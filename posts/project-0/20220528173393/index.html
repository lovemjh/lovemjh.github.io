<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>秒杀高级</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }
  </style>

</head>
    <body style="    
    background-image: url(https://api.ixiaowai.cn/api/api.php);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;">
    <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap">
  <nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-28&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-28&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            11033 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            23 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['秒杀高级'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第十六章</h1>
<h1 align = "center">秒杀高级</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>防止秒杀重复排队</li>
<li>并发超卖问题解决</li>
<li>订单支付</li>
<li>RabbitMQ延时队列</li>
<li>库存回滚</li>
</ul>
<h2 id="1-防止秒杀重复排队">1 防止秒杀重复排队</h2>
<p>用户每次抢单的时候，一旦排队，我们设置一个自增值，让该值的初始值为1，每次进入抢单的时候，对它进行递增，如果值&gt;1，则表明已经排队,不允许重复排队,如果重复排队，则对外抛出异常，并抛出异常信息表示已经正在排队。
<img src="/posts/project-0/20220528173393/image-20220528173531584.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="11-后台排队记录">1.1 后台排队记录</h3>
<p>修改SeckillOrderServiceImpl的add方法，新增递增值判断是否排队中，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173541835.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//递增，判断是否排队
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Long</span> <span class="n">userQueueCount</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueCount&#34;</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="o">(</span><span class="n">userQueueCount</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//100：表示有重复抢单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">REPERROR</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>首次秒杀下单：http://localhost:8001/api/seckillOrder/add?id=1&amp;time=2021061914
<img src="/posts/project-0/20220528173393/image-20220528173553210.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看redis缓存，发现已经记录了UserQueueCount
<img src="/posts/project-0/20220528173393/image-20220528173557522.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>再次重复下单：
<img src="/posts/project-0/20220528173393/image-20220528173602357.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看查看redis缓存，发现UserQueueCount记录的用户下单数量变成了2</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173606706.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="2-并发超卖问题解决">2 并发超卖问题解决</h2>
<p>超卖问题，这里是指多人抢购同一商品的时候，多人同时判断是否有库存，如果只剩一个，则都会判断有库存，此时会导致超卖现象产生，也就是一个商品下了多个订单的现象。</p>
<h3 id="21-思路分析">2.1 思路分析</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528173621573.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>解决超卖问题，可以利用Redis队列实现，给每件商品创建一个独立的商品个数队列，例如：A商品有2个，A商品的ID为1001，则可以创建一个队列,key=SeckillGoodsCountList_1001,往该队列中塞2次该商品ID。</p>
<p>每次给用户下单的时候，先从队列中取数据，如果能取到数据，则表明有库存，如果取不到，则表明没有库存，这样就可以防止超卖问题产生了。</p>
<p>在我们对Redis进行操作的时候，很多时候，都是先将数据查询出来，在内存中修改，然后存入到Redis，在并发场景，会出现数据错乱问题，为了控制数量准确，我们单独将商品数量整一个自增键，<strong>自增键</strong>是线程安全的，所以不担心并发场景的问题。
<img src="/posts/project-0/20220528173393/image-20220528173625837.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="22-代码实现">2.2 代码实现</h3>
<p>每次将商品压入Redis缓存的时候，另外多创建一个商品的队列。</p>
<p>修改SeckillGoodsPushTask,添加一个pushIds方法，用于将指定商品ID放入到指定的数字中，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 将商品ID存入到数组中
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param len:长度
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param id :值
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Long</span><span class="o">[]</span> <span class="nf">pushIds</span><span class="o">(</span><span class="kt">int</span> <span class="n">len</span><span class="o">,</span><span class="n">Long</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Long</span><span class="o">[]</span> <span class="n">ids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Long</span><span class="o">[</span><span class="n">len</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">ids</span><span class="o">.</span><span class="na">length</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ids</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ids</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改SeckillGoodsPushTask的loadGoodsPushRedis方法，添加队列操作，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173634081.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//商品数据队列存储,防止高并发超卖
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Long</span><span class="o">[]</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">pushIds</span><span class="o">(</span><span class="n">seckillGood</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">(),</span> <span class="n">seckillGood</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundListOps</span><span class="o">(</span><span class="s">&#34;SeckillGoodsCountList_&#34;</span><span class="o">+</span><span class="n">seckillGood</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">leftPushAll</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//创建一个计数器记录各个商品的库存数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoodsCount&#34;</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="n">seckillGood</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">seckillGood</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">());</span>
</span></span></code></pre></div><p>测试：</p>
<p>重启服务，发现定时任务执行后，在redis缓存已经记录了数据id的队列SeckillGoodsCountList_1、SeckillGoodsCountList_2等等</p>
<p>并且也记录了每个商品的库存数量SeckillGoodsCoun
<img src="/posts/project-0/20220528173393/image-20220528173639758.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528173393/image-20220528173646339.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528173393/image-20220528173652235.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="23-超卖控制">2.3 超卖控制</h3>
<p>修改多线程下单方法，分别修改数量控制，以及售罄后用户抢单排队信息的清理，修改代码如下图：
<img src="/posts/project-0/20220528173393/image-20220528173657463.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 多线程下单操作
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Async</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">createOrder</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//从队列中获取排队信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SeckillStatus</span> <span class="n">seckillStatus</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillStatus</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundListOps</span><span class="o">(</span><span class="s">&#34;SeckillOrderQueue&#34;</span><span class="o">).</span><span class="na">rightPop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//从队列中获取一个商品
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span> <span class="n">sgood</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundListOps</span><span class="o">(</span><span class="s">&#34;SeckillGoodsCountList_&#34;</span> <span class="o">+</span> <span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">()).</span><span class="na">rightPop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">sgood</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//清理当前用户的排队信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">clearQueue</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//时间区间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">time</span> <span class="o">=</span> <span class="n">seckillStatus</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//用户登录名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">username</span><span class="o">=</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//用户抢购商品
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取商品数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SeckillGoods</span> <span class="n">goods</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillGoods</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoods_&#34;</span> <span class="o">+</span> <span class="n">time</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//如果有库存，则创建秒杀商品订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SeckillOrder</span> <span class="n">seckillOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SeckillOrder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setSeckillId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getCostPrice</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//将秒杀订单存入到Redis中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillOrder&#34;</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">seckillOrder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//商品库存-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Long</span> <span class="n">surplusCount</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoodsCount&#34;</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span><span class="c1">//商品数量递减
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">goods</span><span class="o">.</span><span class="na">setStockCount</span><span class="o">(</span><span class="n">surplusCount</span><span class="o">.</span><span class="na">intValue</span><span class="o">());</span>    <span class="c1">//根据计数器统计
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断当前商品是否还有库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">surplusCount</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//并且将商品数据同步到MySQL中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">seckillGoodsMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">goods</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//如果没有库存,则清空Redis缓存中该商品
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoods_&#34;</span> <span class="o">+</span> <span class="n">time</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//如果有库存，则直数据重置到Reids中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoods_&#34;</span> <span class="o">+</span> <span class="n">time</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">goods</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//抢单成功，更新抢单状态,排队-&gt;等待支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">seckillStatus</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillStatus</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">seckillOrder</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillStatus</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">seckillOrder</span><span class="o">.</span><span class="na">getMoney</span><span class="o">().</span><span class="na">floatValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueStatus&#34;</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">seckillStatus</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 清理用户排队信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param seckillStatus
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearQueue</span><span class="o">(</span><span class="n">SeckillStatus</span> <span class="n">seckillStatus</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//清理排队标示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueCount&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//清理抢单标示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueStatus&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试：正常秒杀下单</p>
<p>http://localhost:8001/api/seckillOrder/add?id=1&amp;time=2021061914</p>
<p>查看redis中的SeckillGoodsCount发现对应编号的商品减去了库存数量。</p>
<h2 id="3-秒杀订单支付">3 秒杀订单支付</h2>
<p><img src="/posts/project-0/20220528173393/image-20220528173707704.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>完成秒杀下订单后，进入支付页面，此时前端会每3秒中向后台发送一次请求用于判断当前用户订单是否完成支付，如果完成了支付，则需要清理掉排队信息，并且需要修改订单状态信息。</p>
<h3 id="31-搭建支付模块">3.1 搭建支付模块</h3>
<p>创建模块dongyimai-payseckill-service</p>
<h4 id="1修改依赖配置文件pomxml">（1）、修改依赖配置文件pom.xml</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-service<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-payseckill-service<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 支付宝支付所需类库包 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alipay.sdk<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>alipay-sdk-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>4.11.54.ALL<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;groupId&gt;</span>org.bouncycastle<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;artifactId&gt;</span>bcprov-jdk15on<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>dongyimai-common<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.2.72<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><h4 id="2配置文件applicationyml">（2）、配置文件application.yml</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9006</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pay</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rabbitmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.188.128</span><span class="w"> </span><span class="c">#mq的服务器地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w"> </span><span class="c">#账号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w"> </span><span class="c">#密码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">alipay</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serverUrl</span><span class="p">:</span><span class="w"> </span><span class="l">https://openapi.alipaydev.com/gateway.do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">notify-url</span><span class="p">:</span><span class="w"> </span><span class="l">http://7r8ukqlrpt.52http.com/pay/notify/url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appId</span><span class="p">:</span><span class="w"> </span><span class="m">2016091300500103</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">privateKey</span><span class="p">:</span><span class="w"> </span><span class="l">用户私钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">alipayPublicKey</span><span class="p">:</span><span class="w"> </span><span class="l">阿里公钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l">json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">charset</span><span class="p">:</span><span class="w"> </span><span class="l">utf-8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">signType</span><span class="p">:</span><span class="w"> </span><span class="l">RSA2</span><span class="w">
</span></span></span></code></pre></div><h3 id="32-创建支付二维码">3.2 创建支付二维码</h3>
<p>下单成功后，会跳转到支付选择页面，在支付选择页面要显示订单编号和订单金额，所以我们需要在下单的时候，将订单金额以及订单编号信息存储到用户查询对象中。</p>
<p>选择扫码支付后，会跳转到扫码支付页面，支付页面会根据用户名查看用户秒杀订单，并根据用户秒杀订单的ID创建预支付信息并获取二维码信息，展示给用户看,此时页面每3秒查询一次支付状态，如果支付成功，需要修改订单状态信息。</p>
<h4 id="321-回显订单号金额">3.2.1 回显订单号、金额</h4>
<p>下单后，进入支付选择页面，需要显示订单号和订单金额，所以需要在用户下单后将该数据传入到pay.html页面，所以查询订单状态的时候，需要将订单号和金额封装到查询的信息中，修改查询订单装的方法加入他们即可。</p>
<p>修改SeckillOrderController的queryStatus方法，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173716301.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getStatus</span><span class="o">(),</span><span class="s">&#34;抢购状态&#34;</span><span class="o">,</span><span class="n">seckillStatus</span><span class="o">);</span>
</span></span></code></pre></div><p>使用Postman测试，效果如下：</p>
<p>http://localhost:8001/api/seckillOrder/query</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173722094.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>订单编号为Long型，转换为json字符串出现精度损失</p>
<p>处理方法：在订单状态实体类，订单编号属性值上增加注解，把Long按照字符串进行序列化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//订单号
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    @JsonSerialize(using = ToStringSerializer.class)
</span></span><span class="line"><span class="cl">    private Long orderId;
</span></span></code></pre></div><h4 id="322-创建二维码">3.2.2 创建二维码</h4>
<p>用户创建二维码，可以先查询用户的秒杀订单抢单信息，然后再发送请求到支付微服务中创建二维码，将订单编号以及订单对应的金额传递到支付微服务:<code>/pay/create/native</code>。</p>
<p>修改支付模块dongyimai-payseckill-service</p>
<h5 id="1编写支付接口定义预下单方法">（1）、编写支付接口，定义预下单方法</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PayService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 生成二维码
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param total_fee
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">createNative</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="2编写接口实现类">(2)、编写接口实现类</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alipay.api.AlipayApiException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alipay.api.DefaultAlipayClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alipay.api.request.AlipayTradePrecreateRequest</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alipay.api.request.AlipayTradeQueryRequest</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alipay.api.response.AlipayTradePrecreateResponse</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alipay.api.response.AlipayTradeQueryResponse</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pay.service.PayService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayServiceImpl</span> <span class="kd">implements</span> <span class="n">PayService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 支付宝gatewayUrl
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.serverUrl}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverUrl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 商户应用id
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.appId}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">appId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * RSA私钥，用于对商户请求报文加签
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.privateKey}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">privateKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 支付宝RSA公钥，用于验签支付宝应答
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.alipayPublicKey}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">alipayPublicKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 签名类型
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.signType}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">signType</span> <span class="o">=</span> <span class="s">&#34;RSA2&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 格式
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.format}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">formate</span> <span class="o">=</span> <span class="s">&#34;json&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 编码
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.charset}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">charset</span> <span class="o">=</span> <span class="s">&#34;UTF-8&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 异步地址
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.notify-url}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">notifyUrl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">createNative</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建阿里支付客户端请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DefaultAlipayClient</span> <span class="n">alipayClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultAlipayClient</span><span class="o">(</span><span class="n">serverUrl</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="n">privateKey</span><span class="o">,</span> <span class="n">formate</span><span class="o">,</span> <span class="n">charset</span><span class="o">,</span> <span class="n">alipayPublicKey</span><span class="o">,</span> <span class="n">signType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建预下单请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AlipayTradePrecreateRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlipayTradePrecreateRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置回调地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">request</span><span class="o">.</span><span class="na">setNotifyUrl</span><span class="o">(</span><span class="n">notifyUrl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置预下单请求参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">request</span><span class="o">.</span><span class="na">setBizContent</span><span class="o">(</span><span class="s">&#34;{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">)+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>              
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">)+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;subject\&#34;:\&#34;测试购买商品001\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span class="o">);</span><span class="c1">//设置业务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//发出预下单业务请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AlipayTradePrecreateResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">alipayClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//从相应对象读取相应结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;响应码:&#34;</span><span class="o">+</span><span class="n">code</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//全部的响应结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;返回结果:&#34;</span><span class="o">+</span><span class="n">body</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;qrcode&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getQrCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">,</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;qrcode:&#34;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="na">getQrCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;out_trade_no:&#34;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;total_fee:&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;预下单接口调用失败:&#34;</span><span class="o">+</span><span class="n">body</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AlipayApiException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>（3）、编写controller控制器代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.entity.Result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.entity.StatusCode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pay.service.PayService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.servlet.ServletInputStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Enumeration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;pay&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PayService</span> <span class="n">payService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 创建二维码连接地址返回给前端 生成二维码图片
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param parameters  包含 订单号  包含 金额  包含 queue队列名称 交换机信息 路由信息 用户名
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/create/native&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="nf">createNative</span><span class="o">(</span><span class="nd">@RequestParam</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取用户名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">payService</span><span class="o">.</span><span class="na">createNative</span><span class="o">(</span><span class="n">parameters</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="s">&#34;二维码连接地址创建成功&#34;</span><span class="o">,</span> <span class="n">resultMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>（4）、编写主启动类PaySeckillApplication</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaySeckillApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaySeckillApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>使用Postman测试效果如下：</p>
<p>http://localhost:9006/pay/create/native?out_trade_no=1132510782836314121&amp;total_fee=1</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173737223.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>根据返回的qrcode,可以生成支付宝扫码的二维码：
<img src="/posts/project-0/20220528173393/image-20220528173741934.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用沙箱版支付宝扫码，即可弹出支付界面。</p>
<h3 id="33-支付流程分析">3.3 支付流程分析</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528173746704.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图，步骤分析如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">1.用户抢单，经过秒杀系统实现抢单，下单后会将向MQ发送一个延时队列消息，包含抢单信息，延时半小时后才能监听到</span>
</span></span><span class="line"><span class="cl"><span class="err">2.秒杀系统同时启用延时消息监听，一旦监听到订单抢单信息，判断Redis缓存中是否存在订单信息，如果存在，则回滚</span>
</span></span><span class="line"><span class="cl"><span class="err">3.秒杀系统还启动支付回调信息监听，如果支付完成，则将订单持久化到MySQL，如果没完成，清理排队信息回滚库存</span>
</span></span><span class="line"><span class="cl"><span class="err">4.每次秒杀下单后调用支付系统，创建二维码，如果用户支付成功了，支付宝平台会将支付信息发送给支付系统指定的回调地址，支付系统收到信息后，将信息发送给MQ，第3个步骤就可以监听到消息了。</span>
</span></span></code></pre></div><h3 id="34-支付回调更新">3.4 支付回调更新</h3>
<p>支付回调这一块代码已经实现了，但之前实现的是订单信息的回调数据发送给MQ，指定了对应的队列，不过现在需要实现的是秒杀信息发送给指定队列，所以之前的代码那块需要动态指定队列。</p>
<h4 id="341-支付回调队列指定">3.4.1 支付回调队列指定</h4>
<p>关于指定队列如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">1.创建支付二维码需要指定队列</span>
</span></span><span class="line"><span class="cl"><span class="err">2.回调地址回调的时候，获取支付二维码指定的队列，将支付信息发送到指定队列中</span>
</span></span></code></pre></div><p>在支付宝支付统一下单API中，有一个附加参数,如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">body</span><span class="o">:</span><span class="s">附加数据,String(127)，在查询API和支付通知中原样返回，可作为自定义参数使用。</span>
</span></span></code></pre></div><p>我们可以在创建二维码的时候，指定该参数，该参数用于指定回调支付信息的对应队列，每次回调的时候，会获取该参数，然后将回调信息发送到该参数对应的队列去。</p>
<h5 id="3411-在预下单时传递队列信息">3.4.1.1 在预下单时传递队列信息</h5>
<p>修改支付微服务的PayServiceImpl的createNative方法，代码如下：</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173753655.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">createNative</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建阿里支付客户端请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DefaultAlipayClient</span> <span class="n">alipayClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultAlipayClient</span><span class="o">(</span><span class="n">serverUrl</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="n">privateKey</span><span class="o">,</span> <span class="n">formate</span><span class="o">,</span> <span class="n">charset</span><span class="o">,</span> <span class="n">alipayPublicKey</span><span class="o">,</span> <span class="n">signType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建预下单请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AlipayTradePrecreateRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlipayTradePrecreateRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="na">setNotifyUrl</span><span class="o">(</span><span class="n">notifyUrl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="na">setBizContent</span><span class="o">(</span><span class="s">&#34;{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">)+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;body\&#34;:\&#34;queue=&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;queue&#34;</span><span class="o">)+</span><span class="s">&#34;&amp;username=&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">)+</span><span class="s">&#34;&amp;routingkey=&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;routingkey&#34;</span><span class="o">)+</span><span class="s">&#34;&amp;exchange=&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;exchange&#34;</span><span class="o">)+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">)+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;subject\&#34;:\&#34;测试购买商品001\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span class="o">);</span><span class="c1">//设置业务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//发出预下单业务请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AlipayTradePrecreateResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">alipayClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//从相应对象读取相应结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;响应码:&#34;</span><span class="o">+</span><span class="n">code</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//全部的响应结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;返回结果:&#34;</span><span class="o">+</span><span class="n">body</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;qrcode&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getQrCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">,</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;qrcode:&#34;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="na">getQrCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;out_trade_no:&#34;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;total_fee:&#34;</span><span class="o">+</span><span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;预下单接口调用失败:&#34;</span><span class="o">+</span><span class="n">body</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AlipayApiException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>我们创建二维码的时候，需要将下面几个参数传递过去</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">username</span><span class="o">:</span><span class="s">用户名,可以根据用户名查询用户排队信息</span>
</span></span><span class="line"><span class="cl"><span class="err">out_trade_no：商户订单号，下单必须</span>
</span></span><span class="line"><span class="cl"><span class="err">total_fee：支付金额，支付必须</span>
</span></span><span class="line"><span class="cl"><span class="err">queue：队列名字，回调的时候，可以知道将支付信息发送到哪个队列</span>
</span></span><span class="line"><span class="cl"><span class="na">routingkey</span><span class="o">:</span><span class="s">路由的名称</span>
</span></span><span class="line"><span class="cl"><span class="err">exchange：交换机名称</span>
</span></span></code></pre></div><p>修改主启动类PayApplication，添加对应队列以及对应交换机绑定，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaySeckillApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaySeckillApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Environment</span> <span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//创建秒杀队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;seckillQueue&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">createSeckillQueue</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.queue.seckillorder&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//创建秒杀交换机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;seckillExchanage&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DirectExchange</span> <span class="nf">basicSeckillExchanage</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DirectExchange</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.exchange.seckillorder&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//绑定秒杀
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;SeckillBinding&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Binding</span> <span class="nf">basicSeckillBinding</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">createSeckillQueue</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">basicSeckillExchanage</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.routing.seckillkey&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改application.yml，添加如下配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1">#位置支付交换机和队列</span>
</span></span><span class="line"><span class="cl"><span class="na">mq</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">pay</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">exchange</span><span class="o">:</span>     
</span></span><span class="line"><span class="cl">      <span class="na">seckillorder</span><span class="o">:</span> <span class="s">exchange.seckillorder</span>
</span></span><span class="line"><span class="cl">    <span class="na">queue</span><span class="o">:</span>     
</span></span><span class="line"><span class="cl">      <span class="na">seckillorder</span><span class="o">:</span> <span class="s">queue.seckillorder</span>
</span></span><span class="line"><span class="cl">    <span class="na">routing</span><span class="o">:</span>     
</span></span><span class="line"><span class="cl">      <span class="na">seckillkey</span><span class="o">:</span> <span class="s">queue.seckillorder</span>
</span></span></code></pre></div><h5 id="3412-测试">3.4.1.2 测试</h5>
<p>使用Postman创建二维码测试</p>
<p>http://localhost:9006/pay/create/native?username=test001&amp;out_trade_no=1132510782836314121&amp;total_fee=1&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173803950.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>以后每次支付，都需要带上对应的参数，包括前面的订单支付。</p>
<h5 id="3413-改造支付回调方法">3.4.1.3 改造支付回调方法</h5>
<p>修改PayController的notifyUrl方法，获取自定义参数，并转成Map，获取queue地址，并将支付信息发送到绑定的queue中，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//接收支付宝网关回调数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/notify/url&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">reciveResult</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//准备一个map封装全部的请求参数和值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取全部的请求参数名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">parameterNames</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameterNames</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">parameterNames</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">paramName</span> <span class="o">=</span> <span class="n">parameterNames</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//封装参数名和参数值到map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">paramName</span><span class="o">,</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">paramName</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//转换map集合为json字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">jsonString</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;响应结果:&#34;</span><span class="o">+</span><span class="n">jsonString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取body自定义参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;body&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//body参数多个用&amp;隔开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span><span class="o">[]</span> <span class="n">splits</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;&amp;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建一个map封装body的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">bodyMap</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">split</span> <span class="o">:</span> <span class="n">splits</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//继续用=号切开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span><span class="o">[]</span> <span class="n">parms</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;=&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">bodyMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">parms</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span><span class="n">parms</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//发送消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">bodyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;exchange&#34;</span><span class="o">),</span><span class="n">bodyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;routingkey&#34;</span><span class="o">),</span><span class="n">jsonString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;pay-success&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>配置回调地址：application.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">alipay</span><span class="p">:</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">notify-url</span><span class="p">:</span><span class="w"> </span><span class="l">http://7r8ukqlrpt.52http.com/pay/notify/url</span><span class="w">
</span></span></span></code></pre></div><h5 id="3414-内网穿透">3.4.1.4 内网穿透</h5>
<p>支付异步通知需要独立ip使阿里支付成功后可以回调我们的接口，所以前提条件就是内网穿透。</p>
<p><a class="link" href="/posts/project-0/https://www.cpolar.com/"  target="_blank" rel="noopener"
    >https://www.cpolar.com/</a>
<img src="/posts/project-0/20220528173393/image-20220528173811677.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如何使用：</p>
<h6 id="1下载-cpolar">（1）、下载 cpolar</h6>
<p><a class="link" href="/posts/project-0/https://www.cpolar.com/static/downloads/releases/latest/cpolar_amd64.msi"  target="_blank" rel="noopener"
    >https://www.cpolar.com/static/downloads/releases/latest/cpolar_amd64.msi</a></p>
<h6 id="2安装">（2）、安装：</h6>
<p>在Linux或OSX上，您可以使用以下命令从终端解压缩cpolar。 在Windows上，只需双击安装</p>
<h6 id="3连接您的帐户">（3）、连接您的帐户：</h6>
<p>运行此命令会将您帐户的authtoken添加到您的cpolar.yml文件中。 这将为您提供更多功能，所有打开的隧道将在此处的仪表板中列出。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cpolar authtoken YzQxMzFiY2YtY2I1NC*****LTg2NzAtZjJkMTRmYjQ0ZDRh
</span></span></code></pre></div><p>具体的token值：登录网站从控制面板获取：https://dashboard.cpolar.com/auth
<img src="/posts/project-0/20220528173393/image-20220528173817734.png"
    
    
    
    loading="lazy"
    
    
></p>
<h6 id="4开启端口映射">（4）、开启端口映射</h6>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cpolar http 80
</span></span></code></pre></div><p>在80端口开启映射。
<img src="/posts/project-0/20220528173393/image-20220528173824527.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试内网穿透：访问回调接口接口</p>
<p><a class="link" href="/posts/project-0/http://6ca8e8f6.cpolar.io/pay/notify/url?id=111&amp;name=wwww"  target="_blank" rel="noopener"
    >http://6ca8e8f6.cpolar.io/pay/notify/url?id=111&name=wwww</a></p>
<p>扫描支付二维码，支付宝即可回调  接口</p>
<p>控制台可以查看相关信息
<img src="/posts/project-0/20220528173393/image-20220528173829290.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="342-支付状态监听">3.4.2 支付状态监听</h4>
<p>支付状态通过回调地址发送给MQ之后，我们需要在秒杀系统中监听支付信息，如果用户已支付，则修改用户订单状态，如果支付失败，则直接删除订单，回滚库存。</p>
<p>在秒杀工程中创建com.offcn.seckill.consumer.SeckillOrderPayMessageListener,实现监听消息，代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="s">&#34;${mq.pay.queue.seckillorder}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillOrderPayMessageListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 监听消费消息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param message
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RabbitHandler</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nd">@Payload</span> <span class="n">String</span> <span class="n">message</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将消息转换成Map对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">message</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听到的消息:&#34;</span><span class="o">+</span><span class="n">resultMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改SeckillApplication创建对应的队列以及绑定对应交换机。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span>
</span></span><span class="line"><span class="cl"><span class="nd">@MapperScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;com.offcn.seckill.dao&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableScheduling</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableAsync</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SeckillApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IdWorker</span> <span class="nf">idWorker</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">IdWorker</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Environment</span> <span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 创建秒杀队列
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;queueSeckillOrder&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">queueSeckillOrder</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.queue.seckillorder&#34;</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//创建秒杀交换机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DirectExchange</span> <span class="nf">directExchangeOrder</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DirectExchange</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.exchange.seckillorder&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/****
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 队列绑定到交换机上
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Binding</span> <span class="nf">basicBindingSeckillOrder</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">BindingBuilder</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queueSeckillOrder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">directExchangeOrder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.routing.seckillkey&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改application.yml文件，添加如下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1">#位置支付交换机和队列</span>
</span></span><span class="line"><span class="cl"><span class="na">mq</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">pay</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">exchange</span><span class="o">:</span>     
</span></span><span class="line"><span class="cl">      <span class="na">seckillorder</span><span class="o">:</span> <span class="s">exchange.seckillorder</span>
</span></span><span class="line"><span class="cl">    <span class="na">queue</span><span class="o">:</span>     
</span></span><span class="line"><span class="cl">      <span class="na">seckillorder</span><span class="o">:</span> <span class="s">queue.seckillorder</span>
</span></span><span class="line"><span class="cl">    <span class="na">routing</span><span class="o">:</span>     
</span></span><span class="line"><span class="cl">      <span class="na">seckillkey</span><span class="o">:</span> <span class="s">queue.seckillorder</span>
</span></span></code></pre></div><h4 id="343-修改订单状态">3.4.3 修改订单状态</h4>
<p>监听到支付信息后，根据支付信息判断，如果用户支付成功，则修改订单信息，并将订单入库，删除用户排队信息，如果用户支付失败，则删除订单信息，回滚库存，删除用户排队信息。</p>
<h5 id="3431-业务层">3.4.3.1 业务层</h5>
<p>修改SeckillOrderService，添加修改订单方法，代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 更新订单状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param transaction_id
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">updatePayStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span> <span class="n">String</span> <span class="n">transaction_id</span><span class="o">,</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span></code></pre></div><p>修改SeckillOrderServiceImpl，添加修改订单方法实现，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 更新订单状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param transaction_id
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePayStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span> <span class="n">String</span> <span class="n">transaction_id</span><span class="o">,</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//订单数据从Redis数据库查询出来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SeckillOrder</span> <span class="n">seckillOrder</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillOrder</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillOrder&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//修改状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置交易流水号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setTransactionId</span><span class="o">(</span><span class="n">transaction_id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//支付时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">seckillOrder</span><span class="o">.</span><span class="na">setPayTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//同步到MySQL中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">seckillOrderMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">seckillOrder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//清空Redis缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillOrder&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//清空用户排队数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueCount&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//删除抢购状态信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueStatus&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改订单实体类的id生成方式，为外面生成
<img src="/posts/project-0/20220528173393/image-20220528173840203.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="3432-修改订单对接">3.4.3.2 修改订单对接</h5>
<p>修改扫码支付状态监听的代码，当用户支付成功后，修改订单状态，也就是调用上面的方法，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173844974.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.seckill.consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.seckill.service.SeckillOrderService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.messaging.handler.annotation.Payload</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="s">&#34;${mq.pay.queue.seckillorder}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillOrderPayMessageListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SeckillOrderService</span> <span class="n">seckillOrderService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 监听消费消息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param message
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RabbitHandler</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nd">@Payload</span> <span class="n">String</span> <span class="n">message</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将消息转换成Map对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听到的消息:&#34;</span><span class="o">+</span><span class="n">resultMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取交易状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">trade_status</span><span class="o">=</span>    <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;trade_status&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//判断交易状态是否等于成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">trade_status</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">trade_status</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;TRADE_SUCCESS&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">body</span><span class="o">=</span>  <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;body&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">bodyMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;body&#34;</span><span class="o">)!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span><span class="o">[]</span> <span class="n">splits</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;&amp;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">split</span> <span class="o">:</span> <span class="n">splits</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">String</span><span class="o">[]</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;=&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bodyMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">vs</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">vs</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">seckillOrderService</span><span class="o">.</span><span class="na">updatePayStatus</span><span class="o">(</span><span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">),</span><span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;trade_no&#34;</span><span class="o">),</span><span class="n">bodyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//支付失败，删除订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>使用Postman完整请求创建二维码下单测试一次。</p>
<p>商品ID：1</p>
<p>剩余库存数量：10</p>
<p>http://localhost:8001/api/seckillGoods/one?id=1&amp;time=2021061916
<img src="/posts/project-0/20220528173393/image-20220528173852410.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单：</p>
<p>http://localhost:8001/api/seckillOrder/add?time=2021061916&amp;id=1</p>
<p>下单后，Redis数据
<img src="/posts/project-0/20220528173393/image-20220528173856522.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单查询：</p>
<p>http://localhost:8001/api/seckillOrder/query
<img src="/posts/project-0/20220528173393/image-20220528173900940.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>创建二维码：</p>
<p>http://localhost:9006/pay/create/native?username=dongyimai&amp;out_trade_no=1375043168986337280&amp;total_fee=0.01&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p>注意：username 用登录的账号   out_trade_no 用下单成功的订单号</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173911454.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>扫码：</p>
<p>使用返回的预下单url生成二维码
<img src="/posts/project-0/20220528173393/image-20220528173915890.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用沙箱支付宝扫描二维码，完成支付</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173922806.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看订单状态：</p>
<p>http://localhost:9005/seckillOrder/query</p>
<h4 id="344-删除订单回滚库存">3.4.4 删除订单回滚库存</h4>
<p>如果用户支付失败，我们需要删除用户订单数据，并回滚库存。</p>
<h5 id="3441-业务层实现">3.4.4.1 业务层实现</h5>
<p>修改SeckillOrderService，创建一个关闭订单方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 关闭订单，回滚库存
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">closeOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span></code></pre></div><p>修改SeckillOrderServiceImpl，创建一个关闭订单实现方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 关闭订单，回滚库存
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将消息转换成SeckillStatus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SeckillStatus</span> <span class="n">seckillStatus</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillStatus</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueStatus&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取Redis中订单信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SeckillOrder</span> <span class="n">seckillOrder</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillOrder</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillOrder&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//如果Redis中有订单信息，说明用户未支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">seckillOrder</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//删除订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillOrder&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//回滚库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//1)从Redis中获取该商品
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SeckillGoods</span> <span class="n">seckillGoods</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillGoods</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoods_&#34;</span><span class="o">+</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getTime</span><span class="o">()).</span><span class="na">get</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//2)如果Redis中没有，则从数据库中加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">seckillGoods</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">seckillGoods</span> <span class="o">=</span> <span class="n">seckillGoodsMapper</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//3)数量+1  (递增数量+1，队列数量+1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Long</span> <span class="n">surplusCount</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoodsCount&#34;</span><span class="o">).</span><span class="na">increment</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">seckillGoods</span><span class="o">.</span><span class="na">setStockCount</span><span class="o">(</span><span class="n">surplusCount</span><span class="o">.</span><span class="na">intValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundListOps</span><span class="o">(</span><span class="s">&#34;SeckillGoodsCountList_&#34;</span> <span class="o">+</span> <span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">()).</span><span class="na">leftPush</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//4)数据同步到Redis中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillGoods_&#34;</span><span class="o">+</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getTime</span><span class="o">()).</span><span class="na">put</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">(),</span><span class="n">seckillGoods</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//清理排队标示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueCount&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//清理抢单标示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;UserQueueStatus&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="3442-调用删除订单">3.4.4.2 调用删除订单</h5>
<p>修改SeckillOrderPayMessageListener，在用户支付失败后调用关闭订单方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//支付失败，关闭订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">seckillOrderService</span><span class="o">.</span><span class="na">closeOrder</span><span class="o">(</span><span class="n">bodyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="3443-测试">3.4.4.3 测试</h5>
<p>使用Postman完整请求创建二维码下单测试一次。</p>
<p>商品ID：1</p>
<p>剩余库存数量：10</p>
<p>http://localhost:9005/seckillGoods/one?id=1&amp;time=2021032518
<img src="/posts/project-0/20220528173393/image-20220528173935260.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单：</p>
<p>http://localhost:9005/seckillOrder/add?time=2021032518&amp;id=1</p>
<p>下单后，Redis数据
<img src="/posts/project-0/20220528173393/image-20220528173939235.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单查询：</p>
<p>http://localhost:9005/seckillOrder/query
<img src="/posts/project-0/20220528173393/image-20220528173944723.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>创建二维码：</p>
<p>http://localhost:9006/pay/create/native?username=test001&amp;out_trade_no=1375043168986337280&amp;total_fee=0.01&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p>秒杀抢单后，商品数量变化：</p>
<p>http://localhost:9005/seckillGoods/one?id=1&amp;time=2021032518
<img src="/posts/project-0/20220528173393/image-20220528173951303.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-rabbitmq延时消息队列">4 RabbitMQ延时消息队列</h2>
<h3 id="41-延时队列介绍">4.1 延时队列介绍</h3>
<p>延时队列即放置在该队列里面的消息是不需要立即消费的，而是等待一段时间之后取出消费。
那么，为什么需要延迟消费呢？我们来看以下的场景</p>
<p>网上商城下订单后30分钟后没有完成支付，取消订单(如：淘宝、去哪儿网)
系统创建了预约之后，需要在预约时间到达前一小时提醒被预约的双方参会
系统中的业务失败之后，需要重试
这些场景都非常常见，我们可以思考，比如第二个需求，系统创建了预约之后，需要在预约时间到达前一小时提醒被预约的双方参会。那么一天之中肯定是会有很多个预约的，时间也是不一定的，假设现在有1点 2点 3点 三个预约，如何让系统知道在当前时间等于0点 1点 2点给用户发送信息呢，是不是需要一个轮询，一直去查看所有的预约，比对当前的系统时间和预约提前一小时的时间是否相等呢？这样做非常浪费资源而且轮询的时间间隔不好控制。如果我们使用延时消息队列呢，我们在创建时把需要通知的预约放入消息中间件中，并且设置该消息的过期时间，等过期时间到达时再取出消费即可。</p>
<p>Rabbitmq实现延时队列一般而言有两种形式：
第一种方式：利用两个特性： Time To Live(TTL)、Dead Letter Exchanges（DLX）[A队列过期-&gt;转发给B队列]</p>
<p>第二种方式：利用rabbitmq中的插件x-delay-message</p>
<h3 id="42-ttl-dlx实现延时队列">4.2 TTL DLX实现延时队列</h3>
<h4 id="421-ttl-dlx介绍">4.2.1 TTL DLX介绍</h4>
<p><strong>TTL</strong>
RabbitMQ可以针对队列设置x-expires(则队列中所有的消息都有相同的过期时间)或者针对Message设置x-message-ttl(对消息进行单独设置，每条消息TTL可以不同)，来控制消息的生存时间，如果超时(两者同时设置以最先到期的时间为准)，则消息变为dead letter(死信)</p>
<p><strong>Dead Letter Exchanges（DLX）</strong>
RabbitMQ的Queue可以配置x-dead-letter-exchange和x-dead-letter-routing-key（可选）两个参数，如果队列内出现了dead letter，则按照这两个参数重新路由转发到指定的队列。
x-dead-letter-exchange：出现dead letter之后将dead letter重新发送到指定exchange</p>
<p>x-dead-letter-routing-key：出现dead letter之后将dead letter重新按照指定的routing-key发送</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173959420.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="423-dlx延时队列实现">4.2.3 DLX延时队列实现</h4>
<h5 id="4231-创建工程">4.2.3.1 创建工程</h5>
<p>创建springboot_rabbitmq_delay工程，并引入相关依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai_parent<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>springboot_rabbitmq_delay<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--starter-web--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--加入ampq--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--测试--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p>application.yml配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">spring</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">application</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">name</span><span class="o">:</span> <span class="s">springboot-demo</span>
</span></span><span class="line"><span class="cl">  <span class="na">rabbitmq</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">host</span><span class="o">:</span> <span class="s">192.168.188.128</span>
</span></span><span class="line"><span class="cl">    <span class="na">port</span><span class="o">:</span> <span class="s">5672</span>
</span></span><span class="line"><span class="cl">    <span class="na">password</span><span class="o">:</span> <span class="s">guest</span>
</span></span><span class="line"><span class="cl">    <span class="na">username</span><span class="o">:</span> <span class="s">guest</span>
</span></span></code></pre></div><h5 id="4232-队列创建">4.2.3.2 队列创建</h5>
<p>创建2个队列，用于接收消息的叫延时队列queue.message.delay，用于转发消息的队列叫queue.message，同时创建一个交换机，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueueConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** 短信发送队列 */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">QUEUE_MESSAGE</span> <span class="o">=</span> <span class="s">&#34;queue.message&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** 交换机 */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DLX_EXCHANGE</span> <span class="o">=</span> <span class="s">&#34;dlx.exchange&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** 短信发送队列 延迟缓冲（按消息） */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">QUEUE_MESSAGE_DELAY</span> <span class="o">=</span> <span class="s">&#34;queue.message.delay&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 接收死信队列
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">messageQueue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//允许长期存储消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">QUEUE_MESSAGE</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 接收延时消息队列
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">delayMessageQueue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">QueueBuilder</span><span class="o">.</span><span class="na">durable</span><span class="o">(</span><span class="n">QUEUE_MESSAGE_DELAY</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">withArgument</span><span class="o">(</span><span class="s">&#34;x-dead-letter-exchange&#34;</span><span class="o">,</span> <span class="n">DLX_EXCHANGE</span><span class="o">)</span>        <span class="c1">// 消息超时进入死信队列，绑定死信队列交换机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">withArgument</span><span class="o">(</span><span class="s">&#34;x-dead-letter-routing-key&#34;</span><span class="o">,</span> <span class="n">QUEUE_MESSAGE</span><span class="o">)</span>   <span class="c1">// 绑定指定的routing-key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 创建交换机
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DirectExchange</span> <span class="nf">directExchange</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DirectExchange</span><span class="o">(</span><span class="n">DLX_EXCHANGE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 交换机与队列绑定
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param messageQueue
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param directExchange
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Binding</span> <span class="nf">basicBinding</span><span class="o">(</span><span class="n">Queue</span> <span class="n">messageQueue</span><span class="o">,</span> <span class="n">DirectExchange</span> <span class="n">directExchange</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">messageQueue</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">directExchange</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">QUEUE_MESSAGE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="4233-消息监听">4.2.3.3 消息监听</h5>
<p>创建MessageListener用于监听消息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="n">QueueConfig</span><span class="o">.</span><span class="na">QUEUE_MESSAGE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 监听消息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param msg
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RabbitHandler</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">msg</span><span class="o">(</span><span class="nd">@Payload</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">SimpleDateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;当前时间:&#34;</span><span class="o">+</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;收到信息:&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意：@Payload 和 @Headers 注解可以分别接收消息中的 body 与 headers 信息</p>
<p>@RabbitListener 可以标注在类上面，需配合 @RabbitHandler 注解一起使用
@RabbitListener 标注在类上面表示当有收到消息的时候，就交给 @RabbitHandler 的方法处理，具体使用哪个方法处理，根据 MessageConverter 转换后的参数类型。</p>
<h5 id="4234-创建启动类">4.2.3.4 创建启动类</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableRabbit</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringRabbitMQApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SpringRabbitMQApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="4235-测试">4.2.3.5 测试</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="n">SpringRabbitMQApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RabbitMQTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RabbitTemplate</span> <span class="n">rabbitTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 发送消息
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SimpleDateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;发送当前时间:&#34;</span><span class="o">+</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">message</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span><span class="s">&#34;offcn&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">QueueConfig</span><span class="o">.</span><span class="na">QUEUE_MESSAGE_DELAY</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="k">new</span> <span class="n">MessagePostProcessor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="n">Message</span> <span class="nf">postProcessMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AmqpException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="o">.</span><span class="na">getMessageProperties</span><span class="o">().</span><span class="na">setExpiration</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>其中message.getMessageProperties().setExpiration(&ldquo;10000&rdquo;);设置消息超时时间,超时后，会将消息转入到另外一个队列。</p>
<p>测试效果如下：
<img src="/posts/project-0/20220528173393/image-20220528174012587.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>接收时间延迟了10秒，在死信队列收到消息
<img src="/posts/project-0/20220528173393/image-20220528174017485.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-超时未完成支付自动删除订单库存回滚作业">5 超时未完成支付、自动删除订单库存回滚(作业)</h2>
<h3 id="51-秒杀流程回顾">5.1 秒杀流程回顾</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528174023470.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图，步骤分析如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">1.用户抢单，经过秒杀系统实现抢单，下单后会将向MQ发送一个延时队列消息，包含抢单信息，延时半小时后才能监听到</span>
</span></span><span class="line"><span class="cl"><span class="err">2.秒杀系统同时启用延时消息监听，一旦监听到订单抢单信息，判断Redis缓存中是否存在订单信息，如果存在，则回滚</span>
</span></span><span class="line"><span class="cl"><span class="err">3.秒杀系统还启动支付回调信息监听，如果支付完成，则将订单持久化到MySQL，如果没完成，清理排队信息回滚库存</span>
</span></span><span class="line"><span class="cl"><span class="err">4.每次秒杀下单后调用支付系统，创建二维码，如果用户支付成功了，支付宝平台会将支付信息发送给支付系统指定的回调地址，支付系统收到信息后，将信息发送给MQ，第3个步骤就可以监听到消息了。</span>
</span></span></code></pre></div><p>延时队列实现订单关闭回滚库存：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.创建一个过期队列  Queue1
</span></span><span class="line"><span class="cl">2.接收消息的队列    Queue2
</span></span><span class="line"><span class="cl">3.中转交换机
</span></span><span class="line"><span class="cl">4.监听Queue2
</span></span><span class="line"><span class="cl">	1)SeckillStatus-&gt;检查Redis中是否有订单信息
</span></span><span class="line"><span class="cl">	2)如果有订单信息，调用删除订单回滚库存-&gt;[需要先关闭扫码支付]
</span></span><span class="line"><span class="cl">	3)如果关闭订单时，用于已支付，修改订单状态即可
</span></span><span class="line"><span class="cl">	4)如果关闭订单时，发生了别的错误，记录日志，人工处理
</span></span></code></pre></div><h3 id="52-关闭支付">5.2 关闭支付</h3>
<p>用户如果半个小时没有支付，我们会关闭支付订单，但在关闭之前，需要先关闭扫码支付，防止中途用户支付。</p>
<p>修改支付微服务的PayService，添加关闭支付方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 关闭支付
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param orderId
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">closePay</span><span class="o">(</span><span class="n">Long</span> <span class="n">out_trade_no</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span></code></pre></div><p>修改PayServiceImpl，实现关闭扫码支付方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">closePay</span><span class="o">(</span><span class="n">Long</span> <span class="n">out_trade_no</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建阿里支付客户端请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DefaultAlipayClient</span> <span class="n">alipayClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultAlipayClient</span><span class="o">(</span><span class="n">serverUrl</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="n">privateKey</span><span class="o">,</span> <span class="n">formate</span><span class="o">,</span> <span class="n">charset</span><span class="o">,</span> <span class="n">alipayPublicKey</span><span class="o">,</span> <span class="n">signType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//撤销交易请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AlipayTradeCancelRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlipayTradeCancelRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="na">setBizContent</span><span class="o">(</span><span class="s">&#34;{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span class="o">+</span><span class="n">out_trade_no</span><span class="o">+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;trade_no\&#34;:\&#34;\&#34;}&#34;</span><span class="o">);</span> <span class="c1">//设置业务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AlipayTradeCancelResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">alipayClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;返回值:&#34;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">,</span> <span class="n">out_trade_no</span><span class="o">+</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AlipayApiException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>修改PayController，增加关闭服务方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//关闭支付预下单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;closepay&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">closePay</span><span class="o">(</span><span class="n">Long</span> <span class="n">out_trade_no</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">payService</span><span class="o">.</span><span class="na">closePay</span><span class="o">(</span><span class="n">out_trade_no</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">resultMap</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//成功关闭，就返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;订单关闭成功&#34;</span><span class="o">,</span><span class="n">resultMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span><span class="s">&#34;订单关闭失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span><span class="s">&#34;订单关闭失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>http://localhost:9006/pay/closepay?out_trade_no=1406451841629294592
<img src="/posts/project-0/20220528173393/image-20220528174032735.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="53-关闭订单回滚库存">5.3 关闭订单回滚库存</h3>
<h4 id="531-配置延时队列">5.3.1 配置延时队列</h4>
<p>在application.yml文件中引入队列信息配置，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1">#位置支付交换机和队列</span>
</span></span><span class="line"><span class="cl"><span class="na">mq</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">pay</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">exchange</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillorder</span><span class="o">:</span> <span class="s">exchange.seckillorder</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillordertimer</span><span class="o">:</span> <span class="s">exchange.seckillordertimer</span>
</span></span><span class="line"><span class="cl">    <span class="na">queue</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillorder</span><span class="o">:</span> <span class="s">queue.seckillorder</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillordertimer</span><span class="o">:</span> <span class="s">queue.seckillordertimer</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillordertimerdelay</span><span class="o">:</span> <span class="s">queue.seckillordertimerdelay</span>
</span></span><span class="line"><span class="cl">    <span class="na">routing</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillkey</span><span class="o">:</span> <span class="s">queue.seckillorder</span>
</span></span><span class="line"><span class="cl">      <span class="na">seckillordertimerkey</span><span class="o">:</span> <span class="s">queue.seckillordertime</span>
</span></span></code></pre></div><p>配置队列与交换机,在SeckillApplication中添加如下方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 到期数据队列
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">seckillOrderTimerQueue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.queue.seckillordertimer&#34;</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 超时数据队列
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">delaySeckillOrderTimerQueue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">QueueBuilder</span><span class="o">.</span><span class="na">durable</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.queue.seckillordertimerdelay&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">withArgument</span><span class="o">(</span><span class="s">&#34;x-dead-letter-exchange&#34;</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.exchange.seckillordertimer&#34;</span><span class="o">))</span>        <span class="c1">// 消息超时进入死信队列，绑定死信队列交换机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">withArgument</span><span class="o">(</span><span class="s">&#34;x-dead-letter-routing-key&#34;</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.routing.seckillordertimerkey&#34;</span><span class="o">))</span>   <span class="c1">// 绑定指定的routing-key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//创建延时交换机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DirectExchange</span> <span class="nf">directExchangeOrderTimer</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DirectExchange</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.exchange.seckillordertimer&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 交换机与队列绑定
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Binding</span> <span class="nf">basicBindingOrderTime</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">seckillOrderTimerQueue</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">directExchangeOrderTimer</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.routing.seckillordertimerkey&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h4 id="532-发送延时消息">5.3.2 发送延时消息</h4>
<p>修改MultiThreadingCreateOrder，添加如下方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 发送延时消息到RabbitMQ中
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param seckillStatus
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendTimerMessage</span><span class="o">(</span><span class="n">SeckillStatus</span> <span class="n">seckillStatus</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;mq.pay.queue.seckillordertimerdelay&#34;</span><span class="o">),</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">),</span> <span class="k">new</span> <span class="n">MessagePostProcessor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Message</span> <span class="nf">postProcessMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AmqpException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">message</span><span class="o">.</span><span class="na">getMessageProperties</span><span class="o">().</span><span class="na">setExpiration</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>在createOrder方法中调用上面方法，如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//发送延时消息到MQ中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">sendTimerMessage</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">);</span>
</span></span></code></pre></div><h4 id="533-feign调用支付服务关闭预下单接口">5.3.3 Feign调用支付服务关闭预下单接口</h4>
<p>在模块dongyimai-seckill-service创建feign接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.seckill.feign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.entity.Result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.FeignClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;PAY&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PayFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/pay/closepay&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">closePay</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">out_trade_no</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意修改配置文件application.yml设置feign调用超时时间</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">connectTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">  </span><span class="c">#连接超时时间5秒</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">readTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">     </span><span class="c">#读超时时间5秒</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#hystrix 配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">execution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c">#如果enabled设置为false，则请求超时交给ribbon控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">isolation</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">thread</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutInMilliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l">SEMAPHORE</span><span class="w">
</span></span></span></code></pre></div><h4 id="534-库存回滚">5.3.4 库存回滚</h4>
<p>创建SeckillOrderDelayMessageListener实现监听消息，并回滚库存，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.seckill.consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.entity.Result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.seckill.bean.SeckillStatus</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.seckill.feign.PayFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.seckill.pojo.SeckillOrder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.seckill.service.SeckillOrderService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.redis.core.RedisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.messaging.handler.annotation.Payload</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="s">&#34;${mq.pay.queue.seckillordertimer}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeckillOrderDelayMessageListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SeckillOrderService</span> <span class="n">seckillOrderService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PayFeign</span> <span class="n">payFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 读取消息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 判断Redis中是否存在对应的订单
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果存在，则关闭支付，再关闭订单
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param message
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RabbitHandler</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nd">@Payload</span> <span class="n">String</span> <span class="n">message</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//读取消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SeckillStatus</span> <span class="n">seckillStatus</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">message</span><span class="o">,</span><span class="n">SeckillStatus</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取Redis中订单信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">seckillStatus</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SeckillOrder</span> <span class="n">seckillOrder</span> <span class="o">=</span> <span class="o">(</span><span class="n">SeckillOrder</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;SeckillOrder&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//如果Redis中有订单信息，说明用户未支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">seckillOrder</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;准备回滚---&#34;</span><span class="o">+</span><span class="n">seckillStatus</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//关闭支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Result</span> <span class="n">closeResult</span> <span class="o">=</span> <span class="n">payFeign</span><span class="o">.</span><span class="na">closePay</span><span class="o">(</span><span class="n">seckillStatus</span><span class="o">.</span><span class="na">getOrderId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">closeMap</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;)</span> <span class="n">closeResult</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">closeMap</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">closeMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">).</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//关闭订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">seckillOrderService</span><span class="o">.</span><span class="na">closeOrder</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>http://localhost:8001/api/seckillOrder/add?time=2021062012&amp;id=1</p>
<p>测试下单，10秒内未完成支付，即可收到延时消息，回滚订单
<img src="/posts/project-0/20220528173393/image-20220528174047031.png"
    
    
    
    loading="lazy"
    
    
></p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528172837/">← 秒杀1</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528170121/">购物车解决方案 →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>