<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="微服务网关和Jwt令牌 - https://lovemjh.vercel.app/posts/project-0/20220528162731/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>微服务网关和Jwt令牌</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.ef012369a26adc2a21396230b3395dfcd5975a3082a65b82785cbc0b446f2a2c.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            微服务网关和Jwt令牌
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            10517 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            21 分钟</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528174166/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528171137/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#学习目标">学习目标</a></li>
        <li><a href="#1-微服务网关">1 微服务网关</a>
          <ul>
            <li><a href="#11-微服务网关的概述">1.1 微服务网关的概述</a></li>
            <li><a href="#12-微服务网关技术">1.2 微服务网关技术</a></li>
          </ul>
        </li>
        <li><a href="#2-网关系统使用">2 网关系统使用</a>
          <ul>
            <li><a href="#21-需求分析">2.1 需求分析</a></li>
            <li><a href="#22-搭建后台网关系统">2.2 搭建后台网关系统</a>
              <ul>
                <li><a href="#221-搭建分析">2.2.1 搭建分析</a></li>
                <li><a href="#222-工程搭建">2.2.2 工程搭建</a></li>
              </ul>
            </li>
            <li><a href="#23-跨域配置">2.3 跨域配置</a></li>
            <li><a href="#24-网关过滤配置">2.4 网关过滤配置</a>
              <ul>
                <li><a href="#241-host-路由">2.4.1 Host 路由</a></li>
                <li><a href="#242-路径匹配过滤配置">2.4.2 路径匹配过滤配置</a></li>
                <li><a href="#243-prefixpath-过滤配置">2.4.3 PrefixPath 过滤配置</a></li>
                <li><a href="#244-stripprefix-过滤配置">2.4.4 StripPrefix 过滤配置</a></li>
                <li><a href="#245-loadbalancerclient-路由过滤器客户端负载均衡">2.4.5 LoadBalancerClient 路由过滤器(客户端负载均衡)</a></li>
              </ul>
            </li>
            <li><a href="#25-网关限流">2.5 网关限流</a>
              <ul>
                <li><a href="#251-思路分析">2.5.1 思路分析</a></li>
                <li><a href="#252-令牌桶算法">2.5.2 令牌桶算法</a></li>
                <li><a href="#253-使用令牌桶进行请求次数限流">2.5.3 使用令牌桶进行请求次数限流</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#3-用户登录">3 用户登录</a>
          <ul>
            <li><a href="#31-表结构介绍">3.1 表结构介绍</a></li>
            <li><a href="#32-登录">3.2 登录</a></li>
            <li><a href="#34-网关关联">3.4 网关关联</a></li>
          </ul>
        </li>
        <li><a href="#4-jwt讲解">4 JWT讲解</a>
          <ul>
            <li><a href="#41-需求分析">4.1 需求分析</a></li>
            <li><a href="#42-什么是jwt">4.2 什么是JWT</a></li>
            <li><a href="#43-jwt的构成">4.3 JWT的构成</a></li>
            <li><a href="#44-jjwt的介绍和使用">4.4 JJWT的介绍和使用</a>
              <ul>
                <li><a href="#441-创建token">4.4.1 创建TOKEN</a></li>
                <li><a href="#442-token解析">4.4.2 TOKEN解析</a></li>
                <li><a href="#443-设置过期时间">4.4.3 设置过期时间</a>
                  <ul>
                    <li><a href="#4431-token过期设置">4.4.3.1 token过期设置</a></li>
                    <li><a href="#4432-解析token">4.4.3.2 解析TOKEN</a></li>
                  </ul>
                </li>
                <li><a href="#444-自定义claims">4.4.4 自定义claims</a></li>
              </ul>
            </li>
            <li><a href="#45-鉴权处理">4.5 鉴权处理</a>
              <ul>
                <li><a href="#451-思路分析">4.5.1 思路分析</a></li>
                <li><a href="#452用户登录签发token">4.5.2用户登录签发TOKEN</a></li>
                <li><a href="#453-网关过滤器拦截请求处理">4.5.3 网关过滤器拦截请求处理</a></li>
                <li><a href="#454-配置过滤规则">4.5.4 配置过滤规则</a></li>
              </ul>
            </li>
            <li><a href="#46-会话保持">4.6 会话保持</a>
              <ul>
                <li><a href="#461-登录封装cookie">4.6.1 登录封装Cookie</a></li>
                <li><a href="#462-过滤器获取令牌数据">4.6.2 过滤器获取令牌数据</a></li>
                <li><a href="#463-添加header信息">4.6.3 添加Header信息</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">第十章</h1>
<h1 align = "center">微服务网关和Jwt令牌</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>
<p>掌握微服务网关的系统搭建</p>
</li>
<li>
<p>了解什么是微服务网关以及它的作用</p>
</li>
<li>
<p>掌握系统中心微服务的搭建</p>
</li>
<li>
<p>掌握用户密码加密存储bcrypt</p>
</li>
<li>
<p>了解JWT鉴权的介绍</p>
</li>
<li>
<p>掌握JWT的鉴权的使用</p>
<p>使用Jwt令牌来存储用户登录信息，在微服务网关中识别登录信息(用户的身份)</p>
</li>
<li>
<p>掌握网关使用JWT进行校验</p>
</li>
<li>
<p>掌握网关限流</p>
</li>
</ul>
<h2 id="1-微服务网关">1 微服务网关</h2>
<h3 id="11-微服务网关的概述">1.1 微服务网关的概述</h3>
<p>不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题：</p>
<ul>
<li>客户端会多次请求不同的微服务，增加了客户端的复杂性</li>
<li>存在跨域请求，在一定场景下处理相对复杂</li>
<li>认证复杂，每个服务都需要独立认证</li>
<li>难以重构，随着项目的迭代，可能需要重新划分微服务。例如，可能将多个服务合并成一个或者将一个服务拆分成多个。如果客户端直接与微服务通信，那么重构将会很难实施</li>
<li>某些微服务可能使用了防火墙/浏览器不友好的协议，直接访问会有一定的困难</li>
</ul>
<p>以上这些问题可以借助网关解决。</p>
<p>网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过网关这一层。也就是说，API 的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由网关来做，这样既提高业务灵活性又不缺安全性，典型的架构图如图所示：
<img src="/posts/project-0/20220528162731/image-20220528164602577.png"
    
    
    
    loading="lazy"
    
    
>
优点如下：</p>
<ul>
<li>安全，只有网关系统对外进行暴露，微服务可以隐藏在内网，通过防火墙保护。</li>
<li>易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。</li>
<li>易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。</li>
<li>减少了客户端与各个微服务之间的交互次数</li>
<li>易于统一授权。</li>
</ul>
<p>总结：微服务网关就是一个系统，通过暴露该微服务网关系统，方便我们进行相关的鉴权，安全控制，日志统一处理，易于监控的相关功能。</p>
<h3 id="12-微服务网关技术">1.2 微服务网关技术</h3>
<p>实现微服务网关的技术有很多，</p>
<ul>
<li>nginx  Nginx (tengine x)是一个高性能的<a class="link" href="/posts/project-0/https://baike.baidu.com/item/HTTP"  target="_blank" rel="noopener"
    >HTTP</a>和<a class="link" href="/posts/project-0/https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/7793488"  target="_blank" rel="noopener"
    >反向代理</a>web服务器，同时也提供了IMAP/POP3/SMTP服务</li>
<li>zuul ,Zuul 是 Netflix 出品的一个基于 JVM 路由和服务端的负载均衡器。</li>
<li>spring-cloud-gateway,是spring 出品的基于spring 的网关项目，集成断路器，路径重写，性能比Zuul好。</li>
</ul>
<p>我们使用gateway这个网关技术，无缝衔接到基于spring cloud的微服务开发中来。</p>
<p>gateway官网：</p>
<p><a class="link" href="/posts/project-0/https://spring.io/projects/spring-cloud-gateway"  target="_blank" rel="noopener"
    >https://spring.io/projects/spring-cloud-gateway</a></p>
<h2 id="2-网关系统使用">2 网关系统使用</h2>
<h3 id="21-需求分析">2.1 需求分析</h3>
<p>​	由于我们开发的系统有包括前台系统和后台系统，后台的系统给管理员使用。那么也需要调用各种微服务，所以我们针对系统管理搭建一个网关系统。分析如下：
<img src="/posts/project-0/20220528162731/image-20220528164616303.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="22-搭建后台网关系统">2.2 搭建后台网关系统</h3>
<h4 id="221-搭建分析">2.2.1 搭建分析</h4>
<p>由上可知道，由于需要有多个网关，所以为了管理方便。我们新建一个项目，打包方式为pom,在里面建立各种网关系统模块即可。如图所示：
<img src="/posts/project-0/20220528162731/image-20220528164635790.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="222-工程搭建">2.2.2 工程搭建</h4>
<p>(1)引入依赖</p>
<p>修改dongyimai-gateway工程，打包方式为pom</p>
<p>pom.xml如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-gateway<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;packaging&gt;</span>pom<span style="color:#000080">&lt;/packaging&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modules&gt;</span>
</span></span><span style="display:flex;"><span>    		<span style="color:#000080">&lt;module&gt;</span>dongyimai-gateway-web<span style="color:#000080">&lt;/module&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/modules&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--网关依赖--&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        		<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        		<span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>在dongyimai-gateway工程中，创建 dongyimai-gateway-web工程，该网关主要用于对后台微服务进行一个调用操作，将多个微服务串联到一起。</p>
<p>pom.xml:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-gateway<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-gateway-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;description&gt;</span>
</span></span><span style="display:flex;"><span>    	普通web请求网关
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)启动类</p>
<p>在dongyimai-gateway-web中创建一个引导类com.offcn.GatewayWebApplication，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GatewayWebApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>   		SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>GatewayWebApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)application.yml配置</p>
<p>在dongyimai-gateway-web的resources下创建application.yml,代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>gateway-web<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:8761/eureka<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">management</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">endpoint</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">web</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">exposure</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">include</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="23-跨域配置">2.3 跨域配置</h3>
<p>有时候，我们需要对所有微服务跨域请求进行处理，则可以在gateway中进行跨域支持。修改application.yml,添加如下代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">cloud</span>:<span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">globalcors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">cors-configurations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">&#39;[/**]&#39;</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowCredentials</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedOrigins</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedMethods</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedHeaders</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>最终文件如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>gateway-web<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">cloud</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">globalcors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">cors-configurations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">&#39;[/**]&#39;</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#匹配所有请求</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedOrigins</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#998;font-style:italic">#跨域处理允许所有的域</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedMethods</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#支持的方法</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- GET<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- POST<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- PUT<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- DELETE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:8761/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="24-网关过滤配置">2.4 网关过滤配置</h3>
<p><img src="/posts/project-0/20220528162731/image-20220528164706189.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。路径过滤器的范围限定为特定路径。 Spring Cloud Gateway包含许多内置的GatewayFilter工厂。如上图，根据请求路径路由到不同微服务去，这块可以使用Gateway的路由过滤功能实现。</p>
<p>过滤器有20 多个实现类，包括头部过滤器、路径类过滤器、 Hystrix 过滤器和变更请求 URL 的过滤器，还有参数和状态码等其他类型的过滤器。</p>
<p>内置的过滤器工厂有22个实现类，包括头部过滤器、路径过滤器、Hystrix 过滤器、请求URL 变更过滤器，还有参数和状态码等其他类型的过滤器。根据过滤器工厂的用途来划分，可以分为以下几种：Header、Parameter、Path、Body、Status、Session、Redirect、Retry、RateLimiter和Hystrix。</p>
<h4 id="241-host-路由">2.4.1 Host 路由</h4>
<p>比如用户请求cloud.ujiuye.com的时候，可以将请求路由给http://localhost:9001服务处理，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164714373.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">      routes:
        - id: dongyimai_goods_route
          uri: http://localhost:9001
          predicates:
          - Host=cloud.ujiuye.com**
</code></pre><p>测试请求<code>http://cloud.ujiuye.com:8001/brand</code>,效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164721375.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：此时要想让cloud.ujiuye.com访问本地计算机，要配置<code>C:\Windows\System32\drivers\etc\hosts</code>文件,映射配置如下：</p>
<pre tabindex="0"><code>127.0.0.1 cloud.ujiuye.com
</code></pre><h4 id="242-路径匹配过滤配置">2.4.2 路径匹配过滤配置</h4>
<p>我们还可以根据请求路径实现对应的路由过滤操作，例如请求中以<code>/brand/</code>路径开始的请求，都直接交给<code>http://localhost:9001</code>服务处理，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164728166.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties"> routes:
		- id: dongyimai_goods_route
 		uri: http://localhost:9001
 		predicates:
		- Path=/brand**
</code></pre><p>测试请求<code>http://localhost:8001/brand</code>,效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164736491.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="243-prefixpath-过滤配置">2.4.3 PrefixPath 过滤配置</h4>
<p>用户每次请求路径的时候，我们可以给真实请求加一个统一前缀，例如用户请求<code>http://localhost:8001</code>的时候我们让它请求真实地址<code>http://localhost:8001/brand</code>，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164743528.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties"> routes:
		- id: dongyimai_goods_route
 		uri: http://localhost:9001
 		predicates:
		#- Host=cloud.ujiuye.com**
		- Path=/**
 		filters:
		- PrefixPath=/brand
</code></pre><p>测试请求<code>http://localhost:8001/</code>效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164750557.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="244-stripprefix-过滤配置">2.4.4 StripPrefix 过滤配置</h4>
<p>很多时候也会有这么一种请求，用户请求路径是<code>/api/brand</code>,而真实路径是<code>/brand</code>，这时候我们需要去掉<code>/api</code>才是真实路径，此时可以使用StripPrefix功能来实现路径的过滤操作，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164756182.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">     routes:
        - id: dongyimai_goods_route
          uri: http://localhost:9001
          predicates:
            - Path=/api/brand**
          filters:
            - StripPrefix=1
</code></pre><p>测试请求<code>http://localhost:8001/api/brand</code>,效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164809921.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="245-loadbalancerclient-路由过滤器客户端负载均衡">2.4.5 LoadBalancerClient 路由过滤器(客户端负载均衡)</h4>
<p>上面的路由配置每次都会将请求给指定的<code>URL</code>处理，但如果在以后生产环境，并发量较大的时候，我们需要根据服务的名称判断来做负载均衡操作，可以使用<code>LoadBalancerClientFilter</code>来实现负载均衡调用。<code>LoadBalancerClientFilter</code>会作用在url以lb开头的路由，然后利用<code>loadBalancer</code>来获取服务实例，构造目标<code>requestUrl</code>，设置到<code>GATEWAY_REQUEST_URL_ATTR</code>属性中，供<code>NettyRoutingFilter</code>使用。</p>
<p>修改application.yml配置文件，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528164816766.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties"> routes:
		- id: dongyimai_goods_route
			#uri: http://localhost:9001
 			uri: lb://goods
 			predicates:
			#- Host=cloud.ujiuye.com**
			  - Path=/**
 			filters:
			#- PrefixPath=/brand
			  - StripPrefix=1
</code></pre><p>测试请求路径<code>http://localhost:8001/api/brand</code>
<img src="/posts/project-0/20220528162731/image-20220528164823400.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="25-网关限流">2.5 网关限流</h3>
<p>网关可以做很多的事情，比如，限流，当我们的系统被频繁的请求的时候，就有可能将系统压垮，所以为了解决这个问题，需要在每一个微服务中做限流操作，但是如果有了网关，那么就可以在网关系统做限流，因为所有的请求都需要先通过网关系统才能路由到微服务中。</p>
<h4 id="251-思路分析">2.5.1 思路分析</h4>
<p><img src="/posts/project-0/20220528162731/image-20220528164829610.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="252-令牌桶算法">2.5.2 令牌桶算法</h4>
<p>令牌桶算法是比较常见的限流算法之一，大概描述如下：
1）所有的请求在处理之前都需要拿到一个可用的令牌才会被处理；
2）根据限流大小，设置按照一定的速率往桶里添加令牌；
3）桶设置最大的放置令牌限制，当桶满时、新添加的令牌就被丢弃或者拒绝；
4）请求达到后首先要获取令牌桶中的令牌，拿着令牌才可以进行其他的业务逻辑，处理完业务逻辑之后，将令牌直接删除；
5）令牌桶有最低限额，当桶中的令牌达到最低限额的时候，请求处理完之后将不会删除令牌，以此保证足够的限流</p>
<p>如下图：
<img src="/posts/project-0/20220528162731/image-20220528164835622.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这个算法的实现，有很多技术，Guaua是其中之一，redis客户端也有其实现。</p>
<h4 id="253-使用令牌桶进行请求次数限流">2.5.3 使用令牌桶进行请求次数限流</h4>
<p>spring cloud gateway 默认使用redis的RateLimter限流算法来实现。所以我们要使用首先需要引入redis的依赖</p>
<p>(1)引入redis依赖</p>
<p>在dongyimai-gateway的pom.xml中引入redis的依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--redis--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-data-redis-reactive<span style="color:#000080">&lt;/artifactId&gt;</span>  	
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)定义KeyResolver</p>
<p>在Applicatioin引导类中添加如下代码，KeyResolver用于计算某一个类型的限流的KEY也就是说，可以通过KeyResolver来指定限流的Key。</p>
<p>我们可以根据IP来限流，比如每个IP每秒钟只能请求一次，在GatewayWebApplication定义key的获取，获取客户端IP，将IP作为key，如下代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">* IP限流
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*@return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;ipKeyResolver&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> KeyResolver <span style="color:#900;font-weight:bold">userKeyResolver</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> KeyResolver<span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span> 		<span style="color:#000;font-weight:bold">public</span> Mono<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">resolve</span><span style="color:#000;font-weight:bold">(</span>ServerWebExchange exchange<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">//获取远程客户端IP
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      String hostName <span style="color:#000;font-weight:bold">=</span> exchange<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getRemoteAddress</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getHostAddress</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;hostName:&#34;</span><span style="color:#000;font-weight:bold">+</span>hostName<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">return</span> Mono<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">just</span><span style="color:#000;font-weight:bold">(</span>hostName<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)修改application.yml中配置项，指定限制流量的配置以及REDIS的配置，如图</p>
<p>修改如下图：
<img src="/posts/project-0/20220528162731/image-20220528164842878.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>配置代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">cloud</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">globalcors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">cors-configurations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">&#39;[/**]&#39;</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 匹配所有请求</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedOrigins</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#跨域处理 允许所有的域</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">allowedMethods</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 支持的方法</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- GET<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- POST<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- PUT<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- DELETE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">routes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>- <span style="color:#000080">id</span>:<span style="color:#bbb"> </span>dongyimai_goods_route<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">uri</span>:<span style="color:#bbb"> </span>lb://DYM-SELLERGOODS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">predicates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#998;font-style:italic"># - Host=cloud.ujiuye.com**</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- Path=/api/album/**,/api/brand/**<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- StripPrefix=1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>RequestRateLimiter<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#请求数限流 名字不能随便写 ，使用默认的facatory</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">args</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#000080">key-resolver</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;#{@ipKeyResolver}&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#000080">redis-rate-limiter.replenishRate</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#000080">redis-rate-limiter.burstCapacity</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>gateway-web<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">#Redis配置</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">redis</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#000080">host</span>:<span style="color:#bbb"> </span><span style="color:#099">192.168.188.129</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">6379</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:8761/eureka<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">instance</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">lease-renewal-interval-in-seconds</span>:<span style="color:#bbb"> </span><span style="color:#099">5</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 每隔5秒发送一次心跳</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">lease-expiration-duration-in-seconds</span>:<span style="color:#bbb"> </span><span style="color:#099">10</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 10秒不发送就过期</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">prefer-ip-address</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ip-address</span>:<span style="color:#bbb"> </span><span style="color:#099">127.0.0.1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">instance-id</span>:<span style="color:#bbb"> </span>${spring.application.name}:${server.port}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">management</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">endpoint</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">web</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">exposure</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">include</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>解释：</p>
<p><code>redis-rate-limiter.replenishRate</code>是您希望允许用户每秒执行多少请求，而不会丢弃任何请求。这是令牌桶填充的速率</p>
<p><code>redis-rate-limiter.burstCapacity</code>是指令牌桶的容量，允许在一秒钟内完成的最大请求数,将此值设置为零将阻止所有请求。</p>
<p>key-resolver: &ldquo;#{@ipKeyResolver}&ldquo;用于通过SPEL表达式来指定使用哪一个KeyResolver.</p>
<p>如上配置：</p>
<p>表示一秒内，允许一个请求通过，令牌桶的填充速率也是一秒钟添加一个令牌。</p>
<p>最大突发状况也只允许一秒内有一次请求，可以根据业务来调整。</p>
<h2 id="3-用户登录">3 用户登录</h2>
<p>项目中有2个重要角色，分别为管理员和用户，下面几章我们将实现购物下单和支付，用户如果没登录是没法下单和支付的，所以我们这里需要实现一个登录功能。</p>
<h3 id="31-表结构介绍">3.1 表结构介绍</h3>
<p>tb_user表结构如下：
<img src="/posts/project-0/20220528162731/image-20220528164851330.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="32-登录">3.2 登录</h3>
<p>登录的时候，需要进行密码校验，这里采用了BCryptPasswordEncoder进行加密，需要将资料中的BCrypt导入到common工程中，其中BCrypt.checkpw(&ldquo;明文&rdquo;,&ldquo;密文&rdquo;)用于对比密码是否一致。</p>
<p>修改dongyimai-service-user的com.offcn.user.service.UserService添加根据用户名查询用户方法，代码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>User <span style="color:#900;font-weight:bold">findByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>修改服务实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> User <span style="color:#900;font-weight:bold">findByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       User user <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> userList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findList</span><span style="color:#000;font-weight:bold">(</span>user<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>userList<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>userList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()&gt;</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> userList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改dongyimai-service-user的com.offcn.user.controller.UserController添加登录方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*用户登录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/login&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">login</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span>String password<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span> 	User user <span style="color:#000;font-weight:bold">=</span>  userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>user<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> BCrypt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkpw</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">,</span>user<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">())){</span>
</span></span><span style="display:flex;"><span> 		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;登录成功！&#34;</span><span style="color:#000;font-weight:bold">,</span>user<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#000;font-weight:bold">return</span>  <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">LOGINERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;账号或者密码错误！&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意：这里密码进行了加密，使用BCrypt.checkpw比对密码。</p>
<p><a class="link" href="/posts/project-0///%e6%a0%b9%e6%8d%ae%e7%99%bb%e5%bd%95%e7%94%a8%e6%88%b7%e5%90%8d%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af" ></a></p>
<p>使用Postman测试如下：
<img src="/posts/project-0/20220528162731/image-20220528164859911.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="34-网关关联">3.4 网关关联</h3>
<p><img src="/posts/project-0/20220528162731/image-20220528164906758.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>在我们平时工作中，并不会直接将微服务暴露出去，一般都会使用网关对接，实现对微服务的一个保护作用，如上图，当用户访问<code>/api/user/</code>的时候我们再根据用户请求调用用户微服务的指定方法。当然，除了<code>/api/user/</code>还有<code>/api/address/</code>、<code>/api/areas/</code>、<code>/api/cities/</code>、<code>/api/provinces/</code>都需要由user微服务处理，修改网关工程<code>dongyimai-gateway-web</code>的application.yml配置文件，如下代码：
<img src="/posts/project-0/20220528162731/image-20220528164912299.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring:
 	cloud:
 		gateway:
 			globalcors:
 				cors-configurations:
					&#39;[/**]&#39;: #匹配所有请求
           allowedOrigins: &#34;*&#34;#跨域处理允许所有的域
           allowedMethods: #支持的方法
          - GET
          - POST
          - PUT
          - DELETE
 routes:
		- id: dongyimai_goods_route
 		uri: lb://DYM-SELLERGOODS
 		predicates:
    #- Host=cloud.ujiuye.com**
    - Path=/api/brand**
    filters:
    - StripPrefix=1
    - name: RequestRateLimiter #请求数限流名字不能随便写，使用默认的facatory
    		args:
           key-resolver: &#34;#{@ipKeyResolver}&#34;
           redis-rate-limiter.replenishRate: 1
           redis-rate-limiter.burstCapacity: 1
#用户微服务
    - id: dongyimai_user_route
    uri: lb://DYM-USER
    predicates:
    	- Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**
    filters:
    	- StripPrefix=1
 application:
     name: gateway-web
#Redis配置
 redis:
 		host: 192.168.188.129
 		port: 6379

server:
 	port: 8001
eureka:
 	client:
 		service-url:
 			defaultZone: http://localhost:8761/eureka
 	instance:
 		prefer-ip-address: true
management:
 	endpoint:
 		gateway:
 			enabled: true
 	web:
 		exposure:
 			include: true
</code></pre><p>使用Postman访问[<code>http://localhost:8001/api/user/login](//根据登录用户名获取用户信息)?username=dongyimai&amp;password=dongyimai</code>，效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164920110.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-jwt讲解">4 JWT讲解</h2>
<h3 id="41-需求分析">4.1 需求分析</h3>
<p>我们之前已经搭建过了网关，使用网关在网关系统中比较适合进行权限校验。
<img src="/posts/project-0/20220528162731/image-20220528164927029.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>那么我们可以采用JWT的方式来实现鉴权校验。</p>
<h3 id="42-什么是jwt">4.2 什么是JWT</h3>
<p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p>
<h3 id="43-jwt的构成">4.3 JWT的构成</h3>
<p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p>
<p><strong>头部（Header）</strong></p>
<p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#000080">&#34;typ&#34;</span>:<span style="color:#d14">&#34;JWT&#34;</span>,<span style="color:#000080">&#34;alg&#34;</span>:<span style="color:#d14">&#34;HS256&#34;</span>}
</span></span></code></pre></div><p>在头部指明了签名算法是HS256算法。我们进行BASE64编码https://base64.us/，编码后的字符串如下：</p>
<pre tabindex="0"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9
</code></pre><blockquote>
<p>小知识：Base64是一种基于64个可打印字符来表示二进制数据的表示方法。由于2的6次方等于64，所以每6个比特为一个单元，对应某个可打印字符。三个字节有24个比特，对应于4个Base64单元，即3个字节需要用4个可打印字符来表示。JDK 中提供了非常方便的 <strong>BASE64Encoder</strong> 和 <strong>BASE64Decoder</strong>，用它们可以非常方便的完成基于 BASE64 的编码和解码</p>
</blockquote>
<p><strong>载荷（playload）</strong></p>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分</p>
<p>（1）标准中注册的声明（建议但不强制使用）</p>
<pre tabindex="0"><code>iss: jwt签发者
sub: jwt所面向的用户
aud: 接收jwt的一方
exp: jwt的过期时间，这个过期时间必须要大于签发时间
nbf: 定义在什么时间之前，该jwt都是不可用的.
iat: jwt的签发时间
jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。
</code></pre><p>（2）公共的声明</p>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</p>
<p>（3）私有的声明</p>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>这个指的就是自定义的claim。比如下面面结构举例中的admin和name都属于自定的claim。这些claim跟JWT标准规定的claim区别在于：JWT规定的claim，JWT的接收方在拿到JWT之后，都知道怎么对这些标准的claim进行验证(还不知道是否能够验证)；而private claims不会验证，除非明确告诉接收方要对这些claim进行验证以及规则才行。</p>
<p>定义一个payload:</p>
<pre tabindex="0"><code>{&#34;sub&#34;:&#34;1234567890&#34;,&#34;name&#34;:&#34;John Doe&#34;,&#34;admin&#34;:true}
</code></pre><p>然后将其进行base64加密，得到Jwt的第二部分。</p>
<pre tabindex="0"><code>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9
</code></pre><p><strong>签证（signature）</strong></p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<blockquote>
<p>header (base64后的)</p>
<p>payload (base64后的)</p>
<p>secret</p>
</blockquote>
<p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p>
<pre tabindex="0"><code>TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</code></pre><p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p>
<pre tabindex="0"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</code></pre><p><strong>注意</strong>：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret,那就意味着客户端是可以自我签发jwt了。</p>
<h3 id="44-jjwt的介绍和使用">4.4 JJWT的介绍和使用</h3>
<p>JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p>
<p>官方文档：</p>
<p><a class="link" href="/posts/project-0/https://github.com/jwtk/jjwt"  target="_blank" rel="noopener"
    >https://github.com/jwtk/jjwt</a></p>
<h4 id="441-创建token">4.4.1 创建TOKEN</h4>
<p>(1)依赖引入</p>
<p>在dongyimai-parent项目中的pom.xml中添加依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--鉴权--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>jjwt<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>0.9.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)创建测试</p>
<p>在dongyimai-common的/test/java下创建测试类，并设置测试方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">JwtTest</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">/****
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*创建Jwt令牌
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testCreateJwt</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>       	JwtBuilder builder<span style="color:#000;font-weight:bold">=</span> Jwts<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">builder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      	<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setId</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;888&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//设置唯一编号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      	<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSubject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;小白&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//设置主题可以是JSON数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      	<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setIssuedAt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">())</span><span style="color:#998;font-style:italic">//设置签发日期
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      	<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">signWith</span><span style="color:#000;font-weight:bold">(</span>SignatureAlgorithm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">HS256</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//设置签名使用HS256算法，并设置SecretKey(字符串)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      	<span style="color:#998;font-style:italic">//构建并返回一个字符串
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>       	System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span> builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compact</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>运行打印结果：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE2MTI3ODk0MjN9.adpNtewLbNZ-r6WUr8fyRLxFj1KF6PPP2UQq_VOxICo
</code></pre><p>再次运行，会发现每次运行的结果是不一样的，因为我们的载荷中包含了时间。</p>
<h4 id="442-token解析">4.4.2 TOKEN解析</h4>
<p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*解析Jwt令牌数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testParseJwt</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span> 		String 			compactJwt<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjIyODd9.RBLpZ79USMplQyfJCZFD2muHV_KLks7M1ZsjTu6Aez4&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> 		Claims claims <span style="color:#000;font-weight:bold">=</span> Jwts<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parser</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span> 		setSigningKey<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span> 		parseClaimsJws<span style="color:#000;font-weight:bold">(</span>compactJwt<span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span> 		getBody<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span> 		System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>运行打印效果：</p>
<pre tabindex="0"><code>{jti=888, sub=小白, iat=1562062287}
</code></pre><p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token.</p>
<h4 id="443-设置过期时间">4.4.3 设置过期时间</h4>
<p>有很多时候，我们并不希望签发的token是永久生效的，所以我们可以为token添加一个过期时间。</p>
<h5 id="4431-token过期设置">4.4.3.1 token过期设置</h5>
<p><img src="/posts/project-0/20220528162731/image-20220528164946738.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>解释：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">.setExpiration(date)//用于设置过期时间，参数为Date类型数据
</code></pre><p>运行，打印效果如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q
</code></pre><h5 id="4432-解析token">4.4.3.2 解析TOKEN</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*解析Jwt令牌数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testParseJwt</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>     String compactJwt<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>     Claims claims <span style="color:#000;font-weight:bold">=</span> Jwts<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parser</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>     setSigningKey<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>     parseClaimsJws<span style="color:#000;font-weight:bold">(</span>compactJwt<span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>     getBody<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>     System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>打印效果：
<img src="/posts/project-0/20220528162731/image-20220528164953754.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>当前时间超过过期时间，则会报错。</p>
<p>可以设置秘钥的过期时间：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setExpiration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentTimeMillis</span><span style="color:#000;font-weight:bold">()+</span>100000<span style="color:#000;font-weight:bold">));</span><span style="color:#998;font-style:italic">//设置过期时间
</span></span></span></code></pre></div><h4 id="444-自定义claims">4.4.4 自定义claims</h4>
<p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色）可以定义自定义claims。</p>
<p>创建测试类，并设置测试方法：</p>
<p>创建token:
<img src="/posts/project-0/20220528162731/image-20220528164959390.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>运行打印效果：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE2MTI3OTAyOTAsImV4cCI6MTYxMjc5MDI5MCwiYWRkcmVzcyI6IuWMl-S6rOW4guacnemYs-WMuuS6lOaWueahpeWfuuWcsCIsIm5hbWUiOiLkuK3lhazkvJjlsLHkuJoifQ.VwVrb-wuxb_BCLlSn2GY_m8z2pWpdU-KdtkeAY8gp5k
</code></pre><p>解析TOKEN:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*解析Jwt令牌数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testParseJwt</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span> 		String compactJwt<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE2MTI3OTA2NTAsImFkZHJlc3MiOiLljJfkuqzluILmnJ3pmLPljLrkupTmlrnmoaXln7rlnLAiLCJuYW1lIjoi5Lit5YWs5LyY5bCx5LiaIn0.zHmA-MY0wg-aDSV9xrf16_ExvxUKcwNrTCsFSjFOUuc&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> 		Claims claims <span style="color:#000;font-weight:bold">=</span> Jwts<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parser</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span> 		setSigningKey<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span> 		parseClaimsJws<span style="color:#000;font-weight:bold">(</span>compactJwt<span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span> 		getBody<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span> 		System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>运行效果：
<img src="/posts/project-0/20220528162731/image-20220528165006261.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="45-鉴权处理">4.5 鉴权处理</h3>
<h4 id="451-思路分析">4.5.1 思路分析</h4>
<p><img src="/posts/project-0/20220528162731/image-20220528165012604.png"
    
    
    
    loading="lazy"
    
    
></p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.用户通过访问微服务网关调用微服务，同时携带头文件信息
2.在微服务网关这里进行拦截，拦截后获取用户要访问的路径
3.识别用户访问的路径是否需要登录，如果需要，识别用户的身份是否能访问该路径[这里可以基于数据库设计一套权限]
4.如果需要权限访问，用户已经登录，则放行
5.如果需要权限访问，且用户未登录，则提示用户需要登录
6.用户通过网关访问用户微服务，进行登录验证
7.验证通过后，用户微服务会颁发一个令牌给网关，网关会将用户信息封装到头文件中，并响应用户
8.用户下次访问，携带头文件中的令牌信息即可识别是否登录
</code></pre><h4 id="452用户登录签发token">4.5.2用户登录签发TOKEN</h4>
<p>(1)生成令牌工具类</p>
<p>在dongyimai-common中创建类utils.JwtUtil，主要辅助生成Jwt令牌信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">JwtUtil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//有效期为
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> Long JWT_TTL <span style="color:#000;font-weight:bold">=</span> 3600000L<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//60 *60 *1000 一个小时
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//Jwt令牌信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String JWT_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *生成token令牌方法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     **/</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">createJWT</span><span style="color:#000;font-weight:bold">(</span>String id<span style="color:#000;font-weight:bold">,</span> String subject<span style="color:#000;font-weight:bold">,</span> Long ttlMillis<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//指定签名算法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     SignatureAlgorithm signatureAlgorithm <span style="color:#000;font-weight:bold">=</span> SignatureAlgorithm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">HS256</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//当前系统时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     <span style="color:#458;font-weight:bold">long</span> nowMillis <span style="color:#000;font-weight:bold">=</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentTimeMillis</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//令牌签发时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     Date now <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">(</span>nowMillis<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//如果令牌有效期为null，则默认设置有效期1小时
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>ttlMillis<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>     ttlMillis<span style="color:#000;font-weight:bold">=</span>JwtUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">JWT_TTL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//令牌过期时间设置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     <span style="color:#458;font-weight:bold">long</span> expMillis <span style="color:#000;font-weight:bold">=</span> nowMillis <span style="color:#000;font-weight:bold">+</span> ttlMillis<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>     Date expDate <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">(</span>expMillis<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//生成秘钥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     SecretKey secretKey <span style="color:#000;font-weight:bold">=</span> generalKey<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//封装Jwt令牌信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     JwtBuilder builder <span style="color:#000;font-weight:bold">=</span> Jwts<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">builder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setId</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//唯一的ID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSubject</span><span style="color:#000;font-weight:bold">(</span>subject<span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//主题可以是JSON数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setIssuer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//签发者
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setIssuedAt</span><span style="color:#000;font-weight:bold">(</span>now<span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//签发时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">signWith</span><span style="color:#000;font-weight:bold">(</span>signatureAlgorithm<span style="color:#000;font-weight:bold">,</span> secretKey<span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//签名算法以及密匙
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setExpiration</span><span style="color:#000;font-weight:bold">(</span>expDate<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">//设置过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>         <span style="color:#000;font-weight:bold">return</span> builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compact</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *生成加密 secretKey
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> SecretKey <span style="color:#900;font-weight:bold">generalKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>         <span style="color:#458;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">[]</span> encodedKey <span style="color:#000;font-weight:bold">=</span> Base64<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEncoder</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span>JwtUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">JWT_KEY</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBytes</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>         SecretKey key <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SecretKeySpec<span style="color:#000;font-weight:bold">(</span>encodedKey<span style="color:#000;font-weight:bold">,</span>0<span style="color:#000;font-weight:bold">,</span> encodedKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;AES&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">return</span> key<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *解析令牌数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@param jwt
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> Claims <span style="color:#900;font-weight:bold">parseJWT</span><span style="color:#000;font-weight:bold">(</span>String jwt<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         SecretKey secretKey <span style="color:#000;font-weight:bold">=</span> generalKey<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">return</span> Jwts<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parser</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSigningKey</span><span style="color:#000;font-weight:bold">(</span>secretKey<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseClaimsJws</span><span style="color:#000;font-weight:bold">(</span>jwt<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)用户登录成功则签发TOKEN，修改登录的方法：
<img src="/posts/project-0/20220528162731/image-20220528165023156.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*用户登录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/login&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">login</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span>String password<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>     User user <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findById</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>user<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> BCrypt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkpw</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">,</span>user<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">())){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//设置令牌信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>         Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> info <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>         info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>         info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;success&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;SUCCESS&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>         info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">,</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//生成令牌
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>         String jwt <span style="color:#000;font-weight:bold">=</span> JwtUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createJWT</span><span style="color:#000;font-weight:bold">(</span>UUID<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">randomUUID</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(),</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>info<span style="color:#000;font-weight:bold">),</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;登录成功！&#34;</span><span style="color:#000;font-weight:bold">,</span>jwt<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">return</span>  <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">LOGINERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;账号或者密码错误！&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="453-网关过滤器拦截请求处理">4.5.3 网关过滤器拦截请求处理</h4>
<p>自定义全局过滤器，创建过滤器类，如图所示：
<img src="/posts/project-0/20220528162731/image-20220528165029839.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>AuthorizeFilter代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">AuthorizeFilter</span> <span style="color:#000;font-weight:bold">implements</span> GlobalFilter<span style="color:#000;font-weight:bold">,</span> Ordered <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//令牌头名字
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span> 		<span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String AUTHORIZE_TOKEN <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *全局过滤器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@param exchange
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@param chain
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Mono<span style="color:#000;font-weight:bold">&lt;</span>Void<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">filter</span><span style="color:#000;font-weight:bold">(</span>ServerWebExchange exchange<span style="color:#000;font-weight:bold">,</span> GatewayFilterChain chain<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取Request、Response对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        ServerHttpRequest request <span style="color:#000;font-weight:bold">=</span> exchange<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        ServerHttpResponse response <span style="color:#000;font-weight:bold">=</span> exchange<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取请求的URI
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String path <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getURI</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//如果是登录、goods等开放的微服务[这里的goods部分开放],则直接放行,这里不做完整演示，完整演示需要设计一套权限系统
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/api/user/login&#34;</span><span style="color:#000;font-weight:bold">)||</span> path<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/api/brand/search/&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Mono<span style="color:#000;font-weight:bold">&lt;</span>Void<span style="color:#000;font-weight:bold">&gt;</span> filter <span style="color:#000;font-weight:bold">=</span> chain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span>exchange<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> filter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取头文件中的令牌信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String tokent <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeaders</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getFirst</span><span style="color:#000;font-weight:bold">(</span>AUTHORIZE_TOKEN<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//如果头文件中没有，则从请求参数中获取
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>tokent<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            tokent <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQueryParams</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getFirst</span><span style="color:#000;font-weight:bold">(</span>AUTHORIZE_TOKEN<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//如果为空，则输出错误代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>tokent<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//设置方法不允许被访问，405错误代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatusCode</span><span style="color:#000;font-weight:bold">(</span>HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">METHOD_NOT_ALLOWED</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setComplete</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//解析令牌数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            Claims claims <span style="color:#000;font-weight:bold">=</span> JwtUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseJWT</span><span style="color:#000;font-weight:bold">(</span>tokent<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//解析失败，响应401错误
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatusCode</span><span style="color:#000;font-weight:bold">(</span>HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UNAUTHORIZED</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setComplete</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> chain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span>exchange<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *过滤器执行顺序
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    *@return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">getOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>需要在dongyimai-gateway-web引入dongyimai-common的依赖</p>
<pre tabindex="0"><code> &lt;dependency&gt;
            &lt;groupId&gt;com.offcn&lt;/groupId&gt;
            &lt;artifactId&gt;dongyimai-common&lt;/artifactId&gt;
            &lt;version&gt;1.0&lt;/version&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
</code></pre><p>注意：需要排除spring-boot-starter-web的依赖</p>
<p>引入之后，启动网关会包一个错误，和SpringMVC冲突
<img src="/posts/project-0/20220528162731/image-20220528165038544.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="454-配置过滤规则">4.5.4 配置过滤规则</h4>
<p>修改网关系统的yml文件：
<img src="/posts/project-0/20220528162731/image-20220528165043770.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上述代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">cloud</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">globalcors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 				</span><span style="color:#000080">corsConfigurations</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">					</span><span style="color:#000080">&#39;[/**]&#39;</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#匹配所有请求</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#000080">allowedOrigins</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#998;font-style:italic">#跨域处理允许所有的域</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#000080">allowedMethods</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#支持的方法</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- GET<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- POST<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- PUT<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- DELETE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">routes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">			</span>- <span style="color:#000080">id</span>:<span style="color:#bbb"> </span>dongyimai_goods_route<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">uri</span>:<span style="color:#bbb"> </span>lb://goods<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">predicates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">				</span>- <span style="color:#bbb">	</span>Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">				</span>- StripPrefix=1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">				</span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>RequestRateLimiter<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#请求数限流名字不能随便写，使用默认的facatory</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">args</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#000080">key-resolver</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;#{@ipKeyResolver}&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#000080">redis-rate-limiter.replenishRate</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span><span style="color:#000080">redis-rate-limiter.burstCapacity</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#用户微服务</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">			</span>- <span style="color:#000080">id</span>:<span style="color:#bbb"> </span>dongyimai_user_route<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">uri</span>:<span style="color:#bbb"> </span>lb://user<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">predicates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">				</span>- Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">				</span>- StripPrefix=1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>gateway-web<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#998;font-style:italic">#Redis配置</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#000080">redis</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">host</span>:<span style="color:#bbb"> </span><span style="color:#099">192.168.188.129</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">6379</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:8761/eureka<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 	</span><span style="color:#000080">instance</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">prefer-ip-address</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">management</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 		</span><span style="color:#000080">endpoint</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 			</span><span style="color:#000080">gateway</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 				</span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">web</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">exposure</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">include</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>测试访问<code>http://localhost:8001/api/user/login?username=dongyimai&amp;password=dongyimai</code>，效果如下：
<img src="/posts/project-0/20220528162731/image-20220528165051182.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试访问 http://localhost:8001/api/user，效果如下：</p>
<p><img src="/posts/project-0/20220528162731/image-20220528165056416.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用postman在请求头加入token，在测试，可以正常访问
<img src="/posts/project-0/20220528162731/image-20220528165126095.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>参考官方手册：</p>
<p><a class="link" href="/posts/project-0/https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory"  target="_blank" rel="noopener"
    >https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory</a></p>
<h3 id="46-会话保持">4.6 会话保持</h3>
<p>用户每次请求的时候，我们都需要获取令牌数据，方法有多重，可以在每次提交的时候，将数据提交到头文件中，也可以将数据存储到Cookie中，每次从Cookie中校验数据，还可以每次将令牌数据以参数的方式提交到网关，这里面采用Cookie的方式比较容易实现。</p>
<h4 id="461-登录封装cookie">4.6.1 登录封装Cookie</h4>
<p>修改user微服务，每次登录的时候，添加令牌信息到Cookie中，修改dongyimai-user-service的<code>com.offcn.user.controller.UserController</code>的<code>login</code>方法，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528165133987.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *用户登录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/login&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">login</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> String password<span style="color:#000;font-weight:bold">,</span> HttpServletResponse response<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        User user <span style="color:#000;font-weight:bold">=</span>  userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>user<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> BCrypt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkpw</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">,</span>user<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">())){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//设置令牌信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> info<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;success&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;SUCCESS&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            info<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">,</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//生成令牌
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String jwt <span style="color:#000;font-weight:bold">=</span> JwtUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createJWT</span><span style="color:#000;font-weight:bold">(</span>UUID<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">randomUUID</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(),</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>info<span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//创建Cookie对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Cookie cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Cookie<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">,</span>jwt<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//设置cookie的路径
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cookie<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//把cookie使用响应头设置给浏览器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addCookie</span><span style="color:#000;font-weight:bold">(</span>cookie<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;登录成功！&#34;</span><span style="color:#000;font-weight:bold">,</span>jwt<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span>  <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">LOGINERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;账号或者密码错误！&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="462-过滤器获取令牌数据">4.6.2 过滤器获取令牌数据</h4>
<p>每次在网关中通过过滤器获取Cookie中的令牌，然后对令牌数据进行解析，修改微服务网关dongyimai-gateway-web中的AuthorizeFilter，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528165141292.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>登录后测试，可以识别用户身份，不登录无法识别。如下访问<code>http://localhost:8001/api/user</code>会携带令牌数据：
<img src="/posts/project-0/20220528162731/image-20220528165147428.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="463-添加header信息">4.6.3 添加Header信息</h4>
<p>我们还可以在Gateway的全局过滤器中添加请求头信息，例如可以将令牌信息添加到请求头中，在微服务中获取头信息，如下代码：</p>
<p>修改微服务网关中的过滤器，在令牌信息校验那块将令牌加入到请求头中，如下代码：
<img src="/posts/project-0/20220528162731/image-20220528165152441.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> Claims claims <span style="color:#000;font-weight:bold">=</span> JwtUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseJWT</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//把解析出来的令牌添加到头文件中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">mutate</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">header</span><span style="color:#000;font-weight:bold">(</span>AUTHORIZE_TOKEN<span style="color:#000;font-weight:bold">,</span>claims<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">());</span>
</span></span></code></pre></div><p>在dongyimai-service-user微服务的UserController的findAll方法中获取请求头测试，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528165159047.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">//获取请求头中封装的令牌
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String token <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;令牌信息:&#34;</span><span style="color:#000;font-weight:bold">+</span>token<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>测试请求地址:</p>
<p>http://localhost:8001/api/user/</p>
<p>后台输出令牌数据如下：
<img src="/posts/project-0/20220528162731/image-20220528165205303.jpeg"
    
    
    
    loading="lazy"
    
    
></p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528174166/">← 分布式事务</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528171137/">提交订单  →</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
