<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>提交订单</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }
  </style>

</head>
    <body style="    
    background-image: url(https://api.ixiaowai.cn/api/api.php);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;">
    <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap">
  <nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-28&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-28&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            6647 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            14 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['提交订单'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第十三章</h1>
<h1 align = "center">提交订单</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>登录页的配置</li>
<li>登录成功跳转实现</li>
<li>结算页查询实现</li>
<li>下单实现</li>
<li>变更库存</li>
<li>增加积分</li>
</ul>
<h2 id="1-登录页面配置">1 登录页面配置</h2>
<p>前面使用的都是采用Postman实现登录，接着我们实现一次oauth自定义登录。</p>
<h3 id="11-准备工作">1.1 准备工作</h3>
<p>(1)静态资源导入</p>
<p>将<code>资料/页面/前端</code>登录相关的静态资源导入到dongyimai-user-oauth中,如下图。
<img src="/posts/project-0/20220528171137/image-20220528171621679.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：为了测试在static目录编写一个测试页success.html</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>登录成功<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>登录成功<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>(2)引入thymeleaf</p>
<p>修改dongyimai-user-oauth，引入thymeleaf模板引擎</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--thymeleaf--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)登录配置</p>
<p>修改dongyimai-user-oauth,编写一个控制器<code>com.offcn.oauth.controller.LoginRedirect</code>，实现登录页跳转，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Controller</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/oauth&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginRedirect</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 跳转到登录页面
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;login&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)登录页配置</p>
<p>针对静态资源和登录页面，我们需要实现忽略安全配置，并且要指定登录页面。修改<code>com.offcn.oauth.config.WebSecurityConfig</code>的2个<code>configure</code>方法，代码如下：</p>
<p>第1个<code>configure</code>配置:
<img src="/posts/project-0/20220528171137/image-20220528171632388.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>第2个<code>configure</code>配置：
<img src="/posts/project-0/20220528171137/image-20220528171637310.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试</p>
<p>http://localhost:9100/oauth/login
<img src="/posts/project-0/20220528171137/image-20220528171643103.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="12-登录实现">1.2 登录实现</h3>
<p>点击登录按钮，访问之前的登录方法实现登录，我们需要对登录页做一下调整。</p>
<p>(1)引入thymeleaf命名空间</p>
<p>修改login.html，引入命名空间</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&#34;http://www.thymeleaf.org&#34;</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>(2)登录脚本</p>
<p>点击登录按钮，使用vue+axios实现登录，我们需要定义脚本访问后台登录方法。</p>
<p>先添加vue入口标签：修改login.html，在73行左右的标签上添加id=&ldquo;app&rdquo;,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;login-box&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--head--&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;py-container logoArea&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;logo&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    		…………略
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>引入js</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;/js/vue.js&#34;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&#34;@{/js/vue.js}&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;/js/axios.js&#34;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&#34;@{/js/axios.js}&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>登录脚本实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">th:inline</span><span class="o">=</span><span class="s">&#34;javascript&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">		<span class="nx">el</span><span class="o">:</span><span class="s2">&#34;#app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="o">:</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">username</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">password</span><span class="o">:</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">methods</span><span class="o">:</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">login</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/user/login?username=&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">username</span><span class="o">+</span><span class="s1">&#39;&amp;password=&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				    <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">flag</span><span class="p">){</span><span class="c1">//登录成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						   <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;登录成功&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						 <span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/success.html&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">						    <span class="nx">alert</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>(3)表单修改</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;sui-form&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;input-prepend&#34;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;add-on loginname&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;prependedInput&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&#34;邮箱/用户名/手机号&#34;</span>
</span></span><span class="line"><span class="cl">                                       <span class="na">class</span><span class="o">=</span><span class="s">&#34;span2 input-xfat&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;input-prepend&#34;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;add-on loginpwd&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;prependedInput&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&#34;请输入密码&#34;</span>
</span></span><span class="line"><span class="cl">                                       <span class="na">class</span><span class="o">=</span><span class="s">&#34;span2 input-xfat&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;setting&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;checkbox inline&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;m1&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;checkbox&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;2&#34;</span> <span class="na">checked</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                    自动登录
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;forget&#34;</span><span class="p">&gt;</span>忘记密码？<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;logined&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;sui-btn btn-block btn-xlarge btn-danger&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;login()&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                    登<span class="ni">&amp;nbsp;&amp;nbsp;</span>录
</span></span><span class="line"><span class="cl">                                <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>注意表单:<code>&lt;form&gt;</code>改成<code>&lt;div&gt;</code>避免出现点击登录按钮默认提交表单的情况。</p>
<p>（4）测试
<img src="/posts/project-0/20220528171137/image-20220528171707378.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>输入账号：dongyimai 密码: 123</p>
<p>登录成功，跳转到测试主页：
<img src="/posts/project-0/20220528171137/image-20220528171714959.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="13-登录跳转">1.3 登录跳转</h3>
<p>用户没有登录的时候，我们直接访问购物车，效果如下：</p>
<p>http://localhost:8001/api/cart/findCartList
<img src="/posts/project-0/20220528171137/image-20220528171719965.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们可以发现，返回的只是个错误状态码，不方便测试，我们可以重定向到登录页面，让用户登录，我们可以修改网关的头文件，让用户每次未登录的时候，都跳转到登录页面。</p>
<p>修改dongyimai-gateway-web的<code>com.offcn.filter.AuthorizeFilter</code>，代码如下：
<img src="/posts/project-0/20220528171137/image-20220528171724716.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>修改判断token为空的代码，把原来响应405，修改成跳转到登录网关登录页地址
<img src="/posts/project-0/20220528171137/image-20220528171729136.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>单独编写跳转方法：needAuthorization
<img src="/posts/project-0/20220528171137/image-20220528171734434.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//设置跳转方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">needAuthorization</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">SEE_OTHER</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;Location&#34;</span><span class="o">,</span><span class="n">url</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">setComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>此时再测试，就可以跳转到登录页面了。当然，在工作中，这里不能直接跳转到登录页，应该提示状态给页面，让页面根据判断跳转，这里只是为了方便测试。</p>
<h3 id="14-成功登录跳转到原访问页">1.4 成功登录跳转到原访问页</h3>
<p>上面虽然实现了登录跳转，但登录成功后却并没有返回到要访问的购物车页面，我们可以将用户要访问的页面作为参数传递给登录控制器，登录控制器记录下来，每次登录成功后，再跳转记录访问路劲参数指定的页面即可。</p>
<p>(1)修改网关携带当前URI</p>
<p>修改dongyimai-gateway-web的<code>com.offcn.filter.AuthorizeFilter</code>，在之前的URL后面添加FROM参数以及FROM参数的值为<code>request.getURI()</code>，代码如下：
<img src="/posts/project-0/20220528171137/image-20220528171741624.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：跳转地址，需要做UrlEncode编码处理</p>
<p>(2)认证服务器获取FROM参数</p>
<p>修改dongyimai-user-oauth的<code>com.offcn.oauth.controller.LoginRedirect</code>记录访问来源页，代码如下：
<img src="/posts/project-0/20220528171137/image-20220528171746170.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：接收过来的跳转url需要做Urldecode解码</p>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Controller</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/oauth&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginRedirect</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 跳转到登录页面
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;FROM&#34;</span><span class="o">,</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span><span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">from</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">decodeUrl</span> <span class="o">=</span> <span class="n">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="s">&#34;utf-8&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;from&#34;</span><span class="o">,</span><span class="n">decodeUrl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;form:&#34;</span><span class="o">+</span><span class="n">decodeUrl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;login&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改页面，获取来源页信息，并存到from变量中，登录成功后跳转到该地址。
<img src="/posts/project-0/20220528171137/image-20220528171752182.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">th:inline</span><span class="o">=</span><span class="s">&#34;javascript&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">el</span><span class="o">:</span> <span class="s2">&#34;#app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>           
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">login</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/user/login?username=&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="s1">&#39;&amp;password=&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">flag</span><span class="p">)</span> <span class="p">{</span><span class="c1">//登录成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           
</span></span><span class="line"><span class="cl">                            <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="p">[[</span><span class="nx">$from</span><span class="p">]];</span><span class="c1">//需要跳转到的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>此时再测试，就可以识别未登录用户，跳转到登录页，然后根据登录状态，如果登录成功，则跳转到来源页。</p>
<h2 id="2-订单确认页">2 订单确认页</h2>
<h3 id="21-收件地址分析">2.1 收件地址分析</h3>
<p>用户从购物车页面点击结算，跳转到订单结算页，结算页需要加载用户对应的收件地址，如下图：
<img src="/posts/project-0/20220528171137/image-20220528171801669.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>表结构分析：
<img src="/posts/project-0/20220528171137/image-20220528171813636.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们可以根据用户登录名去tb_address表中查询对应的数据。</p>
<h3 id="22-实现用户收件地址查询">2.2 实现用户收件地址查询</h3>
<h4 id="221-代码实现">2.2.1 代码实现</h4>
<p>(1)业务层</p>
<p>业务层接口</p>
<p>修改dongyimai-user-service微服务，需改com.offcn.user.service.AddressService接口，添加根据用户名字查询用户收件地址信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据用户查询地址
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param userId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">findListByUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span> <span class="o">);</span>
</span></span></code></pre></div><p>业务层接口实现类</p>
<p>修改dongyimai-service-user微服务，修改com.offcn.user.service.impl.AddressServiceImpl类，添加根据用户查询用户收件地址信息实现方法，如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 根据用户查询地址
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param userId
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">findListByUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">queryWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryWrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&#34;user_id&#34;</span><span class="o">,</span><span class="n">userId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//根据构建的条件查询数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">queryWrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(2)控制层</p>
<p>修改dongyimai-user-service微服务，修改com.offcn.user.controller.AddressController，添加根据用户名查询用户收件信息方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenDecode</span> <span class="n">tokenDecode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/****
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 用户收件地址
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/user/list&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;&gt;</span> <span class="nf">findListByUserId</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取用户登录信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">tokenDecode</span><span class="o">.</span><span class="na">getUserInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">userMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;user_name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//查询用户收件地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addressList</span> <span class="o">=</span> <span class="n">addressService</span><span class="o">.</span><span class="na">findListByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;查询成功！&#34;</span><span class="o">,</span><span class="n">addressList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>注意要在主启动类增加TokenDecode的声明</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">UserApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TokenDecode</span> <span class="nf">getTokenDecode</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">TokenDecode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="222-测试">2.2.2 测试</h4>
<p>访问 <a class="link" href="/posts/project-0/http://localhost:8001/api/address/user/list"  target="_blank" rel="noopener"
    >http://localhost:8001/api/address/user/list</a>
<img src="/posts/project-0/20220528171137/image-20220528171823324.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="223-运送清单学员完成">2.2.3 运送清单【学员完成】</h4>
<p><img src="/posts/project-0/20220528171137/image-20220528171828068.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>运送清单其实就是购物车列表，直接查询之前的购物车列表即可，这里不做说明了。</p>
<h2 id="3-下单">3 下单</h2>
<h3 id="31-业务分析">3.1 业务分析</h3>
<p>点击结算页的时候，会立即创建订单数据，创建订单数据会将数据存入到2张表中，分别是订单表和订单明细表，此处还需要修改商品对应的库存数量。
<img src="/posts/project-0/20220528171137/image-20220528171833750.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>订单表结构如下：
<img src="/posts/project-0/20220528171137/image-20220528171841074.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>订单明细表结构如下：
<img src="/posts/project-0/20220528171137/image-20220528171845285.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="32-下单实现">3.2 下单实现</h3>
<p>下单的时候，先添加订单往tb_order表中增加数据，再添加订单明细，往tb_order_item表中增加数据。</p>
<h4 id="321分布式id生成器">3.2.1分布式ID生成器</h4>
<p>我们采用的是开源的twitter(  非官方中文惯称：推特.是国外的一个网站，是一个社交网络及微博客服务) 的snowflake算法。
<img src="/posts/project-0/20220528171137/image-20220528171850502.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这里先修改dongyimai-order-service微服务，实现下单操作，这里会生成订单号，我们首先需要在启动类中创建一个IdWorker对象。</p>
<p>在<code>com.offcn.OrderApplication</code>中创建IdWorker，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">IdWorker</span> <span class="nf">idWorker</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">IdWorker</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改Pojo下的Order、OrderItem  Id生成方式：
<img src="/posts/project-0/20220528171137/image-20220528171855370.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(1)业务层</p>
<p>修改dongyimai-order-service微服务，修改com.offcn.order.service.impl.OrderServiceImpl,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">  <span class="c1">//注入redis操作类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">OrderItemMapper</span> <span class="n">orderItemMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IdWorker</span> <span class="n">idWorker</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增加Order
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param order
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 得到购物车数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Cart</span> <span class="n">cart</span> <span class="o">:</span> <span class="n">cartList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">orderId</span> <span class="o">=</span> <span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;sellerId:&#34;</span> <span class="o">+</span> <span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Order</span> <span class="n">tborder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">();</span><span class="c1">// 新创建订单对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//复制前端传递过来的订单的属性值，到新创建订单对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">BeanUtils</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">order</span><span class="o">,</span><span class="n">tborder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">tborder</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span><span class="c1">// 订单ID（一定要在复制属性后设置）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span><span class="c1">// 状态：未付款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">// 订单创建日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setUpdateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">// 订单更新日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span><span class="c1">// 商家ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 循环购物车明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">double</span> <span class="n">money</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">orderItem</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">orderItem</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span><span class="c1">// 订单ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">orderItem</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">money</span> <span class="o">+=</span> <span class="n">orderItem</span><span class="o">.</span><span class="na">getTotalFee</span><span class="o">().</span><span class="na">doubleValue</span><span class="o">();</span><span class="c1">// 金额累加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//保存购物明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">orderItemMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">tborder</span><span class="o">.</span><span class="na">setPayment</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">money</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//保存订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">tborder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//下单成功，清空redis购物车数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(2)控制层</p>
<p>修改dongyimai-order-service微服务，修改com.offcn.order.controller.OrderController类，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">TokenDecode</span> <span class="n">tokenDecode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 新增Order数据
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param order
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;Order添加&#34;</span><span class="o">,</span><span class="n">notes</span> <span class="o">=</span> <span class="s">&#34;添加Order方法详情&#34;</span><span class="o">,</span><span class="n">tags</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;OrderController&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">add</span><span class="o">(</span><span class="nd">@RequestBody</span>  <span class="nd">@ApiParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;Order对象&#34;</span><span class="o">,</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;传入JSON数据&#34;</span><span class="o">,</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>  <span class="n">Order</span> <span class="n">order</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取用户名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">tokenDecode</span><span class="o">.</span><span class="na">getUserInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">userMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;user_name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置购买用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">order</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">orderService</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;添加成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="322-测试">3.2.2 测试</h4>
<p>使用postMan
<img src="/posts/project-0/20220528171137/image-20220528171905934.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528171137/image-20220528171915257.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528171137/image-20220528171919352.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>保存订单测试，表数据变化如下：</p>
<p>tb_order表数据：
<img src="/posts/project-0/20220528171137/image-20220528171924107.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>tb_order_item表数据：
<img src="/posts/project-0/20220528171137/image-20220528171928857.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="33-库存变更">3.3 库存变更</h3>
<h4 id="331-业务分析">3.3.1 业务分析</h4>
<p>上面操作只实现了下单操作，但对应的库存还没跟着一起减少，我们在下单之后，应该调用商品微服务，将下单的商品库存减少，销量增加。每次订单微服务只需要将用户名传到商品微服务，商品微服务通过用户名到Redis中查询对应的购物车数据，然后执行库存减少，库存减少需要控制当前商品库存&gt;=销售数量。
<img src="/posts/project-0/20220528171137/image-20220528171933791.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如何控制库存数量&gt;=销售数量呢？其实可以通过SQL语句实现，每次减少数量的时候，加个条件判断。</p>
<p><code>where num&gt;=#{num}</code>即可。</p>
<h4 id="332-代码实现">3.3.2 代码实现</h4>
<p>要调用其他微服务，需要将头文件中的令牌数据携带到其他微服务中取，所以我们不能使用hystrix的多线程模式，修改dongyimai-sellergoods&ndash;service的applicatin.yml配置，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1">#hystrix 配置</span>
</span></span><span class="line"><span class="cl"><span class="na">hystrix</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">command</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">execution</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="na">isolation</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="na">thread</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="na">timeoutInMilliseconds</span><span class="o">:</span> <span class="s">10000</span>
</span></span><span class="line"><span class="cl">          <span class="na">strategy</span><span class="o">:</span> <span class="s">SEMAPHORE    #使用Seamphore，你创建了多少线程，实际就会有多少线程进行执行，只是可同时执行的线程数量会受到限制</span>
</span></span></code></pre></div><p>每次还需要使用拦截器添加头文件信息</p>
<p>修改配置类com.offcn.SellergoodsApplication添加Feign请求拦截器，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">FeignInterceptor</span> <span class="nf">feignInterceptor</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">FeignInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(1)Dao层</p>
<p>修改dongyimai-sellergoods-service微服务的<code>com.offcn.sellergoods.dao.ItemMapper</code>接口，增加库存递减方法,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">   <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 递减库存
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param orderItem
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Update</span><span class="o">(</span><span class="s">&#34;UPDATE tb_item SET num=num-#{num} WHERE id=#{itemId} AND num&gt;=#{num}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">decrCount</span><span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span><span class="o">);</span>
</span></span></code></pre></div><p>(2)业务层</p>
<p>修改dongyimai-sellergoods-service微服务的<code>com.offcn.sellergoods.service.ItemService</code>接口，添加如下方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 库存递减
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">decrCount</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span></code></pre></div><p>修改dongyimai-sellergoods-service微服务的<code>com.offcn.sellergoods.service.impl.ItemServiceImpl</code>实现类，添加一个实现方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ItemMapper</span> <span class="n">itemMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 库存递减
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">decrCount</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 得到购物车数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历购物车集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">Cart</span> <span class="n">cart</span> <span class="o">:</span> <span class="n">cartList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//遍历购物明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//递减库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">itemMapper</span><span class="o">.</span><span class="na">decrCount</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;库存不足，递减失败！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)控制层</p>
<p>修改dongyimai-sellergoods-service的<code>com.offcn.sellergoods.controller.ItemController</code>类，添加库存递减方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 库存递减
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/decr/count&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">decrCount</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//库存递减
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">itemService</span><span class="o">.</span><span class="na">decrCount</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;库存递减成功！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)创建feign</p>
<p>同时在dongyimai-sellergoods-service-api工程添加<code>com.offcn.sellergoods.feign.ItemFeign</code>的实现，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 库存递减
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/decr/count&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Result</span> <span class="nf">decrCount</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;username&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span></code></pre></div><h4 id="333--调用库存递减">3.3.3  调用库存递减</h4>
<p>修改dongyimai-order-service微服务的com.offcn.order.service.impl.OrderServiceImpl类的add方法，增加库存递减的调用。</p>
<p>先注入ItemFeign</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ItemFeign</span> <span class="n">itemFeign</span><span class="o">;</span>
</span></span></code></pre></div><p>再调用库存递减方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//减少库存  调用goods 微服务的 feign 减少库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">itemFeign</span><span class="o">.</span><span class="na">decrCount</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span></code></pre></div><p>注意：调用减少库存方法，要放置在清除redis购物车数据之前。</p>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增加Order
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param order
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 得到购物车数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Cart</span> <span class="n">cart</span> <span class="o">:</span> <span class="n">cartList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">orderId</span> <span class="o">=</span> <span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;sellerId:&#34;</span> <span class="o">+</span> <span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Order</span> <span class="n">tborder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">();</span><span class="c1">// 新创建订单对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//复制前端传递过来的订单的属性值，到新创建订单对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">BeanUtils</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">order</span><span class="o">,</span><span class="n">tborder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">tborder</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span><span class="c1">// 订单ID（一定要在复制属性后设置）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span><span class="c1">// 状态：未付款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">// 订单创建日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setUpdateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">// 订单更新日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tborder</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span><span class="c1">// 商家ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 循环购物车明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">double</span> <span class="n">money</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">orderItem</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">orderItem</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span><span class="c1">// 订单ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">orderItem</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">money</span> <span class="o">+=</span> <span class="n">orderItem</span><span class="o">.</span><span class="na">getTotalFee</span><span class="o">().</span><span class="na">doubleValue</span><span class="o">();</span><span class="c1">// 金额累加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//保存购物明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">orderItemMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">tborder</span><span class="o">.</span><span class="na">setPayment</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">money</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//保存订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">tborder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//******************减少库存********************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//减少库存  调用goods 微服务的 feign 减少库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">itemFeign</span><span class="o">.</span><span class="na">decrCount</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>需要设置开启Feign熔断、设置熔断时间、连接超时时间</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ReadTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">300000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#hystrix 配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">execution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">isolation</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">thread</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutInMilliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l">SEMAPHORE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><h4 id="334-测试">3.3.4 测试</h4>
<p>库存减少前，查询数据库Sku数据如下：个数9999，销量0
<img src="/posts/project-0/20220528171137/image-20220528171950633.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用Postman执行 http://localhost:8001/api/order/
<img src="/posts/project-0/20220528171137/image-20220528171954615.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>执行测试后，剩余库存9998，销量1
<img src="/posts/project-0/20220528171137/image-20220528171959659.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="34-增加积分学员完成">3.4 增加积分[学员完成]</h3>
<p>比如每次下单完成之后，给用户增加10个积分，支付完成后赠送优惠券，优惠券可用于支付时再次抵扣。我们先完成增加积分功能。如tb_user表：points表示用户积分</p>
<p><img src="/posts/project-0/20220528171137/image-20220528172004636.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="341-代码实现">3.4.1 代码实现</h4>
<p>(1)dao层</p>
<p>修改dongyimai-user-service微服务的<code>com.offcn.user.dao.UserMapper</code>接口，增加用户积分方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 增加用户积分
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param point
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Update</span><span class="o">(</span><span class="s">&#34;UPDATE tb_user SET points=points+#{point} WHERE  username=#{username}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">addUserPoints</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;point&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">point</span><span class="o">);</span>
</span></span></code></pre></div><p>(2)业务层</p>
<p>修改dongyimai-user-service微服务的<code>com.offcn.user.service.UserService</code>接口，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 添加用户积分
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param point
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">addUserPoints</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span><span class="n">Integer</span> <span class="n">point</span><span class="o">);</span>
</span></span></code></pre></div><p>修改dongyimai-user-service微服务的<code>com.offcn.user.service.impl.UserServiceImpl</code>，增加添加积分方法实现，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 添加用户积分
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param point
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUserPoints</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">point</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">addUserPoints</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">point</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)控制层</p>
<p>修改dongyimai-user-service微服务的<code>com.offcn.user.controller.UserController</code>，添加增加用户积分方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">TokenDecode</span> <span class="n">tokenDecode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 增加用户积分
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param points:要添加的积分
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/points/add&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">addPoints</span><span class="o">(</span><span class="n">Integer</span> <span class="n">points</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取用户名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">tokenDecode</span><span class="o">.</span><span class="na">getUserInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">userMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//添加积分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">userService</span><span class="o">.</span><span class="na">addUserPoints</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">points</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;添加积分成功！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)Feign添加</p>
<p>修改dongyimai-user-service-api工程，修改<code>com.offcn.user.feign.UserFeign</code>，添加增加用户积分方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 添加用户积分
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param points
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/points/add&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Result</span> <span class="nf">addPoints</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;points&#34;</span><span class="o">)</span><span class="n">Integer</span> <span class="n">points</span><span class="o">);</span>
</span></span></code></pre></div><h4 id="342-增加积分调用">3.4.2 增加积分调用</h4>
<p>修改dongyimai-order-service，添加dongyimai-user-service-api的依赖，修改pom.xml,添加如下依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--user api 依赖--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-user-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在增加订单的时候，同时添加用户积分，修改dongyimai-order-service微服务的<code>com.offcn.order.service.impl.OrderServiceImpl</code>下单方法，增加调用添加积分方法，代码如下：
<img src="/posts/project-0/20220528171137/image-20220528172015076.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>修改dongyimai-order-service的启动类<code>com.offcn.OrderApplication</code>，添加feign的包路径：
<img src="/posts/project-0/20220528171137/image-20220528172020917.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>//注意要设置tb_user表的每个用户的积分初始值为0</p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528162731/">← 微服务网关和Jwt令牌</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528172145/">支付宝支付 →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>