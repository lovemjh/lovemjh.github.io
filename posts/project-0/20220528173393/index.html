<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="ç§’æ€é«˜çº§ - https://lovemjh.vercel.app/posts/project-0/20220528173393/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>ç§’æ€é«˜çº§</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            ç§’æ€é«˜çº§
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">ğŸ“œ</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            11033 å­—</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            23 åˆ†é’Ÿ</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528172837/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528170121/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡</a></li>
        <li><a href="#1-é˜²æ­¢ç§’æ€é‡å¤æ’é˜Ÿ">1 é˜²æ­¢ç§’æ€é‡å¤æ’é˜Ÿ</a>
          <ul>
            <li><a href="#11-åå°æ’é˜Ÿè®°å½•">1.1 åå°æ’é˜Ÿè®°å½•</a></li>
          </ul>
        </li>
        <li><a href="#2-å¹¶å‘è¶…å–é—®é¢˜è§£å†³">2 å¹¶å‘è¶…å–é—®é¢˜è§£å†³</a>
          <ul>
            <li><a href="#21-æ€è·¯åˆ†æ">2.1 æ€è·¯åˆ†æ</a></li>
            <li><a href="#22-ä»£ç å®ç°">2.2 ä»£ç å®ç°</a></li>
            <li><a href="#23-è¶…å–æ§åˆ¶">2.3 è¶…å–æ§åˆ¶</a></li>
          </ul>
        </li>
        <li><a href="#3-ç§’æ€è®¢å•æ”¯ä»˜">3 ç§’æ€è®¢å•æ”¯ä»˜</a>
          <ul>
            <li><a href="#31-æ­å»ºæ”¯ä»˜æ¨¡å—">3.1 æ­å»ºæ”¯ä»˜æ¨¡å—</a>
              <ul>
                <li><a href="#1ä¿®æ”¹ä¾èµ–é…ç½®æ–‡ä»¶pomxml">ï¼ˆ1ï¼‰ã€ä¿®æ”¹ä¾èµ–é…ç½®æ–‡ä»¶pom.xml</a></li>
                <li><a href="#2é…ç½®æ–‡ä»¶applicationyml">ï¼ˆ2ï¼‰ã€é…ç½®æ–‡ä»¶application.yml</a></li>
              </ul>
            </li>
            <li><a href="#32-åˆ›å»ºæ”¯ä»˜äºŒç»´ç ">3.2 åˆ›å»ºæ”¯ä»˜äºŒç»´ç </a>
              <ul>
                <li><a href="#321-å›æ˜¾è®¢å•å·é‡‘é¢">3.2.1 å›æ˜¾è®¢å•å·ã€é‡‘é¢</a></li>
                <li><a href="#322-åˆ›å»ºäºŒç»´ç ">3.2.2 åˆ›å»ºäºŒç»´ç </a>
                  <ul>
                    <li><a href="#1ç¼–å†™æ”¯ä»˜æ¥å£å®šä¹‰é¢„ä¸‹å•æ–¹æ³•">ï¼ˆ1ï¼‰ã€ç¼–å†™æ”¯ä»˜æ¥å£ï¼Œå®šä¹‰é¢„ä¸‹å•æ–¹æ³•</a></li>
                    <li><a href="#2ç¼–å†™æ¥å£å®ç°ç±»">(2)ã€ç¼–å†™æ¥å£å®ç°ç±»</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#33-æ”¯ä»˜æµç¨‹åˆ†æ">3.3 æ”¯ä»˜æµç¨‹åˆ†æ</a></li>
            <li><a href="#34-æ”¯ä»˜å›è°ƒæ›´æ–°">3.4 æ”¯ä»˜å›è°ƒæ›´æ–°</a>
              <ul>
                <li><a href="#341-æ”¯ä»˜å›è°ƒé˜Ÿåˆ—æŒ‡å®š">3.4.1 æ”¯ä»˜å›è°ƒé˜Ÿåˆ—æŒ‡å®š</a>
                  <ul>
                    <li><a href="#3411-åœ¨é¢„ä¸‹å•æ—¶ä¼ é€’é˜Ÿåˆ—ä¿¡æ¯">3.4.1.1 åœ¨é¢„ä¸‹å•æ—¶ä¼ é€’é˜Ÿåˆ—ä¿¡æ¯</a></li>
                    <li><a href="#3412-æµ‹è¯•">3.4.1.2 æµ‹è¯•</a></li>
                    <li><a href="#3413-æ”¹é€ æ”¯ä»˜å›è°ƒæ–¹æ³•">3.4.1.3 æ”¹é€ æ”¯ä»˜å›è°ƒæ–¹æ³•</a></li>
                    <li><a href="#3414-å†…ç½‘ç©¿é€">3.4.1.4 å†…ç½‘ç©¿é€</a>
                      <ul>
                        <li><a href="#1ä¸‹è½½-cpolar">ï¼ˆ1ï¼‰ã€ä¸‹è½½ cpolar</a></li>
                        <li><a href="#2å®‰è£…">ï¼ˆ2ï¼‰ã€å®‰è£…ï¼š</a></li>
                        <li><a href="#3è¿æ¥æ‚¨çš„å¸æˆ·">ï¼ˆ3ï¼‰ã€è¿æ¥æ‚¨çš„å¸æˆ·ï¼š</a></li>
                        <li><a href="#4å¼€å¯ç«¯å£æ˜ å°„">ï¼ˆ4ï¼‰ã€å¼€å¯ç«¯å£æ˜ å°„</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li><a href="#342-æ”¯ä»˜çŠ¶æ€ç›‘å¬">3.4.2 æ”¯ä»˜çŠ¶æ€ç›‘å¬</a></li>
                <li><a href="#343-ä¿®æ”¹è®¢å•çŠ¶æ€">3.4.3 ä¿®æ”¹è®¢å•çŠ¶æ€</a>
                  <ul>
                    <li><a href="#3431-ä¸šåŠ¡å±‚">3.4.3.1 ä¸šåŠ¡å±‚</a></li>
                    <li><a href="#3432-ä¿®æ”¹è®¢å•å¯¹æ¥">3.4.3.2 ä¿®æ”¹è®¢å•å¯¹æ¥</a></li>
                  </ul>
                </li>
                <li><a href="#344-åˆ é™¤è®¢å•å›æ»šåº“å­˜">3.4.4 åˆ é™¤è®¢å•å›æ»šåº“å­˜</a>
                  <ul>
                    <li><a href="#3441-ä¸šåŠ¡å±‚å®ç°">3.4.4.1 ä¸šåŠ¡å±‚å®ç°</a></li>
                    <li><a href="#3442-è°ƒç”¨åˆ é™¤è®¢å•">3.4.4.2 è°ƒç”¨åˆ é™¤è®¢å•</a></li>
                    <li><a href="#3443-æµ‹è¯•">3.4.4.3 æµ‹è¯•</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#4-rabbitmqå»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—">4 RabbitMQå»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—</a>
          <ul>
            <li><a href="#41-å»¶æ—¶é˜Ÿåˆ—ä»‹ç»">4.1 å»¶æ—¶é˜Ÿåˆ—ä»‹ç»</a></li>
            <li><a href="#42-ttl-dlxå®ç°å»¶æ—¶é˜Ÿåˆ—">4.2 TTL DLXå®ç°å»¶æ—¶é˜Ÿåˆ—</a>
              <ul>
                <li><a href="#421-ttl-dlxä»‹ç»">4.2.1 TTL DLXä»‹ç»</a></li>
                <li><a href="#423-dlxå»¶æ—¶é˜Ÿåˆ—å®ç°">4.2.3 DLXå»¶æ—¶é˜Ÿåˆ—å®ç°</a>
                  <ul>
                    <li><a href="#4231-åˆ›å»ºå·¥ç¨‹">4.2.3.1 åˆ›å»ºå·¥ç¨‹</a></li>
                    <li><a href="#4232-é˜Ÿåˆ—åˆ›å»º">4.2.3.2 é˜Ÿåˆ—åˆ›å»º</a></li>
                    <li><a href="#4233-æ¶ˆæ¯ç›‘å¬">4.2.3.3 æ¶ˆæ¯ç›‘å¬</a></li>
                    <li><a href="#4234-åˆ›å»ºå¯åŠ¨ç±»">4.2.3.4 åˆ›å»ºå¯åŠ¨ç±»</a></li>
                    <li><a href="#4235-æµ‹è¯•">4.2.3.5 æµ‹è¯•</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#5-è¶…æ—¶æœªå®Œæˆæ”¯ä»˜è‡ªåŠ¨åˆ é™¤è®¢å•åº“å­˜å›æ»šä½œä¸š">5 è¶…æ—¶æœªå®Œæˆæ”¯ä»˜ã€è‡ªåŠ¨åˆ é™¤è®¢å•åº“å­˜å›æ»š(ä½œä¸š)</a>
          <ul>
            <li><a href="#51-ç§’æ€æµç¨‹å›é¡¾">5.1 ç§’æ€æµç¨‹å›é¡¾</a></li>
            <li><a href="#52-å…³é—­æ”¯ä»˜">5.2 å…³é—­æ”¯ä»˜</a></li>
            <li><a href="#53-å…³é—­è®¢å•å›æ»šåº“å­˜">5.3 å…³é—­è®¢å•å›æ»šåº“å­˜</a>
              <ul>
                <li><a href="#531-é…ç½®å»¶æ—¶é˜Ÿåˆ—">5.3.1 é…ç½®å»¶æ—¶é˜Ÿåˆ—</a></li>
                <li><a href="#532-å‘é€å»¶æ—¶æ¶ˆæ¯">5.3.2 å‘é€å»¶æ—¶æ¶ˆæ¯</a></li>
                <li><a href="#533-feignè°ƒç”¨æ”¯ä»˜æœåŠ¡å…³é—­é¢„ä¸‹å•æ¥å£">5.3.3 Feignè°ƒç”¨æ”¯ä»˜æœåŠ¡å…³é—­é¢„ä¸‹å•æ¥å£</a></li>
                <li><a href="#534-åº“å­˜å›æ»š">5.3.4 åº“å­˜å›æ»š</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">ç¬¬åå…­ç« </h1>
<h1 align = "center">ç§’æ€é«˜çº§</h1>
<h3 align="center">ä¼˜å°±ä¸š.JAVAæ•™ç ”å®¤</h3>
<h2 id="å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡</h2>
<ul>
<li>é˜²æ­¢ç§’æ€é‡å¤æ’é˜Ÿ</li>
<li>å¹¶å‘è¶…å–é—®é¢˜è§£å†³</li>
<li>è®¢å•æ”¯ä»˜</li>
<li>RabbitMQå»¶æ—¶é˜Ÿåˆ—</li>
<li>åº“å­˜å›æ»š</li>
</ul>
<h2 id="1-é˜²æ­¢ç§’æ€é‡å¤æ’é˜Ÿ">1 é˜²æ­¢ç§’æ€é‡å¤æ’é˜Ÿ</h2>
<p>ç”¨æˆ·æ¯æ¬¡æŠ¢å•çš„æ—¶å€™ï¼Œä¸€æ—¦æ’é˜Ÿï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªè‡ªå¢å€¼ï¼Œè®©è¯¥å€¼çš„åˆå§‹å€¼ä¸º1ï¼Œæ¯æ¬¡è¿›å…¥æŠ¢å•çš„æ—¶å€™ï¼Œå¯¹å®ƒè¿›è¡Œé€’å¢ï¼Œå¦‚æœå€¼&gt;1ï¼Œåˆ™è¡¨æ˜å·²ç»æ’é˜Ÿ,ä¸å…è®¸é‡å¤æ’é˜Ÿ,å¦‚æœé‡å¤æ’é˜Ÿï¼Œåˆ™å¯¹å¤–æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯è¡¨ç¤ºå·²ç»æ­£åœ¨æ’é˜Ÿã€‚
<img src="/posts/project-0/20220528173393/image-20220528173531584.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="11-åå°æ’é˜Ÿè®°å½•">1.1 åå°æ’é˜Ÿè®°å½•</h3>
<p>ä¿®æ”¹SeckillOrderServiceImplçš„addæ–¹æ³•ï¼Œæ–°å¢é€’å¢å€¼åˆ¤æ–­æ˜¯å¦æ’é˜Ÿä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173541835.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸Šå›¾ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//é€’å¢ï¼Œåˆ¤æ–­æ˜¯å¦æ’é˜Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Long userQueueCount <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> 1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>userQueueCount<span style="color:#000;font-weight:bold">&gt;</span>1<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//100ï¼šè¡¨ç¤ºæœ‰é‡å¤æŠ¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">REPERROR</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼š</p>
<p>é¦–æ¬¡ç§’æ€ä¸‹å•ï¼šhttp://localhost:8001/api/seckillOrder/add?id=1&amp;time=2021061914
<img src="/posts/project-0/20220528173393/image-20220528173553210.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æŸ¥çœ‹redisç¼“å­˜ï¼Œå‘ç°å·²ç»è®°å½•äº†UserQueueCount
<img src="/posts/project-0/20220528173393/image-20220528173557522.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å†æ¬¡é‡å¤ä¸‹å•ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173602357.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æŸ¥çœ‹æŸ¥çœ‹redisç¼“å­˜ï¼Œå‘ç°UserQueueCountè®°å½•çš„ç”¨æˆ·ä¸‹å•æ•°é‡å˜æˆäº†2</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173606706.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="2-å¹¶å‘è¶…å–é—®é¢˜è§£å†³">2 å¹¶å‘è¶…å–é—®é¢˜è§£å†³</h2>
<p>è¶…å–é—®é¢˜ï¼Œè¿™é‡Œæ˜¯æŒ‡å¤šäººæŠ¢è´­åŒä¸€å•†å“çš„æ—¶å€™ï¼Œå¤šäººåŒæ—¶åˆ¤æ–­æ˜¯å¦æœ‰åº“å­˜ï¼Œå¦‚æœåªå‰©ä¸€ä¸ªï¼Œåˆ™éƒ½ä¼šåˆ¤æ–­æœ‰åº“å­˜ï¼Œæ­¤æ—¶ä¼šå¯¼è‡´è¶…å–ç°è±¡äº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå•†å“ä¸‹äº†å¤šä¸ªè®¢å•çš„ç°è±¡ã€‚</p>
<h3 id="21-æ€è·¯åˆ†æ">2.1 æ€è·¯åˆ†æ</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528173621573.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>è§£å†³è¶…å–é—®é¢˜ï¼Œå¯ä»¥åˆ©ç”¨Redisé˜Ÿåˆ—å®ç°ï¼Œç»™æ¯ä»¶å•†å“åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å•†å“ä¸ªæ•°é˜Ÿåˆ—ï¼Œä¾‹å¦‚ï¼šAå•†å“æœ‰2ä¸ªï¼ŒAå•†å“çš„IDä¸º1001ï¼Œåˆ™å¯ä»¥åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—,key=SeckillGoodsCountList_1001,å¾€è¯¥é˜Ÿåˆ—ä¸­å¡2æ¬¡è¯¥å•†å“IDã€‚</p>
<p>æ¯æ¬¡ç»™ç”¨æˆ·ä¸‹å•çš„æ—¶å€™ï¼Œå…ˆä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œå¦‚æœèƒ½å–åˆ°æ•°æ®ï¼Œåˆ™è¡¨æ˜æœ‰åº“å­˜ï¼Œå¦‚æœå–ä¸åˆ°ï¼Œåˆ™è¡¨æ˜æ²¡æœ‰åº“å­˜ï¼Œè¿™æ ·å°±å¯ä»¥é˜²æ­¢è¶…å–é—®é¢˜äº§ç”Ÿäº†ã€‚</p>
<p>åœ¨æˆ‘ä»¬å¯¹Redisè¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œéƒ½æ˜¯å…ˆå°†æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼Œåœ¨å†…å­˜ä¸­ä¿®æ”¹ï¼Œç„¶åå­˜å…¥åˆ°Redisï¼Œåœ¨å¹¶å‘åœºæ™¯ï¼Œä¼šå‡ºç°æ•°æ®é”™ä¹±é—®é¢˜ï¼Œä¸ºäº†æ§åˆ¶æ•°é‡å‡†ç¡®ï¼Œæˆ‘ä»¬å•ç‹¬å°†å•†å“æ•°é‡æ•´ä¸€ä¸ªè‡ªå¢é”®ï¼Œ<strong>è‡ªå¢é”®</strong>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸æ‹…å¿ƒå¹¶å‘åœºæ™¯çš„é—®é¢˜ã€‚
<img src="/posts/project-0/20220528173393/image-20220528173625837.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="22-ä»£ç å®ç°">2.2 ä»£ç å®ç°</h3>
<p>æ¯æ¬¡å°†å•†å“å‹å…¥Redisç¼“å­˜çš„æ—¶å€™ï¼Œå¦å¤–å¤šåˆ›å»ºä¸€ä¸ªå•†å“çš„é˜Ÿåˆ—ã€‚</p>
<p>ä¿®æ”¹SeckillGoodsPushTask,æ·»åŠ ä¸€ä¸ªpushIdsæ–¹æ³•ï¼Œç”¨äºå°†æŒ‡å®šå•†å“IDæ”¾å…¥åˆ°æŒ‡å®šçš„æ•°å­—ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * å°†å•†å“IDå­˜å…¥åˆ°æ•°ç»„ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param len:é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param id :å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Long<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">pushIds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> len<span style="color:#000;font-weight:bold">,</span>Long id<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    Long<span style="color:#000;font-weight:bold">[]</span> ids <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Long<span style="color:#000;font-weight:bold">[</span>len<span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span>ids<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        ids<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]=</span>id<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> ids<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹SeckillGoodsPushTaskçš„loadGoodsPushRedisæ–¹æ³•ï¼Œæ·»åŠ é˜Ÿåˆ—æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173634081.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸Šå›¾ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//å•†å“æ•°æ®é˜Ÿåˆ—å­˜å‚¨,é˜²æ­¢é«˜å¹¶å‘è¶…å–
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Long<span style="color:#000;font-weight:bold">[]</span> ids <span style="color:#000;font-weight:bold">=</span> pushIds<span style="color:#000;font-weight:bold">(</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStockCount</span><span style="color:#000;font-weight:bold">(),</span> seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCountList_&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">leftPushAll</span><span style="color:#000;font-weight:bold">(</span>ids<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨è®°å½•å„ä¸ªå•†å“çš„åº“å­˜æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">(),</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStockCount</span><span style="color:#000;font-weight:bold">());</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼š</p>
<p>é‡å¯æœåŠ¡ï¼Œå‘ç°å®šæ—¶ä»»åŠ¡æ‰§è¡Œåï¼Œåœ¨redisç¼“å­˜å·²ç»è®°å½•äº†æ•°æ®idçš„é˜Ÿåˆ—SeckillGoodsCountList_1ã€SeckillGoodsCountList_2ç­‰ç­‰</p>
<p>å¹¶ä¸”ä¹Ÿè®°å½•äº†æ¯ä¸ªå•†å“çš„åº“å­˜æ•°é‡SeckillGoodsCoun
<img src="/posts/project-0/20220528173393/image-20220528173639758.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528173393/image-20220528173646339.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528173393/image-20220528173652235.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="23-è¶…å–æ§åˆ¶">2.3 è¶…å–æ§åˆ¶</h3>
<p>ä¿®æ”¹å¤šçº¿ç¨‹ä¸‹å•æ–¹æ³•ï¼Œåˆ†åˆ«ä¿®æ”¹æ•°é‡æ§åˆ¶ï¼Œä»¥åŠå”®ç½„åç”¨æˆ·æŠ¢å•æ’é˜Ÿä¿¡æ¯çš„æ¸…ç†ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹å›¾ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173657463.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸Šå›¾ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * å¤šçº¿ç¨‹ä¸‹å•æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Async</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">createOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//ä»é˜Ÿåˆ—ä¸­è·å–æ’é˜Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillStatus seckillStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillStatus<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrderQueue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">rightPop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªå•†å“
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Object sgood <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCountList_&#34;</span> <span style="color:#000;font-weight:bold">+</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">rightPop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>sgood<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//æ¸…ç†å½“å‰ç”¨æˆ·çš„æ’é˜Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            clearQueue<span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ—¶é—´åŒºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String time <span style="color:#000;font-weight:bold">=</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTime</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//ç”¨æˆ·ç™»å½•å
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String username<span style="color:#000;font-weight:bold">=</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//ç”¨æˆ·æŠ¢è´­å•†å“
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Long id <span style="color:#000;font-weight:bold">=</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–å•†å“æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillGoods goods <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillGoods<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span> <span style="color:#000;font-weight:bold">+</span> time<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å¦‚æœæœ‰åº“å­˜ï¼Œåˆ™åˆ›å»ºç§’æ€å•†å“è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SeckillOrder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setId</span><span style="color:#000;font-weight:bold">(</span>idWorker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nextId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSeckillId</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCostPrice</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUserId</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCreateTime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;0&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å°†ç§’æ€è®¢å•å­˜å…¥åˆ°Redisä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>seckillOrder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å•†å“åº“å­˜-1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Long surplusCount <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//å•†å“æ•°é‡é€’å‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStockCount</span><span style="color:#000;font-weight:bold">(</span>surplusCount<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">intValue</span><span style="color:#000;font-weight:bold">());</span>    <span style="color:#998;font-style:italic">//æ ¹æ®è®¡æ•°å™¨ç»Ÿè®¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ¤æ–­å½“å‰å•†å“æ˜¯å¦è¿˜æœ‰åº“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>surplusCount<span style="color:#000;font-weight:bold">&lt;=</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å¹¶ä¸”å°†å•†å“æ•°æ®åŒæ­¥åˆ°MySQLä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            seckillGoodsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateById</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å¦‚æœæ²¡æœ‰åº“å­˜,åˆ™æ¸…ç©ºRedisç¼“å­˜ä¸­è¯¥å•†å“
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span> <span style="color:#000;font-weight:bold">+</span> time<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å¦‚æœæœ‰åº“å­˜ï¼Œåˆ™ç›´æ•°æ®é‡ç½®åˆ°Reidsä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span> <span style="color:#000;font-weight:bold">+</span> time<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æŠ¢å•æˆåŠŸï¼Œæ›´æ–°æŠ¢å•çŠ¶æ€,æ’é˜Ÿ-&gt;ç­‰å¾…æ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatus</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setOrderId</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMoney</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">floatValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * æ¸…ç†ç”¨æˆ·æ’é˜Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param seckillStatus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">clearQueue</span><span style="color:#000;font-weight:bold">(</span>SeckillStatus seckillStatus<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ¸…ç†æ’é˜Ÿæ ‡ç¤º
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ¸…ç†æŠ¢å•æ ‡ç¤º
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼šæ­£å¸¸ç§’æ€ä¸‹å•</p>
<p>http://localhost:8001/api/seckillOrder/add?id=1&amp;time=2021061914</p>
<p>æŸ¥çœ‹redisä¸­çš„SeckillGoodsCountå‘ç°å¯¹åº”ç¼–å·çš„å•†å“å‡å»äº†åº“å­˜æ•°é‡ã€‚</p>
<h2 id="3-ç§’æ€è®¢å•æ”¯ä»˜">3 ç§’æ€è®¢å•æ”¯ä»˜</h2>
<p><img src="/posts/project-0/20220528173393/image-20220528173707704.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å®Œæˆç§’æ€ä¸‹è®¢å•åï¼Œè¿›å…¥æ”¯ä»˜é¡µé¢ï¼Œæ­¤æ—¶å‰ç«¯ä¼šæ¯3ç§’ä¸­å‘åå°å‘é€ä¸€æ¬¡è¯·æ±‚ç”¨äºåˆ¤æ–­å½“å‰ç”¨æˆ·è®¢å•æ˜¯å¦å®Œæˆæ”¯ä»˜ï¼Œå¦‚æœå®Œæˆäº†æ”¯ä»˜ï¼Œåˆ™éœ€è¦æ¸…ç†æ‰æ’é˜Ÿä¿¡æ¯ï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ä¿¡æ¯ã€‚</p>
<h3 id="31-æ­å»ºæ”¯ä»˜æ¨¡å—">3.1 æ­å»ºæ”¯ä»˜æ¨¡å—</h3>
<p>åˆ›å»ºæ¨¡å—dongyimai-payseckill-service</p>
<h4 id="1ä¿®æ”¹ä¾èµ–é…ç½®æ–‡ä»¶pomxml">ï¼ˆ1ï¼‰ã€ä¿®æ”¹ä¾èµ–é…ç½®æ–‡ä»¶pom.xml</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-service<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-payseckill-service<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!-- æ”¯ä»˜å®æ”¯ä»˜æ‰€éœ€ç±»åº“åŒ… --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alipay.sdk<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>alipay-sdk-java<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>4.11.54.ALL<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000080">&lt;groupId&gt;</span>org.bouncycastle<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000080">&lt;artifactId&gt;</span>bcprov-jdk15on<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-common<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fastjson<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.2.72<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><h4 id="2é…ç½®æ–‡ä»¶applicationyml">ï¼ˆ2ï¼‰ã€é…ç½®æ–‡ä»¶application.yml</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9006</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>pay<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">rabbitmq</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">host</span>:<span style="color:#bbb"> </span><span style="color:#099">192.168.188.128</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#mqçš„æœåŠ¡å™¨åœ°å€</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">username</span>:<span style="color:#bbb"> </span>guest<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#è´¦å·</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">password</span>:<span style="color:#bbb"> </span>guest<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#å¯†ç </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">alipay</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">serverUrl</span>:<span style="color:#bbb"> </span>https://openapi.alipaydev.com/gateway.do<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">notify-url</span>:<span style="color:#bbb"> </span>http://7r8ukqlrpt.52http.com/pay/notify/url<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">appId</span>:<span style="color:#bbb"> </span><span style="color:#099">2016091300500103</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">privateKey</span>:<span style="color:#bbb"> </span>ç”¨æˆ·ç§é’¥<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">alipayPublicKey</span>:<span style="color:#bbb"> </span>é˜¿é‡Œå…¬é’¥<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">format</span>:<span style="color:#bbb"> </span>json<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">charset</span>:<span style="color:#bbb"> </span>utf-8<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">signType</span>:<span style="color:#bbb"> </span>RSA2<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="32-åˆ›å»ºæ”¯ä»˜äºŒç»´ç ">3.2 åˆ›å»ºæ”¯ä»˜äºŒç»´ç </h3>
<p>ä¸‹å•æˆåŠŸåï¼Œä¼šè·³è½¬åˆ°æ”¯ä»˜é€‰æ‹©é¡µé¢ï¼Œåœ¨æ”¯ä»˜é€‰æ‹©é¡µé¢è¦æ˜¾ç¤ºè®¢å•ç¼–å·å’Œè®¢å•é‡‘é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä¸‹å•çš„æ—¶å€™ï¼Œå°†è®¢å•é‡‘é¢ä»¥åŠè®¢å•ç¼–å·ä¿¡æ¯å­˜å‚¨åˆ°ç”¨æˆ·æŸ¥è¯¢å¯¹è±¡ä¸­ã€‚</p>
<p>é€‰æ‹©æ‰«ç æ”¯ä»˜åï¼Œä¼šè·³è½¬åˆ°æ‰«ç æ”¯ä»˜é¡µé¢ï¼Œæ”¯ä»˜é¡µé¢ä¼šæ ¹æ®ç”¨æˆ·åæŸ¥çœ‹ç”¨æˆ·ç§’æ€è®¢å•ï¼Œå¹¶æ ¹æ®ç”¨æˆ·ç§’æ€è®¢å•çš„IDåˆ›å»ºé¢„æ”¯ä»˜ä¿¡æ¯å¹¶è·å–äºŒç»´ç ä¿¡æ¯ï¼Œå±•ç¤ºç»™ç”¨æˆ·çœ‹,æ­¤æ—¶é¡µé¢æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡æ”¯ä»˜çŠ¶æ€ï¼Œå¦‚æœæ”¯ä»˜æˆåŠŸï¼Œéœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ä¿¡æ¯ã€‚</p>
<h4 id="321-å›æ˜¾è®¢å•å·é‡‘é¢">3.2.1 å›æ˜¾è®¢å•å·ã€é‡‘é¢</h4>
<p>ä¸‹å•åï¼Œè¿›å…¥æ”¯ä»˜é€‰æ‹©é¡µé¢ï¼Œéœ€è¦æ˜¾ç¤ºè®¢å•å·å’Œè®¢å•é‡‘é¢ï¼Œæ‰€ä»¥éœ€è¦åœ¨ç”¨æˆ·ä¸‹å•åå°†è¯¥æ•°æ®ä¼ å…¥åˆ°pay.htmlé¡µé¢ï¼Œæ‰€ä»¥æŸ¥è¯¢è®¢å•çŠ¶æ€çš„æ—¶å€™ï¼Œéœ€è¦å°†è®¢å•å·å’Œé‡‘é¢å°è£…åˆ°æŸ¥è¯¢çš„ä¿¡æ¯ä¸­ï¼Œä¿®æ”¹æŸ¥è¯¢è®¢å•è£…çš„æ–¹æ³•åŠ å…¥ä»–ä»¬å³å¯ã€‚</p>
<p>ä¿®æ”¹SeckillOrderControllerçš„queryStatusæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173716301.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸Šå›¾ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatus</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#d14">&#34;æŠ¢è´­çŠ¶æ€&#34;</span><span style="color:#000;font-weight:bold">,</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä½¿ç”¨Postmanæµ‹è¯•ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p>http://localhost:8001/api/seckillOrder/query</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173722094.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>è®¢å•ç¼–å·ä¸ºLongå‹ï¼Œè½¬æ¢ä¸ºjsonå­—ç¬¦ä¸²å‡ºç°ç²¾åº¦æŸå¤±</p>
<p>å¤„ç†æ–¹æ³•ï¼šåœ¨è®¢å•çŠ¶æ€å®ä½“ç±»ï¼Œè®¢å•ç¼–å·å±æ€§å€¼ä¸Šå¢åŠ æ³¨è§£ï¼ŒæŠŠLongæŒ‰ç…§å­—ç¬¦ä¸²è¿›è¡Œåºåˆ—åŒ–</p>
<pre tabindex="0"><code>//è®¢å•å·

    @JsonSerialize(using = ToStringSerializer.class)
    private Long orderId;
</code></pre><h4 id="322-åˆ›å»ºäºŒç»´ç ">3.2.2 åˆ›å»ºäºŒç»´ç </h4>
<p>ç”¨æˆ·åˆ›å»ºäºŒç»´ç ï¼Œå¯ä»¥å…ˆæŸ¥è¯¢ç”¨æˆ·çš„ç§’æ€è®¢å•æŠ¢å•ä¿¡æ¯ï¼Œç„¶åå†å‘é€è¯·æ±‚åˆ°æ”¯ä»˜å¾®æœåŠ¡ä¸­åˆ›å»ºäºŒç»´ç ï¼Œå°†è®¢å•ç¼–å·ä»¥åŠè®¢å•å¯¹åº”çš„é‡‘é¢ä¼ é€’åˆ°æ”¯ä»˜å¾®æœåŠ¡:<code>/pay/create/native</code>ã€‚</p>
<p>ä¿®æ”¹æ”¯ä»˜æ¨¡å—dongyimai-payseckill-service</p>
<h5 id="1ç¼–å†™æ”¯ä»˜æ¥å£å®šä¹‰é¢„ä¸‹å•æ–¹æ³•">ï¼ˆ1ï¼‰ã€ç¼–å†™æ”¯ä»˜æ¥å£ï¼Œå®šä¹‰é¢„ä¸‹å•æ–¹æ³•</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">PayService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ç”ŸæˆäºŒç»´ç 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param out_trade_no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param total_fee
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="2ç¼–å†™æ¥å£å®ç°ç±»">(2)ã€ç¼–å†™æ¥å£å®ç°ç±»</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.AlipayApiException</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.DefaultAlipayClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.request.AlipayTradePrecreateRequest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.request.AlipayTradeQueryRequest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.response.AlipayTradePrecreateResponse</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.response.AlipayTradeQueryResponse</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pay.service.PayService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PayServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> PayService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ”¯ä»˜å®gatewayUrl
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.serverUrl}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String serverUrl<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å•†æˆ·åº”ç”¨id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.appId}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String appId<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * RSAç§é’¥ï¼Œç”¨äºå¯¹å•†æˆ·è¯·æ±‚æŠ¥æ–‡åŠ ç­¾
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.privateKey}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String privateKey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ”¯ä»˜å®RSAå…¬é’¥ï¼Œç”¨äºéªŒç­¾æ”¯ä»˜å®åº”ç­”
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.alipayPublicKey}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String alipayPublicKey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ç­¾åç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.signType}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String signType <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;RSA2&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¼å¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.format}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String formate <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;json&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ç¼–ç 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.charset}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String charset <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;UTF-8&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å¼‚æ­¥åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.notify-url}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String notifyUrl<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºé˜¿é‡Œæ”¯ä»˜å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DefaultAlipayClient alipayClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultAlipayClient<span style="color:#000;font-weight:bold">(</span>serverUrl<span style="color:#000;font-weight:bold">,</span> appId<span style="color:#000;font-weight:bold">,</span> privateKey<span style="color:#000;font-weight:bold">,</span> formate<span style="color:#000;font-weight:bold">,</span> charset<span style="color:#000;font-weight:bold">,</span> alipayPublicKey<span style="color:#000;font-weight:bold">,</span> signType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºé¢„ä¸‹å•è¯·æ±‚å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        AlipayTradePrecreateRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AlipayTradePrecreateRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è®¾ç½®å›è°ƒåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNotifyUrl</span><span style="color:#000;font-weight:bold">(</span>notifyUrl<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è®¾ç½®é¢„ä¸‹å•è¯·æ±‚å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBizContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;{&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>              
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;subject\&#34;:\&#34;æµ‹è¯•è´­ä¹°å•†å“001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//è®¾ç½®ä¸šåŠ¡å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//å‘å‡ºé¢„ä¸‹å•ä¸šåŠ¡è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            AlipayTradePrecreateResponse response <span style="color:#000;font-weight:bold">=</span> alipayClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//ä»ç›¸åº”å¯¹è±¡è¯»å–ç›¸åº”ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String code <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å“åº”ç :&#34;</span><span style="color:#000;font-weight:bold">+</span>code<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å…¨éƒ¨çš„å“åº”ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String body <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;è¿”å›ç»“æœ:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>code<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">,</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee:&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;é¢„ä¸‹å•æ¥å£è°ƒç”¨å¤±è´¥:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>AlipayApiException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ï¼ˆ3ï¼‰ã€ç¼–å†™controlleræ§åˆ¶å™¨ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.StatusCode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pay.service.PayService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RestController</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">javax.servlet.ServletInputStream</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">javax.servlet.http.HttpServletRequest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.ByteArrayOutputStream</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Enumeration</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;pay&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PayController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> PayService payService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ›å»ºäºŒç»´ç è¿æ¥åœ°å€è¿”å›ç»™å‰ç«¯ ç”ŸæˆäºŒç»´ç å›¾ç‰‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param parameters  åŒ…å« è®¢å•å·  åŒ…å« é‡‘é¢  åŒ…å« queueé˜Ÿåˆ—åç§° äº¤æ¢æœºä¿¡æ¯ è·¯ç”±ä¿¡æ¯ ç”¨æˆ·å
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/create/native&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–ç”¨æˆ·å
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> payService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createNative</span><span style="color:#000;font-weight:bold">(</span>parameters<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;äºŒç»´ç è¿æ¥åœ°å€åˆ›å»ºæˆåŠŸ&#34;</span><span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ï¼ˆ4ï¼‰ã€ç¼–å†™ä¸»å¯åŠ¨ç±»PaySeckillApplication</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PaySeckillApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>PaySeckillApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä½¿ç”¨Postmanæµ‹è¯•æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p>http://localhost:9006/pay/create/native?out_trade_no=1132510782836314121&amp;total_fee=1</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173737223.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ ¹æ®è¿”å›çš„qrcode,å¯ä»¥ç”Ÿæˆæ”¯ä»˜å®æ‰«ç çš„äºŒç»´ç ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173741934.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä½¿ç”¨æ²™ç®±ç‰ˆæ”¯ä»˜å®æ‰«ç ï¼Œå³å¯å¼¹å‡ºæ”¯ä»˜ç•Œé¢ã€‚</p>
<h3 id="33-æ”¯ä»˜æµç¨‹åˆ†æ">3.3 æ”¯ä»˜æµç¨‹åˆ†æ</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528173746704.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å¦‚ä¸Šå›¾ï¼Œæ­¥éª¤åˆ†æå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.ç”¨æˆ·æŠ¢å•ï¼Œç»è¿‡ç§’æ€ç³»ç»Ÿå®ç°æŠ¢å•ï¼Œä¸‹å•åä¼šå°†å‘MQå‘é€ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—æ¶ˆæ¯ï¼ŒåŒ…å«æŠ¢å•ä¿¡æ¯ï¼Œå»¶æ—¶åŠå°æ—¶åæ‰èƒ½ç›‘å¬åˆ°
2.ç§’æ€ç³»ç»ŸåŒæ—¶å¯ç”¨å»¶æ—¶æ¶ˆæ¯ç›‘å¬ï¼Œä¸€æ—¦ç›‘å¬åˆ°è®¢å•æŠ¢å•ä¿¡æ¯ï¼Œåˆ¤æ–­Redisç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨è®¢å•ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å›æ»š
3.ç§’æ€ç³»ç»Ÿè¿˜å¯åŠ¨æ”¯ä»˜å›è°ƒä¿¡æ¯ç›‘å¬ï¼Œå¦‚æœæ”¯ä»˜å®Œæˆï¼Œåˆ™å°†è®¢å•æŒä¹…åŒ–åˆ°MySQLï¼Œå¦‚æœæ²¡å®Œæˆï¼Œæ¸…ç†æ’é˜Ÿä¿¡æ¯å›æ»šåº“å­˜
4.æ¯æ¬¡ç§’æ€ä¸‹å•åè°ƒç”¨æ”¯ä»˜ç³»ç»Ÿï¼Œåˆ›å»ºäºŒç»´ç ï¼Œå¦‚æœç”¨æˆ·æ”¯ä»˜æˆåŠŸäº†ï¼Œæ”¯ä»˜å®å¹³å°ä¼šå°†æ”¯ä»˜ä¿¡æ¯å‘é€ç»™æ”¯ä»˜ç³»ç»ŸæŒ‡å®šçš„å›è°ƒåœ°å€ï¼Œæ”¯ä»˜ç³»ç»Ÿæ”¶åˆ°ä¿¡æ¯åï¼Œå°†ä¿¡æ¯å‘é€ç»™MQï¼Œç¬¬3ä¸ªæ­¥éª¤å°±å¯ä»¥ç›‘å¬åˆ°æ¶ˆæ¯äº†ã€‚
</code></pre><h3 id="34-æ”¯ä»˜å›è°ƒæ›´æ–°">3.4 æ”¯ä»˜å›è°ƒæ›´æ–°</h3>
<p>æ”¯ä»˜å›è°ƒè¿™ä¸€å—ä»£ç å·²ç»å®ç°äº†ï¼Œä½†ä¹‹å‰å®ç°çš„æ˜¯è®¢å•ä¿¡æ¯çš„å›è°ƒæ•°æ®å‘é€ç»™MQï¼ŒæŒ‡å®šäº†å¯¹åº”çš„é˜Ÿåˆ—ï¼Œä¸è¿‡ç°åœ¨éœ€è¦å®ç°çš„æ˜¯ç§’æ€ä¿¡æ¯å‘é€ç»™æŒ‡å®šé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¹‹å‰çš„ä»£ç é‚£å—éœ€è¦åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—ã€‚</p>
<h4 id="341-æ”¯ä»˜å›è°ƒé˜Ÿåˆ—æŒ‡å®š">3.4.1 æ”¯ä»˜å›è°ƒé˜Ÿåˆ—æŒ‡å®š</h4>
<p>å…³äºæŒ‡å®šé˜Ÿåˆ—å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.åˆ›å»ºæ”¯ä»˜äºŒç»´ç éœ€è¦æŒ‡å®šé˜Ÿåˆ—
2.å›è°ƒåœ°å€å›è°ƒçš„æ—¶å€™ï¼Œè·å–æ”¯ä»˜äºŒç»´ç æŒ‡å®šçš„é˜Ÿåˆ—ï¼Œå°†æ”¯ä»˜ä¿¡æ¯å‘é€åˆ°æŒ‡å®šé˜Ÿåˆ—ä¸­
</code></pre><p>åœ¨æ”¯ä»˜å®æ”¯ä»˜ç»Ÿä¸€ä¸‹å•APIä¸­ï¼Œæœ‰ä¸€ä¸ªé™„åŠ å‚æ•°,å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">body:é™„åŠ æ•°æ®,String(127)ï¼Œåœ¨æŸ¥è¯¢APIå’Œæ”¯ä»˜é€šçŸ¥ä¸­åŸæ ·è¿”å›ï¼Œå¯ä½œä¸ºè‡ªå®šä¹‰å‚æ•°ä½¿ç”¨ã€‚
</code></pre><p>æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºäºŒç»´ç çš„æ—¶å€™ï¼ŒæŒ‡å®šè¯¥å‚æ•°ï¼Œè¯¥å‚æ•°ç”¨äºæŒ‡å®šå›è°ƒæ”¯ä»˜ä¿¡æ¯çš„å¯¹åº”é˜Ÿåˆ—ï¼Œæ¯æ¬¡å›è°ƒçš„æ—¶å€™ï¼Œä¼šè·å–è¯¥å‚æ•°ï¼Œç„¶åå°†å›è°ƒä¿¡æ¯å‘é€åˆ°è¯¥å‚æ•°å¯¹åº”çš„é˜Ÿåˆ—å»ã€‚</p>
<h5 id="3411-åœ¨é¢„ä¸‹å•æ—¶ä¼ é€’é˜Ÿåˆ—ä¿¡æ¯">3.4.1.1 åœ¨é¢„ä¸‹å•æ—¶ä¼ é€’é˜Ÿåˆ—ä¿¡æ¯</h5>
<p>ä¿®æ”¹æ”¯ä»˜å¾®æœåŠ¡çš„PayServiceImplçš„createNativeæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173753655.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºé˜¿é‡Œæ”¯ä»˜å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DefaultAlipayClient alipayClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultAlipayClient<span style="color:#000;font-weight:bold">(</span>serverUrl<span style="color:#000;font-weight:bold">,</span> appId<span style="color:#000;font-weight:bold">,</span> privateKey<span style="color:#000;font-weight:bold">,</span> formate<span style="color:#000;font-weight:bold">,</span> charset<span style="color:#000;font-weight:bold">,</span> alipayPublicKey<span style="color:#000;font-weight:bold">,</span> signType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºé¢„ä¸‹å•è¯·æ±‚å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        AlipayTradePrecreateRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AlipayTradePrecreateRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNotifyUrl</span><span style="color:#000;font-weight:bold">(</span>notifyUrl<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBizContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;{&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;body\&#34;:\&#34;queue=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;queue&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;&amp;username=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;&amp;routingkey=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;routingkey&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;&amp;exchange=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;exchange&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;subject\&#34;:\&#34;æµ‹è¯•è´­ä¹°å•†å“001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//è®¾ç½®ä¸šåŠ¡å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//å‘å‡ºé¢„ä¸‹å•ä¸šåŠ¡è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            AlipayTradePrecreateResponse response <span style="color:#000;font-weight:bold">=</span> alipayClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//ä»ç›¸åº”å¯¹è±¡è¯»å–ç›¸åº”ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String code <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å“åº”ç :&#34;</span><span style="color:#000;font-weight:bold">+</span>code<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å…¨éƒ¨çš„å“åº”ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String body <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;è¿”å›ç»“æœ:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>code<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">,</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee:&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;é¢„ä¸‹å•æ¥å£è°ƒç”¨å¤±è´¥:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>AlipayApiException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬åˆ›å»ºäºŒç»´ç çš„æ—¶å€™ï¼Œéœ€è¦å°†ä¸‹é¢å‡ ä¸ªå‚æ•°ä¼ é€’è¿‡å»</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">username:ç”¨æˆ·å,å¯ä»¥æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·æ’é˜Ÿä¿¡æ¯
out_trade_noï¼šå•†æˆ·è®¢å•å·ï¼Œä¸‹å•å¿…é¡»
total_feeï¼šæ”¯ä»˜é‡‘é¢ï¼Œæ”¯ä»˜å¿…é¡»
queueï¼šé˜Ÿåˆ—åå­—ï¼Œå›è°ƒçš„æ—¶å€™ï¼Œå¯ä»¥çŸ¥é“å°†æ”¯ä»˜ä¿¡æ¯å‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—
routingkey:è·¯ç”±çš„åç§°
exchangeï¼šäº¤æ¢æœºåç§°
</code></pre><p>ä¿®æ”¹ä¸»å¯åŠ¨ç±»PayApplicationï¼Œæ·»åŠ å¯¹åº”é˜Ÿåˆ—ä»¥åŠå¯¹åº”äº¤æ¢æœºç»‘å®šï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span><span style="color:#000;font-weight:bold">(</span>exclude <span style="color:#000;font-weight:bold">=</span> DataSourceAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PaySeckillApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>PaySeckillApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Environment env<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ›å»ºç§’æ€é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;seckillQueue&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">createSeckillQueue</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillorder&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ›å»ºç§’æ€äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;seckillExchanage&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">basicSeckillExchanage</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillorder&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//ç»‘å®šç§’æ€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;SeckillBinding&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicSeckillBinding</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span>  BindingBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>createSeckillQueue<span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>basicSeckillExchanage<span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillkey&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹application.ymlï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#ä½ç½®æ”¯ä»˜äº¤æ¢æœºå’Œé˜Ÿåˆ—
mq:
  pay:
    exchange:     
      seckillorder: exchange.seckillorder
    queue:     
      seckillorder: queue.seckillorder
    routing:     
      seckillkey: queue.seckillorder
</code></pre><h5 id="3412-æµ‹è¯•">3.4.1.2 æµ‹è¯•</h5>
<p>ä½¿ç”¨Postmanåˆ›å»ºäºŒç»´ç æµ‹è¯•</p>
<p>http://localhost:9006/pay/create/native?username=test001&amp;out_trade_no=1132510782836314121&amp;total_fee=1&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173803950.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä»¥åæ¯æ¬¡æ”¯ä»˜ï¼Œéƒ½éœ€è¦å¸¦ä¸Šå¯¹åº”çš„å‚æ•°ï¼ŒåŒ…æ‹¬å‰é¢çš„è®¢å•æ”¯ä»˜ã€‚</p>
<h5 id="3413-æ”¹é€ æ”¯ä»˜å›è°ƒæ–¹æ³•">3.4.1.3 æ”¹é€ æ”¯ä»˜å›è°ƒæ–¹æ³•</h5>
<p>ä¿®æ”¹PayControllerçš„notifyUrlæ–¹æ³•ï¼Œè·å–è‡ªå®šä¹‰å‚æ•°ï¼Œå¹¶è½¬æˆMapï¼Œè·å–queueåœ°å€ï¼Œå¹¶å°†æ”¯ä»˜ä¿¡æ¯å‘é€åˆ°ç»‘å®šçš„queueä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//æ¥æ”¶æ”¯ä»˜å®ç½‘å…³å›è°ƒæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/notify/url&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">reciveResult</span><span style="color:#000;font-weight:bold">(</span>HttpServletRequest request<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å‡†å¤‡ä¸€ä¸ªmapå°è£…å…¨éƒ¨çš„è¯·æ±‚å‚æ•°å’Œå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–å…¨éƒ¨çš„è¯·æ±‚å‚æ•°åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Enumeration<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> parameterNames <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterNames</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>parameterNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasMoreElements</span><span style="color:#000;font-weight:bold">()){</span>
</span></span><span style="display:flex;"><span>            String paramName <span style="color:#000;font-weight:bold">=</span> parameterNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nextElement</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å°è£…å‚æ•°åå’Œå‚æ•°å€¼åˆ°map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>paramName<span style="color:#000;font-weight:bold">,</span>request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>paramName<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è½¬æ¢mapé›†åˆä¸ºjsonå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String jsonString <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å“åº”ç»“æœ:&#34;</span><span style="color:#000;font-weight:bold">+</span>jsonString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–bodyè‡ªå®šä¹‰å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String body <span style="color:#000;font-weight:bold">=</span> map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;body&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//bodyå‚æ•°å¤šä¸ªç”¨&amp;éš”å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String<span style="color:#000;font-weight:bold">[]</span> splits <span style="color:#000;font-weight:bold">=</span> body<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&amp;&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºä¸€ä¸ªmapå°è£…bodyçš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> bodyMap<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String split <span style="color:#000;font-weight:bold">:</span> splits<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//ç»§ç»­ç”¨=å·åˆ‡å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String<span style="color:#000;font-weight:bold">[]</span> parms <span style="color:#000;font-weight:bold">=</span> split<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>parms<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">],</span>parms<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å‘é€æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        rabbitTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertAndSend</span><span style="color:#000;font-weight:bold">(</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;exchange&#34;</span><span style="color:#000;font-weight:bold">),</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;routingkey&#34;</span><span style="color:#000;font-weight:bold">),</span>jsonString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;pay-success&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>é…ç½®å›è°ƒåœ°å€ï¼šapplication.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">alipay</span>:<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">notify-url</span>:<span style="color:#bbb"> </span>http://7r8ukqlrpt.52http.com/pay/notify/url<span style="color:#bbb">
</span></span></span></code></pre></div><h5 id="3414-å†…ç½‘ç©¿é€">3.4.1.4 å†…ç½‘ç©¿é€</h5>
<p>æ”¯ä»˜å¼‚æ­¥é€šçŸ¥éœ€è¦ç‹¬ç«‹ipä½¿é˜¿é‡Œæ”¯ä»˜æˆåŠŸåå¯ä»¥å›è°ƒæˆ‘ä»¬çš„æ¥å£ï¼Œæ‰€ä»¥å‰ææ¡ä»¶å°±æ˜¯å†…ç½‘ç©¿é€ã€‚</p>
<p><a class="link" href="/posts/project-0/https://www.cpolar.com/"  target="_blank" rel="noopener"
    >https://www.cpolar.com/</a>
<img src="/posts/project-0/20220528173393/image-20220528173811677.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å¦‚ä½•ä½¿ç”¨ï¼š</p>
<h6 id="1ä¸‹è½½-cpolar">ï¼ˆ1ï¼‰ã€ä¸‹è½½ cpolar</h6>
<p><a class="link" href="/posts/project-0/https://www.cpolar.com/static/downloads/releases/latest/cpolar_amd64.msi"  target="_blank" rel="noopener"
    >https://www.cpolar.com/static/downloads/releases/latest/cpolar_amd64.msi</a></p>
<h6 id="2å®‰è£…">ï¼ˆ2ï¼‰ã€å®‰è£…ï¼š</h6>
<p>åœ¨Linuxæˆ–OSXä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä»ç»ˆç«¯è§£å‹ç¼©cpolarã€‚ åœ¨Windowsä¸Šï¼Œåªéœ€åŒå‡»å®‰è£…</p>
<h6 id="3è¿æ¥æ‚¨çš„å¸æˆ·">ï¼ˆ3ï¼‰ã€è¿æ¥æ‚¨çš„å¸æˆ·ï¼š</h6>
<p>è¿è¡Œæ­¤å‘½ä»¤ä¼šå°†æ‚¨å¸æˆ·çš„authtokenæ·»åŠ åˆ°æ‚¨çš„cpolar.ymlæ–‡ä»¶ä¸­ã€‚ è¿™å°†ä¸ºæ‚¨æä¾›æ›´å¤šåŠŸèƒ½ï¼Œæ‰€æœ‰æ‰“å¼€çš„éš§é“å°†åœ¨æ­¤å¤„çš„ä»ªè¡¨æ¿ä¸­åˆ—å‡ºã€‚</p>
<pre tabindex="0"><code>cpolar authtoken YzQxMzFiY2YtY2I1NC*****LTg2NzAtZjJkMTRmYjQ0ZDRh
</code></pre><p>å…·ä½“çš„tokenå€¼ï¼šç™»å½•ç½‘ç«™ä»æ§åˆ¶é¢æ¿è·å–ï¼šhttps://dashboard.cpolar.com/auth
<img src="/posts/project-0/20220528173393/image-20220528173817734.png"
    
    
    
    loading="lazy"
    
    
></p>
<h6 id="4å¼€å¯ç«¯å£æ˜ å°„">ï¼ˆ4ï¼‰ã€å¼€å¯ç«¯å£æ˜ å°„</h6>
<pre tabindex="0"><code>cpolar http 80
</code></pre><p>åœ¨80ç«¯å£å¼€å¯æ˜ å°„ã€‚
<img src="/posts/project-0/20220528173393/image-20220528173824527.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æµ‹è¯•å†…ç½‘ç©¿é€ï¼šè®¿é—®å›è°ƒæ¥å£æ¥å£</p>
<p><a class="link" href="/posts/project-0/http://6ca8e8f6.cpolar.io/pay/notify/url?id=111&amp;name=wwww"  target="_blank" rel="noopener"
    >http://6ca8e8f6.cpolar.io/pay/notify/url?id=111&name=wwww</a></p>
<p>æ‰«ææ”¯ä»˜äºŒç»´ç ï¼Œæ”¯ä»˜å®å³å¯å›è°ƒ  æ¥å£</p>
<p>æ§åˆ¶å°å¯ä»¥æŸ¥çœ‹ç›¸å…³ä¿¡æ¯
<img src="/posts/project-0/20220528173393/image-20220528173829290.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="342-æ”¯ä»˜çŠ¶æ€ç›‘å¬">3.4.2 æ”¯ä»˜çŠ¶æ€ç›‘å¬</h4>
<p>æ”¯ä»˜çŠ¶æ€é€šè¿‡å›è°ƒåœ°å€å‘é€ç»™MQä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç§’æ€ç³»ç»Ÿä¸­ç›‘å¬æ”¯ä»˜ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·å·²æ”¯ä»˜ï¼Œåˆ™ä¿®æ”¹ç”¨æˆ·è®¢å•çŠ¶æ€ï¼Œå¦‚æœæ”¯ä»˜å¤±è´¥ï¼Œåˆ™ç›´æ¥åˆ é™¤è®¢å•ï¼Œå›æ»šåº“å­˜ã€‚</p>
<p>åœ¨ç§’æ€å·¥ç¨‹ä¸­åˆ›å»ºcom.offcn.seckill.consumer.SeckillOrderPayMessageListener,å®ç°ç›‘å¬æ¶ˆæ¯ï¼Œä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;${mq.pay.queue.seckillorder}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillOrderPayMessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ç›‘å¬æ¶ˆè´¹æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">consumeMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> String message<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å°†æ¶ˆæ¯è½¬æ¢æˆMapå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">,</span>Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ç›‘å¬åˆ°çš„æ¶ˆæ¯:&#34;</span><span style="color:#000;font-weight:bold">+</span>resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹SeckillApplicationåˆ›å»ºå¯¹åº”çš„é˜Ÿåˆ—ä»¥åŠç»‘å®šå¯¹åº”äº¤æ¢æœºã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.seckill.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableScheduling</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableAsync</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>SeckillApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> IdWorker <span style="color:#900;font-weight:bold">idWorker</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> IdWorker<span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span>1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Environment env<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ›å»ºç§’æ€é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;queueSeckillOrder&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">queueSeckillOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillorder&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ›å»ºç§’æ€äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">directExchangeOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillorder&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/****
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºä¸Š
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicBindingSeckillOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> BindingBuilder
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>queueSeckillOrder<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>directExchangeOrder<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillkey&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#ä½ç½®æ”¯ä»˜äº¤æ¢æœºå’Œé˜Ÿåˆ—
mq:
  pay:
    exchange:     
      seckillorder: exchange.seckillorder
    queue:     
      seckillorder: queue.seckillorder
    routing:     
      seckillkey: queue.seckillorder
</code></pre><h4 id="343-ä¿®æ”¹è®¢å•çŠ¶æ€">3.4.3 ä¿®æ”¹è®¢å•çŠ¶æ€</h4>
<p>ç›‘å¬åˆ°æ”¯ä»˜ä¿¡æ¯åï¼Œæ ¹æ®æ”¯ä»˜ä¿¡æ¯åˆ¤æ–­ï¼Œå¦‚æœç”¨æˆ·æ”¯ä»˜æˆåŠŸï¼Œåˆ™ä¿®æ”¹è®¢å•ä¿¡æ¯ï¼Œå¹¶å°†è®¢å•å…¥åº“ï¼Œåˆ é™¤ç”¨æˆ·æ’é˜Ÿä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·æ”¯ä»˜å¤±è´¥ï¼Œåˆ™åˆ é™¤è®¢å•ä¿¡æ¯ï¼Œå›æ»šåº“å­˜ï¼Œåˆ é™¤ç”¨æˆ·æ’é˜Ÿä¿¡æ¯ã€‚</p>
<h5 id="3431-ä¸šåŠ¡å±‚">3.4.3.1 ä¸šåŠ¡å±‚</h5>
<p>ä¿®æ”¹SeckillOrderServiceï¼Œæ·»åŠ ä¿®æ”¹è®¢å•æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * æ›´æ–°è®¢å•çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param out_trade_no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param transaction_id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updatePayStatus</span><span style="color:#000;font-weight:bold">(</span>String out_trade_no<span style="color:#000;font-weight:bold">,</span> String transaction_id<span style="color:#000;font-weight:bold">,</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä¿®æ”¹SeckillOrderServiceImplï¼Œæ·»åŠ ä¿®æ”¹è®¢å•æ–¹æ³•å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * æ›´æ–°è®¢å•çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param out_trade_no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param transaction_id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updatePayStatus</span><span style="color:#000;font-weight:bold">(</span>String out_trade_no<span style="color:#000;font-weight:bold">,</span> String transaction_id<span style="color:#000;font-weight:bold">,</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è®¢å•æ•°æ®ä»Redisæ•°æ®åº“æŸ¥è¯¢å‡ºæ¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillOrder<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//ä¿®æ”¹çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è®¾ç½®äº¤æ˜“æµæ°´å·
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTransactionId</span><span style="color:#000;font-weight:bold">(</span>transaction_id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ”¯ä»˜æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPayTime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åŒæ­¥åˆ°MySQLä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    seckillOrderMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">insert</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ¸…ç©ºRedisç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ¸…ç©ºç”¨æˆ·æ’é˜Ÿæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ é™¤æŠ¢è´­çŠ¶æ€ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹è®¢å•å®ä½“ç±»çš„idç”Ÿæˆæ–¹å¼ï¼Œä¸ºå¤–é¢ç”Ÿæˆ
<img src="/posts/project-0/20220528173393/image-20220528173840203.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="3432-ä¿®æ”¹è®¢å•å¯¹æ¥">3.4.3.2 ä¿®æ”¹è®¢å•å¯¹æ¥</h5>
<p>ä¿®æ”¹æ‰«ç æ”¯ä»˜çŠ¶æ€ç›‘å¬çš„ä»£ç ï¼Œå½“ç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œä¿®æ”¹è®¢å•çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528173393/image-20220528173844974.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.seckill.consumer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.service.SeckillOrderService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.messaging.handler.annotation.Payload</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Component</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;${mq.pay.queue.seckillorder}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillOrderPayMessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SeckillOrderService seckillOrderService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ç›‘å¬æ¶ˆè´¹æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">consumeMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> String message<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å°†æ¶ˆæ¯è½¬æ¢æˆMapå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ç›‘å¬åˆ°çš„æ¶ˆæ¯:&#34;</span><span style="color:#000;font-weight:bold">+</span>resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–äº¤æ˜“çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String trade_status<span style="color:#000;font-weight:bold">=</span>    resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;trade_status&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ¤æ–­äº¤æ˜“çŠ¶æ€æ˜¯å¦ç­‰äºæˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>trade_status<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>trade_status<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;TRADE_SUCCESS&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            String body<span style="color:#000;font-weight:bold">=</span>  resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;body&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> bodyMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;body&#34;</span><span style="color:#000;font-weight:bold">)!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                String<span style="color:#000;font-weight:bold">[]</span> splits <span style="color:#000;font-weight:bold">=</span> body<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&amp;&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String split <span style="color:#000;font-weight:bold">:</span> splits<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    String<span style="color:#000;font-weight:bold">[]</span> vs <span style="color:#000;font-weight:bold">=</span> split<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>vs<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">],</span> vs<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            seckillOrderService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updatePayStatus</span><span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">),</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;trade_no&#34;</span><span style="color:#000;font-weight:bold">),</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//æ”¯ä»˜å¤±è´¥ï¼Œåˆ é™¤è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼š</p>
<p>ä½¿ç”¨Postmanå®Œæ•´è¯·æ±‚åˆ›å»ºäºŒç»´ç ä¸‹å•æµ‹è¯•ä¸€æ¬¡ã€‚</p>
<p>å•†å“IDï¼š1</p>
<p>å‰©ä½™åº“å­˜æ•°é‡ï¼š10</p>
<p>http://localhost:8001/api/seckillGoods/one?id=1&amp;time=2021061916
<img src="/posts/project-0/20220528173393/image-20220528173852410.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸‹å•ï¼š</p>
<p>http://localhost:8001/api/seckillOrder/add?time=2021061916&amp;id=1</p>
<p>ä¸‹å•åï¼ŒRedisæ•°æ®
<img src="/posts/project-0/20220528173393/image-20220528173856522.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸‹å•æŸ¥è¯¢ï¼š</p>
<p>http://localhost:8001/api/seckillOrder/query
<img src="/posts/project-0/20220528173393/image-20220528173900940.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åˆ›å»ºäºŒç»´ç ï¼š</p>
<p>http://localhost:9006/pay/create/native?username=dongyimai&amp;out_trade_no=1375043168986337280&amp;total_fee=0.01&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p>æ³¨æ„ï¼šusername ç”¨ç™»å½•çš„è´¦å·   out_trade_no ç”¨ä¸‹å•æˆåŠŸçš„è®¢å•å·</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173911454.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ‰«ç ï¼š</p>
<p>ä½¿ç”¨è¿”å›çš„é¢„ä¸‹å•urlç”ŸæˆäºŒç»´ç 
<img src="/posts/project-0/20220528173393/image-20220528173915890.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä½¿ç”¨æ²™ç®±æ”¯ä»˜å®æ‰«æäºŒç»´ç ï¼Œå®Œæˆæ”¯ä»˜</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173922806.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>æŸ¥çœ‹è®¢å•çŠ¶æ€ï¼š</p>
<p>http://localhost:9005/seckillOrder/query</p>
<h4 id="344-åˆ é™¤è®¢å•å›æ»šåº“å­˜">3.4.4 åˆ é™¤è®¢å•å›æ»šåº“å­˜</h4>
<p>å¦‚æœç”¨æˆ·æ”¯ä»˜å¤±è´¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤ç”¨æˆ·è®¢å•æ•°æ®ï¼Œå¹¶å›æ»šåº“å­˜ã€‚</p>
<h5 id="3441-ä¸šåŠ¡å±‚å®ç°">3.4.4.1 ä¸šåŠ¡å±‚å®ç°</h5>
<p>ä¿®æ”¹SeckillOrderServiceï¼Œåˆ›å»ºä¸€ä¸ªå…³é—­è®¢å•æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * å…³é—­è®¢å•ï¼Œå›æ»šåº“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">closeOrder</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä¿®æ”¹SeckillOrderServiceImplï¼Œåˆ›å»ºä¸€ä¸ªå…³é—­è®¢å•å®ç°æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * å…³é—­è®¢å•ï¼Œå›æ»šåº“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">closeOrder</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å°†æ¶ˆæ¯è½¬æ¢æˆSeckillStatus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillStatus seckillStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillStatus<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è·å–Redisä¸­è®¢å•ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillOrder<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å¦‚æœRedisä¸­æœ‰è®¢å•ä¿¡æ¯ï¼Œè¯´æ˜ç”¨æˆ·æœªæ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> seckillOrder<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ é™¤è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å›æ»šåº“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//1)ä»Redisä¸­è·å–è¯¥å•†å“
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillGoods seckillGoods <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillGoods<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTime</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2)å¦‚æœRedisä¸­æ²¡æœ‰ï¼Œåˆ™ä»æ•°æ®åº“ä¸­åŠ è½½
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>seckillGoods<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            seckillGoods <span style="color:#000;font-weight:bold">=</span> seckillGoodsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectById</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3)æ•°é‡+1  (é€’å¢æ•°é‡+1ï¼Œé˜Ÿåˆ—æ•°é‡+1)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Long surplusCount <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">(),</span> 1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillGoods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStockCount</span><span style="color:#000;font-weight:bold">(</span>surplusCount<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">intValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCountList_&#34;</span> <span style="color:#000;font-weight:bold">+</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">leftPush</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4)æ•°æ®åŒæ­¥åˆ°Redisä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTime</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">(),</span>seckillGoods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ¸…ç†æ’é˜Ÿæ ‡ç¤º
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ¸…ç†æŠ¢å•æ ‡ç¤º
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="3442-è°ƒç”¨åˆ é™¤è®¢å•">3.4.4.2 è°ƒç”¨åˆ é™¤è®¢å•</h5>
<p>ä¿®æ”¹SeckillOrderPayMessageListenerï¼Œåœ¨ç”¨æˆ·æ”¯ä»˜å¤±è´¥åè°ƒç”¨å…³é—­è®¢å•æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//æ”¯ä»˜å¤±è´¥ï¼Œå…³é—­è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            seckillOrderService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closeOrder</span><span style="color:#000;font-weight:bold">(</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="3443-æµ‹è¯•">3.4.4.3 æµ‹è¯•</h5>
<p>ä½¿ç”¨Postmanå®Œæ•´è¯·æ±‚åˆ›å»ºäºŒç»´ç ä¸‹å•æµ‹è¯•ä¸€æ¬¡ã€‚</p>
<p>å•†å“IDï¼š1</p>
<p>å‰©ä½™åº“å­˜æ•°é‡ï¼š10</p>
<p>http://localhost:9005/seckillGoods/one?id=1&amp;time=2021032518
<img src="/posts/project-0/20220528173393/image-20220528173935260.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸‹å•ï¼š</p>
<p>http://localhost:9005/seckillOrder/add?time=2021032518&amp;id=1</p>
<p>ä¸‹å•åï¼ŒRedisæ•°æ®
<img src="/posts/project-0/20220528173393/image-20220528173939235.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸‹å•æŸ¥è¯¢ï¼š</p>
<p>http://localhost:9005/seckillOrder/query
<img src="/posts/project-0/20220528173393/image-20220528173944723.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åˆ›å»ºäºŒç»´ç ï¼š</p>
<p>http://localhost:9006/pay/create/native?username=test001&amp;out_trade_no=1375043168986337280&amp;total_fee=0.01&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p>ç§’æ€æŠ¢å•åï¼Œå•†å“æ•°é‡å˜åŒ–ï¼š</p>
<p>http://localhost:9005/seckillGoods/one?id=1&amp;time=2021032518
<img src="/posts/project-0/20220528173393/image-20220528173951303.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-rabbitmqå»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—">4 RabbitMQå»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—</h2>
<h3 id="41-å»¶æ—¶é˜Ÿåˆ—ä»‹ç»">4.1 å»¶æ—¶é˜Ÿåˆ—ä»‹ç»</h3>
<p>å»¶æ—¶é˜Ÿåˆ—å³æ”¾ç½®åœ¨è¯¥é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯æ˜¯ä¸éœ€è¦ç«‹å³æ¶ˆè´¹çš„ï¼Œè€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åå–å‡ºæ¶ˆè´¹ã€‚
é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿæ¶ˆè´¹å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä»¥ä¸‹çš„åœºæ™¯</p>
<p>ç½‘ä¸Šå•†åŸä¸‹è®¢å•å30åˆ†é’Ÿåæ²¡æœ‰å®Œæˆæ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•(å¦‚ï¼šæ·˜å®ã€å»å“ªå„¿ç½‘)
ç³»ç»Ÿåˆ›å»ºäº†é¢„çº¦ä¹‹åï¼Œéœ€è¦åœ¨é¢„çº¦æ—¶é—´åˆ°è¾¾å‰ä¸€å°æ—¶æé†’è¢«é¢„çº¦çš„åŒæ–¹å‚ä¼š
ç³»ç»Ÿä¸­çš„ä¸šåŠ¡å¤±è´¥ä¹‹åï¼Œéœ€è¦é‡è¯•
è¿™äº›åœºæ™¯éƒ½éå¸¸å¸¸è§ï¼Œæˆ‘ä»¬å¯ä»¥æ€è€ƒï¼Œæ¯”å¦‚ç¬¬äºŒä¸ªéœ€æ±‚ï¼Œç³»ç»Ÿåˆ›å»ºäº†é¢„çº¦ä¹‹åï¼Œéœ€è¦åœ¨é¢„çº¦æ—¶é—´åˆ°è¾¾å‰ä¸€å°æ—¶æé†’è¢«é¢„çº¦çš„åŒæ–¹å‚ä¼šã€‚é‚£ä¹ˆä¸€å¤©ä¹‹ä¸­è‚¯å®šæ˜¯ä¼šæœ‰å¾ˆå¤šä¸ªé¢„çº¦çš„ï¼Œæ—¶é—´ä¹Ÿæ˜¯ä¸ä¸€å®šçš„ï¼Œå‡è®¾ç°åœ¨æœ‰1ç‚¹ 2ç‚¹ 3ç‚¹ ä¸‰ä¸ªé¢„çº¦ï¼Œå¦‚ä½•è®©ç³»ç»ŸçŸ¥é“åœ¨å½“å‰æ—¶é—´ç­‰äº0ç‚¹ 1ç‚¹ 2ç‚¹ç»™ç”¨æˆ·å‘é€ä¿¡æ¯å‘¢ï¼Œæ˜¯ä¸æ˜¯éœ€è¦ä¸€ä¸ªè½®è¯¢ï¼Œä¸€ç›´å»æŸ¥çœ‹æ‰€æœ‰çš„é¢„çº¦ï¼Œæ¯”å¯¹å½“å‰çš„ç³»ç»Ÿæ—¶é—´å’Œé¢„çº¦æå‰ä¸€å°æ—¶çš„æ—¶é—´æ˜¯å¦ç›¸ç­‰å‘¢ï¼Ÿè¿™æ ·åšéå¸¸æµªè´¹èµ„æºè€Œä¸”è½®è¯¢çš„æ—¶é—´é—´éš”ä¸å¥½æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—å‘¢ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºæ—¶æŠŠéœ€è¦é€šçŸ¥çš„é¢„çº¦æ”¾å…¥æ¶ˆæ¯ä¸­é—´ä»¶ä¸­ï¼Œå¹¶ä¸”è®¾ç½®è¯¥æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œç­‰è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶å†å–å‡ºæ¶ˆè´¹å³å¯ã€‚</p>
<p>Rabbitmqå®ç°å»¶æ—¶é˜Ÿåˆ—ä¸€èˆ¬è€Œè¨€æœ‰ä¸¤ç§å½¢å¼ï¼š
ç¬¬ä¸€ç§æ–¹å¼ï¼šåˆ©ç”¨ä¸¤ä¸ªç‰¹æ€§ï¼š Time To Live(TTL)ã€Dead Letter Exchangesï¼ˆDLXï¼‰[Aé˜Ÿåˆ—è¿‡æœŸ-&gt;è½¬å‘ç»™Bé˜Ÿåˆ—]</p>
<p>ç¬¬äºŒç§æ–¹å¼ï¼šåˆ©ç”¨rabbitmqä¸­çš„æ’ä»¶x-delay-message</p>
<h3 id="42-ttl-dlxå®ç°å»¶æ—¶é˜Ÿåˆ—">4.2 TTL DLXå®ç°å»¶æ—¶é˜Ÿåˆ—</h3>
<h4 id="421-ttl-dlxä»‹ç»">4.2.1 TTL DLXä»‹ç»</h4>
<p><strong>TTL</strong>
RabbitMQå¯ä»¥é’ˆå¯¹é˜Ÿåˆ—è®¾ç½®x-expires(åˆ™é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„æ¶ˆæ¯éƒ½æœ‰ç›¸åŒçš„è¿‡æœŸæ—¶é—´)æˆ–è€…é’ˆå¯¹Messageè®¾ç½®x-message-ttl(å¯¹æ¶ˆæ¯è¿›è¡Œå•ç‹¬è®¾ç½®ï¼Œæ¯æ¡æ¶ˆæ¯TTLå¯ä»¥ä¸åŒ)ï¼Œæ¥æ§åˆ¶æ¶ˆæ¯çš„ç”Ÿå­˜æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶(ä¸¤è€…åŒæ—¶è®¾ç½®ä»¥æœ€å…ˆåˆ°æœŸçš„æ—¶é—´ä¸ºå‡†)ï¼Œåˆ™æ¶ˆæ¯å˜ä¸ºdead letter(æ­»ä¿¡)</p>
<p><strong>Dead Letter Exchangesï¼ˆDLXï¼‰</strong>
RabbitMQçš„Queueå¯ä»¥é…ç½®x-dead-letter-exchangeå’Œx-dead-letter-routing-keyï¼ˆå¯é€‰ï¼‰ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœé˜Ÿåˆ—å†…å‡ºç°äº†dead letterï¼Œåˆ™æŒ‰ç…§è¿™ä¸¤ä¸ªå‚æ•°é‡æ–°è·¯ç”±è½¬å‘åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ã€‚
x-dead-letter-exchangeï¼šå‡ºç°dead letterä¹‹åå°†dead letteré‡æ–°å‘é€åˆ°æŒ‡å®šexchange</p>
<p>x-dead-letter-routing-keyï¼šå‡ºç°dead letterä¹‹åå°†dead letteré‡æ–°æŒ‰ç…§æŒ‡å®šçš„routing-keyå‘é€</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173959420.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="423-dlxå»¶æ—¶é˜Ÿåˆ—å®ç°">4.2.3 DLXå»¶æ—¶é˜Ÿåˆ—å®ç°</h4>
<h5 id="4231-åˆ›å»ºå·¥ç¨‹">4.2.3.1 åˆ›å»ºå·¥ç¨‹</h5>
<p>åˆ›å»ºspringboot_rabbitmq_delayå·¥ç¨‹ï¼Œå¹¶å¼•å…¥ç›¸å…³ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai_parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>springboot_rabbitmq_delay<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--starter-web--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--åŠ å…¥ampq--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--æµ‹è¯•--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>application.ymlé…ç½®</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring:
  application:
    name: springboot-demo
  rabbitmq:
    host: 192.168.188.128
    port: 5672
    password: guest
    username: guest
</code></pre><h5 id="4232-é˜Ÿåˆ—åˆ›å»º">4.2.3.2 é˜Ÿåˆ—åˆ›å»º</h5>
<p>åˆ›å»º2ä¸ªé˜Ÿåˆ—ï¼Œç”¨äºæ¥æ”¶æ¶ˆæ¯çš„å«å»¶æ—¶é˜Ÿåˆ—queue.message.delayï¼Œç”¨äºè½¬å‘æ¶ˆæ¯çš„é˜Ÿåˆ—å«queue.messageï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªäº¤æ¢æœºï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">QueueConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/** çŸ­ä¿¡å‘é€é˜Ÿåˆ— */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String QUEUE_MESSAGE <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;queue.message&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/** äº¤æ¢æœº */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String DLX_EXCHANGE <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;dlx.exchange&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/** çŸ­ä¿¡å‘é€é˜Ÿåˆ— å»¶è¿Ÿç¼“å†²ï¼ˆæŒ‰æ¶ˆæ¯ï¼‰ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String QUEUE_MESSAGE_DELAY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;queue.message.delay&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ¥æ”¶æ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">messageQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å…è®¸é•¿æœŸå­˜å‚¨æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>QUEUE_MESSAGE<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ¥æ”¶å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">delayMessageQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> QueueBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">durable</span><span style="color:#000;font-weight:bold">(</span>QUEUE_MESSAGE_DELAY<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-exchange&#34;</span><span style="color:#000;font-weight:bold">,</span> DLX_EXCHANGE<span style="color:#000;font-weight:bold">)</span>        <span style="color:#998;font-style:italic">// æ¶ˆæ¯è¶…æ—¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œç»‘å®šæ­»ä¿¡é˜Ÿåˆ—äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#000;font-weight:bold">,</span> QUEUE_MESSAGE<span style="color:#000;font-weight:bold">)</span>   <span style="color:#998;font-style:italic">// ç»‘å®šæŒ‡å®šçš„routing-key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ›å»ºäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">directExchange</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>DLX_EXCHANGE<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * äº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param messageQueue
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param directExchange
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicBinding</span><span style="color:#000;font-weight:bold">(</span>Queue messageQueue<span style="color:#000;font-weight:bold">,</span> DirectExchange directExchange<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> BindingBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>messageQueue<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>directExchange<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>QUEUE_MESSAGE<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="4233-æ¶ˆæ¯ç›‘å¬">4.2.3.3 æ¶ˆæ¯ç›‘å¬</h5>
<p>åˆ›å»ºMessageListenerç”¨äºç›‘å¬æ¶ˆæ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> QueueConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">QUEUE_MESSAGE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ç›‘å¬æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param msg
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">msg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> Object msg<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        SimpleDateFormat dateFormat <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SimpleDateFormat<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å½“å‰æ—¶é—´:&#34;</span><span style="color:#000;font-weight:bold">+</span>dateFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;æ”¶åˆ°ä¿¡æ¯:&#34;</span><span style="color:#000;font-weight:bold">+</span>msg<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ³¨æ„ï¼š@Payload å’Œ @Headers æ³¨è§£å¯ä»¥åˆ†åˆ«æ¥æ”¶æ¶ˆæ¯ä¸­çš„ body ä¸ headers ä¿¡æ¯</p>
<p>@RabbitListener å¯ä»¥æ ‡æ³¨åœ¨ç±»ä¸Šé¢ï¼Œéœ€é…åˆ @RabbitHandler æ³¨è§£ä¸€èµ·ä½¿ç”¨
@RabbitListener æ ‡æ³¨åœ¨ç±»ä¸Šé¢è¡¨ç¤ºå½“æœ‰æ”¶åˆ°æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±äº¤ç»™ @RabbitHandler çš„æ–¹æ³•å¤„ç†ï¼Œå…·ä½“ä½¿ç”¨å“ªä¸ªæ–¹æ³•å¤„ç†ï¼Œæ ¹æ® MessageConverter è½¬æ¢åçš„å‚æ•°ç±»å‹ã€‚</p>
<h5 id="4234-åˆ›å»ºå¯åŠ¨ç±»">4.2.3.4 åˆ›å»ºå¯åŠ¨ç±»</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableRabbit</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringRabbitMQApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>SpringRabbitMQApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="4235-æµ‹è¯•">4.2.3.5 æµ‹è¯•</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootTest</span><span style="color:#000;font-weight:bold">(</span>classes <span style="color:#000;font-weight:bold">=</span> SpringRabbitMQApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RunWith</span><span style="color:#000;font-weight:bold">(</span>SpringRunner<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">RabbitMQTest</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RabbitTemplate rabbitTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å‘é€æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sendMessage</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> InterruptedException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SimpleDateFormat dateFormat <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SimpleDateFormat<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å‘é€å½“å‰æ—¶é—´:&#34;</span><span style="color:#000;font-weight:bold">+</span>dateFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> message <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        message<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertAndSend</span><span style="color:#000;font-weight:bold">(</span>QueueConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">QUEUE_MESSAGE_DELAY</span><span style="color:#000;font-weight:bold">,</span> message<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> MessagePostProcessor<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">public</span> Message <span style="color:#900;font-weight:bold">postProcessMessage</span><span style="color:#000;font-weight:bold">(</span>Message message<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> AmqpException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                message<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessageProperties</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setExpiration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> message<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">in</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">read</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>å…¶ä¸­message.getMessageProperties().setExpiration(&ldquo;10000&rdquo;);è®¾ç½®æ¶ˆæ¯è¶…æ—¶æ—¶é—´,è¶…æ—¶åï¼Œä¼šå°†æ¶ˆæ¯è½¬å…¥åˆ°å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—ã€‚</p>
<p>æµ‹è¯•æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528173393/image-20220528174012587.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ¥æ”¶æ—¶é—´å»¶è¿Ÿäº†10ç§’ï¼Œåœ¨æ­»ä¿¡é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯
<img src="/posts/project-0/20220528173393/image-20220528174017485.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-è¶…æ—¶æœªå®Œæˆæ”¯ä»˜è‡ªåŠ¨åˆ é™¤è®¢å•åº“å­˜å›æ»šä½œä¸š">5 è¶…æ—¶æœªå®Œæˆæ”¯ä»˜ã€è‡ªåŠ¨åˆ é™¤è®¢å•åº“å­˜å›æ»š(ä½œä¸š)</h2>
<h3 id="51-ç§’æ€æµç¨‹å›é¡¾">5.1 ç§’æ€æµç¨‹å›é¡¾</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528174023470.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å¦‚ä¸Šå›¾ï¼Œæ­¥éª¤åˆ†æå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.ç”¨æˆ·æŠ¢å•ï¼Œç»è¿‡ç§’æ€ç³»ç»Ÿå®ç°æŠ¢å•ï¼Œä¸‹å•åä¼šå°†å‘MQå‘é€ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—æ¶ˆæ¯ï¼ŒåŒ…å«æŠ¢å•ä¿¡æ¯ï¼Œå»¶æ—¶åŠå°æ—¶åæ‰èƒ½ç›‘å¬åˆ°
2.ç§’æ€ç³»ç»ŸåŒæ—¶å¯ç”¨å»¶æ—¶æ¶ˆæ¯ç›‘å¬ï¼Œä¸€æ—¦ç›‘å¬åˆ°è®¢å•æŠ¢å•ä¿¡æ¯ï¼Œåˆ¤æ–­Redisç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨è®¢å•ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å›æ»š
3.ç§’æ€ç³»ç»Ÿè¿˜å¯åŠ¨æ”¯ä»˜å›è°ƒä¿¡æ¯ç›‘å¬ï¼Œå¦‚æœæ”¯ä»˜å®Œæˆï¼Œåˆ™å°†è®¢å•æŒä¹…åŒ–åˆ°MySQLï¼Œå¦‚æœæ²¡å®Œæˆï¼Œæ¸…ç†æ’é˜Ÿä¿¡æ¯å›æ»šåº“å­˜
4.æ¯æ¬¡ç§’æ€ä¸‹å•åè°ƒç”¨æ”¯ä»˜ç³»ç»Ÿï¼Œåˆ›å»ºäºŒç»´ç ï¼Œå¦‚æœç”¨æˆ·æ”¯ä»˜æˆåŠŸäº†ï¼Œæ”¯ä»˜å®å¹³å°ä¼šå°†æ”¯ä»˜ä¿¡æ¯å‘é€ç»™æ”¯ä»˜ç³»ç»ŸæŒ‡å®šçš„å›è°ƒåœ°å€ï¼Œæ”¯ä»˜ç³»ç»Ÿæ”¶åˆ°ä¿¡æ¯åï¼Œå°†ä¿¡æ¯å‘é€ç»™MQï¼Œç¬¬3ä¸ªæ­¥éª¤å°±å¯ä»¥ç›‘å¬åˆ°æ¶ˆæ¯äº†ã€‚
</code></pre><p>å»¶æ—¶é˜Ÿåˆ—å®ç°è®¢å•å…³é—­å›æ»šåº“å­˜ï¼š</p>
<pre tabindex="0"><code>1.åˆ›å»ºä¸€ä¸ªè¿‡æœŸé˜Ÿåˆ—  Queue1
2.æ¥æ”¶æ¶ˆæ¯çš„é˜Ÿåˆ—    Queue2
3.ä¸­è½¬äº¤æ¢æœº
4.ç›‘å¬Queue2
	1)SeckillStatus-&gt;æ£€æŸ¥Redisä¸­æ˜¯å¦æœ‰è®¢å•ä¿¡æ¯
	2)å¦‚æœæœ‰è®¢å•ä¿¡æ¯ï¼Œè°ƒç”¨åˆ é™¤è®¢å•å›æ»šåº“å­˜-&gt;[éœ€è¦å…ˆå…³é—­æ‰«ç æ”¯ä»˜]
	3)å¦‚æœå…³é—­è®¢å•æ—¶ï¼Œç”¨äºå·²æ”¯ä»˜ï¼Œä¿®æ”¹è®¢å•çŠ¶æ€å³å¯
	4)å¦‚æœå…³é—­è®¢å•æ—¶ï¼Œå‘ç”Ÿäº†åˆ«çš„é”™è¯¯ï¼Œè®°å½•æ—¥å¿—ï¼Œäººå·¥å¤„ç†
</code></pre><h3 id="52-å…³é—­æ”¯ä»˜">5.2 å…³é—­æ”¯ä»˜</h3>
<p>ç”¨æˆ·å¦‚æœåŠä¸ªå°æ—¶æ²¡æœ‰æ”¯ä»˜ï¼Œæˆ‘ä»¬ä¼šå…³é—­æ”¯ä»˜è®¢å•ï¼Œä½†åœ¨å…³é—­ä¹‹å‰ï¼Œéœ€è¦å…ˆå…³é—­æ‰«ç æ”¯ä»˜ï¼Œé˜²æ­¢ä¸­é€”ç”¨æˆ·æ”¯ä»˜ã€‚</p>
<p>ä¿®æ”¹æ”¯ä»˜å¾®æœåŠ¡çš„PayServiceï¼Œæ·»åŠ å…³é—­æ”¯ä»˜æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * å…³é—­æ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param orderId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span>Long out_trade_no<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>ä¿®æ”¹PayServiceImplï¼Œå®ç°å…³é—­æ‰«ç æ”¯ä»˜æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span>Long out_trade_no<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºé˜¿é‡Œæ”¯ä»˜å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DefaultAlipayClient alipayClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultAlipayClient<span style="color:#000;font-weight:bold">(</span>serverUrl<span style="color:#000;font-weight:bold">,</span> appId<span style="color:#000;font-weight:bold">,</span> privateKey<span style="color:#000;font-weight:bold">,</span> formate<span style="color:#000;font-weight:bold">,</span> charset<span style="color:#000;font-weight:bold">,</span> alipayPublicKey<span style="color:#000;font-weight:bold">,</span> signType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ’¤é”€äº¤æ˜“è¯·æ±‚å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        AlipayTradeCancelRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AlipayTradeCancelRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBizContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;{&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>out_trade_no<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;trade_no\&#34;:\&#34;\&#34;}&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">//è®¾ç½®ä¸šåŠ¡å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            AlipayTradeCancelResponse response <span style="color:#000;font-weight:bold">=</span> alipayClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            String code<span style="color:#000;font-weight:bold">=</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>code<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;è¿”å›å€¼:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">,</span> code<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">,</span> out_trade_no<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>AlipayApiException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹PayControllerï¼Œå¢åŠ å…³é—­æœåŠ¡æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//å…³é—­æ”¯ä»˜é¢„ä¸‹å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;closepay&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span>Long out_trade_no<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> payService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closePay</span><span style="color:#000;font-weight:bold">(</span>out_trade_no<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">)!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//æˆåŠŸå…³é—­ï¼Œå°±è¿”å›ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;è®¢å•å…³é—­æˆåŠŸ&#34;</span><span style="color:#000;font-weight:bold">,</span>resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;è®¢å•å…³é—­å¤±è´¥&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;è®¢å•å…³é—­å¤±è´¥&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼š</p>
<p>http://localhost:9006/pay/closepay?out_trade_no=1406451841629294592
<img src="/posts/project-0/20220528173393/image-20220528174032735.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="53-å…³é—­è®¢å•å›æ»šåº“å­˜">5.3 å…³é—­è®¢å•å›æ»šåº“å­˜</h3>
<h4 id="531-é…ç½®å»¶æ—¶é˜Ÿåˆ—">5.3.1 é…ç½®å»¶æ—¶é˜Ÿåˆ—</h4>
<p>åœ¨application.ymlæ–‡ä»¶ä¸­å¼•å…¥é˜Ÿåˆ—ä¿¡æ¯é…ç½®ï¼Œå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#ä½ç½®æ”¯ä»˜äº¤æ¢æœºå’Œé˜Ÿåˆ—
mq:
  pay:
    exchange:
      seckillorder: exchange.seckillorder
      seckillordertimer: exchange.seckillordertimer
    queue:
      seckillorder: queue.seckillorder
      seckillordertimer: queue.seckillordertimer
      seckillordertimerdelay: queue.seckillordertimerdelay
    routing:
      seckillkey: queue.seckillorder
      seckillordertimerkey: queue.seckillordertime
</code></pre><p>é…ç½®é˜Ÿåˆ—ä¸äº¤æ¢æœº,åœ¨SeckillApplicationä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ°æœŸæ•°æ®é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">seckillOrderTimerQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillordertimer&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è¶…æ—¶æ•°æ®é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">delaySeckillOrderTimerQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> QueueBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">durable</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillordertimerdelay&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-exchange&#34;</span><span style="color:#000;font-weight:bold">,</span> env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillordertimer&#34;</span><span style="color:#000;font-weight:bold">))</span>        <span style="color:#998;font-style:italic">// æ¶ˆæ¯è¶…æ—¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œç»‘å®šæ­»ä¿¡é˜Ÿåˆ—äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#000;font-weight:bold">,</span> env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillordertimerkey&#34;</span><span style="color:#000;font-weight:bold">))</span>   <span style="color:#998;font-style:italic">// ç»‘å®šæŒ‡å®šçš„routing-key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ›å»ºå»¶æ—¶äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">directExchangeOrderTimer</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillordertimer&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * äº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicBindingOrderTime</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> BindingBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>seckillOrderTimerQueue<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>directExchangeOrderTimer<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillordertimerkey&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="532-å‘é€å»¶æ—¶æ¶ˆæ¯">5.3.2 å‘é€å»¶æ—¶æ¶ˆæ¯</h4>
<p>ä¿®æ”¹MultiThreadingCreateOrderï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * å‘é€å»¶æ—¶æ¶ˆæ¯åˆ°RabbitMQä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param seckillStatus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sendTimerMessage</span><span style="color:#000;font-weight:bold">(</span>SeckillStatus seckillStatus<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    rabbitTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertAndSend</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillordertimerdelay&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span>Object<span style="color:#000;font-weight:bold">)</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">new</span> MessagePostProcessor<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">public</span> Message <span style="color:#900;font-weight:bold">postProcessMessage</span><span style="color:#000;font-weight:bold">(</span>Message message<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> AmqpException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            message<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessageProperties</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setExpiration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> message<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>åœ¨createOrderæ–¹æ³•ä¸­è°ƒç”¨ä¸Šé¢æ–¹æ³•ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//å‘é€å»¶æ—¶æ¶ˆæ¯åˆ°MQä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>sendTimerMessage<span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="533-feignè°ƒç”¨æ”¯ä»˜æœåŠ¡å…³é—­é¢„ä¸‹å•æ¥å£">5.3.3 Feignè°ƒç”¨æ”¯ä»˜æœåŠ¡å…³é—­é¢„ä¸‹å•æ¥å£</h4>
<p>åœ¨æ¨¡å—dongyimai-seckill-serviceåˆ›å»ºfeignæ¥å£</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.seckill.feign</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.openfeign.FeignClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.PostMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;PAY&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">PayFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/pay/closepay&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">)</span> Long out_trade_no<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ³¨æ„ä¿®æ”¹é…ç½®æ–‡ä»¶application.ymlè®¾ç½®feignè°ƒç”¨è¶…æ—¶æ—¶é—´</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">feign</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">connectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">5000</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">#è¿æ¥è¶…æ—¶æ—¶é—´5ç§’</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">readTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">5000</span><span style="color:#bbb">     </span><span style="color:#998;font-style:italic">#è¯»è¶…æ—¶æ—¶é—´5ç§’</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#hystrix é…ç½®</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">execution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">timeout</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#998;font-style:italic">#å¦‚æœenabledè®¾ç½®ä¸ºfalseï¼Œåˆ™è¯·æ±‚è¶…æ—¶äº¤ç»™ribbonæ§åˆ¶</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">isolation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">thread</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">timeoutInMilliseconds</span>:<span style="color:#bbb"> </span><span style="color:#099">10000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">strategy</span>:<span style="color:#bbb"> </span>SEMAPHORE<span style="color:#bbb">
</span></span></span></code></pre></div><h4 id="534-åº“å­˜å›æ»š">5.3.4 åº“å­˜å›æ»š</h4>
<p>åˆ›å»ºSeckillOrderDelayMessageListenerå®ç°ç›‘å¬æ¶ˆæ¯ï¼Œå¹¶å›æ»šåº“å­˜ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.seckill.consumer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.bean.SeckillStatus</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.feign.PayFeign</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.pojo.SeckillOrder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.service.SeckillOrderService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.data.redis.core.RedisTemplate</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.messaging.handler.annotation.Payload</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Component</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;${mq.pay.queue.seckillordertimer}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillOrderDelayMessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RedisTemplate redisTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SeckillOrderService seckillOrderService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> PayFeign payFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è¯»å–æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ¤æ–­Redisä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å¦‚æœå­˜åœ¨ï¼Œåˆ™å…³é—­æ”¯ä»˜ï¼Œå†å…³é—­è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">consumeMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> String message<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è¯»å–æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillStatus seckillStatus <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">,</span>SeckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–Redisä¸­è®¢å•ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String username <span style="color:#000;font-weight:bold">=</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillOrder<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å¦‚æœRedisä¸­æœ‰è®¢å•ä¿¡æ¯ï¼Œè¯´æ˜ç”¨æˆ·æœªæ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å‡†å¤‡å›æ»š---&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å…³é—­æ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Result closeResult <span style="color:#000;font-weight:bold">=</span> payFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closePay</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> closeMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;)</span> closeResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>closeMap<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> closeMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//å…³é—­è®¢å•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                seckillOrderService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closeOrder</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼š</p>
<p>http://localhost:8001/api/seckillOrder/add?time=2021062012&amp;id=1</p>
<p>æµ‹è¯•ä¸‹å•ï¼Œ10ç§’å†…æœªå®Œæˆæ”¯ä»˜ï¼Œå³å¯æ”¶åˆ°å»¶æ—¶æ¶ˆæ¯ï¼Œå›æ»šè®¢å•
<img src="/posts/project-0/20220528173393/image-20220528174047031.png"
    
    
    
    loading="lazy"
    
    
></p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528172837/">â† ç§’æ€1</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528170121/">è´­ç‰©è½¦è§£å†³æ–¹æ¡ˆ  â†’</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        è±«ICPå¤‡2022002918å·
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
