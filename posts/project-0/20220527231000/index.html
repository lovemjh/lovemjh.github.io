<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>商品搜索</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/agate.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script>
    hljs.highlightAll();
  </script>
  
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.5.2/animate.min.css">
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
     

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }

    #Background_animation { 
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    }

  </style>

</head>
    <body style="background-color: rgb(229, 204, 15);">
    
<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" viewBox="0 0 100 100" id="Background_animation">
  <defs>
      <style>
          @keyframes rotate {
              100% {
                  transform: rotate(360deg);
              }
          }
          .out-top {
              animation: rotate 20s linear infinite;
              transform-origin: 13px 25px;
          }
          .in-top {
              animation: rotate 10s linear infinite;
              transform-origin: 13px 25px;
          }
          .out-bottom {
              animation: rotate 25s linear infinite;
              transform-origin: 84px 93px;
          }
          .in-bottom {
              animation: rotate 15s linear infinite;
              transform-origin: 84px 93px;
          }
      </style>
  </defs>
  <path fill="#9b5de5" class="out-top" d="M37-5C25.1-14.7,5.7-19.1-9.2-10-28.5,1.8-32.7,31.1-19.8,49c15.5,21.5,52.6,22,67.2,2.3C59.4,35,53.7,8.5,37-5Z"/>
  <path fill="#f15bb5" class="in-top" d="M20.6,4.1C11.6,1.5-1.9,2.5-8,11.2-16.3,23.1-8.2,45.6,7.4,50S42.1,38.9,41,24.5C40.2,14.1,29.4,6.6,20.6,4.1Z"/>
  <path fill="#00bbf9" class="out-bottom" d="M105.9,48.6c-12.4-8.2-29.3-4.8-39.4.8-23.4,12.8-37.7,51.9-19.1,74.1s63.9,15.3,76-5.6c7.6-13.3,1.8-31.1-2.3-43.8C117.6,63.3,114.7,54.3,105.9,48.6Z"/>
  <path fill="#00f5d4" class="in-bottom" d="M102,67.1c-9.6-6.1-22-3.1-29.5,2-15.4,10.7-19.6,37.5-7.6,47.8s35.9,3.9,44.5-12.5C115.5,92.6,113.9,74.6,102,67.1Z"/>
</svg>

  <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div><nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
<div id="body-wrap">
  
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-27&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-27&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            7842 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            16 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['商品搜索'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第七章</h1>
<h1 align = "center">商品搜索</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>条件筛选</li>
<li>多条件搜索<code>[品牌、规格条件搜索]</code></li>
<li>规格过滤</li>
<li>价格区间搜索</li>
<li>搜索分页</li>
<li>搜索排序</li>
<li>搜索高亮</li>
</ul>
<h2 id="1-品牌统计">1. 品牌统计</h2>
<p><img src="/posts/project-0/20220527231000/image-20220527231207981.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户搜索的时候，除了使用分类搜索外，还有可能使用品牌搜索，所以我们还需要显示品牌数据和规格数据，品牌数据和规格数据的显示比较容易，都可以考虑使用分类统计的方式进行分组实现。</p>
<h3 id="11-品牌统计分析">1.1 品牌统计分析</h3>
<p>看下面的SQL语句，我们在执行搜索的时候，第1条SQL语句是执行搜，第2条语句是根据品牌名字分组查看有多少品牌，大概执行了2个步骤就可以获取数据结果以及品牌统计，我们可以发现他们的搜索条件完全一样。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询所有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tb_item</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%手机%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 根据品牌名字分组查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">brand</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="n">tb_item</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%手机%&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">brand</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>我们每次执行搜索的时候，需要显示商品品牌名称，这里要显示的品牌名称其实就是符合搜素条件的所有商品的品牌集合，我们可以按照上面的实现思路，使用ES根据分组名称做一次分组查询即可实现。</p>
<h3 id="12-品牌分组统计实现">1.2 品牌分组统计实现</h3>
<p>修改search微服务的com.offcn.search.service.impl.SkuServiceImpl类，添加一个品牌分组搜索,如图:
<img src="/posts/project-0/20220527231000/image-20220527231217595.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>添加的代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//设置分组条件  商品品牌
</span></span><span class="line"><span class="cl">nativeSearchQueryBuilder.addAggregation(AggregationBuilders.terms(&#34;skuBrandgroup&#34;).field(&#34;brand.keyword&#34;).size(50));
</span></span></code></pre></div><p>执行获取分组结果:
<img src="/posts/project-0/20220527231000/image-20220527231229573.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>整体代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1.获取关键字的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">keywords</span> <span class="o">=</span> <span class="s">&#34;华为&#34;</span><span class="o">;</span><span class="c1">//赋值给一个默认的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2.创建查询对象 的构建对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//3.设置查询的条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;brand.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span> <span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//5.执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AggregatedPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">esTemplate</span><span class="o">.</span><span class="na">queryForPage</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Terms</span> <span class="n">TermsCategory</span> <span class="o">=</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Terms</span> <span class="n">TermsBrand</span> <span class="o">=</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="n">getStringsCategoryList</span><span class="o">(</span><span class="n">stringTermsCategory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="n">getStringsBrandList</span><span class="o">(</span><span class="n">stringTermsBrand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//6.返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;categoryList&#34;</span><span class="o">,</span> <span class="n">categoryList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;brandList&#34;</span><span class="o">,</span> <span class="n">brandList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取品牌列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param terms
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span> 
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringBrandList</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建一个集合存放全部的品牌分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">terms</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">brandList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">brandList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取分类列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stringTerms
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringCategorList</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建一个集合存放全部的分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">terms</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//获取分组的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//把分组的值加入到集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">categoryList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="n">categoryList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h3 id="13-测试">1.3 测试</h3>
<p>使用PostMan请求http://localhost:9004/search
<img src="/posts/project-0/20220527231000/image-20220527231240838.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="2-规格统计">2. 规格统计</h2>
<p><img src="/posts/project-0/20220527231000/image-20220527231248408.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户搜索的时候，除了使用分类、品牌搜索外，还有可能使用规格搜索，所以我们还需要显示规格数据，规格数据的显示相比上面2种实现略微较难一些，需要对数据进行处理，我们也可以考虑使用分类统计和品牌统计的方式进行分组实现。</p>
<h3 id="21-规格统计分析">2.1 规格统计分析</h3>
<p>看下面的SQL语句，我们在执行搜索的时候，第1条SQL语句是执行搜，第2条语句是根据规格分组查看有多少规格，大概执行了2个步骤就可以获取数据结果以及规格统计，我们可以发现他们的搜索条件完全一样。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询所有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tb_item</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%手机%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 根据规格名字分组查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="n">tb_item</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%手机%&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">spec</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>上述SQL语句执行后的结果如下图：
<img src="/posts/project-0/20220527231000/image-20220527231255150.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>获取到的规格数据我们发现有重复，不过也可以解决，解决思路如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.获取所有规格数据
</span></span><span class="line"><span class="cl">2.将所有规格数据转换成Map
</span></span><span class="line"><span class="cl">3.定义一个Map&lt;String,Set&gt;,key是规格名字，防止重复所以用Map，valu是规格值，规格值有多个，所以用集合，为了防止规格重复，用Set去除重复
</span></span><span class="line"><span class="cl">4.循环规格的Map，将数据填充到定义的Map&lt;String,Set&gt;中
</span></span></code></pre></div><p>我们每次执行搜索的时候，需要显示商品规格数据，这里要显示的规格数据其实就是符合搜素条件的所有商品的规格集合，我们可以按照上面的实现思路，使用ES根据分组名称做一次分组查询，并去除重复数据即可实现。</p>
<h3 id="22-规格统计分组实现">2.2 规格统计分组实现</h3>
<p>修改search微服务的com.offcn.search.service.impl.SkuServiceImpl类，添加一个规格分组搜索</p>
<p>如图:添加规格分组条件
<img src="/posts/project-0/20220527231000/image-20220527231307639.png"
    
    
    
    loading="lazy"
    
    
>
上图代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//设置分组条件  商品的规格
</span></span><span class="line"><span class="cl">nativeSearchQueryBuilder.addAggregation(AggregationBuilders.terms(&#34;skuSpecgroup&#34;).field(&#34;spec.keyword&#34;).size(100));
</span></span></code></pre></div><p>如图:获取规格分组结果:
<img src="/posts/project-0/20220527231000/image-20220527231315811.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>封装调用分组结果的方法，代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 获取规格列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param stringTermsSpec
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//获取规格列表数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">getStringSpecMap</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建一个返回的Map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">specMap</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建一个set存储规格选项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">specSet</span><span class="o">=</span><span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断查询结果不为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">terms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//把查询到规格名称加入到set自动去重
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">specSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">specJson</span> <span class="o">:</span> <span class="n">specSet</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//解析转换规格的json字符串为map集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">specJson</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//遍历map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//提取规格名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//根据规格名称提取对应的规格选项数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">specValues</span><span class="o">=</span><span class="n">specMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断规格选项数据是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">specValues</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">specValues</span><span class="o">=</span><span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//把当前规格选项加入到规格选项数据集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">specValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//把当前的数据加入到返回map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">specMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">specValues</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">specMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>整体代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1.获取关键字的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">keywords</span> <span class="o">=</span> <span class="s">&#34;华为&#34;</span><span class="o">;</span><span class="c1">//赋值给一个默认的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2.创建查询对象 的构建对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//3.设置查询的条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;brand.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品的规格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuSpecgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;spec.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span> <span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//5.执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AggregatedPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">esTemplate</span><span class="o">.</span><span class="na">queryForPage</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StringTerms</span> <span class="n">stringTermsCategory</span> <span class="o">=</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">)</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StringTerms</span> <span class="n">stringTermsBrand</span> <span class="o">=</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">)</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品规格数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StringTerms</span> <span class="n">stringTermsSpec</span> <span class="o">=</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">)</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuSpecgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="n">getStringsCategoryList</span><span class="o">(</span><span class="n">stringTermsCategory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="n">getStringsBrandList</span><span class="o">(</span><span class="n">stringTermsBrand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">specMap</span> <span class="o">=</span> <span class="n">getStringSetMap</span><span class="o">(</span><span class="n">stringTermsSpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//6.返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;specMap&#34;</span><span class="o">,</span> <span class="n">specMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;categoryList&#34;</span><span class="o">,</span> <span class="n">categoryList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;brandList&#34;</span><span class="o">,</span> <span class="n">brandList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取品牌列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stringTermsBrand
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringsBrandList</span><span class="o">(</span><span class="n">StringTerms</span> <span class="n">stringTermsBrand</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">stringTermsBrand</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">stringTermsBrand</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">brandList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">brandList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取分类列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stringTerms
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringsCategoryList</span><span class="o">(</span><span class="n">StringTerms</span> <span class="n">stringTerms</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">stringTerms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">stringTerms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span><span class="c1">//分组的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">categoryList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">categoryList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取规格列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param stringTermsSpec
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">getStringSetMap</span><span class="o">(</span><span class="n">StringTerms</span> <span class="n">stringTermsSpec</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">specMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">specList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">stringTermsSpec</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">stringTermsSpec</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">specList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">specjson</span> <span class="o">:</span> <span class="n">specList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">specjson</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>        <span class="c1">//规格名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>    <span class="c1">//规格选项值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//获取当前规格名字对应的规格数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">specValues</span> <span class="o">=</span> <span class="n">specMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">specValues</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">specValues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//将当前规格加入到集合中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">specValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//将数据存入到specMap中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">specMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">specValues</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">specMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="23-测试">2.3 测试</h3>
<p>使用Postman测试访问http://localhost:9004/search  效果如下：
<img src="/posts/project-0/20220527231000/image-20220527231341255.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="3-条件筛选">3 条件筛选</h2>
<p><img src="/posts/project-0/20220527231000/image-20220527231351052.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户有可能会根据分类搜索、品牌搜索，还有可能根据规格搜索，以及价格搜索和排序操作。根据分类和品牌搜索的时候，可以直接根据指定域搜索，而规格搜索的域数据是不确定的，价格是一个区间搜索，所以我们可以分为三段时间，先实现分类、品牌搜素，再实现规格搜索，然后实现价格区间搜索。</p>
<h3 id="31-分类品牌筛选">3.1 分类、品牌筛选</h3>
<h4 id="311-需求分析">3.1.1 需求分析</h4>
<p>页面每次向后台传入对应的分类和品牌，后台据分类和品牌进行条件过滤即可。</p>
<h4 id="312-代码实现">3.1.2 代码实现</h4>
<p>修改搜索微服务com.offcn.search.service.impl.SkuServiceImpl的search方法，添加分类和品牌过滤,</p>
<p>添加过滤条件如下:
<img src="/posts/project-0/20220527231000/image-20220527231358161.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>PS说明: 以上,我们建议使用filter ,它的搜索效率要优于must.可以参考官方文档说明:</p>
<p><a class="link" href="/posts/project-0/https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html"  target="_blank" rel="noopener"
    >https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html</a></p>
<p>上图整体代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1.获取关键字的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">keywords</span> <span class="o">=</span> <span class="s">&#34;华为&#34;</span><span class="o">;</span><span class="c1">//赋值给一个默认的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2.创建查询对象 的构建对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//3.设置查询的条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;brand.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//设置分组条件  商品的规格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuSpecgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;spec.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//设置主关键字查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span> <span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BoolQueryBuilder</span> <span class="n">boolQueryBuilder</span> <span class="o">=</span> <span class="n">QueryBuilders</span><span class="o">.</span><span class="na">boolQuery</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;brand&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;brand.keyword&#34;</span><span class="o">,</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;brand&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;category&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">,</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;category&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//构建过滤查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withFilter</span><span class="o">(</span><span class="n">boolQueryBuilder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//5.执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AggregatedPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">esTemplate</span><span class="o">.</span><span class="na">queryForPage</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品分类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StringTerms</span> <span class="n">stringTermsCategory</span> <span class="o">=</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">)</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StringTerms</span> <span class="n">stringTermsBrand</span> <span class="o">=</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">)</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取分组结果  商品规格数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StringTerms</span> <span class="n">stringTermsSpec</span> <span class="o">=</span> <span class="o">(</span><span class="n">StringTerms</span><span class="o">)</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getAggregation</span><span class="o">(</span><span class="s">&#34;skuSpecgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="n">getStringsCategoryList</span><span class="o">(</span><span class="n">stringTermsCategory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="n">getStringsBrandList</span><span class="o">(</span><span class="n">stringTermsBrand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">specMap</span> <span class="o">=</span> <span class="n">getStringSetMap</span><span class="o">(</span><span class="n">stringTermsSpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//6.返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;specMap&#34;</span><span class="o">,</span> <span class="n">specMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;categoryList&#34;</span><span class="o">,</span> <span class="n">categoryList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;brandList&#34;</span><span class="o">,</span> <span class="n">brandList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="313-测试">3.1.3 测试</h4>
<p>测试效果如下：</p>
<p>访问地址：http://localhost:9004/search</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{&#34;keywords&#34;:&#34;黑色&#34;,&#34;category&#34;:&#34;手机&#34;,&#34;brand&#34;:&#34;三星&#34;}
</span></span></code></pre></div><p><img src="/posts/project-0/20220527231000/image-20220527231409841.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>此时只能搜到TCL手机</p>
<h3 id="32-规格过滤">3.2 规格过滤</h3>
<h4 id="321-需求分析">3.2.1 需求分析</h4>
<p><img src="/posts/project-0/20220527231000/image-20220527231416030.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>格这一块，需要向后台发送规格名字以及规格值，我们可以按照一定要求来发送数据，例如规格名字以特殊前缀提交到后台：<code>spec_网络制式：电信4G、spec_显示屏尺寸：4.0-4.9英寸</code></p>
<p>后台接到数据后，可以根据前缀spec_来区分是否是规格，如果以<code>spec_xxx</code>开始的数据则为规格数据，需要根据指定规格找信息。
<img src="/posts/project-0/20220527231000/image-20220527231421234.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图是规格的索引存储格式，真实数据在spechMap.规格名字.keyword中，所以找数据也是按照如下格式去找：</p>
<p><code>spechMap.规格名字.keyword</code></p>
<p>使用命令可以查看存储格式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /skuinfo/_mapping
</span></span></code></pre></div><h4 id="322-代码实现">3.2.2 代码实现</h4>
<p>修改com.offcn.search.service.impl.SkuServiceImpl的search方法，增加规格查询操作，代码如下：<img src="/posts/project-0/20220527231000/image-20220527231441666.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//规格过滤查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">searchMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;spec_&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;specMap.&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;.keyword&#34;</span><span class="o">,</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="323-测试">3.2.3 测试</h4>
<p>访问地址：http://localhost:9004/search</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;keywords&#34;</span><span class="p">:</span><span class="s2">&#34;黑色&#34;</span><span class="p">,</span><span class="nt">&#34;spec_网络&#34;</span><span class="p">:</span><span class="s2">&#34;双卡&#34;</span><span class="p">,</span><span class="nt">&#34;spec_机身内存&#34;</span><span class="p">:</span><span class="s2">&#34;32G&#34;</span><span class="p">}</span>
</span></span></code></pre></div><p><img src="/posts/project-0/20220527231000/image-20220527231453078.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="33-价格区间查询">3.3 价格区间查询</h3>
<h4 id="331-需求分析">3.3.1 需求分析</h4>
<p><img src="/posts/project-0/20220527231000/image-20220527231500432.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>价格区间查询，每次需要将价格传入到后台，前端传入后台的价格大概是<code>price=0-500</code>或者<code>price=500-1000</code>依次类推，最后一个是<code>price=3000</code>,后台可以根据-分割，如果分割得到的结果最多有2个，第1个表示<code>x&lt;price</code>，第2个表示<code>price&lt;=y</code>。</p>
<h4 id="332-代码实现">3.3.2 代码实现</h4>
<p>修改com.offcn.search.service.impl.SkuServiceImpl的search方法，增加价格区间查询操作，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//价格过滤查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">String</span> <span class="n">price</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">price</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">split</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">split</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">rangeQuery</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">).</span><span class="na">from</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="kc">true</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="kc">true</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">rangeQuery</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">).</span><span class="na">gte</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="333-测试">3.3.3 测试</h4>
<p>访问地址：http://localhost:9004/search</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;keywords&#34;</span><span class="p">:</span><span class="s2">&#34;黑色&#34;</span><span class="p">,</span><span class="nt">&#34;price&#34;</span><span class="p">:</span><span class="s2">&#34;1-500&#34;</span><span class="p">}</span>
</span></span></code></pre></div><p><img src="/posts/project-0/20220527231000/image-20220527231509561.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>效果如下(部分数据)：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;total&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;categoryList&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;手机&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;totalPages&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;specMap&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;网络&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;电信3G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;移动3G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;联通3G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;联通2G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;移动4G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;联通4G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;移动2G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;电信4G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;双卡&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;机身内存&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;16G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;128G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;32G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;64G&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;brandList&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;三星&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;苹果&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;中国移动&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;联想&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;华为&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;酷派&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;诺基亚&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;飞利浦&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;OPPO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;TCL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;中兴&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;索尼&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;金立&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;小米&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;朵唯&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;百加&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;海信&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;微软&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;阿尔卡特&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;魅族&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;派信&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1260714</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;TCL (S850L) 16GB 耀目红 电信4G手机&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="mf">759.00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;num&#34;</span><span class="p">:</span> <span class="mi">99999</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;http://img11.360buyimg.com/n1/s450x450_jfs/t2278/328/1482029120/347965/7755349f/565e97aaN5710a07d.jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;createTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2015-03-08T13:30:44.000+0000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;updateTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2015-03-08T13:30:44.000+0000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;isDefault&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;goodsId&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;categoryId&#34;</span><span class="p">:</span> <span class="mi">560</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;category&#34;</span><span class="p">:</span> <span class="s2">&#34;手机&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;brand&#34;</span><span class="p">:</span> <span class="s2">&#34;TCL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;机身内存\&#34;:\&#34;16G\&#34;,\&#34;网络\&#34;:\&#34;电信4G\&#34;}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;specMap&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;网络&#34;</span><span class="p">:</span> <span class="s2">&#34;电信4G&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;机身内存&#34;</span><span class="p">:</span> <span class="s2">&#34;16G&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="4-搜索分页">4 搜索分页</h2>
<h3 id="41-分页分析">4.1 分页分析</h3>
<p><img src="/posts/project-0/20220527231000/image-20220527231519046.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>页面需要实现分页搜索，所以我们后台每次查询的时候，需要实现分页。用户页面每次会传入当前页和每页查询多少条数据，当然如果不传入每页显示多少条数据，默认查询30条即可。</p>
<h3 id="42-分页实现">4.2 分页实现</h3>
<p>分页使用PageRequest.of( pageNo- 1, pageSize);实现，第1个参数表示第N页，从0开始，第2个参数表示每页显示多少条，实现代码如下：</p>
<p><img src="/posts/project-0/20220527231000/image-20220527231526768.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> 		<span class="c1">//略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">//构建过滤查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withFilter</span><span class="o">(</span><span class="n">boolQueryBuilder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//构建分页查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Integer</span> <span class="n">pageNum</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;pageNum&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pageNum</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;pageNum&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">pageNum</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Integer</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//设置分页条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withPageable</span><span class="o">(</span><span class="n">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">pageNum</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">pageSize</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//略
</span></span></span></code></pre></div><p>测试如下:
<img src="/posts/project-0/20220527231000/image-20220527231535174.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-搜索排序">5 搜索排序</h2>
<h3 id="51-排序分析">5.1 排序分析</h3>
<p><img src="/posts/project-0/20220527231000/image-20220527231541297.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>排序这里总共有根据价格排序、根据评价排序、根据新品排序、根据销量排序，排序要想实现非常简单，只需要告知排序的域以及排序方式即可实现。</p>
<p>价格排序：只需要根据价格高低排序即可，降序价格高-&gt;低，升序价格低-&gt;高</p>
<p>评价排序：评价分为好评、中评、差评，可以在数据库中设计3个列，用来记录好评、中评、差评的量，每次排序的时候，好评的比例来排序，当然还要有条数限制，评价条数需要超过N条。</p>
<p>新品排序：直接根据商品的发布时间或者更新时间排序。</p>
<p>销量排序：销量排序除了销售数量外，还应该要有时间段限制。</p>
<h3 id="52-排序实现">5.2 排序实现</h3>
<p>这里我们不单独针对某个功能实现排序，我们只需要在后台接收2个参数，分别是排序域名字和排序方式，代码如下：
<img src="/posts/project-0/20220527231000/image-20220527231546735.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>解释: 前端页面传递要排序的字段(field)和要排序的类型(ASC,DESC),后台接收.</p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//构建排序查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">String</span> <span class="n">sortRule</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sortRule&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">sortField</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sortField&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">sortRule</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">sortField</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="n">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="n">sortField</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="n">sortRule</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;DESC&#34;</span><span class="o">)</span> <span class="o">?</span> <span class="n">SortOrder</span><span class="o">.</span><span class="na">DESC</span> <span class="o">:</span> <span class="n">SortOrder</span><span class="o">.</span><span class="na">ASC</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试</p>
<p>根据价格降序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{&#34;keywords&#34;:&#34;手机&#34;,&#34;pageNum&#34;:&#34;1&#34;,&#34;sortRule&#34;:&#34;DESC&#34;,&#34;sortField&#34;:&#34;price&#34;}
</span></span></code></pre></div><p>根据价格升序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{&#34;keywords&#34;:&#34;手机&#34;,&#34;pageNum&#34;:&#34;1&#34;,&#34;sortRule&#34;:&#34;ASC&#34;,&#34;sortField&#34;:&#34;price&#34;}
</span></span></code></pre></div><h2 id="6-高亮显示">6 高亮显示</h2>
<h3 id="61-高亮分析">6.1 高亮分析</h3>
<p><img src="/posts/project-0/20220527231000/image-20220527231557971.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>高亮显示是指根据商品关键字搜索商品的时候，显示的页面对关键字给定了特殊样式，让它显示更加突出，如上图商品搜索中，关键字变成了红色，其实就是给定了红色样式。
<img src="/posts/project-0/20220527231000/image-20220527231602820.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="62-高亮搜索实现步骤解析">6.2 高亮搜索实现步骤解析</h3>
<p>将之前的搜索换掉，换成高亮搜索，我们需要做3个步骤：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.指定高亮域，也就是设置哪个域需要高亮显示
</span></span><span class="line"><span class="cl">  设置高亮域的时候，需要指定前缀和后缀，也就是关键词用什么html标签包裹，再给该标签样式
</span></span><span class="line"><span class="cl">2.高亮搜索实现
</span></span><span class="line"><span class="cl">3.将非高亮数据替换成高亮数据
</span></span></code></pre></div><p>第1点，例如在百度中搜索数据的时候，会有2个地方高亮显示，分别是标题和描述，商城搜索的时候，只是商品名称高亮显示了。而高亮显示其实就是添加了样式，例如<code>&lt;span style=&quot;color:red;&quot;&gt;笔记本&lt;/span&gt;</code>,而其中span开始标签可以称为前缀，span结束标签可以称为后缀。</p>
<p>第2点，高亮搜索使用ElasticsearchTemplate实现。</p>
<p>第3点，高亮搜索后，会搜出非高亮数据和高亮数据，高亮数据会加上第1点中的高亮样式，此时我们需要将非高亮数据换成高亮数据即可。例如非高亮:<code>华为笔记本性能超强悍</code>  高亮数据：<code>华为&lt;span style=&quot;color:red;&quot;笔记本&lt;/span&gt;性能超强悍</code>,将非高亮的换成高亮的，到页面就能显示样式了。</p>
<h3 id="63-高亮代码实现">6.3 高亮代码实现</h3>
<p>修改com.offcn.search.service.impl.SkuServiceImpl的search方法搜索代码，添加高亮显示的域:
<img src="/posts/project-0/20220527231000/image-20220527231609912.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//设置高亮条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withHighlightFields</span><span class="o">(</span><span class="k">new</span> <span class="n">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withHighlightBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">HighlightBuilder</span><span class="o">().</span><span class="na">preTags</span><span class="o">(</span><span class="s">&#34;&lt;em style=\&#34;color:red\&#34;&gt;&#34;</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">&#34;&lt;/em&gt;&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//设置主关键字查询,修改为多字段的搜索条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">multiMatchQuery</span><span class="o">(</span><span class="n">keywords</span><span class="o">,</span><span class="s">&#34;title&#34;</span><span class="o">,</span><span class="s">&#34;brand&#34;</span><span class="o">,</span><span class="s">&#34;category&#34;</span><span class="o">));</span>
</span></span></code></pre></div><p>处理查询高亮结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//....执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//获取高亮结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHit</span> <span class="o">:</span> <span class="n">searchHits</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取高亮的内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">highlightFields</span> <span class="o">=</span> <span class="n">searchHit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取标题的高亮结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">highlightFields</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">)==</span><span class="kc">null</span><span class="o">?</span><span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">getTitle</span><span class="o">():</span><span class="n">highlightFields</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//...获取查询结果数据集合
</span></span></span></code></pre></div><p>注意：放置高亮结果处理代码的顺序，一定要放在获取查询结果数据集合上面。</p>
<h3 id="64-测试">6.4 测试</h3>
<p><img src="/posts/project-0/20220527231000/image-20220527231617975.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#34;name&#34;: &#34;HTC M8Sd (E8) 波尔多红 电信4G&lt;span style=\&#34;color:red\&#34;&gt;手机&lt;/span&gt; 双卡双待双通&#34;,
</span></span></code></pre></div><p>整体代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SkuServiceImpl</span> <span class="kd">implements</span> <span class="n">SkuService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SkuEsMapper</span> <span class="n">skuEsMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ItemFeign</span> <span class="n">itemFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ElasticsearchRestTemplate</span> <span class="n">elasticsearchRestTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importSku</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//调用商品微服务，获取审核状态为1，审核通过的商品
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">itemFeign</span><span class="o">.</span><span class="na">findByStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//算法很好，把接收过来的数据，转换为json字符串，在重新转换为集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuInfoList</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseArray</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">()),</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历sku集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">SkuInfo</span> <span class="n">skuInfo</span> <span class="o">:</span> <span class="n">skuInfoList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取规格数据{&#34;网络&#34;:&#34;移动4G&#34;}，转换为map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">specMap</span><span class="o">=</span>  <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">.</span><span class="na">getSpec</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//关联到动态域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skuInfo</span><span class="o">.</span><span class="na">setSpecMap</span><span class="o">(</span><span class="n">specMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//保存sku到ES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">skuEsMapper</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">skuInfoList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取搜索关键字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">keywords</span><span class="o">=</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断关键字是否为空，如果为空设置默认值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="n">keywords</span><span class="o">=</span><span class="s">&#34;手机&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建查询对象构建器对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//设置分组条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置分组条件  商品品牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;brand.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//设置分组条件  规格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuSpecgroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;spec.keyword&#34;</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">50</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置查询条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span><span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//创建过滤器对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">BoolQueryBuilder</span> <span class="n">boolQueryBuilder</span> <span class="o">=</span> <span class="n">QueryBuilders</span><span class="o">.</span><span class="na">boolQuery</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//判断品牌查询条件是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;brand&#34;</span><span class="o">))){</span>
</span></span><span class="line"><span class="cl">            <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;brand&#34;</span><span class="o">,</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;brand.keyword&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断分类查询条件是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;category&#34;</span><span class="o">))){</span>
</span></span><span class="line"><span class="cl">            <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;category&#34;</span><span class="o">,</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//规格过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">searchMap</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//遍历searchMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//判断key是不是spec_开头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;spec_&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;specMap.&#34;</span><span class="o">+</span><span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">5</span><span class="o">)+</span><span class="s">&#34;.keyword&#34;</span><span class="o">,</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//价格区间过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">String</span> <span class="n">price</span><span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断价格不为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">price</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//切开价格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span><span class="o">[]</span> <span class="n">split</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断结束价格不等于*，就设置价格上限 和下限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="o">(!</span><span class="n">split</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">rangeQuery</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">).</span><span class="na">from</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span><span class="kc">true</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span><span class="kc">true</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//只设置价格下限 &gt;=
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">boolQueryBuilder</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">rangeQuery</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">).</span><span class="na">gte</span><span class="o">(</span><span class="n">split</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//关联查询器对象和过滤器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withFilter</span><span class="o">(</span><span class="n">boolQueryBuilder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//构建分页查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//获取要跳转到的页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Integer</span> <span class="n">pageNum</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断前端传递过来的页码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;pageNum&#34;</span><span class="o">))){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//把页码转换为整数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pageNum</span><span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;pageNum&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//转换失败，赋初始化值1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">pageNum</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取每页显示的记录数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Integer</span> <span class="n">pageSize</span><span class="o">=</span><span class="mi">5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断前端传递过来的每页显示记录数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;pageSize&#34;</span><span class="o">))){</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pageSize</span><span class="o">=</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;pageSize&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">pageSize</span><span class="o">=</span><span class="mi">5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//查询器对象，设置分页参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//注意页码要当前页码-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withPageable</span><span class="o">(</span><span class="n">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">pageNum</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">pageSize</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取排序方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">sortRule</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sortRule&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">sortField</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sortField&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断不为空，设置排序条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">sortRule</span><span class="o">)&amp;&amp;!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">sortField</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="n">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="n">sortField</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="n">sortRule</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;DESC&#34;</span><span class="o">)?</span> <span class="n">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">:</span><span class="n">SortOrder</span><span class="o">.</span><span class="na">ASC</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//设置高亮字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withHighlightFields</span><span class="o">(</span><span class="k">new</span> <span class="n">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置高亮选项 高亮前缀、高亮后缀
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withHighlightBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">HighlightBuilder</span><span class="o">().</span><span class="na">preTags</span><span class="o">(</span><span class="s">&#34;&lt;span style=&#39;color:red&#39;&gt;&#34;</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">&#34;&lt;/span&gt;&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//设置多关键词搜索
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">multiMatchQuery</span><span class="o">(</span><span class="n">keywords</span><span class="o">,</span><span class="s">&#34;title&#34;</span><span class="o">,</span><span class="s">&#34;brand&#34;</span><span class="o">,</span><span class="s">&#34;category&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//构建查询器对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQuery</span> <span class="n">searchQuery</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchHits</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">elasticsearchRestTemplate</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">searchQuery</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取高亮结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHit</span> <span class="o">:</span> <span class="n">searchHits</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取高亮的内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">highlightFields</span> <span class="o">=</span> <span class="n">searchHit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取标题的高亮结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">highlightFields</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">)==</span><span class="kc">null</span><span class="o">?</span><span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">getTitle</span><span class="o">():</span><span class="n">highlightFields</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//对搜索结果进行分页封装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">SearchHitSupport</span><span class="o">.</span><span class="na">searchPageFor</span><span class="o">(</span><span class="n">searchHits</span><span class="o">,</span> <span class="n">searchQuery</span><span class="o">.</span><span class="na">getPageable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//创建集合存储商品信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuInfoList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHit</span> <span class="o">:</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">SkuInfo</span> <span class="n">skuInfo</span><span class="o">=</span>     <span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">skuInfoList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//获取分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Terms</span> <span class="n">terms</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取分类名称集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="n">getStringsCategoryList</span><span class="o">(</span><span class="n">terms</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取品牌分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Terms</span> <span class="n">termsBrand</span><span class="o">=</span><span class="n">searchHits</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;skuBrandgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取品牌集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="n">getStringBrandList</span><span class="o">(</span><span class="n">termsBrand</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取规格分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">Terms</span> <span class="n">termsSpec</span><span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;skuSpecgroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">specMap</span> <span class="o">=</span> <span class="n">getStringSetMap</span><span class="o">(</span><span class="n">termsSpec</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuInfoList</span><span class="o">);</span><span class="c1">//获取所需SkuInfo集合数据内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span><span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">());</span><span class="c1">//总记录数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span><span class="c1">//总页数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;categoryList&#34;</span><span class="o">,</span><span class="n">categoryList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;brandList&#34;</span><span class="o">,</span><span class="n">brandList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;specMap&#34;</span><span class="o">,</span><span class="n">specMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取分类列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param terms
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringsCategoryList</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">terms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span><span class="c1">// 分组的值（分类名称）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">categoryList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取品牌分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringBrandList</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">brandList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">terms</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">brandList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">brandList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取规格分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">getStringSetMap</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">specMap</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">specList</span><span class="o">=</span><span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">terms</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">specList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//循环遍历
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">specJson</span> <span class="o">:</span> <span class="n">specList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//把规格的json字符串转换为map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span>  <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">specJson</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//遍历map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">key</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">value</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//去specMap查找指定的key看是否存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">specValues</span> <span class="o">=</span> <span class="n">specMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//判断value如果为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">specValues</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">specValues</span><span class="o">=</span><span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//把当前的值添加到set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">specValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//把数据添加到map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">specMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">specValues</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">specMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div>
            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220527220542/">← 东易买后端微服务框架搭建</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220527222325/">广告管理与Lua、Canal实现广告缓存 →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>


  
  <script src="/js/jquery.pjax.js"></script> 

    <script type="text/javascript">
            $(function () {
                $(document).pjax('a', '#page', {
                    fragment: '#page',
                    timeout: 5000,
                    cache: false
                });
                $(document).on({
                    'pjax:click': function () {
                        
                        console.log("点击链接");
                    },
                    'pjax:start': function () {
                        
                        console.log("获取请求");
                    },
                    'pjax:end': function () {
                        
                        console.log("请求完成");
                        addNumbers();

                }
            });
        });

    </script>

    <script>
        function addNumbers() {
            
            
            var myElement = document.getElementById('js-toc-w');
            if (window.location.href.includes('/posts/')) {
                
                console.log('地址栏中包含 "/posts/"');
                tocbot.refresh();
                myElement.style.display = 'block';
            } else {
                
                initpageimg();
                console.log('地址栏中不包含 "/posts/"');
                myElement.style.display = 'none';
            }

        }
        function initpageimg() {
            const imgArr = [
                "https://pic1.zhimg.com/80/v2-23d671bf74a246c54b1256bd2322d461_720w.webp?source=1940ef5c",
                "https://pic1.zhimg.com/80/v2-3afad658b44f596b10ec13b2b6d4299d_720w.webp?source=1940ef5c",
                "https://picx.zhimg.com/80/v2-b83d637fafb72fd13a5922aa0038bff9_720w.webp?source=1940ef5c",
                "https://pic1.zhimg.com/80/v2-3afad658b44f596b10ec13b2b6d4299d_720w.webp?source=1940ef5c",
                "https://pic1.zhimg.com/80/v2-7ee6f104979814d2bf420461e3872475_720w.webp?source=1940ef5c",
                "https://picx.zhimg.com/80/v2-585754b4ab4d49f480b833cbbbf4839f_720w.webp?source=1940ef5c",
                "https://pic1.zhimg.com/80/v2-b3d8f74192b2940a1112c93797cc0815_720w.webp?source=1940ef5c",
            ];
            var objs = document.getElementsByClassName('page-img');
            for (var i = 0; i < objs.length; i++) {
                objs[i].id = "myid" + i;
                let randNum = Math.floor(Math.random() * imgArr.length);
                var odiv = document.getElementById("myid" + i);
                odiv.style.backgroundImage = `url(${imgArr[randNum]})`;
                
                odiv.style.backgroundRepeat = "no-repeat";
                odiv.style.backgroundPosition = "0px 0px";
            }
        }
    </script>

<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        
        addNumbers();
        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
        if (scrollY > 600) {
            $(".js-toc-w").css("position", "fixed");
            $('.js-toc-w').css("right", "0px");
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");
        } else {
            $(".js-toc-w").css("position", "fixed");
            $('.js-toc-w').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>



<script type="text/javascript">
    
    tocbot.init({
    
    tocSelector: '.js-toc',
    
    contentSelector: '.js-toc-content',
    
    headingSelector: 'h1, h2, h3, h4, h5 ,h6',
    
    hasInnerContainers: false,
    
    });
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>