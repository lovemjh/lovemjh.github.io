<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>购物车解决方案</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }
  </style>

</head>
    <body style="    
    background-image: url(https://api.ixiaowai.cn/api/api.php);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;">
    <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap">
  <nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-28&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-28&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            14511 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            29 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['购物车解决方案'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第十二章</h1>
<h1 align = "center">购物车解决方案</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<p>目标1：资源服务器授权配置</p>
<p>目标2：掌握OAuth认证微服务动态加载数据</p>
<p>目标3：掌握购物车流程</p>
<p>目标4：掌握购物车渲染流程</p>
<p>目标5：OAuth2.0认证并获取用户令牌数据</p>
<p>目标6：微服务与微服务之间的认证</p>
<h2 id="1-资源服务器授权配置">1 资源服务器授权配置</h2>
<h3 id="11-资源服务授权配置">1.1 资源服务授权配置</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170232312.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>基本上所有微服务都是资源服务</p>
<p>(1)配置公钥 认证服务生成令牌采用非对称加密算法，认证服务采用私钥加密生成令牌，对外向资源服务提供公钥，资源服务使 用公钥 来校验令牌的合法性。 将公钥拷贝到 public.key文件中，将此文件拷贝到每一个需要的资源服务工程的classpath下 ,例如:用户微服务.</p>
<p>(2)添加依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)配置每个系统的Http请求路径安全控制策略以及读取公钥信息识别令牌，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableResourceServer</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span><span class="c1">//激活方法上的PreAuthorize注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfig</span> <span class="kd">extends</span> <span class="n">ResourceServerConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PUBLIC_KEY</span> <span class="o">=</span> <span class="s">&#34;public.key&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义JwtTokenStore
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param jwtAccessTokenConverter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TokenStore</span> <span class="nf">tokenStore</span><span class="o">(</span><span class="n">JwtAccessTokenConverter</span> <span class="n">jwtAccessTokenConverter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">JwtTokenStore</span><span class="o">(</span><span class="n">jwtAccessTokenConverter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义JJwtAccessTokenConverter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">JwtAccessTokenConverter</span> <span class="nf">jwtAccessTokenConverter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">JwtAccessTokenConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtAccessTokenConverter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">converter</span><span class="o">.</span><span class="na">setVerifierKey</span><span class="o">(</span><span class="n">getPubKey</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取非对称加密公钥 Key
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return 公钥 Key
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getPubKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="n">PUBLIC_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//读取第1行，公钥数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">((</span><span class="n">s</span><span class="o">=</span><span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Http安全配置，对每个到达系统的http请求链接进行校验
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param http
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//所有请求必须认证通过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//下边的路径放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;/user/add&#34;</span><span class="o">).</span> <span class="c1">//配置地址放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span>
</span></span><span class="line"><span class="cl">                <span class="n">authenticated</span><span class="o">();</span>    <span class="c1">//其他地址需要认证授权
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="12-用户微服务资源授权">1.2 用户微服务资源授权</h3>
<p>将上面生成的公钥public.key拷贝到dongyimai-user-service微服务工程的resources目录下，如下图：
<img src="/posts/project-0/20220528170121/image-20220528170246904.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>(1)引入依赖</p>
<p>在dongyimai-user-service微服务工程pom.xml中引入oauth依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--oauth依赖--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)资源授权配置</p>
<p>在dongyimai-user-service工程中创建com.offcn.user.config.ResourceServerConfig，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableResourceServer</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span><span class="c1">//激活方法上的PreAuthorize注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfig</span> <span class="kd">extends</span> <span class="n">ResourceServerConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PUBLIC_KEY</span> <span class="o">=</span> <span class="s">&#34;public.key&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义JwtTokenStore
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param jwtAccessTokenConverter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TokenStore</span> <span class="nf">tokenStore</span><span class="o">(</span><span class="n">JwtAccessTokenConverter</span> <span class="n">jwtAccessTokenConverter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">JwtTokenStore</span><span class="o">(</span><span class="n">jwtAccessTokenConverter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义JJwtAccessTokenConverter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">JwtAccessTokenConverter</span> <span class="nf">jwtAccessTokenConverter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">JwtAccessTokenConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtAccessTokenConverter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">converter</span><span class="o">.</span><span class="na">setVerifierKey</span><span class="o">(</span><span class="n">getPubKey</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取非对称加密公钥 Key
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return 公钥 Key
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>   
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getPubKey</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//加载公钥文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="n">PUBLIC_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//读取输入流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//读取第1行，公钥数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">((</span><span class="n">s</span><span class="o">=</span><span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Http安全配置，对每个到达系统的http请求链接进行校验
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param http
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//所有请求必须认证通过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//下边的路径放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;/user/add&#34;</span><span class="o">).</span> <span class="c1">//配置地址放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span>
</span></span><span class="line"><span class="cl">                <span class="n">authenticated</span><span class="o">();</span>    <span class="c1">//其他地址需要认证授权
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>问题：注意公钥的格式必须正确，要不然会出现如下错误
<img src="/posts/project-0/20220528170121/image-20220528170258095.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="13-授权测试">1.3 授权测试</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170303004.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户每次访问微服务的时候，需要先申请令牌，令牌申请后，每次将令牌放到头文件中，才能访问微服务。</p>
<p>头文件中每次需要添加一个<code>Authorization</code>头信息，头的结果为<code>bearer token</code>。</p>
<p>(1)不携带令牌测试</p>
<p>访问http://localhost:9007/user  不携带令牌，结果如下：
<img src="/posts/project-0/20220528170121/image-20220528170309717.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)携带正确令牌访问，注意重新生成令牌</p>
<p>访问http://localhost:9007/user  携带正确令牌</p>
<p>在请求头携带参数：</p>
<p>key:  Authorization</p>
<p>value: Bearer+半角空格+accessToken</p>
<p>结果如下：
<img src="/posts/project-0/20220528170121/image-20220528170315509.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(3)携带错误令牌</p>
<p>访问http://localhost:9007/user  携带不正确令牌，结果如下：
<img src="/posts/project-0/20220528170121/image-20220528170320779.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：客户端资源必须拥有：oauth2-resource，否则报错</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">clients</span><span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">&#34;client1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">resourceIds</span><span class="o">(</span><span class="s">&#34;oauth2-resource&#34;</span><span class="o">,</span><span class="s">&#34;dongyimai-user&#34;</span><span class="o">,</span> <span class="s">&#34;dongyimai-goods&#34;</span><span class="o">)</span>
</span></span></code></pre></div><h2 id="2-网关对接微服务转发token">2 网关对接微服务转发Token</h2>
<p><img src="/posts/project-0/20220528170121/image-20220528170331003.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户每次访问微服务的时候，先去oauth2.0服务登录，登录后再访问微服务网关，微服务网关将请求转发给其他微服务处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">1.用户登录成功后，会将令牌信息存入到cookie中(一般建议存入到头文件中)</span>
</span></span><span class="line"><span class="cl"><span class="err">2.用户携带Cookie中的令牌访问微服务网关</span>
</span></span><span class="line"><span class="cl"><span class="err">3.微服务网关先获取头文件中的令牌信息，如果Header中没有Authorization令牌信息，则从参数中找，参数中如果没有，则取Cookie中找Authorization，最后将令牌信息封装到Header中，并调用其他微服务</span>
</span></span><span class="line"><span class="cl"><span class="err">4.其他微服务会获取头文件中的Authorization令牌信息，然后匹配令牌数据是否能使用公钥解密，如果解密成功说明用户已登录，解密失败，说明用户未登录</span>
</span></span></code></pre></div><h3 id="11-令牌加入到header中">1.1 令牌加入到Header中</h3>
<p>修改dongyimai-gateway-web的全局过滤器com.offcn.filter.AuthorizeFilter，实现将令牌信息添加到头文件中，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170339101.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//不用解析令牌，直接转发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="c1">// Claims claims = JwtUtil.parseJwt(token);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">             <span class="c1">//判断token是否有Bearer开头,如果没有，就添加Bearer开头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="o">(</span><span class="n">token</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(!</span><span class="n">token</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">6</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;bearer&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//添加Bearer开头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">token</span><span class="o">=</span><span class="s">&#34;Bearer &#34;</span><span class="o">+</span><span class="n">token</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//把token转发到对应微服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">request</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">header</span><span class="o">(</span><span class="n">AUTHORIZE_TOKEN</span><span class="o">,</span><span class="n">token</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//解析出现异常返回401
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">setComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>访问<code>http://localhost:8001/api/user</code>，将生成的新令牌放到头文件中效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170345227.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：经测试如上由于java代码中添加了bearer， 那么在发出请求的时候就可以不加了。并且由于网关中gateway中AuthorizeFilter添加的从cookie中获取令牌。此时参数中请求头中不添加Authorization参数也不会报错。因为最终都会被Cookie获取的令牌给覆盖了。</p>
<h3 id="12-springsecurity权限控制">1.2 SpringSecurity权限控制</h3>
<p>由于我们项目使用了微服务，任何用户都有可能使用任意微服务，此时我们需要控制相关权限，例如：普通用户角色不能使用用户的删除操作，只有管理员才可以使用,那么这个时候就需要使用到SpringSecurity的权限控制功能了。</p>
<h4 id="121-角色加载">1.2.1 角色加载</h4>
<p>在dongyimai-user-oauth服务中，找到配置类WebSecurityConfig,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//编写自定义认证类，账号、密码、授权
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">UserDetailsService</span> <span class="nf">CreateUserDetailsService</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//用户账号集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserDetails</span><span class="o">&gt;</span> <span class="n">userDetailsList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建第一组账号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">UserDetails</span> <span class="n">userDetails1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">)).</span><span class="na">authorities</span><span class="o">(</span><span class="s">&#34;ADMIN&#34;</span><span class="o">,</span> <span class="s">&#34;USER&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserDetails</span> <span class="n">userDetails2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;user1&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;456&#34;</span><span class="o">)).</span><span class="na">authorities</span><span class="o">(</span><span class="s">&#34;USER&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserDetails</span> <span class="n">userDetails3</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;user2&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;789&#34;</span><span class="o">)).</span><span class="na">authorities</span><span class="o">(</span><span class="s">&#34;ADMIN&#34;</span><span class="o">,</span> <span class="s">&#34;USER&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//把创建好账号添加到账号集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">userDetailsList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userDetails1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">userDetailsList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userDetails2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">userDetailsList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userDetails3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//把账号存储到内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">InMemoryUserDetailsManager</span><span class="o">(</span><span class="n">userDetailsList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>注意：.authorities(&ldquo;ADMIN&rdquo;, &ldquo;USER&rdquo;) 就是给用户授权的</p>
<h4 id="122-角色权限控制">1.2.2 角色权限控制</h4>
<p>在每个微服务中，需要获取用户的角色，然后根据角色识别是否允许操作指定的方法，Spring Security中定义了四个支持权限控制的表达式注解，分别是<code>@PreAuthorize</code>、<code>@PostAuthorize</code>、<code>@PreFilter</code>和<code>@PostFilter</code>。其中前两者可以用来在方法调用前或者调用后进行权限检查，后两者可以用来对集合类型的参数或者返回值进行过滤。在需要控制权限的方法上，我们可以添加<code>@PreAuthorize</code>注解，用于方法执行前进行权限检查，校验用户当前角色是否能访问该方法。</p>
<p>(1)开启@PreAuthorize</p>
<p>在<code>dongyimai-user-service</code>的<code>ResourceServerConfig</code>类上添加<code>@EnableGlobalMethodSecurity</code>注解，用于开启@PreAuthorize的支持，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170354561.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span></code></pre></div><p>(2)方法权限控制</p>
<p>在<code>dongyimaig-user-service</code>微服务的<code>com.offcn.user.controller.UserController</code>类的findById方法上添加权限控制注解<code>@PreAuthorize</code>，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170400694.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;hasAnyAuthority(&#39;admin&#39;)&#34;</span><span class="o">)</span>
</span></span></code></pre></div><p>(3)测试</p>
<p>我们使用Postman测试，先重新登录创建令牌，然后将令牌数存放到头文件中访问微服务网关来调用user微服务的findById方法，效果如下：</p>
<p>地址：<code>http://localhost:8001/api/user/1</code>提交方式：GET
<img src="/posts/project-0/20220528170121/image-20220528170406596.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>发现上面无法访问，因为用户登录的时候，角色不包含admin角色，而delete方法需要admin角色，所以被拦截了。</p>
<p>我们再测试其他方法，其他方法没有配置拦截，所以用户登录后就会放行。</p>
<p>访问<code>http://localhost:8001/api/user</code></p>
<p>效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170412152.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>知识点说明：</p>
<p>如果希望一个方法能被多个角色访问，配置:<code>@PreAuthorize(&quot;hasAnyAuthority('admin','user')&quot;)</code></p>
<p>如果希望一个类都能被多个角色访问，在类上配置:<code>@PreAuthorize(&quot;hasAnyAuthority('admin','user')&quot;)</code></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170419505.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>再次执行查询方法
<img src="/posts/project-0/20220528170121/image-20220528170424162.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="3-oauth动态加载数据">3 OAuth动态加载数据</h2>
<p>前面OAuth我们用的数据都是静态的，在现实工作中，数据都是从数据库加载的，所以我们需要调整一下OAuth服务，从数据库加载相关数据。</p>
<ul>
<li>客户端数据[生成令牌相关数据]</li>
<li>用户登录账号密码从数据库加载
<img src="/posts/project-0/20220528170121/image-20220528170431588.png"
    
    
    
    loading="lazy"
    
    
></li>
</ul>
<h3 id="31-客户端数据加载">3.1 客户端数据加载</h3>
<h4 id="311-数据介绍">3.1.1 数据介绍</h4>
<p>(1)客户端静态数据</p>
<p>在<code>dongyimai-user-oauth</code>的com.offcn.oauth.config.AuthorizationServerConfig类中配置了客户端静态数据，主要用于配置客户端数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//客户端账号配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//在内存中创建账号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">clients</span><span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// admin，授权码认证、密码认证、客户端认证、简单认证、刷新token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span> <span class="c1">//账号名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">))</span><span class="c1">//密码，要设置加密
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">resourceIds</span><span class="o">(</span><span class="s">&#34;dongyimai-user&#34;</span><span class="o">,</span> <span class="s">&#34;dongyimai-goods&#34;</span><span class="o">)</span><span class="c1">//资源编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="s">&#34;server&#34;</span><span class="o">,</span><span class="s">&#34;app&#34;</span><span class="o">)</span><span class="c1">//作用范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">authorizedGrantTypes</span><span class="o">(</span><span class="s">&#34;authorization_code&#34;</span><span class="o">,</span> <span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="s">&#34;refresh_token&#34;</span><span class="o">,</span> <span class="s">&#34;client_credentials&#34;</span><span class="o">,</span><span class="s">&#34;implicit&#34;</span><span class="o">)</span><span class="c1">//登录授权模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">redirectUris</span><span class="o">(</span><span class="s">&#34;http://localhost&#34;</span><span class="o">);</span><span class="c1">//登录成功跳转地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(2)客户端表结构介绍</p>
<p>在数据库中创建一张表oauth_client_details，表主要用于记录客户端相关信息，表结构如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">oauth_client_details</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">client_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;客户端ID，主要用于标识对应的应用&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">resource_ids</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">client_secret</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;客户端秘钥，BCryptPasswordEncoder加密算法加密&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">scope</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;对应的范围&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">authorized_grant_types</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;认证模式&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">web_server_redirect_uri</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;认证后重定向地址&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">authorities</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">access_token_validity</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;令牌有效期&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">refresh_token_validity</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;令牌刷新周期&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">additional_information</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">autoapprove</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">client_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>字段说明：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">client_id：客户端id</span> 
</span></span><span class="line"><span class="cl"><span class="na">resource_ids：资源id（暂时不用）</span> 
</span></span><span class="line"><span class="cl"><span class="na">client_secret：客户端秘钥</span> 
</span></span><span class="line"><span class="cl"><span class="na">scope：范围</span> 
</span></span><span class="line"><span class="cl"><span class="na">access_token_validity：访问token的有效期（秒）</span> 
</span></span><span class="line"><span class="cl"><span class="na">refresh_token_validity：刷新token的有效期（秒）</span> 
</span></span><span class="line"><span class="cl"><span class="na">authorized_grant_type：授权类型</span><span class="o">:</span><span class="s">authorization_code,password,refresh_token,client_credentials    </span>
</span></span></code></pre></div><p>导入2条记录到表中，SQL如下：数据中密文为123</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">oauth_client_details</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;dongyimai&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$2a$10$8DclUiu2LEG99cTGXdpzVOwoqbJY.IZ7qXClQ.uOM8Gq9fDx/eXhO&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;app&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;authorization_code,password,refresh_token,client_credentials&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;http://localhost&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;432000000&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;432000000&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">oauth_client_details</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;ujiuye&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$2a$10$8DclUiu2LEG99cTGXdpzVOwoqbJY.IZ7qXClQ.uOM8Gq9fDx/eXhO&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;app&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;authorization_code,password,refresh_token,client_credentials&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;http://localhost&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;432000000&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;432000000&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>上述表结构属于SpringSecurity Oauth2.0所需的一个认证表结构，不能随意更改。相关操作在其他类中有所体现，如：<code>org.springframework.security.oauth2.provider.client.JdbcClientDetailsService</code>中的片段代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170441200.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="312-加载数据改造">3.1.2 加载数据改造</h4>
<p>（1）、引入依赖库</p>
<p>修改pom.xml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">&lt;dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">&lt;groupId&gt;mysql&lt;/groupId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">&lt;dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">&lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span></span></span></code></pre></div><p>（2）、修改连接配置</p>
<p>从数据库加载数据，我们需要先配置数据库连接，在dongyimai-user-oauth的application.yml中配置连接信息，如下代码：
<img src="/posts/project-0/20220528170121/image-20220528170447230.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">spring</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">application</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">name</span><span class="o">:</span> <span class="s">oauth2</span>
</span></span><span class="line"><span class="cl">  <span class="na">datasource</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">url</span><span class="o">:</span> <span class="s">jdbc:mysql://localhost:3306/dongyimaidb</span>
</span></span><span class="line"><span class="cl">    <span class="na">username</span><span class="o">:</span> <span class="s">root</span>
</span></span><span class="line"><span class="cl">    <span class="na">password</span><span class="o">:</span> <span class="s">root</span>
</span></span><span class="line"><span class="cl">    <span class="na">driver-class-name</span><span class="o">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
</span></span></code></pre></div><p>(3)修改客户端加载源</p>
<p>修改dongyimai-user-oauth的com.offcn.oauth.config.AuthorizationServerConfig类的configure方法，将之前静态的客户端数据变成从数据库加载，修改如下：</p>
<p><strong>修改前：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170452866.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>修改后：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170459475.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170504888.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意如果：表中的密码不清楚可以创建一个测试类生成一段密码拷贝进入表中替换掉原有的密码即可。</p>
<p>在项目的test目录下，编写测试类TestBCryptDemo:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.oauth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBCryptDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">password</span><span class="o">=</span><span class="s">&#34;dongyimai&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="n">password</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)测试</p>
<p><strong>授权码模式测试</strong></p>
<p>访问：<code>http://localhost:9100/oauth/authorize?client_id=dongyimai&amp;response_type=code&amp;scope=app&amp;redirect_uri=http://localhost</code></p>
<p>效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170511206.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户名对应应用id，密码对应秘钥。账号输入：<code>dongyimai</code>  密码：<code>dongyimai</code></p>
<p>当然此时从数据中取出数据，注意：如果采用授权码模式，客户端账号密码和用户登录账号密码必须一致。</p>
<p><strong>自定义账号密码模式授权测试</strong></p>
<p>我们之前编写的账号密码登录代码如下，每次都会加载指定的客户端ID和指定的秘钥，所以此时的客户端ID和秘钥固定了，输入的账号密码不再是客户端ID和秘钥了。
<img src="/posts/project-0/20220528170121/image-20220528170515642.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>如果客户端账号密码发生变化，对应的修改配置文件中的配置，和数据表oauth_client_details中的账号密码一致</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">auth:
</span></span><span class="line"><span class="cl">  ttl: 3600  #token存储过期时间
</span></span><span class="line"><span class="cl">  clientId: dongyimai    #客户端账号
</span></span><span class="line"><span class="cl">  clientSecret: 123      #客户端密码
</span></span><span class="line"><span class="cl">  cookieDomain: localhost
</span></span><span class="line"><span class="cl">  cookieMaxAge: -1
</span></span></code></pre></div><h3 id="32-用户数据加载">3.2 用户数据加载</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170553193.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>因为我们目前整套系统是对内提供登录访问，所以每次用户登录的时候oauth需要调用用户微服务查询用户信息，如上图：</p>
<p>我们需要在用户微服务中提供用户信息查询的方法，并在oauth中使用feign调用即可。</p>
<p>在真实工作中，用户和管理员对应的oauth认证服务器会分开，网关也会分开，我们今天的课堂案例只实现用户相关的认证即可。</p>
<p>(1)、实现自定义认证类</p>
<p>编写自定义认证类，com.offcn.oauth.auth.UserDetailsServiceImpl该类实现了加载用户相关信息进行授权和认证，如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//根据用户名查询用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">pwd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;dongyimai&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//创建角色
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">permissions</span><span class="o">=</span><span class="s">&#34;salesman,accountant,user&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建用户对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">User</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">pwd</span><span class="o">,</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="n">permissions</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>上述代码给登录用户定义了三个角色，分别为<code>salesman</code>,<code>accountant</code>,<code>user</code>，这一块我们目前使用的是硬编码方式将角色写死了，后面会从数据库加载。</p>
<p>密码也统一写死成了:dongyimai</p>
<p>修改配置类WebSecurityConfig</p>
<p>注释原来写死账号密码的如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/* //声明自定义认证对象
</span></span></span><span class="line"><span class="cl"><span class="cm">    @Bean(name = &#34;userDetailsService&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cm">    @Override
</span></span></span><span class="line"><span class="cl"><span class="cm">    public UserDetailsService userDetailsServiceBean() throws Exception {
</span></span></span><span class="line"><span class="cl"><span class="cm">        return this.CreateUserDetailsService();
</span></span></span><span class="line"><span class="cl"><span class="cm">    }
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    @Override
</span></span></span><span class="line"><span class="cl"><span class="cm">    protected UserDetailsService userDetailsService() {
</span></span></span><span class="line"><span class="cl"><span class="cm">     //启用自定义认证对象进行认证
</span></span></span><span class="line"><span class="cl"><span class="cm">     return   this.CreateUserDetailsService();
</span></span></span><span class="line"><span class="cl"><span class="cm">    }
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">   //自定义认证，声明用户登录账号、密码
</span></span></span><span class="line"><span class="cl"><span class="cm">    private UserDetailsService CreateUserDetailsService(){
</span></span></span><span class="line"><span class="cl"><span class="cm">        List&lt;UserDetails&gt; users=new ArrayList&lt;&gt;();
</span></span></span><span class="line"><span class="cl"><span class="cm">        UserDetails adminUser = User.withUsername(&#34;admin&#34;).password(passwordEncoder().encode(&#34;123&#34;)).authorities(&#34;ADMIN&#34;, &#34;USER&#34;).build();
</span></span></span><span class="line"><span class="cl"><span class="cm">        UserDetails OneUser = User.withUsername(&#34;user1&#34;).password(passwordEncoder().encode(&#34;123&#34;)).authorities(&#34;ADMIN&#34;, &#34;USER&#34;).build();
</span></span></span><span class="line"><span class="cl"><span class="cm">        UserDetails TowUser = User.withUsername(&#34;user2&#34;).password(passwordEncoder().encode(&#34;456&#34;)).authorities(&#34;USER&#34;).build();
</span></span></span><span class="line"><span class="cl"><span class="cm">        users.add(adminUser);
</span></span></span><span class="line"><span class="cl"><span class="cm">        users.add(OneUser);
</span></span></span><span class="line"><span class="cl"><span class="cm">        users.add(TowUser);
</span></span></span><span class="line"><span class="cl"><span class="cm">        return new InMemoryUserDetailsManager(users);
</span></span></span><span class="line"><span class="cl"><span class="cm">    }*/</span>
</span></span></code></pre></div><p>重写获取自定义认证类方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="n">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">UserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">return</span>   <span class="n">userDetailsService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(2)修改Feign</p>
<p>修改dongyimai-user-service-api中创建com.offcn.user.feign.UserFeign，添加代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;DYM-USER&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据username查询用户信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/load/{username}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)修改UserController</p>
<p>修改dongyimai-user-service的UserController添加findByUsername方法，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170602282.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/load/{username}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">username</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//调用UserService实现根据主键查询User
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;查询成功&#34;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)放行查询用户方法</p>
<p>因为oauth需要调用查询用户信息，需要在dongyimai-user-service中放行<code>/user/load/{username}</code>方法,修改ResourceServerConfig，添加对<code>/user/load/{username}</code>的放行操作，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170609133.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(5)oauth调用查询用户信息</p>
<p>oauth引入对user-service-api的依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--依赖用户api--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-user-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>修改oauth的<code>com.offcn.oauth.UserDetailsServiceImpl</code>的<code>loadUserByUsername</code>方法，调用UserFeign查询用户信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">  <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UserFeign</span> <span class="n">userFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//调用用户微服务，根据用户名获得用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userResult</span> <span class="o">=</span> <span class="n">userFeign</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">userResult</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">userResult</span><span class="o">.</span><span class="na">getData</span><span class="o">()!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取用户密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">userResult</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getPassword</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//根据用户名查询用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//String pwd = new BCryptPasswordEncoder().encode(&#34;dongyimai&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//创建User对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//String permissions = &#34;goods_list,seckill_list&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">permissions</span> <span class="o">=</span> <span class="s">&#34;salesman,accountant,user&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">User</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">pwd</span><span class="o">,</span> <span class="n">AuthorityUtils</span><span class="o">.</span><span class="na">commaSeparatedStringToAuthorityList</span><span class="o">(</span><span class="n">permissions</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(6)feign开启</p>
<p>修改<code>com.offcn.OAuthApplication</code>开启Feign客户端功能</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;com.offcn.user.feign&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OAuthApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;restTemplate&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RestTemplate</span> <span class="nf">restTemplate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(7)、设置feign的调用超时时间修改application.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 开启Feign的熔断功能</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#总连接超时时间=（切换服务实例次数+1）*（每个实例重试次数+1）*连接超时时间 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">USER</span><span class="p">:</span><span class="w"> </span><span class="c">#服务名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#配置指定服务的负载均衡策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">NFLoadBalancerRuleClassName</span><span class="p">:</span><span class="w"> </span><span class="l">com.netflix.loadbalancer.RoundRobinRule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Ribbon的连接超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ConnectTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Ribbon的数据读取超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ReadTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 是否对所有操作都进行重试</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">OkToRetryOnAllOperations</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 切换实例的重试次数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MaxAutoRetriesNextServer</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 对当前实例的重试次数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MaxAutoRetries</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#设定Hystrix熔断超时时间 ，理论上熔断时间应该大于总连接超时时间   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">execution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">isolation</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">thread</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutInMilliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w">
</span></span></span></code></pre></div><p>(7)测试</p>
<p>我们换个数据库中的账号密码登录，分别输入zhangsan，密码使用我们前面的测试类重新生成密码拷贝进入数据库中替换原有的数据，然后测试效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170618336.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意账号密码从数据表tb_user查看：
<img src="/posts/project-0/20220528170121/image-20220528170623094.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-购物车">4 购物车</h2>
<p>购物车分为用户登录购物车和未登录购物车操作，传统的电商系统在用户登录和不登录都可以操作购物车，如果用户不登录，操作购物车可以将数据存储到Cookie或者WebSQL或者SessionStorage中，用户登录后购物车数据可以存储到Redis中，再将之前未登录加入的购物车合并到Redis中即可。</p>
<p>淘宝天猫等则采用了另外一种实现方案，用户要想将商品加入购物车，必须先登录才能操作购物车。</p>
<p>我们今天实现的购物车是天猫解决方案，即用户必须先登录才能使用购物车功能。</p>
<h3 id="41-购物车分析">4.1 购物车分析</h3>
<p>(1)需求分析</p>
<p>用户在商品详细页点击加入购物车，提交商品SKU编号和购买数量，添加到购物车。购物车展示页面如下：
<img src="/posts/project-0/20220528170121/image-20220528170629469.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)购物车实现思路
<img src="/posts/project-0/20220528170121/image-20220528170634823.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们实现的是用户登录后的购物车，用户将商品加入购物车的时候，直接将要加入购物车的详情存入到Redis即可。每次查看购物车的时候直接从Redis中获取。</p>
<p>(3)表结构分析</p>
<p>用户登录后将商品加入购物车，需要存储商品详情以及购买数量，购物车详情表如下：</p>
<p>dongyimaidb数据库中tb_order_item表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">tb_order_item</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">item_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;SKU_ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">goods_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;SPU_ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">order_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;订单id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">title</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品标题&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">price</span><span class="o">`</span><span class="w"> </span><span class="nb">decimal</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品单价&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">num</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品购买数量&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">total_fee</span><span class="o">`</span><span class="w"> </span><span class="nb">decimal</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品总金额&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">pic_path</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品图片地址&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">seller_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">BTREE</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">item_id</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">item_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">BTREE</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">order_id</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">order_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">BTREE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8_bin</span><span class="w"> </span><span class="n">ROW_FORMAT</span><span class="o">=</span><span class="k">DYNAMIC</span><span class="w">
</span></span></span></code></pre></div><p>购物车详情表其实就是订单详情表结构，只是目前临时存储数据到Redis，等用户下单后才将数据从Redis取出存入到数据库中。</p>
<h3 id="42-订单购物车微服务">4.2 订单购物车微服务</h3>
<p>我们先搭建一个订单购物车微服务工程，按照如下步骤实现即可。</p>
<p>(1)导入资源</p>
<p>搭建订单购物车微服务，工程名字dongyimai-order-service并搭建对应的api工程dongyimai-order-service-api，如下图：</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170643175.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170648667.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>同时在dongyimai-order-service中引入dongyimai-order-service-api,</p>
<p>依赖引入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-order-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在dongyimai-order-service-api中引入依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-common-db<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>将代码生成器生成好的dao和相关文件拷贝到工程中，以及生成好的Pojo拷贝到API工程中</p>
<p>dongyimai-order-service:
<img src="/posts/project-0/20220528170121/image-20220528170655849.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170709381.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)application.yml配置</p>
<p>在dongyimai-service-order的resources中添加application.yml配置文件，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">server</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">port</span><span class="o">:</span> <span class="s">9008</span>
</span></span><span class="line"><span class="cl"><span class="na">spring</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">application</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">name</span><span class="o">:</span> <span class="s">order</span>
</span></span><span class="line"><span class="cl">  <span class="na">datasource</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">driver-class-name</span><span class="o">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
</span></span><span class="line"><span class="cl">      <span class="na">url</span><span class="o">:</span> <span class="s">jdbc:mysql://localhost:3306/dongyimaidb?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8</span>
</span></span><span class="line"><span class="cl">      <span class="na">username</span><span class="o">:</span> <span class="s">root</span>
</span></span><span class="line"><span class="cl">      <span class="na">password</span><span class="o">:</span> <span class="s">root</span>
</span></span><span class="line"><span class="cl">      <span class="na">type</span><span class="o">:</span> <span class="s">com.alibaba.druid.pool.DruidDataSource</span>
</span></span><span class="line"><span class="cl">  <span class="na">redis</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">host</span><span class="o">:</span> <span class="s">192.168.188.138</span>
</span></span><span class="line"><span class="cl">    <span class="na">port</span><span class="o">:</span> <span class="s">6379</span>
</span></span><span class="line"><span class="cl">  <span class="na">main</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">allow-bean-definition-overriding</span><span class="o">:</span> <span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">eureka</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">client</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">service-url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">defaultZone</span><span class="o">:</span> <span class="s">http://localhost:8761/eureka</span>
</span></span><span class="line"><span class="cl">  <span class="na">instance</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">lease-renewal-interval-in-seconds</span><span class="o">:</span> <span class="s">5 # 每隔5秒发送一次心跳</span>
</span></span><span class="line"><span class="cl">    <span class="na">lease-expiration-duration-in-seconds</span><span class="o">:</span> <span class="s">10 # 10秒不发送就过期    </span>
</span></span><span class="line"><span class="cl"><span class="na">feign</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">hystrix</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">enabled</span><span class="o">:</span> <span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">mybatis-plus</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">configuration</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">map-underscore-to-camel-case</span><span class="o">:</span> <span class="s">true  #开启驼峰式编写规范</span>
</span></span><span class="line"><span class="cl">  <span class="na">type-aliases-package</span><span class="o">:</span> <span class="s">com.offcn.order.pojo</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 配置sql打印日志</span>
</span></span><span class="line"><span class="cl"><span class="na">logging</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">level</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">com.offcn</span><span class="o">:</span> <span class="s">debug</span>
</span></span></code></pre></div><p>(3)创建启动类</p>
<p>在dongyimai-service-order的<code>com.offcn.order</code>中创建启动类，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@MapperScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;com.offcn.order.dao&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="43-添加购物车">4.3 添加购物车</h3>
<h4 id="431-思路分析">4.3.1 思路分析</h4>
<p><img src="/posts/project-0/20220528170121/image-20220528170719500.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户添加购物车，只需要将要加入购物车的商品存入到Redis中即可。一个用户可以将多件商品加入购物车，存储到Redis中的数据可以采用Hash类型。</p>
<p>购物车数据的存储结构如下：
<img src="/posts/project-0/20220528170121/image-20220528170727473.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="432-代码实现">4.3.2 代码实现</h4>
<p>(1)在dongyimai-order-service-api下创建购物车复合实体类com.offcn.order.group.Cart.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cart</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">String</span> <span class="n">sellerId</span><span class="o">;</span><span class="c1">//商家ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">private</span> <span class="n">String</span> <span class="n">sellerName</span><span class="o">;</span><span class="c1">//商家名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItemList</span><span class="o">;</span><span class="c1">//购物车明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//getter  and setter  ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>(2)feign创建</p>
<p>下订单需要调用feign查看商品信息，我们先创建feign分别根据ID查询SKU和SPU信息，在dongyimai-sellergoods-serivce-api工程中的ItemFeign和GoodsFeign根据ID查询方法如下：</p>
<p>com.offcn.sellergoods.feign.ItemFeign</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;dym-sellergoods&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/item&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ItemFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据ID查询Item数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>com.offcn.sellergoods.feign.GoodsFeign</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;dym-sellergoods&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/goods&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GoodsFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据ID查询商品数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">GoodsEntity</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)业务层</p>
<p>业务层接口</p>
<p>在dongyimai-order-servicer微服务中创建com.offcn.order.service.CartService接口，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CartService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 添加商品到购物车
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param cartList
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param itemId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param num
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="nf">addGoodsToCartList</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span><span class="o">,</span> <span class="n">Long</span> <span class="n">itemId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">num</span> <span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 从redis中查询购物车
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="nf">findCartListFromRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 将购物车保存到redis
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param cartList
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveCartListToRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>业务层接口实现类</p>
<p>在dongyimai-service-order微服务中创建接口实现类com.offcn.order.service.impl.CartServiceImpl,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CartServiceImpl</span> <span class="kd">implements</span> <span class="n">CartService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ItemFeign</span> <span class="n">itemFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="nf">addGoodsToCartList</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span><span class="o">,</span> <span class="n">Long</span> <span class="n">itemId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//1.根据商品SKU ID查询SKU商品信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="n">itemResult</span> <span class="o">=</span> <span class="n">itemFeign</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">itemId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">itemResult</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">item</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;商品不存在&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(!</span><span class="n">item</span><span class="o">.</span><span class="na">getStatus</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;商品状态无效&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//2.获取商家ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">sellerId</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//3.根据商家ID判断购物车列表中是否存在该商家的购物车
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Cart</span> <span class="n">cart</span> <span class="o">=</span> <span class="n">searchCartBySellerId</span><span class="o">(</span><span class="n">cartList</span><span class="o">,</span><span class="n">sellerId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//4.如果购物车列表中不存在该商家的购物车
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">cart</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//4.1 新建购物车对象 ，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cart</span><span class="o">=</span><span class="k">new</span> <span class="n">Cart</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">cart</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">sellerId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cart</span><span class="o">.</span><span class="na">setSellerName</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getSeller</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="n">createOrderItem</span><span class="o">(</span><span class="n">item</span><span class="o">,</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span> <span class="n">orderItemList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">orderItemList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cart</span><span class="o">.</span><span class="na">setOrderItemList</span><span class="o">(</span><span class="n">orderItemList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//4.2将购物车对象添加到购物车列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cartList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cart</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//5.如果购物车列表中存在该商家的购物车
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 判断购物车明细列表中是否存在该商品
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="n">searchOrderItemByItemId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">(),</span><span class="n">itemId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">orderItem</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//5.1. 如果没有，新增购物车明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">orderItem</span><span class="o">=</span><span class="n">createOrderItem</span><span class="o">(</span><span class="n">item</span><span class="o">,</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//5.2. 如果有，在原购物车明细上添加数量，更改金额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">orderItem</span><span class="o">.</span><span class="na">setNum</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getNum</span><span class="o">()+</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">orderItem</span><span class="o">.</span><span class="na">setTotalFee</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getNum</span><span class="o">()*</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getPrice</span><span class="o">().</span><span class="na">doubleValue</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//如果数量操作后小于等于0，则移除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getNum</span><span class="o">()&lt;=</span><span class="mi">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span><span class="c1">//移除购物车明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//如果移除后cart的明细数量为0，则将cart移除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">().</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cartList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">cart</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cartList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 从redis中查询购物车
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="nf">findCartListFromRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;从redis中提取购物车数据.....&#34;</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">cartList</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">cartList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cartList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 将购物车保存到redis
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param cartList
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveCartListToRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;向redis存入购物车数据.....&#34;</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">cartList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据商家ID查询购物车对象
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param cartList
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param sellerId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Cart</span> <span class="nf">searchCartBySellerId</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span><span class="o">,</span> <span class="n">String</span> <span class="n">sellerId</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="n">Cart</span> <span class="n">cart</span><span class="o">:</span><span class="n">cartList</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">sellerId</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">cart</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据商品明细ID查询
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param orderItemList
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param itemId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">OrderItem</span> <span class="nf">searchOrderItemByItemId</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItemList</span> <span class="o">,</span><span class="n">Long</span> <span class="n">itemId</span> <span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span><span class="n">orderItemList</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getItemId</span><span class="o">().</span><span class="na">longValue</span><span class="o">()==</span><span class="n">itemId</span><span class="o">.</span><span class="na">longValue</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">orderItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 创建订单明细
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param item
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param num
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">OrderItem</span> <span class="nf">createOrderItem</span><span class="o">(</span><span class="n">Item</span> <span class="n">item</span><span class="o">,</span><span class="n">Integer</span> <span class="n">num</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">num</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;数量非法&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OrderItem</span> <span class="n">orderItem</span><span class="o">=</span><span class="k">new</span> <span class="n">OrderItem</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setGoodsId</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setItemId</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setNum</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setPicPath</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getImage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getPrice</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderItem</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">       <span class="n">orderItem</span><span class="o">.</span><span class="na">setTotalFee</span><span class="o">(</span><span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getPrice</span><span class="o">().</span><span class="na">doubleValue</span><span class="o">()*</span><span class="n">num</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">orderItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>添加dongyimai-order-service对dongyimai-sellergoods-serivce-api的依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-sellergoods-serivce-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)控制层</p>
<p>在dongyimai-service-order微服务中创建com.offcn.order.controller.CartController，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@CrossOrigin</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/cart&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CartController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CartService</span> <span class="n">cartService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 购物车列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/findCartList&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="nf">findCartList</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cartService</span><span class="o">.</span><span class="na">findCartListFromRedis</span><span class="o">(</span><span class="n">username</span><span class="o">);</span><span class="c1">//从redis中提取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/addGoodsToCartList&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">addGoodsToCartList</span><span class="o">(</span><span class="n">Long</span> <span class="n">itemId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">&#34;ujiuye&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="n">findCartList</span><span class="o">(</span><span class="n">username</span><span class="o">);</span><span class="c1">//获取购物车列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cartList</span> <span class="o">=</span> <span class="n">cartService</span><span class="o">.</span><span class="na">addGoodsToCartList</span><span class="o">(</span><span class="n">cartList</span><span class="o">,</span> <span class="n">itemId</span><span class="o">,</span> <span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cartService</span><span class="o">.</span><span class="na">saveCartListToRedis</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">cartList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="s">&#34;添加成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span> <span class="s">&#34;添加失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)feign配置</p>
<p>修改<code>com.offcn.OrderApplication</code>开启Feign客户端：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;com.offcn.sellergoods.feign&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@MapperScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;com.offcn.order.dao&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试添加购物车，效果如下：</p>
<p>请求地址<code>http://localhost:9008/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>
<img src="/posts/project-0/20220528170121/image-20220528170830486.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试查看购物车：<code>http://localhost:9008/cart/findCartList?username=ujiuye</code>
<img src="/posts/project-0/20220528170121/image-20220528170835317.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-用户身份识别">5 用户身份识别</h2>
<h3 id="51-购物车需求分析">5.1 购物车需求分析</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170841088.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>购物车功能已经做完了，但用户我们都是硬编码写死的。用户要想将商品加入购物车，必须得先登录授权，登录授权后再经过微服务网关，微服务网关需要过滤判断用户请求是否存在令牌，如果存在令牌，才能再次访问微服务，此时网关会通过过滤器将令牌数据再次存入到头文件中，然后访问模板渲染服务，模板渲染服务再调用订单购物车微服务，此时也需要将令牌数据存入到头文件中，将令牌数据传递给购物车订单微服务，到了购物车订单微服务的时候，此时微服务需要校验令牌数据，如果令牌正确，才能使用购物车功能，并解析令牌数据获取用户信息。</p>
<h3 id="52-微服务之间认证">5.2 微服务之间认证</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170847702.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图：因为微服务之间并没有传递头文件，所以我们可以定义一个拦截器，每次微服务调用之前都先检查下头文件，将请求的头文件中的令牌数据再放入到header中，再调用其他微服务即可。</p>
<p>(1)创建Feign拦截器</p>
<p>在dongyimai-order-service服务中创建一个com.offcn.order.config.FeignInterceptor拦截器，并将所有头文件数据再次加入到Feign请求的微服务头文件中，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeignInterceptor</span> <span class="kd">implements</span> <span class="n">RequestInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">RequestTemplate</span> <span class="n">requestTemplate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//使用RequestContextHolder工具获取request相关变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ServletRequestAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="o">(</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">attributes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//取出request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//获取所有头文件信息的key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">headerNames</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeaderNames</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">headerNames</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">while</span> <span class="o">(</span><span class="n">headerNames</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//头文件的key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">headerNames</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//头文件的value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">String</span> <span class="n">values</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//将令牌数据添加到头文件中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">requestTemplate</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(2)创建拦截器Bean</p>
<p>在dongyimai-order-service服务中启动类里创建对象实例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 创建拦截器Bean对象
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">FeignInterceptor</span> <span class="nf">feignInterceptor</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">FeignInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)我们将sellergoods工程配置上身份认证</p>
<p>修改dongyimai-order-service的pom.xml，添加oauth的依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--oauth依赖--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>将公钥拷贝到dongyimai-order-service工程的resources中
<img src="/posts/project-0/20220528170121/image-20220528170856147.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>在dongyimai-order-service工程中创建com.offcn.order.config.ResourceServerConfig,配置需要拦截的路径，这里需要拦截所有请求路径，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableResourceServer</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span><span class="c1">//激活方法上的PreAuthorize注解
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfig</span> <span class="kd">extends</span> <span class="n">ResourceServerConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PUBLIC_KEY</span> <span class="o">=</span> <span class="s">&#34;public.key&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">     <span class="c1">//读取公钥的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getPubKey</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//加载公钥文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="n">PUBLIC_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//读取输入流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//读取第1行，公钥数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">((</span><span class="n">s</span><span class="o">=</span><span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义JJwtAccessTokenConverter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 帮助程序在JWT编码的令牌值和OAuth身份验证信息之间进行转换
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">JwtAccessTokenConverter</span> <span class="nf">jwtAccessTokenConverter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">JwtAccessTokenConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtAccessTokenConverter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">converter</span><span class="o">.</span><span class="na">setVerifierKey</span><span class="o">(</span><span class="n">getPubKey</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义JwtTokenStore
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param jwtAccessTokenConverter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TokenStore</span> <span class="nf">tokenStore</span><span class="o">(</span><span class="n">JwtAccessTokenConverter</span> <span class="n">jwtAccessTokenConverter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">JwtTokenStore</span><span class="o">(</span><span class="n">jwtAccessTokenConverter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Http安全配置，对每个到达系统的http请求链接进行校验
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param http
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//所有请求必须认证通过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//下边的路径放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;/spec/**&#34;</span><span class="o">).</span> <span class="c1">//配置地址放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span>
</span></span><span class="line"><span class="cl">                <span class="n">authenticated</span><span class="o">();</span>    <span class="c1">//其他地址需要认证授权
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意：当dongyimai-order-service运行起来可能会报链接不到redis localhost:6379,此处可以再配置文件中配置一下即可 。</p>
<p>再次发送添加购物车请求测试，
<img src="/posts/project-0/20220528170121/image-20220528170905187.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们发现ServletRequestAttributes始终为空，原因是RequestContextHolder.getRequestAttributes()该方法是从ThreadLocal变量里面取得相应信息的，当hystrix断路器的隔离策略为THREAD时，是无法取得ThreadLocal中的值。</p>
<p>解决方案：开启熔断，并将hystrix隔离策略换为SEMAPHORE</p>
<p>修改dongyimai-order-service的application.yml配置文件，在application.yml中添加如下代码，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1">#hystrix 配置</span>
</span></span><span class="line"><span class="cl"><span class="na">hystrix</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">command</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">execution</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="na">isolation</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="na">thread</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="na">timeoutInMilliseconds</span><span class="o">:</span> <span class="s">10000</span>
</span></span><span class="line"><span class="cl">          <span class="na">strategy</span><span class="o">:</span> <span class="s">SEMAPHORE</span>
</span></span></code></pre></div><p>再次测试(注意要重新登陆、使用生成的令牌进行访问)</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170911280.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170915820.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(4)工具类抽取</p>
<p>微服务之间相互认证的情况非常多，我们可以把上面的拦截器抽取出去，放到dongyimai-common的config包中，其他工程需要用，直接创建一个@Bean对象即可。</p>
<h3 id="53-网关过滤">5.3 网关过滤</h3>
<p>为了不给微服务带来一些无效的请求，我们可以在网关中过滤用户请求，先看看头文件中是否有Authorization，如果没有再看看cookie中是否有Authorization，如果都通过了才允许请求到达微服务。</p>
<h3 id="54-订单对接网关oauth">5.4 订单对接网关+oauth</h3>
<p>(1)application.yml配置</p>
<p>修改微服务网关<code>dongyimai-gateway-web</code>的application.yml配置文件，添加order的路由过滤配置，配置如下：
<img src="/posts/project-0/20220528170121/image-20220528170923122.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1">#购物车微服务</span>
</span></span><span class="line"><span class="cl">      <span class="na">-</span> <span class="s">id: dongyimai_order_route</span>
</span></span><span class="line"><span class="cl">        <span class="na">uri</span><span class="o">:</span> <span class="s">lb://ORDER</span>
</span></span><span class="line"><span class="cl">        <span class="na">predicates</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="na">-</span> <span class="s">Path=/api/cart/**,/api/order/**,/api/orderItem/**</span>
</span></span><span class="line"><span class="cl">        <span class="na">filters</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="na">-</span> <span class="s">StripPrefix=1</span>
</span></span></code></pre></div><p>这里注意使用的是yml格式，所以上面代码中的空格也一并记得拷贝到application.yml文件中。</p>
<p>(2)过滤配置</p>
<p>在微服务网关<code>dongyimai-gateway-web</code>中添加<code>com.offcn.filter.URLFilter</code>过滤类，用于过滤需要用户登录的地址，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">URLFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 要放行的路径
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">noAuthorizeurls</span> <span class="o">=</span> <span class="s">&#34;/api/user/add,/api/user/login&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 判断 当前的请求的地址中是否在已有的不拦截的地址中存在,如果存在 则返回true  表示  不拦截   false表示拦截
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param uri 获取到的当前的请求的地址
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">hasAuthorize</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span><span class="o">[]</span> <span class="n">split</span> <span class="o">=</span> <span class="n">noAuthorizeurls</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">split</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">uri</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)全局过滤器修改</p>
<p>修改之前的<code>com.offcn.filter.AuthorizeFilter</code>的过滤方法，将是否需要用户登录过滤也加入其中，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170931350.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//获取请求的URI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getURI</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//判断请求路径是否是不需要验证的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">URLFilter</span><span class="o">.</span><span class="na">hasAuthorize</span><span class="o">(</span><span class="n">path</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//直接放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">return</span>   <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span></code></pre></div><p>(4)测试</p>
<p>使用Postman访问 <code>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>，效果如下：</p>
<p><strong>未登录：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170942027.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用Postman访问 <code>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>，效果如下：</p>
<p><strong>已登录：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170948295.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用Postman访问 <code>http://localhost:8001/api/cart/findCartList?username=ujiuye</code>，效果如下：</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170953025.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="55-获取用户数据">5.5 获取用户数据</h3>
<h4 id="551-数据分析">5.5.1 数据分析</h4>
<p>用户登录后，数据会封装到<code>SecurityContextHolder.getContext().getAuthentication()</code>里面，我们可以将数据从这里面取出，然后转换成<code>OAuth2AuthenticationDetails</code>,在这里面可以获取到令牌信息、令牌类型等，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170959227.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这里的tokenValue是加密之后的令牌数据，remoteAddress是用户的IP信息，tokenType是令牌类型。</p>
<p>我们可以获取令牌加密数据后，使用公钥对它进行解密，如果能解密说明语句无误，如果不能解密用户也没法执行到这一步。解密后可以从明文中获取用户信息。</p>
<h4 id="552-代码实现">5.5.2 代码实现</h4>
<p>(1)在dongyimai-common工程中引入鉴权包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--oauth依赖--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--鉴权--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jjwt<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.9.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)读取公钥</p>
<p>在dongyimai-common中创建com.offcn.utils.TokenDecode类，用于解密令牌信息，在类中读取公钥信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenDecode</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PUBLIC_KEY</span><span class="o">=</span><span class="s">&#34;public.key&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义读取公钥内容变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">publickey</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//读取公钥内容方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getPubKey</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Resource</span> <span class="n">resource</span><span class="o">=</span><span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="n">PUBLIC_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//读取第一行公钥数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="o">((</span><span class="n">publickey</span><span class="o">=</span><span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">publickey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">publickey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(2)校验解析令牌数据</p>
<p>在TokenDecode类中添加校验解析令牌数据的方法，这里用到了JwtHelper实现。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 读取令牌数据
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">dcodeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//校验Jwt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Jwt</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">JwtHelper</span><span class="o">.</span><span class="na">decodeAndVerify</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="k">new</span> <span class="n">RsaVerifier</span><span class="o">(</span><span class="n">getPubKey</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取Jwt原始内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getClaims</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">claims</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)获取令牌数据</p>
<p>在TokenDecode类中添加一个getUserInfo方法，用于从容器中获取令牌信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 获取用户信息
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getUserInfo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取授权信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">OAuth2AuthenticationDetails</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="n">OAuth2AuthenticationDetails</span><span class="o">)</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getDetails</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//令牌解码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">dcodeToken</span><span class="o">(</span><span class="n">details</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>完整代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.io.ClassPathResource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.io.Resource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.jwt.Jwt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.jwt.JwtHelper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.jwt.crypto.sign.RsaVerifier</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationDetails</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenDecode</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PUBLIC_KEY</span><span class="o">=</span><span class="s">&#34;public.key&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义读取公钥内容变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">publickey</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//读取公钥内容方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getPubKey</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Resource</span> <span class="n">resource</span><span class="o">=</span><span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="n">PUBLIC_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">InputStreamReader</span> <span class="n">inputStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="n">inputStreamReader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//读取第一行公钥数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="o">((</span><span class="n">publickey</span><span class="o">=</span><span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">publickey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">publickey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//解析令牌读取数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">decodeToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//调用公钥解析令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Jwt</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">JwtHelper</span><span class="o">.</span><span class="na">decodeAndVerify</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="k">new</span> <span class="n">RsaVerifier</span><span class="o">(</span><span class="n">getPubKey</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取原始内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getClaims</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//解析json字符串为Map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">claims</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//访问当前登录的用户信息解析令牌获取用户数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getUserInfo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取springSecurity登录信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OAuth2AuthenticationDetails</span> <span class="n">details</span><span class="o">=</span> <span class="o">(</span><span class="n">OAuth2AuthenticationDetails</span><span class="o">)</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getDetails</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//解析令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">decodeToken</span><span class="o">(</span><span class="n">details</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)dongyimai-order-service微服务的主启动类中声明TokenDecode</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TokenDecode</span> <span class="nf">getTokenDecode</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">TokenDecode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(5)order微服务的控制层获取用户数据</p>
<p>在CartController中注入TokenDecode，并调用TokenDecode的getUserInfo方法获取用户信息，代码如下：</p>
<p>注入TokenDecode：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">TokenDecode</span> <span class="n">tokenDecode</span><span class="o">;</span>
</span></span></code></pre></div><p>获取用户名：
<img src="/posts/project-0/20220528170121/image-20220528171012342.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@CrossOrigin</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/cart&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CartController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CartService</span> <span class="n">cartService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenDecode</span> <span class="n">tokenDecode</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 购物车列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/findCartList&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="nf">findCartList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">tokenDecode</span><span class="o">.</span><span class="na">getUserInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;userInfo:&#34;</span><span class="o">+</span><span class="n">userInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">username</span><span class="o">=</span><span class="n">userInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;user_name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cartService</span><span class="o">.</span><span class="na">findCartListFromRedis</span><span class="o">(</span><span class="n">username</span><span class="o">);</span><span class="c1">//从redis中提取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/addGoodsToCartList&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">addGoodsToCartList</span><span class="o">(</span><span class="n">Long</span> <span class="n">itemId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//String username = &#34;ujiuye&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">tokenDecode</span><span class="o">.</span><span class="na">getUserInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;userInfo:&#34;</span><span class="o">+</span><span class="n">userInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">username</span><span class="o">=</span><span class="n">userInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;user_name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="n">findCartList</span><span class="o">();</span><span class="c1">//获取购物车列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cartList</span> <span class="o">=</span> <span class="n">cartService</span><span class="o">.</span><span class="na">addGoodsToCartList</span><span class="o">(</span><span class="n">cartList</span><span class="o">,</span> <span class="n">itemId</span><span class="o">,</span> <span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cartService</span><span class="o">.</span><span class="na">saveCartListToRedis</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">cartList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="s">&#34;添加成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span> <span class="s">&#34;添加失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(5)测试</p>
<p>用户登录后测试</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171020396.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>经过网关转发请求添加到购物车：</p>
<p>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1324601&amp;num=1</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171025863.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看redis缓存中保存的用户数据
<img src="/posts/project-0/20220528170121/image-20220528171044967.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>经过网关，查看购物车数据:</p>
<p>http://localhost:8001/api/cart/findCartList</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171053575.png"
    
    
    
    loading="lazy"
    
    
></p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528173393/">← 秒杀高级</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/tool/_20220527215246/">Docker快速入门 →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>