<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="秒杀高级 - https://lovemjh.vercel.app/posts/project-0/20220528173393/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>秒杀高级</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            秒杀高级
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            11033 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            23 分钟</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528172837/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528170121/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#学习目标">学习目标</a></li>
        <li><a href="#1-防止秒杀重复排队">1 防止秒杀重复排队</a>
          <ul>
            <li><a href="#11-后台排队记录">1.1 后台排队记录</a></li>
          </ul>
        </li>
        <li><a href="#2-并发超卖问题解决">2 并发超卖问题解决</a>
          <ul>
            <li><a href="#21-思路分析">2.1 思路分析</a></li>
            <li><a href="#22-代码实现">2.2 代码实现</a></li>
            <li><a href="#23-超卖控制">2.3 超卖控制</a></li>
          </ul>
        </li>
        <li><a href="#3-秒杀订单支付">3 秒杀订单支付</a>
          <ul>
            <li><a href="#31-搭建支付模块">3.1 搭建支付模块</a>
              <ul>
                <li><a href="#1修改依赖配置文件pomxml">（1）、修改依赖配置文件pom.xml</a></li>
                <li><a href="#2配置文件applicationyml">（2）、配置文件application.yml</a></li>
              </ul>
            </li>
            <li><a href="#32-创建支付二维码">3.2 创建支付二维码</a>
              <ul>
                <li><a href="#321-回显订单号金额">3.2.1 回显订单号、金额</a></li>
                <li><a href="#322-创建二维码">3.2.2 创建二维码</a>
                  <ul>
                    <li><a href="#1编写支付接口定义预下单方法">（1）、编写支付接口，定义预下单方法</a></li>
                    <li><a href="#2编写接口实现类">(2)、编写接口实现类</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#33-支付流程分析">3.3 支付流程分析</a></li>
            <li><a href="#34-支付回调更新">3.4 支付回调更新</a>
              <ul>
                <li><a href="#341-支付回调队列指定">3.4.1 支付回调队列指定</a>
                  <ul>
                    <li><a href="#3411-在预下单时传递队列信息">3.4.1.1 在预下单时传递队列信息</a></li>
                    <li><a href="#3412-测试">3.4.1.2 测试</a></li>
                    <li><a href="#3413-改造支付回调方法">3.4.1.3 改造支付回调方法</a></li>
                    <li><a href="#3414-内网穿透">3.4.1.4 内网穿透</a>
                      <ul>
                        <li><a href="#1下载-cpolar">（1）、下载 cpolar</a></li>
                        <li><a href="#2安装">（2）、安装：</a></li>
                        <li><a href="#3连接您的帐户">（3）、连接您的帐户：</a></li>
                        <li><a href="#4开启端口映射">（4）、开启端口映射</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li><a href="#342-支付状态监听">3.4.2 支付状态监听</a></li>
                <li><a href="#343-修改订单状态">3.4.3 修改订单状态</a>
                  <ul>
                    <li><a href="#3431-业务层">3.4.3.1 业务层</a></li>
                    <li><a href="#3432-修改订单对接">3.4.3.2 修改订单对接</a></li>
                  </ul>
                </li>
                <li><a href="#344-删除订单回滚库存">3.4.4 删除订单回滚库存</a>
                  <ul>
                    <li><a href="#3441-业务层实现">3.4.4.1 业务层实现</a></li>
                    <li><a href="#3442-调用删除订单">3.4.4.2 调用删除订单</a></li>
                    <li><a href="#3443-测试">3.4.4.3 测试</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#4-rabbitmq延时消息队列">4 RabbitMQ延时消息队列</a>
          <ul>
            <li><a href="#41-延时队列介绍">4.1 延时队列介绍</a></li>
            <li><a href="#42-ttl-dlx实现延时队列">4.2 TTL DLX实现延时队列</a>
              <ul>
                <li><a href="#421-ttl-dlx介绍">4.2.1 TTL DLX介绍</a></li>
                <li><a href="#423-dlx延时队列实现">4.2.3 DLX延时队列实现</a>
                  <ul>
                    <li><a href="#4231-创建工程">4.2.3.1 创建工程</a></li>
                    <li><a href="#4232-队列创建">4.2.3.2 队列创建</a></li>
                    <li><a href="#4233-消息监听">4.2.3.3 消息监听</a></li>
                    <li><a href="#4234-创建启动类">4.2.3.4 创建启动类</a></li>
                    <li><a href="#4235-测试">4.2.3.5 测试</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#5-超时未完成支付自动删除订单库存回滚作业">5 超时未完成支付、自动删除订单库存回滚(作业)</a>
          <ul>
            <li><a href="#51-秒杀流程回顾">5.1 秒杀流程回顾</a></li>
            <li><a href="#52-关闭支付">5.2 关闭支付</a></li>
            <li><a href="#53-关闭订单回滚库存">5.3 关闭订单回滚库存</a>
              <ul>
                <li><a href="#531-配置延时队列">5.3.1 配置延时队列</a></li>
                <li><a href="#532-发送延时消息">5.3.2 发送延时消息</a></li>
                <li><a href="#533-feign调用支付服务关闭预下单接口">5.3.3 Feign调用支付服务关闭预下单接口</a></li>
                <li><a href="#534-库存回滚">5.3.4 库存回滚</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">第十六章</h1>
<h1 align = "center">秒杀高级</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>防止秒杀重复排队</li>
<li>并发超卖问题解决</li>
<li>订单支付</li>
<li>RabbitMQ延时队列</li>
<li>库存回滚</li>
</ul>
<h2 id="1-防止秒杀重复排队">1 防止秒杀重复排队</h2>
<p>用户每次抢单的时候，一旦排队，我们设置一个自增值，让该值的初始值为1，每次进入抢单的时候，对它进行递增，如果值&gt;1，则表明已经排队,不允许重复排队,如果重复排队，则对外抛出异常，并抛出异常信息表示已经正在排队。
<img src="/posts/project-0/20220528173393/image-20220528173531584.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="11-后台排队记录">1.1 后台排队记录</h3>
<p>修改SeckillOrderServiceImpl的add方法，新增递增值判断是否排队中，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173541835.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//递增，判断是否排队
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Long userQueueCount <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> 1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>userQueueCount<span style="color:#000;font-weight:bold">&gt;</span>1<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//100：表示有重复抢单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">REPERROR</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>首次秒杀下单：http://localhost:8001/api/seckillOrder/add?id=1&amp;time=2021061914
<img src="/posts/project-0/20220528173393/image-20220528173553210.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看redis缓存，发现已经记录了UserQueueCount
<img src="/posts/project-0/20220528173393/image-20220528173557522.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>再次重复下单：
<img src="/posts/project-0/20220528173393/image-20220528173602357.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看查看redis缓存，发现UserQueueCount记录的用户下单数量变成了2</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173606706.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="2-并发超卖问题解决">2 并发超卖问题解决</h2>
<p>超卖问题，这里是指多人抢购同一商品的时候，多人同时判断是否有库存，如果只剩一个，则都会判断有库存，此时会导致超卖现象产生，也就是一个商品下了多个订单的现象。</p>
<h3 id="21-思路分析">2.1 思路分析</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528173621573.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>解决超卖问题，可以利用Redis队列实现，给每件商品创建一个独立的商品个数队列，例如：A商品有2个，A商品的ID为1001，则可以创建一个队列,key=SeckillGoodsCountList_1001,往该队列中塞2次该商品ID。</p>
<p>每次给用户下单的时候，先从队列中取数据，如果能取到数据，则表明有库存，如果取不到，则表明没有库存，这样就可以防止超卖问题产生了。</p>
<p>在我们对Redis进行操作的时候，很多时候，都是先将数据查询出来，在内存中修改，然后存入到Redis，在并发场景，会出现数据错乱问题，为了控制数量准确，我们单独将商品数量整一个自增键，<strong>自增键</strong>是线程安全的，所以不担心并发场景的问题。
<img src="/posts/project-0/20220528173393/image-20220528173625837.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="22-代码实现">2.2 代码实现</h3>
<p>每次将商品压入Redis缓存的时候，另外多创建一个商品的队列。</p>
<p>修改SeckillGoodsPushTask,添加一个pushIds方法，用于将指定商品ID放入到指定的数字中，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 将商品ID存入到数组中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param len:长度
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param id :值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Long<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">pushIds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> len<span style="color:#000;font-weight:bold">,</span>Long id<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    Long<span style="color:#000;font-weight:bold">[]</span> ids <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Long<span style="color:#000;font-weight:bold">[</span>len<span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span>ids<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        ids<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]=</span>id<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> ids<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改SeckillGoodsPushTask的loadGoodsPushRedis方法，添加队列操作，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173634081.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//商品数据队列存储,防止高并发超卖
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Long<span style="color:#000;font-weight:bold">[]</span> ids <span style="color:#000;font-weight:bold">=</span> pushIds<span style="color:#000;font-weight:bold">(</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStockCount</span><span style="color:#000;font-weight:bold">(),</span> seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCountList_&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">leftPushAll</span><span style="color:#000;font-weight:bold">(</span>ids<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//创建一个计数器记录各个商品的库存数量
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">(),</span>seckillGood<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStockCount</span><span style="color:#000;font-weight:bold">());</span>
</span></span></code></pre></div><p>测试：</p>
<p>重启服务，发现定时任务执行后，在redis缓存已经记录了数据id的队列SeckillGoodsCountList_1、SeckillGoodsCountList_2等等</p>
<p>并且也记录了每个商品的库存数量SeckillGoodsCoun
<img src="/posts/project-0/20220528173393/image-20220528173639758.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528173393/image-20220528173646339.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528173393/image-20220528173652235.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="23-超卖控制">2.3 超卖控制</h3>
<p>修改多线程下单方法，分别修改数量控制，以及售罄后用户抢单排队信息的清理，修改代码如下图：
<img src="/posts/project-0/20220528173393/image-20220528173657463.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 多线程下单操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Async</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">createOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//从队列中获取排队信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillStatus seckillStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillStatus<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrderQueue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">rightPop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//从队列中获取一个商品
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Object sgood <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCountList_&#34;</span> <span style="color:#000;font-weight:bold">+</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">rightPop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>sgood<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//清理当前用户的排队信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            clearQueue<span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//时间区间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String time <span style="color:#000;font-weight:bold">=</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTime</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//用户登录名
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String username<span style="color:#000;font-weight:bold">=</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//用户抢购商品
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Long id <span style="color:#000;font-weight:bold">=</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取商品数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillGoods goods <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillGoods<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span> <span style="color:#000;font-weight:bold">+</span> time<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//如果有库存，则创建秒杀商品订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SeckillOrder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setId</span><span style="color:#000;font-weight:bold">(</span>idWorker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nextId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSeckillId</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCostPrice</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUserId</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCreateTime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;0&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//将秒杀订单存入到Redis中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>seckillOrder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//商品库存-1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Long surplusCount <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//商品数量递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStockCount</span><span style="color:#000;font-weight:bold">(</span>surplusCount<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">intValue</span><span style="color:#000;font-weight:bold">());</span>    <span style="color:#998;font-style:italic">//根据计数器统计
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//判断当前商品是否还有库存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>surplusCount<span style="color:#000;font-weight:bold">&lt;=</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//并且将商品数据同步到MySQL中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            seckillGoodsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateById</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//如果没有库存,则清空Redis缓存中该商品
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span> <span style="color:#000;font-weight:bold">+</span> time<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//如果有库存，则直数据重置到Reids中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span> <span style="color:#000;font-weight:bold">+</span> time<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//抢单成功，更新抢单状态,排队-&gt;等待支付
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatus</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setOrderId</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMoney</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">floatValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 清理用户排队信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param seckillStatus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">clearQueue</span><span style="color:#000;font-weight:bold">(</span>SeckillStatus seckillStatus<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//清理排队标示
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//清理抢单标示
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试：正常秒杀下单</p>
<p>http://localhost:8001/api/seckillOrder/add?id=1&amp;time=2021061914</p>
<p>查看redis中的SeckillGoodsCount发现对应编号的商品减去了库存数量。</p>
<h2 id="3-秒杀订单支付">3 秒杀订单支付</h2>
<p><img src="/posts/project-0/20220528173393/image-20220528173707704.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>完成秒杀下订单后，进入支付页面，此时前端会每3秒中向后台发送一次请求用于判断当前用户订单是否完成支付，如果完成了支付，则需要清理掉排队信息，并且需要修改订单状态信息。</p>
<h3 id="31-搭建支付模块">3.1 搭建支付模块</h3>
<p>创建模块dongyimai-payseckill-service</p>
<h4 id="1修改依赖配置文件pomxml">（1）、修改依赖配置文件pom.xml</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-service<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-payseckill-service<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!-- 支付宝支付所需类库包 --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alipay.sdk<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>alipay-sdk-java<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>4.11.54.ALL<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000080">&lt;groupId&gt;</span>org.bouncycastle<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000080">&lt;artifactId&gt;</span>bcprov-jdk15on<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-common<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fastjson<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.2.72<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><h4 id="2配置文件applicationyml">（2）、配置文件application.yml</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9006</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>pay<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">rabbitmq</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">host</span>:<span style="color:#bbb"> </span><span style="color:#099">192.168.188.128</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#mq的服务器地址</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">username</span>:<span style="color:#bbb"> </span>guest<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#账号</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">password</span>:<span style="color:#bbb"> </span>guest<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#密码</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">alipay</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">serverUrl</span>:<span style="color:#bbb"> </span>https://openapi.alipaydev.com/gateway.do<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">notify-url</span>:<span style="color:#bbb"> </span>http://7r8ukqlrpt.52http.com/pay/notify/url<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">appId</span>:<span style="color:#bbb"> </span><span style="color:#099">2016091300500103</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">privateKey</span>:<span style="color:#bbb"> </span>用户私钥<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">alipayPublicKey</span>:<span style="color:#bbb"> </span>阿里公钥<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">format</span>:<span style="color:#bbb"> </span>json<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">charset</span>:<span style="color:#bbb"> </span>utf-8<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">signType</span>:<span style="color:#bbb"> </span>RSA2<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="32-创建支付二维码">3.2 创建支付二维码</h3>
<p>下单成功后，会跳转到支付选择页面，在支付选择页面要显示订单编号和订单金额，所以我们需要在下单的时候，将订单金额以及订单编号信息存储到用户查询对象中。</p>
<p>选择扫码支付后，会跳转到扫码支付页面，支付页面会根据用户名查看用户秒杀订单，并根据用户秒杀订单的ID创建预支付信息并获取二维码信息，展示给用户看,此时页面每3秒查询一次支付状态，如果支付成功，需要修改订单状态信息。</p>
<h4 id="321-回显订单号金额">3.2.1 回显订单号、金额</h4>
<p>下单后，进入支付选择页面，需要显示订单号和订单金额，所以需要在用户下单后将该数据传入到pay.html页面，所以查询订单状态的时候，需要将订单号和金额封装到查询的信息中，修改查询订单装的方法加入他们即可。</p>
<p>修改SeckillOrderController的queryStatus方法，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173716301.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatus</span><span style="color:#000;font-weight:bold">(),</span><span style="color:#d14">&#34;抢购状态&#34;</span><span style="color:#000;font-weight:bold">,</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>使用Postman测试，效果如下：</p>
<p>http://localhost:8001/api/seckillOrder/query</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173722094.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>订单编号为Long型，转换为json字符串出现精度损失</p>
<p>处理方法：在订单状态实体类，订单编号属性值上增加注解，把Long按照字符串进行序列化</p>
<pre tabindex="0"><code>//订单号

    @JsonSerialize(using = ToStringSerializer.class)
    private Long orderId;
</code></pre><h4 id="322-创建二维码">3.2.2 创建二维码</h4>
<p>用户创建二维码，可以先查询用户的秒杀订单抢单信息，然后再发送请求到支付微服务中创建二维码，将订单编号以及订单对应的金额传递到支付微服务:<code>/pay/create/native</code>。</p>
<p>修改支付模块dongyimai-payseckill-service</p>
<h5 id="1编写支付接口定义预下单方法">（1）、编写支付接口，定义预下单方法</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">PayService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 生成二维码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param out_trade_no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param total_fee
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="2编写接口实现类">(2)、编写接口实现类</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.AlipayApiException</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.DefaultAlipayClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.request.AlipayTradePrecreateRequest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.request.AlipayTradeQueryRequest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.response.AlipayTradePrecreateResponse</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alipay.api.response.AlipayTradeQueryResponse</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pay.service.PayService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PayServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> PayService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 支付宝gatewayUrl
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.serverUrl}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String serverUrl<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 商户应用id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.appId}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String appId<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * RSA私钥，用于对商户请求报文加签
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.privateKey}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String privateKey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 支付宝RSA公钥，用于验签支付宝应答
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.alipayPublicKey}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String alipayPublicKey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 签名类型
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.signType}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String signType <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;RSA2&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 格式
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.format}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String formate <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;json&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 编码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.charset}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String charset <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;UTF-8&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 异步地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;${alipay.notify-url}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String notifyUrl<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建阿里支付客户端请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DefaultAlipayClient alipayClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultAlipayClient<span style="color:#000;font-weight:bold">(</span>serverUrl<span style="color:#000;font-weight:bold">,</span> appId<span style="color:#000;font-weight:bold">,</span> privateKey<span style="color:#000;font-weight:bold">,</span> formate<span style="color:#000;font-weight:bold">,</span> charset<span style="color:#000;font-weight:bold">,</span> alipayPublicKey<span style="color:#000;font-weight:bold">,</span> signType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建预下单请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        AlipayTradePrecreateRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AlipayTradePrecreateRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//设置回调地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNotifyUrl</span><span style="color:#000;font-weight:bold">(</span>notifyUrl<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//设置预下单请求参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBizContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;{&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>              
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;subject\&#34;:\&#34;测试购买商品001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//设置业务参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//发出预下单业务请求
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            AlipayTradePrecreateResponse response <span style="color:#000;font-weight:bold">=</span> alipayClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//从相应对象读取相应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String code <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;响应码:&#34;</span><span style="color:#000;font-weight:bold">+</span>code<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//全部的响应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String body <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;返回结果:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>code<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">,</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee:&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;预下单接口调用失败:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>AlipayApiException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>（3）、编写controller控制器代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.StatusCode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pay.service.PayService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RestController</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">javax.servlet.ServletInputStream</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">javax.servlet.http.HttpServletRequest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.ByteArrayOutputStream</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Enumeration</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;pay&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PayController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> PayService payService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 创建二维码连接地址返回给前端 生成二维码图片
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param parameters  包含 订单号  包含 金额  包含 queue队列名称 交换机信息 路由信息 用户名
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/create/native&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取用户名
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> payService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createNative</span><span style="color:#000;font-weight:bold">(</span>parameters<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">&lt;</span>Map<span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;二维码连接地址创建成功&#34;</span><span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>（4）、编写主启动类PaySeckillApplication</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PaySeckillApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>PaySeckillApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>使用Postman测试效果如下：</p>
<p>http://localhost:9006/pay/create/native?out_trade_no=1132510782836314121&amp;total_fee=1</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173737223.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>根据返回的qrcode,可以生成支付宝扫码的二维码：
<img src="/posts/project-0/20220528173393/image-20220528173741934.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用沙箱版支付宝扫码，即可弹出支付界面。</p>
<h3 id="33-支付流程分析">3.3 支付流程分析</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528173746704.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图，步骤分析如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.用户抢单，经过秒杀系统实现抢单，下单后会将向MQ发送一个延时队列消息，包含抢单信息，延时半小时后才能监听到
2.秒杀系统同时启用延时消息监听，一旦监听到订单抢单信息，判断Redis缓存中是否存在订单信息，如果存在，则回滚
3.秒杀系统还启动支付回调信息监听，如果支付完成，则将订单持久化到MySQL，如果没完成，清理排队信息回滚库存
4.每次秒杀下单后调用支付系统，创建二维码，如果用户支付成功了，支付宝平台会将支付信息发送给支付系统指定的回调地址，支付系统收到信息后，将信息发送给MQ，第3个步骤就可以监听到消息了。
</code></pre><h3 id="34-支付回调更新">3.4 支付回调更新</h3>
<p>支付回调这一块代码已经实现了，但之前实现的是订单信息的回调数据发送给MQ，指定了对应的队列，不过现在需要实现的是秒杀信息发送给指定队列，所以之前的代码那块需要动态指定队列。</p>
<h4 id="341-支付回调队列指定">3.4.1 支付回调队列指定</h4>
<p>关于指定队列如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.创建支付二维码需要指定队列
2.回调地址回调的时候，获取支付二维码指定的队列，将支付信息发送到指定队列中
</code></pre><p>在支付宝支付统一下单API中，有一个附加参数,如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">body:附加数据,String(127)，在查询API和支付通知中原样返回，可作为自定义参数使用。
</code></pre><p>我们可以在创建二维码的时候，指定该参数，该参数用于指定回调支付信息的对应队列，每次回调的时候，会获取该参数，然后将回调信息发送到该参数对应的队列去。</p>
<h5 id="3411-在预下单时传递队列信息">3.4.1.1 在预下单时传递队列信息</h5>
<p>修改支付微服务的PayServiceImpl的createNative方法，代码如下：</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173753655.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createNative</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> parameters<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建阿里支付客户端请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DefaultAlipayClient alipayClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultAlipayClient<span style="color:#000;font-weight:bold">(</span>serverUrl<span style="color:#000;font-weight:bold">,</span> appId<span style="color:#000;font-weight:bold">,</span> privateKey<span style="color:#000;font-weight:bold">,</span> formate<span style="color:#000;font-weight:bold">,</span> charset<span style="color:#000;font-weight:bold">,</span> alipayPublicKey<span style="color:#000;font-weight:bold">,</span> signType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建预下单请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        AlipayTradePrecreateRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AlipayTradePrecreateRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNotifyUrl</span><span style="color:#000;font-weight:bold">(</span>notifyUrl<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBizContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;{&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;body\&#34;:\&#34;queue=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;queue&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;&amp;username=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;&amp;routingkey=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;routingkey&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;&amp;exchange=&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;exchange&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">)+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;subject\&#34;:\&#34;测试购买商品001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//设置业务参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//发出预下单业务请求
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            AlipayTradePrecreateResponse response <span style="color:#000;font-weight:bold">=</span> alipayClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//从相应对象读取相应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String code <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;响应码:&#34;</span><span style="color:#000;font-weight:bold">+</span>code<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//全部的响应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String body <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;返回结果:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>code<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">,</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;qrcode:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getQrCode</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOutTradeNo</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee:&#34;</span><span style="color:#000;font-weight:bold">+</span>parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total_fee&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;预下单接口调用失败:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>AlipayApiException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们创建二维码的时候，需要将下面几个参数传递过去</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">username:用户名,可以根据用户名查询用户排队信息
out_trade_no：商户订单号，下单必须
total_fee：支付金额，支付必须
queue：队列名字，回调的时候，可以知道将支付信息发送到哪个队列
routingkey:路由的名称
exchange：交换机名称
</code></pre><p>修改主启动类PayApplication，添加对应队列以及对应交换机绑定，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span><span style="color:#000;font-weight:bold">(</span>exclude <span style="color:#000;font-weight:bold">=</span> DataSourceAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PaySeckillApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>PaySeckillApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Environment env<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//创建秒杀队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;seckillQueue&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">createSeckillQueue</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillorder&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//创建秒杀交换机
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;seckillExchanage&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">basicSeckillExchanage</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillorder&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//绑定秒杀
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;SeckillBinding&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicSeckillBinding</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span>  BindingBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>createSeckillQueue<span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>basicSeckillExchanage<span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillkey&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改application.yml，添加如下配置</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#位置支付交换机和队列
mq:
  pay:
    exchange:     
      seckillorder: exchange.seckillorder
    queue:     
      seckillorder: queue.seckillorder
    routing:     
      seckillkey: queue.seckillorder
</code></pre><h5 id="3412-测试">3.4.1.2 测试</h5>
<p>使用Postman创建二维码测试</p>
<p>http://localhost:9006/pay/create/native?username=test001&amp;out_trade_no=1132510782836314121&amp;total_fee=1&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173803950.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>以后每次支付，都需要带上对应的参数，包括前面的订单支付。</p>
<h5 id="3413-改造支付回调方法">3.4.1.3 改造支付回调方法</h5>
<p>修改PayController的notifyUrl方法，获取自定义参数，并转成Map，获取queue地址，并将支付信息发送到绑定的queue中，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//接收支付宝网关回调数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/notify/url&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">reciveResult</span><span style="color:#000;font-weight:bold">(</span>HttpServletRequest request<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//准备一个map封装全部的请求参数和值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取全部的请求参数名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Enumeration<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> parameterNames <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterNames</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>parameterNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasMoreElements</span><span style="color:#000;font-weight:bold">()){</span>
</span></span><span style="display:flex;"><span>            String paramName <span style="color:#000;font-weight:bold">=</span> parameterNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nextElement</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//封装参数名和参数值到map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>paramName<span style="color:#000;font-weight:bold">,</span>request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>paramName<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//转换map集合为json字符串
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String jsonString <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;响应结果:&#34;</span><span style="color:#000;font-weight:bold">+</span>jsonString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取body自定义参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String body <span style="color:#000;font-weight:bold">=</span> map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;body&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//body参数多个用&amp;隔开
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String<span style="color:#000;font-weight:bold">[]</span> splits <span style="color:#000;font-weight:bold">=</span> body<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&amp;&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建一个map封装body的参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> bodyMap<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String split <span style="color:#000;font-weight:bold">:</span> splits<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//继续用=号切开
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String<span style="color:#000;font-weight:bold">[]</span> parms <span style="color:#000;font-weight:bold">=</span> split<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>parms<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">],</span>parms<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        rabbitTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertAndSend</span><span style="color:#000;font-weight:bold">(</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;exchange&#34;</span><span style="color:#000;font-weight:bold">),</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;routingkey&#34;</span><span style="color:#000;font-weight:bold">),</span>jsonString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;pay-success&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>配置回调地址：application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">alipay</span>:<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">notify-url</span>:<span style="color:#bbb"> </span>http://7r8ukqlrpt.52http.com/pay/notify/url<span style="color:#bbb">
</span></span></span></code></pre></div><h5 id="3414-内网穿透">3.4.1.4 内网穿透</h5>
<p>支付异步通知需要独立ip使阿里支付成功后可以回调我们的接口，所以前提条件就是内网穿透。</p>
<p><a class="link" href="/posts/project-0/https://www.cpolar.com/"  target="_blank" rel="noopener"
    >https://www.cpolar.com/</a>
<img src="/posts/project-0/20220528173393/image-20220528173811677.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如何使用：</p>
<h6 id="1下载-cpolar">（1）、下载 cpolar</h6>
<p><a class="link" href="/posts/project-0/https://www.cpolar.com/static/downloads/releases/latest/cpolar_amd64.msi"  target="_blank" rel="noopener"
    >https://www.cpolar.com/static/downloads/releases/latest/cpolar_amd64.msi</a></p>
<h6 id="2安装">（2）、安装：</h6>
<p>在Linux或OSX上，您可以使用以下命令从终端解压缩cpolar。 在Windows上，只需双击安装</p>
<h6 id="3连接您的帐户">（3）、连接您的帐户：</h6>
<p>运行此命令会将您帐户的authtoken添加到您的cpolar.yml文件中。 这将为您提供更多功能，所有打开的隧道将在此处的仪表板中列出。</p>
<pre tabindex="0"><code>cpolar authtoken YzQxMzFiY2YtY2I1NC*****LTg2NzAtZjJkMTRmYjQ0ZDRh
</code></pre><p>具体的token值：登录网站从控制面板获取：https://dashboard.cpolar.com/auth
<img src="/posts/project-0/20220528173393/image-20220528173817734.png"
    
    
    
    loading="lazy"
    
    
></p>
<h6 id="4开启端口映射">（4）、开启端口映射</h6>
<pre tabindex="0"><code>cpolar http 80
</code></pre><p>在80端口开启映射。
<img src="/posts/project-0/20220528173393/image-20220528173824527.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试内网穿透：访问回调接口接口</p>
<p><a class="link" href="/posts/project-0/http://6ca8e8f6.cpolar.io/pay/notify/url?id=111&amp;name=wwww"  target="_blank" rel="noopener"
    >http://6ca8e8f6.cpolar.io/pay/notify/url?id=111&name=wwww</a></p>
<p>扫描支付二维码，支付宝即可回调  接口</p>
<p>控制台可以查看相关信息
<img src="/posts/project-0/20220528173393/image-20220528173829290.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="342-支付状态监听">3.4.2 支付状态监听</h4>
<p>支付状态通过回调地址发送给MQ之后，我们需要在秒杀系统中监听支付信息，如果用户已支付，则修改用户订单状态，如果支付失败，则直接删除订单，回滚库存。</p>
<p>在秒杀工程中创建com.offcn.seckill.consumer.SeckillOrderPayMessageListener,实现监听消息，代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;${mq.pay.queue.seckillorder}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillOrderPayMessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 监听消费消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">consumeMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> String message<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//将消息转换成Map对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">,</span>Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;监听到的消息:&#34;</span><span style="color:#000;font-weight:bold">+</span>resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改SeckillApplication创建对应的队列以及绑定对应交换机。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.seckill.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableScheduling</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableAsync</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>SeckillApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> IdWorker <span style="color:#900;font-weight:bold">idWorker</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> IdWorker<span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span>1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Environment env<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 创建秒杀队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;queueSeckillOrder&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">queueSeckillOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillorder&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//创建秒杀交换机
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">directExchangeOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillorder&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/****
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 队列绑定到交换机上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicBindingSeckillOrder</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> BindingBuilder
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>queueSeckillOrder<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>directExchangeOrder<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillkey&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改application.yml文件，添加如下配置：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#位置支付交换机和队列
mq:
  pay:
    exchange:     
      seckillorder: exchange.seckillorder
    queue:     
      seckillorder: queue.seckillorder
    routing:     
      seckillkey: queue.seckillorder
</code></pre><h4 id="343-修改订单状态">3.4.3 修改订单状态</h4>
<p>监听到支付信息后，根据支付信息判断，如果用户支付成功，则修改订单信息，并将订单入库，删除用户排队信息，如果用户支付失败，则删除订单信息，回滚库存，删除用户排队信息。</p>
<h5 id="3431-业务层">3.4.3.1 业务层</h5>
<p>修改SeckillOrderService，添加修改订单方法，代码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 更新订单状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param out_trade_no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param transaction_id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updatePayStatus</span><span style="color:#000;font-weight:bold">(</span>String out_trade_no<span style="color:#000;font-weight:bold">,</span> String transaction_id<span style="color:#000;font-weight:bold">,</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>修改SeckillOrderServiceImpl，添加修改订单方法实现，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 更新订单状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param out_trade_no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param transaction_id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updatePayStatus</span><span style="color:#000;font-weight:bold">(</span>String out_trade_no<span style="color:#000;font-weight:bold">,</span> String transaction_id<span style="color:#000;font-weight:bold">,</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//订单数据从Redis数据库查询出来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillOrder<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//修改状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//设置交易流水号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTransactionId</span><span style="color:#000;font-weight:bold">(</span>transaction_id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//支付时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    seckillOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPayTime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//同步到MySQL中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    seckillOrderMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">insert</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//清空Redis缓存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//清空用户排队数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//删除抢购状态信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改订单实体类的id生成方式，为外面生成
<img src="/posts/project-0/20220528173393/image-20220528173840203.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="3432-修改订单对接">3.4.3.2 修改订单对接</h5>
<p>修改扫码支付状态监听的代码，当用户支付成功后，修改订单状态，也就是调用上面的方法，代码如下：
<img src="/posts/project-0/20220528173393/image-20220528173844974.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.seckill.consumer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.service.SeckillOrderService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.messaging.handler.annotation.Payload</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Component</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;${mq.pay.queue.seckillorder}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillOrderPayMessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SeckillOrderService seckillOrderService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 监听消费消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">consumeMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> String message<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//将消息转换成Map对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;监听到的消息:&#34;</span><span style="color:#000;font-weight:bold">+</span>resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取交易状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String trade_status<span style="color:#000;font-weight:bold">=</span>    resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;trade_status&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//判断交易状态是否等于成功
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>trade_status<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>trade_status<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;TRADE_SUCCESS&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            String body<span style="color:#000;font-weight:bold">=</span>  resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;body&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> bodyMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;body&#34;</span><span style="color:#000;font-weight:bold">)!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                String<span style="color:#000;font-weight:bold">[]</span> splits <span style="color:#000;font-weight:bold">=</span> body<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&amp;&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String split <span style="color:#000;font-weight:bold">:</span> splits<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    String<span style="color:#000;font-weight:bold">[]</span> vs <span style="color:#000;font-weight:bold">=</span> split<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>vs<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">],</span> vs<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            seckillOrderService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updatePayStatus</span><span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">),</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;trade_no&#34;</span><span style="color:#000;font-weight:bold">),</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//支付失败，删除订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>使用Postman完整请求创建二维码下单测试一次。</p>
<p>商品ID：1</p>
<p>剩余库存数量：10</p>
<p>http://localhost:8001/api/seckillGoods/one?id=1&amp;time=2021061916
<img src="/posts/project-0/20220528173393/image-20220528173852410.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单：</p>
<p>http://localhost:8001/api/seckillOrder/add?time=2021061916&amp;id=1</p>
<p>下单后，Redis数据
<img src="/posts/project-0/20220528173393/image-20220528173856522.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单查询：</p>
<p>http://localhost:8001/api/seckillOrder/query
<img src="/posts/project-0/20220528173393/image-20220528173900940.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>创建二维码：</p>
<p>http://localhost:9006/pay/create/native?username=dongyimai&amp;out_trade_no=1375043168986337280&amp;total_fee=0.01&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p>注意：username 用登录的账号   out_trade_no 用下单成功的订单号</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173911454.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>扫码：</p>
<p>使用返回的预下单url生成二维码
<img src="/posts/project-0/20220528173393/image-20220528173915890.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用沙箱支付宝扫描二维码，完成支付</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173922806.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看订单状态：</p>
<p>http://localhost:9005/seckillOrder/query</p>
<h4 id="344-删除订单回滚库存">3.4.4 删除订单回滚库存</h4>
<p>如果用户支付失败，我们需要删除用户订单数据，并回滚库存。</p>
<h5 id="3441-业务层实现">3.4.4.1 业务层实现</h5>
<p>修改SeckillOrderService，创建一个关闭订单方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 关闭订单，回滚库存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">closeOrder</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>修改SeckillOrderServiceImpl，创建一个关闭订单实现方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 关闭订单，回滚库存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">closeOrder</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//将消息转换成SeckillStatus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillStatus seckillStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillStatus<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取Redis中订单信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillOrder<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//如果Redis中有订单信息，说明用户未支付
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> seckillOrder<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//删除订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//回滚库存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//1)从Redis中获取该商品
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillGoods seckillGoods <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillGoods<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTime</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2)如果Redis中没有，则从数据库中加载
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>seckillGoods<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            seckillGoods <span style="color:#000;font-weight:bold">=</span> seckillGoodsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectById</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3)数量+1  (递增数量+1，队列数量+1)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Long surplusCount <span style="color:#000;font-weight:bold">=</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">(),</span> 1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        seckillGoods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStockCount</span><span style="color:#000;font-weight:bold">(</span>surplusCount<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">intValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundListOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoodsCountList_&#34;</span> <span style="color:#000;font-weight:bold">+</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">leftPush</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4)数据同步到Redis中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillGoods_&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTime</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">(),</span>seckillGoods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//清理排队标示
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueCount&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//清理抢单标示
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;UserQueueStatus&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="3442-调用删除订单">3.4.4.2 调用删除订单</h5>
<p>修改SeckillOrderPayMessageListener，在用户支付失败后调用关闭订单方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//支付失败，关闭订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            seckillOrderService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closeOrder</span><span style="color:#000;font-weight:bold">(</span>bodyMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="3443-测试">3.4.4.3 测试</h5>
<p>使用Postman完整请求创建二维码下单测试一次。</p>
<p>商品ID：1</p>
<p>剩余库存数量：10</p>
<p>http://localhost:9005/seckillGoods/one?id=1&amp;time=2021032518
<img src="/posts/project-0/20220528173393/image-20220528173935260.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单：</p>
<p>http://localhost:9005/seckillOrder/add?time=2021032518&amp;id=1</p>
<p>下单后，Redis数据
<img src="/posts/project-0/20220528173393/image-20220528173939235.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下单查询：</p>
<p>http://localhost:9005/seckillOrder/query
<img src="/posts/project-0/20220528173393/image-20220528173944723.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>创建二维码：</p>
<p>http://localhost:9006/pay/create/native?username=test001&amp;out_trade_no=1375043168986337280&amp;total_fee=0.01&amp;queue=queue.seckillorder&amp;routingkey=queue.seckillorder&amp;exchange=exchange.seckillorder</p>
<p>秒杀抢单后，商品数量变化：</p>
<p>http://localhost:9005/seckillGoods/one?id=1&amp;time=2021032518
<img src="/posts/project-0/20220528173393/image-20220528173951303.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-rabbitmq延时消息队列">4 RabbitMQ延时消息队列</h2>
<h3 id="41-延时队列介绍">4.1 延时队列介绍</h3>
<p>延时队列即放置在该队列里面的消息是不需要立即消费的，而是等待一段时间之后取出消费。
那么，为什么需要延迟消费呢？我们来看以下的场景</p>
<p>网上商城下订单后30分钟后没有完成支付，取消订单(如：淘宝、去哪儿网)
系统创建了预约之后，需要在预约时间到达前一小时提醒被预约的双方参会
系统中的业务失败之后，需要重试
这些场景都非常常见，我们可以思考，比如第二个需求，系统创建了预约之后，需要在预约时间到达前一小时提醒被预约的双方参会。那么一天之中肯定是会有很多个预约的，时间也是不一定的，假设现在有1点 2点 3点 三个预约，如何让系统知道在当前时间等于0点 1点 2点给用户发送信息呢，是不是需要一个轮询，一直去查看所有的预约，比对当前的系统时间和预约提前一小时的时间是否相等呢？这样做非常浪费资源而且轮询的时间间隔不好控制。如果我们使用延时消息队列呢，我们在创建时把需要通知的预约放入消息中间件中，并且设置该消息的过期时间，等过期时间到达时再取出消费即可。</p>
<p>Rabbitmq实现延时队列一般而言有两种形式：
第一种方式：利用两个特性： Time To Live(TTL)、Dead Letter Exchanges（DLX）[A队列过期-&gt;转发给B队列]</p>
<p>第二种方式：利用rabbitmq中的插件x-delay-message</p>
<h3 id="42-ttl-dlx实现延时队列">4.2 TTL DLX实现延时队列</h3>
<h4 id="421-ttl-dlx介绍">4.2.1 TTL DLX介绍</h4>
<p><strong>TTL</strong>
RabbitMQ可以针对队列设置x-expires(则队列中所有的消息都有相同的过期时间)或者针对Message设置x-message-ttl(对消息进行单独设置，每条消息TTL可以不同)，来控制消息的生存时间，如果超时(两者同时设置以最先到期的时间为准)，则消息变为dead letter(死信)</p>
<p><strong>Dead Letter Exchanges（DLX）</strong>
RabbitMQ的Queue可以配置x-dead-letter-exchange和x-dead-letter-routing-key（可选）两个参数，如果队列内出现了dead letter，则按照这两个参数重新路由转发到指定的队列。
x-dead-letter-exchange：出现dead letter之后将dead letter重新发送到指定exchange</p>
<p>x-dead-letter-routing-key：出现dead letter之后将dead letter重新按照指定的routing-key发送</p>
<p><img src="/posts/project-0/20220528173393/image-20220528173959420.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="423-dlx延时队列实现">4.2.3 DLX延时队列实现</h4>
<h5 id="4231-创建工程">4.2.3.1 创建工程</h5>
<p>创建springboot_rabbitmq_delay工程，并引入相关依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai_parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>springboot_rabbitmq_delay<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--starter-web--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--加入ampq--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--测试--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>application.yml配置</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring:
  application:
    name: springboot-demo
  rabbitmq:
    host: 192.168.188.128
    port: 5672
    password: guest
    username: guest
</code></pre><h5 id="4232-队列创建">4.2.3.2 队列创建</h5>
<p>创建2个队列，用于接收消息的叫延时队列queue.message.delay，用于转发消息的队列叫queue.message，同时创建一个交换机，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">QueueConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/** 短信发送队列 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String QUEUE_MESSAGE <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;queue.message&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/** 交换机 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String DLX_EXCHANGE <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;dlx.exchange&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/** 短信发送队列 延迟缓冲（按消息） */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String QUEUE_MESSAGE_DELAY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;queue.message.delay&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 接收死信队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">messageQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//允许长期存储消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>QUEUE_MESSAGE<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 接收延时消息队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">delayMessageQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> QueueBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">durable</span><span style="color:#000;font-weight:bold">(</span>QUEUE_MESSAGE_DELAY<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-exchange&#34;</span><span style="color:#000;font-weight:bold">,</span> DLX_EXCHANGE<span style="color:#000;font-weight:bold">)</span>        <span style="color:#998;font-style:italic">// 消息超时进入死信队列，绑定死信队列交换机
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#000;font-weight:bold">,</span> QUEUE_MESSAGE<span style="color:#000;font-weight:bold">)</span>   <span style="color:#998;font-style:italic">// 绑定指定的routing-key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 创建交换机
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">directExchange</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>DLX_EXCHANGE<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 交换机与队列绑定
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param messageQueue
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param directExchange
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicBinding</span><span style="color:#000;font-weight:bold">(</span>Queue messageQueue<span style="color:#000;font-weight:bold">,</span> DirectExchange directExchange<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> BindingBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>messageQueue<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>directExchange<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>QUEUE_MESSAGE<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="4233-消息监听">4.2.3.3 消息监听</h5>
<p>创建MessageListener用于监听消息，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> QueueConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">QUEUE_MESSAGE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 监听消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param msg
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">msg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> Object msg<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        SimpleDateFormat dateFormat <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SimpleDateFormat<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;当前时间:&#34;</span><span style="color:#000;font-weight:bold">+</span>dateFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;收到信息:&#34;</span><span style="color:#000;font-weight:bold">+</span>msg<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意：@Payload 和 @Headers 注解可以分别接收消息中的 body 与 headers 信息</p>
<p>@RabbitListener 可以标注在类上面，需配合 @RabbitHandler 注解一起使用
@RabbitListener 标注在类上面表示当有收到消息的时候，就交给 @RabbitHandler 的方法处理，具体使用哪个方法处理，根据 MessageConverter 转换后的参数类型。</p>
<h5 id="4234-创建启动类">4.2.3.4 创建启动类</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableRabbit</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringRabbitMQApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>SpringRabbitMQApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="4235-测试">4.2.3.5 测试</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootTest</span><span style="color:#000;font-weight:bold">(</span>classes <span style="color:#000;font-weight:bold">=</span> SpringRabbitMQApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RunWith</span><span style="color:#000;font-weight:bold">(</span>SpringRunner<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">RabbitMQTest</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RabbitTemplate rabbitTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sendMessage</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> InterruptedException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SimpleDateFormat dateFormat <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SimpleDateFormat<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;发送当前时间:&#34;</span><span style="color:#000;font-weight:bold">+</span>dateFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> message <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        message<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertAndSend</span><span style="color:#000;font-weight:bold">(</span>QueueConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">QUEUE_MESSAGE_DELAY</span><span style="color:#000;font-weight:bold">,</span> message<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> MessagePostProcessor<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">public</span> Message <span style="color:#900;font-weight:bold">postProcessMessage</span><span style="color:#000;font-weight:bold">(</span>Message message<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> AmqpException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                message<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessageProperties</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setExpiration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> message<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">in</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">read</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中message.getMessageProperties().setExpiration(&ldquo;10000&rdquo;);设置消息超时时间,超时后，会将消息转入到另外一个队列。</p>
<p>测试效果如下：
<img src="/posts/project-0/20220528173393/image-20220528174012587.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>接收时间延迟了10秒，在死信队列收到消息
<img src="/posts/project-0/20220528173393/image-20220528174017485.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-超时未完成支付自动删除订单库存回滚作业">5 超时未完成支付、自动删除订单库存回滚(作业)</h2>
<h3 id="51-秒杀流程回顾">5.1 秒杀流程回顾</h3>
<p><img src="/posts/project-0/20220528173393/image-20220528174023470.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图，步骤分析如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.用户抢单，经过秒杀系统实现抢单，下单后会将向MQ发送一个延时队列消息，包含抢单信息，延时半小时后才能监听到
2.秒杀系统同时启用延时消息监听，一旦监听到订单抢单信息，判断Redis缓存中是否存在订单信息，如果存在，则回滚
3.秒杀系统还启动支付回调信息监听，如果支付完成，则将订单持久化到MySQL，如果没完成，清理排队信息回滚库存
4.每次秒杀下单后调用支付系统，创建二维码，如果用户支付成功了，支付宝平台会将支付信息发送给支付系统指定的回调地址，支付系统收到信息后，将信息发送给MQ，第3个步骤就可以监听到消息了。
</code></pre><p>延时队列实现订单关闭回滚库存：</p>
<pre tabindex="0"><code>1.创建一个过期队列  Queue1
2.接收消息的队列    Queue2
3.中转交换机
4.监听Queue2
	1)SeckillStatus-&gt;检查Redis中是否有订单信息
	2)如果有订单信息，调用删除订单回滚库存-&gt;[需要先关闭扫码支付]
	3)如果关闭订单时，用于已支付，修改订单状态即可
	4)如果关闭订单时，发生了别的错误，记录日志，人工处理
</code></pre><h3 id="52-关闭支付">5.2 关闭支付</h3>
<p>用户如果半个小时没有支付，我们会关闭支付订单，但在关闭之前，需要先关闭扫码支付，防止中途用户支付。</p>
<p>修改支付微服务的PayService，添加关闭支付方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 关闭支付
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param orderId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span>Long out_trade_no<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>修改PayServiceImpl，实现关闭扫码支付方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span>Long out_trade_no<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建阿里支付客户端请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DefaultAlipayClient alipayClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultAlipayClient<span style="color:#000;font-weight:bold">(</span>serverUrl<span style="color:#000;font-weight:bold">,</span> appId<span style="color:#000;font-weight:bold">,</span> privateKey<span style="color:#000;font-weight:bold">,</span> formate<span style="color:#000;font-weight:bold">,</span> charset<span style="color:#000;font-weight:bold">,</span> alipayPublicKey<span style="color:#000;font-weight:bold">,</span> signType<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//撤销交易请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        AlipayTradeCancelRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AlipayTradeCancelRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBizContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;{&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span style="color:#000;font-weight:bold">+</span>out_trade_no<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;\&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;    \&#34;trade_no\&#34;:\&#34;\&#34;}&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">//设置业务参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            AlipayTradeCancelResponse response <span style="color:#000;font-weight:bold">=</span> alipayClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            String code<span style="color:#000;font-weight:bold">=</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>code<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;返回值:&#34;</span><span style="color:#000;font-weight:bold">+</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">,</span> code<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">,</span> out_trade_no<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>AlipayApiException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>修改PayController，增加关闭服务方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//关闭支付预下单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;closepay&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span>Long out_trade_no<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> resultMap <span style="color:#000;font-weight:bold">=</span> payService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closePay</span><span style="color:#000;font-weight:bold">(</span>out_trade_no<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">)!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//成功关闭，就返回结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;订单关闭成功&#34;</span><span style="color:#000;font-weight:bold">,</span>resultMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;订单关闭失败&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;订单关闭失败&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>http://localhost:9006/pay/closepay?out_trade_no=1406451841629294592
<img src="/posts/project-0/20220528173393/image-20220528174032735.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="53-关闭订单回滚库存">5.3 关闭订单回滚库存</h3>
<h4 id="531-配置延时队列">5.3.1 配置延时队列</h4>
<p>在application.yml文件中引入队列信息配置，如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#位置支付交换机和队列
mq:
  pay:
    exchange:
      seckillorder: exchange.seckillorder
      seckillordertimer: exchange.seckillordertimer
    queue:
      seckillorder: queue.seckillorder
      seckillordertimer: queue.seckillordertimer
      seckillordertimerdelay: queue.seckillordertimerdelay
    routing:
      seckillkey: queue.seckillorder
      seckillordertimerkey: queue.seckillordertime
</code></pre><p>配置队列与交换机,在SeckillApplication中添加如下方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 到期数据队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">seckillOrderTimerQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Queue<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillordertimer&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 超时数据队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Queue <span style="color:#900;font-weight:bold">delaySeckillOrderTimerQueue</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> QueueBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">durable</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillordertimerdelay&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-exchange&#34;</span><span style="color:#000;font-weight:bold">,</span> env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillordertimer&#34;</span><span style="color:#000;font-weight:bold">))</span>        <span style="color:#998;font-style:italic">// 消息超时进入死信队列，绑定死信队列交换机
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withArgument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#000;font-weight:bold">,</span> env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillordertimerkey&#34;</span><span style="color:#000;font-weight:bold">))</span>   <span style="color:#998;font-style:italic">// 绑定指定的routing-key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//创建延时交换机
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DirectExchange <span style="color:#900;font-weight:bold">directExchangeOrderTimer</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DirectExchange<span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.exchange.seckillordertimer&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 交换机与队列绑定
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Binding <span style="color:#900;font-weight:bold">basicBindingOrderTime</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> BindingBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>seckillOrderTimerQueue<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">to</span><span style="color:#000;font-weight:bold">(</span>directExchangeOrderTimer<span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">with</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.routing.seckillordertimerkey&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="532-发送延时消息">5.3.2 发送延时消息</h4>
<p>修改MultiThreadingCreateOrder，添加如下方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 发送延时消息到RabbitMQ中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param seckillStatus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sendTimerMessage</span><span style="color:#000;font-weight:bold">(</span>SeckillStatus seckillStatus<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    rabbitTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertAndSend</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mq.pay.queue.seckillordertimerdelay&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span>Object<span style="color:#000;font-weight:bold">)</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">new</span> MessagePostProcessor<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">public</span> Message <span style="color:#900;font-weight:bold">postProcessMessage</span><span style="color:#000;font-weight:bold">(</span>Message message<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> AmqpException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            message<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessageProperties</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setExpiration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> message<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在createOrder方法中调用上面方法，如下代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//发送延时消息到MQ中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>sendTimerMessage<span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="533-feign调用支付服务关闭预下单接口">5.3.3 Feign调用支付服务关闭预下单接口</h4>
<p>在模块dongyimai-seckill-service创建feign接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.seckill.feign</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.openfeign.FeignClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.PostMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestParam</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;PAY&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">PayFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/pay/closepay&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">closePay</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;out_trade_no&#34;</span><span style="color:#000;font-weight:bold">)</span> Long out_trade_no<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意修改配置文件application.yml设置feign调用超时时间</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">feign</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">connectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">5000</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">#连接超时时间5秒</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">readTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">5000</span><span style="color:#bbb">     </span><span style="color:#998;font-style:italic">#读超时时间5秒</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#hystrix 配置</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">execution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">timeout</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#998;font-style:italic">#如果enabled设置为false，则请求超时交给ribbon控制</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">isolation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">thread</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">timeoutInMilliseconds</span>:<span style="color:#bbb"> </span><span style="color:#099">10000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">strategy</span>:<span style="color:#bbb"> </span>SEMAPHORE<span style="color:#bbb">
</span></span></span></code></pre></div><h4 id="534-库存回滚">5.3.4 库存回滚</h4>
<p>创建SeckillOrderDelayMessageListener实现监听消息，并回滚库存，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.seckill.consumer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.bean.SeckillStatus</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.feign.PayFeign</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.pojo.SeckillOrder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.seckill.service.SeckillOrderService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.data.redis.core.RedisTemplate</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.messaging.handler.annotation.Payload</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Component</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RabbitListener</span><span style="color:#000;font-weight:bold">(</span>queues <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;${mq.pay.queue.seckillordertimer}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SeckillOrderDelayMessageListener</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RedisTemplate redisTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SeckillOrderService seckillOrderService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> PayFeign payFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 读取消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 判断Redis中是否存在对应的订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 如果存在，则关闭支付，再关闭订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">consumeMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@Payload</span> String message<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//读取消息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SeckillStatus seckillStatus <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>message<span style="color:#000;font-weight:bold">,</span>SeckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取Redis中订单信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String username <span style="color:#000;font-weight:bold">=</span> seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        SeckillOrder seckillOrder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SeckillOrder<span style="color:#000;font-weight:bold">)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SeckillOrder&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//如果Redis中有订单信息，说明用户未支付
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>seckillOrder<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;准备回滚---&#34;</span><span style="color:#000;font-weight:bold">+</span>seckillStatus<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//关闭支付
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Result closeResult <span style="color:#000;font-weight:bold">=</span> payFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closePay</span><span style="color:#000;font-weight:bold">(</span>seckillStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> closeMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;)</span> closeResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>closeMap<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> closeMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;code&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//关闭订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                seckillOrderService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">closeOrder</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>http://localhost:8001/api/seckillOrder/add?time=2021062012&amp;id=1</p>
<p>测试下单，10秒内未完成支付，即可收到延时消息，回滚订单
<img src="/posts/project-0/20220528173393/image-20220528174047031.png"
    
    
    
    loading="lazy"
    
    
></p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528172837/">← 秒杀1</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528170121/">购物车解决方案  →</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
