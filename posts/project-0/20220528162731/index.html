<!DOCTYPE html>
<html><head>
  
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">

  <title>微服务网关和Jwt令牌</title>
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>
  <style>
    .highlight {
      overflow-x: auto;
    }

    pre {
      position: relative;
      padding: 30px 10px 10px 10px;
      border-width: 1px;
      border-color:#7c4242;
    }

    .post-content pre code {
      font-family: Consolas;
    }

    pre::after {
      display: block;
      content: " ";
      position: absolute;
      border-radius: 50%;
      background: #ff5f56;
      width: 12px;
      height: 12px;
      top: 0;
      left: 12px;
      margin-top: 12px;
      -webkit-box-shadow: 20px 0 #ffbd2e, 40px 0 #27c93f;
      box-shadow: 20px 0 #ffbd2e, 40px 0 #27c93f;
    }










    html,
    body {
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .page-list {
      height: 18em;
      background-color: rgba(255, 255, 255, 0);
      border-radius: 20px;
      margin-bottom: 2em;
      box-shadow: 2px 4px 6px #000;
      display: flex;
    }

    .page-img {
      float: left;
      display: block;
      width: 40%;
      height: 100%;
      border-radius: 20px 0px 0px 20px;
      background-color: yellow;
      background-image: url(https://api.ixiaowai.cn/api/api.php);
      background-repeat: no-repeat;
      background-size: 100% 100%;
      -moz-background-size: 100% 100%;
    }

    .page-mian {
      float: left;
      display: block;
      width: 60%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0);
       
      padding: 0% 2% 0% 2%;
    }

    .page-Title a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-Content a {
      text-decoration: none;
      font-size: 16px;
      color: rgb(0, 0, 0);
    }


    .ull {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.263);
      height: 50px;
      margin: 0px;
    }

    .ull a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(255, 255, 255);
    }

    .lii {
      display: inline;
      margin-right: 20px;
    }

    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }










    @media screen and (max-width: 1080px) {

       
      .navigation {
        display: none;
      }

      .page-list {
        height: 25em;
        background-color: rgba(255, 255, 255, 0);
        border-radius: 20px;
        margin-bottom: 2em;
        box-shadow: 2px 4px 6px #000;
        display: block;
      }

      .page-img {
        width: 100%;
        height: 40%;
        border-radius: 20px 20px 0px 0px;
        background-color: yellow;
        background-image: url(https://api.ixiaowai.cn/api/api.php);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        -moz-background-size: 100% 100%;
      }

      .page-mian {
        width: 100%;
        height: 60%;
        background-color: rgba(0, 0, 0, 0);
         
        padding: 0% 2% 0% 2%;
      }

    }
  </style>




  <style>
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }
  </style>
  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }

     
    .navigation {
      width: 100%;
      height: 50px;
      background-color: rgba(208, 240, 121, 0.184);
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;
    }

     
    .hide {
      top: -60px;
    }
  </style>
</head><body style="background-image:url(https://api.ixiaowai.cn/api/api.php); 
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;
    background-attachment:fixed"><input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> Home
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-book'></i> Posts
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Archive
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Categories
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> Tags
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> About
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap content"><nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> Home
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-book'></i> Posts
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Archive
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Categories
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> Tags
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> About
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-28&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-28&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            10517 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            21 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['微服务网关和Jwt令牌'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            <div class="js-toc-content">
                <h1 align = "center">第十章</h1>
<h1 align = "center">微服务网关和Jwt令牌</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>
<p>掌握微服务网关的系统搭建</p>
</li>
<li>
<p>了解什么是微服务网关以及它的作用</p>
</li>
<li>
<p>掌握系统中心微服务的搭建</p>
</li>
<li>
<p>掌握用户密码加密存储bcrypt</p>
</li>
<li>
<p>了解JWT鉴权的介绍</p>
</li>
<li>
<p>掌握JWT的鉴权的使用</p>
<p>使用Jwt令牌来存储用户登录信息，在微服务网关中识别登录信息(用户的身份)</p>
</li>
<li>
<p>掌握网关使用JWT进行校验</p>
</li>
<li>
<p>掌握网关限流</p>
</li>
</ul>
<h2 id="1-微服务网关">1 微服务网关</h2>
<h3 id="11-微服务网关的概述">1.1 微服务网关的概述</h3>
<p>不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题：</p>
<ul>
<li>客户端会多次请求不同的微服务，增加了客户端的复杂性</li>
<li>存在跨域请求，在一定场景下处理相对复杂</li>
<li>认证复杂，每个服务都需要独立认证</li>
<li>难以重构，随着项目的迭代，可能需要重新划分微服务。例如，可能将多个服务合并成一个或者将一个服务拆分成多个。如果客户端直接与微服务通信，那么重构将会很难实施</li>
<li>某些微服务可能使用了防火墙/浏览器不友好的协议，直接访问会有一定的困难</li>
</ul>
<p>以上这些问题可以借助网关解决。</p>
<p>网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过网关这一层。也就是说，API 的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由网关来做，这样既提高业务灵活性又不缺安全性，典型的架构图如图所示：
<img src="/posts/project-0/20220528162731/image-20220528164602577.png"
    
    
    
    loading="lazy"
    
    
>
优点如下：</p>
<ul>
<li>安全，只有网关系统对外进行暴露，微服务可以隐藏在内网，通过防火墙保护。</li>
<li>易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。</li>
<li>易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。</li>
<li>减少了客户端与各个微服务之间的交互次数</li>
<li>易于统一授权。</li>
</ul>
<p>总结：微服务网关就是一个系统，通过暴露该微服务网关系统，方便我们进行相关的鉴权，安全控制，日志统一处理，易于监控的相关功能。</p>
<h3 id="12-微服务网关技术">1.2 微服务网关技术</h3>
<p>实现微服务网关的技术有很多，</p>
<ul>
<li>nginx  Nginx (tengine x)是一个高性能的<a class="link" href="/posts/project-0/https://baike.baidu.com/item/HTTP"  target="_blank" rel="noopener"
    >HTTP</a>和<a class="link" href="/posts/project-0/https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/7793488"  target="_blank" rel="noopener"
    >反向代理</a>web服务器，同时也提供了IMAP/POP3/SMTP服务</li>
<li>zuul ,Zuul 是 Netflix 出品的一个基于 JVM 路由和服务端的负载均衡器。</li>
<li>spring-cloud-gateway,是spring 出品的基于spring 的网关项目，集成断路器，路径重写，性能比Zuul好。</li>
</ul>
<p>我们使用gateway这个网关技术，无缝衔接到基于spring cloud的微服务开发中来。</p>
<p>gateway官网：</p>
<p><a class="link" href="/posts/project-0/https://spring.io/projects/spring-cloud-gateway"  target="_blank" rel="noopener"
    >https://spring.io/projects/spring-cloud-gateway</a></p>
<h2 id="2-网关系统使用">2 网关系统使用</h2>
<h3 id="21-需求分析">2.1 需求分析</h3>
<p>​	由于我们开发的系统有包括前台系统和后台系统，后台的系统给管理员使用。那么也需要调用各种微服务，所以我们针对系统管理搭建一个网关系统。分析如下：
<img src="/posts/project-0/20220528162731/image-20220528164616303.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="22-搭建后台网关系统">2.2 搭建后台网关系统</h3>
<h4 id="221-搭建分析">2.2.1 搭建分析</h4>
<p>由上可知道，由于需要有多个网关，所以为了管理方便。我们新建一个项目，打包方式为pom,在里面建立各种网关系统模块即可。如图所示：
<img src="/posts/project-0/20220528162731/image-20220528164635790.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="222-工程搭建">2.2.2 工程搭建</h4>
<p>(1)引入依赖</p>
<p>修改dongyimai-gateway工程，打包方式为pom</p>
<p>pom.xml如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-parent<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;packaging&gt;</span>pom<span class="nt">&lt;/packaging&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modules&gt;</span>
</span></span><span class="line"><span class="cl">    		<span class="nt">&lt;module&gt;</span>dongyimai-gateway-web<span class="nt">&lt;/module&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/modules&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--网关依赖--&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        		<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        		<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p>在dongyimai-gateway工程中，创建 dongyimai-gateway-web工程，该网关主要用于对后台微服务进行一个调用操作，将多个微服务串联到一起。</p>
<p>pom.xml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-gateway-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;description&gt;</span>
</span></span><span class="line"><span class="cl">    	普通web请求网关
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/description&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)启动类</p>
<p>在dongyimai-gateway-web中创建一个引导类com.offcn.GatewayWebApplication，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayWebApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">   		<span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">GatewayWebApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)application.yml配置</p>
<p>在dongyimai-gateway-web的resources下创建application.yml,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gateway-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8761/eureka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><h3 id="23-跨域配置">2.3 跨域配置</h3>
<p>有时候，我们需要对所有微服务跨域请求进行处理，则可以在gateway中进行跨域支持。修改application.yml,添加如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">globalcors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cors-configurations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#39;[/**]&#39;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowCredentials</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedOrigins</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedMethods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedHeaders</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span></span></span></code></pre></div><p>最终文件如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gateway-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">globalcors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cors-configurations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#39;[/**]&#39;</span><span class="p">:</span><span class="w"> </span><span class="c">#匹配所有请求</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedOrigins</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="c">#跨域处理允许所有的域</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedMethods</span><span class="p">:</span><span class="w"> </span><span class="c">#支持的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">POST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">PUT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">DELETE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8761/eureka</span><span class="w">
</span></span></span></code></pre></div><h3 id="24-网关过滤配置">2.4 网关过滤配置</h3>
<p><img src="/posts/project-0/20220528162731/image-20220528164706189.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。路径过滤器的范围限定为特定路径。 Spring Cloud Gateway包含许多内置的GatewayFilter工厂。如上图，根据请求路径路由到不同微服务去，这块可以使用Gateway的路由过滤功能实现。</p>
<p>过滤器有20 多个实现类，包括头部过滤器、路径类过滤器、 Hystrix 过滤器和变更请求 URL 的过滤器，还有参数和状态码等其他类型的过滤器。</p>
<p>内置的过滤器工厂有22个实现类，包括头部过滤器、路径过滤器、Hystrix 过滤器、请求URL 变更过滤器，还有参数和状态码等其他类型的过滤器。根据过滤器工厂的用途来划分，可以分为以下几种：Header、Parameter、Path、Body、Status、Session、Redirect、Retry、RateLimiter和Hystrix。</p>
<h4 id="241-host-路由">2.4.1 Host 路由</h4>
<p>比如用户请求cloud.ujiuye.com的时候，可以将请求路由给http://localhost:9001服务处理，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164714373.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">      routes:
</span></span><span class="line"><span class="cl">        - id: dongyimai_goods_route
</span></span><span class="line"><span class="cl">          uri: http://localhost:9001
</span></span><span class="line"><span class="cl">          predicates:
</span></span><span class="line"><span class="cl">          - Host=cloud.ujiuye.com**
</span></span></code></pre></div><p>测试请求<code>http://cloud.ujiuye.com:8001/brand</code>,效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164721375.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：此时要想让cloud.ujiuye.com访问本地计算机，要配置<code>C:\Windows\System32\drivers\etc\hosts</code>文件,映射配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">127.0.0.1 cloud.ujiuye.com
</span></span></code></pre></div><h4 id="242-路径匹配过滤配置">2.4.2 路径匹配过滤配置</h4>
<p>我们还可以根据请求路径实现对应的路由过滤操作，例如请求中以<code>/brand/</code>路径开始的请求，都直接交给<code>http://localhost:9001</code>服务处理，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164728166.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> routes:
</span></span><span class="line"><span class="cl">		- id: dongyimai_goods_route
</span></span><span class="line"><span class="cl"> 		uri: http://localhost:9001
</span></span><span class="line"><span class="cl"> 		predicates:
</span></span><span class="line"><span class="cl">		- Path=/brand**
</span></span></code></pre></div><p>测试请求<code>http://localhost:8001/brand</code>,效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164736491.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="243-prefixpath-过滤配置">2.4.3 PrefixPath 过滤配置</h4>
<p>用户每次请求路径的时候，我们可以给真实请求加一个统一前缀，例如用户请求<code>http://localhost:8001</code>的时候我们让它请求真实地址<code>http://localhost:8001/brand</code>，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164743528.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> routes:
</span></span><span class="line"><span class="cl">		- id: dongyimai_goods_route
</span></span><span class="line"><span class="cl"> 		uri: http://localhost:9001
</span></span><span class="line"><span class="cl"> 		predicates:
</span></span><span class="line"><span class="cl">		#- Host=cloud.ujiuye.com**
</span></span><span class="line"><span class="cl">		- Path=/**
</span></span><span class="line"><span class="cl"> 		filters:
</span></span><span class="line"><span class="cl">		- PrefixPath=/brand
</span></span></code></pre></div><p>测试请求<code>http://localhost:8001/</code>效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164750557.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="244-stripprefix-过滤配置">2.4.4 StripPrefix 过滤配置</h4>
<p>很多时候也会有这么一种请求，用户请求路径是<code>/api/brand</code>,而真实路径是<code>/brand</code>，这时候我们需要去掉<code>/api</code>才是真实路径，此时可以使用StripPrefix功能来实现路径的过滤操作，如下配置：
<img src="/posts/project-0/20220528162731/image-20220528164756182.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">     routes:
</span></span><span class="line"><span class="cl">        - id: dongyimai_goods_route
</span></span><span class="line"><span class="cl">          uri: http://localhost:9001
</span></span><span class="line"><span class="cl">          predicates:
</span></span><span class="line"><span class="cl">            - Path=/api/brand**
</span></span><span class="line"><span class="cl">          filters:
</span></span><span class="line"><span class="cl">            - StripPrefix=1
</span></span></code></pre></div><p>测试请求<code>http://localhost:8001/api/brand</code>,效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164809921.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="245-loadbalancerclient-路由过滤器客户端负载均衡">2.4.5 LoadBalancerClient 路由过滤器(客户端负载均衡)</h4>
<p>上面的路由配置每次都会将请求给指定的<code>URL</code>处理，但如果在以后生产环境，并发量较大的时候，我们需要根据服务的名称判断来做负载均衡操作，可以使用<code>LoadBalancerClientFilter</code>来实现负载均衡调用。<code>LoadBalancerClientFilter</code>会作用在url以lb开头的路由，然后利用<code>loadBalancer</code>来获取服务实例，构造目标<code>requestUrl</code>，设置到<code>GATEWAY_REQUEST_URL_ATTR</code>属性中，供<code>NettyRoutingFilter</code>使用。</p>
<p>修改application.yml配置文件，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528164816766.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> routes:
</span></span><span class="line"><span class="cl">		- id: dongyimai_goods_route
</span></span><span class="line"><span class="cl">			#uri: http://localhost:9001
</span></span><span class="line"><span class="cl"> 			uri: lb://goods
</span></span><span class="line"><span class="cl"> 			predicates:
</span></span><span class="line"><span class="cl">			#- Host=cloud.ujiuye.com**
</span></span><span class="line"><span class="cl">			  - Path=/**
</span></span><span class="line"><span class="cl"> 			filters:
</span></span><span class="line"><span class="cl">			#- PrefixPath=/brand
</span></span><span class="line"><span class="cl">			  - StripPrefix=1
</span></span></code></pre></div><p>测试请求路径<code>http://localhost:8001/api/brand</code>
<img src="/posts/project-0/20220528162731/image-20220528164823400.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="25-网关限流">2.5 网关限流</h3>
<p>网关可以做很多的事情，比如，限流，当我们的系统被频繁的请求的时候，就有可能将系统压垮，所以为了解决这个问题，需要在每一个微服务中做限流操作，但是如果有了网关，那么就可以在网关系统做限流，因为所有的请求都需要先通过网关系统才能路由到微服务中。</p>
<h4 id="251-思路分析">2.5.1 思路分析</h4>
<p><img src="/posts/project-0/20220528162731/image-20220528164829610.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="252-令牌桶算法">2.5.2 令牌桶算法</h4>
<p>令牌桶算法是比较常见的限流算法之一，大概描述如下：
1）所有的请求在处理之前都需要拿到一个可用的令牌才会被处理；
2）根据限流大小，设置按照一定的速率往桶里添加令牌；
3）桶设置最大的放置令牌限制，当桶满时、新添加的令牌就被丢弃或者拒绝；
4）请求达到后首先要获取令牌桶中的令牌，拿着令牌才可以进行其他的业务逻辑，处理完业务逻辑之后，将令牌直接删除；
5）令牌桶有最低限额，当桶中的令牌达到最低限额的时候，请求处理完之后将不会删除令牌，以此保证足够的限流</p>
<p>如下图：
<img src="/posts/project-0/20220528162731/image-20220528164835622.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这个算法的实现，有很多技术，Guaua是其中之一，redis客户端也有其实现。</p>
<h4 id="253-使用令牌桶进行请求次数限流">2.5.3 使用令牌桶进行请求次数限流</h4>
<p>spring cloud gateway 默认使用redis的RateLimter限流算法来实现。所以我们要使用首先需要引入redis的依赖</p>
<p>(1)引入redis依赖</p>
<p>在dongyimai-gateway的pom.xml中引入redis的依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--redis--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis-reactive<span class="nt">&lt;/artifactId&gt;</span>  	
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)定义KeyResolver</p>
<p>在Applicatioin引导类中添加如下代码，KeyResolver用于计算某一个类型的限流的KEY也就是说，可以通过KeyResolver来指定限流的Key。</p>
<p>我们可以根据IP来限流，比如每个IP每秒钟只能请求一次，在GatewayWebApplication定义key的获取，获取客户端IP，将IP作为key，如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">* IP限流
</span></span></span><span class="line"><span class="cl"><span class="cm">*@return
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;ipKeyResolver&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">KeyResolver</span> <span class="nf">userKeyResolver</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="n">KeyResolver</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">		<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"> 		<span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//获取远程客户端IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">String</span> <span class="n">hostName</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getRemoteAddress</span><span class="o">().</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getHostAddress</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;hostName:&#34;</span><span class="o">+</span><span class="n">hostName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">hostName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">};</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3)修改application.yml中配置项，指定限制流量的配置以及REDIS的配置，如图</p>
<p>修改如下图：
<img src="/posts/project-0/20220528162731/image-20220528164842878.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>配置代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">globalcors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cors-configurations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#39;[/**]&#39;</span><span class="p">:</span><span class="w"> </span><span class="c"># 匹配所有请求</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedOrigins</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w"> </span><span class="c">#跨域处理 允许所有的域</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowedMethods</span><span class="p">:</span><span class="w"> </span><span class="c"># 支持的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">POST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">PUT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">DELETE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai_goods_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://DYM-SELLERGOODS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># - Host=cloud.ujiuye.com**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">Path=/api/album/**,/api/brand/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">RequestRateLimiter</span><span class="w"> </span><span class="c">#请求数限流 名字不能随便写 ，使用默认的facatory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key-resolver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;#{@ipKeyResolver}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">redis-rate-limiter.replenishRate</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">redis-rate-limiter.burstCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gateway-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#Redis配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.188.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8761/eureka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lease-renewal-interval-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 每隔5秒发送一次心跳</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lease-expiration-duration-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 10秒不发送就过期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ip-address</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instance-id</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.application.name}:${server.port}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>解释：</p>
<p><code>redis-rate-limiter.replenishRate</code>是您希望允许用户每秒执行多少请求，而不会丢弃任何请求。这是令牌桶填充的速率</p>
<p><code>redis-rate-limiter.burstCapacity</code>是指令牌桶的容量，允许在一秒钟内完成的最大请求数,将此值设置为零将阻止所有请求。</p>
<p>key-resolver: &ldquo;#{@ipKeyResolver}&ldquo;用于通过SPEL表达式来指定使用哪一个KeyResolver.</p>
<p>如上配置：</p>
<p>表示一秒内，允许一个请求通过，令牌桶的填充速率也是一秒钟添加一个令牌。</p>
<p>最大突发状况也只允许一秒内有一次请求，可以根据业务来调整。</p>
<h2 id="3-用户登录">3 用户登录</h2>
<p>项目中有2个重要角色，分别为管理员和用户，下面几章我们将实现购物下单和支付，用户如果没登录是没法下单和支付的，所以我们这里需要实现一个登录功能。</p>
<h3 id="31-表结构介绍">3.1 表结构介绍</h3>
<p>tb_user表结构如下：
<img src="/posts/project-0/20220528162731/image-20220528164851330.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="32-登录">3.2 登录</h3>
<p>登录的时候，需要进行密码校验，这里采用了BCryptPasswordEncoder进行加密，需要将资料中的BCrypt导入到common工程中，其中BCrypt.checkpw(&ldquo;明文&rdquo;,&ldquo;密文&rdquo;)用于对比密码是否一致。</p>
<p>修改dongyimai-service-user的com.offcn.user.service.UserService添加根据用户名查询用户方法，代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">User</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span></span></code></pre></div><p>修改服务实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">User</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userList</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findList</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">userList</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">userList</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">userList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>修改dongyimai-service-user的com.offcn.user.controller.UserController添加登录方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">*用户登录
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span><span class="n">String</span> <span class="n">password</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//查询用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 	<span class="n">User</span> <span class="n">user</span> <span class="o">=</span>  <span class="n">userService</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">BCrypt</span><span class="o">.</span><span class="na">checkpw</span><span class="o">(</span><span class="n">password</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())){</span>
</span></span><span class="line"><span class="cl"> 		<span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;登录成功！&#34;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">return</span>  <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">LOGINERROR</span><span class="o">,</span><span class="s">&#34;账号或者密码错误！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意：这里密码进行了加密，使用BCrypt.checkpw比对密码。</p>
<p><a class="link" href="/posts/project-0///%e6%a0%b9%e6%8d%ae%e7%99%bb%e5%bd%95%e7%94%a8%e6%88%b7%e5%90%8d%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af" ></a></p>
<p>使用Postman测试如下：
<img src="/posts/project-0/20220528162731/image-20220528164859911.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="34-网关关联">3.4 网关关联</h3>
<p><img src="/posts/project-0/20220528162731/image-20220528164906758.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>在我们平时工作中，并不会直接将微服务暴露出去，一般都会使用网关对接，实现对微服务的一个保护作用，如上图，当用户访问<code>/api/user/</code>的时候我们再根据用户请求调用用户微服务的指定方法。当然，除了<code>/api/user/</code>还有<code>/api/address/</code>、<code>/api/areas/</code>、<code>/api/cities/</code>、<code>/api/provinces/</code>都需要由user微服务处理，修改网关工程<code>dongyimai-gateway-web</code>的application.yml配置文件，如下代码：
<img src="/posts/project-0/20220528162731/image-20220528164912299.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl"> 	cloud:
</span></span><span class="line"><span class="cl"> 		gateway:
</span></span><span class="line"><span class="cl"> 			globalcors:
</span></span><span class="line"><span class="cl"> 				cors-configurations:
</span></span><span class="line"><span class="cl">					&#39;[/**]&#39;: #匹配所有请求
</span></span><span class="line"><span class="cl">           allowedOrigins: &#34;*&#34;#跨域处理允许所有的域
</span></span><span class="line"><span class="cl">           allowedMethods: #支持的方法
</span></span><span class="line"><span class="cl">          - GET
</span></span><span class="line"><span class="cl">          - POST
</span></span><span class="line"><span class="cl">          - PUT
</span></span><span class="line"><span class="cl">          - DELETE
</span></span><span class="line"><span class="cl"> routes:
</span></span><span class="line"><span class="cl">		- id: dongyimai_goods_route
</span></span><span class="line"><span class="cl"> 		uri: lb://DYM-SELLERGOODS
</span></span><span class="line"><span class="cl"> 		predicates:
</span></span><span class="line"><span class="cl">    #- Host=cloud.ujiuye.com**
</span></span><span class="line"><span class="cl">    - Path=/api/brand**
</span></span><span class="line"><span class="cl">    filters:
</span></span><span class="line"><span class="cl">    - StripPrefix=1
</span></span><span class="line"><span class="cl">    - name: RequestRateLimiter #请求数限流名字不能随便写，使用默认的facatory
</span></span><span class="line"><span class="cl">    		args:
</span></span><span class="line"><span class="cl">           key-resolver: &#34;#{@ipKeyResolver}&#34;
</span></span><span class="line"><span class="cl">           redis-rate-limiter.replenishRate: 1
</span></span><span class="line"><span class="cl">           redis-rate-limiter.burstCapacity: 1
</span></span><span class="line"><span class="cl">#用户微服务
</span></span><span class="line"><span class="cl">    - id: dongyimai_user_route
</span></span><span class="line"><span class="cl">    uri: lb://DYM-USER
</span></span><span class="line"><span class="cl">    predicates:
</span></span><span class="line"><span class="cl">    	- Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**
</span></span><span class="line"><span class="cl">    filters:
</span></span><span class="line"><span class="cl">    	- StripPrefix=1
</span></span><span class="line"><span class="cl"> application:
</span></span><span class="line"><span class="cl">     name: gateway-web
</span></span><span class="line"><span class="cl">#Redis配置
</span></span><span class="line"><span class="cl"> redis:
</span></span><span class="line"><span class="cl"> 		host: 192.168.188.129
</span></span><span class="line"><span class="cl"> 		port: 6379
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server:
</span></span><span class="line"><span class="cl"> 	port: 8001
</span></span><span class="line"><span class="cl">eureka:
</span></span><span class="line"><span class="cl"> 	client:
</span></span><span class="line"><span class="cl"> 		service-url:
</span></span><span class="line"><span class="cl"> 			defaultZone: http://localhost:8761/eureka
</span></span><span class="line"><span class="cl"> 	instance:
</span></span><span class="line"><span class="cl"> 		prefer-ip-address: true
</span></span><span class="line"><span class="cl">management:
</span></span><span class="line"><span class="cl"> 	endpoint:
</span></span><span class="line"><span class="cl"> 		gateway:
</span></span><span class="line"><span class="cl"> 			enabled: true
</span></span><span class="line"><span class="cl"> 	web:
</span></span><span class="line"><span class="cl"> 		exposure:
</span></span><span class="line"><span class="cl"> 			include: true
</span></span></code></pre></div><p>使用Postman访问[<code>http://localhost:8001/api/user/login](//根据登录用户名获取用户信息)?username=dongyimai&amp;password=dongyimai</code>，效果如下：
<img src="/posts/project-0/20220528162731/image-20220528164920110.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-jwt讲解">4 JWT讲解</h2>
<h3 id="41-需求分析">4.1 需求分析</h3>
<p>我们之前已经搭建过了网关，使用网关在网关系统中比较适合进行权限校验。
<img src="/posts/project-0/20220528162731/image-20220528164927029.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>那么我们可以采用JWT的方式来实现鉴权校验。</p>
<h3 id="42-什么是jwt">4.2 什么是JWT</h3>
<p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p>
<h3 id="43-jwt的构成">4.3 JWT的构成</h3>
<p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p>
<p><strong>头部（Header）</strong></p>
<p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;typ&#34;</span><span class="p">:</span><span class="s2">&#34;JWT&#34;</span><span class="p">,</span><span class="nt">&#34;alg&#34;</span><span class="p">:</span><span class="s2">&#34;HS256&#34;</span><span class="p">}</span>
</span></span></code></pre></div><p>在头部指明了签名算法是HS256算法。我们进行BASE64编码https://base64.us/，编码后的字符串如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9
</span></span></code></pre></div><blockquote>
<p>小知识：Base64是一种基于64个可打印字符来表示二进制数据的表示方法。由于2的6次方等于64，所以每6个比特为一个单元，对应某个可打印字符。三个字节有24个比特，对应于4个Base64单元，即3个字节需要用4个可打印字符来表示。JDK 中提供了非常方便的 <strong>BASE64Encoder</strong> 和 <strong>BASE64Decoder</strong>，用它们可以非常方便的完成基于 BASE64 的编码和解码</p>
</blockquote>
<p><strong>载荷（playload）</strong></p>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分</p>
<p>（1）标准中注册的声明（建议但不强制使用）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">iss: jwt签发者
</span></span><span class="line"><span class="cl">sub: jwt所面向的用户
</span></span><span class="line"><span class="cl">aud: 接收jwt的一方
</span></span><span class="line"><span class="cl">exp: jwt的过期时间，这个过期时间必须要大于签发时间
</span></span><span class="line"><span class="cl">nbf: 定义在什么时间之前，该jwt都是不可用的.
</span></span><span class="line"><span class="cl">iat: jwt的签发时间
</span></span><span class="line"><span class="cl">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。
</span></span></code></pre></div><p>（2）公共的声明</p>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</p>
<p>（3）私有的声明</p>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>这个指的就是自定义的claim。比如下面面结构举例中的admin和name都属于自定的claim。这些claim跟JWT标准规定的claim区别在于：JWT规定的claim，JWT的接收方在拿到JWT之后，都知道怎么对这些标准的claim进行验证(还不知道是否能够验证)；而private claims不会验证，除非明确告诉接收方要对这些claim进行验证以及规则才行。</p>
<p>定义一个payload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{&#34;sub&#34;:&#34;1234567890&#34;,&#34;name&#34;:&#34;John Doe&#34;,&#34;admin&#34;:true}
</span></span></code></pre></div><p>然后将其进行base64加密，得到Jwt的第二部分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9
</span></span></code></pre></div><p><strong>签证（signature）</strong></p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<blockquote>
<p>header (base64后的)</p>
<p>payload (base64后的)</p>
<p>secret</p>
</blockquote>
<p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</span></span></code></pre></div><p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</span></span></code></pre></div><p><strong>注意</strong>：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret,那就意味着客户端是可以自我签发jwt了。</p>
<h3 id="44-jjwt的介绍和使用">4.4 JJWT的介绍和使用</h3>
<p>JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p>
<p>官方文档：</p>
<p><a class="link" href="/posts/project-0/https://github.com/jwtk/jjwt"  target="_blank" rel="noopener"
    >https://github.com/jwtk/jjwt</a></p>
<h4 id="441-创建token">4.4.1 创建TOKEN</h4>
<p>(1)依赖引入</p>
<p>在dongyimai-parent项目中的pom.xml中添加依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--鉴权--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jjwt<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.9.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)创建测试</p>
<p>在dongyimai-common的/test/java下创建测试类，并设置测试方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/****
</span></span></span><span class="line"><span class="cl"><span class="cm">*创建Jwt令牌
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreateJwt</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">       	<span class="n">JwtBuilder</span> <span class="n">builder</span><span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      	<span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">&#34;888&#34;</span><span class="o">)</span><span class="c1">//设置唯一编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      	<span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="s">&#34;小白&#34;</span><span class="o">)</span><span class="c1">//设置主题可以是JSON数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      	<span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span><span class="c1">//设置签发日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      	<span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">,</span><span class="s">&#34;ujiuye&#34;</span><span class="o">);</span><span class="c1">//设置签名使用HS256算法，并设置SecretKey(字符串)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      	<span class="c1">//构建并返回一个字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">builder</span><span class="o">.</span><span class="na">compact</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>运行打印结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE2MTI3ODk0MjN9.adpNtewLbNZ-r6WUr8fyRLxFj1KF6PPP2UQq_VOxICo
</span></span></code></pre></div><p>再次运行，会发现每次运行的结果是不一样的，因为我们的载荷中包含了时间。</p>
<h4 id="442-token解析">4.4.2 TOKEN解析</h4>
<p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">*解析Jwt令牌数据
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testParseJwt</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">String</span> 			<span class="n">compactJwt</span><span class="o">=</span><span class="s">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjIyODd9.RBLpZ79USMplQyfJCZFD2muHV_KLks7M1ZsjTu6Aez4&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">setSigningKey</span><span class="o">(</span><span class="s">&#34;ujiuye&#34;</span><span class="o">).</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">parseClaimsJws</span><span class="o">(</span><span class="n">compactJwt</span><span class="o">).</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>运行打印效果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{jti=888, sub=小白, iat=1562062287}
</span></span></code></pre></div><p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token.</p>
<h4 id="443-设置过期时间">4.4.3 设置过期时间</h4>
<p>有很多时候，我们并不希望签发的token是永久生效的，所以我们可以为token添加一个过期时间。</p>
<h5 id="4431-token过期设置">4.4.3.1 token过期设置</h5>
<p><img src="/posts/project-0/20220528162731/image-20220528164946738.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>解释：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.setExpiration(date)//用于设置过期时间，参数为Date类型数据
</span></span></code></pre></div><p>运行，打印效果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q
</span></span></code></pre></div><h5 id="4432-解析token">4.4.3.2 解析TOKEN</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">*解析Jwt令牌数据
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testParseJwt</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">     <span class="n">String</span> <span class="n">compactJwt</span><span class="o">=</span><span class="s">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">     <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span>
</span></span><span class="line"><span class="cl">     <span class="n">setSigningKey</span><span class="o">(</span><span class="s">&#34;ujiuye&#34;</span><span class="o">).</span>
</span></span><span class="line"><span class="cl">     <span class="n">parseClaimsJws</span><span class="o">(</span><span class="n">compactJwt</span><span class="o">).</span>
</span></span><span class="line"><span class="cl">     <span class="n">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">     <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>打印效果：
<img src="/posts/project-0/20220528162731/image-20220528164953754.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>当前时间超过过期时间，则会报错。</p>
<p>可以设置秘钥的过期时间：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()+</span><span class="n">100000</span><span class="o">));</span><span class="c1">//设置过期时间
</span></span></span></code></pre></div><h4 id="444-自定义claims">4.4.4 自定义claims</h4>
<p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色）可以定义自定义claims。</p>
<p>创建测试类，并设置测试方法：</p>
<p>创建token:
<img src="/posts/project-0/20220528162731/image-20220528164959390.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>运行打印效果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE2MTI3OTAyOTAsImV4cCI6MTYxMjc5MDI5MCwiYWRkcmVzcyI6IuWMl-S6rOW4guacnemYs-WMuuS6lOaWueahpeWfuuWcsCIsIm5hbWUiOiLkuK3lhazkvJjlsLHkuJoifQ.VwVrb-wuxb_BCLlSn2GY_m8z2pWpdU-KdtkeAY8gp5k
</span></span></code></pre></div><p>解析TOKEN:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">*解析Jwt令牌数据
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testParseJwt</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">String</span> <span class="n">compactJwt</span><span class="o">=</span><span class="s">&#34;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE2MTI3OTA2NTAsImFkZHJlc3MiOiLljJfkuqzluILmnJ3pmLPljLrkupTmlrnmoaXln7rlnLAiLCJuYW1lIjoi5Lit5YWs5LyY5bCx5LiaIn0.zHmA-MY0wg-aDSV9xrf16_ExvxUKcwNrTCsFSjFOUuc&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">setSigningKey</span><span class="o">(</span><span class="s">&#34;ujiuye&#34;</span><span class="o">).</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">parseClaimsJws</span><span class="o">(</span><span class="n">compactJwt</span><span class="o">).</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>运行效果：
<img src="/posts/project-0/20220528162731/image-20220528165006261.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="45-鉴权处理">4.5 鉴权处理</h3>
<h4 id="451-思路分析">4.5.1 思路分析</h4>
<p><img src="/posts/project-0/20220528162731/image-20220528165012604.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.用户通过访问微服务网关调用微服务，同时携带头文件信息
</span></span><span class="line"><span class="cl">2.在微服务网关这里进行拦截，拦截后获取用户要访问的路径
</span></span><span class="line"><span class="cl">3.识别用户访问的路径是否需要登录，如果需要，识别用户的身份是否能访问该路径[这里可以基于数据库设计一套权限]
</span></span><span class="line"><span class="cl">4.如果需要权限访问，用户已经登录，则放行
</span></span><span class="line"><span class="cl">5.如果需要权限访问，且用户未登录，则提示用户需要登录
</span></span><span class="line"><span class="cl">6.用户通过网关访问用户微服务，进行登录验证
</span></span><span class="line"><span class="cl">7.验证通过后，用户微服务会颁发一个令牌给网关，网关会将用户信息封装到头文件中，并响应用户
</span></span><span class="line"><span class="cl">8.用户下次访问，携带头文件中的令牌信息即可识别是否登录
</span></span></code></pre></div><h4 id="452用户登录签发token">4.5.2用户登录签发TOKEN</h4>
<p>(1)生成令牌工具类</p>
<p>在dongyimai-common中创建类utils.JwtUtil，主要辅助生成Jwt令牌信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtUtil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//有效期为
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Long</span> <span class="n">JWT_TTL</span> <span class="o">=</span> <span class="n">3600000L</span><span class="o">;</span><span class="c1">//60 *60 *1000 一个小时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Jwt令牌信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JWT_KEY</span> <span class="o">=</span> <span class="s">&#34;ujiuye&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *生成token令牌方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">createJWT</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">subject</span><span class="o">,</span> <span class="n">Long</span> <span class="n">ttlMillis</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//指定签名算法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">SignatureAlgorithm</span> <span class="n">signatureAlgorithm</span> <span class="o">=</span> <span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//当前系统时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">long</span> <span class="n">nowMillis</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//令牌签发时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">nowMillis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//如果令牌有效期为null，则默认设置有效期1小时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">if</span><span class="o">(</span><span class="n">ttlMillis</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">     <span class="n">ttlMillis</span><span class="o">=</span><span class="n">JwtUtil</span><span class="o">.</span><span class="na">JWT_TTL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//令牌过期时间设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">long</span> <span class="n">expMillis</span> <span class="o">=</span> <span class="n">nowMillis</span> <span class="o">+</span> <span class="n">ttlMillis</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">     <span class="n">Date</span> <span class="n">expDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">expMillis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//生成秘钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">SecretKey</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">generalKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//封装Jwt令牌信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">JwtBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">id</span><span class="o">)</span><span class="c1">//唯一的ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="n">subject</span><span class="o">)</span><span class="c1">//主题可以是JSON数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">setIssuer</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span><span class="c1">//签发者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="n">now</span><span class="o">)</span><span class="c1">//签发时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">signatureAlgorithm</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">)</span><span class="c1">//签名算法以及密匙
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">expDate</span><span class="o">);</span> <span class="c1">//设置过期时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">compact</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    *生成加密 secretKey
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@return
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="kd">static</span> <span class="n">SecretKey</span> <span class="nf">generalKey</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">         <span class="kt">byte</span><span class="o">[]</span> <span class="n">encodedKey</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="n">JwtUtil</span><span class="o">.</span><span class="na">JWT_KEY</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">         <span class="n">SecretKey</span> <span class="n">key</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="n">encodedKey</span><span class="o">,</span><span class="n">0</span><span class="o">,</span> <span class="n">encodedKey</span><span class="o">.</span><span class="na">length</span><span class="o">,</span><span class="s">&#34;AES&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    *解析令牌数据
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@param jwt
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@return
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="kd">static</span> <span class="n">Claims</span> <span class="nf">parseJWT</span><span class="o">(</span><span class="n">String</span> <span class="n">jwt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">SecretKey</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">generalKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">secretKey</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">jwt</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(2)用户登录成功则签发TOKEN，修改登录的方法：
<img src="/posts/project-0/20220528162731/image-20220528165023156.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">*用户登录
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span><span class="n">String</span> <span class="n">password</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//查询用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">BCrypt</span><span class="o">.</span><span class="na">checkpw</span><span class="o">(</span><span class="n">password</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置令牌信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">         <span class="n">info</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;role&#34;</span><span class="o">,</span><span class="s">&#34;USER&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">         <span class="n">info</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;success&#34;</span><span class="o">,</span><span class="s">&#34;SUCCESS&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">         <span class="n">info</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//生成令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="n">String</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">JwtUtil</span><span class="o">.</span><span class="na">createJWT</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">info</span><span class="o">),</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;登录成功！&#34;</span><span class="o">,</span><span class="n">jwt</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span>  <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">LOGINERROR</span><span class="o">,</span><span class="s">&#34;账号或者密码错误！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="453-网关过滤器拦截请求处理">4.5.3 网关过滤器拦截请求处理</h4>
<p>自定义全局过滤器，创建过滤器类，如图所示：
<img src="/posts/project-0/20220528162731/image-20220528165029839.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>AuthorizeFilter代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizeFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span><span class="o">,</span> <span class="n">Ordered</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//令牌头名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 		<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">AUTHORIZE_TOKEN</span> <span class="o">=</span> <span class="s">&#34;Authorization&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">    *全局过滤器
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@param exchange
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@param chain
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@return
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取Request、Response对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取请求的URI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getURI</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//如果是登录、goods等开放的微服务[这里的goods部分开放],则直接放行,这里不做完整演示，完整演示需要设计一套权限系统
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/api/user/login&#34;</span><span class="o">)||</span> <span class="n">path</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/api/brand/search/&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">filter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取头文件中的令牌信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">tokent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="n">AUTHORIZE_TOKEN</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//如果头文件中没有，则从请求参数中获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">tokent</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="n">tokent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getQueryParams</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="n">AUTHORIZE_TOKEN</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//如果为空，则输出错误代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">tokent</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//设置方法不允许被访问，405错误代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">METHOD_NOT_ALLOWED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">setComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//解析令牌数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">JwtUtil</span><span class="o">.</span><span class="na">parseJWT</span><span class="o">(</span><span class="n">tokent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//解析失败，响应401错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">setComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">    *过滤器执行顺序
</span></span></span><span class="line"><span class="cl"><span class="cm">    *@return
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>需要在dongyimai-gateway-web引入dongyimai-common的依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> &lt;dependency&gt;
</span></span><span class="line"><span class="cl">            &lt;groupId&gt;com.offcn&lt;/groupId&gt;
</span></span><span class="line"><span class="cl">            &lt;artifactId&gt;dongyimai-common&lt;/artifactId&gt;
</span></span><span class="line"><span class="cl">            &lt;version&gt;1.0&lt;/version&gt;
</span></span><span class="line"><span class="cl">            &lt;exclusions&gt;
</span></span><span class="line"><span class="cl">                &lt;exclusion&gt;
</span></span><span class="line"><span class="cl">                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span class="line"><span class="cl">                    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
</span></span><span class="line"><span class="cl">                &lt;/exclusion&gt;
</span></span><span class="line"><span class="cl">            &lt;/exclusions&gt;
</span></span><span class="line"><span class="cl">        &lt;/dependency&gt;
</span></span></code></pre></div><p>注意：需要排除spring-boot-starter-web的依赖</p>
<p>引入之后，启动网关会包一个错误，和SpringMVC冲突
<img src="/posts/project-0/20220528162731/image-20220528165038544.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="454-配置过滤规则">4.5.4 配置过滤规则</h4>
<p>修改网关系统的yml文件：
<img src="/posts/project-0/20220528162731/image-20220528165043770.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上述代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">globalcors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 				</span><span class="nt">corsConfigurations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">&#39;[/**]&#39;</span><span class="p">:</span><span class="w"> </span><span class="c">#匹配所有请求</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">allowedOrigins</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="c">#跨域处理允许所有的域</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">allowedMethods</span><span class="p">:</span><span class="w"> </span><span class="c">#支持的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">POST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">PUT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">DELETE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai_goods_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://goods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="w">	</span><span class="l">Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">RequestRateLimiter</span><span class="w"> </span><span class="c">#请求数限流名字不能随便写，使用默认的facatory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">key-resolver</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;#{@ipKeyResolver}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">redis-rate-limiter.replenishRate</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">redis-rate-limiter.burstCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#用户微服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai_user_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="l">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gateway-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c">#Redis配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.188.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8761/eureka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 			</span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 				</span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>测试访问<code>http://localhost:8001/api/user/login?username=dongyimai&amp;password=dongyimai</code>，效果如下：
<img src="/posts/project-0/20220528162731/image-20220528165051182.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试访问 http://localhost:8001/api/user，效果如下：</p>
<p><img src="/posts/project-0/20220528162731/image-20220528165056416.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用postman在请求头加入token，在测试，可以正常访问
<img src="/posts/project-0/20220528162731/image-20220528165126095.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>参考官方手册：</p>
<p><a class="link" href="/posts/project-0/https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory"  target="_blank" rel="noopener"
    >https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory</a></p>
<h3 id="46-会话保持">4.6 会话保持</h3>
<p>用户每次请求的时候，我们都需要获取令牌数据，方法有多重，可以在每次提交的时候，将数据提交到头文件中，也可以将数据存储到Cookie中，每次从Cookie中校验数据，还可以每次将令牌数据以参数的方式提交到网关，这里面采用Cookie的方式比较容易实现。</p>
<h4 id="461-登录封装cookie">4.6.1 登录封装Cookie</h4>
<p>修改user微服务，每次登录的时候，添加令牌信息到Cookie中，修改dongyimai-user-service的<code>com.offcn.user.controller.UserController</code>的<code>login</code>方法，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528165133987.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     *用户登录
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//查询用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span>  <span class="n">userService</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">BCrypt</span><span class="o">.</span><span class="na">checkpw</span><span class="o">(</span><span class="n">password</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//设置令牌信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">info</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;role&#34;</span><span class="o">,</span><span class="s">&#34;USER&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;success&#34;</span><span class="o">,</span><span class="s">&#34;SUCCESS&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//生成令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">JwtUtil</span><span class="o">.</span><span class="na">createJWT</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">info</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//创建Cookie对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="s">&#34;Authorization&#34;</span><span class="o">,</span><span class="n">jwt</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//设置cookie的路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//把cookie使用响应头设置给浏览器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;登录成功！&#34;</span><span class="o">,</span><span class="n">jwt</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">LOGINERROR</span><span class="o">,</span><span class="s">&#34;账号或者密码错误！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h4 id="462-过滤器获取令牌数据">4.6.2 过滤器获取令牌数据</h4>
<p>每次在网关中通过过滤器获取Cookie中的令牌，然后对令牌数据进行解析，修改微服务网关dongyimai-gateway-web中的AuthorizeFilter，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528165141292.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>登录后测试，可以识别用户身份，不登录无法识别。如下访问<code>http://localhost:8001/api/user</code>会携带令牌数据：
<img src="/posts/project-0/20220528162731/image-20220528165147428.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="463-添加header信息">4.6.3 添加Header信息</h4>
<p>我们还可以在Gateway的全局过滤器中添加请求头信息，例如可以将令牌信息添加到请求头中，在微服务中获取头信息，如下代码：</p>
<p>修改微服务网关中的过滤器，在令牌信息校验那块将令牌加入到请求头中，如下代码：
<img src="/posts/project-0/20220528162731/image-20220528165152441.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">JwtUtil</span><span class="o">.</span><span class="na">parseJWT</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//把解析出来的令牌添加到头文件中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">request</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">header</span><span class="o">(</span><span class="n">AUTHORIZE_TOKEN</span><span class="o">,</span><span class="n">claims</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span></code></pre></div><p>在dongyimai-service-user微服务的UserController的findAll方法中获取请求头测试，代码如下：
<img src="/posts/project-0/20220528162731/image-20220528165159047.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//获取请求头中封装的令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;Authorization&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;令牌信息:&#34;</span><span class="o">+</span><span class="n">token</span><span class="o">);</span>
</span></span></code></pre></div><p>测试请求地址:</p>
<p>http://localhost:8001/api/user/</p>
<p>后台输出令牌数据如下：
<img src="/posts/project-0/20220528162731/image-20220528165205303.jpeg"
    
    
    
    loading="lazy"
    
    
></p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528174166/">← 分布式事务</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528171137/">提交订单  →</a></button>
            </div>
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山客</div>
                <div class="author-info__description">晓梦云码支付 <s>三网云端免挂/QQ/支付宝/微信</s>pay.yzfyd.cn</div>
            </div>
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://yzfyd.cn" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
        </div>
    </div>


    <div class="card-widget card-announcement">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget card-announcement">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget card-announcement">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget card-webinfo">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>
<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: 0px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">

    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>

    var a = 0;
    ff.onclick = function () {

        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");
            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }

    }
    

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }



</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });

    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script>
    
    
    
    
    
    

    
    

    
    
    
    
    
    
    
    

    

</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>
