<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>支付宝支付</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/agate.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script>
    hljs.highlightAll();
  </script>
  
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.5.2/animate.min.css">
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
     

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }

    #Background_animation { 
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    }

  </style>

</head>
    <body style="background-color: rgb(229, 204, 15);">
    
<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" viewBox="0 0 100 100" id="Background_animation">
  <defs>
      <style>
          @keyframes rotate {
              100% {
                  transform: rotate(360deg);
              }
          }
          .out-top {
              animation: rotate 20s linear infinite;
              transform-origin: 13px 25px;
          }
          .in-top {
              animation: rotate 10s linear infinite;
              transform-origin: 13px 25px;
          }
          .out-bottom {
              animation: rotate 25s linear infinite;
              transform-origin: 84px 93px;
          }
          .in-bottom {
              animation: rotate 15s linear infinite;
              transform-origin: 84px 93px;
          }
      </style>
  </defs>
  <path fill="#9b5de5" class="out-top" d="M37-5C25.1-14.7,5.7-19.1-9.2-10-28.5,1.8-32.7,31.1-19.8,49c15.5,21.5,52.6,22,67.2,2.3C59.4,35,53.7,8.5,37-5Z"/>
  <path fill="#f15bb5" class="in-top" d="M20.6,4.1C11.6,1.5-1.9,2.5-8,11.2-16.3,23.1-8.2,45.6,7.4,50S42.1,38.9,41,24.5C40.2,14.1,29.4,6.6,20.6,4.1Z"/>
  <path fill="#00bbf9" class="out-bottom" d="M105.9,48.6c-12.4-8.2-29.3-4.8-39.4.8-23.4,12.8-37.7,51.9-19.1,74.1s63.9,15.3,76-5.6c7.6-13.3,1.8-31.1-2.3-43.8C117.6,63.3,114.7,54.3,105.9,48.6Z"/>
  <path fill="#00f5d4" class="in-bottom" d="M102,67.1c-9.6-6.1-22-3.1-29.5,2-15.4,10.7-19.6,37.5-7.6,47.8s35.9,3.9,44.5-12.5C115.5,92.6,113.9,74.6,102,67.1Z"/>
</svg>

  <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div><nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
<div id="body-wrap">
  
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-28&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-28&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            9743 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            20 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['支付宝支付'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第十四章</h1>
<h1 align = "center">支付宝支付</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<p>目标1：掌握二维码生成插件qrious的使用</p>
<p>目标2：能够说出支付宝支付开发的整体思路</p>
<p>目标3：能够调用支付宝支付接口（预下单）生成支付二维码</p>
<p>目标4：能够调用支付宝支付接口（查询订单）查询支付状态</p>
<p>目标5：实现支付日志的生成与订单状态的修改</p>
<h1 id="一二维码">一、二维码</h1>
<h2 id="1-什么是二维码">1 什么是二维码</h2>
<p>二维码又称QR Code，QR全称Quick Response，是一个近几年来移动设备上超流行的一种编码方式，它比传统的Bar Code条形码能存更多的信息，也能表示更多的数据类型。</p>
<p>二维条码/二维码（2-dimensional bar code）是用某种特定的几何图形按一定规律在平面（二维方向上）分布的黑白相间的图形记录数据符号信息的；在代码编制上巧妙地利用构成计算机内部逻辑基础的“0”、“1”比特流的概念，使用若干个与二进制相对应的几何形体来表示文字数值信息，通过图象输入设备或光电扫描设备自动识读以实现信息自动处理：它具有条码技术的一些共性：每种码制有其特定的字符集；每个字符占有一定的宽度；具有一定的校验功能等。同时还具有对不同行的信息自动识别功能、及处理图形旋转变化点。
<img src="/posts/project-0/20220528172145/image-20220528172251356.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="2-二维码优势">2 二维码优势</h2>
<ul>
<li>信息容量大, 可以容纳多达1850个大写字母或2710个数字或500多个汉字</li>
<li>应用范围广, 支持文字,声音,图片,指纹等等&hellip;</li>
<li>容错能力强, 即使图片出现部分破损也能使用</li>
<li>成本低, 容易制作</li>
</ul>
<h2 id="3-二维码容错级别">3 二维码容错级别</h2>
<p>L级（低） 7％的码字可以被恢复。</p>
<p>M级（中） 的码字的15％可以被恢复。</p>
<p>Q级（四分）的码字的25％可以被恢复。</p>
<p>H级（高） 的码字的30％可以被恢复。</p>
<h2 id="4-二维码生成插件qrious">4 二维码生成插件qrious</h2>
<p>qrious是一款基于HTML5 Canvas的纯JS二维码生成插件。通过qrious.js可以快速生成各种二维码，你可以控制二维码的尺寸颜色，还可以将生成的二维码进行Base64编码。</p>
<p>官网地址：https://github.com/neocotic/qrious</p>
<p>qrious.js二维码插件的可用配置参数如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>background</td>
<td>String</td>
<td>&ldquo;white&rdquo;</td>
<td>二维码的背景颜色。</td>
</tr>
<tr>
<td>foreground</td>
<td>String</td>
<td>&ldquo;black&rdquo;</td>
<td>二维码的前景颜色。</td>
</tr>
<tr>
<td>level</td>
<td>String</td>
<td>&ldquo;L&rdquo;</td>
<td>二维码的误差校正级别(L, M, Q, H)。</td>
</tr>
<tr>
<td>mime</td>
<td>String</td>
<td>&ldquo;image/png&rdquo;</td>
<td>二维码输出为图片时的MIME类型。</td>
</tr>
<tr>
<td>size</td>
<td>Number</td>
<td>100</td>
<td>二维码的尺寸，单位像素。</td>
</tr>
<tr>
<td>value</td>
<td>String</td>
<td>&quot;&quot;</td>
<td>需要编码为二维码的值</td>
</tr>
</tbody>
</table>
<p>下面的代码即可生成一张二维码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>二维码入门小demo<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">img</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;qrious&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;qrious.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="kd">var</span> <span class="nx">qr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QRious</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">	   <span class="nx">element</span><span class="o">:</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;qrious&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	   <span class="nx">size</span><span class="o">:</span><span class="mi">250</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nx">level</span><span class="o">:</span><span class="s1">&#39;H&#39;</span><span class="p">,</span>	
</span></span><span class="line"><span class="cl"><span class="nx">value</span><span class="o">:</span><span class="s1">&#39;http://www.ujiuye.com&#39;</span>
</span></span><span class="line"><span class="cl">	<span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>运行效果：</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172302874.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>大家掏出手机，扫一下看看是否会看到优就业的官网呢？</p>
<h1 id="二支付宝扫码支付业务介绍及开发环境配置流程">二、支付宝扫码支付业务介绍及开发、环境配置流程</h1>
<h2 id="1-支付宝扫码支付业务流程">1 支付宝扫码支付业务流程</h2>
<p>支付宝扫码支付是商户系统按支付宝支付协议生成支付二维码，用户再用支付宝“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。</p>
<p>具体操作步骤：（了解）</p>
<p><strong>第一步：创建应用</strong></p>
<p>接入扫码支付能力，需要在开放平台创建一个应用，通过该应用来接入各种能力。</p>
<p>点击如下链接即可开始创建应用:https://openhome.alipay.com/platform/appManage.htm</p>
<p><strong>第二步：添加应用功能</strong></p>
<p>开发者在开发过程中，可以添加自己需要的功能到待申请功能列表。</p>
<p>给应用添加当面付功能，这样就可以在你的应用里使用扫码支付能力。</p>
<p><strong>第三步：配置秘钥</strong></p>
<p>为了保证交易双方的身份和数据安全，需要配置双方密钥。</p>
<p><strong>第四步：沙箱环境调试使用</strong></p>
<p>支付能力直接涉及到交易与资金，为了方便开放者调试支付能力，支付宝已经准备好沙箱环境，包括沙箱环境账号和沙箱版支付宝钱包，这样就可以在沙箱环境调试了。</p>
<p><strong>第五步：签约</strong></p>
<p>在正式使用这些能力的时候，需要在开放平台里进行签约，这时候约定的合同就生效了。也可以代替商户签约。</p>
<p><strong>第六步：上线应用</strong></p>
<p>上线：商户本身应用上线时候，也要把支付宝开放平台的应用上线。</p>
<p>验收：为了确保应用质量，开放平台提供了云验收平台，可以在线验收应用。</p>
<p><strong>第七步：监控应用</strong></p>
<p>在开放平台监控交易情况</p>
<p>应用上线后还可以在开放平台，查看应用运行情况以及交易状态。</p>
<h2 id="2-扫码支付具体申请配置流程">2 扫码支付具体申请配置流程</h2>
<h3 id="21登录支付宝开发者平台">2.1、登录支付宝开发者平台</h3>
<p>打开支付宝官网：https://open.alipay.com</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172312372.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>选择我是开发者</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172318032.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>【注意】用自己的支付宝，扫描右边的扫码登录，在支付宝确认登录，即可登录支付宝开发者平台。初次登录进行身份验证</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172324306.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>选择：自研开发者</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172329688.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>同意协议，点击确定</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172333879.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="22登录开发者平台界面">2.2、登录开发者平台界面</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172339093.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>选择研发服务</p>
<h3 id="23进入研发服务中心---沙箱环境">2.3、进入研发服务中心&mdash;》沙箱环境</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172343632.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>沙箱环境(Beta)是协助开发者进行接口功能开发及主要功能联调的模拟环境。</p>
<p>作为开发者使用沙箱完全可以用来入门学习如何对接扫码支付接口。</p>
<p>Appid是应用的id，后续再开发应用时要用到，请保存好！</p>
<p>支付宝网关：https://openapi.alipaydev.com/gateway.do</p>
<h3 id="24配置沙箱环境配置rsa2公钥">2.4、配置沙箱环境,配置RSA2公钥</h3>
<p>(1)鼠标移动到设置<img src="/posts/project-0/20220528172145/image-20220528172401252.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>处在弹出的文字介绍中，点击 <strong>生成方法</strong></p>
<p><img src="/posts/project-0/20220528172145/image-20220528172409392.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)根据操作系统进行选择进行下载。</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172421119.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>在线生成：https://miniu.alipay.com/keytool/create</p>
<p>下载成功后，直接点击安装</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172426280.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>安装成功</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172430581.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>双击打开程序</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172437823.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>依照图示选择</p>
<p>​         密码长度为 <strong>RSA2</strong></p>
<p>​         密码格式为 <strong>PKCS8(Java适用)</strong></p>
<p>然后点击<strong>生成密钥</strong>， 后 点击<strong>打开密钥文件路径</strong></p>
<p><img src="/posts/project-0/20220528172145/image-20220528172449287.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>回到沙箱配置界面，点击 <strong>查看</strong></p>
<p><img src="/posts/project-0/20220528172145/image-20220528172454669.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>点击更换应用公钥：</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172500902.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>选择公钥，打开刚才我们生成的应用公钥，拷贝粘贴到文本框中</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172505140.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>点击保存设置既可以把我们的公钥配置上去。</p>
<h2 id="3-支付宝支付sdk">3 支付宝支付SDK</h2>
<p>支付宝支付提供了SDK，使用支付宝支付SDK,在maven工程中引入依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 支付宝支付所需类库包 --&gt;</span>  
</span></span><span class="line"><span class="cl">       <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alipay.sdk<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>alipay-sdk-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>4.3.0.ALL<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;groupId&gt;</span>org.bouncycastle<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;artifactId&gt;</span>bcprov-jdk15on<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id="4-工程搭建与准备工作">4 工程搭建与准备工作</h2>
<p>（1）建立支付服务实现模块dongyimai-pay-service</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172511482.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>（2）dongyimai-pay-service下创建application.yml，配置文件代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9009</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pay</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.188.128</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">main</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allow-bean-definition-overriding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://127.0.0.1:8761/eureka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 配置sql打印日志</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">com</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">offcn</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#hystrix 配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">execution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c">#如果enabled设置为false，则请求超时交给ribbon控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">isolation</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l">SEMAPHORE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#支付宝支付信息配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">alipay</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serverUrl</span><span class="p">:</span><span class="w"> </span><span class="l">https://openapi.alipaydev.com/gateway.do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appId</span><span class="p">:</span><span class="w"> </span><span class="m">2016102600767650</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">privateKey</span><span class="p">:</span><span class="w"> </span><span class="l">用户私钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l">json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">charset</span><span class="p">:</span><span class="w"> </span><span class="l">utf-8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">alipayPublicKey</span><span class="p">:</span><span class="w"> </span><span class="l">阿里公钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">signType</span><span class="p">:</span><span class="w"> </span><span class="l">RSA2</span><span class="w">
</span></span></span></code></pre></div><p>AlipayClient创建关键参数说明：</p>
<table>
<thead>
<tr>
<th><strong>配置参数</strong></th>
<th><strong>示例值解释</strong></th>
<th><strong>获取方式/示例值</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>URL</td>
<td>支付宝网关（固定）</td>
<td><a class="link" href="/posts/project-0/https://openapi.alipay.com/gateway.do"  target="_blank" rel="noopener"
    >https://openapi.alipay.com/gateway.do</a></td>
</tr>
<tr>
<td>APP_ID</td>
<td>APPID即创建应用后生成</td>
<td>获取见上面<a class="link" href="/posts/project-0/https://docs.open.alipay.com/#s0"  target="_blank" rel="noopener"
    >创建应用并获取APPID</a></td>
</tr>
<tr>
<td>APP_PRIVATE_KEY</td>
<td>开发者应用私钥，由开发者自己生成</td>
<td>获取见上面<a class="link" href="/posts/project-0/https://docs.open.alipay.com/#s1"  target="_blank" rel="noopener"
    >配置密钥</a></td>
</tr>
<tr>
<td>FORMAT</td>
<td>参数返回格式，只支持json</td>
<td>json（固定）</td>
</tr>
<tr>
<td>CHARSET</td>
<td>请求和签名使用的字符编码格式，支持GBK和UTF-8</td>
<td>开发者根据实际工程编码配置</td>
</tr>
<tr>
<td>ALIPAY_PUBLIC_KEY</td>
<td>支付宝公钥，由支付宝生成</td>
<td>获取详见上面<a class="link" href="/posts/project-0/https://docs.open.alipay.com/#s1"  target="_blank" rel="noopener"
    >配置密钥</a></td>
</tr>
<tr>
<td>SIGN_TYPE</td>
<td>商户生成签名字符串所使用的签名算法类型，目前支持RSA2和RSA，推荐使用RSA2</td>
<td>RSA2</td>
</tr>
</tbody>
</table>
<p>接下来，就可以用alipayClient来调用具体的API了。alipayClient只需要初始化一次，后续调用不同的API都可以使用同一个alipayClient对象。</p>
<p>（4）在<code>com.offcn.pay.config</code>包下，创建AliPayConfig，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AliPayConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.appId}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">appId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.serverUrl}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverUrl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.privateKey}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">privateKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.alipayPublicKey}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">alipayPublicKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.format}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">format</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.charset}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">charset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${alipay.signType}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">signType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AlipayClient</span> <span class="nf">getPayClient</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultAlipayClient</span><span class="o">(</span><span class="n">serverUrl</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="n">privateKey</span><span class="o">,</span> <span class="n">format</span><span class="o">,</span> <span class="n">charset</span><span class="o">,</span> <span class="n">alipayPublicKey</span><span class="o">,</span> <span class="n">signType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>（5）启动类创建</p>
<p>在<code>dongyimai-pay-service</code>中创建<code>com.offcn.pay.PayApplication</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span><span class="o">={</span><span class="n">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PayApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>pom.xml引入如下依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 支付宝支付所需类库包 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.alipay.sdk<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>alipay-sdk-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>4.3.0.ALL<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.bouncycastle<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>bcprov-jdk15on<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-common<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h1 id="三-东易买-支付宝支付二维码生成">三 东易买-支付宝支付二维码生成</h1>
<h2 id="1-需求分析与实现思路">1 需求分析与实现思路</h2>
<h3 id="11需求分析">1.1需求分析</h3>
<p>在支付页面上生成支付二维码，并显示订单号和金额</p>
<p>用户拿出手机,打开支付宝扫描页面上的二维码,然后在支付宝中完成支付
<img src="/posts/project-0/20220528172145/image-20220528172521558.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="12实现思路">1.2实现思路</h3>
<p>商户系统通过AlipayClient调用支付宝预下单接口alipay.trade.precreate，获得该订单二维码图片地址。</p>
<p>构建参数发送给预下单接口 ，返回的信息中有支付url，根据url生成二维码，显示的订单号和金额也在返回的信息中。</p>
<p><strong>重要入参说明</strong></p>
<ul>
<li>out_trade_no：商户订单号，需要保证商家系统不重复。</li>
<li>total_amount：订单金额。(单位：元)</li>
<li>subject：商品的标题/交易标题/订单标题/订单关键字等。不可使用特殊字符，如 /,=,&amp; 等。</li>
<li>store_id：商户门店编号。</li>
<li>timeout_express：交易超时时间。</li>
</ul>
<p><strong>重要出参说明</strong></p>
<ul>
<li>qr_code：订单二维码（有效时间 2 小时）以字符串的格式返回，开发者需要自己使用工具根据内容生成二维码图片。</li>
</ul>
<h2 id="2-代码实现">2 代码实现</h2>
<h3 id="21服务接口层">2.1服务接口层</h3>
<p>（1）在dongyimai-pay-service创建包com.offcn.pay.service ，包下建立接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AliPayService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 生成支付宝支付二维码
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param out_trade_no 订单号
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param total_fee 金额(分)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span> <span class="nf">createNative</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span> <span class="n">String</span> <span class="n">total_fee</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="22服务实现层">2.2服务实现层</h3>
<p>dongyimai-pay-service创建com.offcn.pay.service.impl包，新建类</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AliPayServiceImpl</span> <span class="kd">implements</span> <span class="n">AliPayService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AlipayClient</span> <span class="n">alipayClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 生成支付宝支付二维码
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param out_trade_no 订单号
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param total_fee    金额(分)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span> <span class="nf">createNative</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span> <span class="n">String</span> <span class="n">total_fee</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建预下单请求对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AlipayTradePrecreateRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlipayTradePrecreateRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//转换下单金额按照元
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">total_fee</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">BigDecimal</span> <span class="n">bigTotal</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">total</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">BigDecimal</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">100d</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BigDecimal</span> <span class="n">bigYuan</span> <span class="o">=</span> <span class="n">bigTotal</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">cs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;预下单金额:&#34;</span> <span class="o">+</span> <span class="n">bigYuan</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="na">setBizContent</span><span class="o">(</span><span class="s">&#34;{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span> <span class="o">+</span> <span class="n">out_trade_no</span> <span class="o">+</span> <span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;total_amount\&#34;:\&#34;&#34;</span> <span class="o">+</span> <span class="n">bigYuan</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;subject\&#34;:\&#34;测试购买商品001\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;store_id\&#34;:\&#34;xa_001\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;    \&#34;timeout_express\&#34;:\&#34;90m\&#34;}&#34;</span><span class="o">);</span><span class="c1">//设置业务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//发出预下单业务请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">AlipayTradePrecreateResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">alipayClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//从相应对象读取相应结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;响应码:&#34;</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//全部的响应结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;返回结果:&#34;</span> <span class="o">+</span> <span class="n">body</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;qrcode&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getQrCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total_fee&#34;</span><span class="o">,</span> <span class="n">total_fee</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;qrcode:&#34;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getQrCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;out_trade_no:&#34;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;total_fee:&#34;</span> <span class="o">+</span> <span class="n">total_fee</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;预下单接口调用失败:&#34;</span> <span class="o">+</span> <span class="n">body</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AlipayApiException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="23控制层">2.3控制层</h3>
<p>dongyimai-pay-service创建com.offcn.pay.controller.PayController.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/pay&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AliPayService</span> <span class="n">aliPayService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 生成二维码
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/createNative&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span> <span class="nf">createNative</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">IdWorker</span> <span class="n">idworker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IdWorker</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">aliPayService</span><span class="o">.</span><span class="na">createNative</span><span class="o">(</span><span class="n">idworker</span><span class="o">.</span><span class="na">nextId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这里我们订单号通过分布式ID生成器生成，金额暂时写死，后续开发我们再对接业务系统得到订单号和金额</p>
<p>浏览器测试 http://localhost:9009/pay/createNative</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172532601.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>打开支付页面/pay.html，修改value路径，然后打开，会出现二维码，可以扫码试试
<img src="/posts/project-0/20220528172145/image-20220528172537551.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>打开手机沙箱版支付宝，使用沙箱账号进行扫描。出现如下支付页面。</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172542392.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="四-东易买-检测支付状态">四 东易买-检测支付状态</h1>
<h2 id="1-需求分析及实现思路">1 需求分析及实现思路</h2>
<h3 id="11-需求分析">1.1 需求分析</h3>
<p>当用户支付成功后跳转到成功页面
<img src="/posts/project-0/20220528172145/image-20220528172549694.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>当返回异常时跳转到错误页面
<img src="/posts/project-0/20220528172145/image-20220528172559543.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="12-实现思路">1.2 实现思路</h3>
<p>我们通过AlipayClient实现对交易查询接口（alipay.trade.query）的调用。</p>
<p>交易查询接口具体参数：</p>
<p>关键入参：</p>
<table>
<thead>
<tr>
<th><strong>参数名称</strong></th>
<th><strong>参数说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>out_trade_no</td>
<td>支付时传入的商户订单号，与trade_no必填一个</td>
</tr>
<tr>
<td>trade_no</td>
<td>支付时返回的支付宝交易号，与out_trade_no必填一个</td>
</tr>
</tbody>
</table>
<p>关键出参：</p>
<table>
<thead>
<tr>
<th><strong>参数名称</strong></th>
<th><strong>参数说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>trade_no</td>
<td>支付宝28位交易号</td>
</tr>
<tr>
<td>out_trade_no</td>
<td>支付时传入的商户订单号</td>
</tr>
<tr>
<td>trade_status</td>
<td>交易当前状态</td>
</tr>
</tbody>
</table>
<p>我们在controller方法中轮询调用交易查询指定订单号（间隔3秒），当返回状态为success时，我们会在controller方法返回结果。前端代码收到结果后跳转到成功页面。</p>
<h2 id="2-检测支付状态-后端代码">2 检测支付状态-后端代码</h2>
<h3 id="21-服务接口层">2.1 服务接口层</h3>
<p>在dongyimai-pay-service的AliPayService.java中新增方法定义</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 查询支付状态
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Map</span> <span class="nf">queryPayStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">);</span>
</span></span></code></pre></div><h3 id="22-服务实现层">2.2 服务实现层</h3>
<p>在dongyimai-pay-service的AliPayServiceImpl.java中实现方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 交易查询接口alipay.trade.query：
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 获取指定订单编号的，交易状态
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * @throws AlipayApiException 
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span>  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">queryPayStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">		<span class="n">AlipayTradeQueryRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlipayTradeQueryRequest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">request</span><span class="o">.</span><span class="na">setBizContent</span><span class="o">(</span><span class="s">&#34;{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;    \&#34;out_trade_no\&#34;:\&#34;&#34;</span><span class="o">+</span><span class="n">out_trade_no</span><span class="o">+</span><span class="s">&#34;\&#34;,&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;    \&#34;trade_no\&#34;:\&#34;\&#34;}&#34;</span><span class="o">);</span> <span class="c1">//设置业务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//发出请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">AlipayTradeQueryResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">alipayClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">String</span> <span class="n">code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;返回值1:&#34;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;10000&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//System.out.println(&#34;返回值2:&#34;+response.getBody());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">,</span> <span class="n">out_trade_no</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getTradeStatus</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                 <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;trade_no&#34;</span><span class="o">,</span><span class="n">response</span><span class="o">.</span><span class="na">getTradeNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>			
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AlipayApiException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="23-控制层">2.3 控制层</h3>
<p>在dongyimai-pay-service的PayController.java新增方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 查询支付状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/queryPayStatus&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">queryPayStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span> <span class="n">result</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//调用查询接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">map</span> <span class="o">=</span> <span class="n">aliPayService</span><span class="o">.</span><span class="na">queryPayStatus</span><span class="o">(</span><span class="n">out_trade_no</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*e1.printStackTrace();*/</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;调用查询服务出错&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span><span class="c1">//出错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">result</span><span class="o">=</span><span class="k">new</span>  <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span><span class="s">&#34;支付出错&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">)!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;TRADE_SUCCESS&#34;</span><span class="o">)){</span><span class="c1">//如果成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">result</span><span class="o">=</span><span class="k">new</span>  <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;支付成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">)!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;TRADE_CLOSED&#34;</span><span class="o">)){</span><span class="c1">//如果成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">result</span><span class="o">=</span><span class="k">new</span>  <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;未付款交易超时关闭，或支付完成后全额退款&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">)!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;TRADE_FINISHED&#34;</span><span class="o">)){</span><span class="c1">//如果成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">result</span><span class="o">=</span><span class="k">new</span>  <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="s">&#34;交易结束，不可退款&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3000</span><span class="o">);</span><span class="c1">//间隔三秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="3-查询时间限制">3 查询时间限制</h2>
<h3 id="31问题分析">3.1问题分析</h3>
<p>如果用户到了二维码页面一直未支付，或是关掉了支付页面，我们的代码会一直循环调用支付宝接口，这样会对程序造成很大的压力。所以我们要加一个时间限制或是循环次数限制，当超过时间或次数时，跳出循环。</p>
<h3 id="32代码完善">3.2代码完善</h3>
<p>（1）修改dongyimai-pay-service工程PayController.java的queryPayStatus方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">	<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/queryPayStatus&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Result</span> <span class="nf">queryPayStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">Result</span> <span class="n">result</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>		
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">x</span><span class="o">=</span><span class="n">0</span><span class="o">;</span>		
</span></span><span class="line"><span class="cl">		<span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//调用查询接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">.......</span>		
</span></span><span class="line"><span class="cl">			<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3000</span><span class="o">);</span><span class="c1">//间隔三秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>	
</span></span><span class="line"><span class="cl">			<span class="c1">//为了不让循环无休止地运行，我们定义一个循环变量，如果这个变量超过了这个值则退出循环，设置时间为5分钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">x</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="n">100</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">				<span class="n">result</span><span class="o">=</span><span class="k">new</span>  <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span> <span class="s">&#34;二维码超时&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span></code></pre></div><p>访问：http://localhost:9009/pay/queryPayStatus?out_trade_no=1394204936316682240，并扫描预下单时生成的二维码，进行支付。返回支付成功</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172615222.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>长时间没有返回结果返回二维码超时：
<img src="/posts/project-0/20220528172145/image-20220528172621024.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="五-支付日志">五 支付日志</h1>
<h2 id="1-需求分析">1 需求分析</h2>
<p>我们现在系统还有个问题需要解决：系统中无法查询到支付记录，支付后订单状态没有改变</p>
<p>我们现在就来解决这两个问题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">1.在用户下订单时，判断如果为支付宝支付，就向支付日志表添加一条记录，信息包括支付总金额、订单ID（多个）、用户ID</span> <span class="s">、下单时间等信息，支付状态为0（未支付）</span>
</span></span><span class="line"><span class="cl"><span class="err">2.生成的支付日志对象放入redis中，以用户ID作为key，这样在生成支付二维码时就可以从redis中提取支付日志对象中的金额和订单号。</span>
</span></span><span class="line"><span class="cl"><span class="err">3.当用户支付成功后，修改支付日志的支付状态为1（已支付），并记录支付宝传递给我们的交易流水号。根据订单ID（多个）修改订单的状态为2（已付款）。</span>
</span></span></code></pre></div><h2 id="2-表结构分析">2 表结构分析</h2>
<p><strong>tb_paylog</strong>  支付日志表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>out_trade_no</td>
<td>varchar</td>
<td>30</td>
<td>支付订单号</td>
</tr>
<tr>
<td>create_time</td>
<td>datatime</td>
<td></td>
<td>创建时间</td>
</tr>
<tr>
<td>pay_time</td>
<td>datatime</td>
<td></td>
<td>支付完成时间</td>
</tr>
<tr>
<td>total_fee</td>
<td>bigint</td>
<td></td>
<td>支付金额（分）</td>
</tr>
<tr>
<td>transaction_id</td>
<td>varchar</td>
<td>30</td>
<td>交易流水号</td>
</tr>
<tr>
<td>trade_state</td>
<td>varchar</td>
<td>1</td>
<td>交易状态</td>
</tr>
<tr>
<td>pay_type</td>
<td>varchar</td>
<td>1</td>
<td>支付类型：1:支付宝2:微信3:网银</td>
</tr>
<tr>
<td>order_list</td>
<td>varchar</td>
<td>200</td>
<td>订单表ID串，用逗号分隔</td>
</tr>
</tbody>
</table>
<h2 id="3-逆向工程">3 逆向工程</h2>
<p>拷贝逆向工程中的相关日志的pojo、Feign到dongyimai-order-service-api，拷贝 dao、service、controller到dongyimai-order-service中。
<img src="/posts/project-0/20220528172145/image-20220528172627888.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528172145/image-20220528172632310.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-插入日志记录">4 插入日志记录</h2>
<p>修改<code>dongyimai-order-service</code>工程<code>com.offcn.order.service.impl.OrderServiceImpl</code> 的add方法。</p>
<p>内容：判断如果支付方式为支付宝支付，向数据库插入支付日志记录，并放入redis存储</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172638046.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">PayLogMapper</span> <span class="n">payLogMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author zdy
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 增加Order
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 金额校验:后台校验
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param order
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 得到购物车数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;</span> <span class="n">cartList</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Cart</span><span class="o">&gt;)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">orderIdList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span><span class="c1">//订单ID列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">total_money</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="c1">//总金额 （元）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">Cart</span> <span class="n">cart</span> <span class="o">:</span> <span class="n">cartList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">orderId</span> <span class="o">=</span> <span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;sellerId:&#34;</span> <span class="o">+</span> <span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;orderId:&#34;</span> <span class="o">+</span> <span class="n">orderId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Order</span> <span class="n">tborder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">();</span><span class="c1">// 新创建订单对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span><span class="c1">// 订单ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span><span class="c1">// 用户名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setPaymentType</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getPaymentType</span><span class="o">());</span><span class="c1">// 支付类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span><span class="c1">// 状态：未付款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">// 订单创建日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setUpdateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">// 订单更新日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setReceiverAreaName</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getReceiverAreaName</span><span class="o">());</span><span class="c1">// 地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setReceiverMobile</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getReceiverMobile</span><span class="o">());</span><span class="c1">// 手机号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setReceiver</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getReceiver</span><span class="o">());</span><span class="c1">// 收货人
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setSourceType</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getSourceType</span><span class="o">());</span><span class="c1">// 订单来源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tborder</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span><span class="c1">// 商家ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 循环购物车明细
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="n">money</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">OrderItem</span> <span class="n">orderItem</span> <span class="o">:</span> <span class="n">cart</span><span class="o">.</span><span class="na">getOrderItemList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">orderItem</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">orderItem</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span><span class="c1">// 订单ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">orderItem</span><span class="o">.</span><span class="na">setSellerId</span><span class="o">(</span><span class="n">cart</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">money</span> <span class="o">+=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getTotalFee</span><span class="o">());</span><span class="c1">// 金额累加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;orderItem.getId():&#34;</span><span class="o">+</span><span class="n">orderItem</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//减少库存  调用goods 微服务的 feign 减少库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">itemFeign</span><span class="o">.</span><span class="na">decrCount</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//保存订单明细到数据库中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">            <span class="n">orderItemMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">orderIdList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">orderId</span><span class="o">+</span><span class="s">&#34;&#34;</span><span class="o">);</span><span class="c1">//添加到订单列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">total_money</span><span class="o">+=</span><span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tborder</span><span class="o">.</span><span class="na">setPayment</span><span class="o">(</span><span class="n">money</span><span class="o">+</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">tborder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//线上支付，记录订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getPaymentType</span><span class="o">()))</span> <span class="o">{</span><span class="c1">//如果是支付宝支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PayLog</span> <span class="n">payLog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayLog</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">outTradeNo</span> <span class="o">=</span> <span class="n">idWorker</span><span class="o">.</span><span class="na">nextId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;&#34;</span><span class="o">;</span><span class="c1">//支付订单号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">payLog</span><span class="o">.</span><span class="na">setOutTradeNo</span><span class="o">(</span><span class="n">outTradeNo</span><span class="o">);</span><span class="c1">//支付订单号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">payLog</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span><span class="c1">//创建时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//订单号列表，逗号分隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">orderIdList</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34;[&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34; &#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setOrderList</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span><span class="c1">//订单号列表，逗号分隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">payLog</span><span class="o">.</span><span class="na">setPayType</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getPaymentType</span><span class="o">());</span><span class="c1">//支付类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//把元转换成分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;合计金额:&#34;</span> <span class="o">+</span> <span class="n">total_money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">BigDecimal</span> <span class="n">total_money1</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">total_money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">BigDecimal</span> <span class="n">cj</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">100d</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//高精度乘法 推荐使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">BigDecimal</span> <span class="n">bigDecimal</span> <span class="o">=</span> <span class="n">total_money1</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">cj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//低精度计算方式，不推荐使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">double</span> <span class="n">hj</span> <span class="o">=</span> <span class="n">total_money</span> <span class="o">*</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;合计:&#34;</span> <span class="o">+</span> <span class="n">hj</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;高精度处理:&#34;</span> <span class="o">+</span> <span class="n">bigDecimal</span><span class="o">.</span><span class="na">toBigInteger</span><span class="o">().</span><span class="na">longValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setTotalFee</span><span class="o">(</span><span class="n">bigDecimal</span><span class="o">.</span><span class="na">toBigInteger</span><span class="o">().</span><span class="na">longValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setTradeState</span><span class="o">(</span><span class="s">&#34;0&#34;</span><span class="o">);</span><span class="c1">//支付状态  0 未支付 1已经支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">payLog</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span><span class="c1">//用户ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">payLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">payLog</span><span class="o">);</span><span class="c1">//插入到支付日志表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;payLog&#34;</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">payLog</span><span class="o">);</span><span class="c1">//放入缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//增加积分，调用用户微服务的userFeign 增加积分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">userFeign</span><span class="o">.</span><span class="na">addPoints</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;cartList&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改PayLog.java中主键生成的方式为外界输入</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172647199.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-读取支付日志">5 读取支付日志</h2>
<h3 id="51服务接口层">5.1服务接口层</h3>
<p>在dongyimai-order-service 工程中创建PayLogService.java, 新增方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据用户查询payLog
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param userId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PayLog</span> <span class="nf">searchPayLogFromRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>
</span></span></code></pre></div><h3 id="52服务实现层">5.2服务实现层</h3>
<p>dongyimai-order-service的PayLogServiceImpl.java实现方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据用户查询payLog
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param userId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PayLog</span> <span class="nf">searchPayLogFromRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="n">PayLog</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;payLog&#34;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h3 id="53控制层paylogcontroller">5.3控制层PayLogController</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 查询用户的支付日志
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;根据登录用户从redis中查询支付日志&#34;</span><span class="o">,</span><span class="n">notes</span> <span class="o">=</span> <span class="s">&#34;查询用户支付日志&#34;</span><span class="o">,</span><span class="n">tags</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;OrderController&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/searchPayLogFromRedis&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">PayLog</span><span class="o">&gt;</span> <span class="nf">searchPayLogFromRedis</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">PayLog</span> <span class="n">payLog</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">searchPayLogFromRedis</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">PayLog</span><span class="o">&gt;(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;查询成功&#34;</span><span class="o">,</span><span class="n">payLog</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h3 id="54修改paylogfegin">5.4修改PayLogFegin</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;ORDER&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PayLogFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     查询用户的支付日志
</span></span></span><span class="line"><span class="cl"><span class="cm">     @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/payLog/searchPayLogFromRedis&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">PayLog</span><span class="o">&gt;</span> <span class="nf">searchPayLogFromRedis</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;userId&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">userId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">....</span>
</span></span></code></pre></div><h3 id="55引入依赖">5.5引入依赖</h3>
<p>在dongyimai-pay-service中引入dongyimai-order-service-api的依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-order-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>druid-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="56修改启动类">5.6修改启动类</h3>
<p>修改dongyimai-pay-service启动类 PayApplication.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span><span class="o">={</span><span class="n">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;com.offcn.order.feign&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PayApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="57-修改控制器paycontroller">5.7 修改控制器PayController</h3>
<p>修改dongyimai-pay-service工程PayController.java的createNative方法</p>
<p>实现思路：调用获取支付日志对象的方法，得到订单号和金额</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">PayLogFeign</span> <span class="n">payLogFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 生成二维码
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/createNative&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span> <span class="nf">createNative</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取用户名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">tokenDecode</span><span class="o">.</span><span class="na">getUserInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">userMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;user_name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;当前登录用户:&#34;</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//到redis查询支付日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">PayLog</span><span class="o">&gt;</span> <span class="n">payLogResult</span> <span class="o">=</span> <span class="n">payLogFeign</span><span class="o">.</span><span class="na">searchPayLogFromRedis</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PayLog</span> <span class="n">payLog</span> <span class="o">=</span> <span class="n">payLogResult</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断支付日志存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">payLog</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">aliPayService</span><span class="o">.</span><span class="na">createNative</span><span class="o">(</span><span class="n">payLog</span><span class="o">.</span><span class="na">getOutTradeNo</span><span class="o">(),</span><span class="n">payLog</span><span class="o">.</span><span class="na">getTotalFee</span><span class="o">()+</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h2 id="6-修改订单状态">6 修改订单状态</h2>
<p>订单支付成功后，需要修改日志记录支付交易流水号并持久化到数据库，并且修改订单的支付状态，然后将Redis中的订单删除：</p>
<h3 id="61服务接口层">6.1服务接口层</h3>
<p>修改com.offcn.order.service.OrderService，添加修改订单状态方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 根据订单ID修改订单状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param transactionid 交易流水号
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param orderId
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span><span class="n">String</span> <span class="n">transactionid</span><span class="o">);</span>
</span></span></code></pre></div><h3 id="62服务实现层">6.2服务实现层</h3>
<p>修改com.offcn.order.service.impl.OrderServiceImpl，添加修改订单状态实现方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 修改订单状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param out_trade_no   支付订单号
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param transaction_id 支付宝返回的交易流水号
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span> <span class="n">String</span> <span class="n">transaction_id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1.修改支付日志状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PayLog</span> <span class="n">payLog</span> <span class="o">=</span> <span class="n">payLogMapper</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">out_trade_no</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">payLog</span><span class="o">.</span><span class="na">setPayTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">payLog</span><span class="o">.</span><span class="na">setTradeState</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span><span class="c1">//已支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">payLog</span><span class="o">.</span><span class="na">setTransactionId</span><span class="o">(</span><span class="n">transaction_id</span><span class="o">);</span><span class="c1">//交易号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">payLogMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">payLog</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2.修改订单状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">orderList</span> <span class="o">=</span> <span class="n">payLog</span><span class="o">.</span><span class="na">getOrderList</span><span class="o">();</span><span class="c1">//获取订单号列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span><span class="o">[]</span> <span class="n">orderIds</span> <span class="o">=</span> <span class="n">orderList</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">);</span><span class="c1">//获取订单号数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">orderId</span><span class="o">:</span><span class="n">orderIds</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderMapper</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">orderId</span><span class="o">)</span> <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">order</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">order</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span><span class="c1">//已付款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">orderMapper</span><span class="o">.</span><span class="na">updateById</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//3、清除redis缓存数据		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundHashOps</span><span class="o">(</span><span class="s">&#34;payLog&#34;</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">payLog</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="63控制层ordercontroller">6.3控制层OrderController</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 修改订单的状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param transaction_id
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;修改订单的状态&#34;</span><span class="o">,</span><span class="n">notes</span> <span class="o">=</span> <span class="s">&#34;修改订单的状态&#34;</span><span class="o">,</span><span class="n">tags</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;OrderController&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;/updateOrderStatus&#34;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">updateOrderStatus</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">)</span>  <span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;transaction_id&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">transaction_id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderService</span><span class="o">.</span><span class="na">updateStatus</span><span class="o">(</span><span class="n">out_trade_no</span><span class="o">,</span><span class="n">transaction_id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;修改成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span><span class="s">&#34;修改失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="64修改orderfeign">6.4修改OrderFeign</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 修改订单状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param out_trade_no
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param transaction_id
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/updateOrderStatus&#34;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">updateStatus</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">)</span>  <span class="n">String</span> <span class="n">out_trade_no</span><span class="o">,</span>  
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;transaction_id&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">transaction_id</span><span class="o">);</span>
</span></span></code></pre></div><h3 id="65修改paycontroller">6.5修改PayController</h3>
<p>修改com.offcn.pay.controller.PayController中查询交易状态的方法queryPayStatus，
支付成功调用orderFeign修改订单的状态以及日志信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                        <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">)!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;tradestatus&#34;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;TRADE_SUCCESS&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span><span class="o">=</span><span class="k">new</span>  <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;支付成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">orderFeign</span><span class="o">.</span><span class="na">updateStatus</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;out_trade_no&#34;</span><span class="o">),</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;trade_no&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="7dongyimai-pay-service集成springsecurity环境及网关配置">7.dongyimai-pay-service集成SpringSecurity环境及网关配置</h2>
<h3 id="71-pomxml加入如下依赖">7.1 pom.xml加入如下依赖</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-order-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>druid-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--oauth依赖--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="72-引入公钥和验证文件">7.2 引入公钥和验证文件</h3>
<p>将public.key和文件ResourceServerConfig拷贝到dongyimai-pay-service中，参考其他项目</p>
<h3 id="73-引入feigninterceptor">7.3 引入FeignInterceptor</h3>
<p>在PayController引入FeignInterceptor</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">FeignInterceptor</span> <span class="nf">feignInterceptor</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">FeignInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="74修改网关配置路由转发到支付微服务">7.4、修改网关配置，路由转发到支付微服务</h3>
<p>application.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai_pay_route</span><span class="w"> </span><span class="c">#支付微服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://PAY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">Path=/api/pay/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span></code></pre></div><h2 id="8测试">8.测试</h2>
<h3 id="81用户登录">8.1用户登录</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172704393.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="82-添加购物车">8.2 添加购物车</h3>
<p>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1324601&amp;num=5</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172709159.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="83查询购物车">8.3查询购物车</h3>
<p>http://localhost:8001/api/cart/findCartList</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172714248.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="84提交订单">8.4提交订单</h3>
<p>http://localhost:8001/api/order/</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172720605.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="85-查询redis">8.5 查询redis</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172730564.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="86查询数据库">8.6查询数据库</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172735524.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="87-预下单">8.7 预下单</h3>
<p>http://localhost:8001/api/pay/createNative</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172740117.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="88生成二维码">8.8生成二维码</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172745729.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="89-扫描支付并查询交易状态">8.9 扫描支付并查询交易状态</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172754703.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="810查看数据库">8.10查看数据库：</h3>
<p><img src="/posts/project-0/20220528172145/image-20220528172804970.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>订单状态也已经被修改为1</p>
<p><img src="/posts/project-0/20220528172145/image-20220528172810738.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="六-支付日志显示学员实现">六 支付日志显示（学员实现）</h1>
<p>需求：在运营商后台中，显示支付日志列表，实现按日期、状态、用户进行查询。</p>
<p>学员实现。</p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528171137/">← 提交订单</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220528172837/">秒杀1 →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>


  
  <script src="/js/jquery.pjax.js"></script> 

    <script type="text/javascript">
            $(function () {
                $(document).pjax('a', '#page', {
                    fragment: '#page',
                    timeout: 5000,
                    cache: false
                });
                $(document).on({
                    'pjax:click': function () {
                        
                        console.log("点击链接");
                    },
                    'pjax:start': function () {
                        
                        console.log("获取请求");
                    },
                    'pjax:end': function () {
                        
                        console.log("请求完成");
                    }
                });
            });


        </script>





<script>
  const imgArr = [
    "https://pic1.zhimg.com/80/v2-23d671bf74a246c54b1256bd2322d461_720w.webp?source=1940ef5c",
    "https://pic1.zhimg.com/80/v2-3afad658b44f596b10ec13b2b6d4299d_720w.webp?source=1940ef5c",
    "https://picx.zhimg.com/80/v2-b83d637fafb72fd13a5922aa0038bff9_720w.webp?source=1940ef5c",
    "https://pic1.zhimg.com/80/v2-3afad658b44f596b10ec13b2b6d4299d_720w.webp?source=1940ef5c",
    "https://pic1.zhimg.com/80/v2-7ee6f104979814d2bf420461e3872475_720w.webp?source=1940ef5c",
    "https://picx.zhimg.com/80/v2-585754b4ab4d49f480b833cbbbf4839f_720w.webp?source=1940ef5c",
    "https://pic1.zhimg.com/80/v2-b3d8f74192b2940a1112c93797cc0815_720w.webp?source=1940ef5c",
  ];
  var objs = document.getElementsByClassName('page-img');
  for (var i = 0; i < objs.length; i++) {
    objs[i].id = "myid" + i;
    let randNum = Math.floor(Math.random() * imgArr.length);
    var odiv = document.getElementById("myid" + i);
    odiv.style.backgroundImage = `url(${imgArr[randNum]})`;
    
    odiv.style.backgroundRepeat = "no-repeat";
    odiv.style.backgroundPosition = "0px 0px";
  }
</script>

<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>