<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="ElasticSearch - https://lovemjh.github.io/posts/tool/20220526220934/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>ElasticSearch</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.github.io/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            ElasticSearch
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-26&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-26&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            11088 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            23 分钟</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.github.io/posts/tool/20220526204447/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.github.io/posts/java-frame/20220526214937/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1-认识elasticsearch">1 认识ElasticSearch</a>
      <ul>
        <li><a href="#一基于数据库查询的问题">（一）基于数据库查询的问题</a></li>
        <li><a href="#二倒排索引">（二）倒排索引</a>
          <ul>
            <li><a href="#1-倒排索引概念">1 倒排索引概念</a></li>
            <li><a href="#2-倒排索引案例">2 倒排索引案例</a></li>
          </ul>
        </li>
        <li><a href="#三elasticsearch存储和查询的原理">（三）ElasticSearch存储和查询的原理</a></li>
        <li><a href="#四elasticsearch概念详解">（四）ElasticSearch概念详解</a></li>
      </ul>
    </li>
    <li><a href="#2-安装elasticsearch">2 安装ElasticSearch</a>
      <ul>
        <li><a href="#一elasticsearch安装">（一）ElasticSearch安装</a>
          <ul>
            <li><a href="#1-上传elasticsearch安装包">1 上传ElasticSearch安装包</a></li>
            <li><a href="#2-执行解压操作">2 执行解压操作</a></li>
            <li><a href="#3-创建普通用户">3 创建普通用户</a></li>
            <li><a href="#4-为新用户授权如下图">4 为新用户授权，如下图</a></li>
            <li><a href="#5-修改elasticsearchyml文件">5 修改elasticsearch.yml文件</a></li>
            <li><a href="#6-修改虚拟机的配置文件">6 修改虚拟机的配置文件</a></li>
            <li><a href="#7-启动elasticsearch">7 启动ElasticSearch</a></li>
            <li><a href="#8-查看elasticsearch是否启动">8 查看ElasticSearch是否启动</a></li>
          </ul>
        </li>
        <li><a href="#二访问elasticsearch">（二）访问ElasticSearch</a>
          <ul>
            <li><a href="#1-关闭防火墙">1 关闭防火墙</a></li>
            <li><a href="#2-浏览器访问">2 浏览器访问</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-elasticsearch辅助工具安装">3 ElasticSearch辅助工具安装</a>
      <ul>
        <li><a href="#一-postman-介绍和安装">（一） Postman 介绍和安装</a></li>
        <li><a href="#二-kibana介绍安装">（二） Kibana介绍&amp;安装</a>
          <ul>
            <li><a href="#1-什么是kibana">1 什么是Kibana</a></li>
            <li><a href="#2-kibana安装">2 Kibana安装</a>
              <ul>
                <li><a href="#21-上传kibana">2.1 上传kibana</a></li>
                <li><a href="#22-解压kibana到安装目录">2.2 解压kibana到安装目录</a></li>
                <li><a href="#23-修改kibana配置">2.3 修改kibana配置</a></li>
                <li><a href="#24-启动kibana">2.4 启动kibana</a></li>
                <li><a href="#25-访问kibane">2.5 访问kibane</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#三ik分词器安装">（三）IK分词器安装</a>
          <ul>
            <li><a href="#1-环境准备">1 环境准备</a>
              <ul>
                <li><a href="#11-设置java_home">1.1 设置JAVA_HOME</a></li>
                <li><a href="#12-下载maven安装包">1.2 下载maven安装包</a></li>
                <li><a href="#13-解压maven安装包">1.3 解压maven安装包</a></li>
                <li><a href="#14-设置软连接">1.4 设置软连接</a></li>
                <li><a href="#15-设置path">1.5 设置path</a></li>
                <li><a href="#16-验证maven是否安装成功">1.6 验证maven是否安装成功</a></li>
                <li><a href="#17-设置maven的阿里云镜像">1.7 设置maven的阿里云镜像</a></li>
              </ul>
            </li>
            <li><a href="#2-安装ik分词器">2 安装IK分词器</a>
              <ul>
                <li><a href="#21-下载ik分词器">2.1 下载IK分词器</a></li>
                <li><a href="#22-解压ik到指定目录">2.2 解压IK到指定目录</a></li>
                <li><a href="#23-编译jar包">2.3 编译jar包</a></li>
                <li><a href="#24-jar包移动">2.4 jar包移动</a></li>
                <li><a href="#25-拷贝词典">2.5 拷贝词典</a></li>
                <li><a href="#26-重新启动">2.6 重新启动</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#四使用ik分词器">（四）使用IK分词器</a>
          <ul>
            <li><a href="#1-ik分词器使用">1 IK分词器使用</a>
              <ul>
                <li><a href="#11ik_max_word">1.1ik_max_word</a></li>
                <li><a href="#12-ik_smart">1.2 ik_smart</a></li>
                <li><a href="#13-使用ik分词器查询文档">1.3 使用IK分词器查询文档</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4-elasticsearch核心概念">4 ElasticSearch核心概念</a></li>
    <li><a href="#5-脚本操作elasticsearch">5 脚本操作ElasticSearch</a>
      <ul>
        <li><a href="#一restful风格介绍">（一）RESTful风格介绍</a></li>
        <li><a href="#二操作索引">（二）操作索引</a>
          <ul>
            <li><a href="#1-创建索引put">1 创建索引（PUT）</a></li>
            <li><a href="#2-查询索引get">2 查询索引（GET）</a></li>
            <li><a href="#3-删除索引delete">3 删除索引（DELETE）</a></li>
            <li><a href="#4-关闭打开索引了解">4 关闭、打开索引（了解）</a></li>
          </ul>
        </li>
        <li><a href="#三elasticsearch-数据类型">（三）ElasticSearch 数据类型</a>
          <ul>
            <li><a href="#1-简单数据类型">1 简单数据类型</a></li>
            <li><a href="#2-复杂数据类型">2 复杂数据类型</a></li>
          </ul>
        </li>
        <li><a href="#四操作映射">（四）操作映射</a>
          <ul>
            <li><a href="#1-查询映射">1 查询映射</a></li>
            <li><a href="#2-创建映射">2 创建映射</a>
              <ul>
                <li><a href="#21-创建索引后添加映射">2.1 创建索引后添加映射</a></li>
                <li><a href="#22-创建索引并添加映射">2.2 创建索引并添加映射</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#五-操作文档">（五） 操作文档</a>
          <ul>
            <li><a href="#1-查询文档">1 查询文档</a></li>
            <li><a href="#2-添加文档指定id">2 添加文档，指定id</a></li>
            <li><a href="#3-删除文档">3 删除文档</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#7-elasticsearch-javaapi">7 ElasticSearch JavaAPI</a>
      <ul>
        <li><a href="#一springboot整合elasticsearch环境搭建">（一）SpringBoot整合ElasticSearch环境搭建</a>
          <ul>
            <li><a href="#1-搭建springboot工程">1 搭建SpringBoot工程</a></li>
            <li><a href="#2-引入elasticsearch相关坐标">2 引入ElasticSearch相关坐标</a></li>
            <li><a href="#3-编写核心配置类">3 编写核心配置类</a></li>
            <li><a href="#4-测试客户端对象">4 测试客户端对象</a></li>
          </ul>
        </li>
        <li><a href="#二操作elasticsearch">（二）操作ElasticSearch</a>
          <ul>
            <li><a href="#1-添加索引">1 添加索引</a></li>
            <li><a href="#2--添加索引并添加映射">2  添加索引，并添加映射</a></li>
            <li><a href="#3-查询删除判断索引">3 查询、删除、判断索引</a>
              <ul>
                <li><a href="#31-查询索引">3.1 查询索引</a></li>
                <li><a href="#32-删除索引">3.2 删除索引</a></li>
                <li><a href="#33-索引是否存在">3.3 索引是否存在</a></li>
              </ul>
            </li>
            <li><a href="#4-操作文档">4 操作文档</a>
              <ul>
                <li><a href="#41--添加文档">4.1  添加文档</a></li>
                <li><a href="#42-修改文档添加文档时如果id存在则修改id不存在则添加">4.2 修改文档：添加文档时，如果id存在则修改，id不存在则添加</a></li>
                <li><a href="#43-根据id查询文档">4.3 根据id查询文档</a></li>
                <li><a href="#44-根据id删除文档">4.4 根据id删除文档</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#三elasticsearch的批量操作">（三）ElasticSearch的批量操作</a>
          <ul>
            <li><a href="#1-bulk-批量操作脚本实现">1 bulk 批量操作脚本实现</a></li>
            <li><a href="#2-bulk批量操作javaapi-实现">2 bulk批量操作JavaAPI 实现</a></li>
            <li><a href="#3-导入数据分析创建索引">3 导入数据分析&amp;创建索引</a></li>
            <li><a href="#4-导入数据代码实现">4 导入数据代码实现</a></li>
          </ul>
        </li>
        <li><a href="#四elasticsearch高级查询">（四）ElasticSearch高级查询</a>
          <ul>
            <li><a href="#1-matchall脚本实现">1 matchAll脚本实现</a></li>
            <li><a href="#2-matchall-javaapi">2 matchAll-JavaAPI</a></li>
            <li><a href="#3-termquery-词条查询">3 termQuery 词条查询</a></li>
            <li><a href="#4-matchquery">4 matchQuery</a></li>
            <li><a href="#5-模糊查询脚本实现">5 模糊查询脚本实现</a></li>
            <li><a href="#6-模糊查询javaapi">6 模糊查询javaAPI</a></li>
            <li><a href="#7-范围查询脚本实现">7 范围查询脚本实现</a></li>
            <li><a href="#8-范围查询api实现">8 范围查询API实现</a></li>
            <li><a href="#9-querystring-查询">9 queryString 查询</a></li>
            <li><a href="#10-querystring-javaapi代码实现">10 queryString javaAPI代码实现：</a></li>
            <li><a href="#11-聚合查询脚本实现">11 聚合查询脚本实现</a></li>
            <li><a href="#12-聚合查询javaapi">12 聚合查询JavaAPI</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 id="1-认识elasticsearch">1 认识ElasticSearch</h1>
<h2 id="一基于数据库查询的问题">（一）基于数据库查询的问题</h2>
<p><img src="/posts/tool/20220526220934/image-20220526221044127.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>需求： 查询title中包含‘手机’ 的信息？</p>
<p>实现：SELECT * FROM tb_item WHERE title LIKE &lsquo;%手机%&rsquo;;</p>
<p>问题：</p>
<p>（1）性能低：如果是模糊查询，坐标有通配符，不会走索引，会进行全表扫描，性能低。</p>
<p>（2）功能弱：如果以”华为手机“作为条件，查询不出来数据。</p>
<p>解决：使用ES就可以<strong>倒排索引</strong>就可以解决上述存在的问题</p>
<h2 id="二倒排索引">（二）倒排索引</h2>
<h3 id="1-倒排索引概念">1 倒排索引概念</h3>
<p><strong>倒排索引</strong>：将文档进行分词，形成词条和id的对应关系即为反向索引。</p>
<h3 id="2-倒排索引案例">2 倒排索引案例</h3>
<p>以唐诗为例，所处包含“前”的诗句？</p>
<p>正向索引：由《静夜思》&ndash;&gt;床前明月光&mdash;&gt;“前”字</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>&laquo;静夜思&raquo;</td>
<td>窗前明月光，疑是地上霜&hellip;</td>
</tr>
<tr>
<td>&laquo;水调歌头&raquo;</td>
<td>明月几时有，把酒问青天&hellip;</td>
</tr>
<tr>
<td>&laquo;春晓&raquo;</td>
<td>春眠不觉晓，处处闻啼鸟&hellip;</td>
</tr>
</tbody>
</table>
<p>反向索引：</p>
<p>“床前明月光”&ndash;&gt; 分词</p>
<p>将一段文本按照一定的规则，拆分为不同的词条（term）
<img src="/posts/tool/20220526220934/image-20220526221103534.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>案例：明月几时有，分词。分词效果如下
<img src="/posts/tool/20220526220934/image-20220526221111950.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="三elasticsearch存储和查询的原理">（三）ElasticSearch存储和查询的原理</h2>
<p><strong>index（索引）</strong>：相当于mysql的库</p>
<p><strong>映射</strong>：相当于mysql 的表结构</p>
<p><strong>document(文档)</strong>：相当于mysql的表中的数据</p>
<p>Es使用倒排索引，对title 进行分词
<img src="/posts/tool/20220526220934/image-20220526221139841.png"
    
    
    
    loading="lazy"
    
    
></p>
<ol>
<li>
<p>使用“手机”作为关键字查询</p>
<p>生成的倒排索引中，词条会排序，形成一颗树形结构，提升词条的查询速度</p>
</li>
<li>
<p>使用“华为手机”作为关键字查询</p>
<p>华为：1,3</p>
<p>手机：1,2,3
<img src="/posts/tool/20220526220934/image-20220526221146485.png"
    
    
    
    loading="lazy"
    
    
></p>
</li>
</ol>
<h2 id="四elasticsearch概念详解">（四）ElasticSearch概念详解</h2>
<p>ElasticSearch是一个基于Lucene的搜索服务器
<img src="/posts/tool/20220526220934/image-20220526221155547.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>是一个分布式、高扩展、高实时的搜索与数据分析引擎</p>
<p>基于RESTful web接口</p>
<p>Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎</p>
<p>官网：https://www.elastic.co/</p>
<p>应用场景</p>
<p>搜索：海量数据的查询</p>
<p>日志数据分析</p>
<p>实时数据分析</p>
<h1 id="2-安装elasticsearch">2 安装ElasticSearch</h1>
<h2 id="一elasticsearch安装">（一）ElasticSearch安装</h2>
<h3 id="1-上传elasticsearch安装包">1 上传ElasticSearch安装包</h3>
<p><img src="/posts/tool/20220526220934/image-20220526221228208.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="2-执行解压操作">2 执行解压操作</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">#创建一个安装目录 </span>
</span></span><span style="display:flex;"><span> mkdir /usr/local/es
</span></span><span style="display:flex;"><span> <span style="color:#998;font-style:italic">#将elasticsearch-7.4.0-linux-x86_64.tar.gz解压到/usr/local/es 目录下. -C 大写</span>
</span></span><span style="display:flex;"><span> tar -zxvf elasticsearch-7.4.0-linux-x86_64.tar.gz  -C /usr/local/es
</span></span></code></pre></div><h3 id="3-创建普通用户">3 创建普通用户</h3>
<p>因为安全问题，Elasticsearch 不允许root用户直接运行，所以要创建新用户，在root用户中创建新用户,执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>useradd offcn  <span style="color:#998;font-style:italic">#新增offcn账户</span>
</span></span><span style="display:flex;"><span>passwd offcn   <span style="color:#998;font-style:italic">#为offcn账户设置密码</span>
</span></span></code></pre></div><h3 id="4-为新用户授权如下图">4 为新用户授权，如下图</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>chown -R offcn:offcn /usr/local/es/elasticsearch-7.4.0 <span style="color:#998;font-style:italic">#文件夹所有者</span>
</span></span></code></pre></div><p><img src="/posts/tool/20220526220934/image-20220526221241011.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>将 /usr/local/es/elasticsearch-7.4.0文件夹授权给offcn用户，由上图可见，我们的文件夹权限赋给了offcn</p>
<h3 id="5-修改elasticsearchyml文件">5 修改elasticsearch.yml文件</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim /usr/local/es/elasticsearch-7.4.0/config/elasticsearch.yml 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ======================== Elasticsearch Configuration =========================</span>
</span></span><span style="display:flex;"><span>cluster.name: my-application
</span></span><span style="display:flex;"><span>node.name: node-1
</span></span><span style="display:flex;"><span>network.host: 0.0.0.0
</span></span><span style="display:flex;"><span>http.port: <span style="color:#099">9200</span>
</span></span><span style="display:flex;"><span>cluster.initial_master_nodes: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;node-1&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>cluster.name：配置elasticsearch的集群名称，默认是elasticsearch。建议修改成一个有意义的名称</p>
<p>node.name：节点名，elasticsearch会默认随机指定一个名字，建议指定一个有意义的名称，方便管理</p>
<p>network.host：设置为0.0.0.0允许外网访问</p>
<p>http.port：Elasticsearch的http访问端口</p>
<p>cluster.initial_master_nodes：初始化新的集群时需要此配置来选举master</p>
<h3 id="6-修改虚拟机的配置文件">6 修改虚拟机的配置文件</h3>
<p>新创建的offcn用户最大可创建文件数太小，最大虚拟内存太小，切换到root用户，编辑下列配置文件， 添加类似如下内容</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 切换到root用户</span>
</span></span><span style="display:flex;"><span>su root 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#1. ===最大可创建文件数太小=======</span>
</span></span><span style="display:flex;"><span>vim /etc/security/limits.conf 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 在文件末尾中增加下面内容</span>
</span></span><span style="display:flex;"><span>offcn soft nofile <span style="color:#099">65536</span>
</span></span><span style="display:flex;"><span>offcn hard nofile <span style="color:#099">65536</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#===========</span>
</span></span><span style="display:flex;"><span>vim /etc/security/limits.d/20-nproc.conf
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 在文件末尾中增加下面内容</span>
</span></span><span style="display:flex;"><span>offcn soft nofile <span style="color:#099">65536</span>
</span></span><span style="display:flex;"><span>offcn hard nofile <span style="color:#099">65536</span>
</span></span><span style="display:flex;"><span>*  hard    nproc     <span style="color:#099">4096</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注：* 代表Linux所有用户名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2. ===最大虚拟内存太小=======</span>
</span></span><span style="display:flex;"><span>vim /etc/sysctl.conf
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 在文件中增加下面内容</span>
</span></span><span style="display:flex;"><span>vm.max_map_count<span style="color:#000;font-weight:bold">=</span><span style="color:#099">655360</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 重新加载，输入下面命令：</span>
</span></span><span style="display:flex;"><span>sysctl -p
</span></span></code></pre></div><h3 id="7-启动elasticsearch">7 启动ElasticSearch</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>su offcn    <span style="color:#998;font-style:italic">#切换到offcn 用户启动</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/es/elasticsearch-7.4.0/bin
</span></span><span style="display:flex;"><span>./elasticsearch <span style="color:#998;font-style:italic">#启动</span>
</span></span></code></pre></div><p><img src="/posts/tool/20220526220934/image-20220526221256705.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>通过上图我们可以看到elasticsearch已经成功启动</p>
<h3 id="8-查看elasticsearch是否启动">8 查看ElasticSearch是否启动</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ps -ef|grep elastic
</span></span></code></pre></div><h2 id="二访问elasticsearch">（二）访问ElasticSearch</h2>
<h3 id="1-关闭防火墙">1 关闭防火墙</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#暂时关闭防火墙</span>
</span></span><span style="display:flex;"><span>systemctl  stop  firewalld.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 或者</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#永久设置防火墙状态</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> firewalld.service  <span style="color:#998;font-style:italic">#打开防火墙永久性生效，重启后不会复原 </span>
</span></span><span style="display:flex;"><span>systemctl disable firewalld.service <span style="color:#998;font-style:italic">#关闭防火墙，永久性生效，重启后不会复原 </span>
</span></span></code></pre></div><h3 id="2-浏览器访问">2 浏览器访问</h3>
<p><img src="/posts/tool/20220526220934/image-20220526221313772.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>说明： 此时elasticsearch已成功启动</p>
<pre tabindex="0"><code>重点几个关注下即可:
number&#34; : &#34;7.4.0&#34;   表示elasticsearch版本
lucene_version&#34; : &#34;8.2.0&#34;  表示lucene版本
name ： 默认启动的时候指定了 ES 实例名称
cluster_name ： 默认名为 elasticsearch
</code></pre><h1 id="3-elasticsearch辅助工具安装">3 ElasticSearch辅助工具安装</h1>
<h2 id="一-postman-介绍和安装">（一） Postman 介绍和安装</h2>
<p>Postman是一个http模拟请求的工具。</p>
<p>官网介绍：“Modern software is built on APIs，Postman helps you develop APIs faster”</p>
<p>看得出来，它是一个专门测试 API 的工具，Postman 提供功能强大的 Web API 和 HTTP 请求的调试，它能够发送任何类型的HTTP 请求 (GET, POST, PUT, DELETE…)，并且能附带任何数量的参数和 Headers。不仅如此，它还提供测试数据和环境配置数据的导入导出。</p>
<p>进入官网www.getpostman.com，下载</p>
<h2 id="二-kibana介绍安装">（二） Kibana介绍&amp;安装</h2>
<h3 id="1-什么是kibana">1 什么是Kibana</h3>
<p>Kibana是一个针对Elasticsearch的开源分析及可视化平台，用来搜索、查看交互存储在Elasticsearch索引中的数据。使用Kibana，可以通过各种图表进行高级数据分析及展示。</p>
<p>Kibana让海量数据更容易理解。它操作简单，基于浏览器的用户界面可以快速创建仪表板（dashboard）实时显示Elasticsearch查询动态。</p>
<h3 id="2-kibana安装">2 Kibana安装</h3>
<h4 id="21-上传kibana">2.1 上传kibana</h4>
<p><img src="/posts/tool/C:%5cUsers%5cAdministrator%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5c1615536058337.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="22-解压kibana到安装目录">2.2 解压kibana到安装目录</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#创建安装目录</span>
</span></span><span style="display:flex;"><span>mkdir /usr/local/kibana
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#将kibana解压到安装目录</span>
</span></span><span style="display:flex;"><span>tar -zxvf kibana-7.4.0-linux-x86_64.tar.gz -C /usr/local/kibana
</span></span></code></pre></div><h4 id="23-修改kibana配置">2.3 修改kibana配置</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim /usr/local/kibana/kibana-7.4.0-linux-x86_64/config/kibana.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>server.port: <span style="color:#099">5601</span>
</span></span><span style="display:flex;"><span>server.host: <span style="color:#d14">&#34;0.0.0.0&#34;</span>
</span></span><span style="display:flex;"><span>server.name: <span style="color:#d14">&#34;kibana-offcn&#34;</span>
</span></span><span style="display:flex;"><span>elasticsearch.hosts: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;http://127.0.0.1:9200&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>elasticsearch.requestTimeout: <span style="color:#099">99999</span>
</span></span></code></pre></div><p>server.port：http访问端口</p>
<p>server.host：ip地址，0.0.0.0表示可远程访问</p>
<p>server.name：kibana服务名</p>
<p>elasticsearch.hosts：elasticsearch地址</p>
<p>elasticsearch.requestTimeout：请求elasticsearch超时时间，默认为30000，此处可根据情况设置</p>
<h4 id="24-启动kibana">2.4 启动kibana</h4>
<p>由于kibana不建议使用root用户启动，如果用root启动，需要加&ndash;allow-root参数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 切换到kibana的bin目录</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/kibana/kibana-7.4.0-linux-x86_64/bin
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>./kibana --allow-root
</span></span></code></pre></div><p><img src="/posts/tool/20220526220934/image-20220526221325710.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>启动成功。</p>
<h4 id="25-访问kibane">2.5 访问kibane</h4>
<pre tabindex="0"><code>访问地址： http://192.168.126.20:5601/
</code></pre><p><img src="/posts/tool/20220526220934/image-20220526221331884.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="三ik分词器安装">（三）IK分词器安装</h2>
<h3 id="1-环境准备">1 环境准备</h3>
<p>Elasticsearch 要使用 ik，就要先构建 ik 的 jar包，这里要用到 maven 包管理工具，而 maven 需要java 环境，而 Elasticsearch 内置了jdk， 所以可以将JAVA_HOME设置为Elasticsearch 内置的jdk</p>
<h4 id="11-设置java_home">1.1 设置JAVA_HOME</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim /etc/profile
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 在profile文件末尾添加</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#java environment</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">export</span> <span style="color:#008080">JAVA_HOME</span><span style="color:#000;font-weight:bold">=</span>/usr/local/es/elasticsearch-7.4.0/jdk
</span></span><span style="display:flex;"><span><span style="color:#0086b3">export</span> <span style="color:#008080">PATH</span><span style="color:#000;font-weight:bold">=</span><span style="color:#008080">$PATH</span>:<span style="color:#d14">${</span><span style="color:#008080">JAVA_HOME</span><span style="color:#d14">}</span>/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 保存退出后，重新加载profile</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">source</span> /etc/profile
</span></span></code></pre></div><h4 id="12-下载maven安装包">1.2 下载maven安装包</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#安装包较小，直接使用wget命令下载，下载的默认位置，当前所在的位置</span>
</span></span><span style="display:flex;"><span>wget http://mirror.cc.columbia.edu/pub/software/apache/maven/maven-3/3.1.1/binaries/apache-maven-3.1.1-bin.tar.gz 
</span></span></code></pre></div><h4 id="13-解压maven安装包">1.3 解压maven安装包</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#创建maven的安装包</span>
</span></span><span style="display:flex;"><span>mkdir /usr/local/maven/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#解压到指定的目录</span>
</span></span><span style="display:flex;"><span>tar -zxvf apache-maven-3.1.1-bin.tar.gz -C /usr/local/maven/
</span></span></code></pre></div><h4 id="14-设置软连接">1.4 设置软连接</h4>
<pre tabindex="0"><code>ln -s apache-maven-3.1.1 maven 
</code></pre><h4 id="15-设置path">1.5 设置path</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#打开文件 </span>
</span></span><span style="display:flex;"><span>vim  /etc/profile.d/maven.sh
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#将下面的内容复制到文件，保存 </span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">export</span> <span style="color:#008080">MAVEN_HOME</span><span style="color:#000;font-weight:bold">=</span>/usr/local/maven/maven  
</span></span><span style="display:flex;"><span><span style="color:#0086b3">export</span> <span style="color:#008080">PATH</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">${</span><span style="color:#008080">MAVEN_HOME</span><span style="color:#d14">}</span>/bin:<span style="color:#d14">${</span><span style="color:#008080">PATH</span><span style="color:#d14">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#设置好Maven的路径之后，需要运行下面的命令使其生效</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">source</span> /etc/profile.d/maven.sh
</span></span></code></pre></div><h4 id="16-验证maven是否安装成功">1.6 验证maven是否安装成功</h4>
<pre tabindex="0"><code>mvn -v
</code></pre><h4 id="17-设置maven的阿里云镜像">1.7 设置maven的阿里云镜像</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;mirror&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;id&gt;</span>alimaven<span style="color:#000080">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;name&gt;</span>aliyun maven<span style="color:#000080">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span style="color:#000080">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;mirrorOf&gt;</span>central<span style="color:#000080">&lt;/mirrorOf&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/mirror&gt;</span> 
</span></span></code></pre></div><h3 id="2-安装ik分词器">2 安装IK分词器</h3>
<h4 id="21-下载ik分词器">2.1 下载IK分词器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/medcl/elasticsearch-analysis-ik/archive/v7.4.0.zip
</span></span></code></pre></div><h4 id="22-解压ik到指定目录">2.2 解压IK到指定目录</h4>
<p>由于这里是zip包不是gz包，所以我们需要使用unzip命令进行解压，如果本机环境没有安装unzip，请执行：</p>
<pre tabindex="0"><code>yum install zip 
yum install unzip
</code></pre><p>解压IK</p>
<pre tabindex="0"><code>unzip v7.4.0.zip
</code></pre><h4 id="23-编译jar包">2.3 编译jar包</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 切换到 elasticsearch-analysis-ik-7.4.0目录</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> elasticsearch-analysis-ik-7.4.0/
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#打包，注意第一次使用maven会比较慢，提前配置好阿里云镜像</span>
</span></span><span style="display:flex;"><span>mvn package
</span></span></code></pre></div><h4 id="24-jar包移动">2.4 jar包移动</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#切换目录</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/es/elasticsearch-7.4.0/plugins/
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#新建目录</span>
</span></span><span style="display:flex;"><span>mkdir analysis-ik
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> analysis-ik
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#执行拷贝</span>
</span></span><span style="display:flex;"><span>cp -R /opt/elasticsearch-analysis-ik-7.4.0/target/releases/elasticsearch-analysis-ik-7.4.0.zip      /usr/local/es/elasticsearch-7.4.0/plugins/analysis-ik
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#执行解压</span>
</span></span><span style="display:flex;"><span>unzip  /usr/local/es/elasticsearch-7.4.0/plugins/analysis-ik/elasticsearch-analysis-ik-7.4.0.zip
</span></span></code></pre></div><h4 id="25-拷贝词典">2.5 拷贝词典</h4>
<p>将elasticsearch-analysis-ik-7.4.0目录下的config目录中的所有文件 拷贝到elasticsearch的config目录</p>
<pre tabindex="0"><code>cp -R /opt/elasticsearch-analysis-ik-7.4.0/config/*   /usr/local/es/elasticsearch-7.4.0/config
</code></pre><h4 id="26-重新启动">2.6 重新启动</h4>
<p>配置成功之后，重新启动ES，重新启动Kibana，使用IK分词器。</p>
<h2 id="四使用ik分词器">（四）使用IK分词器</h2>
<h3 id="1-ik分词器使用">1 IK分词器使用</h3>
<p>IK分词器有两种分词模式：ik_max_word和ik_smart模式。</p>
<h4 id="11ik_max_word">1.1ik_max_word</h4>
<p>会将文本做最细粒度的拆分，比如会将“乒乓球明年总冠军”拆分为“乒乓球、乒乓、球、明年、总冠军、冠军。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#方式一</span> <span style="color:#a61717;background-color:#e3d2d2">ik_max_word</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/_analyze</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_max_word&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;text&#34;</span>: <span style="color:#d14">&#34;乒乓球明年总冠军&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ik_max_word分词器执行如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;tokens&#34;</span> : [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;乒乓球&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;乒乓&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">2</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;球&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">2</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_CHAR&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;明年&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;总冠军&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">8</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;冠军&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">6</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">8</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="12-ik_smart">1.2 ik_smart</h4>
<p>会做最粗粒度的拆分，比如会将“乒乓球明年总冠军”拆分为乒乓球、明年、总冠军。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#方式二ik_smart</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/_analyze</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_smart&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;text&#34;</span>: <span style="color:#d14">&#34;乒乓球明年总冠军&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ik_smart分词器执行如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;tokens&#34;</span> : [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;乒乓球&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;明年&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;token&#34;</span> : <span style="color:#d14">&#34;总冠军&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;start_offset&#34;</span> : <span style="color:#099">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;end_offset&#34;</span> : <span style="color:#099">8</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span> : <span style="color:#d14">&#34;CN_WORD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;position&#34;</span> : <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由此可见  使用ik_smart可以将文本&quot;text&quot;: &ldquo;乒乓球明年总冠军&quot;分成了【乒乓球】【明年】【总冠军】</p>
<p>这样看的话，这样的分词效果达到了我们的要求。</p>
<h4 id="13-使用ik分词器查询文档">1.3 使用IK分词器查询文档</h4>
<p>词条查询：term</p>
<p>​			词条查询不会分析查询条件，只有当词条和查询字符串完全匹配时才匹配搜索</p>
<p>全文查询：match</p>
<p>​           全文查询会分析查询条件，先将查询条件进行分词，然后查询，求并集</p>
<p>1.创建索引，添加映射，并指定分词器为ik分词器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">PUT</span> <span style="color:#a61717;background-color:#e3d2d2">person</span><span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;name&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;keyword&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;address&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_max_word&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;age&#34;</span>:{
</span></span><span style="display:flex;"><span>         <span style="color:#000080">&#34;type&#34;</span>:<span style="color:#d14">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>2.添加文档</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;北京海淀区&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;李四&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;北京朝阳区&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;王五&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;北京昌平区&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;赵六&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;昌平区慧聪园&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>3.查询映射</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">person</span><span style="color:#099">2</span>
</span></span></code></pre></div><p><img src="/posts/tool/20220526220934/image-20220526221919810.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>4.查看分词效果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">_analyze</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_max_word&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;text&#34;</span>: <span style="color:#d14">&#34;北京海淀&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>5.词条查询：term</p>
<p>查询person2中匹配到&quot;北京&quot;两字的词条</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;term&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;address&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;value&#34;</span>: <span style="color:#d14">&#34;北京&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>6.全文查询：match</p>
<p>全文查询会分析查询条件，先将查询条件进行分词，然后查询，求并集</p>
<pre tabindex="0"><code>GET /person2/_search
{
  &#34;query&#34;: {
    &#34;match&#34;: {
      &#34;address&#34;:&#34;北京昌平&#34;
    }
  }
}
</code></pre><h1 id="4-elasticsearch核心概念">4 ElasticSearch核心概念</h1>
<p><strong>索引（index）</strong></p>
<p>ElasticSearch存储数据的地方，可以理解成关系型数据库中的数据库概念。</p>
<p><strong>映射（mapping）</strong></p>
<p>mapping定义了每个字段的类型、字段所使用的分词器等。相当于关系型数据库中的表结构。</p>
<p><strong>文档（document）</strong></p>
<p>Elasticsearch中的最小数据单元，常以json格式显示。一个document相当于关系型数据库中的一行数据。</p>
<p><strong>倒排索引</strong></p>
<p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，对应一个包含它的文档id列表。</p>
<p><strong>类型（type）</strong></p>
<p>一种type就像一类表。如用户表、角色表等。在Elasticsearch7.X默认type为_doc</p>
<pre><code>ES 5.x中一个index可以有多种type。
ES 6.x中一个index只能有一种type。
ES 7.x以后，将逐步移除type这个概念，现在的操作已经不再使用，默认_doc
</code></pre>
<h1 id="5-脚本操作elasticsearch">5 脚本操作ElasticSearch</h1>
<h2 id="一restful风格介绍">（一）RESTful风格介绍</h2>
<p>Restful就是一个资源定位及资源操作的风格。不是标准也不是协议，只是一种风格。基于这个风格设计的软件可以更简洁，更有层次，可以降低开发的复杂性，提高系统的可伸缩性。</p>
<p>特点：</p>
<p>1.基于http协议</p>
<p>2.使用XML格式定义或JSON格式定义</p>
<p>3.每一个URI代表1种资源。</p>
<p>4.客户端使用GET、POST、PUT、DELETE 4个表示操作方式的动词对服务端资源进行操作：</p>
<p>GET：用来获取资源</p>
<p>POST：用来新建资源（也可以用于更新资源）</p>
<p>PUT：用来更新资源</p>
<p>DELETE：用来删除资源
<img src="/posts/tool/20220526220934/image-20220526221419329.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="二操作索引">（二）操作索引</h2>
<h3 id="1-创建索引put">1 创建索引（PUT）</h3>
<pre tabindex="0"><code>http://ip:端口/索引名称
案例： 
http://192.168.126.20:9200/index_01
</code></pre><h3 id="2-查询索引get">2 查询索引（GET）</h3>
<pre tabindex="0"><code>GET http://ip:端口/索引名称  # 查询单个索引信息
GET http://ip:端口/索引名称1,索引名称2...  # 查询多个索引信息
GET http://ip:端口/_all  # 查询所有索引信息
</code></pre><h3 id="3-删除索引delete">3 删除索引（DELETE）</h3>
<pre tabindex="0"><code>DELETE http://ip:端口/索引名称
</code></pre><h3 id="4-关闭打开索引了解">4 关闭、打开索引（了解）</h3>
<pre tabindex="0"><code>POST http://ip:端口/索引名称/_close  
POST http://ip:端口/索引名称/_open 
</code></pre><h2 id="三elasticsearch-数据类型">（三）ElasticSearch 数据类型</h2>
<h3 id="1-简单数据类型">1 简单数据类型</h3>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>字符串</td>
<td>text ：会分词，不支持聚合    相当于mysql 中的sum（求和）</td>
</tr>
<tr>
<td></td>
<td>keyword：不会分词，将全部内容作为一个词条，支持聚合</td>
</tr>
<tr>
<td>数值</td>
<td>byte, short, integer, long, float, double</td>
</tr>
<tr>
<td>布尔</td>
<td>boolean</td>
</tr>
<tr>
<td>范围类型</td>
<td>integer_range, float_range, long_range, double_range, date_range</td>
</tr>
<tr>
<td>日期</td>
<td>date</td>
</tr>
</tbody>
</table>
<h3 id="2-复杂数据类型">2 复杂数据类型</h3>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>数组:  [ ]</td>
<td>nested (for arrays of JSON objects 数组类型的JSON对象)</td>
</tr>
<tr>
<td>对象：{ }</td>
<td>object(for single JSON objects 单个JSON对象)</td>
</tr>
</tbody>
</table>
<h2 id="四操作映射">（四）操作映射</h2>
<h3 id="1-查询映射">1 查询映射</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/索引的名称/_mapping</span>
</span></span></code></pre></div><h3 id="2-创建映射">2 创建映射</h3>
<h4 id="21-创建索引后添加映射">2.1 创建索引后添加映射</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#创建一个person</span> <span style="color:#a61717;background-color:#e3d2d2">索引</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">PUT</span> <span style="color:#a61717;background-color:#e3d2d2">person</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#查询person</span> <span style="color:#a61717;background-color:#e3d2d2">索引的mapping</span> <span style="color:#a61717;background-color:#e3d2d2">是空</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/person/_mapping</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#给person</span> <span style="color:#a61717;background-color:#e3d2d2">添加索引</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">PUT</span> <span style="color:#a61717;background-color:#e3d2d2">/person/_mapping</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;properties&#34;</span>:{
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;name&#34;</span>:{
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span>:<span style="color:#d14">&#34;text&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;age&#34;</span>:{
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span>:<span style="color:#d14">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="22-创建索引并添加映射">2.2 创建索引并添加映射</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#创建索引并且添加映射</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">PUT</span> <span style="color:#a61717;background-color:#e3d2d2">person</span><span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;name&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;type&#34;</span>:<span style="color:#d14">&#34;text&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;age&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#查询映射</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_mapping</span>
</span></span></code></pre></div><p>添加字段</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#给创建好的索引添加字段</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">PUT</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_mapping</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;properties&#34;</span>:{
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;address&#34;</span>:{
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;type&#34;</span>:<span style="color:#d14">&#34;text&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>总结：在实际当中 ，我们很少操作映射，一般都是使用API方式操作文档，所以以上的操作只需要能看懂就可以。</p>
<h2 id="五-操作文档">（五） 操作文档</h2>
<h3 id="1-查询文档">1 查询文档</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#根据id查询具体的文档</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">语法：</span> <span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/索引的名称/_doc/索引的id</span> 
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">案例：</span> <span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">1</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">1</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#查询所有的文档</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">语法：GET</span> <span style="color:#a61717;background-color:#e3d2d2">/索引名称/_search</span> 
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">案例：GET</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">1</span><span style="color:#a61717;background-color:#e3d2d2">/_search</span>
</span></span></code></pre></div><h3 id="2-添加文档指定id">2 添加文档，指定id</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#语法：POST</span> <span style="color:#a61717;background-color:#e3d2d2">/索引的名称/文档的类型/文档的id</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">2</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;北京&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#查询文档</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">1</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">1</span>
</span></span></code></pre></div><p>添加文档，不指定id</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#添加文档，不指定id</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">1</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;张三&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;北京&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#查询所有文档</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">1</span><span style="color:#a61717;background-color:#e3d2d2">/_search</span>
</span></span></code></pre></div><h3 id="3-删除文档">3 删除文档</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#删除指定id文档</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">DELETE</span> <span style="color:#a61717;background-color:#e3d2d2">/person</span><span style="color:#099">1</span><span style="color:#a61717;background-color:#e3d2d2">/_doc/</span><span style="color:#099">1</span>
</span></span></code></pre></div><h1 id="7-elasticsearch-javaapi">7 ElasticSearch JavaAPI</h1>
<h2 id="一springboot整合elasticsearch环境搭建">（一）SpringBoot整合ElasticSearch环境搭建</h2>
<h3 id="1-搭建springboot工程">1 搭建SpringBoot工程</h3>
<h3 id="2-引入elasticsearch相关坐标">2 引入ElasticSearch相关坐标</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--引入es的坐标--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.elasticsearch.client<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>elasticsearch-rest-high-level-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>7.4.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.elasticsearch.client<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>elasticsearch-rest-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>7.4.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.elasticsearch<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>elasticsearch<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>7.4.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="3-编写核心配置类">3 编写核心配置类</h3>
<p>编写核心配置文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">elasticsearch</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hostname</span>:<span style="color:#bbb"> </span><span style="color:#099">192.168.126.20</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9200</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>编写核心配置类</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@ConfigurationProperties</span><span style="color:#000;font-weight:bold">(</span>prefix<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;elasticsearch&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ElasticSearchConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String host<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">int</span> port<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> RestHighLevelClient <span style="color:#900;font-weight:bold">client</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestHighLevelClient<span style="color:#000;font-weight:bold">(</span>RestClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">builder</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">new</span> HttpHost<span style="color:#000;font-weight:bold">(</span>host<span style="color:#000;font-weight:bold">,</span>port<span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;http&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>  
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">getHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> host<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setHost</span><span style="color:#000;font-weight:bold">(</span>String host<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">host</span> <span style="color:#000;font-weight:bold">=</span> host<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">getPort</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> port<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> port<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">port</span> <span style="color:#000;font-weight:bold">=</span> port<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-测试客户端对象">4 测试客户端对象</h3>
<p>注意：使用@Autowired注入RestHighLevelClient 如果报红线，则是因为配置类所在的包和测试类所在的包，包名不一致造成的</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootTest</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringElasticsearchApplicationTests</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RestHighLevelClient restHighLevelClient<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">contextLoads</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>restHighLevelClient<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="二操作elasticsearch">（二）操作ElasticSearch</h2>
<h3 id="1-添加索引">1 添加索引</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 添加索引：
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">addIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Exception<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#998;font-style:italic">//1：使用restHighLevelClient获取操作索引的对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   IndicesClient indices <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>   <span style="color:#998;font-style:italic">//2: 具体操作索引，并且获得返回值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   <span style="color:#998;font-style:italic">//2.1 创建索引对象，设置索引的名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   CreateIndexRequest createIndexRequest <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CreateIndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#998;font-style:italic">//2.2 创建索引，获得返回值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   CreateIndexResponse createIndexResponse <span style="color:#000;font-weight:bold">=</span> indices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>createIndexRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#998;font-style:italic">//3:根据返回值判断返回结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>createIndexResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAcknowledged</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2--添加索引并添加映射">2  添加索引，并添加映射</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 创建索引并且添加映射
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * @throws IOException
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">addIndexAndMapping</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//1.使用client获取操作索引的对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndicesClient indicesClient <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2.具体操作，获取返回值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    CreateIndexRequest createRequest <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CreateIndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2.1 设置mappings
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String mapping <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;{\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;      \&#34;properties\&#34; : {\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;        \&#34;address\&#34; : {\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;          \&#34;type\&#34; : \&#34;text\&#34;,\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;          \&#34;analyzer\&#34; : \&#34;ik_max_word\&#34;\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;        },\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;        \&#34;age\&#34; : {\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;          \&#34;type\&#34; : \&#34;long\&#34;\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;        },\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;        \&#34;name\&#34; : {\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;          \&#34;type\&#34; : \&#34;keyword\&#34;\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;        }\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;      }\n&#34;</span> <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;    }&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    createRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">mapping</span><span style="color:#000;font-weight:bold">(</span>mapping<span style="color:#000;font-weight:bold">,</span> XContentType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">JSON</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2.2执行创建，返回对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    CreateIndexResponse response <span style="color:#000;font-weight:bold">=</span> indicesClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>createRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//3.根据返回值判断结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAcknowledged</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-查询删除判断索引">3 查询、删除、判断索引</h3>
<h4 id="31-查询索引">3.1 查询索引</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 查询索引
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">queryIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//1:使用client获取操作索引的对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndicesClient indices <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2:获得对象，执行具体的操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//2.1 创建获取索引的请求对象，设置索引名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    GetIndexRequest getReqeust <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> GetIndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2.2 执行查询，获得返回值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    GetIndexResponse response <span style="color:#000;font-weight:bold">=</span> indices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>getReqeust<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//3：获取结果,遍历
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> MappingMetaData<span style="color:#000;font-weight:bold">&gt;</span> mappings <span style="color:#000;font-weight:bold">=</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMappings</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String key <span style="color:#000;font-weight:bold">:</span> mappings<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">keySet</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>key <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;:&#34;</span> <span style="color:#000;font-weight:bold">+</span> mappings<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getSourceAsMap</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><h4 id="32-删除索引">3.2 删除索引</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 删除索引
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    IndicesClient indices <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    DeleteIndexRequest deleteRequest <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DeleteIndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    AcknowledgedResponse response <span style="color:#000;font-weight:bold">=</span> indices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>deleteRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAcknowledged</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="33-索引是否存在">3.3 索引是否存在</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 判断索引是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">existIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    IndicesClient indices <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    GetIndexRequest getRequest <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> GetIndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;person&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">boolean</span> exists <span style="color:#000;font-weight:bold">=</span> indices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">exists</span><span style="color:#000;font-weight:bold">(</span>getRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>exists<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-操作文档">4 操作文档</h3>
<h4 id="41--添加文档">4.1  添加文档</h4>
<p>添加文档,使用map作为数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 添加文档,使用map作为数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">addDoc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//数据对象，map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Map data <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;address&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;北京昌平&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;马同志&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#099">20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//1：获取操作文档的对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndexRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">id</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>data<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2：添加数据，获取结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndexResponse response <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//3：打印响应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>添加文档,使用对象作为数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 添加文档,使用对象作为数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">addDoc2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//数据对象，javaObject
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Person p <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Person<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setId</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;2&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;小胖2222&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#099">30</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAddress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;陕西西安&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//将对象转为json
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String data <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>p<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//1:获取操作文档的对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndexRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">id</span><span style="color:#000;font-weight:bold">(</span>p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>data<span style="color:#000;font-weight:bold">,</span> XContentType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">JSON</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2:添加数据，获取结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndexResponse response <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//3:打印响应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="42-修改文档添加文档时如果id存在则修改id不存在则添加">4.2 修改文档：添加文档时，如果id存在则修改，id不存在则添加</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 修改文档：添加文档时，如果id存在则修改，id不存在则添加
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateDoc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//数据对象，map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Map data <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;address&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;北京昌平&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;朱同志&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#099">20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//1：获取操作文档的对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndexRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">id</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>data<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2：添加数据，获取结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    IndexResponse response <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//3：打印响应结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="43-根据id查询文档">4.3 根据id查询文档</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 根据id查询文档
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">findDocById</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    GetRequest getReqeust <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> GetRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//getReqeust.id(&#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    GetResponse response <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>getReqeust<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取数据对应的json
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSourceAsString</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="44-根据id删除文档">4.4 根据id删除文档</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  * 根据id删除文档
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">delDoc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    DeleteRequest deleteRequest <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DeleteRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;offcn&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    DeleteResponse response <span style="color:#000;font-weight:bold">=</span> restHighLevelClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>deleteRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="三elasticsearch的批量操作">（三）ElasticSearch的批量操作</h2>
<h3 id="1-bulk-批量操作脚本实现">1 bulk 批量操作脚本实现</h3>
<p>需求：同时完成删除，更新，添加操作</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">_bulk</span>
</span></span><span style="display:flex;"><span>{<span style="color:#000080">&#34;delete&#34;</span>:{<span style="color:#000080">&#34;_index&#34;</span>:<span style="color:#d14">&#34;person1&#34;</span>,<span style="color:#000080">&#34;_id&#34;</span>:<span style="color:#d14">&#34;4&#34;</span>}}
</span></span><span style="display:flex;"><span>{<span style="color:#000080">&#34;create&#34;</span>:{<span style="color:#000080">&#34;_index&#34;</span>:<span style="color:#d14">&#34;person1&#34;</span>,<span style="color:#000080">&#34;_id&#34;</span>:<span style="color:#d14">&#34;5&#34;</span>}}
</span></span><span style="display:flex;"><span>{<span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;八号&#34;</span>,<span style="color:#000080">&#34;age&#34;</span>:<span style="color:#099">18</span>,<span style="color:#000080">&#34;address&#34;</span>:<span style="color:#d14">&#34;北京&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#000080">&#34;update&#34;</span>:{<span style="color:#000080">&#34;_index&#34;</span>:<span style="color:#d14">&#34;person1&#34;</span>,<span style="color:#000080">&#34;_id&#34;</span>:<span style="color:#d14">&#34;2&#34;</span>}}
</span></span><span style="display:flex;"><span>{<span style="color:#000080">&#34;doc&#34;</span>:{<span style="color:#000080">&#34;name&#34;</span>:<span style="color:#d14">&#34;2号&#34;</span>}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">查询运行结果~</span> 
</span></span></code></pre></div><h3 id="2-bulk批量操作javaapi-实现">2 bulk批量操作JavaAPI 实现</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *  Bulk 批量操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">test2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建bulkrequest对象，整合所有操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        BulkRequest bulkRequest <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> BulkRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           <span style="color:#998;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        # 1. 删除5号记录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        # 2. 添加6号记录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        # 3. 修改3号记录 名称为 “三号”
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">         */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//添加对应操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//1. 删除5号记录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        DeleteRequest deleteRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> DeleteRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;person1&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;5&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        bulkRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>deleteRequest<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2. 添加6号记录
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;六号&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        IndexRequest indexRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;person1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">id</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;6&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        bulkRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>indexRequest<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3. 修改3号记录 名称为 “三号”
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> mapUpdate<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        mapUpdate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;三号&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        UpdateRequest updateRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> UpdateRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;person1&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;3&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">doc</span><span style="color:#000;font-weight:bold">(</span>mapUpdate<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        bulkRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>updateRequest<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//执行批量操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        BulkResponse response <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bulk</span><span style="color:#000;font-weight:bold">(</span>bulkRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-导入数据分析创建索引">3 导入数据分析&amp;创建索引</h3>
<p>需求：  将数据库中Good表的数据导入到ElasticSearch当中</p>
<p>实现步骤：</p>
<p>分析goods表结构</p>
<p>创建goods索引</p>
<p>查询Goods表数据</p>
<p>批量添加到ElasticSearch中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Json" data-lang="Json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">PUT</span> <span style="color:#a61717;background-color:#e3d2d2">goods</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;title&#34;</span>: {
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_smart&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;price&#34;</span>: { 
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;double&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;createTime&#34;</span>: {
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;date&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;categoryName&#34;</span>: {	
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;keyword&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;brandName&#34;</span>: {	
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;keyword&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;spec&#34;</span>: {		
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;object&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;saleNum&#34;</span>: {	
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;stock&#34;</span>: {	
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>title:商品标题</p>
<p>price:商品价格</p>
<p>createTime:创建时间</p>
<p>categoryName:分类名称。如：家电，手机</p>
<p>brandName:品牌名称。如：华为，小米</p>
<p>spec: 商品规格。如： spec:{&ldquo;屏幕尺寸&rdquo;,&ldquo;5寸&rdquo;，&ldquo;内存大小&rdquo;,&ldquo;128G&rdquo;}</p>
<p>saleNum:销量</p>
<p>stock:库存量</p>
<p>插入一条测试数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Json" data-lang="Json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_doc/</span><span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;title&#34;</span>:<span style="color:#d14">&#34;小米手机&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;price&#34;</span>:<span style="color:#099">1000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;createTime&#34;</span>:<span style="color:#d14">&#34;2021-12-01&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;categoryName&#34;</span>:<span style="color:#d14">&#34;手机&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;brandName&#34;</span>:<span style="color:#d14">&#34;小米&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;saleNum&#34;</span>:<span style="color:#099">3000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;stock&#34;</span>:<span style="color:#099">10000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;spec&#34;</span>:{
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;网络制式&#34;</span>:<span style="color:#d14">&#34;移动4G&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;屏幕尺寸&#34;</span>:<span style="color:#d14">&#34;4.5&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4-导入数据代码实现">4 导入数据代码实现</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 从Mysql 批量导入 elasticSearch
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">test3</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//1.查询所有数据，mysql
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>Goods<span style="color:#000;font-weight:bold">&gt;</span> goodsList <span style="color:#000;font-weight:bold">=</span> goodsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2.bulk导入
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        BulkRequest bulkRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> BulkRequest<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2.1 循环goodsList，创建IndexRequest添加数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Goods goods <span style="color:#000;font-weight:bold">:</span> goodsList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//2.2 设置spec规格信息 Map的数据   specStr:{}
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String specStr <span style="color:#000;font-weight:bold">=</span> goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSpecStr</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//将json格式字符串转为Map集合
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Map map <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>specStr<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//设置spec map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSpec</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//将goods对象转换为json字符串
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String data <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            IndexRequest indexRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;goods&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>data<span style="color:#000;font-weight:bold">,</span>XContentType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">JSON</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            bulkRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>indexRequest<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        BulkResponse response <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bulk</span><span style="color:#000;font-weight:bold">(</span>bulkRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="四elasticsearch高级查询">（四）ElasticSearch高级查询</h2>
<h3 id="1-matchall脚本实现">1 matchAll脚本实现</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">默认情况下，es一次展示</span><span style="color:#099">10</span><span style="color:#a61717;background-color:#e3d2d2">条数据,通过from和size来控制分页</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">查询结果详解</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;match_all&#34;</span>: {}
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;from&#34;</span>: <span style="color:#099">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;size&#34;</span>: <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods</span>
</span></span></code></pre></div><h3 id="2-matchall-javaapi">2 matchAll-JavaAPI</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 查询所有
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *  1. matchAll
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *  2. 将查询结果封装为Goods对象，装载到List中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *  3. 分页。默认显示10条
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">matchAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2. 构建查询请求对象，指定查询的索引名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchRequest searchRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> SearchRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;goods&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4. 创建查询条件构建器SearchSourceBuilder
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchSourceBuilder sourceBuilder<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> SearchSourceBuilder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//6. 查询条件
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        QueryBuilder queryBuilder<span style="color:#000;font-weight:bold">=</span> QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">matchAllQuery</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//5. 指定查询条件
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        sourceBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>queryBuilder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3. 添加查询条件构建器 SearchSourceBuilder
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        searchRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>sourceBuilder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// 8 . 添加分页信息  不设置 默认10条
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//        sourceBuilder.from(0);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//        sourceBuilder.size(100);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//1. 查询,获取查询结果
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        SearchResponse searchResponse <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>searchRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//7. 获取命中对象 SearchHits
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchHits hits <span style="color:#000;font-weight:bold">=</span> searchResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//7.1 获取总记录数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      Long total<span style="color:#000;font-weight:bold">=</span> hits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;总数：&#34;</span><span style="color:#000;font-weight:bold">+</span>total<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//7.2 获取Hits数据  数组
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchHit<span style="color:#000;font-weight:bold">[]</span> hits1 <span style="color:#000;font-weight:bold">=</span> hits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//获取json字符串格式的数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>Goods<span style="color:#000;font-weight:bold">&gt;</span> goodsList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SearchHit searchHit <span style="color:#000;font-weight:bold">:</span> hits1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            String sourceAsString <span style="color:#000;font-weight:bold">=</span> searchHit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSourceAsString</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//转为java对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Goods goods <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>sourceAsString<span style="color:#000;font-weight:bold">,</span> Goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            goodsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Goods goods <span style="color:#000;font-weight:bold">:</span> goodsList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-termquery-词条查询">3 termQuery 词条查询</h3>
<p>term查询和字段类型有关系，首先回顾一下ElasticSearch两个数据类型</p>
<p>ElasticSearch两个数据类型：</p>
<pre tabindex="0"><code>text：会分词，不支持聚合
keyword：不会分词，将全部内容作为一个词条，支持聚合
</code></pre><p>脚本实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#term查询：</span> <span style="color:#a61717;background-color:#e3d2d2">查询title当中包含</span>  <span style="color:#a61717;background-color:#e3d2d2">华为</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">/goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;term&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;title&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;value&#34;</span>: <span style="color:#d14">&#34;华为&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>javaAPI代码实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * termQuery:词条查询
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testTermQuery</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SearchRequest searchRequest <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SearchRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;goods&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        SearchSourceBuilder sourceBulider <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SearchSourceBuilder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        QueryBuilder query <span style="color:#000;font-weight:bold">=</span> QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">termQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;华为&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//term词条查询
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        sourceBulider<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>query<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        searchRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>sourceBulider<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        SearchResponse searchResponse <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>searchRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        SearchHits searchHits <span style="color:#000;font-weight:bold">=</span> searchResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取记录数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#458;font-weight:bold">long</span> value <span style="color:#000;font-weight:bold">=</span> searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;总记录数：&#34;</span><span style="color:#000;font-weight:bold">+</span>value<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>Goods<span style="color:#000;font-weight:bold">&gt;</span> goodsList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        SearchHit<span style="color:#000;font-weight:bold">[]</span> hits <span style="color:#000;font-weight:bold">=</span> searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SearchHit hit <span style="color:#000;font-weight:bold">:</span> hits<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            String sourceAsString <span style="color:#000;font-weight:bold">=</span> hit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSourceAsString</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//转为java
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Goods goods <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>sourceAsString<span style="color:#000;font-weight:bold">,</span> Goods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            goodsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Goods goods <span style="color:#000;font-weight:bold">:</span> goodsList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>goods<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-matchquery">4 matchQuery</h3>
<p>match查询，会对查询条件分词，然后将分词后的查询条件和词条进行等值匹配,默认取并集（OR）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">match查询</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;match&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;华为手机&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;size&#34;</span>: <span style="color:#099">500</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>match 的默认搜索（or 并集）</p>
<p>例如：华为手机，会分词为 “华为”，“手机” 只要出现其中一个词条都会搜索到</p>
<p>match的 and（交集） 搜索</p>
<p>例如：例如：华为手机，会分词为 “华为”，“手机”  但要求“华为”，和“手机”同时出现在词条</p>
<p><strong>总结：</strong></p>
<p>term query会去倒排索引中寻找确切的term，它并不知道分词器的存在。这种查询适合<strong>keyword</strong> 、<strong>numeric</strong>、<strong>date</strong></p>
<p>match query知道分词器的存在。并且理解是如何被分词的</p>
<h3 id="5-模糊查询脚本实现">5 模糊查询脚本实现</h3>
<pre tabindex="0"><code>通配符使用，?代表任意单个字符，*代表0个或者是多个字符
案例： 
&#34;*华*&#34;  包含华字的
&#34;华*&#34;   华字后边多个字符
&#34;华?&#34;  华字后边单个字符
&#34;*华&#34;或&#34;?华&#34; 会引发全表（全索引）扫描 注意效率问题
</code></pre><pre tabindex="0"><code># wildcard 查询。查询条件分词，模糊查询
GET goods/_search
{
  &#34;query&#34;: {
    &#34;wildcard&#34;: {
      &#34;title&#34;: {
        &#34;value&#34;: &#34;华*&#34;
      }
    }
  }
}
</code></pre><h3 id="6-模糊查询javaapi">6 模糊查询javaAPI</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//模糊查询
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>WildcardQueryBuilder query <span style="color:#000;font-weight:bold">=</span> QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">wildcardQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;华*&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//华后多个字符
</span></span></span></code></pre></div><h3 id="7-范围查询脚本实现">7 范围查询脚本实现</h3>
<pre tabindex="0"><code># 范围查询
GET goods/_search
{
  &#34;query&#34;: {
    &#34;range&#34;: {
      &#34;price&#34;: {
        &#34;gte&#34;: 2000,
        &#34;lte&#34;: 3000
      }
    }
  },
  &#34;sort&#34;: [
    {
      &#34;price&#34;: {
        &#34;order&#34;: &#34;desc&#34;
      }
    }
  ]
}
</code></pre><h3 id="8-范围查询api实现">8 范围查询API实现</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//范围查询 以price 价格为条件
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>RangeQueryBuilder query <span style="color:#000;font-weight:bold">=</span> QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">rangeQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;price&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//指定下限
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>query<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">gte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//指定上限
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>query<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#099">3000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>sourceBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>query<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//排序  价格 降序排列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>sourceBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;price&#34;</span><span style="color:#000;font-weight:bold">,</span>SortOrder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DESC</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="9-querystring-查询">9 queryString 查询</h3>
<p>queryString 多条件查询</p>
<p>会对查询条件进行分词。</p>
<p>然后将分词后的查询条件和词条进行等值匹配</p>
<p>默认取并集（OR）</p>
<p>可以指定多个查询字段</p>
<p>query_string：识别query中的连接符（or 、and）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">queryString</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;query_string&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;fields&#34;</span>: [<span style="color:#d14">&#34;title&#34;</span>,<span style="color:#d14">&#34;categoryName&#34;</span>,<span style="color:#d14">&#34;brandName&#34;</span>], 
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;query&#34;</span>: <span style="color:#d14">&#34;华为 AND 手机&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>simple_query_string：不识别query中的连接符（or 、and），查询时会将 “华为”、&ldquo;and&rdquo;、“手机”分别进行查询</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;simple_query_string&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;fields&#34;</span>: [<span style="color:#d14">&#34;title&#34;</span>,<span style="color:#d14">&#34;categoryName&#34;</span>,<span style="color:#d14">&#34;brandName&#34;</span>], 
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;query&#34;</span>: <span style="color:#d14">&#34;华为 AND 手机&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="10-querystring-javaapi代码实现">10 queryString javaAPI代码实现：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>QueryStringQueryBuilder query <span style="color:#000;font-weight:bold">=</span> QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">queryStringQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;华为手机&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;categoryName&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;brandName&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">defaultOperator</span><span style="color:#000;font-weight:bold">(</span>Operator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">AND</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="11-聚合查询脚本实现">11 聚合查询脚本实现</h3>
<p>指标聚合：相当于MySQL的聚合函数。max、min、avg、sum等</p>
<p>桶聚合：相当于MySQL的 group by 操作。不要对text类型的数据进行分组，会失败</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">聚合查询</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">指标聚合</span> <span style="color:#a61717;background-color:#e3d2d2">聚合函数</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;match&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;手机&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;aggs&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;max_price&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;max&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;field&#34;</span>: <span style="color:#d14">&#34;price&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">桶聚合</span>  <span style="color:#a61717;background-color:#e3d2d2">分组</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">GET</span> <span style="color:#a61717;background-color:#e3d2d2">goods/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;match&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;手机&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;aggs&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;goods_brands&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&#34;terms&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;field&#34;</span>: <span style="color:#d14">&#34;brandName&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&#34;size&#34;</span>: <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="12-聚合查询javaapi">12 聚合查询JavaAPI</h3>
<p>聚合查询：桶聚合，分组查询</p>
<ol>
<li>
<p>查询title包含手机的数据</p>
</li>
<li>
<p>查询品牌列表</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 聚合查询：桶聚合，分组查询
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 1. 查询title包含手机的数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 2. 查询品牌列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testAggQuery</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SearchRequest searchRequest<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> SearchRequest<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;goods&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SearchSourceBuilder sourceBuilder<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> SearchSourceBuilder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//1. 查询title包含手机的数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    MatchQueryBuilder queryBuilder <span style="color:#000;font-weight:bold">=</span> QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">matchQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;手机&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sourceBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>queryBuilder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//2. 查询品牌列表  只展示前100条
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    AggregationBuilder aggregation<span style="color:#000;font-weight:bold">=</span>AggregationBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">terms</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;goods_brands&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;brandName&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#099">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    sourceBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">aggregation</span><span style="color:#000;font-weight:bold">(</span>aggregation<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    searchRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>sourceBuilder<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SearchResponse searchResponse <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>searchRequest<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//7. 获取命中对象 SearchHits
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SearchHits hits <span style="color:#000;font-weight:bold">=</span> searchResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//7.1 获取总记录数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Long total<span style="color:#000;font-weight:bold">=</span> hits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;总数：&#34;</span><span style="color:#000;font-weight:bold">+</span>total<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// aggregations 对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Aggregations aggregations <span style="color:#000;font-weight:bold">=</span> searchResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAggregations</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//将aggregations 转化为map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Aggregation<span style="color:#000;font-weight:bold">&gt;</span> aggregationMap <span style="color:#000;font-weight:bold">=</span> aggregations<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">asMap</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//通过key获取goods_brands 对象 使用Aggregation的子类接收  buckets属性在Terms接口中体现
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//        Aggregation goods_brands1 = aggregationMap.get(&#34;goods_brands&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Terms goods_brands <span style="color:#000;font-weight:bold">=(</span>Terms<span style="color:#000;font-weight:bold">)</span> aggregationMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;goods_brands&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取buckets 数组集合
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    List<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> Terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Bucket</span><span style="color:#000;font-weight:bold">&gt;</span> buckets <span style="color:#000;font-weight:bold">=</span> goods_brands<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBuckets</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span>map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//遍历buckets   key 属性名，doc_count 统计聚合数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Bucket</span> bucket <span style="color:#000;font-weight:bold">:</span> buckets<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>bucket<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKey</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>bucket<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKeyAsString</span><span style="color:#000;font-weight:bold">(),</span>bucket<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDocCount</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.github.io/posts/tool/20220526204447/">← Dubbo</a></div>
    <div><a href="https://lovemjh.github.io/posts/java-frame/20220526214937/">Mybatis-Plus  →</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
