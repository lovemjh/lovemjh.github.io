<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="购物车解决方案 - https://lovemjh.vercel.app/posts/project-0/20220528170121/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>购物车解决方案</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            购物车解决方案
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            14511 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            29 分钟</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528173393/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/tool/_20220527215246/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#学习目标">学习目标</a></li>
        <li><a href="#1-资源服务器授权配置">1 资源服务器授权配置</a>
          <ul>
            <li><a href="#11-资源服务授权配置">1.1 资源服务授权配置</a></li>
            <li><a href="#12-用户微服务资源授权">1.2 用户微服务资源授权</a></li>
            <li><a href="#13-授权测试">1.3 授权测试</a></li>
          </ul>
        </li>
        <li><a href="#2-网关对接微服务转发token">2 网关对接微服务转发Token</a>
          <ul>
            <li><a href="#11-令牌加入到header中">1.1 令牌加入到Header中</a></li>
            <li><a href="#12-springsecurity权限控制">1.2 SpringSecurity权限控制</a>
              <ul>
                <li><a href="#121-角色加载">1.2.1 角色加载</a></li>
                <li><a href="#122-角色权限控制">1.2.2 角色权限控制</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#3-oauth动态加载数据">3 OAuth动态加载数据</a>
          <ul>
            <li><a href="#31-客户端数据加载">3.1 客户端数据加载</a>
              <ul>
                <li><a href="#311-数据介绍">3.1.1 数据介绍</a></li>
                <li><a href="#312-加载数据改造">3.1.2 加载数据改造</a></li>
              </ul>
            </li>
            <li><a href="#32-用户数据加载">3.2 用户数据加载</a></li>
          </ul>
        </li>
        <li><a href="#4-购物车">4 购物车</a>
          <ul>
            <li><a href="#41-购物车分析">4.1 购物车分析</a></li>
            <li><a href="#42-订单购物车微服务">4.2 订单购物车微服务</a></li>
            <li><a href="#43-添加购物车">4.3 添加购物车</a>
              <ul>
                <li><a href="#431-思路分析">4.3.1 思路分析</a></li>
                <li><a href="#432-代码实现">4.3.2 代码实现</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#5-用户身份识别">5 用户身份识别</a>
          <ul>
            <li><a href="#51-购物车需求分析">5.1 购物车需求分析</a></li>
            <li><a href="#52-微服务之间认证">5.2 微服务之间认证</a></li>
            <li><a href="#53-网关过滤">5.3 网关过滤</a></li>
            <li><a href="#54-订单对接网关oauth">5.4 订单对接网关+oauth</a></li>
            <li><a href="#55-获取用户数据">5.5 获取用户数据</a>
              <ul>
                <li><a href="#551-数据分析">5.5.1 数据分析</a></li>
                <li><a href="#552-代码实现">5.5.2 代码实现</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">第十二章</h1>
<h1 align = "center">购物车解决方案</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<p>目标1：资源服务器授权配置</p>
<p>目标2：掌握OAuth认证微服务动态加载数据</p>
<p>目标3：掌握购物车流程</p>
<p>目标4：掌握购物车渲染流程</p>
<p>目标5：OAuth2.0认证并获取用户令牌数据</p>
<p>目标6：微服务与微服务之间的认证</p>
<h2 id="1-资源服务器授权配置">1 资源服务器授权配置</h2>
<h3 id="11-资源服务授权配置">1.1 资源服务授权配置</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170232312.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>基本上所有微服务都是资源服务</p>
<p>(1)配置公钥 认证服务生成令牌采用非对称加密算法，认证服务采用私钥加密生成令牌，对外向资源服务提供公钥，资源服务使 用公钥 来校验令牌的合法性。 将公钥拷贝到 public.key文件中，将此文件拷贝到每一个需要的资源服务工程的classpath下 ,例如:用户微服务.</p>
<p>(2)添加依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)配置每个系统的Http请求路径安全控制策略以及读取公钥信息识别令牌，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableResourceServer</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//激活方法上的PreAuthorize注解
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ResourceServerConfig</span> <span style="color:#000;font-weight:bold">extends</span> ResourceServerConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//公钥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 定义JwtTokenStore
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param jwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenStore <span style="color:#900;font-weight:bold">tokenStore</span><span style="color:#000;font-weight:bold">(</span>JwtAccessTokenConverter jwtAccessTokenConverter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> JwtTokenStore<span style="color:#000;font-weight:bold">(</span>jwtAccessTokenConverter<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 定义JJwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> JwtAccessTokenConverter <span style="color:#900;font-weight:bold">jwtAccessTokenConverter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        JwtAccessTokenConverter converter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> JwtAccessTokenConverter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVerifierKey</span><span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> converter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 获取非对称加密公钥 Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return 公钥 Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        Resource resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader br <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//读取第1行，公钥数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>s<span style="color:#000;font-weight:bold">=</span>br<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000;font-weight:bold">return</span> s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException ioe<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * Http安全配置，对每个到达系统的http请求链接进行校验
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//所有请求必须认证通过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//下边的路径放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;/user/add&#34;</span><span style="color:#000;font-weight:bold">).</span> <span style="color:#998;font-style:italic">//配置地址放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                permitAll<span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">anyRequest</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>                authenticated<span style="color:#000;font-weight:bold">();</span>    <span style="color:#998;font-style:italic">//其他地址需要认证授权
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="12-用户微服务资源授权">1.2 用户微服务资源授权</h3>
<p>将上面生成的公钥public.key拷贝到dongyimai-user-service微服务工程的resources目录下，如下图：
<img src="/posts/project-0/20220528170121/image-20220528170246904.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>(1)引入依赖</p>
<p>在dongyimai-user-service微服务工程pom.xml中引入oauth依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--oauth依赖--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)资源授权配置</p>
<p>在dongyimai-user-service工程中创建com.offcn.user.config.ResourceServerConfig，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableResourceServer</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//激活方法上的PreAuthorize注解
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ResourceServerConfig</span> <span style="color:#000;font-weight:bold">extends</span> ResourceServerConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//公钥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 定义JwtTokenStore
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param jwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenStore <span style="color:#900;font-weight:bold">tokenStore</span><span style="color:#000;font-weight:bold">(</span>JwtAccessTokenConverter jwtAccessTokenConverter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> JwtTokenStore<span style="color:#000;font-weight:bold">(</span>jwtAccessTokenConverter<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 定义JJwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> JwtAccessTokenConverter <span style="color:#900;font-weight:bold">jwtAccessTokenConverter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        JwtAccessTokenConverter converter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> JwtAccessTokenConverter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVerifierKey</span><span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> converter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 获取非对称加密公钥 Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return 公钥 Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//加载公钥文件
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Resource resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//读取输入流
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader br <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//读取第1行，公钥数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>s<span style="color:#000;font-weight:bold">=</span>br<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000;font-weight:bold">return</span> s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * Http安全配置，对每个到达系统的http请求链接进行校验
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//所有请求必须认证通过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//下边的路径放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;/user/add&#34;</span><span style="color:#000;font-weight:bold">).</span> <span style="color:#998;font-style:italic">//配置地址放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                permitAll<span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">anyRequest</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>                authenticated<span style="color:#000;font-weight:bold">();</span>    <span style="color:#998;font-style:italic">//其他地址需要认证授权
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>问题：注意公钥的格式必须正确，要不然会出现如下错误
<img src="/posts/project-0/20220528170121/image-20220528170258095.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="13-授权测试">1.3 授权测试</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170303004.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户每次访问微服务的时候，需要先申请令牌，令牌申请后，每次将令牌放到头文件中，才能访问微服务。</p>
<p>头文件中每次需要添加一个<code>Authorization</code>头信息，头的结果为<code>bearer token</code>。</p>
<p>(1)不携带令牌测试</p>
<p>访问http://localhost:9007/user  不携带令牌，结果如下：
<img src="/posts/project-0/20220528170121/image-20220528170309717.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)携带正确令牌访问，注意重新生成令牌</p>
<p>访问http://localhost:9007/user  携带正确令牌</p>
<p>在请求头携带参数：</p>
<p>key:  Authorization</p>
<p>value: Bearer+半角空格+accessToken</p>
<p>结果如下：
<img src="/posts/project-0/20220528170121/image-20220528170315509.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(3)携带错误令牌</p>
<p>访问http://localhost:9007/user  携带不正确令牌，结果如下：
<img src="/posts/project-0/20220528170121/image-20220528170320779.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：客户端资源必须拥有：oauth2-resource，否则报错</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inMemory</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;client1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">secret</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;123&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resourceIds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;oauth2-resource&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;dongyimai-user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;dongyimai-goods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-网关对接微服务转发token">2 网关对接微服务转发Token</h2>
<p><img src="/posts/project-0/20220528170121/image-20220528170331003.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户每次访问微服务的时候，先去oauth2.0服务登录，登录后再访问微服务网关，微服务网关将请求转发给其他微服务处理。</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.用户登录成功后，会将令牌信息存入到cookie中(一般建议存入到头文件中)
2.用户携带Cookie中的令牌访问微服务网关
3.微服务网关先获取头文件中的令牌信息，如果Header中没有Authorization令牌信息，则从参数中找，参数中如果没有，则取Cookie中找Authorization，最后将令牌信息封装到Header中，并调用其他微服务
4.其他微服务会获取头文件中的Authorization令牌信息，然后匹配令牌数据是否能使用公钥解密，如果解密成功说明用户已登录，解密失败，说明用户未登录
</code></pre><h3 id="11-令牌加入到header中">1.1 令牌加入到Header中</h3>
<p>修改dongyimai-gateway-web的全局过滤器com.offcn.filter.AuthorizeFilter，实现将令牌信息添加到头文件中，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170339101.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//不用解析令牌，直接转发
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>           <span style="color:#998;font-style:italic">// Claims claims = JwtUtil.parseJwt(token);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>             <span style="color:#998;font-style:italic">//判断token是否有Bearer开头,如果没有，就添加Bearer开头
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>token<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">substring</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">,</span>6<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">toLowerCase</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;bearer&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic">//添加Bearer开头
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                    token<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Bearer &#34;</span><span style="color:#000;font-weight:bold">+</span>token<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//把token转发到对应微服务
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">mutate</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">header</span><span style="color:#000;font-weight:bold">(</span>AUTHORIZE_TOKEN<span style="color:#000;font-weight:bold">,</span>token<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//解析出现异常返回401
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatusCode</span><span style="color:#000;font-weight:bold">(</span>HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UNAUTHORIZED</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setComplete</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>访问<code>http://localhost:8001/api/user</code>，将生成的新令牌放到头文件中效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170345227.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：经测试如上由于java代码中添加了bearer， 那么在发出请求的时候就可以不加了。并且由于网关中gateway中AuthorizeFilter添加的从cookie中获取令牌。此时参数中请求头中不添加Authorization参数也不会报错。因为最终都会被Cookie获取的令牌给覆盖了。</p>
<h3 id="12-springsecurity权限控制">1.2 SpringSecurity权限控制</h3>
<p>由于我们项目使用了微服务，任何用户都有可能使用任意微服务，此时我们需要控制相关权限，例如：普通用户角色不能使用用户的删除操作，只有管理员才可以使用,那么这个时候就需要使用到SpringSecurity的权限控制功能了。</p>
<h4 id="121-角色加载">1.2.1 角色加载</h4>
<p>在dongyimai-user-oauth服务中，找到配置类WebSecurityConfig,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//编写自定义认证类，账号、密码、授权
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> UserDetailsService <span style="color:#900;font-weight:bold">CreateUserDetailsService</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//用户账号集合
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>UserDetails<span style="color:#000;font-weight:bold">&gt;</span> userDetailsList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建第一组账号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        UserDetails userDetails1 <span style="color:#000;font-weight:bold">=</span> User<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;123&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ADMIN&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails2 <span style="color:#000;font-weight:bold">=</span> User<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;456&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails3 <span style="color:#000;font-weight:bold">=</span> User<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user2&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;789&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ADMIN&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//把创建好账号添加到账号集合
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        userDetailsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>userDetails1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        userDetailsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>userDetails2<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        userDetailsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>userDetails3<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//把账号存储到内存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> InMemoryUserDetailsManager<span style="color:#000;font-weight:bold">(</span>userDetailsList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意：.authorities(&ldquo;ADMIN&rdquo;, &ldquo;USER&rdquo;) 就是给用户授权的</p>
<h4 id="122-角色权限控制">1.2.2 角色权限控制</h4>
<p>在每个微服务中，需要获取用户的角色，然后根据角色识别是否允许操作指定的方法，Spring Security中定义了四个支持权限控制的表达式注解，分别是<code>@PreAuthorize</code>、<code>@PostAuthorize</code>、<code>@PreFilter</code>和<code>@PostFilter</code>。其中前两者可以用来在方法调用前或者调用后进行权限检查，后两者可以用来对集合类型的参数或者返回值进行过滤。在需要控制权限的方法上，我们可以添加<code>@PreAuthorize</code>注解，用于方法执行前进行权限检查，校验用户当前角色是否能访问该方法。</p>
<p>(1)开启@PreAuthorize</p>
<p>在<code>dongyimai-user-service</code>的<code>ResourceServerConfig</code>类上添加<code>@EnableGlobalMethodSecurity</code>注解，用于开启@PreAuthorize的支持，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170354561.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>(2)方法权限控制</p>
<p>在<code>dongyimaig-user-service</code>微服务的<code>com.offcn.user.controller.UserController</code>类的findById方法上添加权限控制注解<code>@PreAuthorize</code>，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170400694.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@PreAuthorize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;hasAnyAuthority(&#39;admin&#39;)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>(3)测试</p>
<p>我们使用Postman测试，先重新登录创建令牌，然后将令牌数存放到头文件中访问微服务网关来调用user微服务的findById方法，效果如下：</p>
<p>地址：<code>http://localhost:8001/api/user/1</code>提交方式：GET
<img src="/posts/project-0/20220528170121/image-20220528170406596.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>发现上面无法访问，因为用户登录的时候，角色不包含admin角色，而delete方法需要admin角色，所以被拦截了。</p>
<p>我们再测试其他方法，其他方法没有配置拦截，所以用户登录后就会放行。</p>
<p>访问<code>http://localhost:8001/api/user</code></p>
<p>效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170412152.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>知识点说明：</p>
<p>如果希望一个方法能被多个角色访问，配置:<code>@PreAuthorize(&quot;hasAnyAuthority('admin','user')&quot;)</code></p>
<p>如果希望一个类都能被多个角色访问，在类上配置:<code>@PreAuthorize(&quot;hasAnyAuthority('admin','user')&quot;)</code></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170419505.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>再次执行查询方法
<img src="/posts/project-0/20220528170121/image-20220528170424162.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="3-oauth动态加载数据">3 OAuth动态加载数据</h2>
<p>前面OAuth我们用的数据都是静态的，在现实工作中，数据都是从数据库加载的，所以我们需要调整一下OAuth服务，从数据库加载相关数据。</p>
<ul>
<li>客户端数据[生成令牌相关数据]</li>
<li>用户登录账号密码从数据库加载
<img src="/posts/project-0/20220528170121/image-20220528170431588.png"
    
    
    
    loading="lazy"
    
    
></li>
</ul>
<h3 id="31-客户端数据加载">3.1 客户端数据加载</h3>
<h4 id="311-数据介绍">3.1.1 数据介绍</h4>
<p>(1)客户端静态数据</p>
<p>在<code>dongyimai-user-oauth</code>的com.offcn.oauth.config.AuthorizationServerConfig类中配置了客户端静态数据，主要用于配置客户端数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">//客户端账号配置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>ClientDetailsServiceConfigurer clients<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#998;font-style:italic">//在内存中创建账号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inMemory</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">// admin，授权码认证、密码认证、客户端认证、简单认证、刷新token
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#998;font-style:italic">//账号名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">secret</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#998;font-style:italic">//密码，要设置加密
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resourceIds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;dongyimai-user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;dongyimai-goods&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//资源编号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">scopes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;server&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;app&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//作用范围
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizedGrantTypes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;authorization_code&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;refresh_token&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;client_credentials&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;implicit&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//登录授权模式
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">redirectUris</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http://localhost&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//登录成功跳转地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)客户端表结构介绍</p>
<p>在数据库中创建一张表oauth_client_details，表主要用于记录客户端相关信息，表结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>oauth_client_details<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>client_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">48</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;客户端ID，主要用于标识对应的应用&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>resource_ids<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>client_secret<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;客户端秘钥，BCryptPasswordEncoder加密算法加密&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span><span style="color:#000;font-weight:bold">scope</span><span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;对应的范围&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>authorized_grant_types<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;认证模式&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>web_server_redirect_uri<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;认证后重定向地址&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>authorities<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>access_token_validity<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;令牌有效期&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>refresh_token_validity<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;令牌刷新周期&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>additional_information<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">4096</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>autoapprove<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>client_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><p>字段说明：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">client_id：客户端id 
resource_ids：资源id（暂时不用） 
client_secret：客户端秘钥 
scope：范围 
access_token_validity：访问token的有效期（秒） 
refresh_token_validity：刷新token的有效期（秒） 
authorized_grant_type：授权类型:authorization_code,password,refresh_token,client_credentials    
</code></pre><p>导入2条记录到表中，SQL如下：数据中密文为123</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>oauth_client_details<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#d14">&#39;dongyimai&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;$2a$10$8DclUiu2LEG99cTGXdpzVOwoqbJY.IZ7qXClQ.uOM8Gq9fDx/eXhO&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;app&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;authorization_code,password,refresh_token,client_credentials&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;http://localhost&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>oauth_client_details<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#d14">&#39;ujiuye&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;$2a$10$8DclUiu2LEG99cTGXdpzVOwoqbJY.IZ7qXClQ.uOM8Gq9fDx/eXhO&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;app&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;authorization_code,password,refresh_token,client_credentials&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;http://localhost&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>上述表结构属于SpringSecurity Oauth2.0所需的一个认证表结构，不能随意更改。相关操作在其他类中有所体现，如：<code>org.springframework.security.oauth2.provider.client.JdbcClientDetailsService</code>中的片段代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170441200.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="312-加载数据改造">3.1.2 加载数据改造</h4>
<p>（1）、引入依赖库</p>
<p>修改pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>&lt;dependency&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;groupId&gt;mysql&lt;/groupId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>&lt;/dependency&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>&lt;dependency&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>&lt;/dependency&gt;<span style="color:#bbb">
</span></span></span></code></pre></div><p>（2）、修改连接配置</p>
<p>从数据库加载数据，我们需要先配置数据库连接，在dongyimai-user-oauth的application.yml中配置连接信息，如下代码：
<img src="/posts/project-0/20220528170121/image-20220528170447230.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring:
  application:
    name: oauth2
  datasource:
    url: jdbc:mysql://localhost:3306/dongyimaidb
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
</code></pre><p>(3)修改客户端加载源</p>
<p>修改dongyimai-user-oauth的com.offcn.oauth.config.AuthorizationServerConfig类的configure方法，将之前静态的客户端数据变成从数据库加载，修改如下：</p>
<p><strong>修改前：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170452866.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>修改后：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170459475.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170504888.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意如果：表中的密码不清楚可以创建一个测试类生成一段密码拷贝进入表中替换掉原有的密码即可。</p>
<p>在项目的test目录下，编写测试类TestBCryptDemo:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.oauth</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.junit.jupiter.api.Test</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">TestBCryptDemo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span>  <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">test1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String password<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dongyimai&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> BCryptPasswordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)测试</p>
<p><strong>授权码模式测试</strong></p>
<p>访问：<code>http://localhost:9100/oauth/authorize?client_id=dongyimai&amp;response_type=code&amp;scope=app&amp;redirect_uri=http://localhost</code></p>
<p>效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170511206.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户名对应应用id，密码对应秘钥。账号输入：<code>dongyimai</code>  密码：<code>dongyimai</code></p>
<p>当然此时从数据中取出数据，注意：如果采用授权码模式，客户端账号密码和用户登录账号密码必须一致。</p>
<p><strong>自定义账号密码模式授权测试</strong></p>
<p>我们之前编写的账号密码登录代码如下，每次都会加载指定的客户端ID和指定的秘钥，所以此时的客户端ID和秘钥固定了，输入的账号密码不再是客户端ID和秘钥了。
<img src="/posts/project-0/20220528170121/image-20220528170515642.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>如果客户端账号密码发生变化，对应的修改配置文件中的配置，和数据表oauth_client_details中的账号密码一致</p>
<pre tabindex="0"><code>auth:
  ttl: 3600  #token存储过期时间
  clientId: dongyimai    #客户端账号
  clientSecret: 123      #客户端密码
  cookieDomain: localhost
  cookieMaxAge: -1
</code></pre><h3 id="32-用户数据加载">3.2 用户数据加载</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170553193.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>因为我们目前整套系统是对内提供登录访问，所以每次用户登录的时候oauth需要调用用户微服务查询用户信息，如上图：</p>
<p>我们需要在用户微服务中提供用户信息查询的方法，并在oauth中使用feign调用即可。</p>
<p>在真实工作中，用户和管理员对应的oauth认证服务器会分开，网关也会分开，我们今天的课堂案例只实现用户相关的认证即可。</p>
<p>(1)、实现自定义认证类</p>
<p>编写自定义认证类，com.offcn.oauth.auth.UserDetailsServiceImpl该类实现了加载用户相关信息进行授权和认证，如下代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserDetailsServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserDetailsService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> UserDetails <span style="color:#900;font-weight:bold">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> UsernameNotFoundException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//根据用户名查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String pwd <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BCryptPasswordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;dongyimai&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#998;font-style:italic">//创建角色
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String permissions<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;salesman,accountant,user&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//创建用户对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        User userDetails <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>pwd<span style="color:#000;font-weight:bold">,</span> AuthorityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">commaSeparatedStringToAuthorityList</span><span style="color:#000;font-weight:bold">(</span>permissions<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> userDetails<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述代码给登录用户定义了三个角色，分别为<code>salesman</code>,<code>accountant</code>,<code>user</code>，这一块我们目前使用的是硬编码方式将角色写死了，后面会从数据库加载。</p>
<p>密码也统一写死成了:dongyimai</p>
<p>修改配置类WebSecurityConfig</p>
<p>注释原来写死账号密码的如下代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/* //声明自定义认证对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    @Bean(name = &#34;userDetailsService&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    @Override
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    public UserDetailsService userDetailsServiceBean() throws Exception {
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        return this.CreateUserDetailsService();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    }
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    @Override
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    protected UserDetailsService userDetailsService() {
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     //启用自定义认证对象进行认证
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     return   this.CreateUserDetailsService();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    }
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">   //自定义认证，声明用户登录账号、密码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    private UserDetailsService CreateUserDetailsService(){
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        List&lt;UserDetails&gt; users=new ArrayList&lt;&gt;();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        UserDetails adminUser = User.withUsername(&#34;admin&#34;).password(passwordEncoder().encode(&#34;123&#34;)).authorities(&#34;ADMIN&#34;, &#34;USER&#34;).build();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        UserDetails OneUser = User.withUsername(&#34;user1&#34;).password(passwordEncoder().encode(&#34;123&#34;)).authorities(&#34;ADMIN&#34;, &#34;USER&#34;).build();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        UserDetails TowUser = User.withUsername(&#34;user2&#34;).password(passwordEncoder().encode(&#34;456&#34;)).authorities(&#34;USER&#34;).build();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        users.add(adminUser);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        users.add(OneUser);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        users.add(TowUser);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        return new InMemoryUserDetailsManager(users);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    }*/</span>
</span></span></code></pre></div><p>重写获取自定义认证类方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>UserDetailsService userDetailsService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">protected</span> UserDetailsService <span style="color:#900;font-weight:bold">userDetailsService</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">return</span>   userDetailsService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)修改Feign</p>
<p>修改dongyimai-user-service-api中创建com.offcn.user.feign.UserFeign，添加代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;DYM-USER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">UserFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 根据username查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/load/{username}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> String username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)修改UserController</p>
<p>修改dongyimai-user-service的UserController添加findByUsername方法，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170602282.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/load/{username}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> String username<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//调用UserService实现根据主键查询User
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    User user <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;查询成功&#34;</span><span style="color:#000;font-weight:bold">,</span>user<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)放行查询用户方法</p>
<p>因为oauth需要调用查询用户信息，需要在dongyimai-user-service中放行<code>/user/load/{username}</code>方法,修改ResourceServerConfig，添加对<code>/user/load/{username}</code>的放行操作，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170609133.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(5)oauth调用查询用户信息</p>
<p>oauth引入对user-service-api的依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--依赖用户api--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-user-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>修改oauth的<code>com.offcn.oauth.UserDetailsServiceImpl</code>的<code>loadUserByUsername</code>方法，调用UserFeign查询用户信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserFeign userFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> UserDetails <span style="color:#900;font-weight:bold">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> UsernameNotFoundException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//调用用户微服务，根据用户名获得用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> userResult <span style="color:#000;font-weight:bold">=</span> userFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>userResult<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>userResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">()!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//获取用户密码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String pwd <span style="color:#000;font-weight:bold">=</span> userResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//根据用户名查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//String pwd = new BCryptPasswordEncoder().encode(&#34;dongyimai&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//创建User对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//String permissions = &#34;goods_list,seckill_list&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String permissions <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;salesman,accountant,user&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            User userDetails <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> pwd<span style="color:#000;font-weight:bold">,</span> AuthorityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">commaSeparatedStringToAuthorityList</span><span style="color:#000;font-weight:bold">(</span>permissions<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> userDetails<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(6)feign开启</p>
<p>修改<code>com.offcn.OAuthApplication</code>开启Feign客户端功能</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.user.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OAuthApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OAuthApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;restTemplate&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> RestTemplate <span style="color:#900;font-weight:bold">restTemplate</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestTemplate<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(7)、设置feign的调用超时时间修改application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启Feign的熔断功能</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">feign</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#总连接超时时间=（切换服务实例次数+1）*（每个实例重试次数+1）*连接超时时间 </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">USER</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#服务名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ribbon</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#配置指定服务的负载均衡策略</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">NFLoadBalancerRuleClassName</span>:<span style="color:#bbb"> </span>com.netflix.loadbalancer.RoundRobinRule<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbon的连接超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ConnectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">2000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbon的数据读取超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ReadTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">2000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 是否对所有操作都进行重试</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">OkToRetryOnAllOperations</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 切换实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetriesNextServer</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 对当前实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetries</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#设定Hystrix熔断超时时间 ，理论上熔断时间应该大于总连接超时时间   </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">execution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">isolation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">thread</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">timeoutInMilliseconds</span>:<span style="color:#bbb"> </span><span style="color:#099">10000</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>(7)测试</p>
<p>我们换个数据库中的账号密码登录，分别输入zhangsan，密码使用我们前面的测试类重新生成密码拷贝进入数据库中替换原有的数据，然后测试效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170618336.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意账号密码从数据表tb_user查看：
<img src="/posts/project-0/20220528170121/image-20220528170623094.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-购物车">4 购物车</h2>
<p>购物车分为用户登录购物车和未登录购物车操作，传统的电商系统在用户登录和不登录都可以操作购物车，如果用户不登录，操作购物车可以将数据存储到Cookie或者WebSQL或者SessionStorage中，用户登录后购物车数据可以存储到Redis中，再将之前未登录加入的购物车合并到Redis中即可。</p>
<p>淘宝天猫等则采用了另外一种实现方案，用户要想将商品加入购物车，必须先登录才能操作购物车。</p>
<p>我们今天实现的购物车是天猫解决方案，即用户必须先登录才能使用购物车功能。</p>
<h3 id="41-购物车分析">4.1 购物车分析</h3>
<p>(1)需求分析</p>
<p>用户在商品详细页点击加入购物车，提交商品SKU编号和购买数量，添加到购物车。购物车展示页面如下：
<img src="/posts/project-0/20220528170121/image-20220528170629469.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)购物车实现思路
<img src="/posts/project-0/20220528170121/image-20220528170634823.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们实现的是用户登录后的购物车，用户将商品加入购物车的时候，直接将要加入购物车的详情存入到Redis即可。每次查看购物车的时候直接从Redis中获取。</p>
<p>(3)表结构分析</p>
<p>用户登录后将商品加入购物车，需要存储商品详情以及购买数量，购物车详情表如下：</p>
<p>dongyimaidb数据库中tb_order_item表：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>tb_order_item<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>item_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;SKU_ID&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>goods_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;SPU_ID&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>order_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;订单id&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>title<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">200</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#bbb"> </span>utf8_bin<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;商品标题&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>price<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">decimal</span>(<span style="color:#099">20</span>,<span style="color:#099">2</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;商品单价&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>num<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">10</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;商品购买数量&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>total_fee<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">decimal</span>(<span style="color:#099">20</span>,<span style="color:#099">2</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;商品总金额&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>pic_path<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">200</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#bbb"> </span>utf8_bin<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;商品图片地址&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>seller_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#bbb"> </span>utf8_bin<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>BTREE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>item_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>item_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>BTREE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>order_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>order_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>BTREE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#000;font-weight:bold">=</span>utf8_bin<span style="color:#bbb"> </span>ROW_FORMAT<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">DYNAMIC</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>购物车详情表其实就是订单详情表结构，只是目前临时存储数据到Redis，等用户下单后才将数据从Redis取出存入到数据库中。</p>
<h3 id="42-订单购物车微服务">4.2 订单购物车微服务</h3>
<p>我们先搭建一个订单购物车微服务工程，按照如下步骤实现即可。</p>
<p>(1)导入资源</p>
<p>搭建订单购物车微服务，工程名字dongyimai-order-service并搭建对应的api工程dongyimai-order-service-api，如下图：</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170643175.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170648667.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>同时在dongyimai-order-service中引入dongyimai-order-service-api,</p>
<p>依赖引入：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-order-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在dongyimai-order-service-api中引入依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-common-db<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>将代码生成器生成好的dao和相关文件拷贝到工程中，以及生成好的Pojo拷贝到API工程中</p>
<p>dongyimai-order-service:
<img src="/posts/project-0/20220528170121/image-20220528170655849.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170709381.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)application.yml配置</p>
<p>在dongyimai-service-order的resources中添加application.yml配置文件，代码如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 9008
spring:
  application:
    name: order
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/dongyimaidb?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8
      username: root
      password: root
      type: com.alibaba.druid.pool.DruidDataSource
  redis:
    host: 192.168.188.138
    port: 6379
  main:
    allow-bean-definition-overriding: true
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka
  instance:
    lease-renewal-interval-in-seconds: 5 # 每隔5秒发送一次心跳
    lease-expiration-duration-in-seconds: 10 # 10秒不发送就过期    
feign:
  hystrix:
    enabled: true
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true  #开启驼峰式编写规范
  type-aliases-package: com.offcn.order.pojo
# 配置sql打印日志
logging:
  level:
    com.offcn: debug
</code></pre><p>(3)创建启动类</p>
<p>在dongyimai-service-order的<code>com.offcn.order</code>中创建启动类，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.order.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OrderApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="43-添加购物车">4.3 添加购物车</h3>
<h4 id="431-思路分析">4.3.1 思路分析</h4>
<p><img src="/posts/project-0/20220528170121/image-20220528170719500.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户添加购物车，只需要将要加入购物车的商品存入到Redis中即可。一个用户可以将多件商品加入购物车，存储到Redis中的数据可以采用Hash类型。</p>
<p>购物车数据的存储结构如下：
<img src="/posts/project-0/20220528170121/image-20220528170727473.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="432-代码实现">4.3.2 代码实现</h4>
<p>(1)在dongyimai-order-service-api下创建购物车复合实体类com.offcn.order.group.Cart.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Cart</span> <span style="color:#000;font-weight:bold">implements</span> Serializable<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">private</span> String sellerId<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//商家ID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">private</span> String sellerName<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//商家名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">private</span> List<span style="color:#000;font-weight:bold">&lt;</span>OrderItem<span style="color:#000;font-weight:bold">&gt;</span> orderItemList<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//购物车明细
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//getter  and setter  ......
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)feign创建</p>
<p>下订单需要调用feign查看商品信息，我们先创建feign分别根据ID查询SKU和SPU信息，在dongyimai-sellergoods-serivce-api工程中的ItemFeign和GoodsFeign根据ID查询方法如下：</p>
<p>com.offcn.sellergoods.feign.ItemFeign</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dym-sellergoods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/item&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">ItemFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 根据ID查询Item数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/{id}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> Long id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>com.offcn.sellergoods.feign.GoodsFeign</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dym-sellergoods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/goods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">GoodsFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 根据ID查询商品数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/{id}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>GoodsEntity<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> Long id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)业务层</p>
<p>业务层接口</p>
<p>在dongyimai-order-servicer微服务中创建com.offcn.order.service.CartService接口，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">CartService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 添加商品到购物车
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param itemId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param num
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">,</span> Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 从redis中查询购物车
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 将购物车保存到redis
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>业务层接口实现类</p>
<p>在dongyimai-service-order微服务中创建接口实现类com.offcn.order.service.impl.CartServiceImpl,代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CartServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> CartService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ItemFeign itemFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RedisTemplate redisTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">,</span> Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//1.根据商品SKU ID查询SKU商品信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Result<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> itemResult <span style="color:#000;font-weight:bold">=</span> itemFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findById</span><span style="color:#000;font-weight:bold">(</span>itemId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Item item <span style="color:#000;font-weight:bold">=</span> itemResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;商品不存在&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatus</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;商品状态无效&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2.获取商家ID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String sellerId <span style="color:#000;font-weight:bold">=</span> item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSellerId</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3.根据商家ID判断购物车列表中是否存在该商家的购物车
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Cart cart <span style="color:#000;font-weight:bold">=</span> searchCartBySellerId<span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">,</span>sellerId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4.如果购物车列表中不存在该商家的购物车
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//4.1 新建购物车对象 ，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cart<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> Cart<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSellerId</span><span style="color:#000;font-weight:bold">(</span>sellerId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSellerName</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSeller</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            OrderItem orderItem <span style="color:#000;font-weight:bold">=</span> createOrderItem<span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">,</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            List orderItemList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            orderItemList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setOrderItemList</span><span style="color:#000;font-weight:bold">(</span>orderItemList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//4.2将购物车对象添加到购物车列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cartList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//5.如果购物车列表中存在该商家的购物车
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">// 判断购物车明细列表中是否存在该商品
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            OrderItem orderItem <span style="color:#000;font-weight:bold">=</span> searchOrderItemByItemId<span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">(),</span>itemId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//5.1. 如果没有，新增购物车明细
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                orderItem<span style="color:#000;font-weight:bold">=</span>createOrderItem<span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">,</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//5.2. 如果有，在原购物车明细上添加数量，更改金额
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNum</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNum</span><span style="color:#000;font-weight:bold">()+</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTotalFee</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> BigDecimal<span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNum</span><span style="color:#000;font-weight:bold">()*</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPrice</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">doubleValue</span><span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//如果数量操作后小于等于0，则移除
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNum</span><span style="color:#000;font-weight:bold">()&lt;=</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                    cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//移除购物车明细
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//如果移除后cart的明细数量为0，则将cart移除
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()==</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                    cartList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartList<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 从redis中查询购物车
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;从redis中提取购物车数据.....&#34;</span><span style="color:#000;font-weight:bold">+</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cartList&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            cartList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartList<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 将购物车保存到redis
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;向redis存入购物车数据.....&#34;</span><span style="color:#000;font-weight:bold">+</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cartList&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 根据商家ID查询购物车对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param sellerId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Cart <span style="color:#900;font-weight:bold">searchCartBySellerId</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">,</span> String sellerId<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span>Cart cart<span style="color:#000;font-weight:bold">:</span>cartList<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSellerId</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>sellerId<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> cart<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 根据商品明细ID查询
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param orderItemList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param itemId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderItem <span style="color:#900;font-weight:bold">searchOrderItemByItemId</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>OrderItem<span style="color:#000;font-weight:bold">&gt;</span> orderItemList <span style="color:#000;font-weight:bold">,</span>Long itemId <span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span>OrderItem orderItem <span style="color:#000;font-weight:bold">:</span>orderItemList<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getItemId</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">longValue</span><span style="color:#000;font-weight:bold">()==</span>itemId<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">longValue</span><span style="color:#000;font-weight:bold">()){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> orderItem<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 创建订单明细
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param item
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param num
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderItem <span style="color:#900;font-weight:bold">createOrderItem</span><span style="color:#000;font-weight:bold">(</span>Item item<span style="color:#000;font-weight:bold">,</span>Integer num<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>num<span style="color:#000;font-weight:bold">&lt;=</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;数量非法&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        OrderItem orderItem<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> OrderItem<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setGoodsId</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setItemId</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNum</span><span style="color:#000;font-weight:bold">(</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPicPath</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getImage</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPrice</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPrice</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSellerId</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSellerId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTitle</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTitle</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>       orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTotalFee</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> BigDecimal<span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPrice</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">doubleValue</span><span style="color:#000;font-weight:bold">()*</span>num<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> orderItem<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>添加dongyimai-order-service对dongyimai-sellergoods-serivce-api的依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-sellergoods-serivce-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)控制层</p>
<p>在dongyimai-service-order微服务中创建com.offcn.order.controller.CartController，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/cart&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CartController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> CartService cartService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 购物车列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/findCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartList</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//从redis中提取
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/addGoodsToCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String username <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList <span style="color:#000;font-weight:bold">=</span> findCartList<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//获取购物车列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cartList <span style="color:#000;font-weight:bold">=</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">,</span> itemId<span style="color:#000;font-weight:bold">,</span> num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;添加成功&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;添加失败&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)feign配置</p>
<p>修改<code>com.offcn.OrderApplication</code>开启Feign客户端：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.sellergoods.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.order.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OrderApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>测试添加购物车，效果如下：</p>
<p>请求地址<code>http://localhost:9008/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>
<img src="/posts/project-0/20220528170121/image-20220528170830486.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试查看购物车：<code>http://localhost:9008/cart/findCartList?username=ujiuye</code>
<img src="/posts/project-0/20220528170121/image-20220528170835317.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-用户身份识别">5 用户身份识别</h2>
<h3 id="51-购物车需求分析">5.1 购物车需求分析</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170841088.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>购物车功能已经做完了，但用户我们都是硬编码写死的。用户要想将商品加入购物车，必须得先登录授权，登录授权后再经过微服务网关，微服务网关需要过滤判断用户请求是否存在令牌，如果存在令牌，才能再次访问微服务，此时网关会通过过滤器将令牌数据再次存入到头文件中，然后访问模板渲染服务，模板渲染服务再调用订单购物车微服务，此时也需要将令牌数据存入到头文件中，将令牌数据传递给购物车订单微服务，到了购物车订单微服务的时候，此时微服务需要校验令牌数据，如果令牌正确，才能使用购物车功能，并解析令牌数据获取用户信息。</p>
<h3 id="52-微服务之间认证">5.2 微服务之间认证</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170847702.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图：因为微服务之间并没有传递头文件，所以我们可以定义一个拦截器，每次微服务调用之前都先检查下头文件，将请求的头文件中的令牌数据再放入到header中，再调用其他微服务即可。</p>
<p>(1)创建Feign拦截器</p>
<p>在dongyimai-order-service服务中创建一个com.offcn.order.config.FeignInterceptor拦截器，并将所有头文件数据再次加入到Feign请求的微服务头文件中，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">FeignInterceptor</span> <span style="color:#000;font-weight:bold">implements</span> RequestInterceptor <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">apply</span><span style="color:#000;font-weight:bold">(</span>RequestTemplate requestTemplate<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//使用RequestContextHolder工具获取request相关变量
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            ServletRequestAttributes attributes <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>ServletRequestAttributes<span style="color:#000;font-weight:bold">)</span> RequestContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequestAttributes</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>attributes <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//取出request
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                HttpServletRequest request <span style="color:#000;font-weight:bold">=</span> attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//获取所有头文件信息的key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                Enumeration<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> headerNames <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeaderNames</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>headerNames <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>headerNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasMoreElements</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">//头文件的key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        String name <span style="color:#000;font-weight:bold">=</span> headerNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nextElement</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">//头文件的value
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        String values <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeader</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">//将令牌数据添加到头文件中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        requestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">header</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">,</span> values<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)创建拦截器Bean</p>
<p>在dongyimai-order-service服务中启动类里创建对象实例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 创建拦截器Bean对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> FeignInterceptor <span style="color:#900;font-weight:bold">feignInterceptor</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> FeignInterceptor<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)我们将sellergoods工程配置上身份认证</p>
<p>修改dongyimai-order-service的pom.xml，添加oauth的依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--oauth依赖--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>将公钥拷贝到dongyimai-order-service工程的resources中
<img src="/posts/project-0/20220528170121/image-20220528170856147.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>在dongyimai-order-service工程中创建com.offcn.order.config.ResourceServerConfig,配置需要拦截的路径，这里需要拦截所有请求路径，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableResourceServer</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//激活方法上的PreAuthorize注解
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ResourceServerConfig</span> <span style="color:#000;font-weight:bold">extends</span> ResourceServerConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//公钥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>     <span style="color:#998;font-style:italic">//读取公钥的方法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//加载公钥文件
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Resource resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//读取输入流
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader br <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//读取第1行，公钥数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>s<span style="color:#000;font-weight:bold">=</span>br<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000;font-weight:bold">return</span> s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 定义JJwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 帮助程序在JWT编码的令牌值和OAuth身份验证信息之间进行转换
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> JwtAccessTokenConverter <span style="color:#900;font-weight:bold">jwtAccessTokenConverter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        JwtAccessTokenConverter converter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> JwtAccessTokenConverter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVerifierKey</span><span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> converter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 定义JwtTokenStore
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param jwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenStore <span style="color:#900;font-weight:bold">tokenStore</span><span style="color:#000;font-weight:bold">(</span>JwtAccessTokenConverter jwtAccessTokenConverter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> JwtTokenStore<span style="color:#000;font-weight:bold">(</span>jwtAccessTokenConverter<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * Http安全配置，对每个到达系统的http请求链接进行校验
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//所有请求必须认证通过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//下边的路径放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;/spec/**&#34;</span><span style="color:#000;font-weight:bold">).</span> <span style="color:#998;font-style:italic">//配置地址放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                permitAll<span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">anyRequest</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>                authenticated<span style="color:#000;font-weight:bold">();</span>    <span style="color:#998;font-style:italic">//其他地址需要认证授权
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意：当dongyimai-order-service运行起来可能会报链接不到redis localhost:6379,此处可以再配置文件中配置一下即可 。</p>
<p>再次发送添加购物车请求测试，
<img src="/posts/project-0/20220528170121/image-20220528170905187.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们发现ServletRequestAttributes始终为空，原因是RequestContextHolder.getRequestAttributes()该方法是从ThreadLocal变量里面取得相应信息的，当hystrix断路器的隔离策略为THREAD时，是无法取得ThreadLocal中的值。</p>
<p>解决方案：开启熔断，并将hystrix隔离策略换为SEMAPHORE</p>
<p>修改dongyimai-order-service的application.yml配置文件，在application.yml中添加如下代码，代码如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#hystrix 配置
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000
          strategy: SEMAPHORE
</code></pre><p>再次测试(注意要重新登陆、使用生成的令牌进行访问)</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170911280.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>效果如下：
<img src="/posts/project-0/20220528170121/image-20220528170915820.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(4)工具类抽取</p>
<p>微服务之间相互认证的情况非常多，我们可以把上面的拦截器抽取出去，放到dongyimai-common的config包中，其他工程需要用，直接创建一个@Bean对象即可。</p>
<h3 id="53-网关过滤">5.3 网关过滤</h3>
<p>为了不给微服务带来一些无效的请求，我们可以在网关中过滤用户请求，先看看头文件中是否有Authorization，如果没有再看看cookie中是否有Authorization，如果都通过了才允许请求到达微服务。</p>
<h3 id="54-订单对接网关oauth">5.4 订单对接网关+oauth</h3>
<p>(1)application.yml配置</p>
<p>修改微服务网关<code>dongyimai-gateway-web</code>的application.yml配置文件，添加order的路由过滤配置，配置如下：
<img src="/posts/project-0/20220528170121/image-20220528170923122.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#购物车微服务
      - id: dongyimai_order_route
        uri: lb://ORDER
        predicates:
          - Path=/api/cart/**,/api/order/**,/api/orderItem/**
        filters:
          - StripPrefix=1
</code></pre><p>这里注意使用的是yml格式，所以上面代码中的空格也一并记得拷贝到application.yml文件中。</p>
<p>(2)过滤配置</p>
<p>在微服务网关<code>dongyimai-gateway-web</code>中添加<code>com.offcn.filter.URLFilter</code>过滤类，用于过滤需要用户登录的地址，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">URLFilter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 要放行的路径
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String noAuthorizeurls <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/api/user/add,/api/user/login&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 判断 当前的请求的地址中是否在已有的不拦截的地址中存在,如果存在 则返回true  表示  不拦截   false表示拦截
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param uri 获取到的当前的请求的地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">hasAuthorize</span><span style="color:#000;font-weight:bold">(</span>String uri<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String<span style="color:#000;font-weight:bold">[]</span> split <span style="color:#000;font-weight:bold">=</span> noAuthorizeurls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String s <span style="color:#000;font-weight:bold">:</span> split<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>s<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>uri<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)全局过滤器修改</p>
<p>修改之前的<code>com.offcn.filter.AuthorizeFilter</code>的过滤方法，将是否需要用户登录过滤也加入其中，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170931350.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">//获取请求的URI
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String path <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getURI</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//判断请求路径是否是不需要验证的
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>URLFilter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasAuthorize</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//直接放行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">return</span>   chain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span>exchange<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)测试</p>
<p>使用Postman访问 <code>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>，效果如下：</p>
<p><strong>未登录：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170942027.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用Postman访问 <code>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>，效果如下：</p>
<p><strong>已登录：</strong>
<img src="/posts/project-0/20220528170121/image-20220528170948295.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>使用Postman访问 <code>http://localhost:8001/api/cart/findCartList?username=ujiuye</code>，效果如下：</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170953025.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="55-获取用户数据">5.5 获取用户数据</h3>
<h4 id="551-数据分析">5.5.1 数据分析</h4>
<p>用户登录后，数据会封装到<code>SecurityContextHolder.getContext().getAuthentication()</code>里面，我们可以将数据从这里面取出，然后转换成<code>OAuth2AuthenticationDetails</code>,在这里面可以获取到令牌信息、令牌类型等，代码如下：
<img src="/posts/project-0/20220528170121/image-20220528170959227.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这里的tokenValue是加密之后的令牌数据，remoteAddress是用户的IP信息，tokenType是令牌类型。</p>
<p>我们可以获取令牌加密数据后，使用公钥对它进行解密，如果能解密说明语句无误，如果不能解密用户也没法执行到这一步。解密后可以从明文中获取用户信息。</p>
<h4 id="552-代码实现">5.5.2 代码实现</h4>
<p>(1)在dongyimai-common工程中引入鉴权包</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--oauth依赖--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;scope&gt;</span>provided<span style="color:#000080">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--鉴权--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>jjwt<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>0.9.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;scope&gt;</span>provided<span style="color:#000080">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)读取公钥</p>
<p>在dongyimai-common中创建com.offcn.utils.TokenDecode类，用于解密令牌信息，在类中读取公钥信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">TokenDecode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//公钥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//定义读取公钥内容变量
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String publickey<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//读取公钥内容方法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        Resource resource<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader bufferedReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//读取第一行公钥数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>publickey<span style="color:#000;font-weight:bold">=</span>bufferedReader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)校验解析令牌数据</p>
<p>在TokenDecode类中添加校验解析令牌数据的方法，这里用到了JwtHelper实现。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 读取令牌数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">dcodeToken</span><span style="color:#000;font-weight:bold">(</span>String token<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//校验Jwt
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Jwt jwt <span style="color:#000;font-weight:bold">=</span> JwtHelper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decodeAndVerify</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> RsaVerifier<span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取Jwt原始内容
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String claims <span style="color:#000;font-weight:bold">=</span> jwt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClaims</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">,</span>Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)获取令牌数据</p>
<p>在TokenDecode类中添加一个getUserInfo方法，用于从容器中获取令牌信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 获取用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getUserInfo</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取授权信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    OAuth2AuthenticationDetails details <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>OAuth2AuthenticationDetails<span style="color:#000;font-weight:bold">)</span> SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAuthentication</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getDetails</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//令牌解码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> dcodeToken<span style="color:#000;font-weight:bold">(</span>details<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTokenValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>完整代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.core.io.ClassPathResource</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.core.io.Resource</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.core.context.SecurityContextHolder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.jwt.Jwt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.jwt.JwtHelper</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.jwt.crypto.sign.RsaVerifier</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationDetails</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.BufferedReader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.InputStreamReader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">TokenDecode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//公钥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//定义读取公钥内容变量
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String publickey<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//读取公钥内容方法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        Resource resource<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader bufferedReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//读取第一行公钥数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>publickey<span style="color:#000;font-weight:bold">=</span>bufferedReader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//解析令牌读取数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">decodeToken</span><span style="color:#000;font-weight:bold">(</span>String token<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//调用公钥解析令牌
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Jwt jwt <span style="color:#000;font-weight:bold">=</span> JwtHelper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decodeAndVerify</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> RsaVerifier<span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取原始内容
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String claims <span style="color:#000;font-weight:bold">=</span> jwt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClaims</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//解析json字符串为Map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//访问当前登录的用户信息解析令牌获取用户数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getUserInfo</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取springSecurity登录信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        OAuth2AuthenticationDetails details<span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>OAuth2AuthenticationDetails<span style="color:#000;font-weight:bold">)</span> SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAuthentication</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getDetails</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//解析令牌
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> decodeToken<span style="color:#000;font-weight:bold">(</span>details<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTokenValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)dongyimai-order-service微服务的主启动类中声明TokenDecode</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenDecode <span style="color:#900;font-weight:bold">getTokenDecode</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> TokenDecode<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)order微服务的控制层获取用户数据</p>
<p>在CartController中注入TokenDecode，并调用TokenDecode的getUserInfo方法获取用户信息，代码如下：</p>
<p>注入TokenDecode：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">private</span> TokenDecode tokenDecode<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>获取用户名：
<img src="/posts/project-0/20220528170121/image-20220528171012342.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/cart&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CartController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> CartService cartService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> TokenDecode tokenDecode<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 购物车列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/findCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartList</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> userInfo <span style="color:#000;font-weight:bold">=</span> tokenDecode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUserInfo</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;userInfo:&#34;</span><span style="color:#000;font-weight:bold">+</span>userInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        String username<span style="color:#000;font-weight:bold">=</span>userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user_name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//从redis中提取
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/addGoodsToCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//String username = &#34;ujiuye&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> userInfo <span style="color:#000;font-weight:bold">=</span> tokenDecode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUserInfo</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;userInfo:&#34;</span><span style="color:#000;font-weight:bold">+</span>userInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        String username<span style="color:#000;font-weight:bold">=</span>userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user_name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList <span style="color:#000;font-weight:bold">=</span> findCartList<span style="color:#000;font-weight:bold">();</span><span style="color:#998;font-style:italic">//获取购物车列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cartList <span style="color:#000;font-weight:bold">=</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">,</span> itemId<span style="color:#000;font-weight:bold">,</span> num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;添加成功&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;添加失败&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)测试</p>
<p>用户登录后测试</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171020396.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>经过网关转发请求添加到购物车：</p>
<p>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1324601&amp;num=1</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171025863.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看redis缓存中保存的用户数据
<img src="/posts/project-0/20220528170121/image-20220528171044967.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>经过网关，查看购物车数据:</p>
<p>http://localhost:8001/api/cart/findCartList</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171053575.png"
    
    
    
    loading="lazy"
    
    
></p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528173393/">← 秒杀高级</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/tool/_20220527215246/">Docker快速入门  →</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
