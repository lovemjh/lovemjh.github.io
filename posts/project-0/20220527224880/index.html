<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="æœç´¢è§£å†³æ–¹æ¡ˆ-Elasticsearch - https://lovemjh.vercel.app/posts/project-0/20220527224880/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>æœç´¢è§£å†³æ–¹æ¡ˆ-Elasticsearch</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            æœç´¢è§£å†³æ–¹æ¡ˆ-Elasticsearch
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">ğŸ“œ</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-27&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-27&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            9081 å­—</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            19 åˆ†é’Ÿ</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220527222325/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220527233134/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡</a></li>
      </ul>
    </li>
    <li><a href="#ä¸€elasticsearch-å®‰è£…">ä¸€ã€Elasticsearch å®‰è£…</a>
      <ul>
        <li><a href="#1dockeré•œåƒä¸‹è½½">(1)dockeré•œåƒä¸‹è½½</a></li>
        <li><a href="#2å®‰è£…eså®¹å™¨">(2)å®‰è£…eså®¹å™¨</a></li>
        <li><a href="#3å¼€å¯è¿œç¨‹è¿æ¥åŠè·¨åŸŸé…ç½®">(3)å¼€å¯è¿œç¨‹è¿æ¥åŠè·¨åŸŸé…ç½®</a></li>
      </ul>
    </li>
    <li><a href="#äºŒikåˆ†è¯å™¨å®‰è£…">äºŒã€IKåˆ†è¯å™¨å®‰è£…</a></li>
    <li><a href="#ä¸‰-kibanaä½¿ç”¨-æŒæ¡dslè¯­å¥">ä¸‰ã€ Kibanaä½¿ç”¨-æŒæ¡DSLè¯­å¥</a>
      <ul>
        <li>
          <ul>
            <li><a href="#31--kibanaä¸‹è½½å®‰è£…">3.1  Kibanaä¸‹è½½å®‰è£…</a></li>
            <li><a href="#32-kibanaä½¿ç”¨">3.2 Kibanaä½¿ç”¨</a>
              <ul>
                <li><a href="#321-é…ç½®ç´¢å¼•">3.2.1 é…ç½®ç´¢å¼•</a></li>
                <li><a href="#322-ç´¢å¼•ç®¡ç†">3.2.2 ç´¢å¼•ç®¡ç†</a></li>
                <li><a href="#323-dslè¯­å¥ä½¿ç”¨">3.2.3 DSLè¯­å¥ä½¿ç”¨</a>
                  <ul>
                    <li><a href="#3231-query-dslç»“æ„åŒ–æŸ¥è¯¢ä»‹ç»">3.2.3.1 Query DSLç»“æ„åŒ–æŸ¥è¯¢ä»‹ç»</a></li>
                    <li><a href="#3232-æµ‹è¯•åˆ†è¯">3.2.3.2 æµ‹è¯•åˆ†è¯</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#å››æ•°æ®å¯¼å…¥es">å››ã€æ•°æ®å¯¼å…¥ES</a>
      <ul>
        <li>
          <ul>
            <li><a href="#41-springdata-elasticsearchä»‹ç»">4.1 SpringData Elasticsearchä»‹ç»</a>
              <ul>
                <li><a href="#411-springdataä»‹ç»">4.1.1 SpringDataä»‹ç»</a></li>
                <li><a href="#412-springdata-esä»‹ç»">4.1.2 SpringData ESä»‹ç»</a></li>
              </ul>
            </li>
            <li><a href="#42-æœç´¢å·¥ç¨‹æ­å»º">4.2 æœç´¢å·¥ç¨‹æ­å»º</a></li>
            <li><a href="#43-æ•°æ®å¯¼å…¥">4.3 æ•°æ®å¯¼å…¥</a>
              <ul>
                <li><a href="#431-æ–‡æ¡£æ˜ å°„beanåˆ›å»º">4.3.1 æ–‡æ¡£æ˜ å°„Beanåˆ›å»º</a></li>
                <li><a href="#432-æœç´¢å®¡æ ¸é€šè¿‡sku">4.3.2 æœç´¢å®¡æ ¸é€šè¿‡Sku</a></li>
                <li><a href="#433-skuå¯¼å…¥eså®ç°">4.3.3 Skuå¯¼å…¥ESå®ç°</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#äº”å…³é”®å­—æœç´¢">äº”ã€å…³é”®å­—æœç´¢</a>
      <ul>
        <li>
          <ul>
            <li><a href="#51-æœåŠ¡å±‚å®ç°">5.1 æœåŠ¡å±‚å®ç°</a></li>
            <li><a href="#52-æ§åˆ¶å±‚å®ç°">5.2 æ§åˆ¶å±‚å®ç°</a></li>
            <li><a href="#53-æµ‹è¯•">5.3 æµ‹è¯•</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#å…­-åˆ†ç±»ç»Ÿè®¡">å…­ã€ åˆ†ç±»ç»Ÿè®¡</a>
      <ul>
        <li>
          <ul>
            <li><a href="#61-åˆ†ç±»ç»Ÿè®¡åˆ†æ">6.1 åˆ†ç±»ç»Ÿè®¡åˆ†æ</a></li>
            <li><a href="#62-åˆ†ç±»åˆ†ç»„ç»Ÿè®¡å®ç°">6.2 åˆ†ç±»åˆ†ç»„ç»Ÿè®¡å®ç°</a></li>
            <li><a href="#63-æµ‹è¯•">6.3 æµ‹è¯•</a></li>
            <li><a href="#64-ä»£ç ä¼˜åŒ–">6.4 ä»£ç ä¼˜åŒ–</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">ç¬¬å…­ç« </h1>
<h1 align = "center">æœç´¢è§£å†³æ–¹æ¡ˆ-Elasticsearch</h1>
<h3 align="center">ä¼˜å°±ä¸š.JAVAæ•™ç ”å®¤</h3>
<h2 id="å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡</h2>
<ul>
<li>Elasticsearchã€Kibanaç¯å¢ƒé…ç½®</li>
<li>DSLè¯­å¥è®²è§£</li>
<li>å•†å“ç´¢å¼•åº“å¯¼å…¥è®²è§£</li>
<li>å•†å“å…³é”®è¯æœç´¢å®ç°</li>
<li>åˆ†ç±»ç»Ÿè®¡æœç´¢</li>
</ul>
<h1 id="ä¸€elasticsearch-å®‰è£…">ä¸€ã€Elasticsearch å®‰è£…</h1>
<p>ElasticSearchæ˜¯ä¸€ä¸ªåŸºäºLuceneçš„æœç´¢æœåŠ¡å™¨ã€‚å®ƒæä¾›äº†ä¸€ä¸ªåˆ†å¸ƒå¼å¤šç”¨æˆ·èƒ½åŠ›çš„å…¨æ–‡æœç´¢å¼•æ“ï¼ŒåŸºäºRESTfulwebæ¥å£ã€‚ElasticSearchæ˜¯ç”¨Javaå¼€å‘çš„ï¼Œå¹¶ä½œä¸ºApacheè®¸å¯æ¡æ¬¾ä¸‹çš„å¼€æ”¾æºç å‘å¸ƒï¼Œæ˜¯å½“å‰æµè¡Œçš„ä¼ä¸šçº§æœç´¢å¼•æ“ã€‚è®¾è®¡ç”¨äºäº‘è®¡ç®—ä¸­ï¼Œèƒ½å¤Ÿè¾¾åˆ°å®æ—¶æœç´¢ï¼Œç¨³å®šï¼Œå¯é ï¼Œå¿«é€Ÿï¼Œå®‰è£…ä½¿ç”¨æ–¹ä¾¿ã€‚æ„å»ºåœ¨å…¨æ–‡æ£€ç´¢å¼€æºè½¯ä»¶Luceneä¹‹ä¸Šçš„Elasticsearchï¼Œä¸ä»…èƒ½å¯¹æµ·é‡è§„æ¨¡çš„æ•°æ®å®Œæˆåˆ†å¸ƒå¼ç´¢å¼•ä¸æ£€ç´¢ï¼Œè¿˜èƒ½æä¾›æ•°æ®èšåˆåˆ†æã€‚æ®å›½é™…æƒå¨çš„æ•°æ®åº“äº§å“è¯„æµ‹æœºæ„DBEnginesçš„ç»Ÿè®¡ï¼Œåœ¨2016å¹´1æœˆï¼ŒElasticsearchå·²è¶…è¿‡Solrç­‰ï¼Œæˆä¸ºæ’åç¬¬ä¸€çš„æœç´¢å¼•æ“ç±»åº”ç”¨</p>
<p>ç®€ä¹‹ï¼šElasticSearchæ˜¯åŸºäºRestfullä¹å‡†çš„é«˜æ‰©å±•é«˜å¯ç”¨çš„å®æ—¶æ•°æ®åˆ†æçš„å…¨æ–‡æœç´¢å·¥å…·ã€‚</p>
<p>åŸºæœ¬æ¦‚å¿µ</p>
<p><img src="/posts/project-0/20220527224880/image-20220527225257010.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ­¤å¤„éœ€è¦æ³¨æ„ï¼šå…³äºç±»å‹typeåœ¨ä¸åŒç‰ˆæœ¬æ˜¯æœ‰æ‰€å˜åŒ–çš„</p>
<p>Elasticsearch å®˜ç½‘æå‡ºçš„è¿‘æœŸç‰ˆæœ¬å¯¹ type æ¦‚å¿µçš„æ¼”å˜æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>åœ¨ <strong>5.X</strong> ç‰ˆæœ¬ä¸­ï¼Œ<strong>ä¸€ä¸ª index</strong> ä¸‹<strong>å¯ä»¥åˆ›å»ºå¤šä¸ª type</strong>ï¼›</p>
<p>åœ¨ <strong>6.X</strong> ç‰ˆæœ¬ä¸­ï¼Œ<strong>ä¸€ä¸ª index</strong> ä¸‹<strong>åªèƒ½å­˜åœ¨ä¸€ä¸ª type</strong>ï¼›</p>
<p>åœ¨ <strong>7.X</strong> ç‰ˆæœ¬ä¸­ï¼Œç›´æ¥<strong>å»é™¤äº† type</strong> çš„æ¦‚å¿µï¼Œå°±æ˜¯è¯´ <strong>index ä¸å†ä¼šæœ‰ type</strong>ã€‚</p>
<p>ä¸»è¦ç›®çš„å°±æ˜¯ ä¸ºäº†ä¿æŒ Elasticsearch â€œ<strong>ä¸€åˆ‡ä¸ºäº†æœç´¢</strong>â€ çš„å®—æ—¨</p>
<p>ç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»ä½¿ç”¨è¿‡elasticsearchäº†ï¼Œè¿™é‡Œä¸å†å¯¹å®ƒè¿›è¡Œè¿‡å¤šçš„ä»‹ç»äº†ï¼Œç›´æ¥ä¸‹è½½å®‰è£…ï¼Œæœ¬ç« èŠ‚å°†é‡‡ç”¨Dockerå®‰è£…ï¼Œä¸è¿‡åœ¨å¸‚é¢ä¸Šè¿˜æœ‰å¾ˆå¤šé‡‡ç”¨linxuå®‰è£…ï¼Œå…³äºlinuxå®‰è£…ï¼Œå·²ç»æä¾›äº†å®‰è£…æ‰‹å†Œï¼Œè¿™é‡Œå°±ä¸è®²äº†ã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰å·²ç»ä½¿ç”¨è¿‡elasticsearchäº†ï¼Œè¿™é‡Œä¸å†å¯¹å®ƒè¿›è¡Œä»‹ç»äº†ï¼Œç›´æ¥ä¸‹è½½å®‰è£…ï¼Œæœ¬ç« èŠ‚å°†é‡‡ç”¨Dockerå®‰è£…ï¼Œä¸è¿‡åœ¨å¸‚é¢ä¸Šè¿˜æœ‰å¾ˆå¤šé‡‡ç”¨linxuå®‰è£…ï¼Œå…³äºlinuxå®‰è£…ï¼Œå·²ç»æä¾›äº†å®‰è£…æ‰‹å†Œï¼Œè¿™é‡Œå°±ä¸è®²äº†ã€‚</p>
<h2 id="1dockeré•œåƒä¸‹è½½">(1)dockeré•œåƒä¸‹è½½</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">docker</span> <span style="color:#d14">pull elasticsearch:7.7.0</span>
</span></span></code></pre></div><p>æ³¨æ„ï¼šå»ºè®®è¿˜åŸé•œåƒå¤‡ä»½æ–‡ä»¶</p>
<pre tabindex="0"><code>docker load -i elasticsearch7.7.tar
</code></pre><h2 id="2å®‰è£…eså®¹å™¨">(2)å®‰è£…eså®¹å™¨</h2>
<p>å› ä¸ºelasticsearchåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šè¿›è¡Œä¸€äº›æ£€æŸ¥ï¼Œæ¯”å¦‚æœ€å¤šæ‰“å¼€çš„æ–‡ä»¶çš„ä¸ªæ•°ä»¥åŠè™šæ‹Ÿå†…å­˜åŒºåŸŸæ•°é‡ç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆè¿›è¡Œç³»ç»Ÿè°ƒä¼˜ï¼Œéœ€è¦åœ¨è™šæ‹Ÿæœºä¸‹è®¾ç½®<code>max_map_count</code>ï¼Œå¦åˆ™elasticsearchå®¹å™¨ä¼šå¯åŠ¨ä¸èµ·æ¥
æŸ¥çœ‹<code>max_map_count</code>çš„å€¼ é»˜è®¤æ˜¯65530</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /proc/sys/vm/max_map_count
</span></span></code></pre></div><p>é‡æ–°è®¾ç½®<code>max_map_count</code>çš„å€¼</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sysctl -w vm.max_map_count<span style="color:#000;font-weight:bold">=</span><span style="color:#099">262144</span>
</span></span></code></pre></div><p>ç„¶åæ‰§è¡Œè¿è¡Œå®¹å™¨å‘½ä»¤ï¼Œå¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">docker</span> <span style="color:#d14">run -di --name dym_es -p 9200:9200 -p 9300:9300 -e &#34;discovery.type=single-node&#34; -e &#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;  elasticsearch:7.7.0 </span>
</span></span></code></pre></div><p>å‘½ä»¤è§£é‡Šï¼š</p>
<p>9200ç«¯å£(Webç®¡ç†å¹³å°ç«¯å£)  9300(æœåŠ¡é»˜è®¤ç«¯å£)</p>
<p><code>-e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot;</code>æ˜¯è®¾ç½®å ç”¨å†…å­˜å¤§å°ï¼Œä¸€èˆ¬çº¿ä¸Šæ£€ç´¢æœåŠ¡å™¨-ESæœåŠ¡å™¨32Gï¼Œè¿™é‡Œå°±å°ä¸€ç‚¹æµ‹è¯•</p>
<p><code>-e &quot;discovery.type=single-node&quot;</code>è¿™ä¸ªæ˜¯è®¾ç½®å•èŠ‚ç‚¹è¿è¡Œ</p>
<h2 id="3å¼€å¯è¿œç¨‹è¿æ¥åŠè·¨åŸŸé…ç½®">(3)å¼€å¯è¿œç¨‹è¿æ¥åŠè·¨åŸŸé…ç½®</h2>
<p>å°†elasticsearchå®¹å™¨å†…éƒ¨çš„/usr/share/elasticsearch/config/elasticsearch.ymlé…ç½®æ–‡ä»¶æ‹·è´åˆ°è™šæ‹Ÿæœºçš„rootç›®å½•ä¸‹ï¼Œç¼–è¾‘å¢åŠ ä»¥ä¸‹å‘½ä»¤ã€‚</p>
<p>æ‹·è´å‘½ä»¤ï¼š</p>
<pre tabindex="0"><code>docker cp dym_es:/usr/share/elasticsearch/config/elasticsearch.yml /root/elasticsearch.yml
</code></pre><p>ç¼–è¾‘elasticsearch.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">cluster.name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">my-application</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">http.cors.enabled</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">http.cors.allow-origin</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">network.host</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">0.0.0.0</span>
</span></span></code></pre></div><p>å…¶ä¸­ï¼š</p>
<p>cluster.nameï¼šè‡ªå®šä¹‰é›†ç¾¤åç§°ã€‚
network.hostï¼šå½“å‰esèŠ‚ç‚¹ç»‘å®šçš„ipåœ°å€ï¼Œé»˜è®¤127.0.0.1ï¼Œå¦‚æœéœ€è¦å¼€æ”¾å¯¹å¤–è®¿é—®è¿™ä¸ªå±æ€§å¿…é¡»è®¾ç½®ã€‚http.cors.enabled: trueï¼šæ­¤æ­¥ä¸ºå…è®¸elasticsearchè·¨åŸŸè®¿é—®ï¼Œé»˜è®¤æ˜¯falseã€‚
<code>http.cors.allow-origin: &quot;*&quot;</code>ï¼šè¡¨ç¤ºè·¨åŸŸè®¿é—®å…è®¸çš„åŸŸååœ°å€ï¼ˆ*è¡¨ç¤ºä»»æ„ï¼‰ã€‚</p>
<p>åˆ é™¤ä¹‹å‰çš„eså®¹å™¨ï¼Œå¹¶é‡æ–°æ‰§è¡Œè¿è¡Œå®¹å™¨å‘½ä»¤</p>
<pre tabindex="0"><code>docker rm -f dym_es
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -di --name dym_es -p 9200:9200 -p 9300:9300 -e <span style="color:#d14">&#34;discovery.type=single-node&#34;</span> -e <span style="color:#d14">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span> -v /root/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml elasticsearch:7.7.0
</span></span></code></pre></div><p>æµè§ˆå™¨è¾“å…¥åœ°å€è®¿é—®ï¼š`http://192.168.188.128:9200/
<img src="/posts/project-0/20220527224880/image-20220527230503925.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å°æç¤ºï¼šå¦‚æœæƒ³è®©å®¹å™¨å¼€å¯é‡å¯ï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">docker</span> <span style="color:#d14">update --restart=always dym_es</span>
</span></span></code></pre></div><h1 id="äºŒikåˆ†è¯å™¨å®‰è£…">äºŒã€IKåˆ†è¯å™¨å®‰è£…</h1>
<p>(1)å®‰è£…ikåˆ†è¯å™¨</p>
<p>IKåˆ†è¯å™¨ä¸‹è½½åœ°å€https://github.com/medcl/elasticsearch-analysis-ik/releases</p>
<p>ä¸Šä¼ åˆ†è¯å™¨å‹ç¼©æ–‡ä»¶åˆ°linuxæœåŠ¡å™¨ï¼Œæ‹·è´æ–‡ä»¶åˆ°ESå®¹å™¨</p>
<pre tabindex="0"><code>docker cp /root/elasticsearch-analysis-ik-7.7.0.zip   dym_es:/usr/share/elasticsearch/plugins/elasticsearch-analysis-ik-7.7.0.zip
</code></pre><p>è¿›å…¥å®¹å™¨å®‰è£…ikåˆ†è¯å™¨</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">docker</span> <span style="color:#d14">exec -it dym_es /bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">cd</span>  <span style="color:#d14">/usr/share/elasticsearch/plugins/</span>
</span></span></code></pre></div><p>åœ¨pluginsç›®å½•ä¸‹å®‰è£…ikåˆ†è¯å™¨ï¼Œikåˆ†è¯å™¨éœ€è¦å’Œesç‰ˆæœ¬ä¸€è‡´</p>
<p>ä½¿ç”¨ä¸Šä¼ çš„æ’ä»¶å‹ç¼©åŒ…å®‰è£…ï¼š</p>
<pre tabindex="0"><code>mkdir ik
mv elasticsearch-analysis-ik-7.7.0.zip  ik/
cd ik
unzip elasticsearch-analysis-ik-7.7.0.zip
</code></pre><p>ä¹Ÿå¯ä»¥åŸºäºç½‘ç»œå®‰è£…ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">elasticsearch-plugin</span> <span style="color:#d14">install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.7.0/elasticsearch-analysis-ik-7.7.0.zip</span>
</span></span></code></pre></div><p>é€€å‡ºå®¹å™¨å¹¶é‡å¯</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker restart dym_es
</span></span></code></pre></div><p>æµ‹è¯•å®‰è£…æˆåŠŸï¼Œåœ°å€æ è¾“å…¥ï¼š</p>
<p>http://192.168.188.128:9200/_cat/plugins
<img src="/posts/project-0/20220527224880/image-20220527230518571.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>IKåˆ†è¯å™¨æœ‰ä¸¤ç§åˆ†è¯æ¨¡å¼ï¼šik_max_wordå’Œik_smartæ¨¡å¼ã€‚</p>
<p>1ã€ik_max_word</p>
<p>ä¼šå°†æ–‡æœ¬åšæœ€ç»†ç²’åº¦çš„æ‹†åˆ†ï¼Œæ¯”å¦‚ä¼šå°†â€œä¸­åäººæ°‘å…±å’Œå›½äººæ°‘å¤§ä¼šå ‚â€æ‹†åˆ†ä¸ºâ€œä¸­åäººæ°‘ã€ä¸­åã€åäººã€äººæ°‘å…±å’Œå›½ã€äººæ°‘ã€å…±å’Œå›½ã€å¤§ä¼šå ‚ã€å¤§ä¼šã€ä¼šå ‚ç­‰è¯è¯­ã€‚</p>
<p>2ã€ik_smart
ä¼šåšæœ€ç²—ç²’åº¦çš„æ‹†åˆ†ï¼Œæ¯”å¦‚ä¼šå°†â€œä¸­åäººæ°‘å…±å’Œå›½äººæ°‘å¤§ä¼šå ‚â€æ‹†åˆ†ä¸ºä¸­åäººæ°‘å…±å’Œå›½ã€äººæ°‘å¤§ä¼šå ‚ã€‚</p>
<p>ä¸¤ç§åˆ†è¯å™¨ä½¿ç”¨çš„æœ€ä½³å®è·µæ˜¯ï¼šç´¢å¼•æ—¶ç”¨ik_max_wordï¼Œåœ¨æœç´¢æ—¶ç”¨ik_smartã€‚
<strong>å³ï¼šç´¢å¼•æ—¶æœ€å¤§åŒ–çš„å°†æ–‡ç« å†…å®¹åˆ†è¯ï¼Œæœç´¢æ—¶æ›´ç²¾ç¡®çš„æœç´¢åˆ°æƒ³è¦çš„ç»“æœã€‚</strong></p>
<h1 id="ä¸‰-kibanaä½¿ç”¨-æŒæ¡dslè¯­å¥">ä¸‰ã€ Kibanaä½¿ç”¨-æŒæ¡DSLè¯­å¥</h1>
<p>æˆ‘ä»¬è¿™é‡Œéœ€è¦ä¸€ä¸ªæ›´ä¸“ä¸šçš„å·¥å…·å®ç°å¯¹æ—¥å¿—çš„å®æ—¶åˆ†æï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è®²çš„kibanaã€‚</p>
<p>Kibana æ˜¯ä¸€æ¬¾å¼€æºçš„æ•°æ®åˆ†æå’Œå¯è§†åŒ–å¹³å°ï¼Œå®ƒæ˜¯ Elastic Stack æˆå‘˜ä¹‹ä¸€ï¼Œè®¾è®¡ç”¨äºå’Œ Elasticsearch åä½œã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Kibana å¯¹ Elasticsearch ç´¢å¼•ä¸­çš„æ•°æ®è¿›è¡Œæœç´¢ã€æŸ¥çœ‹ã€äº¤äº’æ“ä½œã€‚æ‚¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ©ç”¨å›¾è¡¨ã€è¡¨æ ¼åŠåœ°å›¾å¯¹æ•°æ®è¿›è¡Œå¤šå…ƒåŒ–çš„åˆ†æå’Œå‘ˆç°ã€‚</p>
<p>Kibana å¯ä»¥ä½¿å¤§æ•°æ®é€šä¿—æ˜“æ‡‚ã€‚å®ƒå¾ˆç®€å•ï¼ŒåŸºäºæµè§ˆå™¨çš„ç•Œé¢ä¾¿äºæ‚¨å¿«é€Ÿåˆ›å»ºå’Œåˆ†äº«åŠ¨æ€æ•°æ®ä»ªè¡¨æ¿æ¥è¿½è¸ª Elasticsearch çš„å®æ—¶æ•°æ®å˜åŒ–ã€‚</p>
<p>æ­å»º Kibana éå¸¸ç®€å•ã€‚æ‚¨å¯ä»¥åˆ†åˆ†é’Ÿå®Œæˆ Kibana çš„å®‰è£…å¹¶å¼€å§‹æ¢ç´¢ Elasticsearch çš„ç´¢å¼•æ•°æ®â€‰â€”â€‰æ²¡æœ‰ä»£ç ã€ä¸éœ€è¦é¢å¤–çš„åŸºç¡€è®¾æ–½ã€‚</p>
<h3 id="31--kibanaä¸‹è½½å®‰è£…">3.1  Kibanaä¸‹è½½å®‰è£…</h3>
<p>æˆ‘ä»¬é¡¹ç›®ä¸­ä¸å†ä½¿ç”¨linuxï¼Œç›´æ¥ä½¿ç”¨Dockerï¼Œæ‰€æœ‰è¿™é‡Œå°±ä¸æ¼”ç¤ºåœ¨windowsçš„ä¸‹è½½å®‰è£…äº†ã€‚</p>
<p>(1)é•œåƒä¸‹è½½</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">docker</span> <span style="color:#d14">pull kibana:7.7.0</span>
</span></span></code></pre></div><p>ä¸ºäº†èŠ‚çœæ—¶é—´,å»ºè®®è¿˜åŸè™šæ‹Ÿæœºå¤‡ä»½æ–‡ä»¶</p>
<pre tabindex="0"><code>docker load -i kibana7.7.tar
</code></pre><p>(2)å®‰è£…kibanaå®¹å™¨</p>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¼€å§‹å®‰è£…kibanaå®¹å™¨</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">docker</span> <span style="color:#d14">run -di --link dym_es:elasticsearch --name kibana --restart=always -p 5601:5601 kibana:7.7.0</span>
</span></span></code></pre></div><p>restart=always:æ¯æ¬¡æœåŠ¡éƒ½ä¼šé‡å¯ï¼Œä¹Ÿå°±æ˜¯å¼€å¯å¯åŠ¨</p>
<p>5601:5601:ç«¯å£å·</p>
<p>(3)è®¿é—®æµ‹è¯•</p>
<p>è®¿é—®<code>http://192.168.188.128:5601</code>å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220527224880/image-20220527230531004.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="32-kibanaä½¿ç”¨">3.2 Kibanaä½¿ç”¨</h3>
<h4 id="321-é…ç½®ç´¢å¼•">3.2.1 é…ç½®ç´¢å¼•</h4>
<p>æ­¤å¤„æˆ‘ä»¬é€‰æ‹© å›¾ä¸­æ‰€ç¤ºï¼šè‡ªå·±çš„æ•°æ®
<img src="/posts/project-0/20220527224880/image-20220527230538800.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>é€‰æ‹©ä¸Šå›¾çš„è®¾ç½®å›¾æ ‡</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230551964.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥å’Œesè¿›è¡Œäº¤äº’äº†</p>
<h4 id="322-ç´¢å¼•ç®¡ç†">3.2.2 ç´¢å¼•ç®¡ç†</h4>
<p>è¦ä½¿ç”¨Kibanaï¼Œæ‚¨å¿…é¡»è‡³å°‘é…ç½®ä¸€ä¸ªç´¢å¼•ï¼ˆä½†æ˜¯è¦æ±‚Elasticsearchä¸­è¦æœ‰æ•°æ®ï¼‰ã€‚ç´¢å¼•ç”¨äºæ ‡è¯†Elasticsearchç´¢å¼•ä»¥è¿è¡Œæœç´¢å’Œåˆ†æã€‚å®ƒä»¬è¿˜ç”¨äºé…ç½®å­—æ®µç­‰ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹å¦‚ä½•ç®¡ç†æŸ¥çœ‹ç´¢å¼•ã€‚</p>
<p>ç‚¹å‡» è®¾ç½®-é€‰æ‹©D -Manager space</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230559697.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>é€‰æ‹© Index Patterns</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230612571.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åˆ›å»ºä¸€ä¸ªç´¢å¼•</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230621404.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ²¡æœ‰æ•°æ®ç›®å‰ä¸èƒ½å»ºç«‹ç´¢å¼•
<img src="/posts/project-0/20220527224880/image-20220527230629462.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åé¢æ·»åŠ è¿‡ç´¢å¼•å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æŸ¥çœ‹æ·»åŠ çš„ç´¢å¼•</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230637812.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>è¾“å…¥ç´¢å¼•è§„åˆ™ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥
<img src="/posts/project-0/20220527224880/image-20220527230648100.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç‚¹å‡»åˆ›å»º
<img src="/posts/project-0/20220527224880/image-20220527230654594.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åŸŸçš„æ¯ä¸ªæ ‡é¢˜é€‰é¡¹åˆ†åˆ«ä»£è¡¨å¦‚ä¸‹æ„æ€ï¼š
<img src="/posts/project-0/20220527224880/image-20220527230701373.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¹Ÿå¯ä»¥ç›´æ¥æŸ¥çœ‹ é€‰æ‹© Elasticsearch-Index Managerment æŸ¥çœ‹åˆ›å»ºçš„ç´¢å¼•
<img src="/posts/project-0/20220527224880/image-20220527230709653.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="323-dslè¯­å¥ä½¿ç”¨">3.2.3 DSLè¯­å¥ä½¿ç”¨</h4>
<h5 id="3231-query-dslç»“æ„åŒ–æŸ¥è¯¢ä»‹ç»">3.2.3.1 Query DSLç»“æ„åŒ–æŸ¥è¯¢ä»‹ç»</h5>
<p>Query DSLæ˜¯ä¸€ä¸ªJavaå¼€æºæ¡†æ¶ç”¨äºæ„å»ºç±»å‹å®‰å…¨çš„SQLæŸ¥è¯¢è¯­å¥ã€‚é‡‡ç”¨APIä»£æ›¿ä¼ ç»Ÿçš„æ‹¼æ¥å­—ç¬¦ä¸²æ¥æ„é€ æŸ¥è¯¢è¯­å¥ã€‚ç›®å‰Querydslæ”¯æŒçš„å¹³å°åŒ…æ‹¬JPA,JDOï¼ŒSQLï¼ŒJava Collectionsï¼ŒRDFï¼ŒLuceneï¼ŒHibernate Searchã€‚elasticsearchæä¾›äº†ä¸€æ•´å¥—åŸºäºJSONçš„æŸ¥è¯¢DSLè¯­è¨€æ¥å®šä¹‰æŸ¥è¯¢ã€‚
Query DSLå½“ä½œæ˜¯ä¸€ç³»åˆ—çš„æŠ½è±¡çš„æŸ¥è¯¢è¡¨è¾¾å¼æ ‘(AST)ç‰¹å®šæŸ¥è¯¢èƒ½å¤ŸåŒ…å«å…¶å®ƒçš„æŸ¥è¯¢ï¼Œ(å¦‚ bool ), æœ‰äº›æŸ¥è¯¢èƒ½å¤ŸåŒ…å«è¿‡æ»¤å™¨(å¦‚ constant_score), è¿˜æœ‰çš„å¯ä»¥åŒæ—¶åŒ…å«æŸ¥è¯¢å’Œè¿‡æ»¤å™¨ (å¦‚ filtered). éƒ½èƒ½å¤Ÿä»ESæ”¯æŒæŸ¥è¯¢é›†åˆé‡Œé¢é€‰æ‹©ä»»æ„ä¸€ä¸ªæŸ¥è¯¢æˆ–è€…æ˜¯ä»è¿‡æ»¤å™¨é›†åˆé‡Œé¢æŒ‘é€‰å‡ºä»»æ„ä¸€ä¸ªè¿‡æ»¤å™¨, è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ å‡ºä»»æ„å¤æ‚ï¼ˆmaybe éå¸¸æœ‰è¶£ï¼‰çš„æŸ¥è¯¢äº†ã€‚</p>
<h5 id="3232-æµ‹è¯•åˆ†è¯">3.2.3.2 æµ‹è¯•åˆ†è¯</h5>
<p>ï¼ˆ1ï¼‰ik_smart
<img src="/posts/project-0/20220527224880/image-20220527230718701.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">_analyze</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_smart&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;text&#34;</span>: <span style="color:#d14">&#34;ä¸­åäººæ°‘å…±å’Œå›½äººæ°‘å¤§ä¼šå ‚&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>(2) ik_max_word
<img src="/posts/project-0/20220527224880/image-20220527230726538.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">POST</span> <span style="color:#a61717;background-color:#e3d2d2">_analyze</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;analyzer&#34;</span>: <span style="color:#d14">&#34;ik_max_word&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;text&#34;</span>: <span style="color:#d14">&#34;ä¸­åäººæ°‘å…±å’Œå›½äººæ°‘å¤§ä¼šå ‚&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="å››æ•°æ®å¯¼å…¥es">å››ã€æ•°æ®å¯¼å…¥ES</h1>
<h3 id="41-springdata-elasticsearchä»‹ç»">4.1 SpringData Elasticsearchä»‹ç»</h3>
<h4 id="411-springdataä»‹ç»">4.1.1 SpringDataä»‹ç»</h4>
<p>Spring Dataæ˜¯ä¸€ä¸ªç”¨äºç®€åŒ–æ•°æ®åº“è®¿é—®ï¼Œå¹¶æ”¯æŒäº‘æœåŠ¡çš„å¼€æºæ¡†æ¶ã€‚å…¶ä¸»è¦ç›®æ ‡æ˜¯ä½¿å¾—å¯¹æ•°æ®çš„è®¿é—®å˜å¾—æ–¹ä¾¿å¿«æ·ï¼Œå¹¶æ”¯æŒmap-reduceæ¡†æ¶å’Œäº‘è®¡ç®—æ•°æ®æœåŠ¡ã€‚ Spring Dataå¯ä»¥æå¤§çš„ç®€åŒ–JPAçš„å†™æ³•ï¼Œå¯ä»¥åœ¨å‡ ä¹ä¸ç”¨å†™å®ç°çš„æƒ…å†µä¸‹ï¼Œå®ç°å¯¹æ•°æ®çš„è®¿é—®å’Œæ“ä½œã€‚é™¤äº†CRUDå¤–ï¼Œè¿˜åŒ…æ‹¬å¦‚åˆ†é¡µã€æ’åºç­‰ä¸€äº›å¸¸ç”¨çš„åŠŸèƒ½ã€‚</p>
<p>Spring Dataçš„å®˜ç½‘ï¼šhttps://spring.io/projects/spring-data</p>
<h4 id="412-springdata-esä»‹ç»">4.1.2 SpringData ESä»‹ç»</h4>
<p>Spring Data ElasticSearch åŸºäº spring data API ç®€åŒ– elasticSearchæ“ä½œï¼Œå°†åŸå§‹æ“ä½œelasticSearchçš„å®¢æˆ·ç«¯API è¿›è¡Œå°è£… ã€‚Spring Dataä¸ºElasticsearché¡¹ç›®æä¾›é›†æˆæœç´¢å¼•æ“ã€‚Spring Data Elasticsearch POJOçš„å…³é”®åŠŸèƒ½åŒºåŸŸä¸ºä¸­å¿ƒçš„æ¨¡å‹ä¸Elastichsearchäº¤äº’æ–‡æ¡£å’Œè½»æ¾åœ°ç¼–å†™ä¸€ä¸ªå­˜å‚¨åº“æ•°æ®è®¿é—®å±‚ã€‚ å®˜æ–¹ç½‘ç«™ï¼šhttps://spring.io/projects/spring-data-elasticsearch</p>
<h3 id="42-æœç´¢å·¥ç¨‹æ­å»º">4.2 æœç´¢å·¥ç¨‹æ­å»º</h3>
<p>åˆ›å»ºæœç´¢å¾®æœåŠ¡å·¥ç¨‹ï¼Œdongyimai-search-service,è¯¥å·¥ç¨‹ä¸»è¦æä¾›æœç´¢æœåŠ¡ä»¥åŠç´¢å¼•æ•°æ®çš„æ›´æ–°æ“ä½œã€‚</p>
<p>(1)APIå·¥ç¨‹æ­å»º</p>
<p>é¦–å…ˆåˆ›å»ºsearchçš„APIå·¥ç¨‹,åœ¨dongyimai-service-apiä¸­åˆ›å»ºdongyimai-search-service-apiï¼Œå¦‚ä¸‹å›¾ï¼š
<img src="/posts/project-0/20220527224880/image-20220527230738835.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>pom.xmlå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>0.0.1<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-search-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;maven.compiler.source&gt;</span>8<span style="color:#000080">&lt;/maven.compiler.source&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;maven.compiler.target&gt;</span>8<span style="color:#000080">&lt;/maven.compiler.target&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--goods APIä¾èµ–--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-sellergoods-serivce-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--SpringDataESä¾èµ–--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-data-elasticsearch<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)æœç´¢å¾®æœåŠ¡æ­å»º</p>
<p>åœ¨dongyimai-serviceä¸­æ­å»ºdongyimai-search-serviceå¾®æœåŠ¡ï¼Œå¹¶è¿›è¡Œç›¸å…³é…ç½®ã€‚</p>
<p><strong>pom.xmlé…ç½®</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-service<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>0.0.1<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-search-service<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;maven.compiler.source&gt;</span>8<span style="color:#000080">&lt;/maven.compiler.source&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;maven.compiler.target&gt;</span>8<span style="color:#000080">&lt;/maven.compiler.target&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-search-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p><strong>application.ymlé…ç½®</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#008080">server</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">port</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">9005</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">spring</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">application</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">search</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">elasticsearch</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">rest</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">uris</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">192.168.188.128:9200  #æ­¤å¤„é…ç½®elasticsearchçš„è®¿é—®åœ°å€  </span>
</span></span><span style="display:flex;"><span><span style="color:#008080">eureka</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">client</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">service-url</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">defaultZone</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">http://127.0.0.1:8761/eureka</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">prefer-ip-address</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">feign</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">hystrix</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">enabled</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#è¶…æ—¶é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">ribbon</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">ReadTimeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">300000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008080">hystrix</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">command</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">execution</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008080">isolation</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#008080">thread</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#008080">timeoutInMilliseconds</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">10000</span>
</span></span></code></pre></div><p>(3)å¯åŠ¨ç±»</p>
<p>åˆ›å»ºSearchApplicationä½œä¸ºæœç´¢å¾®æœåŠ¡å·¥ç¨‹çš„å¯åŠ¨ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span><span style="color:#000;font-weight:bold">(</span>exclude <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>DruidDataSourceAutoConfigure<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> DataSourceAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SearchApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>SearchApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>åˆ†åˆ«åˆ›å»ºå¯¹åº”çš„åŒ…ï¼Œdaoã€serviceã€controllerï¼Œå¦‚ä¸‹å›¾ï¼š
<img src="/posts/project-0/20220527224880/image-20220527230750192.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="43-æ•°æ®å¯¼å…¥">4.3 æ•°æ®å¯¼å…¥</h3>
<p>ç°åœ¨éœ€è¦å°†æ•°æ®ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥ï¼Œç„¶åå°†æ•°æ®å¯¼å…¥åˆ°ESä¸­ã€‚
<img src="/posts/project-0/20220527224880/image-20220527230758388.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ•°æ®å¯¼å…¥æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">1.è¯·æ±‚searchæœåŠ¡,è°ƒç”¨æ•°æ®å¯¼å…¥åœ°å€</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">2.æ ¹æ®æ³¨å†Œä¸­å¿ƒä¸­çš„æ³¨å†Œçš„goodsæœåŠ¡çš„åœ°å€ï¼Œä½¿ç”¨Feignæ–¹å¼æŸ¥è¯¢æ‰€æœ‰å·²ç»å®¡æ ¸çš„Sku</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">3.ä½¿ç”¨SpringData</span> <span style="color:#d14">Eså°†æŸ¥è¯¢åˆ°çš„Skué›†åˆå¯¼å…¥åˆ°ESä¸­</span>
</span></span></code></pre></div><h4 id="431-æ–‡æ¡£æ˜ å°„beanåˆ›å»º">4.3.1 æ–‡æ¡£æ˜ å°„Beanåˆ›å»º</h4>
<p>æœç´¢å•†å“çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å¦‚ä¸‹å±æ€§æœç´¢æ•°æ®,å¹¶ä¸”ä¸æ˜¯æ‰€æœ‰çš„å±æ€§éƒ½éœ€è¦åˆ†è¯æœç´¢ï¼Œæˆ‘ä»¬åˆ›å»ºJavaBeanï¼Œå°†JavaBeanæ•°æ®å­˜å…¥åˆ°ESä¸­è¦ä»¥æœç´¢æ¡ä»¶å’Œæœç´¢å±•ç¤ºç»“æœä¸ºä¾æ®ï¼Œéƒ¨åˆ†å…³é”®æœç´¢æ¡ä»¶åˆ†æå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">1.å¯èƒ½ä¼šæ ¹æ®å•†å“åç§°æœç´¢ï¼Œè€Œä¸”å¯ä»¥æœç´¢å•†å“åç§°ä¸­çš„ä»»æ„ä¸€ä¸ªè¯è¯­ï¼Œæ‰€ä»¥éœ€è¦åˆ†è¯</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">2.å¯èƒ½ä¼šæ ¹æ®å•†å“åˆ†ç±»æœç´¢ï¼Œå•†å“åˆ†ç±»ä¸éœ€è¦åˆ†è¯</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">3.å¯èƒ½ä¼šæ ¹æ®å•†å“å“ç‰Œæœç´¢ï¼Œå•†å“å“ç‰Œä¸éœ€è¦åˆ†è¯</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">4.å¯èƒ½ä¼šæ ¹æ®å•†å“å•†å®¶æœç´¢ï¼Œå•†å“å•†å®¶ä¸éœ€è¦åˆ†è¯</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">5.å¯èƒ½æ ¹æ®è§„æ ¼è¿›è¡Œæœç´¢ï¼Œè§„æ ¼æ—¶ä¸€ä¸ªé”®å€¼å¯¹ç»“æ„ï¼Œç”¨Map</span>
</span></span></code></pre></div><p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥åœ¨dongyimai-search-service-apiå·¥ç¨‹ä¸­åˆ›å»ºcom.offcn.search.pojo.SkuInfoï¼Œå¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Document</span><span style="color:#000;font-weight:bold">(</span>indexName <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;skuinfo&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SkuInfo</span> <span style="color:#000;font-weight:bold">implements</span> Serializable <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å•†å“idï¼ŒåŒæ—¶ä¹Ÿæ˜¯å•†å“ç¼–å·
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Long id<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//SKUåç§°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Field</span><span style="color:#000;font-weight:bold">(</span>type <span style="color:#000;font-weight:bold">=</span> FieldType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Text</span><span style="color:#000;font-weight:bold">,</span> analyzer <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;ik_smart&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String title<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å•†å“ä»·æ ¼ï¼Œå•ä½ä¸ºï¼šå…ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Field</span><span style="color:#000;font-weight:bold">(</span>type <span style="color:#000;font-weight:bold">=</span> FieldType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Double</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> BigDecimal price<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åº“å­˜æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> Integer num<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å•†å“å›¾ç‰‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String image<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å•†å“çŠ¶æ€ï¼Œ1-æ­£å¸¸ï¼Œ2-ä¸‹æ¶ï¼Œ3-åˆ é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String status<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//åˆ›å»ºæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> Date createTime<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ›´æ–°æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> Date updateTime<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ˜¯å¦é»˜è®¤
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String isDefault<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//goodsId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> Long goodsId<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//ç±»ç›®ID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> Long categoryId<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//ç±»ç›®åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   <span style="color:#998;font-style:italic">// @Field(type = FieldType.Keyword)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String category<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å“ç‰Œåç§°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   <span style="color:#998;font-style:italic">// @Field(type = FieldType.Keyword)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String brand<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è§„æ ¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String spec<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è§„æ ¼å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> specMap<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å¯¹åº”çš„getã€setæ–¹æ³•çœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">....</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="432-æœç´¢å®¡æ ¸é€šè¿‡sku">4.3.2 æœç´¢å®¡æ ¸é€šè¿‡Sku</h4>
<p>ä¿®æ”¹dongyimai-sellergoods-serviceå¾®æœåŠ¡ï¼Œæ·»åŠ æœç´¢å®¡æ ¸é€šè¿‡çš„Skuï¼Œä¾›searchå¾®æœåŠ¡è°ƒç”¨ã€‚</p>
<p><strong>ä¸‹é¢éƒ½æ˜¯é’ˆå¯¹goodså¾®æœåŠ¡çš„æ“ä½œã€‚</strong></p>
<p>ä¿®æ”¹ItemServiceæ¥å£ï¼Œæ·»åŠ æ ¹æ®çŠ¶æ€æŸ¥è¯¢Skuæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * æ ¹æ®çŠ¶æ€æŸ¥è¯¢SKUåˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span>  List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findByStatus</span><span style="color:#000;font-weight:bold">(</span>String status<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä¿®æ”¹ItemServiceImplï¼Œæ·»åŠ æ ¹æ®çŠ¶æ€æŸ¥è¯¢Skuå®ç°æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findByStatus</span><span style="color:#000;font-weight:bold">(</span>String status<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        QueryWrapper<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> queryWrapper <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> QueryWrapper<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        queryWrapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">eq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;status&#34;</span><span style="color:#000;font-weight:bold">,</span>status<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">list</span><span style="color:#000;font-weight:bold">(</span>queryWrapper<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹com.offcn.sellergoods.controller.ItemControllerï¼Œæ·»åŠ æ ¹æ®å®¡æ ¸çŠ¶æ€æŸ¥è¯¢Skuæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®å®¡æ ¸çŠ¶æ€æŸ¥è¯¢Sku
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param status
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/status/{status}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result<span style="color:#000;font-weight:bold">&lt;</span>List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#900;font-weight:bold">findByStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> String status<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> list <span style="color:#000;font-weight:bold">=</span> itemService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByStatus</span><span style="color:#000;font-weight:bold">(</span>status<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">&lt;</span>List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;&gt;(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;æŸ¥è¯¢æˆåŠŸ&#34;</span><span style="color:#000;font-weight:bold">,</span>list<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>è®¿é—®åœ°å€ï¼šhttp://localhost:9001/item/status/1
<img src="/posts/project-0/20220527224880/image-20220527230811094.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="433-skuå¯¼å…¥eså®ç°">4.3.3 Skuå¯¼å…¥ESå®ç°</h4>
<p>(1) Feigné…ç½®</p>
<p>ä¿®æ”¹dongyimai-sellergoods-service-apiå·¥ç¨‹ï¼Œåœ¨com.offcn.sellergoods.feign.ItemFeignä¸Šæ·»åŠ findSkuListæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>value<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dym-sellergoods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">ItemFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®å®¡æ ¸çŠ¶æ€æŸ¥è¯¢Sku
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param status
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/item/status/{status}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#900;font-weight:bold">findByStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> String status<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2) Daoåˆ›å»º</p>
<p>ä¿®æ”¹dongyimai-search-serviceå·¥ç¨‹ï¼Œåˆ›å»ºcom.dongyimai.search.dao.SkuEsMapper,è¯¥æ¥å£ä¸»è¦ç”¨äºç´¢å¼•æ•°æ®æ“ä½œï¼Œä¸»è¦ä½¿ç”¨å®ƒæ¥å®ç°å°†æ•°æ®å¯¼å…¥åˆ°ESç´¢å¼•åº“ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Repository</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">SkuEsMapper</span> <span style="color:#000;font-weight:bold">extends</span> ElasticsearchRepository<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">,</span>Long<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3) æœåŠ¡å±‚åˆ›å»º</p>
<p>ä¿®æ”¹dongyimai-search-serviceå·¥ç¨‹ï¼Œåˆ›å»ºcom.dongyimai.search.service.SkuService,ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">SkuService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å¯¼å…¥SKUæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">importSku</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹dongyimai-search-serviceå·¥ç¨‹ï¼Œåˆ›å»ºcom.offcn.search.service.impl.SkuServiceImpl,å®ç°Skuæ•°æ®å¯¼å…¥åˆ°ESä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SkuServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> SkuService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SkuEsMapper skuEsMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ItemFeign itemFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">importSku</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è°ƒç”¨å•†å“å¾®æœåŠ¡ï¼Œè·å–skuå•†å“æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Result<span style="color:#000;font-weight:bold">&lt;</span>List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;&gt;</span> result <span style="color:#000;font-weight:bold">=</span> itemFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#998;font-style:italic">//æŠŠè¿”å›çš„ç»“æœè¿”å›æœç´¢å®ä½“ç±»æ•°æ®é›†åˆ(é‡‡ç”¨æ·±å…‹éš†æŠ€æœ¯ï¼ŒæŠŠItemå¯¹è±¡å±æ€§å€¼å¤åˆ¶åˆ°SkuInfoå¯¹è±¡)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuInfoList <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseArray</span><span style="color:#000;font-weight:bold">(</span>JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">()),</span> SkuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//éå†skué›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SkuInfo skuInfo <span style="color:#000;font-weight:bold">:</span> skuInfoList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è·å–è§„æ ¼jsonå­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºmapå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>          Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>skuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSpec</span><span style="color:#000;font-weight:bold">(),</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>          <span style="color:#998;font-style:italic">//å…³è”è®¾ç½®åˆ°specMap
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            skuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSpecMap</span><span style="color:#000;font-weight:bold">(</span>specMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//ä¿å­˜skué›†åˆæ•°æ®åˆ°es
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        skuEsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">saveAll</span><span style="color:#000;font-weight:bold">(</span>skuInfoList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)æ§åˆ¶å±‚é…ç½®</p>
<p>ä¿®æ”¹dongyimai-search-serviceå·¥ç¨‹ï¼Œåœ¨com.offcn.search.controller.SkuControllerç±»ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•è°ƒç”¨ä¸Šè¿°å¯¼å…¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/search&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SkuController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SkuService skuService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å¯¼å…¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/import&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">search</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        skuService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">importSku</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;å¯¼å…¥æ•°æ®åˆ°ç´¢å¼•åº“ä¸­æˆåŠŸï¼&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)ä¿®æ”¹å¯åŠ¨ç±»</p>
<p>å¯åŠ¨ç±»ä¸­éœ€è¦å¼€å¯Feignå®¢æˆ·ç«¯ï¼Œå¹¶ä¸”éœ€è¦æ·»åŠ ESåŒ…æ‰«æï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span><span style="color:#000;font-weight:bold">(</span>exclude<span style="color:#000;font-weight:bold">={</span>DataSourceAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;com.offcn.sellergoods.feign&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableElasticsearchRepositories</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;com.offcn.search.dao&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SearchApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>SearchApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ³¨æ„å¦‚æœå‡ºç°é”™è¯¯ï¼š
<img src="/posts/project-0/20220527224880/image-20220527230823397.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>è§£å†³åŠæ³•ï¼Œä¿®æ”¹application.ymlå¢åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">main</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">allow-bean-definition-overriding</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>(6)æµ‹è¯•</p>
<p>è°ƒç”¨http://localhost:9005/search/importè¿›è¡Œæµ‹è¯•</p>
<p>æ‰“å¼€Kibanaå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ•°æ®ï¼š</p>
<p><code>http://192.168.188.128:5601</code></p>
<pre tabindex="0"><code>GET /skuinfo/_search
</code></pre><p><img src="/posts/project-0/20220527224880/image-20220527230830310.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="äº”å…³é”®å­—æœç´¢">äº”ã€å…³é”®å­—æœç´¢</h1>
<p><img src="/posts/project-0/20220527224880/image-20220527230835463.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æˆ‘ä»¬å…ˆä½¿ç”¨SpringDataElasticsearchå®ç°ä¸€ä¸ªç®€å•çš„æœç´¢åŠŸèƒ½ï¼Œå…ˆå®ç°æ ¹æ®å…³é”®å­—æœç´¢ï¼Œä»ä¸Šé¢æœç´¢å›¾ç‰‡å¯ä»¥çœ‹å¾—åˆ°ï¼Œæ¯æ¬¡æœç´¢çš„æ—¶å€™ï¼Œé™¤äº†å…³é”®å­—å¤–ï¼Œè¿˜æœ‰å¯èƒ½æœ‰å“ç‰Œã€åˆ†ç±»ã€è§„æ ¼ç­‰ï¼Œåå°æ¥æ”¶æœç´¢æ¡ä»¶ä½¿ç”¨Mapæ¥æ”¶æ¯”è¾ƒåˆé€‚ã€‚</p>
<h3 id="51-æœåŠ¡å±‚å®ç°">5.1 æœåŠ¡å±‚å®ç°</h3>
<p>ä¿®æ”¹searchæœåŠ¡çš„com.offcn.search.service.SkuService,æ·»åŠ æœç´¢æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * æœç´¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param searchMap
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span>Map <span style="color:#900;font-weight:bold">search</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> searchMap<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä¿®æ”¹searchæœåŠ¡çš„com.dongyimai.search.service.impl.SkuServiceImpl,æ·»åŠ æœç´¢å®ç°æ–¹æ³•,ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map <span style="color:#900;font-weight:bold">search</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> searchMap<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#998;font-style:italic">//1.è·å–å…³é”®å­—çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   String keywords <span style="color:#000;font-weight:bold">=</span> searchMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;keywords&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>keywords<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        keywords <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;åä¸º&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//èµ‹å€¼ç»™ä¸€ä¸ªé»˜è®¤çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#998;font-style:italic">//2.åˆ›å»ºæŸ¥è¯¢å¯¹è±¡ çš„æ„å»ºå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      NativeSearchQueryBuilder nativeSearchQueryBuilder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NativeSearchQueryBuilder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#998;font-style:italic">//3.è®¾ç½®æŸ¥è¯¢çš„æ¡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//ä½¿ç”¨ï¼šQueryBuilders.matchQuery(&#34;title&#34;, keywords) ï¼Œæœç´¢åä¸º ---&gt; å    ä¸º äºŒå­—å¯ä»¥æ‹†åˆ†æŸ¥è¯¢ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//ä½¿ç”¨ï¼šQueryBuilders.matchPhraseQuery(&#34;title&#34;, keywords) åä¸ºäºŒå­—ä¸æ‹†åˆ†æŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withQuery</span><span style="color:#000;font-weight:bold">(</span>QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">matchQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> keywords<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4.æ„å»ºæŸ¥è¯¢å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        NativeSearchQuery query <span style="color:#000;font-weight:bold">=</span> nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//5.æ‰§è¡ŒæŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchHits<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> searchHits <span style="color:#000;font-weight:bold">=</span> elasticsearchRestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>query<span style="color:#000;font-weight:bold">,</span> SkuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å¯¹æœç´¢searchHitsé›†åˆè¿›è¡Œåˆ†é¡µå°è£…
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchPage<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuPage <span style="color:#000;font-weight:bold">=</span> SearchHitSupport<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">searchPageFor</span><span style="color:#000;font-weight:bold">(</span>searchHits<span style="color:#000;font-weight:bold">,</span> query<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPageable</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//éå†å–å‡ºæŸ¥è¯¢çš„å•†å“ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SearchHit<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> searchHit <span style="color:#000;font-weight:bold">:</span>skuPage<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContent</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// è·å–æœç´¢åˆ°çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            SkuInfo content <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SkuInfo<span style="color:#000;font-weight:bold">)</span> searchHit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContent</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            SkuInfo skuInfo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SkuInfo<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//æŠŠä¸€ä¸ªå¯¹è±¡å±æ€§å€¼å¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªå¯¹è±¡ï¼šä¸¤ä¸ªå¯¹è±¡å±æ€§åç§°å¿…é¡»ä¸€è‡´ï¼Œå±æ€§ç±»å‹å¿…é¡»ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            BeanUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">copyProperties</span><span style="color:#000;font-weight:bold">(</span>content<span style="color:#000;font-weight:bold">,</span> skuInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            skuList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>skuInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//6.è¿”å›ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map resultMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;rows&#34;</span><span style="color:#000;font-weight:bold">,</span> skuList<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//è·å–æ‰€éœ€SkuInfoé›†åˆæ•°æ®å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total&#34;</span><span style="color:#000;font-weight:bold">,</span>searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">());</span><span style="color:#998;font-style:italic">//æ€»è®°å½•æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;totalPages&#34;</span><span style="color:#000;font-weight:bold">,</span> skuPage<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalPages</span><span style="color:#000;font-weight:bold">());</span><span style="color:#998;font-style:italic">//æ€»é¡µæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> resultMap<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>æ³¨æ„</strong>: ElasticSearchTemplateæ›´å¤šæ˜¯å¯¹ESRepositoryçš„è¡¥å……ï¼Œé‡Œé¢æä¾›äº†ä¸€äº›æ›´åº•å±‚çš„æ–¹æ³•,æ›´åŠ é€‚ç”¨äºæŸ¥è¯¢æ•°æ®</p>
<h3 id="52-æ§åˆ¶å±‚å®ç°">5.2 æ§åˆ¶å±‚å®ç°</h3>
<p>ä¿®æ”¹com.offcn.search.controller.SkuControllerï¼Œåœ¨æ§åˆ¶å±‚è°ƒç”¨Serviceå±‚å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * æœç´¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param searchMap
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@PostMapping</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map <span style="color:#900;font-weight:bold">search</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestBody</span><span style="color:#000;font-weight:bold">(</span>required <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span> Map searchMap<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>  skuService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>searchMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="53-æµ‹è¯•">5.3 æµ‹è¯•</h3>
<p>ä½¿ç”¨Postmanå·¥å…·ï¼Œè¾“å…¥http://localhost:9005/search</p>
<p>é€‰ä¸­POSTæäº¤
<img src="/posts/project-0/20220527224880/image-20220527230845070.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="å…­-åˆ†ç±»ç»Ÿè®¡">å…­ã€ åˆ†ç±»ç»Ÿè®¡</h1>
<h3 id="61-åˆ†ç±»ç»Ÿè®¡åˆ†æ">6.1 åˆ†ç±»ç»Ÿè®¡åˆ†æ</h3>
<p>çœ‹ä¸‹é¢çš„SQLè¯­å¥ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œæœç´¢çš„æ—¶å€™ï¼Œç¬¬1æ¡SQLè¯­å¥æ˜¯æ‰§è¡Œæœï¼Œç¬¬2æ¡è¯­å¥æ˜¯æ ¹æ®åˆ†ç±»åå­—åˆ†ç»„æŸ¥çœ‹æœ‰å¤šå°‘åˆ†ç±»ï¼Œå¤§æ¦‚æ‰§è¡Œäº†2ä¸ªæ­¥éª¤å°±å¯ä»¥è·å–æ•°æ®ç»“æœä»¥åŠåˆ†ç±»ç»Ÿè®¡ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä»–ä»¬çš„æœç´¢æ¡ä»¶å®Œå…¨ä¸€æ ·ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#998;font-style:italic">-- æŸ¥è¯¢æ‰€æœ‰
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>tb_item<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>title<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">LIKE</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;%æ‰‹æœº%&#39;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- æ ¹æ®åˆ†ç±»åå­—åˆ†ç»„æŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>category<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb">  </span>tb_item<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>title<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">LIKE</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;%æ‰‹æœº%&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">BY</span><span style="color:#bbb"> </span>category;<span style="color:#bbb">
</span></span></span></code></pre></div><p><img src="/posts/project-0/20220527224880/image-20220527230852516.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æˆ‘ä»¬æ¯æ¬¡æ‰§è¡Œæœç´¢çš„æ—¶å€™ï¼Œéœ€è¦æ˜¾ç¤ºå•†å“åˆ†ç±»åç§°ï¼Œè¿™é‡Œè¦æ˜¾ç¤ºçš„åˆ†ç±»åç§°å…¶å®å°±æ˜¯ç¬¦åˆæœç´ æ¡ä»¶çš„æ‰€æœ‰å•†å“çš„åˆ†ç±»é›†åˆï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„å®ç°æ€è·¯ï¼Œä½¿ç”¨ESæ ¹æ®åˆ†ç»„åç§°åšä¸€æ¬¡åˆ†ç»„æŸ¥è¯¢å³å¯å®ç°ã€‚</p>
<h3 id="62-åˆ†ç±»åˆ†ç»„ç»Ÿè®¡å®ç°">6.2 åˆ†ç±»åˆ†ç»„ç»Ÿè®¡å®ç°</h3>
<p>ä¿®æ”¹searchå¾®æœåŠ¡çš„com.offcn.search.service.impl.SkuServiceImplç±»ï¼Œæ•´ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">public</span> Map <span style="color:#900;font-weight:bold">search</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> searchMap<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//1.è·å–å…³é”®å­—çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String keywords <span style="color:#000;font-weight:bold">=</span> searchMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;keywords&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>keywords<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            keywords <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;åä¸º&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//èµ‹å€¼ç»™ä¸€ä¸ªé»˜è®¤çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2.åˆ›å»ºæŸ¥è¯¢å¯¹è±¡ çš„æ„å»ºå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        NativeSearchQueryBuilder nativeSearchQueryBuilder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NativeSearchQueryBuilder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// è®¾ç½®åˆ†ç»„çš„æ¡ä»¶  termsåè¡¨ç¤ºåˆ†ç»„æŸ¥è¯¢åçš„åˆ—å,æ³¨æ„æœç´¢å­—æ®µåé¢åŠ .keyword
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAggregation</span><span style="color:#000;font-weight:bold">(</span>AggregationBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">terms</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;skuCategorygroup&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;category.keyword&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3.è®¾ç½®æŸ¥è¯¢çš„æ¡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//ä½¿ç”¨ï¼šQueryBuilders.matchQuery(&#34;title&#34;, keywords) ï¼Œæœç´¢åä¸º ---&gt; å    ä¸º äºŒå­—å¯ä»¥æ‹†åˆ†æŸ¥è¯¢ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//ä½¿ç”¨ï¼šQueryBuilders.matchPhraseQuery(&#34;title&#34;, keywords) åä¸ºäºŒå­—ä¸æ‹†åˆ†æŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withQuery</span><span style="color:#000;font-weight:bold">(</span>QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">matchQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> keywords<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4.æ„å»ºæŸ¥è¯¢å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        NativeSearchQuery query <span style="color:#000;font-weight:bold">=</span> nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//5.æ‰§è¡ŒæŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchHits<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> searchHits <span style="color:#000;font-weight:bold">=</span> elasticsearchRestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>query<span style="color:#000;font-weight:bold">,</span> SkuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å¯¹æœç´¢searchHitsé›†åˆè¿›è¡Œåˆ†é¡µå°è£…
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchPage<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuPage <span style="color:#000;font-weight:bold">=</span> SearchHitSupport<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">searchPageFor</span><span style="color:#000;font-weight:bold">(</span>searchHits<span style="color:#000;font-weight:bold">,</span> query<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPageable</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–åˆ†ç»„ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Terms terms <span style="color:#000;font-weight:bold">=</span> searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAggregations</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;skuCategorygroup&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// è·å–åˆ†ç±»åç§°é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>terms <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Bucket</span> bucket <span style="color:#000;font-weight:bold">:</span> terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBuckets</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                String keyAsString <span style="color:#000;font-weight:bold">=</span> bucket<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKeyAsString</span><span style="color:#000;font-weight:bold">();</span><span style="color:#998;font-style:italic">// åˆ†ç»„çš„å€¼ï¼ˆåˆ†ç±»åç§°ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                categoryList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>keyAsString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//éå†å–å‡ºæŸ¥è¯¢çš„å•†å“ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SearchHit<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> searchHit <span style="color:#000;font-weight:bold">:</span>skuPage<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContent</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// è·å–æœç´¢åˆ°çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            SkuInfo content <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SkuInfo<span style="color:#000;font-weight:bold">)</span> searchHit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContent</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            SkuInfo skuInfo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SkuInfo<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            BeanUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">copyProperties</span><span style="color:#000;font-weight:bold">(</span>content<span style="color:#000;font-weight:bold">,</span> skuInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            skuList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>skuInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//6.è¿”å›ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map resultMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;rows&#34;</span><span style="color:#000;font-weight:bold">,</span> skuList<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//è·å–æ‰€éœ€SkuInfoé›†åˆæ•°æ®å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total&#34;</span><span style="color:#000;font-weight:bold">,</span>searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">());</span><span style="color:#998;font-style:italic">//æ€»è®°å½•æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;totalPages&#34;</span><span style="color:#000;font-weight:bold">,</span> skuPage<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalPages</span><span style="color:#000;font-weight:bold">());</span><span style="color:#998;font-style:italic">//æ€»é¡µæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;categoryList&#34;</span><span style="color:#000;font-weight:bold">,</span>categoryList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> resultMap<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ·»åŠ çš„ä»£ç å¦‚ä¸‹:
<img src="/posts/project-0/20220527224880/image-20220527230901579.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220527224880/image-20220527230908138.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220527224880/image-20220527230914696.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ³¨æ„åˆ†ç»„æœç´¢è¦åŠ keywordï¼Œå› ä¸ºæ•°æ®å­˜å‚¨ç»“æ„æ˜¯keywordç±»å‹</p>
<p>å…·ä½“æŸ¥çœ‹æ•°æ®ç»“æ„å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<pre tabindex="0"><code>GET /skuinfo/_mapping
</code></pre><p><img src="/posts/project-0/20220527224880/image-20220527230921890.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="63-æµ‹è¯•">6.3 æµ‹è¯•</h3>
<p>è¯·æ±‚http://localhost:9005/search
<img src="/posts/project-0/20220527224880/image-20220527230928474.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="64-ä»£ç ä¼˜åŒ–">6.4 ä»£ç ä¼˜åŒ–</h3>
<p>å¦‚ä¸Š,å¯ä»¥å°†è·å–åˆ†ç»„çš„ä»£ç è¿›è¡Œæå–,å¦‚ä¸‹ä»£ç æ‰€ç¤º:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è·å–åˆ†ç±»åˆ—è¡¨æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param terms
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getStringsCategoryList</span><span style="color:#000;font-weight:bold">(</span>Terms terms<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>terms <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Bucket</span> bucket <span style="color:#000;font-weight:bold">:</span> terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBuckets</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                String keyAsString <span style="color:#000;font-weight:bold">=</span> bucket<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKeyAsString</span><span style="color:#000;font-weight:bold">();</span><span style="color:#998;font-style:italic">// åˆ†ç»„çš„å€¼ï¼ˆåˆ†ç±»åç§°ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                categoryList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>keyAsString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> categoryList<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>åœ¨searchæ–¹æ³•ä¸­è¿›è¡Œè°ƒç”¨:
<img src="/posts/project-0/20220527224880/image-20220527230939376.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// è·å–åˆ†ç±»åç§°é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringsCategoryList</span><span style="color:#000;font-weight:bold">(</span>terms<span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>æ•´ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.search.service.impl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.entity.Result</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.search.dao.SkuEsMapper</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.search.pojo.SkuInfo</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.search.service.SkuService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.sellergoods.feign.SkuFeign</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.sellergoods.pojo.Item</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.commons.lang.StringUtils</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.index.query.QueryBuilders</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.search.aggregations.AggregationBuilders</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.search.aggregations.bucket.terms.Terms</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.BeanUtils</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.data.elasticsearch.core.*</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.data.elasticsearch.core.query.NativeSearchQuery</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.ArrayList</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.List</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SkuServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> SkuService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SkuEsMapper skuEsMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> SkuFeign skuFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å¯¼å…¥SKUæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">importSku</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è°ƒç”¨å•†å“å¾®æœåŠ¡ï¼Œè·å–skuå•†å“æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Result<span style="color:#000;font-weight:bold">&lt;</span>List<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;&gt;</span> result <span style="color:#000;font-weight:bold">=</span> skuFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æŠŠæ•°æ®è½¬æ¢ä¸ºæœç´¢å®ä½“ç±»æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuInfoList <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseArray</span><span style="color:#000;font-weight:bold">(</span>JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toJSONString</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">()),</span> SkuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//éå†skué›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SkuInfo skuInfo <span style="color:#000;font-weight:bold">:</span> skuInfoList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è·å–è§„æ ¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> specMap <span style="color:#000;font-weight:bold">=</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>skuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSpec</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//å…³è”è®¾ç½®åˆ°specMap
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            skuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSpecMap</span><span style="color:#000;font-weight:bold">(</span>specMap<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//ä¿å­˜skué›†åˆæ•°æ®åˆ°es
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        skuEsMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">saveAll</span><span style="color:#000;font-weight:bold">(</span>skuInfoList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map <span style="color:#900;font-weight:bold">search</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> searchMap<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//1.è·å–å…³é”®å­—çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String keywords <span style="color:#000;font-weight:bold">=</span> searchMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;keywords&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>keywords<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            keywords <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;åä¸º&#34;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//èµ‹å€¼ç»™ä¸€ä¸ªé»˜è®¤çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2.åˆ›å»ºæŸ¥è¯¢å¯¹è±¡ çš„æ„å»ºå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        NativeSearchQueryBuilder nativeSearchQueryBuilder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NativeSearchQueryBuilder<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// è®¾ç½®åˆ†ç»„çš„æ¡ä»¶  termsåè¡¨ç¤ºåˆ†ç»„æŸ¥è¯¢åçš„åˆ—å
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAggregation</span><span style="color:#000;font-weight:bold">(</span>AggregationBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">terms</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;skuCategorygroup&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;category.keyword&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3.è®¾ç½®æŸ¥è¯¢çš„æ¡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//ä½¿ç”¨ï¼šQueryBuilders.matchQuery(&#34;title&#34;, keywords) ï¼Œæœç´¢åä¸º ---&gt; å    ä¸º äºŒå­—å¯ä»¥æ‹†åˆ†æŸ¥è¯¢ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//ä½¿ç”¨ï¼šQueryBuilders.matchPhraseQuery(&#34;title&#34;, keywords) åä¸ºäºŒå­—ä¸æ‹†åˆ†æŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withQuery</span><span style="color:#000;font-weight:bold">(</span>QueryBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">matchQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> keywords<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4.æ„å»ºæŸ¥è¯¢å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        NativeSearchQuery query <span style="color:#000;font-weight:bold">=</span> nativeSearchQueryBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//5.æ‰§è¡ŒæŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchHits<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> searchHits <span style="color:#000;font-weight:bold">=</span> elasticsearchRestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>query<span style="color:#000;font-weight:bold">,</span> SkuInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//å¯¹æœç´¢searchHitsé›†åˆè¿›è¡Œåˆ†é¡µå°è£…
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        SearchPage<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuPage <span style="color:#000;font-weight:bold">=</span> SearchHitSupport<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">searchPageFor</span><span style="color:#000;font-weight:bold">(</span>searchHits<span style="color:#000;font-weight:bold">,</span> query<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPageable</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–åˆ†ç»„ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Terms terms <span style="color:#000;font-weight:bold">=</span> searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAggregations</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;skuCategorygroup&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// è·å–åˆ†ç±»åç§°é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringsCategoryList</span><span style="color:#000;font-weight:bold">(</span>terms<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//éå†å–å‡ºæŸ¥è¯¢çš„å•†å“ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> skuList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>SearchHit<span style="color:#000;font-weight:bold">&lt;</span>SkuInfo<span style="color:#000;font-weight:bold">&gt;</span> searchHit <span style="color:#000;font-weight:bold">:</span>skuPage<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContent</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// è·å–æœç´¢åˆ°çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            SkuInfo content <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>SkuInfo<span style="color:#000;font-weight:bold">)</span> searchHit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContent</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            SkuInfo skuInfo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SkuInfo<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            BeanUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">copyProperties</span><span style="color:#000;font-weight:bold">(</span>content<span style="color:#000;font-weight:bold">,</span> skuInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            skuList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>skuInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//6.è¿”å›ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map resultMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;rows&#34;</span><span style="color:#000;font-weight:bold">,</span> skuList<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//è·å–æ‰€éœ€SkuInfoé›†åˆæ•°æ®å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;total&#34;</span><span style="color:#000;font-weight:bold">,</span>searchHits<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">());</span><span style="color:#998;font-style:italic">//æ€»è®°å½•æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;totalPages&#34;</span><span style="color:#000;font-weight:bold">,</span> skuPage<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTotalPages</span><span style="color:#000;font-weight:bold">());</span><span style="color:#998;font-style:italic">//æ€»é¡µæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;categoryList&#34;</span><span style="color:#000;font-weight:bold">,</span>categoryList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> resultMap<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è·å–åˆ†ç±»åˆ—è¡¨æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param terms
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getStringsCategoryList</span><span style="color:#000;font-weight:bold">(</span>Terms terms<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>terms <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Bucket</span> bucket <span style="color:#000;font-weight:bold">:</span> terms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBuckets</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                String keyAsString <span style="color:#000;font-weight:bold">=</span> bucket<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKeyAsString</span><span style="color:#000;font-weight:bold">();</span><span style="color:#998;font-style:italic">// åˆ†ç»„çš„å€¼ï¼ˆåˆ†ç±»åç§°ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                categoryList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>keyAsString<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> categoryList<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220527222325/">â† å¹¿å‘Šç®¡ç†ä¸Luaã€Canalå®ç°å¹¿å‘Šç¼“å­˜</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220527233134/">æ¶ˆæ¯é˜Ÿåˆ—åŠçŸ­ä¿¡å‘é€å¹³å°  â†’</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        è±«ICPå¤‡2022002918å·
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
