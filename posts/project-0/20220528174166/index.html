<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="分布式事务 - https://lovemjh.vercel.app/posts/project-0/20220528174166/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>分布式事务</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            分布式事务
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            15807 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            32 分钟</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project/20220528234610/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528162731/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#学习目标">学习目标</a></li>
      </ul>
    </li>
    <li><a href="#一-分布式事务介绍">一 分布式事务介绍</a>
      <ul>
        <li><a href="#11-什么是事务">1.1 什么是事务</a></li>
        <li><a href="#12-本地事务">1.2 本地事务</a>
          <ul>
            <li><a href="#121-原子性和持久性都要通过undo和redo日志来实现">1.2.1 原子性和持久性都要通过undo和redo日志来实现</a>
              <ul>
                <li><a href="#1-undo日志">1. undo日志</a>
                  <ul>
                    <li><a href="#如何保证持久性">如何保证持久性？</a></li>
                    <li><a href="#如何保证原子性">如何保证原子性?</a></li>
                  </ul>
                </li>
                <li><a href="#2-redo日志">2. redo日志</a>
                  <ul>
                    <li><a href="#安全和性能问题">安全和性能问题</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#13-什么是分布式事务">1.3 什么是分布式事务</a></li>
        <li><a href="#14-分布式事务应用架构">1.4 分布式事务应用架构</a>
          <ul>
            <li><a href="#141-单一服务分布式事务">1.4.1 单一服务分布式事务</a></li>
            <li><a href="#142-多服务分布式事务">1.4.2 多服务分布式事务</a></li>
            <li><a href="#143-多服务多数据源分布式事务">1.4.3 多服务多数据源分布式事务</a></li>
          </ul>
        </li>
        <li><a href="#15-cap定理">1.5 CAP定理</a>
          <ul>
            <li><a href="#1-eureka-ap">1 eureka AP</a></li>
            <li><a href="#2-zookeeper-cp">2 zookeeper CP</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#二-分布式事务解决方案">二 分布式事务解决方案</a>
      <ul>
        <li><a href="#21--基于xa协议的两阶段提交2pc">2.1  基于XA协议的两阶段提交(2PC)</a></li>
        <li><a href="#22-补偿事务tcc3pc">2.2 补偿事务（TCC）3PC</a></li>
        <li><a href="#23-本地消息表异步确保">2.3 本地消息表（异步确保）</a></li>
        <li><a href="#24-mq-事务消息了解">2.4 MQ 事务消息（了解）</a></li>
        <li><a href="#25-seata---2pc-改进">2.5 Seata   2PC-&gt;改进</a>
          <ul>
            <li><a href="#251-seata介绍">2.5.1 Seata介绍</a></li>
            <li><a href="#252-at模式">2.5.2 AT模式</a></li>
            <li><a href="#253-tcc模式">2.5.3 TCC模式</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#三-seata案例">三 Seata案例</a>
      <ul>
        <li><a href="#31-需求分析">3.1 需求分析</a></li>
        <li><a href="#32-案例实现">3.2 案例实现</a>
          <ul>
            <li><a href="#321-父工程">3.2.1 父工程</a>
              <ul>
                <li><a href="#322-公共工程">3.2.2 公共工程</a></li>
                <li><a href="#323-商品微服务">3.2.3 商品微服务</a></li>
                <li><a href="#324-用户微服务">3.2.4 用户微服务</a></li>
                <li><a href="#325-订单微服务">3.2.5 订单微服务</a></li>
                <li><a href="#326-业务微服务">3.2.6 业务微服务</a></li>
              </ul>
            </li>
            <li><a href="#33-分布式事务抽取">3.3 分布式事务抽取</a>
              <ul>
                <li><a href="#331-分布式事务工程抽取搭建">3.3.1 分布式事务工程抽取搭建</a></li>
                <li><a href="#332-配置讲解">3.3.2 配置讲解</a></li>
                <li><a href="#333-测试分布式事务">3.3.3 测试分布式事务</a></li>
                <li><a href="#334-测试分布式事务回滚">3.3.4 测试分布式事务回滚</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#4-分布式事务实战学员完成">4 分布式事务实战(学员完成)</a>
          <ul>
            <li><a href="#41-undolog表结构导入">4.1 undolog表结构导入</a></li>
            <li><a href="#42-fescar工程搭建">4.2 Fescar工程搭建</a>
              <ul>
                <li>
                  <ul>
                    <li><a href="#421-pomxml依赖">4.2.1 pom.xml依赖</a></li>
                    <li><a href="#422-引入配置">4.2.2 引入配置</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#43-tm和proxydatasource">4.3 TM和ProxyDataSource</a>
              <ul>
                <li><a href="#431-tm和proxydatasource实现">4.3.1 TM和ProxyDataSource实现</a></li>
              </ul>
            </li>
            <li><a href="#44-分布式事务测试">4.4 分布式事务测试</a>
              <ul>
                <li><a href="#441-微服务添加依赖">4.4.1 微服务添加依赖</a></li>
                <li><a href="#442-测试">4.4.2 测试</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">第十七章</h1>
<h1 align = "center">分布式事务</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>
<p>理解什么是事务</p>
</li>
<li>
<p>理解什么是分布式事务</p>
</li>
<li>
<p>理解CAP定理</p>
</li>
<li>
<p>理解相关的分布式事务解决方案</p>
</li>
<li>
<p>理解Seata工作流程</p>
</li>
<li>
<p>能实现Seata案例</p>
</li>
</ul>
<p>作业：实现项目中分布式事务控制-下单-&gt;用户微服务（增加积分）-&gt;Goods微服务(库存递减)</p>
<h1 id="一-分布式事务介绍">一 分布式事务介绍</h1>
<h2 id="11-什么是事务">1.1 什么是事务</h2>
<p>数据库事务(简称：事务，Transaction)是指数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成[由当前业务逻辑多个不同操作构成]。</p>
<p>事务拥有以下四个特性，习惯上被称为ACID特性：</p>
<p><strong>1. 原子性(Atomicity)</strong>：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</p>
<p><strong>2. 一致性(Consistency)</strong>：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态是指数据库中的数据应满足完整性约束。除此之外，一致性还有另外一层语义，就是事务的中间状态不能被观察到(这层语义也有说应该属于原子性)。</p>
<p><strong>3. 隔离性(Isolation)</strong>：多个事务并发执行时，一个事务的执行不应影响其他事务的执行，如同只有这一个操作在被数据库所执行一样。</p>
<p>​	全局修改，修改mysql.ini配置文件，在最后加上</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1 可选参数有：READ-UNCOMMITTED, READ-COMMITTED, REPEATABLE-READ, SERIALIZABLE.
2 [mysqld]
3 transaction-isolation = REPEATABLE-READ	
</code></pre><p>这里全局默认是REPEATABLE-READ,其实MySQL本来默认也是这个级别。</p>
<p>​	<strong>Read Uncommitted  (读取未提交内容)</strong></p>
<p>​	等级是最低等级，也可以认为，事务之间完全不隔离</p>
<p>​	eg. 事务A开始一个事务，接着事务B开始，事务B对数据C继续update，这时候，A读取了B未提交（commit）的数据，这种情况叫做脏读（dirty read）。这个时候要是事务B遇到错误必须rollback，那么A读取的数据就完全是错的。</p>
<p>​	<strong>Read Committed   (读取提交内容)</strong></p>
<p>​	事务读取的数据，都是别的事务已经提交了的</p>
<p>​	eg. 事务A select了一条数据，接着事务B update 这条数据，然后commit，这时候A还未提交，A再回来读这条数据，发现数据居然变了</p>
<p>​	<strong>Repeatable      (可重读)</strong></p>
<p>​    保证不会在一个事务内两次select同一条数据会出现变化，即是别的事务对你select的对象进行update操作不会影响。但是，如果是insert操作，在这个隔离级别还是会受到影响。</p>
<p>​	eg. 事务A开启事务，并select一段有范围的数据，然后事务B开启事务，在先前A事务select的那段有范围的数据中insert一条数据，然后提交事务，接着事务A再select出来这段数据，发现数据多了一条，这种情况叫幻读（Phantom Read）</p>
<p>​	<strong>Serializable     (可串行化)</strong></p>
<p>​	保证事务之间不会有任何踩踏，每个事务都可以认为只有它自己在操作数据库。</p>
<p><strong>4. 持久性(Durability)</strong>：已被提交的事务对数据库的修改应该永久保存在数据库中。在事务结束时，此操作将不可逆转。</p>
<h2 id="12-本地事务">1.2 本地事务</h2>
<p>起初，事务仅限于对单一数据库资源的访问控制,架构服务化以后，事务的概念延伸到了服务中。倘若将一个单一的服务操作作为一个事务，那么整个服务操作只能涉及一个单一的数据库资源,这类基于单个服务单一数据库资源访问的事务，被称为本地事务(Local Transaction)。
<img src="/posts/project-0/20220528174166/image-20220528174221166.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="121-原子性和持久性都要通过undo和redo日志来实现">1.2.1 原子性和持久性都要通过undo和redo日志来实现</h3>
<p>在数据库系统中，既有存放数据的文件，也有存放日志的文件。日志在内存中也是有缓存Log buffer，也有磁盘文件log file。</p>
<p>MySQL中的日志文件，有这么两种与事务有关：undo日志与redo日志。</p>
<h4 id="1-undo日志">1. undo日志</h4>
<p>数据库事务具备原子性（<strong>Atomicity</strong>），如果事务执行失败，需要把数据回滚。</p>
<p>事务同时还具备持久性**(Durability)**，事务对数据所做的变更就完全保存在了数据库，不能因为故障而丢失。</p>
<p>原子性可以利用undo日志来实现。</p>
<p>Undo Log的原理很简单，为了满足事务的原子性，在操作任何数据之前，首先将数据备份到Undo Log。然后进行数据的修改。如果出现了错误或者用户执行了ROLLBACK语句，系统可以利用Undo Log中的备份将数据恢复到事务开始之前的状态。</p>
<p>数据库写入数据到磁盘之前，会把<strong>数据先缓存在内存</strong>中，事务提交时才会写入磁盘中。</p>
<p>用Undo Log实现原子性和持久化的事务的简化过程：</p>
<p>假设有A、B两个数据，值分别为1,2。</p>
<p>​	A. 事务开始.</p>
<p>​	B. 记录A=1到undo log.</p>
<p>​	C. 修改A=3. (内存)</p>
<p>​	D. 记录B=2到undo log.</p>
<p>​	E. 修改B=4. (内存)</p>
<p>​	F. 将undo log写到磁盘。</p>
<p>​	G. 将数据写到磁盘。</p>
<p>​	H. 事务提交。</p>
<h5 id="如何保证持久性">如何保证持久性？</h5>
<p>事务提交前，会把修改数据到磁盘前，也就是说只要事务提交了，数据肯定持久化了。</p>
<h5 id="如何保证原子性">如何保证原子性?</h5>
<p>- 每次对数据库修改，都会把修改前数据记录在undo log，那么需要回滚时，可以读取undo log，恢复数据。</p>
<p>- 若系统在G和H之间崩溃</p>
<p>此时事务并未提交，需要回滚。而undo log已经被持久化，可以根据undo log来恢复数据</p>
<p>- 若系统在G之前崩溃</p>
<p>此时数据并未持久化到硬盘，依然保持在事务之前的状态</p>
<p>缺陷：每个事务提交前将数据和Undo Log写入磁盘，这样会导致大量的磁盘IO，因此性能很低。</p>
<p>如果能够将数据缓存一段时间，就能减少IO提高性能。但是这样就会丧失事务的持久性。因此引入了另外一种机制来实现持久化，即<strong>Redo Log</strong>.</p>
<h4 id="2-redo日志">2. redo日志</h4>
<p>和Undo Log相反，Redo Log记录的是<strong>新数据</strong>的备份。在事务提交前，只要将Redo Log持久化即可，不需要将数据持久化，减少了IO的次数。</p>
<p>先来看下基本原理：</p>
<p>Undo + Redo事务的简化过程</p>
<p>假设有A、B两个数据，值分别为1,2</p>
<p>​	A. 事务开始.</p>
<p>​	B. 记录A=1到undo log buffer.</p>
<p>​	C. 修改A=3.</p>
<p>​	D. 记录A=3到redo log buffer.</p>
<p>​	E. 记录B=2到undo log buffer.</p>
<p>​	F. 修改B=4.</p>
<p>​	G. 记录B=4到redo log buffer.</p>
<p>​	H. 将undo log写入磁盘  (写入redo Log,既有原始数据，也有修改之后的数据)</p>
<p>​	I. 将redo log写入磁盘  (顺序写)</p>
<p>​	J. 事务提交</p>
<p>随机写：写入数据是随机写。需要 寻址，在完成写入。寻址比写入花费更多的时间。</p>
<p>顺序写：写入redo是顺序写，开辟一个连续的空间。不需要寻址。效率高。</p>
<h5 id="安全和性能问题">安全和性能问题</h5>
<p>如何保证原子性？</p>
<p>如果在事务提交前故障，通过undo log日志恢复数据。如果undo log都还没写入，那么数据就尚未持久化，无需回滚</p>
<h2 id="13-什么是分布式事务">1.3 什么是分布式事务</h2>
<p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上,且属于不同的应用，分布式事务需要保证这些操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p>
<h2 id="14-分布式事务应用架构">1.4 分布式事务应用架构</h2>
<p>本地事务主要限制在单个会话内，不涉及多个数据库资源。但是在基于SOA(Service-Oriented Architecture，面向服务架构)的分布式应用环境下，越来越多的应用要求对多个数据库资源，多个服务的访问都能纳入到同一个事务当中，分布式事务应运而生。</p>
<h3 id="141-单一服务分布式事务">1.4.1 单一服务分布式事务</h3>
<p>最早的分布式事务应用架构很简单，不涉及服务间的访问调用，仅仅是服务内操作涉及到对多个数据库资源的访问。
<img src="/posts/project-0/20220528174166/image-20220528174233574.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="142-多服务分布式事务">1.4.2 多服务分布式事务</h3>
<p>当一个服务操作访问不同的数据库资源，又希望对它们的访问具有事务特性时，就需要采用分布式事务来协调所有的事务参与者。</p>
<p>对于上面介绍的分布式事务应用架构，尽管一个服务操作会访问多个数据库资源，但是毕竟整个事务还是控制在单一服务的内部。如果一个服务操作需要调用另外一个服务，这时的事务就需要跨越多个服务了。在这种情况下，起始于某个服务的事务在调用另外一个服务的时候，需要以某种机制流转到另外一个服务，从而使被调用的服务访问的资源也自动加入到该事务当中来。下图反映了这样一个跨越多个服务的分布式事务：
<img src="/posts/project-0/20220528174166/image-20220528174238947.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="143-多服务多数据源分布式事务">1.4.3 多服务多数据源分布式事务</h3>
<p>如果将上面这两种场景(一个服务可以调用多个数据库资源，也可以调用其他服务)结合在一起，对此进行延伸，整个分布式事务的参与者将会组成如下图所示的树形拓扑结构。在一个跨服务的分布式事务中，事务的发起者和提交均系同一个，它可以是整个调用的客户端，也可以是客户端最先调用的那个服务。
<img src="/posts/project-0/20220528174166/image-20220528174246977.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>较之基于单一数据库资源访问的本地事务，分布式事务的应用架构更为复杂。在不同的分布式应用架构下，实现一个分布式事务要考虑的问题并不完全一样，比如对多资源的协调、事务的跨服务传播等，实现机制也是复杂多变。</p>
<p>事务的作用：</p>
<pre tabindex="0"><code>保证每个事务的数据一致性。
</code></pre><h2 id="15-cap定理">1.5 CAP定理</h2>
<p>CAP 定理，又被叫作布鲁尔定理。对于设计分布式系统(不仅仅是分布式事务)的架构师来说，CAP 就是你的入门理论。</p>
<p>**C (一致性)：**对某个指定的客户端来说，读操作能返回最新的写操作。</p>
<p>对于数据分布在不同节点上的数据来说，如果在某个节点更新了数据，那么在其他节点如果都能读取到这个最新的数据，那么就称为强一致，如果有某个节点没有读取到，那就是分布式不一致。</p>
<p>**A (可用性)：**非故障的节点在合理的时间内返回合理的响应(不是错误和超时的响应)。可用性的两个关键一个是合理的时间，一个是合理的响应。</p>
<p>合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回。合理的响应指的是系统应该明确返回结果并且结果是正确的，这里的正确指的是比如应该返回 50，而不是返回 40。</p>
<p>**P (分区容错性)：**当出现网络分区后，系统能够继续工作。打个比方，这里集群有多台机器，有台机器网络出现了问题，但是这个集群仍然可以正常工作。</p>
<p>熟悉 CAP 的人都知道，三者不能共有，如果感兴趣可以搜索 CAP 的证明，在分布式系统中，网络无法 100% 可靠，分区其实是一个必然现象。</p>
<p>如果我们选择了 CA 而放弃了 P，那么当发生分区现象时，为了保证一致性，这个时候必须拒绝请求，但是 A 又不允许，所以分布式系统理论上不可能选择 CA 架构，只能选择 CP 或者 AP 架构。</p>
<p>对于 CP 来说，放弃可用性，追求一致性和分区容错性，我们的 ZooKeeper 其实就是追求的强一致。</p>
<p>对于 AP 来说，放弃一致性(这里说的一致性是强一致性)，追求分区容错性和可用性 Eureka，这是很多分布式系统设计时的选择，后面的 BASE 也是根据 AP 来扩展。</p>
<p>顺便一提，CAP 理论中是忽略网络延迟，也就是当事务提交时，从节点 A 复制到节点 B 没有延迟，但是在现实中这个是明显不可能的，所以总会有一定的时间是不一致。</p>
<p>同时 CAP 中选择两个，比如你选择了 CP，并不是叫你放弃 A。因为 P 出现的概率实在是太小了，大部分的时间你仍然需要保证 CA。</p>
<p>就算分区出现了你也要为后来的 A 做准备，比如通过一些日志的手段，是其他机器回复至可用。</p>
<p>在现有的技术方案中，注册中心主要分为两类，一类是CP类注册中心，另一类是AP类注册中心。在一个分布式系统中，Consistency（一致性）、Availability（可用性）、Partition tolerance（分区容错性）无法同时满足，正所谓“鱼和熊掌与虾不可兼得也”。</p>
<p>CP类注册中心更强调一致性，而AP类注册中心更强调可用性。</p>
<h3 id="1-eureka-ap">1 eureka AP</h3>
<p>eureka 保证了可用性，实现最终一致性。</p>
<p>Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而Eureka的客户端在向某个Eureka注册或时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用(保证可用性)，只不过查到的信息可能不是最新的(不保证强一致性)，其中说明了，eureka是不满足强一致性，但还是会保证最终一致性。</p>
<h3 id="2-zookeeper-cp">2 zookeeper CP</h3>
<p>zookeeper在选举leader时，会停止服务，直到选举成功之后才会再次对外提供服务，这个时候就说明了服务不可用，但是在选举成功之后，因为一主多从的结构，zookeeper在这时还是一个高可用注册中心，只是在优先保证一致性的前提下，zookeeper才会顾及到可用性。</p>
<h1 id="二-分布式事务解决方案">二 分布式事务解决方案</h1>
<p>1.XA两段提交(低效率)-21 XA JTA分布式事务解决方案</p>
<p>2.TCC三段提交(2段,高效率[不推荐(补偿代码)])</p>
<p>3.本地消息(MQ+Table)</p>
<p>4.事务消息(RocketMQ[alibaba])</p>
<p>5.Seata(alibaba)</p>
<h2 id="21--基于xa协议的两阶段提交2pc">2.1  基于XA协议的两阶段提交(2PC)</h2>
<p>两阶段提交协议(Two Phase Commitment Protocol)中，涉及到两种角色</p>
<p>==一个事务协调者==（coordinator）：负责协调多个参与者进行事务投票及提交(回滚)
多个==事务参与者==（participants）：即本地事务执行者</p>
<p>总共处理步骤有两个
（1）投票阶段（voting phase）：协调者将通知事务参与者准备提交或取消事务，然后进入表决过程。参与者将告知协调者自己的决策：同意（事务参与者本地事务执行成功，但未提交）或取消（本地事务执行故障）；
（2）提交阶段（commit phase）：收到参与者的通知后，协调者再向参与者发出通知，根据反馈情况决定各参与者是否要提交还是回滚；</p>
<p>如果所示 1-2为第一阶段，2-3为第二阶段
<img src="/posts/project-0/20220528174166/image-20220528174256733.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528174166/image-20220528174301831.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如果任一资源管理器在第一阶段返回准备失败，那么事务管理器会要求所有资源管理器在第二阶段执行回滚操作。通过事务管理器的两阶段协调，最终所有资源管理器要么全部提交，要么全部回滚，最终状态都是一致的</p>
<p><strong>优点：</strong> 尽量保证了数据的强一致，适合对数据强一致要求很高的关键领域。</p>
<p><strong>缺点：</strong> 牺牲了可用性，对性能影响较大，不适合高并发高性能场景，如果分布式系统跨接口调用，目前 .NET 界还没有实现方案。</p>
<pre><code>		 1. 单点故障问题：如果事务管理器挂了，就会失败。
		 2. 阻塞问题：在准备阶段和提交阶段，每个事务参与者都会锁定本地资源，并等待其他事务的执行结果，阻塞时间较长，资源锁定时间太久，执行效率比较低。
</code></pre>
<h2 id="22-补偿事务tcc3pc">2.2 补偿事务（TCC）3PC</h2>
<p>TCC 将事务提交分为 Try(method1) - Confirm(method2) - Cancel(method3) 3个操作。其和两阶段提交有点类似，Try为第一阶段，Confirm - Cancel为第二阶段，是一种应用层面侵入业务的两阶段提交。</p>
<table>
<thead>
<tr>
<th>操作方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Try</td>
<td>预留业务资源/数据效验</td>
</tr>
<tr>
<td>Confirm</td>
<td>确认执行业务操作，实际提交数据，不做任何业务检查，try成功，confirm必定成功，需保证幂等</td>
</tr>
<tr>
<td>Cancel</td>
<td>取消执行业务操作，实际回滚数据，需保证幂等</td>
</tr>
</tbody>
</table>
<p>其核心在于将业务分为两个操作步骤完成。不依赖 RM 对分布式事务的支持，而是通过对业务逻辑的分解来实现分布式事务。</p>
<p><img src="/posts/project-0/20220528174166/image-20220528174310842.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>例如： A要向 B 转账，思路大概是：</p>
<pre tabindex="0"><code>我们有一个本地方法，里面依次调用 
1、首先在 Try 阶段，要先调用远程接口把 B和 A的钱给冻结起来。 
2、在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。 
3、如果第2步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。 
</code></pre><pre tabindex="0"><code class="language-properties" data-lang="properties">假设用户user表中有两个字段：可用余额(available_money)、冻结余额(frozen_money)
A扣钱对应服务A(ServiceA)
B加钱对应服务B(ServiceB)
转账订单服务(OrderService)
业务转账方法服务(BusinessService)
</code></pre><p>ServiceA，ServiceB，OrderService都需分别实现try()，confirm()，cancle()方法，方法对应业务逻辑如下</p>
<table>
<thead>
<tr>
<th>操作方法</th>
<th><strong>ServiceA</strong></th>
<th><strong>ServiceB</strong></th>
<th><strong>OrderService</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>try()</td>
<td>校验余额(并发控制)<br/>冻结余额+1000<br/>余额-1000</td>
<td>冻结余额+1000</td>
<td>创建转账订单，状态待转账</td>
</tr>
<tr>
<td>confirm()</td>
<td>冻结余额-1000</td>
<td></td>
<td>状态变为转账成功</td>
</tr>
<tr>
<td>cancle()</td>
<td>冻结余额-1000<br/>余额+1000</td>
<td></td>
<td>状态变为转账失败</td>
</tr>
</tbody>
</table>
<p>其中业务调用方BusinessService中就需要调用
ServiceA.try()
ServiceB.try()
OrderService.try()</p>
<p>1、当所有try()方法均执行成功时，对全局事物进行提交，即由事物管理器调用每个微服务的confirm()方法</p>
<p>2、 当任意一个方法try()失败(预留资源不足，抑或网络异常，代码异常等任何异常)，由事物管理器调用每个微服务的cancle()方法对全局事务进行回滚</p>
<p><strong>优点：</strong> 每个极端都会提交本地事务并释放锁，并不需要等待其他事务的执行结果。而如果其他事务执行失败，最后不是回滚，而是执行补偿操作。这样就避免了资源的长期锁定和阻塞等待，执行效率比较高，属于性能比较好的分布式事务方式。</p>
<p><strong>缺点：</strong></p>
<ol>
<li>代码侵入： 需要人为编写代码实现 try, confirm, cancel, 代码侵入较多</li>
<li>开发成本高，一个业务需要拆分为3个阶段，分别编写业务实现，业务编写比较复杂</li>
<li>安全性考虑： cancel动作如果执行失败，资源就无法释放，需要引入重试机制，而重试可能导致重复执行，还要考虑重试的幂等问题。</li>
</ol>
<h2 id="23-本地消息表异步确保">2.3 本地消息表（异步确保）</h2>
<p>本地消息表这种实现方式应该是业界使用最多的，其核心思想是将分布式事务拆分成本地事务进行处理，这种思路是来源于ebay。我们可以从下面的流程图中看出其中的一些细节：
<img src="/posts/project-0/20220528174166/image-20220528174326321.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>基本思路就是：</p>
<p>消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。</p>
<p>消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。</p>
<p>生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p>
<p>这种方案遵循BASE理论，采用的是最终一致性，笔者认为是这几种方案里面比较适合实际业务场景的，即不会出现像2PC那样复杂的实现(当调用链很长的时候，2PC的可用性是非常低的)，也不会像TCC那样可能出现确认或者回滚不了的情况。</p>
<p><strong>优点：</strong> 一种非常经典的实现，避免了分布式事务，实现了最终一致性。在 .NET中 有现成的解决方案。</p>
<p><strong>缺点：</strong> 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p>
<h2 id="24-mq-事务消息了解">2.4 MQ 事务消息（了解）</h2>
<p>有一些第三方的MQ是支持事务消息的，比如RocketMQ，他们支持事务消息的方式也是类似于采用的二阶段提交，但是市面上一些主流的MQ都是不支持事务消息的，比如 RabbitMQ 和 Kafka 都不支持。</p>
<p>以阿里的 RocketMQ 中间件为例，其思路大致为：</p>
<p>第一阶段Prepared消息，会拿到消息的地址。
第二阶段执行本地事务，第三阶段通过第一阶段拿到的地址去访问消息，并修改状态。</p>
<p>也就是说在业务方法内要想消息队列提交两次请求，一次发送消息和一次确认消息。如果确认消息发送失败了RocketMQ会定期扫描消息集群中的事务消息，这时候发现了Prepared消息，它会向消息发送者确认，所以生产方需要实现一个check接口，RocketMQ会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。
<img src="/posts/project-0/20220528174166/image-20220528174334017.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>优点：</strong> 实现了最终一致性，不需要依赖本地数据库事务。</p>
<p><strong>缺点：</strong> 目前主流MQ中只有RocketMQ支持事务消息。</p>
<h2 id="25-seata---2pc-改进">2.5 Seata   2PC-&gt;改进</h2>
<p>2019 年 1 月，阿里巴巴中间件团队发起了开源项目 <a class="link" href="/posts/project-0/https://www.oschina.net/p/fescar"  target="_blank" rel="noopener"
    ><em>Fescar</em></a><em>（Fast &amp; EaSy Commit And Rollback）</em>，和社区一起共建开源分布式事务解决方案。Fescar 的愿景是让分布式事务的使用像本地事务的使用一样，简单和高效，并逐步解决开发者们遇到的分布式事务方面的所有难题。</p>
<p><strong>Fescar 开源后，蚂蚁金服加入 Fescar 社区参与共建，并在 Fescar 0.4.0 版本中贡献了 TCC 模式。</strong></p>
<p>为了打造更中立、更开放、生态更加丰富的分布式事务开源社区，经过社区核心成员的投票，大家决定对 Fescar 进行品牌升级，并更名为 <strong>Seata</strong>，意为：<strong>Simple Extensible Autonomous Transaction Architecture</strong>，是一套一站式分布式事务解决方案。</p>
<p>Seata 融合了阿里巴巴和蚂蚁金服在分布式事务技术上的积累，并沉淀了新零售、云计算和新金融等场景下丰富的实践经验。</p>
<h3 id="251-seata介绍">2.5.1 Seata介绍</h3>
<p>解决分布式事务问题，有两个设计初衷</p>
<p><strong>对业务无侵入</strong>：即减少技术架构上的微服务化所带来的分布式事务问题对业务的侵入
<strong>高性能</strong>：减少分布式事务解决方案所带来的性能消耗</p>
<p>seata中有两种分布式事务实现方案，AT及TCC</p>
<ul>
<li>
<p>AT模式主要关注多 DB 访问的数据一致性，当然也包括多服务下的多 DB 数据访问一致性问题</p>
</li>
<li>
<p>TCC 模式主要关注业务拆分，在按照业务横向扩展资源时，解决微服务间调用的一致性问题</p>
</li>
</ul>
<h3 id="252-at模式">2.5.2 AT模式</h3>
<p>Seata AT模式是基于XA事务演进而来的一个分布式事务中间件，XA是一个基于数据库实现的分布式事务协议，本质上和两阶段提交一样，需要数据库支持，Mysql5.6以上版本支持XA协议，其他数据库如Oracle，DB2也实现了XA接口
<img src="/posts/project-0/20220528174166/image-20220528174341229.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>解释：</p>
<p><strong>Transaction Coordinator (TC)</strong>： 事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。
<strong>Transaction Manager（TM）</strong>： 控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。
<strong>Resource Manager (RM)</strong>： 控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。</p>
<p>协调执行流程如下：
<img src="/posts/project-0/20220528174166/image-20220528174346372.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>Branch就是指的分布式事务中每个独立的本地局部事务。</p>
<p><strong>第一阶段</strong></p>
<p>Seata 的 JDBC 数据源代理通过对业务 SQL 的解析，把业务数据在更新前后的数据镜像组织成回滚日志，利用 本地事务 的 ACID 特性，将业务数据的更新和回滚日志的写入在同一个 本地事务 中提交。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>undo_log<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span>AUTO_INCREMENT,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>branch_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>xid<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>rollback_info<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>longblob<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_status<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_created<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_modified<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>ext<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>idx_unionkey<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>xid<span style="color:#000;font-weight:bold">`</span>,<span style="color:#000;font-weight:bold">`</span>branch_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span>AUTO_INCREMENT<span style="color:#000;font-weight:bold">=</span><span style="color:#099">200</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><p>这样，可以保证：<strong>任何提交的业务数据的更新一定有相应的回滚日志存在</strong>
<img src="/posts/project-0/20220528174166/image-20220528174352568.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>基于这样的机制，分支的本地事务便可以在全局事务的第一阶段提交，并马上释放本地事务锁定的资源</p>
<p>这也是Seata和XA事务的不同之处，两阶段提交往往对资源的锁定需要持续到第二阶段实际的提交或者回滚操作，而有了回滚日志之后，可以在第一阶段释放对资源的锁定，降低了锁范围，提高效率，即使第二阶段发生异常需要回滚，只需找对undolog中对应数据并反解析成sql来达到回滚目的</p>
<p>同时Seata通过代理数据源将业务sql的执行解析成undolog来与业务数据的更新同时入库，达到了对业务无侵入的效果。</p>
<p><strong>第二阶段</strong></p>
<p>如果决议是全局提交，此时分支事务此时已经完成提交，不需要同步协调处理（只需要异步清理回滚日志），Phase2 可以非常快速地完成.
<img src="/posts/project-0/20220528174166/image-20220528174358044.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528174166/image-20220528174402282.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如果决议是全局回滚，RM 收到协调器发来的回滚请求，通过 XID 和 Branch ID 找到相应的回滚日志记录，<strong>通过回滚记录生成反向的更新 SQL 并执行</strong>，以完成分支的回滚
<img src="/posts/project-0/20220528174166/image-20220528174408769.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="253-tcc模式">2.5.3 TCC模式</h3>
<p>seata也针对TCC做了适配兼容，支持TCC事务方案，原理前面已经介绍过，基本思路就是使用侵入业务上的补偿及事务管理器的协调来达到全局事务的一起提交及回滚。
<img src="/posts/project-0/20220528174166/image-20220528174413131.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="三-seata案例">三 Seata案例</h1>
<h2 id="31-需求分析">3.1 需求分析</h2>
<p><img src="/posts/project-0/20220528174166/image-20220528174417912.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>完成一个案例，用户下单的时候记录下单日志，完成订单添加，完成用户账户扣款，完成商品库存削减功能，稍后在任何一个微服务中制造异常，测试分布式事务。</p>
<p>先将<code>seata\案例SQL脚本</code>数据库脚本导入到数据库中。
<img src="/posts/project-0/20220528174166/image-20220528174422755.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="32-案例实现">3.2 案例实现</h2>
<h3 id="321-父工程">3.2.1 父工程</h3>
<p>搭建fescar-parent,为了适应东易买工程的分布式事务，我们这里的父工程引入和东易买工程一样的依赖包。</p>
<p>pom.xml依赖如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>2.2.7.RELEASE<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;packaging&gt;</span>pom<span style="color:#000080">&lt;/packaging&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">&lt;!--跳过测试--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;skipTests&gt;</span>true<span style="color:#000080">&lt;/skipTests&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">&lt;!--依赖包--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--测试包--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--fastjson--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fastjson<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.2.51<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--web起步依赖--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;version&gt;</span>Hoxton.RELEASE<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;type&gt;</span>pom<span style="color:#000080">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;scope&gt;</span>import<span style="color:#000080">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><h4 id="322-公共工程">3.2.2 公共工程</h4>
<p>将所有数据库对应的Pojo/Feign抽取出一个公共工程<code>fescar-api</code>,在该工程中导入依赖:</p>
<p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;description&gt;</span>
</span></span><span style="display:flex;"><span>        API:Model和Feign
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--openfeign--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!-- MyBatisPlus --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.baomidou<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>3.4.2<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--MySQL数据库驱动--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>mysql<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>5.1.45<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>将Pojo导入到工程中
<img src="/posts/project-0/20220528174166/image-20220528174432489.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="323-商品微服务">3.2.3 商品微服务</h4>
<p>创建<code>fescar-item</code>微服务，在该工程中实现库存削减。</p>
<p>(1)pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-item<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)Dao</p>
<p>创建<code>com.offcn.dao.ItemInfoMapper</code>,代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">ItemInfoMapper</span> <span style="color:#000;font-weight:bold">extends</span> BaseMapper<span style="color:#000;font-weight:bold">&lt;</span>ItemInfo<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)Service</p>
<p>创建<code>com.offcn.service.ItemInfoService</code>接口，并创建库存递减方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">ItemInfoService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 库存递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">decrCount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建<code>com.offcn.service.impl.ItemInfoServiceImpl</code>实现库存递减操作，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Transactional</span><span style="color:#000;font-weight:bold">(</span>rollbackFor <span style="color:#000;font-weight:bold">=</span> Exception<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ItemInfoServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> ItemInfoService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ItemInfoMapper itemInfoMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 库存递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">decrCount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//查询商品信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        ItemInfo itemInfo <span style="color:#000;font-weight:bold">=</span> itemInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectById</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        itemInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCount</span><span style="color:#000;font-weight:bold">(</span>itemInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCount</span><span style="color:#000;font-weight:bold">()-</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> dcount <span style="color:#000;font-weight:bold">=</span> itemInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateById</span><span style="color:#000;font-weight:bold">(</span>itemInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;库存递减受影响行数：&#34;</span><span style="color:#000;font-weight:bold">+</span>dcount<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)Controller</p>
<p>创建<code>com.offcn.controller.ItemInfoController</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/itemInfo&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ItemInfoController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ItemInfoService itemInfoService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 库存递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/decrCount&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">decrCount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;id&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;count&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//库存递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        itemInfoService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decrCount</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;success&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)启动类</p>
<p>创建<code>com.offcn.ItemApplication</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ItemApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>ItemApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(6)application.yml</p>
<p>创建applicatin.yml,配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 9001
spring:
  application:
    name: item
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/fescar-item?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC
    username: root
    password: 123456
  main:
    allow-bean-definition-overriding: true
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:8761/eureka
  instance:
    prefer-ip-address: true
feign:
  hystrix:
    enabled: true
#hystrix 配置
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000
          strategy: SEMAPHORE
</code></pre><h4 id="324-用户微服务">3.2.4 用户微服务</h4>
<p>创建<code>fescar-user</code>微服务，并引入公共工程依赖。</p>
<p>(1)pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-user<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)Dao</p>
<p>创建<code>com.offcn.dao.UserInfoMapper</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">UserInfoMapper</span> <span style="color:#000;font-weight:bold">extends</span> BaseMapper<span style="color:#000;font-weight:bold">&lt;</span>UserInfo<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)Service</p>
<p>创建<code>com.offcn.service.UserInfoService</code>接口，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">UserInfoService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 账户金额递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param money
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">decrMoney</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> money<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建<code>com.offcn.service.impl.UserInfoServiceImpl</code>实现用户账户扣款，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Transactional</span><span style="color:#000;font-weight:bold">(</span>rollbackFor <span style="color:#000;font-weight:bold">=</span> Exception<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserInfoServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserInfoService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserInfoMapper userInfoMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 账户金额递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param money
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">decrMoney</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> money<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        UserInfo userInfo <span style="color:#000;font-weight:bold">=</span> userInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectById</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMoney</span><span style="color:#000;font-weight:bold">()-</span>money<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> count <span style="color:#000;font-weight:bold">=</span> userInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateById</span><span style="color:#000;font-weight:bold">(</span>userInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;添加用户受影响行数：&#34;</span><span style="color:#000;font-weight:bold">+</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//int q=10/0;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)Controller</p>
<p>创建<code>com.offcn.controller.UserInfoController</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/userInfo&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserInfoController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserInfoService userInfoService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 账户余额递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param money
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/add&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">decrMoney</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">)</span> String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;money&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#458;font-weight:bold">int</span> money<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        userInfoService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decrMoney</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>money<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;success&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)启动类</p>
<p>创建<code>com.offcn.UserApplication</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>UserApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(6)application.yml</p>
<p>创建application.yml配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 9002
spring:
  application:
    name: user
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/fescar-item?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC
    username: root
    password: 123456
  main:
    allow-bean-definition-overriding: true
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:8761/eureka
  instance:
    prefer-ip-address: true
feign:
  hystrix:
    enabled: true
#hystrix 配置
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000
          strategy: SEMAPHORE
</code></pre><h4 id="325-订单微服务">3.2.5 订单微服务</h4>
<p>在订单微服务中实现调用商品微服务递减库存。</p>
<p>(1)pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-order<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)Dao</p>
<p>创建<code>com.offcn.dao.OrderInfoMapper</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">OrderInfoMapper</span> <span style="color:#000;font-weight:bold">extends</span> BaseMapper<span style="color:#000;font-weight:bold">&lt;</span>OrderInfo<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)Service</p>
<p>创建<code>com.offcn.service.OrderInfoService</code>实现添加订单操作，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">OrderInfoService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 添加订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">add</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建<code>com.offcn.service.impl.OrderInfoServiceImpl</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderInfoServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> OrderInfoService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderInfoMapper orderInfoMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ItemInfoFeign itemInfoFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 添加订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">add</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//添加订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        OrderInfo orderInfo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> OrderInfo<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        orderInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;生成订单&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        orderInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>10<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> icount <span style="color:#000;font-weight:bold">=</span> orderInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">insert</span><span style="color:#000;font-weight:bold">(</span>orderInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;添加订单受影响函数：&#34;</span><span style="color:#000;font-weight:bold">+</span>icount<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//递减库存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        itemInfoFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decrCount</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)Controller</p>
<p>创建<code>com.offcn.controller.OrderInfoController</code>调用下单操作，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/orderInfo&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderInfoController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderInfoService orderInfoService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 增加订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/add&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">)</span> String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;id&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#3c5d5d;font-weight:bold">@RequestParam</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;count&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//添加订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        orderInfoService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>id<span style="color:#000;font-weight:bold">,</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;success&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)启动类</p>
<p>创建<code>com.offcn.OrderApplication</code>启动类，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OrderApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)application.yml配置</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 9003
spring:
  application:
    name: order
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/fescar-item?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC
    username: root
    password: 123456
  main:
    allow-bean-definition-overriding: true
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:8761/eureka
  instance:
    prefer-ip-address: true
feign:
  hystrix:
    enabled: true
#hystrix 配置
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000
          strategy: SEMAPHORE
</code></pre><h4 id="326-业务微服务">3.2.6 业务微服务</h4>
<p>创建<code>fescar-business</code>业务微服务，在该微服务中实现分布式事务控制，下单入口从这里开始。</p>
<p>（1）pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;description&gt;</span>分布式事务业务控制<span style="color:#000080">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-business<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)Dao</p>
<p>创建<code>com.offcn.dao.LogInfoMapper</code>代码如下：</p>
<pre tabindex="0"><code>public interface LogInfoMapper extends BaseMapper&lt;LogInfo&gt; {
}
</code></pre><p>(3)Service</p>
<p>创建<code>com.offcn.service.BusinessService</code>接口，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">BusinessService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 下单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">add</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建<code>com.offcn.service.impl.BusinessServiceImpl</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">BusinessServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> BusinessService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderInfoFeign orderInfoFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserInfoFeign userInfoFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> LogInfoMapper logInfoMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 下单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param count
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">add</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//添加订单日志
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        LogInfo logInfo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> LogInfo<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        logInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setContent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;添加订单数据---&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        logInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCreatetime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Date<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> logcount <span style="color:#000;font-weight:bold">=</span> logInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">insert</span><span style="color:#000;font-weight:bold">(</span>logInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;添加日志受影响行数：&#34;</span><span style="color:#000;font-weight:bold">+</span>logcount<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//添加订单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        orderInfoFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>id<span style="color:#000;font-weight:bold">,</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//用户账户余额递减
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        userInfoFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decrMoney</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>10<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)Controller</p>
<p>创建<code>com.offcn.controller.BusinessController</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/business&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">BusinessController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> BusinessService businessService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 购买商品分布式事务测试
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/addorder&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">order</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        String username<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;zhangsan&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> id<span style="color:#000;font-weight:bold">=</span>1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> count<span style="color:#000;font-weight:bold">=</span>5<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//下单
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        businessService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>id<span style="color:#000;font-weight:bold">,</span>count<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;success&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)启动类</p>
<p>创建启动类<code>com.offcn.BusinessApplication</code>，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">BusinessApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>BusinessApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(6)application.yml配置</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 9004
spring:
  application:
    name: business
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/fescar-item?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC
    username: root
    password: 123456
  main:
    allow-bean-definition-overriding: true
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:8761/eureka
  instance:
    prefer-ip-address: true
feign:
  hystrix:
    enabled: true

#读取超时设置
ribbon:
  ReadTimeout: 30000
#hystrix 配置
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000
          strategy: SEMAPHORE
</code></pre><p>测试调用:</p>
<p>http://localhost:9004/business/addorder</p>
<p>查看各个微服务，控制台输出。</p>
<h3 id="33-分布式事务抽取">3.3 分布式事务抽取</h3>
<p>上面案例，并没有实现分布式事务，在我们以后工作中，也并非每个服务都需要实现分布式事务，我们可以将分布式事务抽取出来。</p>
<h4 id="331-分布式事务工程抽取搭建">3.3.1 分布式事务工程抽取搭建</h4>
<p>创建<code>fescar-transaction</code>微服务工程，在该工程中实现分布式事务控制。</p>
<p>(1)pom.xml依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>fescar-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;description&gt;</span>fescar分布式事务微服务<span style="color:#000080">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-transaction<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;fescar.version&gt;</span>0.4.2<span style="color:#000080">&lt;/fescar.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">&lt;!--fescar依赖包--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba.fescar<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-tm<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>${fescar.version}<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba.fescar<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-spring<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>${fescar.version}<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)资源文件导入</p>
<p>将<code>seata\资源包</code>中的文件导入到该工程中。
<img src="/posts/project-0/20220528174166/image-20220528174504162.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>相关概念讲解</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">XID：全局事务的唯一标识，由 ip:port:sequence 组成；
Transaction Coordinator (TC)：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚；
Transaction Manager (TM )：控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议；
Resource Manager (RM)：控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚；
</code></pre><p>Fescar 使用 XID 表示一个分布式事务，XID 需要在一次分布式事务请求所涉的系统中进行传递，从而向 feacar-server 发送分支事务的处理情况，以及接收 feacar-server 的 commit、rollback 指令。
<img src="/posts/project-0/20220528174166/image-20220528174509308.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="332-配置讲解">3.3.2 配置讲解</h4>
<p>fescar 的配置入口文件是 registry.conf, 查看代码 ConfigurationFactory 得知目前还不能指定该配置文件，所以配置文件名称只能为 registry.conf。</p>
<p>在 <code>registry</code> 中可以指定具体配置的形式，默认使用 file 类型，在 file.conf 中有 3 部分配置内容：</p>
<p>transport transport :用于定义 Netty 相关的参数，TM、RM 与 fescar-server 之间使用 Netty 进行通信。</p>
<p>service:</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">service {
  #vgroup-&gt;rgroup
  vgroup_mapping.my_test_tx_group = &#34;default&#34;
  #only support single node 配置Client连接TC的地址
  default.grouplist = &#34;127.0.0.1:8091&#34;
  #degrade current not support
  enableDegrade = false
  #disable
  disable = false
  #是否启用Seata分布式事务
  disableGlobalTransaction = false
}
</code></pre><p>client:</p>
<pre tabindex="0"><code>client {
  #RM接收TC的commit通知缓冲上限
  async.commit.buffer.limit = 10000
  lock {
    retry.internal = 10
    retry.times = 30
  }
</code></pre><p>fescar 在 AT 模式下需要创建数据库代理.在<code>com.offcn.fescar.FescarAutoConfiguration</code>中代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 创建代理数据库
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 会将und_log绑定到本地事务中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param environment
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> DataSource <span style="color:#900;font-weight:bold">dataSource</span><span style="color:#000;font-weight:bold">(</span>Environment environment<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//创建数据源对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    DruidDataSource dataSource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DruidDataSource<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取数据源链接地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUrl</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.url&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//设置数据库驱动
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDriver</span><span style="color:#000;font-weight:bold">(</span>DriverManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDriver</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.url&#34;</span><span style="color:#000;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;无法识别驱动类型&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取数据库名字
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUsername</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.username&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取数据库密码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPassword</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.password&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//将数据库封装成一个代理数据库
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DataSourceProxy<span style="color:#000;font-weight:bold">(</span>dataSource<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 全局事务扫描器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * 用来解析带有@GlobalTransactional注解的方法，然后采用AOP的机制控制事务
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @param environment
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> GlobalTransactionScanner <span style="color:#900;font-weight:bold">globalTransactionScanner</span><span style="color:#000;font-weight:bold">(</span>Environment environment<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//事务分组名称
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String applicationName <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.application.name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    String groupName <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;fescar.group.name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>applicationName <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> GlobalTransactionScanner<span style="color:#000;font-weight:bold">(</span>groupName <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;my_test_tx_group&#34;</span> <span style="color:#000;font-weight:bold">:</span> groupName<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> GlobalTransactionScanner<span style="color:#000;font-weight:bold">(</span>applicationName<span style="color:#000;font-weight:bold">,</span> groupName <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;my_test_tx_group&#34;</span> <span style="color:#000;font-weight:bold">:</span> groupName<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>使用 <code>DataSourceProxy</code> 的目的是为了引入 <code>ConnectionProxy</code> ，fescar 无侵入的一方面就体现在 <code>ConnectionProxy</code> 的实现上，即分支事务加入全局事务的切入点是在本地事务的 <code>commit</code> 阶段，这样设计可以保证业务数据与 <code>undo_log</code> 是在一个本地事务中。</p>
<p><code>undo_log</code> 是需要在业务库上创建的一个表，fescar 依赖该表记录每笔分支事务的状态及二阶段 <code>rollback</code> 的回放数据。不用担心该表的数据量过大形成单点问题，在全局事务 <code>commit</code> 的场景下事务对应的 <code>undo_log</code> 会异步删除。</p>
<p>所以在每个微服务对应的数据库中需要创建一张undo_log表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>undo_log<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span>AUTO_INCREMENT,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>branch_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>xid<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>rollback_info<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>longblob<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_status<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_created<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_modified<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>ext<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>idx_unionkey<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>xid<span style="color:#000;font-weight:bold">`</span>,<span style="color:#000;font-weight:bold">`</span>branch_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span>AUTO_INCREMENT<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><h4 id="333-测试分布式事务">3.3.3 测试分布式事务</h4>
<p>(1)添加依赖</p>
<p>将上面所有工程都添加<code>fescar-transaction</code>的依赖。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--分布式事务模块--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>fescar-transaction<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)启动</p>
<p>解压<code>seata\fescar-server-0.4.2.zip</code>文件包，并点击<code>bin\fescar-server.bat</code>启动Seata的事务协调器。
<img src="/posts/project-0/20220528174166/image-20220528174520205.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(3)重新启动</p>
<p>在业务微服务上添加<code>@GlobalTransactional(name = &quot;add&quot;)</code>注解，并重新启动其他微服务，测试测试数据正确。
<img src="/posts/project-0/20220528174166/image-20220528174525698.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="334-测试分布式事务回滚">3.3.4 测试分布式事务回滚</h4>
<p>修改fescar-user模块的UserInfoServiceImpl，模拟异常</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Transactional</span><span style="color:#000;font-weight:bold">(</span>rollbackFor <span style="color:#000;font-weight:bold">=</span> Exception<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserInfoServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserInfoService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserInfoMapper userInfoMapper<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">decrMoney</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> money<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">//根据用户名获取用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        UserInfo userInfo <span style="color:#000;font-weight:bold">=</span> userInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectById</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//扣减金额
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMoney</span><span style="color:#000;font-weight:bold">(</span>userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMoney</span><span style="color:#000;font-weight:bold">()-</span>money<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//更新保存扣减后的用户信息到数据库
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#458;font-weight:bold">int</span> dcount <span style="color:#000;font-weight:bold">=</span> userInfoMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateById</span><span style="color:#000;font-weight:bold">(</span>userInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;更新用户受影响行数:&#34;</span><span style="color:#000;font-weight:bold">+</span>dcount<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//模拟异常
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#458;font-weight:bold">int</span> q<span style="color:#000;font-weight:bold">=</span>10<span style="color:#000;font-weight:bold">/</span>0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>重启user服务，再次测试，发现，订单、用户、日志数据都没有插入。</p>
<p>注意：controller、service千万不能try catch处理异常，一定要抛出异常，要不然分布式事务不会生效。</p>
<h2 id="4-分布式事务实战学员完成">4 分布式事务实战(学员完成)</h2>
<h3 id="41-undolog表结构导入">4.1 undolog表结构导入</h3>
<p>核心在于对业务sql进行解析，转换成undolog,所以只要支持Fescar分布式事务的微服务数据都需要导入该表结构，我们在每个微服务的数据库中都导入下面表结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>undo_log<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span>AUTO_INCREMENT,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>branch_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>xid<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>rollback_info<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>longblob<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_status<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_created<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>log_modified<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>datetime<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>ext<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>idx_unionkey<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>xid<span style="color:#000;font-weight:bold">`</span>,<span style="color:#000;font-weight:bold">`</span>branch_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span>AUTO_INCREMENT<span style="color:#000;font-weight:bold">=</span><span style="color:#099">200</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="42-fescar工程搭建">4.2 Fescar工程搭建</h3>
<p>在所有微服务工程中，不一定所有工程都需要使用分布式事务，我们可以创建一个独立的分布式事务工程，指定微服务需要支持分布式事务的时候，直接依赖独立的分布式工程即可。</p>
<p>搭建一个dongyimai-transaction-fescar提供fescar分布式事务支持。</p>
<h5 id="421-pomxml依赖">4.2.1 pom.xml依赖</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai_parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai_transaction_fescar<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;fescar.version&gt;</span>0.4.2<span style="color:#000080">&lt;/fescar.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai_common<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba.fescar<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-tm<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>${fescar.version}<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.alibaba.fescar<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>fescar-spring<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>${fescar.version}<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><h5 id="422-引入配置">4.2.2 引入配置</h5>
<p>将<code>fescar配置文件</code>文件夹中的所有配置文件拷贝到resources工程下，如下图：
<img src="/posts/project-0/20220528174166/image-20220528174536828.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>其中file.conf有2个配置
<img src="/posts/project-0/20220528174166/image-20220528174541479.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>service.vgroup_mapping.my_test_tx_group 映射到相应的 Fescar-Server 集群名称，然后再根据集群名称.grouplist 获取到可用服务列表。</p>
<h3 id="43-tm和proxydatasource">4.3 TM和ProxyDataSource</h3>
<p>核心在于对业务sql进行解析，转换成undolog，并同时入库，此时需要创建一个代理数据源，用代理数据源来实现。</p>
<p>要想实现全局事务管理器，需要添加一个<code>@GlobalTransactional注解</code>,该注解需要创建一个解析器，<code>GlobalTransactionScanner</code>,它是一个全局事务扫描器，用来解析带有@GlobalTransactional注解的方法，然后采用AOP的机制控制事务。</p>
<p>每次微服务和微服务之间相互调用,要想控制全局事务，每次TM都会请求TC生成一个XID，每次执行下一个事务，也就是调用其他微服务的时候都需要将该XID传递过去,所以我们可以每次请求的时候，都获取头中的XID，并将XID传递到下一个微服务。</p>
<h4 id="431-tm和proxydatasource实现">4.3.1 TM和ProxyDataSource实现</h4>
<p>创建FescarAutoConfiguration类，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">FescarAutoConfiguration</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String FESCAR_XID <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;fescarXID&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 创建代理数据库
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param environment
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> DataSource <span style="color:#900;font-weight:bold">dataSource</span><span style="color:#000;font-weight:bold">(</span>Environment environment<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        DruidDataSource dataSource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DruidDataSource<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUrl</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.url&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDriver</span><span style="color:#000;font-weight:bold">(</span>DriverManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDriver</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.url&#34;</span><span style="color:#000;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;can&#39;t recognize dataSource Driver&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUsername</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.username&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        dataSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPassword</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.datasource.password&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DataSourceProxy<span style="color:#000;font-weight:bold">(</span>dataSource<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 全局事务扫描器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 用来解析带有@GlobalTransactional注解的方法，然后采用AOP的机制控制事务
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param environment
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> GlobalTransactionScanner <span style="color:#900;font-weight:bold">globalTransactionScanner</span><span style="color:#000;font-weight:bold">(</span>Environment environment<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        String applicationName <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;spring.application.name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        String groupName <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;fescar.group.name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>applicationName <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> GlobalTransactionScanner<span style="color:#000;font-weight:bold">(</span>groupName <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;my_test_tx_group&#34;</span> <span style="color:#000;font-weight:bold">:</span> groupName<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> GlobalTransactionScanner<span style="color:#000;font-weight:bold">(</span>applicationName<span style="color:#000;font-weight:bold">,</span> groupName <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;my_test_tx_group&#34;</span> <span style="color:#000;font-weight:bold">:</span> groupName<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 每次微服务和微服务之间相互调用
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 要想控制全局事务，每次TM都会请求TC生成一个XID，每次执行下一个事务，也就是调用其他微服务的时候都需要将该XID传递过去
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 所以我们可以每次请求的时候，都获取头中的XID，并将XID传递到下一个微服务
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param restTemplates
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@ConditionalOnBean</span><span style="color:#000;font-weight:bold">({</span>RestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">addFescarInterceptor</span><span style="color:#000;font-weight:bold">(</span>Collection<span style="color:#000;font-weight:bold">&lt;</span>RestTemplate<span style="color:#000;font-weight:bold">&gt;</span> restTemplates<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        restTemplates<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forEach</span><span style="color:#000;font-weight:bold">(</span>restTemplate <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    List<span style="color:#000;font-weight:bold">&lt;</span>ClientHttpRequestInterceptor<span style="color:#000;font-weight:bold">&gt;</span> interceptors <span style="color:#000;font-weight:bold">=</span> restTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInterceptors</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>interceptors <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                        interceptors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>fescarRestInterceptor<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Object<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> FescarRMRequestFilter <span style="color:#900;font-weight:bold">fescarRMRequestFilter</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> FescarRMRequestFilter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> FescarRestInterceptor <span style="color:#900;font-weight:bold">fescarRestInterceptor</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> FescarRestInterceptor<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意：如果自定义fescar.group.name需要和file.conf中的名字保持一致。</p>
<p>创建FescarRMRequestFilter，给每个线程绑定一个XID，代码如下;</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">FescarRMRequestFilter</span> <span style="color:#000;font-weight:bold">extends</span> OncePerRequestFilter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> Logger LOGGER <span style="color:#000;font-weight:bold">=</span> org<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">slf4j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">LoggerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLogger</span><span style="color:#000;font-weight:bold">(</span>FescarRMRequestFilter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * 给每次线程请求绑定一个XID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param request
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param response
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param filterChain
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doFilterInternal</span><span style="color:#000;font-weight:bold">(</span>HttpServletRequest request<span style="color:#000;font-weight:bold">,</span> HttpServletResponse response<span style="color:#000;font-weight:bold">,</span> FilterChain filterChain<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> ServletException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String currentXID <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeader</span><span style="color:#000;font-weight:bold">(</span>FescarAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">FESCAR_XID</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>currentXID<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            RootContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>currentXID<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;当前线程绑定的XID :&#34;</span> <span style="color:#000;font-weight:bold">+</span> currentXID<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            filterChain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">doFilter</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            String unbindXID <span style="color:#000;font-weight:bold">=</span> RootContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unbind</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>unbindXID <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;当前线程从指定XID中解绑 XID :&#34;</span> <span style="color:#000;font-weight:bold">+</span> unbindXID<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>currentXID<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>unbindXID<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;当前线程的XID发生变更&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>currentXID <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;当前线程的XID发生变更&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建FescarRestInterceptor过滤器，每次请求其他微服务的时候，都将XID携带过去。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">FescarRestInterceptor</span> <span style="color:#000;font-weight:bold">implements</span> RequestInterceptor<span style="color:#000;font-weight:bold">,</span> ClientHttpRequestInterceptor <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">apply</span><span style="color:#000;font-weight:bold">(</span>RequestTemplate requestTemplate<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String xid <span style="color:#000;font-weight:bold">=</span> RootContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getXID</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>xid<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            requestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">header</span><span style="color:#000;font-weight:bold">(</span>FescarAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">FESCAR_XID</span><span style="color:#000;font-weight:bold">,</span> xid<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> ClientHttpResponse <span style="color:#900;font-weight:bold">intercept</span><span style="color:#000;font-weight:bold">(</span>HttpRequest request<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">[]</span> body<span style="color:#000;font-weight:bold">,</span> ClientHttpRequestExecution execution<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String xid <span style="color:#000;font-weight:bold">=</span> RootContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getXID</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>xid<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            HttpHeaders headers <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeaders</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            headers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>FescarAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">FESCAR_XID</span><span style="color:#000;font-weight:bold">,</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">singletonList</span><span style="color:#000;font-weight:bold">(</span>xid<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> execution<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="44-分布式事务测试">4.4 分布式事务测试</h3>
<h4 id="441-微服务添加依赖">4.4.1 微服务添加依赖</h4>
<p>因为所有微服务都有可能使用分布式事务，所以我们可以在每个微服务工程中添加fescar的依赖，当然，搜索工程排除，因为它不需要依赖数据库，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--fescar依赖--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-transaction-fescar<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="442-测试">4.4.2 测试</h4>
<p>在订单微服务的OrderServiceImpl的add方法上增加@GlobalTransactional(name = &ldquo;add&rdquo;)注解</p>
<p>在订单微服务的OrderServiceImpl的add方法上增加@GlobalTransactional(name = &ldquo;add&rdquo;)注解，代码如下：
<img src="/posts/project-0/20220528174166/image-20220528174555194.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这里涉及到几个微服务的调用，我们先查询下数据库数据，然后再测试一次，如果输出<code>添加订单完成</code>和<code>库存减少完毕</code>则表明订单微服务和商品微服务的事务已经完成，这时候我们在添加积分的方法中制造一个异常，如果积分添加异常，而商品微服务中数据没发生变化，则表明分布式事务控制成功。</p>
<p>修改用户微服务，在添加用户积分的地方制造异常，代码如下：
<img src="/posts/project-0/20220528174166/image-20220528174600809.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>启动Fescar-server，打开seata包/fescar-server-0.4.2/bin,双击fescar-server.bat启动fescar-server，如下：
<img src="/posts/project-0/20220528174166/image-20220528174607397.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>测试前后结果一致</p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project/20220528234610/">← tk-题库项目开发3</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528162731/">微服务网关和Jwt令牌  →</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
