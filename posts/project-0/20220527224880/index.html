<!DOCTYPE html>
<html><head>
  
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">

  <title>搜索解决方案-Elasticsearch</title>
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>
  <style>
    .highlight {
      overflow-x: auto;
    }

    pre {
      position: relative;
      padding: 30px 10px 10px 10px;
      border-width: 1px;
      border-color:#7c4242;
    }

    .post-content pre code {
      font-family: Consolas;
    }

    pre::after {
      display: block;
      content: " ";
      position: absolute;
      border-radius: 50%;
      background: #ff5f56;
      width: 12px;
      height: 12px;
      top: 0;
      left: 12px;
      margin-top: 12px;
      -webkit-box-shadow: 20px 0 #ffbd2e, 40px 0 #27c93f;
      box-shadow: 20px 0 #ffbd2e, 40px 0 #27c93f;
    }










    html,
    body {
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .page-list {
      height: 18em;
      background-color: rgba(255, 255, 255, 0);
      border-radius: 20px;
      margin-bottom: 2em;
      box-shadow: 2px 4px 6px #000;
      display: flex;
    }

    .page-img {
      float: left;
      display: block;
      width: 40%;
      height: 100%;
      border-radius: 20px 0px 0px 20px;
      background-color: yellow;
      background-image: url(https://api.ixiaowai.cn/api/api.php);
      background-repeat: no-repeat;
      background-size: 100% 100%;
      -moz-background-size: 100% 100%;
    }

    .page-mian {
      float: left;
      display: block;
      width: 60%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0);
       
      padding: 0% 2% 0% 2%;
    }

    .page-Title a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-Content a {
      text-decoration: none;
      font-size: 16px;
      color: rgb(0, 0, 0);
    }


    .ull {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.263);
      height: 50px;
      margin: 0px;
    }

    .ull a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(255, 255, 255);
    }

    .lii {
      display: inline;
      margin-right: 20px;
    }

    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }










    @media screen and (max-width: 1080px) {

       
      .navigation {
        display: none;
      }

      .page-list {
        height: 25em;
        background-color: rgba(255, 255, 255, 0);
        border-radius: 20px;
        margin-bottom: 2em;
        box-shadow: 2px 4px 6px #000;
        display: block;
      }

      .page-img {
        width: 100%;
        height: 40%;
        border-radius: 20px 20px 0px 0px;
        background-color: yellow;
        background-image: url(https://api.ixiaowai.cn/api/api.php);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        -moz-background-size: 100% 100%;
      }

      .page-mian {
        width: 100%;
        height: 60%;
        background-color: rgba(0, 0, 0, 0);
         
        padding: 0% 2% 0% 2%;
      }

    }
  </style>




  <style>
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }
  </style>
  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }

     
    .navigation {
      width: 100%;
      height: 50px;
      background-color: rgba(208, 240, 121, 0.184);
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;
    }

     
    .hide {
      top: -60px;
    }
  </style>
</head><body><input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> Home
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-book'></i> Posts
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Archive
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Categories
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> Tags
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> About
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap content"><nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> Home
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-book'></i> Posts
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Archive
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> Categories
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> Tags
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> About
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-27&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-27&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            9081 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            19 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['搜索解决方案-Elasticsearch'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            <div class="js-toc-content">
                <h1 align = "center">第六章</h1>
<h1 align = "center">搜索解决方案-Elasticsearch</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>Elasticsearch、Kibana环境配置</li>
<li>DSL语句讲解</li>
<li>商品索引库导入讲解</li>
<li>商品关键词搜索实现</li>
<li>分类统计搜索</li>
</ul>
<h1 id="一elasticsearch-安装">一、Elasticsearch 安装</h1>
<p>ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTfulweb接口。ElasticSearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。构建在全文检索开源软件Lucene之上的Elasticsearch，不仅能对海量规模的数据完成分布式索引与检索，还能提供数据聚合分析。据国际权威的数据库产品评测机构DBEngines的统计，在2016年1月，Elasticsearch已超过Solr等，成为排名第一的搜索引擎类应用</p>
<p>简之：ElasticSearch是基于Restfull乐准的高扩展高可用的实时数据分析的全文搜索工具。</p>
<p>基本概念</p>
<p><img src="/posts/project-0/20220527224880/image-20220527225257010.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>此处需要注意：关于类型type在不同版本是有所变化的</p>
<p>Elasticsearch 官网提出的近期版本对 type 概念的演变情况如下：</p>
<p>在 <strong>5.X</strong> 版本中，<strong>一个 index</strong> 下<strong>可以创建多个 type</strong>；</p>
<p>在 <strong>6.X</strong> 版本中，<strong>一个 index</strong> 下<strong>只能存在一个 type</strong>；</p>
<p>在 <strong>7.X</strong> 版本中，直接<strong>去除了 type</strong> 的概念，就是说 <strong>index 不再会有 type</strong>。</p>
<p>主要目的就是 为了保持 Elasticsearch “<strong>一切为了搜索</strong>” 的宗旨</p>
<p>由于我们之前已经使用过elasticsearch了，这里不再对它进行过多的介绍了，直接下载安装，本章节将采用Docker安装，不过在市面上还有很多采用linxu安装，关于linux安装，已经提供了安装手册，这里就不讲了。</p>
<p>我们之前已经使用过elasticsearch了，这里不再对它进行介绍了，直接下载安装，本章节将采用Docker安装，不过在市面上还有很多采用linxu安装，关于linux安装，已经提供了安装手册，这里就不讲了。</p>
<h2 id="1docker镜像下载">(1)docker镜像下载</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker pull elasticsearch:7.7.0
</span></span></code></pre></div><p>注意：建议还原镜像备份文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker load -i elasticsearch7.7.tar
</span></span></code></pre></div><h2 id="2安装es容器">(2)安装es容器</h2>
<p>因为elasticsearch在启动的时候会进行一些检查，比如最多打开的文件的个数以及虚拟内存区域数量等等，所以我们需要先进行系统调优，需要在虚拟机下设置<code>max_map_count</code>，否则elasticsearch容器会启动不起来
查看<code>max_map_count</code>的值 默认是65530</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /proc/sys/vm/max_map_count
</span></span></code></pre></div><p>重新设置<code>max_map_count</code>的值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sysctl -w vm.max_map_count<span class="o">=</span><span class="m">262144</span>
</span></span></code></pre></div><p>然后执行运行容器命令，如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker run -di --name dym_es -p 9200:9200 -p 9300:9300 -e &#34;discovery.type=single-node&#34; -e &#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;  elasticsearch:7.7.0 
</span></span></code></pre></div><p>命令解释：</p>
<p>9200端口(Web管理平台端口)  9300(服务默认端口)</p>
<p><code>-e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot;</code>是设置占用内存大小，一般线上检索服务器-ES服务器32G，这里就小一点测试</p>
<p><code>-e &quot;discovery.type=single-node&quot;</code>这个是设置单节点运行</p>
<h2 id="3开启远程连接及跨域配置">(3)开启远程连接及跨域配置</h2>
<p>将elasticsearch容器内部的/usr/share/elasticsearch/config/elasticsearch.yml配置文件拷贝到虚拟机的root目录下，编辑增加以下命令。</p>
<p>拷贝命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker cp dym_es:/usr/share/elasticsearch/config/elasticsearch.yml /root/elasticsearch.yml
</span></span></code></pre></div><p>编辑elasticsearch.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cluster.name: my-application
</span></span><span class="line"><span class="cl">http.cors.enabled: true
</span></span><span class="line"><span class="cl">http.cors.allow-origin: &#34;*&#34;
</span></span><span class="line"><span class="cl">network.host: 0.0.0.0
</span></span></code></pre></div><p>其中：</p>
<p>cluster.name：自定义集群名称。
network.host：当前es节点绑定的ip地址，默认127.0.0.1，如果需要开放对外访问这个属性必须设置。http.cors.enabled: true：此步为允许elasticsearch跨域访问，默认是false。
<code>http.cors.allow-origin: &quot;*&quot;</code>：表示跨域访问允许的域名地址（*表示任意）。</p>
<p>删除之前的es容器，并重新执行运行容器命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker rm -f dym_es
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker run -di --name dym_es -p 9200:9200 -p 9300:9300 -e <span class="s2">&#34;discovery.type=single-node&#34;</span> -e <span class="s2">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span> -v /root/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml elasticsearch:7.7.0
</span></span></code></pre></div><p>浏览器输入地址访问：`http://192.168.188.128:9200/
<img src="/posts/project-0/20220527224880/image-20220527230503925.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>小提示：如果想让容器开启重启，可以执行下面命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker update --restart=always dym_es
</span></span></code></pre></div><h1 id="二ik分词器安装">二、IK分词器安装</h1>
<p>(1)安装ik分词器</p>
<p>IK分词器下载地址https://github.com/medcl/elasticsearch-analysis-ik/releases</p>
<p>上传分词器压缩文件到linux服务器，拷贝文件到ES容器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker cp /root/elasticsearch-analysis-ik-7.7.0.zip   dym_es:/usr/share/elasticsearch/plugins/elasticsearch-analysis-ik-7.7.0.zip
</span></span></code></pre></div><p>进入容器安装ik分词器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker exec -it dym_es /bin/bash
</span></span><span class="line"><span class="cl">cd  /usr/share/elasticsearch/plugins/
</span></span></code></pre></div><p>在plugins目录下安装ik分词器，ik分词器需要和es版本一致</p>
<p>使用上传的插件压缩包安装：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir ik
</span></span><span class="line"><span class="cl">mv elasticsearch-analysis-ik-7.7.0.zip  ik/
</span></span><span class="line"><span class="cl">cd ik
</span></span><span class="line"><span class="cl">unzip elasticsearch-analysis-ik-7.7.0.zip
</span></span></code></pre></div><p>也可以基于网络安装：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.7.0/elasticsearch-analysis-ik-7.7.0.zip
</span></span></code></pre></div><p>退出容器并重启</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker restart dym_es
</span></span></code></pre></div><p>测试安装成功，地址栏输入：</p>
<p>http://192.168.188.128:9200/_cat/plugins
<img src="/posts/project-0/20220527224880/image-20220527230518571.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>IK分词器有两种分词模式：ik_max_word和ik_smart模式。</p>
<p>1、ik_max_word</p>
<p>会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民、中华、华人、人民共和国、人民、共和国、大会堂、大会、会堂等词语。</p>
<p>2、ik_smart
会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为中华人民共和国、人民大会堂。</p>
<p>两种分词器使用的最佳实践是：索引时用ik_max_word，在搜索时用ik_smart。
<strong>即：索引时最大化的将文章内容分词，搜索时更精确的搜索到想要的结果。</strong></p>
<h1 id="三-kibana使用-掌握dsl语句">三、 Kibana使用-掌握DSL语句</h1>
<p>我们这里需要一个更专业的工具实现对日志的实时分析，也就是我们接下来要讲的kibana。</p>
<p>Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作。您可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作。您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现。</p>
<p>Kibana 可以使大数据通俗易懂。它很简单，基于浏览器的界面便于您快速创建和分享动态数据仪表板来追踪 Elasticsearch 的实时数据变化。</p>
<p>搭建 Kibana 非常简单。您可以分分钟完成 Kibana 的安装并开始探索 Elasticsearch 的索引数据 — 没有代码、不需要额外的基础设施。</p>
<h3 id="31--kibana下载安装">3.1  Kibana下载安装</h3>
<p>我们项目中不再使用linux，直接使用Docker，所有这里就不演示在windows的下载安装了。</p>
<p>(1)镜像下载</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker pull kibana:7.7.0
</span></span></code></pre></div><p>为了节省时间,建议还原虚拟机备份文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker load -i kibana7.7.tar
</span></span></code></pre></div><p>(2)安装kibana容器</p>
<p>执行如下命令，开始安装kibana容器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker run -di --link dym_es:elasticsearch --name kibana --restart=always -p 5601:5601 kibana:7.7.0
</span></span></code></pre></div><p>restart=always:每次服务都会重启，也就是开启启动</p>
<p>5601:5601:端口号</p>
<p>(3)访问测试</p>
<p>访问<code>http://192.168.188.128:5601</code>如下：
<img src="/posts/project-0/20220527224880/image-20220527230531004.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="32-kibana使用">3.2 Kibana使用</h3>
<h4 id="321-配置索引">3.2.1 配置索引</h4>
<p>此处我们选择 图中所示：自己的数据
<img src="/posts/project-0/20220527224880/image-20220527230538800.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>选择上图的设置图标</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230551964.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>接下来就可以和es进行交互了</p>
<h4 id="322-索引管理">3.2.2 索引管理</h4>
<p>要使用Kibana，您必须至少配置一个索引（但是要求Elasticsearch中要有数据）。索引用于标识Elasticsearch索引以运行搜索和分析。它们还用于配置字段等。下面我们看如何管理查看索引。</p>
<p>点击 设置-选择D -Manager space</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230559697.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>选择 Index Patterns</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230612571.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>创建一个索引</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230621404.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>没有数据目前不能建立索引
<img src="/posts/project-0/20220527224880/image-20220527230629462.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>后面添加过索引可以通过如下方法查看添加的索引</p>
<p><img src="/posts/project-0/20220527224880/image-20220527230637812.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>输入索引规则，点击下一步
<img src="/posts/project-0/20220527224880/image-20220527230648100.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>点击创建
<img src="/posts/project-0/20220527224880/image-20220527230654594.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>域的每个标题选项分别代表如下意思：
<img src="/posts/project-0/20220527224880/image-20220527230701373.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>也可以直接查看 选择 Elasticsearch-Index Managerment 查看创建的索引
<img src="/posts/project-0/20220527224880/image-20220527230709653.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="323-dsl语句使用">3.2.3 DSL语句使用</h4>
<h5 id="3231-query-dsl结构化查询介绍">3.2.3.1 Query DSL结构化查询介绍</h5>
<p>Query DSL是一个Java开源框架用于构建类型安全的SQL查询语句。采用API代替传统的拼接字符串来构造查询语句。目前Querydsl支持的平台包括JPA,JDO，SQL，Java Collections，RDF，Lucene，Hibernate Search。elasticsearch提供了一整套基于JSON的查询DSL语言来定义查询。
Query DSL当作是一系列的抽象的查询表达式树(AST)特定查询能够包含其它的查询，(如 bool ), 有些查询能够包含过滤器(如 constant_score), 还有的可以同时包含查询和过滤器 (如 filtered). 都能够从ES支持查询集合里面选择任意一个查询或者是从过滤器集合里面挑选出任意一个过滤器, 这样的话，我们就可以构造出任意复杂（maybe 非常有趣）的查询了。</p>
<h5 id="3232-测试分词">3.2.3.2 测试分词</h5>
<p>（1）ik_smart
<img src="/posts/project-0/20220527224880/image-20220527230718701.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">POST</span> <span class="err">_analyze</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;中华人民共和国人民大会堂&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>(2) ik_max_word
<img src="/posts/project-0/20220527224880/image-20220527230726538.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">POST</span> <span class="err">_analyze</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;中华人民共和国人民大会堂&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="四数据导入es">四、数据导入ES</h1>
<h3 id="41-springdata-elasticsearch介绍">4.1 SpringData Elasticsearch介绍</h3>
<h4 id="411-springdata介绍">4.1.1 SpringData介绍</h4>
<p>Spring Data是一个用于简化数据库访问，并支持云服务的开源框架。其主要目标是使得对数据的访问变得方便快捷，并支持map-reduce框架和云计算数据服务。 Spring Data可以极大的简化JPA的写法，可以在几乎不用写实现的情况下，实现对数据的访问和操作。除了CRUD外，还包括如分页、排序等一些常用的功能。</p>
<p>Spring Data的官网：https://spring.io/projects/spring-data</p>
<h4 id="412-springdata-es介绍">4.1.2 SpringData ES介绍</h4>
<p>Spring Data ElasticSearch 基于 spring data API 简化 elasticSearch操作，将原始操作elasticSearch的客户端API 进行封装 。Spring Data为Elasticsearch项目提供集成搜索引擎。Spring Data Elasticsearch POJO的关键功能区域为中心的模型与Elastichsearch交互文档和轻松地编写一个存储库数据访问层。 官方网站：https://spring.io/projects/spring-data-elasticsearch</p>
<h3 id="42-搜索工程搭建">4.2 搜索工程搭建</h3>
<p>创建搜索微服务工程，dongyimai-search-service,该工程主要提供搜索服务以及索引数据的更新操作。</p>
<p>(1)API工程搭建</p>
<p>首先创建search的API工程,在dongyimai-service-api中创建dongyimai-search-service-api，如下图：
<img src="/posts/project-0/20220527224880/image-20220527230738835.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>pom.xml如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-search-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;maven.compiler.source&gt;</span>8<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;maven.compiler.target&gt;</span>8<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--goods API依赖--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>dongyimai-sellergoods-serivce-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--SpringDataES依赖--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-elasticsearch<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p>(2)搜索微服务搭建</p>
<p>在dongyimai-service中搭建dongyimai-search-service微服务，并进行相关配置。</p>
<p><strong>pom.xml配置</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-service<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-search-service<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;maven.compiler.source&gt;</span>8<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;maven.compiler.target&gt;</span>8<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>dongyimai-search-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p><strong>application.yml配置</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server:
</span></span><span class="line"><span class="cl">  port: 9005
</span></span><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl">  application:
</span></span><span class="line"><span class="cl">    name: search
</span></span><span class="line"><span class="cl">  elasticsearch:
</span></span><span class="line"><span class="cl">    rest:
</span></span><span class="line"><span class="cl">      uris: 192.168.188.128:9200  #此处配置elasticsearch的访问地址  
</span></span><span class="line"><span class="cl">eureka:
</span></span><span class="line"><span class="cl">  client:
</span></span><span class="line"><span class="cl">    service-url:
</span></span><span class="line"><span class="cl">      defaultZone: http://127.0.0.1:8761/eureka
</span></span><span class="line"><span class="cl">  instance:
</span></span><span class="line"><span class="cl">    prefer-ip-address: true
</span></span><span class="line"><span class="cl">feign:
</span></span><span class="line"><span class="cl">  hystrix:
</span></span><span class="line"><span class="cl">    enabled: true
</span></span><span class="line"><span class="cl">#超时配置
</span></span><span class="line"><span class="cl">ribbon:
</span></span><span class="line"><span class="cl">  ReadTimeout: 300000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hystrix:
</span></span><span class="line"><span class="cl">  command:
</span></span><span class="line"><span class="cl">    default:
</span></span><span class="line"><span class="cl">      execution:
</span></span><span class="line"><span class="cl">        isolation:
</span></span><span class="line"><span class="cl">          thread:
</span></span><span class="line"><span class="cl">            timeoutInMilliseconds: 10000
</span></span></code></pre></div><p>(3)启动类</p>
<p>创建SearchApplication作为搜索微服务工程的启动类，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="o">{</span><span class="n">DruidDataSourceAutoConfigure</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SearchApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SearchApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>分别创建对应的包，dao、service、controller，如下图：
<img src="/posts/project-0/20220527224880/image-20220527230750192.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="43-数据导入">4.3 数据导入</h3>
<p>现在需要将数据从数据库中查询出来，然后将数据导入到ES中。
<img src="/posts/project-0/20220527224880/image-20220527230758388.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>数据导入流程如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.请求search服务,调用数据导入地址
</span></span><span class="line"><span class="cl">2.根据注册中心中的注册的goods服务的地址，使用Feign方式查询所有已经审核的Sku
</span></span><span class="line"><span class="cl">3.使用SpringData Es将查询到的Sku集合导入到ES中
</span></span></code></pre></div><h4 id="431-文档映射bean创建">4.3.1 文档映射Bean创建</h4>
<p>搜索商品的时候，会根据如下属性搜索数据,并且不是所有的属性都需要分词搜索，我们创建JavaBean，将JavaBean数据存入到ES中要以搜索条件和搜索展示结果为依据，部分关键搜索条件分析如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.可能会根据商品名称搜索，而且可以搜索商品名称中的任意一个词语，所以需要分词
</span></span><span class="line"><span class="cl">2.可能会根据商品分类搜索，商品分类不需要分词
</span></span><span class="line"><span class="cl">3.可能会根据商品品牌搜索，商品品牌不需要分词
</span></span><span class="line"><span class="cl">4.可能会根据商品商家搜索，商品商家不需要分词
</span></span><span class="line"><span class="cl">5.可能根据规格进行搜索，规格时一个键值对结构，用Map
</span></span></code></pre></div><p>根据上面的分析，我们可以在dongyimai-search-service-api工程中创建com.offcn.search.pojo.SkuInfo，如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Document</span><span class="o">(</span><span class="n">indexName</span> <span class="o">=</span> <span class="s">&#34;skuinfo&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SkuInfo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//商品id，同时也是商品编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Id</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//SKU名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">FieldType</span><span class="o">.</span><span class="na">Text</span><span class="o">,</span> <span class="n">analyzer</span> <span class="o">=</span> <span class="s">&#34;ik_smart&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//商品价格，单位为：元
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">FieldType</span><span class="o">.</span><span class="na">Double</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">price</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//库存数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//商品图片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">image</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//商品状态，1-正常，2-下架，3-删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">status</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//创建时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//更新时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Date</span> <span class="n">updateTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//是否默认
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">isDefault</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//goodsId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">goodsId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//类目ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">categoryId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//类目名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// @Field(type = FieldType.Keyword)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">category</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//品牌名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// @Field(type = FieldType.Keyword)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">brand</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//规格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">spec</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//规格参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">specMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//对应的get、set方法省略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">....</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="432-搜索审核通过sku">4.3.2 搜索审核通过Sku</h4>
<p>修改dongyimai-sellergoods-service微服务，添加搜索审核通过的Sku，供search微服务调用。</p>
<p><strong>下面都是针对goods微服务的操作。</strong></p>
<p>修改ItemService接口，添加根据状态查询Sku方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 根据状态查询SKU列表
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">  <span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="nf">findByStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">status</span><span class="o">);</span>
</span></span></code></pre></div><p>修改ItemServiceImpl，添加根据状态查询Sku实现方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="nf">findByStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="n">queryWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryWrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&#34;status&#34;</span><span class="o">,</span><span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">queryWrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>修改com.offcn.sellergoods.controller.ItemController，添加根据审核状态查询Sku方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据审核状态查询Sku
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param status
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/status/{status}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span> <span class="nf">findByStatus</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">status</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">itemService</span><span class="o">.</span><span class="na">findByStatus</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;查询成功&#34;</span><span class="o">,</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>访问地址：http://localhost:9001/item/status/1
<img src="/posts/project-0/20220527224880/image-20220527230811094.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="433-sku导入es实现">4.3.3 Sku导入ES实现</h4>
<p>(1) Feign配置</p>
<p>修改dongyimai-sellergoods-service-api工程，在com.offcn.sellergoods.feign.ItemFeign上添加findSkuList方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&#34;dym-sellergoods&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ItemFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据审核状态查询Sku
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param status
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/item/status/{status}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span> <span class="nf">findByStatus</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(2) Dao创建</p>
<p>修改dongyimai-search-service工程，创建com.dongyimai.search.dao.SkuEsMapper,该接口主要用于索引数据操作，主要使用它来实现将数据导入到ES索引库中，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SkuEsMapper</span> <span class="kd">extends</span> <span class="n">ElasticsearchRepository</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">,</span><span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(3) 服务层创建</p>
<p>修改dongyimai-search-service工程，创建com.dongyimai.search.service.SkuService,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SkuService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 导入SKU数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">importSku</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改dongyimai-search-service工程，创建com.offcn.search.service.impl.SkuServiceImpl,实现Sku数据导入到ES中，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SkuServiceImpl</span> <span class="kd">implements</span> <span class="n">SkuService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SkuEsMapper</span> <span class="n">skuEsMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ItemFeign</span> <span class="n">itemFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importSku</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//调用商品微服务，获取sku商品数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">itemFeign</span><span class="o">.</span><span class="na">findByStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//把返回的结果返回搜索实体类数据集合(采用深克隆技术，把Item对象属性值复制到SkuInfo对象)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuInfoList</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseArray</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">()),</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历sku集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">SkuInfo</span> <span class="n">skuInfo</span> <span class="o">:</span> <span class="n">skuInfoList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取规格json字符串，转换为map对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">.</span><span class="na">getSpec</span><span class="o">(),</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//关联设置到specMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skuInfo</span><span class="o">.</span><span class="na">setSpecMap</span><span class="o">(</span><span class="n">specMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//保存sku集合数据到es
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">skuEsMapper</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">skuInfoList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)控制层配置</p>
<p>修改dongyimai-search-service工程，在com.offcn.search.controller.SkuController类中添加如下方法调用上述导入方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/search&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@CrossOrigin</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SkuController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SkuService</span> <span class="n">skuService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 导入数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/import&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">search</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">skuService</span><span class="o">.</span><span class="na">importSku</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;导入数据到索引库中成功！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(5)修改启动类</p>
<p>启动类中需要开启Feign客户端，并且需要添加ES包扫描，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span><span class="o">={</span><span class="n">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">&#34;com.offcn.sellergoods.feign&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableElasticsearchRepositories</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">&#34;com.offcn.search.dao&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SearchApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SearchApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意如果出现错误：
<img src="/posts/project-0/20220527224880/image-20220527230823397.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>解决办法，修改application.yml增加如下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">main</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allow-bean-definition-overriding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>(6)测试</p>
<p>调用http://localhost:9005/search/import进行测试</p>
<p>打开Kibana可以看到如下数据：</p>
<p><code>http://192.168.188.128:5601</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /skuinfo/_search
</span></span></code></pre></div><p><img src="/posts/project-0/20220527224880/image-20220527230830310.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="五关键字搜索">五、关键字搜索</h1>
<p><img src="/posts/project-0/20220527224880/image-20220527230835463.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们先使用SpringDataElasticsearch实现一个简单的搜索功能，先实现根据关键字搜索，从上面搜索图片可以看得到，每次搜索的时候，除了关键字外，还有可能有品牌、分类、规格等，后台接收搜索条件使用Map接收比较合适。</p>
<h3 id="51-服务层实现">5.1 服务层实现</h3>
<p>修改search服务的com.offcn.search.service.SkuService,添加搜索方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 搜索
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param searchMap
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">);</span>
</span></span></code></pre></div><p>修改search服务的com.dongyimai.search.service.impl.SkuServiceImpl,添加搜索实现方法,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ElasticsearchRestTemplate</span> <span class="n">elasticsearchRestTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">//1.获取关键字的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">String</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">keywords</span> <span class="o">=</span> <span class="s">&#34;华为&#34;</span><span class="o">;</span><span class="c1">//赋值给一个默认的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">}</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//2.创建查询对象 的构建对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">//3.设置查询的条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//使用：QueryBuilders.matchQuery(&#34;title&#34;, keywords) ，搜索华为 ---&gt; 华    为 二字可以拆分查询，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//使用：QueryBuilders.matchPhraseQuery(&#34;title&#34;, keywords) 华为二字不拆分查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span> <span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//5.执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchHits</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">elasticsearchRestTemplate</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//对搜索searchHits集合进行分页封装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">SearchHitSupport</span><span class="o">.</span><span class="na">searchPageFor</span><span class="o">(</span><span class="n">searchHits</span><span class="o">,</span> <span class="n">query</span><span class="o">.</span><span class="na">getPageable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历取出查询的商品信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHit</span> <span class="o">:</span><span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 获取搜索到的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SkuInfo</span> <span class="n">content</span> <span class="o">=</span> <span class="o">(</span><span class="n">SkuInfo</span><span class="o">)</span> <span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">SkuInfo</span> <span class="n">skuInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SkuInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//把一个对象属性值复制到另外一个对象：两个对象属性名称必须一致，属性类型必须相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">BeanUtils</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">skuList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//6.返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuList</span><span class="o">);</span><span class="c1">//获取所需SkuInfo集合数据内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span><span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">());</span><span class="c1">//总记录数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span><span class="c1">//总页数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><strong>注意</strong>: ElasticSearchTemplate更多是对ESRepository的补充，里面提供了一些更底层的方法,更加适用于查询数据</p>
<h3 id="52-控制层实现">5.2 控制层实现</h3>
<p>修改com.offcn.search.controller.SkuController，在控制层调用Service层即可，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 搜索
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param searchMap
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="nd">@RequestBody</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="n">Map</span> <span class="n">searchMap</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>  <span class="n">skuService</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">searchMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="53-测试">5.3 测试</h3>
<p>使用Postman工具，输入http://localhost:9005/search</p>
<p>选中POST提交
<img src="/posts/project-0/20220527224880/image-20220527230845070.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="六-分类统计">六、 分类统计</h1>
<h3 id="61-分类统计分析">6.1 分类统计分析</h3>
<p>看下面的SQL语句，我们在执行搜索的时候，第1条SQL语句是执行搜，第2条语句是根据分类名字分组查看有多少分类，大概执行了2个步骤就可以获取数据结果以及分类统计，我们可以发现他们的搜索条件完全一样。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询所有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tb_item</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%手机%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 根据分类名字分组查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="n">tb_item</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%手机%&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">category</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><img src="/posts/project-0/20220527224880/image-20220527230852516.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>我们每次执行搜索的时候，需要显示商品分类名称，这里要显示的分类名称其实就是符合搜素条件的所有商品的分类集合，我们可以按照上面的实现思路，使用ES根据分组名称做一次分组查询即可实现。</p>
<h3 id="62-分类分组统计实现">6.2 分类分组统计实现</h3>
<p>修改search微服务的com.offcn.search.service.impl.SkuServiceImpl类，整体代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">   <span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//1.获取关键字的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">keywords</span> <span class="o">=</span> <span class="s">&#34;华为&#34;</span><span class="o">;</span><span class="c1">//赋值给一个默认的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2.创建查询对象 的构建对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置分组的条件  terms后表示分组查询后的列名,注意搜索字段后面加.keyword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.设置查询的条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//使用：QueryBuilders.matchQuery(&#34;title&#34;, keywords) ，搜索华为 ---&gt; 华    为 二字可以拆分查询，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//使用：QueryBuilders.matchPhraseQuery(&#34;title&#34;, keywords) 华为二字不拆分查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span> <span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//5.执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchHits</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">elasticsearchRestTemplate</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//对搜索searchHits集合进行分页封装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">SearchHitSupport</span><span class="o">.</span><span class="na">searchPageFor</span><span class="o">(</span><span class="n">searchHits</span><span class="o">,</span> <span class="n">query</span><span class="o">.</span><span class="na">getPageable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Terms</span> <span class="n">terms</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取分类名称集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">terms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span><span class="c1">// 分组的值（分类名称）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">categoryList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历取出查询的商品信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHit</span> <span class="o">:</span><span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 获取搜索到的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SkuInfo</span> <span class="n">content</span> <span class="o">=</span> <span class="o">(</span><span class="n">SkuInfo</span><span class="o">)</span> <span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">SkuInfo</span> <span class="n">skuInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SkuInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">BeanUtils</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">skuList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//6.返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuList</span><span class="o">);</span><span class="c1">//获取所需SkuInfo集合数据内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span><span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">());</span><span class="c1">//总记录数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span><span class="c1">//总页数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;categoryList&#34;</span><span class="o">,</span><span class="n">categoryList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>添加的代码如下:
<img src="/posts/project-0/20220527224880/image-20220527230901579.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220527224880/image-20220527230908138.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220527224880/image-20220527230914696.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意分组搜索要加keyword，因为数据存储结构是keyword类型</p>
<p>具体查看数据结构可以使用如下指令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /skuinfo/_mapping
</span></span></code></pre></div><p><img src="/posts/project-0/20220527224880/image-20220527230921890.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="63-测试">6.3 测试</h3>
<p>请求http://localhost:9005/search
<img src="/posts/project-0/20220527224880/image-20220527230928474.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="64-代码优化">6.4 代码优化</h3>
<p>如上,可以将获取分组的代码进行提取,如下代码所示:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取分类列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param terms
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringsCategoryList</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">terms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span><span class="c1">// 分组的值（分类名称）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">categoryList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>在search方法中进行调用:
<img src="/posts/project-0/20220527224880/image-20220527230939376.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">        <span class="c1">// 获取分类名称集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getStringsCategoryList</span><span class="o">(</span><span class="n">terms</span><span class="o">);</span>
</span></span></code></pre></div><p>整体代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.search.service.impl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.entity.Result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.search.dao.SkuEsMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.search.pojo.SkuInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.search.service.SkuService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.sellergoods.feign.SkuFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.sellergoods.pojo.Item</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.lang.StringUtils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.elasticsearch.index.query.QueryBuilders</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.elasticsearch.search.aggregations.AggregationBuilders</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.elasticsearch.search.aggregations.bucket.terms.Terms</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.BeanUtils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.elasticsearch.core.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.elasticsearch.core.query.NativeSearchQuery</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SkuServiceImpl</span> <span class="kd">implements</span> <span class="n">SkuService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SkuEsMapper</span> <span class="n">skuEsMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SkuFeign</span> <span class="n">skuFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 导入SKU数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importSku</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//调用商品微服务，获取sku商品数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">skuFeign</span><span class="o">.</span><span class="na">findByStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//把数据转换为搜索实体类数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuInfoList</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseArray</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">()),</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历sku集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">SkuInfo</span> <span class="n">skuInfo</span> <span class="o">:</span> <span class="n">skuInfoList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取规格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">specMap</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">.</span><span class="na">getSpec</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//关联设置到specMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skuInfo</span><span class="o">.</span><span class="na">setSpecMap</span><span class="o">(</span><span class="n">specMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//保存sku集合数据到es
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">skuEsMapper</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">skuInfoList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ElasticsearchRestTemplate</span> <span class="n">elasticsearchRestTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Map</span> <span class="nf">search</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">searchMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//1.获取关键字的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">searchMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;keywords&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">keywords</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">keywords</span> <span class="o">=</span> <span class="s">&#34;华为&#34;</span><span class="o">;</span><span class="c1">//赋值给一个默认的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2.创建查询对象 的构建对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQueryBuilder</span> <span class="n">nativeSearchQueryBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NativeSearchQueryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置分组的条件  terms后表示分组查询后的列名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">addAggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;category.keyword&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.设置查询的条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//使用：QueryBuilders.matchQuery(&#34;title&#34;, keywords) ，搜索华为 ---&gt; 华    为 二字可以拆分查询，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//使用：QueryBuilders.matchPhraseQuery(&#34;title&#34;, keywords) 华为二字不拆分查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;title&#34;</span><span class="o">,</span> <span class="n">keywords</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//4.构建查询对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">NativeSearchQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">nativeSearchQueryBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//5.执行查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchHits</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">elasticsearchRestTemplate</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">SkuInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//对搜索searchHits集合进行分页封装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SearchPage</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuPage</span> <span class="o">=</span> <span class="n">SearchHitSupport</span><span class="o">.</span><span class="na">searchPageFor</span><span class="o">(</span><span class="n">searchHits</span><span class="o">,</span> <span class="n">query</span><span class="o">.</span><span class="na">getPageable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取分组结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Terms</span> <span class="n">terms</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;skuCategorygroup&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取分类名称集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getStringsCategoryList</span><span class="o">(</span><span class="n">terms</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历取出查询的商品信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">skuList</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span><span class="o">&lt;</span><span class="n">SkuInfo</span><span class="o">&gt;</span> <span class="n">searchHit</span> <span class="o">:</span><span class="n">skuPage</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 获取搜索到的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SkuInfo</span> <span class="n">content</span> <span class="o">=</span> <span class="o">(</span><span class="n">SkuInfo</span><span class="o">)</span> <span class="n">searchHit</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">SkuInfo</span> <span class="n">skuInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SkuInfo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">BeanUtils</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">skuList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">skuInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//6.返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;rows&#34;</span><span class="o">,</span> <span class="n">skuList</span><span class="o">);</span><span class="c1">//获取所需SkuInfo集合数据内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;total&#34;</span><span class="o">,</span><span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">());</span><span class="c1">//总记录数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;totalPages&#34;</span><span class="o">,</span> <span class="n">skuPage</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span><span class="c1">//总页数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;categoryList&#34;</span><span class="o">,</span><span class="n">categoryList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 获取分类列表数据
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param terms
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStringsCategoryList</span><span class="o">(</span><span class="n">Terms</span> <span class="n">terms</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">terms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">terms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">keyAsString</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span><span class="c1">// 分组的值（分类名称）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">categoryList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyAsString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div>
            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220527222325/">← 广告管理与Lua、Canal实现广告缓存</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220527233134/">消息队列及短信发送平台  →</a></button>
            </div>
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山客</div>
                <div class="author-info__description">晓梦云码支付 <s>三网云端免挂/QQ/支付宝/微信</s>pay.yzfyd.cn</div>
            </div>
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://yzfyd.cn" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
        </div>
    </div>


    <div class="card-widget card-announcement">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget card-announcement">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget card-announcement">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget card-webinfo">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>
<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">

    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>

    var a = 0;
    ff.onclick = function () {

        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");
            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }

    }
    

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }



</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });

    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script>
    
    
    
    
    
    

    
    

    
    
    
    
    
    
    
    

    

</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script><script type="text/javascript" size="150" alpha='0.3' zIndex="-2" src="/js/ribbon.js"></script>
    </body>
</html>
