<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="SpringCloud - https://lovemjh.vercel.app/posts/java-frame/20220526235888/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>SpringCloud</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.ef012369a26adc2a21396230b3395dfcd5975a3082a65b82785cbc0b446f2a2c.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            SpringCloud
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-26&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-26&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            14475 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            29 分钟</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/java-frame/20220526160511/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/java-frame/20220526162071/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一系统架构演变">一、系统架构演变</a>
      <ul>
        <li><a href="#11-集中式架构">1.1 集中式架构</a></li>
        <li><a href="#12-垂直拆分">1.2 垂直拆分</a></li>
        <li><a href="#13-分布式服务">1.3 分布式服务</a></li>
        <li><a href="#14-服务治理soa">1.4 服务治理（SOA）</a></li>
        <li><a href="#15-微服务概述">1.5 微服务概述</a>
          <ul>
            <li><a href="#151-什么是微服务">1.5.1 什么是微服务</a></li>
            <li><a href="#152-微服务与微服务架构">1.5.2 微服务与微服务架构</a></li>
            <li><a href="#153-微服务的优缺点">1.5.3 微服务的优缺点</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#二远程调用方式">二、远程调用方式</a>
      <ul>
        <li><a href="#21调用方式介绍">2.1调用方式介绍</a></li>
        <li><a href="#22--认识rpc">2.2  认识RPC</a></li>
        <li><a href="#23--认识http">2.3  认识http</a></li>
        <li><a href="#24--如何选择">2.4  如何选择</a></li>
      </ul>
    </li>
    <li><a href="#三springcloud入门概述">三、SpringCloud入门概述</a>
      <ul>
        <li><a href="#31springcloud是什么">3.1、SpringCloud是什么？</a></li>
        <li><a href="#32-springcloud和springboot的关系">3.2、 SpringCloud和SpringBoot的关系</a></li>
        <li><a href="#33-springcloud主要框架">3.3、 SpringCloud主要框架</a></li>
      </ul>
    </li>
    <li><a href="#四服务发现组件eureka">四、服务发现组件Eureka</a>
      <ul>
        <li><a href="#41eureka简介">4.1、Eureka简介</a></li>
        <li><a href="#42springcloud父工程创建">4.2、SpringCloud父工程创建</a></li>
        <li><a href="#43eureka服务端开发">4.3、Eureka服务端开发</a></li>
        <li><a href="#44基于eureka入门接口模块">4.4基于Eureka入门接口模块</a></li>
        <li><a href="#45基于eureka入门生产者服务">4.5基于Eureka入门生产者服务</a></li>
        <li><a href="#46基于eureka入门消费者服务">4.6、基于Eureka入门消费者服务‘</a></li>
        <li><a href="#47eureka的服务剔除与保护机制">4.7、Eureka的服务剔除与保护机制</a></li>
      </ul>
    </li>
    <li><a href="#五eureka高可用">五、Eureka高可用</a>
      <ul>
        <li><a href="#51高可用介绍">5.1高可用介绍</a></li>
        <li><a href="#52高可用实现">5.2高可用实现</a></li>
      </ul>
    </li>
    <li><a href="#六服务调用组件">六、服务调用组件</a>
      <ul>
        <li><a href="#61基于loadbalance服务调用">6.1基于LoadBalance服务调用</a>
          <ul>
            <li><a href="#611原理介绍"><strong>6.1.1原理介绍</strong></a></li>
            <li><a href="#612代码实现">6.1.2代码实现</a>
              <ul>
                <li><a href="#6121创建接口模块userinterface">6.1.2.1创建接口模块UserInterface</a></li>
                <li><a href="#6122创建提供者">6.1.2.2创建提供者</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#62基于ribbon的远程调用">6.2基于Ribbon的远程调用</a>
          <ul>
            <li><a href="#621ribbon介绍">6.2.1Ribbon介绍</a></li>
            <li><a href="#622-消费者项目创建">6.2.2 消费者项目创建</a></li>
            <li><a href="#623负载均衡规则配置了解">6.2.3负载均衡规则配置[了解]</a></li>
            <li><a href="#624重试机制了解">6.2.4重试机制[了解]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#一基于feign的远程调用">一、基于Feign的远程调用</a>
      <ul>
        <li><a href="#1feign介绍">1.Feign介绍</a></li>
        <li><a href="#2消费者项目创建">2.消费者项目创建</a>
          <ul>
            <li><a href="#21-创建新模块userweb03">2.1 <strong>创建新模块UserWeb03</strong></a></li>
            <li><a href="#22-修改pomxml引入feign依赖包"><strong>2.2 修改pom.xml引入Feign依赖包</strong></a></li>
            <li><a href="#23-修改应用启动类"><strong>2.3 修改应用启动类</strong></a></li>
            <li><a href="#24-配置文件applicationyml-进行如下修改"><strong>2.4 配置文件application.yml 进行如下修改</strong></a></li>
            <li><a href="#25-在comoffcnservice中添加接口userservice"><strong>2.5 在com.offcn.service中添加接口UserService</strong></a></li>
            <li><a href="#26-删除实现类userserviceimpl以及依赖pomxml移除对接口userinterface的依赖">2.6 <strong>删除实现类UserServiceImpl，以及依赖pom.xml移除对接口UserInterface的依赖</strong></a></li>
            <li><a href="#27-usercontroller直接调用接口userservice">2.7 <strong>UserController直接调用接口UserService</strong></a></li>
            <li><a href="#27-访问userweb03可以看到一样得到访问结果">2.7 <strong>访问UserWeb03可以看到一样得到访问结果</strong></a></li>
          </ul>
        </li>
        <li><a href="#3-开启调用日志">3. 开启调用日志</a>
          <ul>
            <li><a href="#31修改applicationyml设置对应包的日志级别">3.1<strong>修改application.yml设置对应包的日志级别</strong></a></li>
            <li><a href="#32编写配置类定义日志级别">3.2<strong>编写配置类，定义日志级别</strong></a></li>
            <li><a href="#33-修改接口userservice"><strong>3.3 修改接口UserService</strong></a></li>
            <li><a href="#34-重启工程userweb03"><strong>3.4 重启工程UserWeb03</strong></a></li>
            <li><a href="#35设置feign默认超时时间">3.5、设置feign默认超时时间</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#二熔断器组件netflix-hystrix">二、<strong>熔断器组件Netflix Hystrix</strong></a>
      <ul>
        <li><a href="#1-熔断器hystix介绍">1 熔断器Hystix介绍</a></li>
        <li><a href="#2-熔断器hystix的原理和作用">2 熔断器Hystix的原理和作用</a></li>
        <li><a href="#3-ribbon使用hystix">3 Ribbon使用Hystix</a>
          <ul>
            <li><a href="#31-修改项目userweb02引入hystix熔断器"><strong>3.1 修改项目UserWeb02，引入Hystix熔断器</strong></a></li>
            <li><a href="#32修改应用启动类增加注解enablecircuitbreaker允许hystix熔断器生效">3.2<strong>修改应用启动类。增加注解@EnableCircuitBreaker允许Hystix熔断器生效</strong></a></li>
            <li><a href="#33-修改业务实现类userserviceimpl">3.3 <strong>修改业务实现类UserServiceImpl</strong></a></li>
            <li><a href="#34-修改服务提供者userprovdier01userprovdier02">3.4 <strong>修改服务提供者UserProvdier01、UserProvdier02</strong></a></li>
            <li><a href="#35-测试">3.5 <strong>测试</strong></a></li>
          </ul>
        </li>
        <li><a href="#4-优化ribbon使用hystix">4 优化Ribbon使用Hystix</a>
          <ul>
            <li><a href="#41-设定消费者userweb02熔断超时时间">4.1 <strong>设定消费者UserWeb02熔断超时时间</strong></a></li>
            <li><a href="#42-修改服务提供者userprovdier01userprovdier02"><strong>4.2 修改服务提供者UserProvdier01、UserProvdier02</strong></a></li>
            <li><a href="#43-重启相关项目发现重试机制已经生效不会再发生错误">4.3 <strong>重启相关项目，发现重试机制已经生效，不会再发生错误</strong></a></li>
          </ul>
        </li>
        <li><a href="#5-feign使用hystix">5 Feign使用Hystix</a>
          <ul>
            <li><a href="#51修改项目userweb03的applicationyml">5.1<strong>修改项目UserWeb03的application.yml</strong></a></li>
            <li><a href="#52-导入熔断所需依赖包"><strong>5.2 导入熔断所需依赖包</strong></a></li>
            <li><a href="#53-编写feign声明接口userservice的实现类userserviceimpl注意要声明为service"><strong>5.3 编写Feign声明接口UserService的实现类UserServiceImpl（注意要声明为@Service）</strong></a></li>
            <li><a href="#54-在feign调用接口userservice中使用注解feignclient声明熔断调用实现类"><strong>5.4 在Feign调用接口UserService中，使用注解@FeignClient声明熔断调用实现类</strong></a></li>
            <li><a href="#55-重启动项目userweb03"><strong>5.5 重启动项目UserWeb03</strong></a></li>
          </ul>
        </li>
        <li><a href="#6-hystix监控服务器搭建了解">6 Hystix监控服务器搭建【了解】</a>
          <ul>
            <li><a href="#61-新建一个模块hystrix-dashboard编辑pomxml导入所需依赖包">6.1 <strong>新建一个模块hystrix-dashboard，编辑pom.xml导入所需依赖包</strong></a></li>
            <li><a href="#62-为应用主类加上enablehystrixdashboard启用hystrix-dashboard功能"><strong>6.2 为应用主类加上@EnableHystrixDashboard，启用Hystrix Dashboard功能</strong></a></li>
            <li><a href="#63-修改yml文件"><strong>6.3 修改yml文件</strong></a></li>
            <li><a href="#64-启动该应用并访问"><strong>6.4 启动该应用，并访问</strong></a></li>
          </ul>
        </li>
        <li><a href="#7-启动客户端监控">7 启动客户端监控</a>
          <ul>
            <li><a href="#71-修改项目userweb04的pomxml增加hystrix监控所需依赖包">7.1 修改项目UserWeb04的pom.xml增加Hystrix监控所需依赖包</a></li>
            <li><a href="#72-在服务实例的主类中已经使用enablecircuitbreaker或enablehystrix注解开启断路器功能"><strong>7.2 在服务实例的主类中已经使用@EnableCircuitBreaker或@EnableHystrix注解，开启断路器功能。</strong></a></li>
            <li><a href="#73-重启应用访问地址httplocalhost9004hystrixstream"><strong>7.3 重启应用，访问地址:http://localhost:9004/hystrix.stream</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 id="一系统架构演变">一、系统架构演变</h1>
<p>随着互联网的发展，网站应用的规模不断扩大。需求的激增，带来的是技术上的压力。系统架构也因此也不断的演进、升级、迭代。</p>
<p>从单一应用，到垂直拆分，到分布式服务，到SOA，以及现在火热的微服务架构。让我们来看一下它们各自的特点：</p>
<h2 id="11-集中式架构">1.1 集中式架构</h2>
<p>当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。此时，用于简化增删改查工作量的数据访问框架(ORM)是影响项目开发的关键。</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000029248.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>存在的问题：</p>
<p>· 代码耦合，开发维护困难</p>
<p>· 无法针对不同模块进行针对性优化</p>
<p>· 无法水平扩展</p>
<p>· 单点容错率低，并发能力差</p>
<h2 id="12-垂直拆分">1.2 垂直拆分</h2>
<p>当访问量逐渐增大，单一应用无法满足需求，此时为了应对更高的并发和业务需求，我们根据业务功能对系统进行拆分：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000039536.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>优点：</p>
<p>· 系统拆分实现了流量分担，解决了并发问题</p>
<p>· 可以针对不同模块进行优化</p>
<p>· 方便水平扩展，负载均衡，容错率提高</p>
<p>缺点：</p>
<p>· 系统间相互独立，会有很多重复开发工作，影响开发效率</p>
<h2 id="13-分布式服务">1.3 分布式服务</h2>
<p>当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，
使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式调用是关键。</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000053598.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>优点：</p>
<p>· 将基础服务进行了抽取，系统间相互调用，提高了代码复用和开发效率</p>
<p>缺点：</p>
<p>· 系统间耦合度变高，调用关系错综复杂，难以维护</p>
<h2 id="14-服务治理soa">1.4 服务治理（SOA）</h2>
<p>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000102517.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>以前出现了什么问题？</p>
<p>· 服务越来越多，需要管理每个服务的地址</p>
<p>· 调用关系错综复杂，难以理清依赖关系</p>
<p>· 服务过多，服务状态难以管理，无法根据服务情况动态管理</p>
<p>服务治理要做什么？</p>
<p>· 服务注册中心，实现服务自动注册和发现，无需人为记录服务地址</p>
<p>· 服务自动订阅，服务列表自动推送，服务调用透明化，无需关心依赖关系</p>
<p>· 动态监控服务状态监控报告，人为控制服务状态</p>
<p>缺点：</p>
<p>· 服务间会有依赖关系，一旦某个环节出错会影响较大</p>
<p>· 服务关系复杂，运维、测试部署困难，不符合DevOps（开发部署等一体化）思想</p>
<h2 id="15-微服务概述">1.5 微服务概述</h2>
<h3 id="151-什么是微服务">1.5.1 什么是微服务</h3>
<p>目前的微服务并没有一个统一的标准，一般是以业务来划分将传统的一站式应用，拆分成一个个的服务，彻底去耦合，一个微服务就是单功能业务，只做一件事。
<img src="/posts/Java-frame/20220526235888/image-20220527000117710.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="152-微服务与微服务架构">1.5.2 微服务与微服务架构</h3>
<p>微服务是一种架构模式或者一种架构风格，提倡将单一应用程序划分成一组小的服务独立部署，服务之间相互配合、相互协调，每个服务运行于自己的进程中。</p>
<p>服务与服务间采用轻量级通讯，如HTTP的RESTful API等</p>
<p>避免统一的、集中式的服务管理机制</p>
<h3 id="153-微服务的优缺点">1.5.3 微服务的优缺点</h3>
<p><strong>优点</strong></p>
<ul>
<li>每个服务足够内聚，足够小，比较容易聚焦</li>
<li>开发简单且效率高，一个服务只做一件事情</li>
<li>开发团队小，一般2-5人足以（当然按实际为准）</li>
<li>微服务是松耦合的，无论开发还是部署都可以独立完成</li>
<li>微服务能用不同的语言开发</li>
<li>易于和第三方集成，微服务允许容易且灵活的自动集成部署（持续集成工具有Jenkins,Hudson,bamboo等）</li>
<li>微服务易于被开发人员理解，修改和维护，这样可以使小团队更加关注自己的工作成果，而无需一定要通过合作才能体现价值</li>
<li>微服务允许你融合最新的技术</li>
<li>微服务只是业务逻辑的代码，不会和HTML,CSS或其他界面组件融合。</li>
<li>每个微服务都可以有自己的存储能力，数据库可自有也可以统一，十分灵活。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>开发人员要处理分布式系统的复杂性</li>
<li>多服务运维难度，随着服务的增加，运维的压力也会增大</li>
<li>依赖系统部署</li>
<li>服务间通讯的成本</li>
<li>数据的一致性</li>
<li>系统集成测试</li>
<li>性能监控的难度</li>
</ul>
<h1 id="二远程调用方式">二、远程调用方式</h1>
<h2 id="21调用方式介绍">2.1调用方式介绍</h2>
<p>无论是微服务还是SOA，都面临着服务间的远程调用。那么服务间的远程调用方式有哪些呢？</p>
<p>常见的远程调用方式有以下几种：</p>
<ol>
<li>
<p>RPC：Remote Produce Call远程过程调用，类似的还有RMI(Remote Method Invocation，远程方法调用)。自定义数据格式，基于原生TCP通信，速度快，效率高。早期的webservice，现在热门的dubbo，都是RPC的典型</p>
</li>
<li>
<p>Http：http其实是一种网络传输协议，基于TCP，规定了数据传输的格式。现在客户端浏览器与服务端通信基本都是采用Http协议。也可以用来进行远程服务调用。缺点是消息封装臃肿。现在热门的Rest风格，就可以通过http协议来实现。</p>
</li>
</ol>
<h2 id="22--认识rpc">2.2  认识RPC</h2>
<p><strong>概念解释：</strong></p>
<p>RPC，即 Remote Procedure Call（远程过程调用），是一个计算机通信协议。 该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地为这个交互作用编程。</p>
<p>说得通俗一点就是：A计算机提供一个服务，B计算机可以像调用本地服务那样调用A计算机的服务。</p>
<p><strong>作用体现：</strong></p>
<p>通过上面的概念，我们可以知道，实现RPC主要是做到两点：</p>
<ol>
<li>
<p>实现远程调用其他计算机的服务</p>
</li>
<li>
<p>像调用本地服务一样调用远程服务</p>
</li>
</ol>
<p><strong>问题思考：</strong></p>
<p>要实现远程调用，肯定是通过网络传输数据。A程序提供服务，B程序通过网络将请求参数传递给A，A程序接收参数调用本地服务执行后得到结果，再将结果返回给B程序。这里需要关注的有两点：</p>
<p>1）采用何种网络通讯协议？</p>
<p>​	 现在比较流行的RPC框架，都会采用TCP作为底层传输协议</p>
<p>2）数据传输的格式怎样？</p>
<p>​	两个程序进行通讯，必须约定好数据传输格式。就好比两个人聊天，要用同一种语言，否则无法沟通。所以，我们必须定义好请求和响应的格式。另外，数据在网路中传输需要进行序列化，所以还需要约定统一的序列化的方式。</p>
<p>如果仅仅是远程调用，还不算是RPC，因为RPC强调的是过程调用，调用的过程对用户而言是应该是透明的，用户不应该关心调用的细节，可以像调用本地服务一样调用远程服务。</p>
<p>所以RPC一定要对调用的过程进行封装</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000135012.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="23--认识http">2.3  认识http</h2>
<p><strong>概念解释</strong>：</p>
<p>Http协议：超文本传输协议，是一种应用层协议。规定了网络传输的请求格式、响应格式、资源定位和操作的方式等。但是底层采用什么网络传输协议，并没有规定，不过现在都是采用TCP协议作为底层传输协议。说到这里，大家可能觉得，Http与RPC的远程调用非常像，都是按照某种规定好的数据格式进行网络通信，有请求，有响应。没错，在这点来看，两者非常相似，但是还是有一些细微差别。</p>
<p><strong>http和rpc差别：</strong></p>
<ul>
<li>
<p>· RPC并没有规定数据传输格式，这个格式可以任意指定，不同的RPC协议，数据格式不一定相同。</p>
</li>
<li>
<p>· Http中定义了资源定位的路径，RPC中并不需要</p>
</li>
<li>
<p>· 最重要的一点：RPC需要满足像调用本地服务一样调用远程服务，也就是对调用过程在API层面进行封装。Http协议没有这样的要求，因此请求、响应等细节需要我们自己去实现。</p>
</li>
<li>
<p>优点：RPC方式更加透明，对用户更方便。Http方式更灵活，没有规定API和语言，跨语言、跨平台</p>
<p>缺点：RPC方式需要在API层面进行封装，限制了开发的语言环境</p>
</li>
</ul>
<p>例如我们通过浏览器访问网站，就是通过Http协议。只不过浏览器把请求封装，发起请求以及接收响应，解析响应的事情都帮我们做了。如果是不通过浏览器，那么这些事情都需要自己去完成。</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000143493.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="24--如何选择">2.4  如何选择</h2>
<p>既然两种方式都可以实现远程调用，我们该如何选择呢？</p>
<p>· 速度来看，RPC要比http更快，虽然底层都是TCP，但是http协议的信息往往比较臃肿，不过可以采用gzip压缩。</p>
<p>· 难度来看，RPC实现较为复杂，http相对比较简单</p>
<p>· 灵活性来看，http更胜一筹，因为它不关心实现细节，跨平台、跨语言。</p>
<p>因此，两者都有不同的使用场景：</p>
<p>· 如果对效率要求更高，并且开发过程使用统一的技术栈，那么用RPC还是不错的。</p>
<p>· 如果需要更加灵活，跨语言、跨平台，显然http更合适</p>
<p>那么我们该怎么选择呢？</p>
<p><strong>微服务，更加强调的是独立、自治、灵活。而RPC方式的限制较多，因此微服务框架中，一般都会采用基于Http的Rest风格服务。</strong></p>
<h1 id="三springcloud入门概述">三、SpringCloud入门概述</h1>
<p>Spring的三大模块：SpringBoot（构建），Spring Cloud（协调），Spring Cloud Data Flow（连接）</p>
<h2 id="31springcloud是什么">3.1、SpringCloud是什么？</h2>
<p>Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、熔断器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。Spring并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<p>Spring Cloud项目的官方网址：https://spring.io/projects/spring-cloud</p>
<h2 id="32-springcloud和springboot的关系">3.2、 SpringCloud和SpringBoot的关系</h2>
<p>Spring Boot 是 Spring 的一套快速配置脚手架，可以基于Spring Boot 快速开发单个微服务，Spring Cloud是一个基于Spring Boot实现的云应用开发工具；</p>
<p>Spring Boot专注于快速方便开发单个微服务个体，Spring Cloud关注全局的服务治理框架，它将SpringBoot开发的一个个微服务整合并管理起来，为各个服务之间提供 服务发现、负载均衡、断路器、路由、配置管理、微代理，消息总线、全局锁、分布式会话等集成服务；</p>
<p>Spring Boot使用了默认大于配置的理念，很多集成方案已经帮你选择好了，能不配置就不配置，Spring Cloud很大的一部分是基于Spring Boot来实现，可以不基于Spring Boot吗？不可以。</p>
<p>Spring Boot可以离开Spring Cloud独立使用开发项目，但是Spring Cloud离不开Spring Boot，属于依赖的关系。</p>
<h2 id="33-springcloud主要框架">3.3、 SpringCloud主要框架</h2>
<p>服务发现——Netflix Eureka</p>
<p>服务调用——Netflix Feign</p>
<p>熔断器——Netflix Hystrix</p>
<p>服务网关——Netflix Zuul</p>
<p>分布式配置——Spring Cloud Config</p>
<p>消息总线 —— Spring Cloud Bus</p>
<h1 id="四服务发现组件eureka">四、服务发现组件Eureka</h1>
<h2 id="41eureka简介">4.1、Eureka简介</h2>
<p>Eureka 是Spring Cloud Netflix 微服务套件中的一部分， 它基于Netflix Eureka 做了二次封装， 主要负责完成微服务架构中的服务治理功能。我们只需通过简单引入依赖和注解配置就能让Spring Boot 构建的微服务应用轻松地与Eureka 服务治理体系进行整合。</p>
<p>Eureka包含两个组件：Eureka Server和Eureka Client。</p>
<p>Eureka Server提供服务注册服务。</p>
<p>Eureka Client是一个java客户端，用来简化与Eureka Server的交互、客户端同时也就是一个内置的、使用轮询(round-robin)负载算法的负载均衡器。
<img src="/posts/Java-frame/20220526235888/image-20220527000158173.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="42springcloud父工程创建">4.2、SpringCloud父工程创建</h2>
<p><strong>1.创建父工程</strong> springboot项目hello-parent</p>
<p><strong>2.修改父工程配置文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;project</span> <span style="color:#008080">xmlns=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#008080">xmlns:xsi=</span><span style="color:#d14">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#008080">xsi:schemaLocation=</span><span style="color:#d14">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#000080">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;modelVersion&gt;</span>4.0.0<span style="color:#000080">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>2.3.8.RELEASE<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;relativePath/&gt;</span> <span style="color:#998;font-style:italic">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>hello-parent<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;name&gt;</span>hello-parent<span style="color:#000080">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;packaging&gt;</span>pom<span style="color:#000080">&lt;/packaging&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;java.version&gt;</span>1.8<span style="color:#000080">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;version&gt;</span>Hoxton.RELEASE<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;type&gt;</span>pom<span style="color:#000080">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;scope&gt;</span>import<span style="color:#000080">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/project&gt;</span>
</span></span></code></pre></div><p><strong>3.删除其余文件</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000209127.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>只留下 iml文件 和 父工程的pom文件即可 其余的没有用 包括src</p>
<h2 id="43eureka服务端开发">4.3、Eureka服务端开发</h2>
<p><strong>1.创建EurekaServer01模块</strong>（Maven工程即可）</p>
<p><strong>2.导入pom文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>			
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>3.编写配置文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#内置的tomcat服务启动监听端口号</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8888</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#应用名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>EurekaServer01<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#EurekaServer配置</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">instance</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">hostname</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#关闭自我保护模式（缺省为打开）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enable-self-preservation</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#扫描失效服务的间隔时间（缺省为60*1000ms）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">eviction-interval-timer-in-ms</span>:<span style="color:#bbb"> </span><span style="color:#099">1000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">register-with-eureka</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#此EurekaServer不在注册到其他的注册中心</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">fetch-registry</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">       </span><span style="color:#998;font-style:italic">#不在从其他中心中心拉取服务器信息</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://${eureka.instance.hostname}:${server.port}/eureka<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#注册中心访问地址</span><span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>4.编写启动类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaServer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">EurekaServer01Start</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>EurekaServer01Start<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>5.启动测试结果</strong></p>
<p>然后在浏览器地址栏输入 http://localhost:8888/ 运行效果如下：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000220180.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>主界面中system status为系统信息 General Info为一般信息 Instances currently</p>
<p>registered with Eureka为注册到注册中心的所有微服务列表</p>
<h2 id="44基于eureka入门接口模块">4.4基于Eureka入门接口模块</h2>
<p><strong>1.创建HelloInterface01模块</strong></p>
<p><strong>2.编写接口</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">HelloService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">sayHello</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3.安装到本地仓库</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000229087.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>注意：</strong></p>
<p>hello-parent父工程的pom.xml不需要声明springboot的maven编译插件，这样就可以避免把所有继承父工程的项目打包成springboot的jar包。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!-- 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;build&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        &lt;plugins&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">            &lt;plugin&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">            &lt;/plugin&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        &lt;/plugins&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;/build&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">--&gt;</span>
</span></span></code></pre></div><h2 id="45基于eureka入门生产者服务">4.5基于Eureka入门生产者服务</h2>
<p><strong>1.创建HelloProvider01模块</strong></p>
<p><strong>2.编写pom文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>HelloInterface01<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>3.编写yml文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>HelloProvider01<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:8888/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>4.编写接口的实现类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.service.impl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.HelloService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HelloServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> HelloService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">sayHello</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;hello Eureka!&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>5.编写HelloController实现类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.controller</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.HelloService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.GetMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RestController</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HelloController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">private</span> HelloService helloService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">sayHello</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> helloService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sayHello</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>6.编写启动类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.SpringApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.autoconfigure.SpringBootApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HelloProvider01Start</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>HelloProvider01Start<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>7.启动服务</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000242665.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>查看Eureka管理控制台，可以看到服务已经注册上去！
<img src="/posts/Java-frame/20220526235888/image-20220527000250318.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="46基于eureka入门消费者服务">4.6、基于Eureka入门消费者服务‘</h2>
<p><strong>1.创建HelloConsumer01模块</strong></p>
<p><strong>2.导入pom依赖</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>HelloInterface01<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>3.yml配置文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>helloConsumer01<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9002</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:8888/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>4.编写启动类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HelloConsumer01Start</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>HelloConsumer01Start<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>5.编写配置类（也可以在启动类中进行配置）实例化远程调用模板类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> RestTemplate <span style="color:#900;font-weight:bold">restTemplate</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestTemplate<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>6.编写实现类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.service.impl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.HelloService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.client.ServiceInstance</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.client.discovery.DiscoveryClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.http.HttpStatus</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.http.ResponseEntity</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.client.RestTemplate</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.List</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HelloServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> HelloService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> DiscoveryClient discoveryClient<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">//是一个服务查询工具，可以连接到EurekaServer，根据服务名称去查询服务信息，注意别导错包了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RestTemplate restTemplate<span style="color:#000;font-weight:bold">;</span>  <span style="color:#998;font-style:italic">//调用rest风格接口工具类
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//从EurekaServer获取对应服务的地址和端口
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">getServerInfo</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>ServiceInstance<span style="color:#000;font-weight:bold">&gt;</span> instanceList <span style="color:#000;font-weight:bold">=</span> discoveryClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstances</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;HELLOPROVIDER01&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>instanceList<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>instanceList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()&gt;</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            ServiceInstance serviceInstance <span style="color:#000;font-weight:bold">=</span> instanceList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//获取对应服务的主机地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String host <span style="color:#000;font-weight:bold">=</span> serviceInstance<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHost</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//获取对应服务端口号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#458;font-weight:bold">int</span> port <span style="color:#000;font-weight:bold">=</span> serviceInstance<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPort</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;http://&#34;</span><span style="color:#000;font-weight:bold">+</span>host<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;:&#34;</span><span style="color:#000;font-weight:bold">+</span>port<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">sayHello</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        ResponseEntity<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> responseEntity <span style="color:#000;font-weight:bold">=</span> restTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getForEntity</span><span style="color:#000;font-weight:bold">(</span>getServerInfo<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/hello&#34;</span><span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        String body <span style="color:#000;font-weight:bold">=</span> responseEntity<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBody</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;调用远程服务返回值:&#34;</span><span style="color:#000;font-weight:bold">+</span>body<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> body<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>7.controller调用代码</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.controller</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.HelloService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RequestMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RestController</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HelloControllerConsumer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> HelloService helloService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/testHello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">sayHello</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> helloService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sayHello</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>8.启动服务</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000305472.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>9.测试访问</strong></p>
<p><a class="link" href="/posts/Java-frame/http://localhost:9002/testHello"  target="_blank" rel="noopener"
    >http://localhost:9002/testHello</a></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000313519.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="47eureka的服务剔除与保护机制">4.7、Eureka的服务剔除与保护机制</h2>
<p><strong>1.服务剔除</strong></p>
<p>注册到eureka的服务可能由于内存溢出或网络故障等原因使得服务不能正常的工作，而服务注册中心并未收到“服务下线”的请求。服务注册中心在启动时会创建一个定时任务，默认每隔一段时间（默认为60秒）将当前清单中超时（默认为90秒）没有续约的服务剔除，这个操作被称为失效剔除。</p>
<p><strong>2.服务保护</strong></p>
<p>我们关停一个服务，很可能会在Eureka面板看到一条警告：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000321992.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这是触发了Eureka的自我保护机制。当服务未按时进行心跳续约时，Eureka会统计服务实例最近15分钟心跳续约的比例是否低于了85%。</p>
<p>在生产环境下，因为网络延迟等原因，心跳失败实例的比例很有可能超标，但是此时就把服务剔除列表并不妥当，因为服务可能没有宕机。</p>
<p>Eureka在这段时间内不会剔除任何服务实例，直到网络恢复正常。生产环境下这很有效，保证了大多数服务依然可用，不过也有可能获取到失败的服务实例，因此服务调用者必须做好服
务的失败容错。</p>
<p>可以通过下面的配置来关停自我保护：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000328575.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="五eureka高可用">五、Eureka高可用</h1>
<h2 id="51高可用介绍">5.1高可用介绍</h2>
<p>EurekaServer可以是一个集群，形成高可用的Eureka注册中心</p>
<p>多个Eureka Server之间也会互相注册为服务，当服务提供者注册到Eureka Server集群中的某个节点时，该节点会把服务的信息同步给集群中的每个节点，从而实现数据同步。</p>
<p>因此，无论客户端访问到Eureka Server集群中的哪一个节点，都可以获取到完整的服务列表信息。</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000335415.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="52高可用实现">5.2高可用实现</h2>
<p><strong>1.创建第二个eureka2</strong></p>
<p><strong>2.修改eureka1的yml文件配置</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#内置的tomcat服务启动监听端口号</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">10086</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#应用名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>EurekaServer<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#EurekaServer配置</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">instance</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">hostname</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#关闭自我保护模式（缺省为打开）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enable-self-preservation</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#扫描失效服务的间隔时间（缺省为60*1000ms）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">eviction-interval-timer-in-ms</span>:<span style="color:#bbb"> </span><span style="color:#099">1000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">register-with-eureka</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#需要设置为true允许去其他eurekaserver注册</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">fetch-registry</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">       </span><span style="color:#998;font-style:italic">#允许从其他中心中心拉取服务器信息</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://${eureka.instance.hostname}:10087/eureka<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#注册中心访问地址,指向另外一台eurekaserver</span><span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>3.编写eureka2的yml文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#内置的tomcat服务启动监听端口号</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">10087</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#应用名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>EurekaServer<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#EurekaServer配置</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">instance</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">hostname</span>:<span style="color:#bbb"> </span>localhost<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#关闭自我保护模式（缺省为打开）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enable-self-preservation</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#扫描失效服务的间隔时间（缺省为60*1000ms）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">eviction-interval-timer-in-ms</span>:<span style="color:#bbb"> </span><span style="color:#099">1000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">register-with-eureka</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#此EurekaServer不在注册到其他的注册中心</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">fetch-registry</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">       </span><span style="color:#998;font-style:italic">#不在从其他中心中心拉取服务器信息</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://${eureka.instance.hostname}:10086/eureka<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#注册中心访问地址,指向另外一台eurekaserver</span><span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>4.启动两个eureka</strong></p>
<p>启动项目EurekaServer1、EurekaServer2</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000344936.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000353106.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>5.修改提供者和消费者的注册中心地址</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#配置EurekaServer注册中心服务器地址</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:10086/eureka,http://localhost:10087/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><p>此时配置文件同时指向两个配置中心</p>
<p><strong>6.启动测试</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000400555.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="六服务调用组件">六、服务调用组件</h1>
<p>在上节课，我们启动了一个服务作为生产者，通过DiscoveryClient来获取服务实例信息，然后获取ip和端口来访问。但是实际环境中，我们往往会开启很多个服务的集群。此时我们获取的服务列表中就会有多个，到底该访问哪一个呢？</p>
<p>一般这种情况下我们就需要编写负载均衡算法，在多个实例列表中进行选择。</p>
<p>不过SpringColud中已经帮我们集成了一系列负载均衡组件：LoadBalancerClient、Ribbon、Feign，简单修改代码即可使用。</p>
<h2 id="61基于loadbalance服务调用">6.1基于LoadBalance服务调用</h2>
<h3 id="611原理介绍"><strong>6.1.1原理介绍</strong></h3>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000409562.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="612代码实现">6.1.2代码实现</h3>
<h4 id="6121创建接口模块userinterface">6.1.2.1创建接口模块UserInterface</h4>
<p><strong>1.创建实体类com.offcn.pojo.User  提供属性 id、name、age等属性，提供getset  全参和空参构造器、toString方法等</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.pojo</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.Serializable</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">User</span> <span style="color:#000;font-weight:bold">implements</span> Serializable <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Long id<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String username<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Integer age<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//省略getset方法  空参数 全参数构造器  以及toString方法
</span></span></span></code></pre></div><p><strong>3.创建接口com.offcn.service.UserService,提供方法<code>List&lt;User&gt;findAll()</code>;</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pojo.User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.List</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">UserService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>     Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>4.安装模块到本地仓库</strong></p>
<h4 id="6122创建提供者">6.1.2.2创建提供者</h4>
<p><strong>1.创建两个提供者模块测试负载均衡</strong></p>
<p>创建新模块UserProvider01、  UserProvider02 参考模块HelloProvider01，引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>UserInterface<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>2.修改两个模块的yml文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>UserProvider<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:10086/eureka,http://localhost:10087/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>UserProvider<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">8002</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:10086/eureka,http://localhost:10087/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>3.创建接口的实现类实现接口方法</strong>（两个模块一样）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.service.impl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pojo.User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.UserService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Service</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.ArrayList</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.List</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> list<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>1L<span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;zhangsan1&#34;</span><span style="color:#000;font-weight:bold">,</span>21<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>2L<span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;zhangsan2&#34;</span><span style="color:#000;font-weight:bold">,</span>22<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>3L<span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;zhangsan3&#34;</span><span style="color:#000;font-weight:bold">,</span>23<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span>list<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>4.修改两个controller方法</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.controller</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pojo.User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.UserService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.GetMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RestController</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.List</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserService userService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取全部用户数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span>userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;UserProvider01&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.controller</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.pojo.User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.UserService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.GetMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.RestController</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.List</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserService userService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//获取全部用户数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span>userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;UserProvider02&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><font color="red">为了区分访问的具体微服务，存储version字段作为区别</font></p>
<p><strong>5.编写启动类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.SpringApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.autoconfigure.SpringBootApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserProvider01Start</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>UserProvider01Start<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.SpringApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.autoconfigure.SpringBootApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserProvider02Start</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>UserProvider02Start<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>5.启动两个工程查看注册中心</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000446648.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>1.新建模块UserWeb(参考HelloConsumer01)</strong>，引入依赖如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>UserInterface<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>2.编写yml文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9001</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">thymeleaf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">prefix</span>:<span style="color:#bbb"> </span>classpath:/templates/  <span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#在构建URL时预先查看名称的前缀</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">suffix</span>:<span style="color:#bbb"> </span>.html  <span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#构建URL时附加到查看名称的后缀</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">cache</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>UserWeb<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:10086/eureka,http://localhost:10087/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>3.远程调用业务类代码</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//远程服务调用客户端
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>	RestTemplate restTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//支持负载均衡的调用客户端
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>	LoadBalancerClient loadBalancerClient<span style="color:#000;font-weight:bold">;</span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">	 * 通过客户端负载均衡器获取生产者服务器基础地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">	 * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">getServerUrl</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>		
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//通过客户端调用服务均衡器查找服务
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		ServiceInstance inst <span style="color:#000;font-weight:bold">=</span> loadBalancerClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">choose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;USERPROVIDER&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//获取服务提供者服务器ip、端口号
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		String ip <span style="color:#000;font-weight:bold">=</span> inst<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHost</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#458;font-weight:bold">int</span> port <span style="color:#000;font-weight:bold">=</span> inst<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPort</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//拼接调用地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		String url<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;http://&#34;</span><span style="color:#000;font-weight:bold">+</span>ip<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;:&#34;</span><span style="color:#000;font-weight:bold">+</span>port<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> url<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String url<span style="color:#000;font-weight:bold">=</span>getServerUrl<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> restTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getForObject</span><span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/user/&#34;</span><span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意：LoadBalancerClient 具备负载均衡功能，可以根据服务名从多个实例中选择一个实例</p>
<p><strong>4.controller代码</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.controller</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.offcn.service.UserService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.stereotype.Controller</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.ui.Model</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.bind.annotation.GetMapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserService userService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//查询全部用户数据，显示列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">(</span>Model model<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;page&#34;</span><span style="color:#000;font-weight:bold">,</span>map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;list&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//获取服务提供者信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        model<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span>map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version:&#34;</span><span style="color:#000;font-weight:bold">+</span>map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;user/list&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>4.创建list.html页面代码</strong></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000506323.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span> <span style="color:#008080">lang</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;en&#34;</span> <span style="color:#008080">xmlns:th</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;http://www.thymeleaf.org&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">meta</span> <span style="color:#008080">charset</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">title</span>&gt;Title&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">h1</span> <span style="color:#008080">th:text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;${version}&#34;</span>&gt;&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">table</span> <span style="color:#008080">width</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;200&#34;</span> <span style="color:#008080">style</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;text-align: center;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">tr</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">th</span>&gt;编号&lt;/<span style="color:#000080">th</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">th</span>&gt;姓名&lt;/<span style="color:#000080">th</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">th</span>&gt;年龄&lt;/<span style="color:#000080">th</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">th</span>&gt;index&lt;/<span style="color:#000080">th</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#000080">tr</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">tr</span> <span style="color:#008080">th:each</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34; user,iterStat : ${page}&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">td</span> <span style="color:#008080">th:text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;${user.id}&#34;</span>&gt;&lt;/<span style="color:#000080">td</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">td</span> <span style="color:#008080">th:text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;${user.username}&#34;</span>&gt;&lt;/<span style="color:#000080">td</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">td</span> <span style="color:#008080">th:text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;${user.age}&#34;</span>&gt;&lt;/<span style="color:#000080">td</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">td</span> <span style="color:#008080">th:text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;${iterStat.index}&#34;</span>&gt;index&lt;/<span style="color:#000080">td</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#000080">tr</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">table</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><p><strong>5.编写主启动类</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.SpringApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.boot.autoconfigure.SpringBootApplication</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.context.annotation.Bean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.web.client.RestTemplate</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserWebApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>UserWebApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> RestTemplate <span style="color:#900;font-weight:bold">restTemplate</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestTemplate<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>6.测试效果</strong></p>
<p>顺序启动项目EurekaServer01、EurekaServer02、UserProvdier01、UserProvdier02、UserWeb</p>
<p>访问Eureka管理控制台界面，可以看到各个服务以及注册成功</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000518209.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>访问消费者工程UserWeb02地址：http://localhost:9001</p>
<p>多次刷新后可以看见 控制台在 provider1和provider2之间切换</p>
<p><img src="/posts/Java-frame/20220526235888/20210128172630.gif"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="62基于ribbon的远程调用">6.2基于Ribbon的远程调用</h2>
<h3 id="621ribbon介绍">6.2.1Ribbon介绍</h3>
<p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端负载均衡的工具。它是一个基于HTTP和TCP的客户端负载均衡器。</p>
<p>下面我们带领大家使用Ribbon来实现客户端服务调用。</p>
<h3 id="622-消费者项目创建">6.2.2 消费者项目创建</h3>
<p><strong>1、创建新模块UserWeb02</strong></p>
<p>​	复制工程UserWeb的内容到UserWeb02</p>
<p><strong>2、修改pom.xml引入Ribbon依赖包</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-ribbon<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>3.修改UserWeb02工程中配置文件application.yml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#服务器端口号</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9002</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">thymeleaf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">prefix</span>:<span style="color:#bbb"> </span>classpath:/templates/  <span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#在构建URL时预先查看名称的前缀</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">suffix</span>:<span style="color:#bbb"> </span>.html  <span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#构建URL时附加到查看名称的后缀</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">cache</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>UserWeb02<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>4.修改项目启动类AppStartApplication</strong>
<img src="/posts/Java-frame/20220526235888/image-20220527000538799.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>在RestTemplate定义上增加注解@LoadBalanced，即可开启Ribbon</p>
<p><strong>5.修改类UserServiceImpl</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RestTemplate restTemplate<span style="color:#000;font-weight:bold">;</span>   <span style="color:#998;font-style:italic">//rest接口调用工具
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//编写查询服务方法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">getServerUrl</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;http://USERPROVIDER&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String url<span style="color:#000;font-weight:bold">=</span>getServerUrl<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> restTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getForObject</span><span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/user/&#34;</span><span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>6.测试效果</strong></p>
<p>访问消费者工程UserWeb02地址：http://localhost:9002</p>
<p>可以看到不停刷新页面，显示的用户服务信息发生变化，在2个生产者服务之间来回切换。
<img src="/posts/Java-frame/20220526235888/20210128172631.gif"
    
    
    
    loading="lazy"
    
    
>
后台打印：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000600305.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="623负载均衡规则配置了解">6.2.3负载均衡规则配置[了解]</h3>
<p><strong>1.规则分类</strong></p>
<p>默认情况下Ribbon的负载均衡策略是轮询，Ribbon常用的负载均衡规则：</p>
<p>1、简单轮询策略（RoundRobinRule）</p>
<p>​     以轮询的方式依次将请求调度不同的服务器</p>
<p>2、随机策略 （RandomRule）</p>
<p>​     随机选择状态为UP的Server</p>
<p>3、加权响应时间策略 （WeightedResponseTimeRule）</p>
<p>​     根据响应时间分配一个weight，响应时间越长，weight越小，被选中的可能性越低。</p>
<p>4、区域权重策略（ZoneAwareRule）</p>
<p>​     综合判断server所在区域的性能和server的可用性选择server</p>
<p>5、最低并发策略(BestAvailableRule)</p>
<p>​    逐个查看server，选择一个并发连接最低的server</p>
<p>6、重试策略(RetryRule)</p>
<p>​     对选定的负载均衡策略机上重试机制</p>
<p>7、可用过滤策略(AvailabilityFilteringRule)</p>
<p>​    过滤掉一直失败并被标记为circuit tripped的server</p>
<p>8、ResponseTimeWeightedRule</p>
<p>​    已废弃，作用同WeightedResponseTimeRule</p>
<p><strong>2.规则配置</strong></p>
<p><strong>yml文件配置指定服务的负载均衡策略</strong></p>
<p>#     com.netflix.loadbalancer.RandomRule #配置规则 随机</p>
<p>#    com.netflix.loadbalancer.RoundRobinRule #配置规则 轮询</p>
<p>#    com.netflix.loadbalancer.RetryRule #配置规则 重试</p>
<p>#    com.netflix.loadbalancer.WeightedResponseTimeRule #配置规则 响应时间权重</p>
<p>#    com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略</p>
<p>针对每个服务来在消费端如UserWeb02的application.yml中配置负载均衡规则</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">USERPROVIDER</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#服务名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ribbon</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">NFLoadBalancerRuleClassName</span>:<span style="color:#bbb"> </span>com.netflix.loadbalancer.RandomRule<span style="color:#bbb">
</span></span></span></code></pre></div><p><img src="/posts/Java-frame/20220526235888/image-20220527000612603.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="624重试机制了解">6.2.4重试机制[了解]</h3>
<p><strong>1.重试机制理解</strong></p>
<p>当我们选择轮询负载均衡策略的时候，如果一个服务停掉，因为服务剔除的延迟，消费者并不会立即得到最新的服务列表，此时再次访问你会得到错误提示：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527000621118.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>Spring Cloud 整合了Spring Retry 来增强RestTemplate的重试能力，当一次服务调用失败后，不会立即抛出一次，而是再次重试另一个服务。</p>
<p><strong>2.重试机制实现</strong></p>
<p>1.修改配置文件application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic">#开启Spring Cloud的重试功能</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">cloud</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">loadbalancer</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">retry</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">USERPROVIDER</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ribbon</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#配置指定服务的负载均衡策略</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">NFLoadBalancerRuleClassName</span>:<span style="color:#bbb"> </span>com.netflix.loadbalancer.RoundRobinRule<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 是否对所有操作都进行重试,默认支持读造作，不支持写操作</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#(写操作要保证接口 幂等性：防止多次操作造成数异常)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">OkToRetryOnAllOperations</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ConnectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">250</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># Ribbon的连接超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ReadTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">1000</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># Ribbon的数据读取超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 切换实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetriesNextServer</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 对当前实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetries</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>注意：使用重试，要设置负载均衡策略为轮询com.netflix.loadbalancer.RoundRobinRule</p>
<p>2.修改pom文件引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.retry<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000080">&lt;artifactId&gt;</span>spring-retry<span style="color:#000080">&lt;/artifactId&gt;</span>          
</span></span><span style="display:flex;"><span> <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>4.测试效果</p>
<p>重启项目UserWeb02，</p>
<p>访问地址：<a class="link" href="/posts/Java-frame/http://127.0.0.1:9002/"  target="_blank" rel="noopener"
    >http://127.0.0.1:9002/</a></p>
<p>不断刷新页面，可以看到用户服务显示内容在变化，负载均衡效果已经生效，到此ribbon消费者成功</p>
<p>如图：</p>
<p><img src="/posts/Java-frame/20220526235888/20210128172631%201.gif"
    
    
    
    loading="lazy"
    
    
></p>
<p>关闭生产者项目ProviderService002</p>
<p>再次访问<a class="link" href="/posts/Java-frame/http://127.0.0.1:9002/"  target="_blank" rel="noopener"
    >http://127.0.0.1:9002/</a></p>
<p>重试机制生效不会再产生刚才的调用错误。</p>
<p>注意：重试过于频繁后台也会出现异常，但是页面不会再次出现错误。</p>
<h1 id="一基于feign的远程调用">一、基于Feign的远程调用</h1>
<h2 id="1feign介绍">1.Feign介绍</h2>
<p>Feign是一个声明式的web服务客户端，它使编写web服务客户端变得更加容易。创建一个接口并添加一个Fegin的注解@FeignClient，就可以通过该接口调用生产者提供的服务。Spring Cloud对Feign进行了增强，使得Feign支持了Spring MVC注解</p>
<p>两点：1、Feign采用的是接口加注解的声明式服务调用;</p>
<p>​            2、Fegin整合Ribbon及Eureka，支持负载均衡</p>
<p>接下带领大家创建一个消费者项目，体验Feign的使用方式。</p>
<h2 id="2消费者项目创建">2.消费者项目创建</h2>
<h3 id="21-创建新模块userweb03">2.1 <strong>创建新模块UserWeb03</strong></h3>
<p>复制工程UserWeb02的内容到UserWeb03</p>
<h3 id="22-修改pomxml引入feign依赖包"><strong>2.2 修改pom.xml引入Feign依赖包</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="23-修改应用启动类"><strong>2.3 修改应用启动类</strong></h3>
<p><strong>增加注解@EnableFeignClients</strong>
<img src="/posts/Java-frame/20220526235888/image-20220527214753544.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="24-配置文件applicationyml-进行如下修改"><strong>2.4 配置文件application.yml 进行如下修改</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">9003</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">thymeleaf</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">cache</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>UserWeb03<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">eureka</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">client</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">service-url</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">defaultZone</span>:<span style="color:#bbb"> </span>http://localhost:10086/eureka,http://localhost:10087/eureka<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="25-在comoffcnservice中添加接口userservice"><strong>2.5 在com.offcn.service中添加接口UserService</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;USERPROVIDER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">UserService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//查询全部
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/user/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="26-删除实现类userserviceimpl以及依赖pomxml移除对接口userinterface的依赖">2.6 <strong>删除实现类UserServiceImpl，以及依赖pom.xml移除对接口UserInterface的依赖</strong></h3>
<h3 id="27-usercontroller直接调用接口userservice">2.7 <strong>UserController直接调用接口UserService</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>	UserService userService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="27-访问userweb03可以看到一样得到访问结果">2.7 <strong>访问UserWeb03可以看到一样得到访问结果</strong></h3>
<p>访问http://localhost:9003/</p>
<h2 id="3-开启调用日志">3. 开启调用日志</h2>
<p>@FeignClient注解修改的客户端在被代理时，都会创建一个新的Fegin.Logger实例。我们需要额外指定这个日志的级别才可以。</p>
<h3 id="31修改applicationyml设置对应包的日志级别">3.1<strong>修改application.yml设置对应包的日志级别</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#设置消费者指定包日志级别</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">logging</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">level</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">com.offcn </span>:<span style="color:#bbb"> </span>debug<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="32编写配置类定义日志级别">3.2<strong>编写配置类，定义日志级别</strong></h3>
<p>这里指定的Level级别是FULL，Feign支持4种级别：</p>
<p>NONE：不记录任何日志信息，这是默认值。</p>
<p>BASIC：仅记录请求的方法，URL以及响应状态码和执行时间</p>
<p>HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息</p>
<p>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。</p>
<p>创建类FeignConfig ，配置Feign日志级别定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.config</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.context.annotation.Bean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.context.annotation.Configuration</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">feign.Logger</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">FeignConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">public</span> Logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Level</span> <span style="color:#900;font-weight:bold">getFeignlogger</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> Logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Level</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">FULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="33-修改接口userservice"><strong>3.3 修改接口UserService</strong></h3>
<p>修改注解：@FeignClient，指定Feign日志配置文件</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527214844763.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="34-重启工程userweb03"><strong>3.4 重启工程UserWeb03</strong></h3>
<p>访问地址http://localhost:9003/</p>
<p>查看控制台即可看到Feign调用日志：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527214854549.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="35设置feign默认超时时间">3.5、设置feign默认超时时间</h3>
<pre tabindex="0"><code>feign:
  client:
    config:
      default:
        connectTimeout: 10000 #连接超时配置
        readTimeout: 60000 #执行超时配置
</code></pre><h1 id="二熔断器组件netflix-hystrix">二、<strong>熔断器组件Netflix Hystrix</strong></h1>
<h2 id="1-熔断器hystix介绍">1 熔断器Hystix介绍</h2>
<p>Hystix是Netflix的针对微服务分布式系统的熔断保护中间件，一个有关延迟和失败容错的开源库包，用于隔离访问远程服务、第三方库，防止出现级联失败。</p>
<p>Hystix是Netflix的针对微服务分布式系统的熔断保护中间件，是一个有关延迟和失败容错的开源库包，用来设计隔离访问远程服务、第三方库等，防止出现级联式失败。</p>
<p>主页：<a class="link" href="/posts/Java-frame/https://github.com/Netflix/Hystrix/"  target="_blank" rel="noopener"
    >https://github.com/Netflix/Hystrix/</a></p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527214913588.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="2-熔断器hystix的原理和作用">2 熔断器Hystix的原理和作用</h2>
<p>熔断器机制的原理很简单，像家里的电路保险丝，如果电路发生短路能立刻熔断电路，避免发生灾难。</p>
<p>在分布式系统中应用这一模式之后，服务调用方可以自己进行判断某些服务反应慢或者存在大量超时的情况时，能够主动熔断，防止整体系统被拖垮。</p>
<p>不同于电路熔断只能断不能自动重连，Hystrix可以实现弹性容错，当情况好转之后，可以自动重连。</p>
<p>正常工作的情况下，客户端请求调用服务API接口：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527214921469.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>当有服务出现异常时，直接进行失败回滚，服务降级处理：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527214929006.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="3-ribbon使用hystix">3 Ribbon使用Hystix</h2>
<h3 id="31-修改项目userweb02引入hystix熔断器"><strong>3.1 修改项目UserWeb02，引入Hystix熔断器</strong></h3>
<p>pom.xml增加Hystix依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="32修改应用启动类增加注解enablecircuitbreaker允许hystix熔断器生效">3.2<strong>修改应用启动类。增加注解@EnableCircuitBreaker允许Hystix熔断器生效</strong></h3>
<p><img src="/posts/Java-frame/20220526235888/image-20220527214941255.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="33-修改业务实现类userserviceimpl">3.3 <strong>修改业务实现类UserServiceImpl</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@HystrixCommand</span><span style="color:#000;font-weight:bold">(</span>fallbackMethod <span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;findAllCallBack&#34;</span> <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    String url<span style="color:#000;font-weight:bold">=</span>getServerUrl<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> restTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getForObject</span><span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/user/&#34;</span><span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//熔断触发后，回调方法
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAllCallBack</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;熔断被触发，远程调用失败&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>@HystrixCommand(fallbackMethod=&ldquo;findAllCallBack&rdquo;)：</p>
<p>声明一个失败回滚处理函数<strong>findAllCallBack</strong>，当findAll执行超时（默认是1000毫秒），就会执行<strong>findAllCallBack</strong>函数，返回错误提示。</p>
<p>为了方便查看熔断的触发时机，我们记录请求访问时间。</p>
<h3 id="34-修改服务提供者userprovdier01userprovdier02">3.4 <strong>修改服务提供者UserProvdier01、UserProvdier02</strong></h3>
<p>让服务随机休眠一段时间，以触发熔断</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//获取全部用户数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span>userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;UserProvider01&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//随机睡 0-1500毫秒
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Random<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">nextInt</span><span style="color:#000;font-weight:bold">(</span>1500<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="35-测试">3.5 <strong>测试</strong></h3>
<p>启动应用，访问地址：<a class="link" href="/posts/Java-frame/http://localhost:9002/"  target="_blank" rel="noopener"
    >http://localhost:9002/</a></p>
<p>可以看到当请求时间超过1000毫秒是发生熔断
<img src="/posts/Java-frame/20220526235888/image-20220527215004934.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-优化ribbon使用hystix">4 优化Ribbon使用Hystix</h2>
<p>虽然熔断实现了，但是我们的重试机制似乎没有生效，是这样吗？</p>
<p>其实这里是因为我们的Ribbon超时时间设置的是1000ms
<img src="/posts/Java-frame/20220526235888/image-20220527215018006.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">USERPROVIDER</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#服务名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ribbon</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#配置指定服务的负载均衡策略</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">NFLoadBalancerRuleClassName</span>:<span style="color:#bbb"> </span>com.netflix.loadbalancer.RoundRobinRule<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbon的连接超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ConnectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">250</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbon的数据读取超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ReadTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">1000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 是否对所有操作都进行重试</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">OkToRetryOnAllOperations</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 切换实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetriesNextServer</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 对当前实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetries</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>而Hystix的超时时间默认也是1000ms，因此重试机制没有被触发，而是先触发了熔断。</p>
<p>注意，针对RestTemplate发起调用设置超时时间</p>
<p>所以，RestTemplate、Ribbon的超时时间一定要小于Hystix的超时时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@LoadBalanced</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> RestTemplate <span style="color:#900;font-weight:bold">restTemplate</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        HttpComponentsClientHttpRequestFactory factory <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpComponentsClientHttpRequestFactory<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setReadTimeout</span><span style="color:#000;font-weight:bold">(</span>250<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setConnectTimeout</span><span style="color:#000;font-weight:bold">(</span>250<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestTemplate<span style="color:#000;font-weight:bold">(</span>factory<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="41-设定消费者userweb02熔断超时时间">4.1 <strong>设定消费者UserWeb02熔断超时时间</strong></h3>
<p>修改application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#设定Hystrix熔断超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">execution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">isolation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">thread</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">timeoutInMilliseconds</span>:<span style="color:#bbb"> </span><span style="color:#099">6000</span><span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="42-修改服务提供者userprovdier01userprovdier02"><strong>4.2 修改服务提供者UserProvdier01、UserProvdier02</strong></h3>
<p>让服务随机休眠一段时间（1-6000毫秒）
<img src="/posts/Java-frame/20220526235888/image-20220527215033918.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="43-重启相关项目发现重试机制已经生效不会再发生错误">4.3 <strong>重启相关项目，发现重试机制已经生效，不会再发生错误</strong></h3>
<p>重试已经生效</p>
<h2 id="5-feign使用hystix">5 Feign使用Hystix</h2>
<p>Feign默认也有对Hystix的集成，只不过，默认情况下是关闭的。我们需要通过下面的参数来开启：</p>
<h3 id="51修改项目userweb03的applicationyml">5.1<strong>修改项目UserWeb03的application.yml</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启Feign的熔断功能</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">feign</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#总连接超时时间=（切换服务实例次数+1）*（每个实例重试次数+1）*连接超时时间 </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">USERPROVIDER</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#服务名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ribbon</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#配置指定服务的负载均衡策略</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">NFLoadBalancerRuleClassName</span>:<span style="color:#bbb"> </span>com.netflix.loadbalancer.RoundRobinRule<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbon的连接超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ConnectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">250</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbon的数据读取超时时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ReadTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">250</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 是否对所有操作都进行重试</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">OkToRetryOnAllOperations</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 切换实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetriesNextServer</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># 对当前实例的重试次数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetries</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#设定Hystrix熔断超时时间 ，理论上熔断时间应该大于总连接超时时间   </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">execution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">isolation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">thread</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">timeoutInMilliseconds</span>:<span style="color:#bbb"> </span><span style="color:#099">6000</span><span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="52-导入熔断所需依赖包"><strong>5.2 导入熔断所需依赖包</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="53-编写feign声明接口userservice的实现类userserviceimpl注意要声明为service"><strong>5.3 编写Feign声明接口UserService的实现类UserServiceImpl（注意要声明为@Service）</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;调用远程服务失败,熔断被触发!&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="54-在feign调用接口userservice中使用注解feignclient声明熔断调用实现类"><strong>5.4 在Feign调用接口UserService中，使用注解@FeignClient声明熔断调用实现类</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>value<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;USERPROVIDER&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             configuration<span style="color:#000;font-weight:bold">=</span>FeignConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             fallback<span style="color:#000;font-weight:bold">=</span>UserServiceImpl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="55-重启动项目userweb03"><strong>5.5 重启动项目UserWeb03</strong></h3>
<p>访问地址http://localhost:9003/</p>
<p>超时后熔断被触发
<img src="/posts/Java-frame/20220526235888/image-20220527215106658.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="6-hystix监控服务器搭建了解">6 Hystix监控服务器搭建【了解】</h2>
<p>断路器是根据一段时间窗内的请求情况来判断并操作断路器的打开和关闭状态的。而这些请求情况的指标信息都是HystrixCommand和HystrixObservableCommand实例在执行过程中记录的重要度量信息，它们除了Hystrix断路器实现中使用之外，对于系统运维也有非常大的帮助。这些指标信息会以“滚动时间窗”与“桶”结合的方式进行汇总，并在内存中驻留一段时间，以供内部或外部进行查询使用，Hystrix Dashboard就是这些指标内容的消费者之一。</p>
<p>接下来搭建使用Hystix监控</p>
<h3 id="61-新建一个模块hystrix-dashboard编辑pomxml导入所需依赖包">6.1 <strong>新建一个模块hystrix-dashboard，编辑pom.xml导入所需依赖包</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span> <span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id="62-为应用主类加上enablehystrixdashboard启用hystrix-dashboard功能"><strong>6.2 为应用主类加上@EnableHystrixDashboard，启用Hystrix Dashboard功能</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableHystrixDashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">HystrixDashboardStart</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>HystrixDashboardStart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="63-修改yml文件"><strong>6.3 修改yml文件</strong></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#000080">spring</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">application</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>hystrix-dashboard<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">server</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">1301</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">dashboard</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">proxy-stream-allow-list</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;*&#34;</span><span style="color:#bbb">    
</span></span></span></code></pre></div><h3 id="64-启动该应用并访问"><strong>6.4 启动该应用，并访问</strong></h3>
<p>http://localhost:1301/hystrix，我们可以看到如下页面：</p>
<h2 id="7-启动客户端监控">7 启动客户端监控</h2>
<p>项目：UserWeb03的UserService接口实现使用了@FeignClient修饰，feign是自带断路器功能的,并且已经开启了断路器功能，所以这个接口的调用情况会被Hystrix记录下来，以用来给断路器和Hystrix Dashboard使用。</p>
<h3 id="71-修改项目userweb04的pomxml增加hystrix监控所需依赖包">7.1 修改项目UserWeb04的pom.xml增加Hystrix监控所需依赖包</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>	<span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>	      <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>	      <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>	      <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>	      <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000080">&lt;/dependency&gt;</span>      
</span></span></code></pre></div><h3 id="72-在服务实例的主类中已经使用enablecircuitbreaker或enablehystrix注解开启断路器功能"><strong>7.2 在服务实例的主类中已经使用@EnableCircuitBreaker或@EnableHystrix注解，开启断路器功能。</strong></h3>
<p>同时增加监控路径访问地址定义/hystrix.stream可以访问</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableHystrix</span>  <span style="color:#998;font-style:italic">//开启断路器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@EnableHystrixDashboard</span>  <span style="color:#998;font-style:italic">//启用HystrixDashboard
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">AppStartApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>AppStartApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#3c5d5d;font-weight:bold">@Bean</span>	
</span></span><span style="display:flex;"><span>	<span style="color:#3c5d5d;font-weight:bold">@LoadBalanced</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">public</span> RestTemplate <span style="color:#900;font-weight:bold">getRestTemplate</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestTemplate<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	 <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">public</span> ServletRegistrationBean <span style="color:#900;font-weight:bold">getServlet</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>	        HystrixMetricsStreamServlet streamServlet <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HystrixMetricsStreamServlet<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	        ServletRegistrationBean registrationBean <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ServletRegistrationBean<span style="color:#000;font-weight:bold">(</span>streamServlet<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	        registrationBean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setLoadOnStartup</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>  <span style="color:#998;font-style:italic">//系统启动时加载顺序
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	        registrationBean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addUrlMappings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/hystrix.stream&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//路径
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	        registrationBean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;HystrixMetricsStreamServlet&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000;font-weight:bold">return</span> registrationBean<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="73-重启应用访问地址httplocalhost9004hystrixstream"><strong>7.3 重启应用，访问地址:http://localhost:9004/hystrix.stream</strong></h3>
<p>注意：如果没有访问消费者使用Hystrix熔断的接口，监控数据看不到任何数据。</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527215137577.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>需要首先访问消费者接口:http://localhost:9003/</p>
<p>才能看到Hystrix监控数据。
<img src="/posts/Java-frame/20220526235888/image-20220527215146996.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>4.使用Hystrix Dashboard对Hystrix监控数据进行图形化监控</strong></p>
<p>访问http://localhost:9004/hystrix，在出现的Hystrix Dashboard的首页中输入http://localhost:9004/hystrix.stream，</p>
<p>点击“Monitor Stream”按钮，此时我们可以看到如下页面：</p>
<p><img src="/posts/Java-frame/20220526235888/image-20220527215212881.png"
    
    
    
    loading="lazy"
    
    
></p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/java-frame/20220526160511/">← Spring-MVC</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/java-frame/20220526162071/">SSM整合  →</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
