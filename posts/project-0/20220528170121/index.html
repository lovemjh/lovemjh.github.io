<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="è´­ç‰©è½¦è§£å†³æ–¹æ¡ˆ - https://lovemjh.vercel.app/posts/project-0/20220528170121/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>è´­ç‰©è½¦è§£å†³æ–¹æ¡ˆ</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://lovemjh.vercel.app/style.min.824365c118b34524ce845ac2a294220354719cca11af5b27a81b04c173bbba57.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"hasFoldAllCodeBlocks": false,
		"svgColor": "#6c757d",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            è´­ç‰©è½¦è§£å†³æ–¹æ¡ˆ
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill=#6c757d p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill=#6c757d></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill=#6c757d></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill=#6c757d p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill=#6c757d p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill=#6c757d p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill=#6c757d p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill=#6c757d></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">ğŸ“œ</div>
        
    
    
</div>
</div>
        <div id="content">












<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2022-05-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            14511 å­—</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            29 åˆ†é’Ÿ</span><div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/"></a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/"></a>
			
		</div>
	</div>
</div>
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528173393/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://lovemjh.vercel.app/posts/tool/_20220527215246/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡</a></li>
        <li><a href="#1-èµ„æºæœåŠ¡å™¨æˆæƒé…ç½®">1 èµ„æºæœåŠ¡å™¨æˆæƒé…ç½®</a>
          <ul>
            <li><a href="#11-èµ„æºæœåŠ¡æˆæƒé…ç½®">1.1 èµ„æºæœåŠ¡æˆæƒé…ç½®</a></li>
            <li><a href="#12-ç”¨æˆ·å¾®æœåŠ¡èµ„æºæˆæƒ">1.2 ç”¨æˆ·å¾®æœåŠ¡èµ„æºæˆæƒ</a></li>
            <li><a href="#13-æˆæƒæµ‹è¯•">1.3 æˆæƒæµ‹è¯•</a></li>
          </ul>
        </li>
        <li><a href="#2-ç½‘å…³å¯¹æ¥å¾®æœåŠ¡è½¬å‘token">2 ç½‘å…³å¯¹æ¥å¾®æœåŠ¡è½¬å‘Token</a>
          <ul>
            <li><a href="#11-ä»¤ç‰ŒåŠ å…¥åˆ°headerä¸­">1.1 ä»¤ç‰ŒåŠ å…¥åˆ°Headerä¸­</a></li>
            <li><a href="#12-springsecurityæƒé™æ§åˆ¶">1.2 SpringSecurityæƒé™æ§åˆ¶</a>
              <ul>
                <li><a href="#121-è§’è‰²åŠ è½½">1.2.1 è§’è‰²åŠ è½½</a></li>
                <li><a href="#122-è§’è‰²æƒé™æ§åˆ¶">1.2.2 è§’è‰²æƒé™æ§åˆ¶</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#3-oauthåŠ¨æ€åŠ è½½æ•°æ®">3 OAuthåŠ¨æ€åŠ è½½æ•°æ®</a>
          <ul>
            <li><a href="#31-å®¢æˆ·ç«¯æ•°æ®åŠ è½½">3.1 å®¢æˆ·ç«¯æ•°æ®åŠ è½½</a>
              <ul>
                <li><a href="#311-æ•°æ®ä»‹ç»">3.1.1 æ•°æ®ä»‹ç»</a></li>
                <li><a href="#312-åŠ è½½æ•°æ®æ”¹é€ ">3.1.2 åŠ è½½æ•°æ®æ”¹é€ </a></li>
              </ul>
            </li>
            <li><a href="#32-ç”¨æˆ·æ•°æ®åŠ è½½">3.2 ç”¨æˆ·æ•°æ®åŠ è½½</a></li>
          </ul>
        </li>
        <li><a href="#4-è´­ç‰©è½¦">4 è´­ç‰©è½¦</a>
          <ul>
            <li><a href="#41-è´­ç‰©è½¦åˆ†æ">4.1 è´­ç‰©è½¦åˆ†æ</a></li>
            <li><a href="#42-è®¢å•è´­ç‰©è½¦å¾®æœåŠ¡">4.2 è®¢å•è´­ç‰©è½¦å¾®æœåŠ¡</a></li>
            <li><a href="#43-æ·»åŠ è´­ç‰©è½¦">4.3 æ·»åŠ è´­ç‰©è½¦</a>
              <ul>
                <li><a href="#431-æ€è·¯åˆ†æ">4.3.1 æ€è·¯åˆ†æ</a></li>
                <li><a href="#432-ä»£ç å®ç°">4.3.2 ä»£ç å®ç°</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#5-ç”¨æˆ·èº«ä»½è¯†åˆ«">5 ç”¨æˆ·èº«ä»½è¯†åˆ«</a>
          <ul>
            <li><a href="#51-è´­ç‰©è½¦éœ€æ±‚åˆ†æ">5.1 è´­ç‰©è½¦éœ€æ±‚åˆ†æ</a></li>
            <li><a href="#52-å¾®æœåŠ¡ä¹‹é—´è®¤è¯">5.2 å¾®æœåŠ¡ä¹‹é—´è®¤è¯</a></li>
            <li><a href="#53-ç½‘å…³è¿‡æ»¤">5.3 ç½‘å…³è¿‡æ»¤</a></li>
            <li><a href="#54-è®¢å•å¯¹æ¥ç½‘å…³oauth">5.4 è®¢å•å¯¹æ¥ç½‘å…³+oauth</a></li>
            <li><a href="#55-è·å–ç”¨æˆ·æ•°æ®">5.5 è·å–ç”¨æˆ·æ•°æ®</a>
              <ul>
                <li><a href="#551-æ•°æ®åˆ†æ">5.5.1 æ•°æ®åˆ†æ</a></li>
                <li><a href="#552-ä»£ç å®ç°">5.5.2 ä»£ç å®ç°</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h1 align = "center">ç¬¬åäºŒç« </h1>
<h1 align = "center">è´­ç‰©è½¦è§£å†³æ–¹æ¡ˆ</h1>
<h3 align="center">ä¼˜å°±ä¸š.JAVAæ•™ç ”å®¤</h3>
<h2 id="å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡</h2>
<p>ç›®æ ‡1ï¼šèµ„æºæœåŠ¡å™¨æˆæƒé…ç½®</p>
<p>ç›®æ ‡2ï¼šæŒæ¡OAuthè®¤è¯å¾®æœåŠ¡åŠ¨æ€åŠ è½½æ•°æ®</p>
<p>ç›®æ ‡3ï¼šæŒæ¡è´­ç‰©è½¦æµç¨‹</p>
<p>ç›®æ ‡4ï¼šæŒæ¡è´­ç‰©è½¦æ¸²æŸ“æµç¨‹</p>
<p>ç›®æ ‡5ï¼šOAuth2.0è®¤è¯å¹¶è·å–ç”¨æˆ·ä»¤ç‰Œæ•°æ®</p>
<p>ç›®æ ‡6ï¼šå¾®æœåŠ¡ä¸å¾®æœåŠ¡ä¹‹é—´çš„è®¤è¯</p>
<h2 id="1-èµ„æºæœåŠ¡å™¨æˆæƒé…ç½®">1 èµ„æºæœåŠ¡å™¨æˆæƒé…ç½®</h2>
<h3 id="11-èµ„æºæœåŠ¡æˆæƒé…ç½®">1.1 èµ„æºæœåŠ¡æˆæƒé…ç½®</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170232312.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åŸºæœ¬ä¸Šæ‰€æœ‰å¾®æœåŠ¡éƒ½æ˜¯èµ„æºæœåŠ¡</p>
<p>(1)é…ç½®å…¬é’¥ è®¤è¯æœåŠ¡ç”Ÿæˆä»¤ç‰Œé‡‡ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œè®¤è¯æœåŠ¡é‡‡ç”¨ç§é’¥åŠ å¯†ç”Ÿæˆä»¤ç‰Œï¼Œå¯¹å¤–å‘èµ„æºæœåŠ¡æä¾›å…¬é’¥ï¼Œèµ„æºæœåŠ¡ä½¿ ç”¨å…¬é’¥ æ¥æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ã€‚ å°†å…¬é’¥æ‹·è´åˆ° public.keyæ–‡ä»¶ä¸­ï¼Œå°†æ­¤æ–‡ä»¶æ‹·è´åˆ°æ¯ä¸€ä¸ªéœ€è¦çš„èµ„æºæœåŠ¡å·¥ç¨‹çš„classpathä¸‹ ,ä¾‹å¦‚:ç”¨æˆ·å¾®æœåŠ¡.</p>
<p>(2)æ·»åŠ ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)é…ç½®æ¯ä¸ªç³»ç»Ÿçš„Httpè¯·æ±‚è·¯å¾„å®‰å…¨æ§åˆ¶ç­–ç•¥ä»¥åŠè¯»å–å…¬é’¥ä¿¡æ¯è¯†åˆ«ä»¤ç‰Œï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableResourceServer</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//æ¿€æ´»æ–¹æ³•ä¸Šçš„PreAuthorizeæ³¨è§£
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ResourceServerConfig</span> <span style="color:#000;font-weight:bold">extends</span> ResourceServerConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å…¬é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å®šä¹‰JwtTokenStore
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param jwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenStore <span style="color:#900;font-weight:bold">tokenStore</span><span style="color:#000;font-weight:bold">(</span>JwtAccessTokenConverter jwtAccessTokenConverter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> JwtTokenStore<span style="color:#000;font-weight:bold">(</span>jwtAccessTokenConverter<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å®šä¹‰JJwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> JwtAccessTokenConverter <span style="color:#900;font-weight:bold">jwtAccessTokenConverter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        JwtAccessTokenConverter converter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> JwtAccessTokenConverter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVerifierKey</span><span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> converter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è·å–éå¯¹ç§°åŠ å¯†å…¬é’¥ Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return å…¬é’¥ Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        Resource resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader br <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è¯»å–ç¬¬1è¡Œï¼Œå…¬é’¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>s<span style="color:#000;font-weight:bold">=</span>br<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000;font-weight:bold">return</span> s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException ioe<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//ä¸‹è¾¹çš„è·¯å¾„æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;/user/add&#34;</span><span style="color:#000;font-weight:bold">).</span> <span style="color:#998;font-style:italic">//é…ç½®åœ°å€æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                permitAll<span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">anyRequest</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>                authenticated<span style="color:#000;font-weight:bold">();</span>    <span style="color:#998;font-style:italic">//å…¶ä»–åœ°å€éœ€è¦è®¤è¯æˆæƒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="12-ç”¨æˆ·å¾®æœåŠ¡èµ„æºæˆæƒ">1.2 ç”¨æˆ·å¾®æœåŠ¡èµ„æºæˆæƒ</h3>
<p>å°†ä¸Šé¢ç”Ÿæˆçš„å…¬é’¥public.keyæ‹·è´åˆ°dongyimai-user-serviceå¾®æœåŠ¡å·¥ç¨‹çš„resourcesç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170246904.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>(1)å¼•å…¥ä¾èµ–</p>
<p>åœ¨dongyimai-user-serviceå¾®æœåŠ¡å·¥ç¨‹pom.xmlä¸­å¼•å…¥oauthä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--oauthä¾èµ–--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)èµ„æºæˆæƒé…ç½®</p>
<p>åœ¨dongyimai-user-serviceå·¥ç¨‹ä¸­åˆ›å»ºcom.offcn.user.config.ResourceServerConfigï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableResourceServer</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//æ¿€æ´»æ–¹æ³•ä¸Šçš„PreAuthorizeæ³¨è§£
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ResourceServerConfig</span> <span style="color:#000;font-weight:bold">extends</span> ResourceServerConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å…¬é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å®šä¹‰JwtTokenStore
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param jwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenStore <span style="color:#900;font-weight:bold">tokenStore</span><span style="color:#000;font-weight:bold">(</span>JwtAccessTokenConverter jwtAccessTokenConverter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> JwtTokenStore<span style="color:#000;font-weight:bold">(</span>jwtAccessTokenConverter<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å®šä¹‰JJwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> JwtAccessTokenConverter <span style="color:#900;font-weight:bold">jwtAccessTokenConverter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        JwtAccessTokenConverter converter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> JwtAccessTokenConverter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVerifierKey</span><span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> converter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è·å–éå¯¹ç§°åŠ å¯†å…¬é’¥ Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return å…¬é’¥ Key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åŠ è½½å…¬é’¥æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Resource resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è¯»å–è¾“å…¥æµ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader br <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è¯»å–ç¬¬1è¡Œï¼Œå…¬é’¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>s<span style="color:#000;font-weight:bold">=</span>br<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000;font-weight:bold">return</span> s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//ä¸‹è¾¹çš„è·¯å¾„æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;/user/add&#34;</span><span style="color:#000;font-weight:bold">).</span> <span style="color:#998;font-style:italic">//é…ç½®åœ°å€æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                permitAll<span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">anyRequest</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>                authenticated<span style="color:#000;font-weight:bold">();</span>    <span style="color:#998;font-style:italic">//å…¶ä»–åœ°å€éœ€è¦è®¤è¯æˆæƒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>é—®é¢˜ï¼šæ³¨æ„å…¬é’¥çš„æ ¼å¼å¿…é¡»æ­£ç¡®ï¼Œè¦ä¸ç„¶ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯
<img src="/posts/project-0/20220528170121/image-20220528170258095.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="13-æˆæƒæµ‹è¯•">1.3 æˆæƒæµ‹è¯•</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170303004.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç”¨æˆ·æ¯æ¬¡è®¿é—®å¾®æœåŠ¡çš„æ—¶å€™ï¼Œéœ€è¦å…ˆç”³è¯·ä»¤ç‰Œï¼Œä»¤ç‰Œç”³è¯·åï¼Œæ¯æ¬¡å°†ä»¤ç‰Œæ”¾åˆ°å¤´æ–‡ä»¶ä¸­ï¼Œæ‰èƒ½è®¿é—®å¾®æœåŠ¡ã€‚</p>
<p>å¤´æ–‡ä»¶ä¸­æ¯æ¬¡éœ€è¦æ·»åŠ ä¸€ä¸ª<code>Authorization</code>å¤´ä¿¡æ¯ï¼Œå¤´çš„ç»“æœä¸º<code>bearer token</code>ã€‚</p>
<p>(1)ä¸æºå¸¦ä»¤ç‰Œæµ‹è¯•</p>
<p>è®¿é—®http://localhost:9007/user  ä¸æºå¸¦ä»¤ç‰Œï¼Œç»“æœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170309717.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)æºå¸¦æ­£ç¡®ä»¤ç‰Œè®¿é—®ï¼Œæ³¨æ„é‡æ–°ç”Ÿæˆä»¤ç‰Œ</p>
<p>è®¿é—®http://localhost:9007/user  æºå¸¦æ­£ç¡®ä»¤ç‰Œ</p>
<p>åœ¨è¯·æ±‚å¤´æºå¸¦å‚æ•°ï¼š</p>
<p>key:  Authorization</p>
<p>value: Bearer+åŠè§’ç©ºæ ¼+accessToken</p>
<p>ç»“æœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170315509.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(3)æºå¸¦é”™è¯¯ä»¤ç‰Œ</p>
<p>è®¿é—®http://localhost:9007/user  æºå¸¦ä¸æ­£ç¡®ä»¤ç‰Œï¼Œç»“æœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170320779.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ³¨æ„ï¼šå®¢æˆ·ç«¯èµ„æºå¿…é¡»æ‹¥æœ‰ï¼šoauth2-resourceï¼Œå¦åˆ™æŠ¥é”™</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inMemory</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;client1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">secret</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;123&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resourceIds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;oauth2-resource&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;dongyimai-user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;dongyimai-goods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-ç½‘å…³å¯¹æ¥å¾®æœåŠ¡è½¬å‘token">2 ç½‘å…³å¯¹æ¥å¾®æœåŠ¡è½¬å‘Token</h2>
<p><img src="/posts/project-0/20220528170121/image-20220528170331003.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç”¨æˆ·æ¯æ¬¡è®¿é—®å¾®æœåŠ¡çš„æ—¶å€™ï¼Œå…ˆå»oauth2.0æœåŠ¡ç™»å½•ï¼Œç™»å½•åå†è®¿é—®å¾®æœåŠ¡ç½‘å…³ï¼Œå¾®æœåŠ¡ç½‘å…³å°†è¯·æ±‚è½¬å‘ç»™å…¶ä»–å¾®æœåŠ¡å¤„ç†ã€‚</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">1.ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¼šå°†ä»¤ç‰Œä¿¡æ¯å­˜å…¥åˆ°cookieä¸­(ä¸€èˆ¬å»ºè®®å­˜å…¥åˆ°å¤´æ–‡ä»¶ä¸­)
2.ç”¨æˆ·æºå¸¦Cookieä¸­çš„ä»¤ç‰Œè®¿é—®å¾®æœåŠ¡ç½‘å…³
3.å¾®æœåŠ¡ç½‘å…³å…ˆè·å–å¤´æ–‡ä»¶ä¸­çš„ä»¤ç‰Œä¿¡æ¯ï¼Œå¦‚æœHeaderä¸­æ²¡æœ‰Authorizationä»¤ç‰Œä¿¡æ¯ï¼Œåˆ™ä»å‚æ•°ä¸­æ‰¾ï¼Œå‚æ•°ä¸­å¦‚æœæ²¡æœ‰ï¼Œåˆ™å–Cookieä¸­æ‰¾Authorizationï¼Œæœ€åå°†ä»¤ç‰Œä¿¡æ¯å°è£…åˆ°Headerä¸­ï¼Œå¹¶è°ƒç”¨å…¶ä»–å¾®æœåŠ¡
4.å…¶ä»–å¾®æœåŠ¡ä¼šè·å–å¤´æ–‡ä»¶ä¸­çš„Authorizationä»¤ç‰Œä¿¡æ¯ï¼Œç„¶ååŒ¹é…ä»¤ç‰Œæ•°æ®æ˜¯å¦èƒ½ä½¿ç”¨å…¬é’¥è§£å¯†ï¼Œå¦‚æœè§£å¯†æˆåŠŸè¯´æ˜ç”¨æˆ·å·²ç™»å½•ï¼Œè§£å¯†å¤±è´¥ï¼Œè¯´æ˜ç”¨æˆ·æœªç™»å½•
</code></pre><h3 id="11-ä»¤ç‰ŒåŠ å…¥åˆ°headerä¸­">1.1 ä»¤ç‰ŒåŠ å…¥åˆ°Headerä¸­</h3>
<p>ä¿®æ”¹dongyimai-gateway-webçš„å…¨å±€è¿‡æ»¤å™¨com.offcn.filter.AuthorizeFilterï¼Œå®ç°å°†ä»¤ç‰Œä¿¡æ¯æ·»åŠ åˆ°å¤´æ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170339101.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//ä¸ç”¨è§£æä»¤ç‰Œï¼Œç›´æ¥è½¬å‘
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>           <span style="color:#998;font-style:italic">// Claims claims = JwtUtil.parseJwt(token);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>             <span style="color:#998;font-style:italic">//åˆ¤æ–­tokenæ˜¯å¦æœ‰Bearerå¼€å¤´,å¦‚æœæ²¡æœ‰ï¼Œå°±æ·»åŠ Bearerå¼€å¤´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>token<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">substring</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">,</span>6<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">toLowerCase</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;bearer&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic">//æ·»åŠ Bearerå¼€å¤´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                    token<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Bearer &#34;</span><span style="color:#000;font-weight:bold">+</span>token<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//æŠŠtokenè½¬å‘åˆ°å¯¹åº”å¾®æœåŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">mutate</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">header</span><span style="color:#000;font-weight:bold">(</span>AUTHORIZE_TOKEN<span style="color:#000;font-weight:bold">,</span>token<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è§£æå‡ºç°å¼‚å¸¸è¿”å›401
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setStatusCode</span><span style="color:#000;font-weight:bold">(</span>HttpStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UNAUTHORIZED</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setComplete</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•ï¼š</p>
<p>è®¿é—®<code>http://localhost:8001/api/user</code>ï¼Œå°†ç”Ÿæˆçš„æ–°ä»¤ç‰Œæ”¾åˆ°å¤´æ–‡ä»¶ä¸­æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170345227.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ³¨æ„ï¼šç»æµ‹è¯•å¦‚ä¸Šç”±äºjavaä»£ç ä¸­æ·»åŠ äº†bearerï¼Œ é‚£ä¹ˆåœ¨å‘å‡ºè¯·æ±‚çš„æ—¶å€™å°±å¯ä»¥ä¸åŠ äº†ã€‚å¹¶ä¸”ç”±äºç½‘å…³ä¸­gatewayä¸­AuthorizeFilteræ·»åŠ çš„ä»cookieä¸­è·å–ä»¤ç‰Œã€‚æ­¤æ—¶å‚æ•°ä¸­è¯·æ±‚å¤´ä¸­ä¸æ·»åŠ Authorizationå‚æ•°ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚å› ä¸ºæœ€ç»ˆéƒ½ä¼šè¢«Cookieè·å–çš„ä»¤ç‰Œç»™è¦†ç›–äº†ã€‚</p>
<h3 id="12-springsecurityæƒé™æ§åˆ¶">1.2 SpringSecurityæƒé™æ§åˆ¶</h3>
<p>ç”±äºæˆ‘ä»¬é¡¹ç›®ä½¿ç”¨äº†å¾®æœåŠ¡ï¼Œä»»ä½•ç”¨æˆ·éƒ½æœ‰å¯èƒ½ä½¿ç”¨ä»»æ„å¾®æœåŠ¡ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ§åˆ¶ç›¸å…³æƒé™ï¼Œä¾‹å¦‚ï¼šæ™®é€šç”¨æˆ·è§’è‰²ä¸èƒ½ä½¿ç”¨ç”¨æˆ·çš„åˆ é™¤æ“ä½œï¼Œåªæœ‰ç®¡ç†å‘˜æ‰å¯ä»¥ä½¿ç”¨,é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ°SpringSecurityçš„æƒé™æ§åˆ¶åŠŸèƒ½äº†ã€‚</p>
<h4 id="121-è§’è‰²åŠ è½½">1.2.1 è§’è‰²åŠ è½½</h4>
<p>åœ¨dongyimai-user-oauthæœåŠ¡ä¸­ï¼Œæ‰¾åˆ°é…ç½®ç±»WebSecurityConfig,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//ç¼–å†™è‡ªå®šä¹‰è®¤è¯ç±»ï¼Œè´¦å·ã€å¯†ç ã€æˆæƒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> UserDetailsService <span style="color:#900;font-weight:bold">CreateUserDetailsService</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//ç”¨æˆ·è´¦å·é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>UserDetails<span style="color:#000;font-weight:bold">&gt;</span> userDetailsList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºç¬¬ä¸€ç»„è´¦å·
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        UserDetails userDetails1 <span style="color:#000;font-weight:bold">=</span> User<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;123&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ADMIN&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails2 <span style="color:#000;font-weight:bold">=</span> User<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;456&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails3 <span style="color:#000;font-weight:bold">=</span> User<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user2&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;789&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ADMIN&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æŠŠåˆ›å»ºå¥½è´¦å·æ·»åŠ åˆ°è´¦å·é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        userDetailsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>userDetails1<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        userDetailsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>userDetails2<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        userDetailsList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>userDetails3<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æŠŠè´¦å·å­˜å‚¨åˆ°å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> InMemoryUserDetailsManager<span style="color:#000;font-weight:bold">(</span>userDetailsList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ³¨æ„ï¼š.authorities(&ldquo;ADMIN&rdquo;, &ldquo;USER&rdquo;) å°±æ˜¯ç»™ç”¨æˆ·æˆæƒçš„</p>
<h4 id="122-è§’è‰²æƒé™æ§åˆ¶">1.2.2 è§’è‰²æƒé™æ§åˆ¶</h4>
<p>åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¸­ï¼Œéœ€è¦è·å–ç”¨æˆ·çš„è§’è‰²ï¼Œç„¶åæ ¹æ®è§’è‰²è¯†åˆ«æ˜¯å¦å…è®¸æ“ä½œæŒ‡å®šçš„æ–¹æ³•ï¼ŒSpring Securityä¸­å®šä¹‰äº†å››ä¸ªæ”¯æŒæƒé™æ§åˆ¶çš„è¡¨è¾¾å¼æ³¨è§£ï¼Œåˆ†åˆ«æ˜¯<code>@PreAuthorize</code>ã€<code>@PostAuthorize</code>ã€<code>@PreFilter</code>å’Œ<code>@PostFilter</code>ã€‚å…¶ä¸­å‰ä¸¤è€…å¯ä»¥ç”¨æ¥åœ¨æ–¹æ³•è°ƒç”¨å‰æˆ–è€…è°ƒç”¨åè¿›è¡Œæƒé™æ£€æŸ¥ï¼Œåä¸¤è€…å¯ä»¥ç”¨æ¥å¯¹é›†åˆç±»å‹çš„å‚æ•°æˆ–è€…è¿”å›å€¼è¿›è¡Œè¿‡æ»¤ã€‚åœ¨éœ€è¦æ§åˆ¶æƒé™çš„æ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ <code>@PreAuthorize</code>æ³¨è§£ï¼Œç”¨äºæ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œæ ¡éªŒç”¨æˆ·å½“å‰è§’è‰²æ˜¯å¦èƒ½è®¿é—®è¯¥æ–¹æ³•ã€‚</p>
<p>(1)å¼€å¯@PreAuthorize</p>
<p>åœ¨<code>dongyimai-user-service</code>çš„<code>ResourceServerConfig</code>ç±»ä¸Šæ·»åŠ <code>@EnableGlobalMethodSecurity</code>æ³¨è§£ï¼Œç”¨äºå¼€å¯@PreAuthorizeçš„æ”¯æŒï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170354561.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>(2)æ–¹æ³•æƒé™æ§åˆ¶</p>
<p>åœ¨<code>dongyimaig-user-service</code>å¾®æœåŠ¡çš„<code>com.offcn.user.controller.UserController</code>ç±»çš„findByIdæ–¹æ³•ä¸Šæ·»åŠ æƒé™æ§åˆ¶æ³¨è§£<code>@PreAuthorize</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170400694.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@PreAuthorize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;hasAnyAuthority(&#39;admin&#39;)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>(3)æµ‹è¯•</p>
<p>æˆ‘ä»¬ä½¿ç”¨Postmanæµ‹è¯•ï¼Œå…ˆé‡æ–°ç™»å½•åˆ›å»ºä»¤ç‰Œï¼Œç„¶åå°†ä»¤ç‰Œæ•°å­˜æ”¾åˆ°å¤´æ–‡ä»¶ä¸­è®¿é—®å¾®æœåŠ¡ç½‘å…³æ¥è°ƒç”¨userå¾®æœåŠ¡çš„findByIdæ–¹æ³•ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p>åœ°å€ï¼š<code>http://localhost:8001/api/user/1</code>æäº¤æ–¹å¼ï¼šGET
<img src="/posts/project-0/20220528170121/image-20220528170406596.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å‘ç°ä¸Šé¢æ— æ³•è®¿é—®ï¼Œå› ä¸ºç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼Œè§’è‰²ä¸åŒ…å«adminè§’è‰²ï¼Œè€Œdeleteæ–¹æ³•éœ€è¦adminè§’è‰²ï¼Œæ‰€ä»¥è¢«æ‹¦æˆªäº†ã€‚</p>
<p>æˆ‘ä»¬å†æµ‹è¯•å…¶ä»–æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•æ²¡æœ‰é…ç½®æ‹¦æˆªï¼Œæ‰€ä»¥ç”¨æˆ·ç™»å½•åå°±ä¼šæ”¾è¡Œã€‚</p>
<p>è®¿é—®<code>http://localhost:8001/api/user</code></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170412152.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>çŸ¥è¯†ç‚¹è¯´æ˜ï¼š</p>
<p>å¦‚æœå¸Œæœ›ä¸€ä¸ªæ–¹æ³•èƒ½è¢«å¤šä¸ªè§’è‰²è®¿é—®ï¼Œé…ç½®:<code>@PreAuthorize(&quot;hasAnyAuthority('admin','user')&quot;)</code></p>
<p>å¦‚æœå¸Œæœ›ä¸€ä¸ªç±»éƒ½èƒ½è¢«å¤šä¸ªè§’è‰²è®¿é—®ï¼Œåœ¨ç±»ä¸Šé…ç½®:<code>@PreAuthorize(&quot;hasAnyAuthority('admin','user')&quot;)</code></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170419505.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å†æ¬¡æ‰§è¡ŒæŸ¥è¯¢æ–¹æ³•
<img src="/posts/project-0/20220528170121/image-20220528170424162.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="3-oauthåŠ¨æ€åŠ è½½æ•°æ®">3 OAuthåŠ¨æ€åŠ è½½æ•°æ®</h2>
<p>å‰é¢OAuthæˆ‘ä»¬ç”¨çš„æ•°æ®éƒ½æ˜¯é™æ€çš„ï¼Œåœ¨ç°å®å·¥ä½œä¸­ï¼Œæ•°æ®éƒ½æ˜¯ä»æ•°æ®åº“åŠ è½½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒæ•´ä¸€ä¸‹OAuthæœåŠ¡ï¼Œä»æ•°æ®åº“åŠ è½½ç›¸å…³æ•°æ®ã€‚</p>
<ul>
<li>å®¢æˆ·ç«¯æ•°æ®[ç”Ÿæˆä»¤ç‰Œç›¸å…³æ•°æ®]</li>
<li>ç”¨æˆ·ç™»å½•è´¦å·å¯†ç ä»æ•°æ®åº“åŠ è½½
<img src="/posts/project-0/20220528170121/image-20220528170431588.png"
    
    
    
    loading="lazy"
    
    
></li>
</ul>
<h3 id="31-å®¢æˆ·ç«¯æ•°æ®åŠ è½½">3.1 å®¢æˆ·ç«¯æ•°æ®åŠ è½½</h3>
<h4 id="311-æ•°æ®ä»‹ç»">3.1.1 æ•°æ®ä»‹ç»</h4>
<p>(1)å®¢æˆ·ç«¯é™æ€æ•°æ®</p>
<p>åœ¨<code>dongyimai-user-oauth</code>çš„com.offcn.oauth.config.AuthorizationServerConfigç±»ä¸­é…ç½®äº†å®¢æˆ·ç«¯é™æ€æ•°æ®ï¼Œä¸»è¦ç”¨äºé…ç½®å®¢æˆ·ç«¯æ•°æ®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">//å®¢æˆ·ç«¯è´¦å·é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>ClientDetailsServiceConfigurer clients<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#998;font-style:italic">//åœ¨å†…å­˜ä¸­åˆ›å»ºè´¦å·
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inMemory</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">// adminï¼Œæˆæƒç è®¤è¯ã€å¯†ç è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€ç®€å•è®¤è¯ã€åˆ·æ–°token
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#998;font-style:italic">//è´¦å·åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">secret</span><span style="color:#000;font-weight:bold">(</span>passwordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#998;font-style:italic">//å¯†ç ï¼Œè¦è®¾ç½®åŠ å¯†
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resourceIds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;dongyimai-user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;dongyimai-goods&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//èµ„æºç¼–å·
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">scopes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;server&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;app&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//ä½œç”¨èŒƒå›´
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizedGrantTypes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;authorization_code&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;refresh_token&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;client_credentials&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;implicit&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//ç™»å½•æˆæƒæ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">redirectUris</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http://localhost&#34;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//ç™»å½•æˆåŠŸè·³è½¬åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)å®¢æˆ·ç«¯è¡¨ç»“æ„ä»‹ç»</p>
<p>åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€å¼ è¡¨oauth_client_detailsï¼Œè¡¨ä¸»è¦ç”¨äºè®°å½•å®¢æˆ·ç«¯ç›¸å…³ä¿¡æ¯ï¼Œè¡¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>oauth_client_details<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>client_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">48</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å®¢æˆ·ç«¯IDï¼Œä¸»è¦ç”¨äºæ ‡è¯†å¯¹åº”çš„åº”ç”¨&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>resource_ids<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>client_secret<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å®¢æˆ·ç«¯ç§˜é’¥ï¼ŒBCryptPasswordEncoderåŠ å¯†ç®—æ³•åŠ å¯†&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span><span style="color:#000;font-weight:bold">scope</span><span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å¯¹åº”çš„èŒƒå›´&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>authorized_grant_types<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;è®¤è¯æ¨¡å¼&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>web_server_redirect_uri<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;è®¤è¯åé‡å®šå‘åœ°å€&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>authorities<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>access_token_validity<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;ä»¤ç‰Œæœ‰æ•ˆæœŸ&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>refresh_token_validity<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">11</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;ä»¤ç‰Œåˆ·æ–°å‘¨æœŸ&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>additional_information<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">4096</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>autoapprove<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">256</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>client_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><p>å­—æ®µè¯´æ˜ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">client_idï¼šå®¢æˆ·ç«¯id 
resource_idsï¼šèµ„æºidï¼ˆæš‚æ—¶ä¸ç”¨ï¼‰ 
client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ 
scopeï¼šèŒƒå›´ 
access_token_validityï¼šè®¿é—®tokençš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ 
refresh_token_validityï¼šåˆ·æ–°tokençš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ 
authorized_grant_typeï¼šæˆæƒç±»å‹:authorization_code,password,refresh_token,client_credentials    
</code></pre><p>å¯¼å…¥2æ¡è®°å½•åˆ°è¡¨ä¸­ï¼ŒSQLå¦‚ä¸‹ï¼šæ•°æ®ä¸­å¯†æ–‡ä¸º123</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>oauth_client_details<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#d14">&#39;dongyimai&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;$2a$10$8DclUiu2LEG99cTGXdpzVOwoqbJY.IZ7qXClQ.uOM8Gq9fDx/eXhO&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;app&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;authorization_code,password,refresh_token,client_credentials&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;http://localhost&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>oauth_client_details<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#d14">&#39;ujiuye&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;$2a$10$8DclUiu2LEG99cTGXdpzVOwoqbJY.IZ7qXClQ.uOM8Gq9fDx/eXhO&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;app&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;authorization_code,password,refresh_token,client_credentials&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;http://localhost&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#39;432000000&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>ä¸Šè¿°è¡¨ç»“æ„å±äºSpringSecurity Oauth2.0æ‰€éœ€çš„ä¸€ä¸ªè®¤è¯è¡¨ç»“æ„ï¼Œä¸èƒ½éšæ„æ›´æ”¹ã€‚ç›¸å…³æ“ä½œåœ¨å…¶ä»–ç±»ä¸­æœ‰æ‰€ä½“ç°ï¼Œå¦‚ï¼š<code>org.springframework.security.oauth2.provider.client.JdbcClientDetailsService</code>ä¸­çš„ç‰‡æ®µä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170441200.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="312-åŠ è½½æ•°æ®æ”¹é€ ">3.1.2 åŠ è½½æ•°æ®æ”¹é€ </h4>
<p>ï¼ˆ1ï¼‰ã€å¼•å…¥ä¾èµ–åº“</p>
<p>ä¿®æ”¹pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>&lt;dependency&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;groupId&gt;mysql&lt;/groupId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>&lt;/dependency&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>&lt;dependency&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>&lt;/dependency&gt;<span style="color:#bbb">
</span></span></span></code></pre></div><p>ï¼ˆ2ï¼‰ã€ä¿®æ”¹è¿æ¥é…ç½®</p>
<p>ä»æ•°æ®åº“åŠ è½½æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé…ç½®æ•°æ®åº“è¿æ¥ï¼Œåœ¨dongyimai-user-oauthçš„application.ymlä¸­é…ç½®è¿æ¥ä¿¡æ¯ï¼Œå¦‚ä¸‹ä»£ç ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170447230.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸Šå›¾ä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring:
  application:
    name: oauth2
  datasource:
    url: jdbc:mysql://localhost:3306/dongyimaidb
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
</code></pre><p>(3)ä¿®æ”¹å®¢æˆ·ç«¯åŠ è½½æº</p>
<p>ä¿®æ”¹dongyimai-user-oauthçš„com.offcn.oauth.config.AuthorizationServerConfigç±»çš„configureæ–¹æ³•ï¼Œå°†ä¹‹å‰é™æ€çš„å®¢æˆ·ç«¯æ•°æ®å˜æˆä»æ•°æ®åº“åŠ è½½ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<p><strong>ä¿®æ”¹å‰ï¼š</strong>
<img src="/posts/project-0/20220528170121/image-20220528170452866.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>ä¿®æ”¹åï¼š</strong>
<img src="/posts/project-0/20220528170121/image-20220528170459475.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170504888.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ³¨æ„å¦‚æœï¼šè¡¨ä¸­çš„å¯†ç ä¸æ¸…æ¥šå¯ä»¥åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»ç”Ÿæˆä¸€æ®µå¯†ç æ‹·è´è¿›å…¥è¡¨ä¸­æ›¿æ¢æ‰åŸæœ‰çš„å¯†ç å³å¯ã€‚</p>
<p>åœ¨é¡¹ç›®çš„testç›®å½•ä¸‹ï¼Œç¼–å†™æµ‹è¯•ç±»TestBCryptDemo:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.offcn.oauth</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.junit.jupiter.api.Test</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">TestBCryptDemo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span>  <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">test1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String password<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dongyimai&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> BCryptPasswordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)æµ‹è¯•</p>
<p><strong>æˆæƒç æ¨¡å¼æµ‹è¯•</strong></p>
<p>è®¿é—®ï¼š<code>http://localhost:9100/oauth/authorize?client_id=dongyimai&amp;response_type=code&amp;scope=app&amp;redirect_uri=http://localhost</code></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170511206.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç”¨æˆ·åå¯¹åº”åº”ç”¨idï¼Œå¯†ç å¯¹åº”ç§˜é’¥ã€‚è´¦å·è¾“å…¥ï¼š<code>dongyimai</code>  å¯†ç ï¼š<code>dongyimai</code></p>
<p>å½“ç„¶æ­¤æ—¶ä»æ•°æ®ä¸­å–å‡ºæ•°æ®ï¼Œæ³¨æ„ï¼šå¦‚æœé‡‡ç”¨æˆæƒç æ¨¡å¼ï¼Œå®¢æˆ·ç«¯è´¦å·å¯†ç å’Œç”¨æˆ·ç™»å½•è´¦å·å¯†ç å¿…é¡»ä¸€è‡´ã€‚</p>
<p><strong>è‡ªå®šä¹‰è´¦å·å¯†ç æ¨¡å¼æˆæƒæµ‹è¯•</strong></p>
<p>æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„è´¦å·å¯†ç ç™»å½•ä»£ç å¦‚ä¸‹ï¼Œæ¯æ¬¡éƒ½ä¼šåŠ è½½æŒ‡å®šçš„å®¢æˆ·ç«¯IDå’ŒæŒ‡å®šçš„ç§˜é’¥ï¼Œæ‰€ä»¥æ­¤æ—¶çš„å®¢æˆ·ç«¯IDå’Œç§˜é’¥å›ºå®šäº†ï¼Œè¾“å…¥çš„è´¦å·å¯†ç ä¸å†æ˜¯å®¢æˆ·ç«¯IDå’Œç§˜é’¥äº†ã€‚
<img src="/posts/project-0/20220528170121/image-20220528170515642.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>å¦‚æœå®¢æˆ·ç«¯è´¦å·å¯†ç å‘ç”Ÿå˜åŒ–ï¼Œå¯¹åº”çš„ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œå’Œæ•°æ®è¡¨oauth_client_detailsä¸­çš„è´¦å·å¯†ç ä¸€è‡´</p>
<pre tabindex="0"><code>auth:
  ttl: 3600  #tokenå­˜å‚¨è¿‡æœŸæ—¶é—´
  clientId: dongyimai    #å®¢æˆ·ç«¯è´¦å·
  clientSecret: 123      #å®¢æˆ·ç«¯å¯†ç 
  cookieDomain: localhost
  cookieMaxAge: -1
</code></pre><h3 id="32-ç”¨æˆ·æ•°æ®åŠ è½½">3.2 ç”¨æˆ·æ•°æ®åŠ è½½</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170553193.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å› ä¸ºæˆ‘ä»¬ç›®å‰æ•´å¥—ç³»ç»Ÿæ˜¯å¯¹å†…æä¾›ç™»å½•è®¿é—®ï¼Œæ‰€ä»¥æ¯æ¬¡ç”¨æˆ·ç™»å½•çš„æ—¶å€™oauthéœ€è¦è°ƒç”¨ç”¨æˆ·å¾®æœåŠ¡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚ä¸Šå›¾ï¼š</p>
<p>æˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·å¾®æœåŠ¡ä¸­æä¾›ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢çš„æ–¹æ³•ï¼Œå¹¶åœ¨oauthä¸­ä½¿ç”¨feignè°ƒç”¨å³å¯ã€‚</p>
<p>åœ¨çœŸå®å·¥ä½œä¸­ï¼Œç”¨æˆ·å’Œç®¡ç†å‘˜å¯¹åº”çš„oauthè®¤è¯æœåŠ¡å™¨ä¼šåˆ†å¼€ï¼Œç½‘å…³ä¹Ÿä¼šåˆ†å¼€ï¼Œæˆ‘ä»¬ä»Šå¤©çš„è¯¾å ‚æ¡ˆä¾‹åªå®ç°ç”¨æˆ·ç›¸å…³çš„è®¤è¯å³å¯ã€‚</p>
<p>(1)ã€å®ç°è‡ªå®šä¹‰è®¤è¯ç±»</p>
<p>ç¼–å†™è‡ªå®šä¹‰è®¤è¯ç±»ï¼Œcom.offcn.oauth.auth.UserDetailsServiceImplè¯¥ç±»å®ç°äº†åŠ è½½ç”¨æˆ·ç›¸å…³ä¿¡æ¯è¿›è¡Œæˆæƒå’Œè®¤è¯ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserDetailsServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> UserDetailsService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> UserDetails <span style="color:#900;font-weight:bold">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> UsernameNotFoundException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String pwd <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BCryptPasswordEncoder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;dongyimai&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#998;font-style:italic">//åˆ›å»ºè§’è‰²
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String permissions<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;salesman,accountant,user&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ›å»ºç”¨æˆ·å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        User userDetails <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span>pwd<span style="color:#000;font-weight:bold">,</span> AuthorityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">commaSeparatedStringToAuthorityList</span><span style="color:#000;font-weight:bold">(</span>permissions<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> userDetails<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¸Šè¿°ä»£ç ç»™ç™»å½•ç”¨æˆ·å®šä¹‰äº†ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º<code>salesman</code>,<code>accountant</code>,<code>user</code>ï¼Œè¿™ä¸€å—æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯ç¡¬ç¼–ç æ–¹å¼å°†è§’è‰²å†™æ­»äº†ï¼Œåé¢ä¼šä»æ•°æ®åº“åŠ è½½ã€‚</p>
<p>å¯†ç ä¹Ÿç»Ÿä¸€å†™æ­»æˆäº†:dongyimai</p>
<p>ä¿®æ”¹é…ç½®ç±»WebSecurityConfig</p>
<p>æ³¨é‡ŠåŸæ¥å†™æ­»è´¦å·å¯†ç çš„å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/* //å£°æ˜è‡ªå®šä¹‰è®¤è¯å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    @Bean(name = &#34;userDetailsService&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    @Override
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    public UserDetailsService userDetailsServiceBean() throws Exception {
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        return this.CreateUserDetailsService();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    }
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    @Override
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    protected UserDetailsService userDetailsService() {
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     //å¯ç”¨è‡ªå®šä¹‰è®¤è¯å¯¹è±¡è¿›è¡Œè®¤è¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     return   this.CreateUserDetailsService();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    }
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">   //è‡ªå®šä¹‰è®¤è¯ï¼Œå£°æ˜ç”¨æˆ·ç™»å½•è´¦å·ã€å¯†ç 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    private UserDetailsService CreateUserDetailsService(){
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        List&lt;UserDetails&gt; users=new ArrayList&lt;&gt;();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        UserDetails adminUser = User.withUsername(&#34;admin&#34;).password(passwordEncoder().encode(&#34;123&#34;)).authorities(&#34;ADMIN&#34;, &#34;USER&#34;).build();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        UserDetails OneUser = User.withUsername(&#34;user1&#34;).password(passwordEncoder().encode(&#34;123&#34;)).authorities(&#34;ADMIN&#34;, &#34;USER&#34;).build();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        UserDetails TowUser = User.withUsername(&#34;user2&#34;).password(passwordEncoder().encode(&#34;456&#34;)).authorities(&#34;USER&#34;).build();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        users.add(adminUser);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        users.add(OneUser);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        users.add(TowUser);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">        return new InMemoryUserDetailsManager(users);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    }*/</span>
</span></span></code></pre></div><p>é‡å†™è·å–è‡ªå®šä¹‰è®¤è¯ç±»æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>UserDetailsService userDetailsService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">protected</span> UserDetailsService <span style="color:#900;font-weight:bold">userDetailsService</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">return</span>   userDetailsService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)ä¿®æ”¹Feign</p>
<p>ä¿®æ”¹dongyimai-user-service-apiä¸­åˆ›å»ºcom.offcn.user.feign.UserFeignï¼Œæ·»åŠ ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;DYM-USER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">UserFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®usernameæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/load/{username}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> String username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)ä¿®æ”¹UserController</p>
<p>ä¿®æ”¹dongyimai-user-serviceçš„UserControlleræ·»åŠ findByUsernameæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170602282.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/load/{username}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> String username<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è°ƒç”¨UserServiceå®ç°æ ¹æ®ä¸»é”®æŸ¥è¯¢User
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    User user <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#d14">&#34;æŸ¥è¯¢æˆåŠŸ&#34;</span><span style="color:#000;font-weight:bold">,</span>user<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)æ”¾è¡ŒæŸ¥è¯¢ç”¨æˆ·æ–¹æ³•</p>
<p>å› ä¸ºoauthéœ€è¦è°ƒç”¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦åœ¨dongyimai-user-serviceä¸­æ”¾è¡Œ<code>/user/load/{username}</code>æ–¹æ³•,ä¿®æ”¹ResourceServerConfigï¼Œæ·»åŠ å¯¹<code>/user/load/{username}</code>çš„æ”¾è¡Œæ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170609133.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(5)oauthè°ƒç”¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</p>
<p>oauthå¼•å…¥å¯¹user-service-apiçš„ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--ä¾èµ–ç”¨æˆ·api--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-user-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>ä¿®æ”¹oauthçš„<code>com.offcn.oauth.UserDetailsServiceImpl</code>çš„<code>loadUserByUsername</code>æ–¹æ³•ï¼Œè°ƒç”¨UserFeignæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> UserFeign userFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> UserDetails <span style="color:#900;font-weight:bold">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> UsernameNotFoundException <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è°ƒç”¨ç”¨æˆ·å¾®æœåŠ¡ï¼Œæ ¹æ®ç”¨æˆ·åè·å¾—ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Result<span style="color:#000;font-weight:bold">&lt;</span>User<span style="color:#000;font-weight:bold">&gt;</span> userResult <span style="color:#000;font-weight:bold">=</span> userFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>userResult<span style="color:#000;font-weight:bold">!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">&amp;&amp;</span>userResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">()!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è·å–ç”¨æˆ·å¯†ç 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String pwd <span style="color:#000;font-weight:bold">=</span> userResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//String pwd = new BCryptPasswordEncoder().encode(&#34;dongyimai&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//åˆ›å»ºUserå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//String permissions = &#34;goods_list,seckill_list&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String permissions <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;salesman,accountant,user&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            User userDetails <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> pwd<span style="color:#000;font-weight:bold">,</span> AuthorityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">commaSeparatedStringToAuthorityList</span><span style="color:#000;font-weight:bold">(</span>permissions<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> userDetails<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(6)feignå¼€å¯</p>
<p>ä¿®æ”¹<code>com.offcn.OAuthApplication</code>å¼€å¯Feignå®¢æˆ·ç«¯åŠŸèƒ½</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.user.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OAuthApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OAuthApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;restTemplate&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> RestTemplate <span style="color:#900;font-weight:bold">restTemplate</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestTemplate<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(7)ã€è®¾ç½®feignçš„è°ƒç”¨è¶…æ—¶æ—¶é—´ä¿®æ”¹application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å¼€å¯Feignçš„ç†”æ–­åŠŸèƒ½</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">feign</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">enabled</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#æ€»è¿æ¥è¶…æ—¶æ—¶é—´=ï¼ˆåˆ‡æ¢æœåŠ¡å®ä¾‹æ¬¡æ•°+1ï¼‰*ï¼ˆæ¯ä¸ªå®ä¾‹é‡è¯•æ¬¡æ•°+1ï¼‰*è¿æ¥è¶…æ—¶æ—¶é—´ </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">USER</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#æœåŠ¡åç§°</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ribbon</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">#é…ç½®æŒ‡å®šæœåŠ¡çš„è´Ÿè½½å‡è¡¡ç­–ç•¥</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">NFLoadBalancerRuleClassName</span>:<span style="color:#bbb"> </span>com.netflix.loadbalancer.RoundRobinRule<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbonçš„è¿æ¥è¶…æ—¶æ—¶é—´</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ConnectTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">2000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># Ribbonçš„æ•°æ®è¯»å–è¶…æ—¶æ—¶é—´</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">ReadTimeout</span>:<span style="color:#bbb"> </span><span style="color:#099">2000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># æ˜¯å¦å¯¹æ‰€æœ‰æ“ä½œéƒ½è¿›è¡Œé‡è¯•</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">OkToRetryOnAllOperations</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># åˆ‡æ¢å®ä¾‹çš„é‡è¯•æ¬¡æ•°</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetriesNextServer</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># å¯¹å½“å‰å®ä¾‹çš„é‡è¯•æ¬¡æ•°</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">MaxAutoRetries</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">#è®¾å®šHystrixç†”æ–­è¶…æ—¶æ—¶é—´ ï¼Œç†è®ºä¸Šç†”æ–­æ—¶é—´åº”è¯¥å¤§äºæ€»è¿æ¥è¶…æ—¶æ—¶é—´   </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">hystrix</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000080">execution</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">isolation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000080">thread</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000080">timeoutInMilliseconds</span>:<span style="color:#bbb"> </span><span style="color:#099">10000</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>(7)æµ‹è¯•</p>
<p>æˆ‘ä»¬æ¢ä¸ªæ•°æ®åº“ä¸­çš„è´¦å·å¯†ç ç™»å½•ï¼Œåˆ†åˆ«è¾“å…¥zhangsanï¼Œå¯†ç ä½¿ç”¨æˆ‘ä»¬å‰é¢çš„æµ‹è¯•ç±»é‡æ–°ç”Ÿæˆå¯†ç æ‹·è´è¿›å…¥æ•°æ®åº“ä¸­æ›¿æ¢åŸæœ‰çš„æ•°æ®ï¼Œç„¶åæµ‹è¯•æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170618336.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ³¨æ„è´¦å·å¯†ç ä»æ•°æ®è¡¨tb_useræŸ¥çœ‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170623094.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="4-è´­ç‰©è½¦">4 è´­ç‰©è½¦</h2>
<p>è´­ç‰©è½¦åˆ†ä¸ºç”¨æˆ·ç™»å½•è´­ç‰©è½¦å’Œæœªç™»å½•è´­ç‰©è½¦æ“ä½œï¼Œä¼ ç»Ÿçš„ç”µå•†ç³»ç»Ÿåœ¨ç”¨æˆ·ç™»å½•å’Œä¸ç™»å½•éƒ½å¯ä»¥æ“ä½œè´­ç‰©è½¦ï¼Œå¦‚æœç”¨æˆ·ä¸ç™»å½•ï¼Œæ“ä½œè´­ç‰©è½¦å¯ä»¥å°†æ•°æ®å­˜å‚¨åˆ°Cookieæˆ–è€…WebSQLæˆ–è€…SessionStorageä¸­ï¼Œç”¨æˆ·ç™»å½•åè´­ç‰©è½¦æ•°æ®å¯ä»¥å­˜å‚¨åˆ°Redisä¸­ï¼Œå†å°†ä¹‹å‰æœªç™»å½•åŠ å…¥çš„è´­ç‰©è½¦åˆå¹¶åˆ°Redisä¸­å³å¯ã€‚</p>
<p>æ·˜å®å¤©çŒ«ç­‰åˆ™é‡‡ç”¨äº†å¦å¤–ä¸€ç§å®ç°æ–¹æ¡ˆï¼Œç”¨æˆ·è¦æƒ³å°†å•†å“åŠ å…¥è´­ç‰©è½¦ï¼Œå¿…é¡»å…ˆç™»å½•æ‰èƒ½æ“ä½œè´­ç‰©è½¦ã€‚</p>
<p>æˆ‘ä»¬ä»Šå¤©å®ç°çš„è´­ç‰©è½¦æ˜¯å¤©çŒ«è§£å†³æ–¹æ¡ˆï¼Œå³ç”¨æˆ·å¿…é¡»å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨è´­ç‰©è½¦åŠŸèƒ½ã€‚</p>
<h3 id="41-è´­ç‰©è½¦åˆ†æ">4.1 è´­ç‰©è½¦åˆ†æ</h3>
<p>(1)éœ€æ±‚åˆ†æ</p>
<p>ç”¨æˆ·åœ¨å•†å“è¯¦ç»†é¡µç‚¹å‡»åŠ å…¥è´­ç‰©è½¦ï¼Œæäº¤å•†å“SKUç¼–å·å’Œè´­ä¹°æ•°é‡ï¼Œæ·»åŠ åˆ°è´­ç‰©è½¦ã€‚è´­ç‰©è½¦å±•ç¤ºé¡µé¢å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170629469.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)è´­ç‰©è½¦å®ç°æ€è·¯
<img src="/posts/project-0/20220528170121/image-20220528170634823.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æˆ‘ä»¬å®ç°çš„æ˜¯ç”¨æˆ·ç™»å½•åçš„è´­ç‰©è½¦ï¼Œç”¨æˆ·å°†å•†å“åŠ å…¥è´­ç‰©è½¦çš„æ—¶å€™ï¼Œç›´æ¥å°†è¦åŠ å…¥è´­ç‰©è½¦çš„è¯¦æƒ…å­˜å…¥åˆ°Rediså³å¯ã€‚æ¯æ¬¡æŸ¥çœ‹è´­ç‰©è½¦çš„æ—¶å€™ç›´æ¥ä»Redisä¸­è·å–ã€‚</p>
<p>(3)è¡¨ç»“æ„åˆ†æ</p>
<p>ç”¨æˆ·ç™»å½•åå°†å•†å“åŠ å…¥è´­ç‰©è½¦ï¼Œéœ€è¦å­˜å‚¨å•†å“è¯¦æƒ…ä»¥åŠè´­ä¹°æ•°é‡ï¼Œè´­ç‰©è½¦è¯¦æƒ…è¡¨å¦‚ä¸‹ï¼š</p>
<p>dongyimaidbæ•°æ®åº“ä¸­tb_order_itemè¡¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>tb_order_item<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>item_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;SKU_ID&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>goods_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;SPU_ID&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>order_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">bigint</span>(<span style="color:#099">20</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;è®¢å•id&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>title<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">200</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#bbb"> </span>utf8_bin<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å•†å“æ ‡é¢˜&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>price<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">decimal</span>(<span style="color:#099">20</span>,<span style="color:#099">2</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å•†å“å•ä»·&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>num<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">int</span>(<span style="color:#099">10</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å•†å“è´­ä¹°æ•°é‡&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>total_fee<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">decimal</span>(<span style="color:#099">20</span>,<span style="color:#099">2</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å•†å“æ€»é‡‘é¢&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>pic_path<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">200</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#bbb"> </span>utf8_bin<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COMMENT</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;å•†å“å›¾ç‰‡åœ°å€&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">`</span>seller_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span><span style="color:#0086b3">varchar</span>(<span style="color:#099">100</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#bbb"> </span>utf8_bin<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>BTREE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>item_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>item_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>BTREE,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">`</span>order_id<span style="color:#000;font-weight:bold">`</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">`</span>order_id<span style="color:#000;font-weight:bold">`</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>BTREE<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#000;font-weight:bold">=</span>InnoDB<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span>CHARSET<span style="color:#000;font-weight:bold">=</span>utf8<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COLLATE</span><span style="color:#000;font-weight:bold">=</span>utf8_bin<span style="color:#bbb"> </span>ROW_FORMAT<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">DYNAMIC</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>è´­ç‰©è½¦è¯¦æƒ…è¡¨å…¶å®å°±æ˜¯è®¢å•è¯¦æƒ…è¡¨ç»“æ„ï¼Œåªæ˜¯ç›®å‰ä¸´æ—¶å­˜å‚¨æ•°æ®åˆ°Redisï¼Œç­‰ç”¨æˆ·ä¸‹å•åæ‰å°†æ•°æ®ä»Rediså–å‡ºå­˜å…¥åˆ°æ•°æ®åº“ä¸­ã€‚</p>
<h3 id="42-è®¢å•è´­ç‰©è½¦å¾®æœåŠ¡">4.2 è®¢å•è´­ç‰©è½¦å¾®æœåŠ¡</h3>
<p>æˆ‘ä»¬å…ˆæ­å»ºä¸€ä¸ªè®¢å•è´­ç‰©è½¦å¾®æœåŠ¡å·¥ç¨‹ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®ç°å³å¯ã€‚</p>
<p>(1)å¯¼å…¥èµ„æº</p>
<p>æ­å»ºè®¢å•è´­ç‰©è½¦å¾®æœåŠ¡ï¼Œå·¥ç¨‹åå­—dongyimai-order-serviceå¹¶æ­å»ºå¯¹åº”çš„apiå·¥ç¨‹dongyimai-order-service-apiï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170643175.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170648667.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åŒæ—¶åœ¨dongyimai-order-serviceä¸­å¼•å…¥dongyimai-order-service-api,</p>
<p>ä¾èµ–å¼•å…¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-order-service-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>åœ¨dongyimai-order-service-apiä¸­å¼•å…¥ä¾èµ–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-common-db<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>å°†ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆå¥½çš„daoå’Œç›¸å…³æ–‡ä»¶æ‹·è´åˆ°å·¥ç¨‹ä¸­ï¼Œä»¥åŠç”Ÿæˆå¥½çš„Pojoæ‹·è´åˆ°APIå·¥ç¨‹ä¸­</p>
<p>dongyimai-order-service:
<img src="/posts/project-0/20220528170121/image-20220528170655849.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528170121/image-20220528170709381.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)application.ymlé…ç½®</p>
<p>åœ¨dongyimai-service-orderçš„resourcesä¸­æ·»åŠ application.ymlé…ç½®æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 9008
spring:
  application:
    name: order
  datasource:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/dongyimaidb?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8
      username: root
      password: root
      type: com.alibaba.druid.pool.DruidDataSource
  redis:
    host: 192.168.188.138
    port: 6379
  main:
    allow-bean-definition-overriding: true
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka
  instance:
    lease-renewal-interval-in-seconds: 5 # æ¯éš”5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    lease-expiration-duration-in-seconds: 10 # 10ç§’ä¸å‘é€å°±è¿‡æœŸ    
feign:
  hystrix:
    enabled: true
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true  #å¼€å¯é©¼å³°å¼ç¼–å†™è§„èŒƒ
  type-aliases-package: com.offcn.order.pojo
# é…ç½®sqlæ‰“å°æ—¥å¿—
logging:
  level:
    com.offcn: debug
</code></pre><p>(3)åˆ›å»ºå¯åŠ¨ç±»</p>
<p>åœ¨dongyimai-service-orderçš„<code>com.offcn.order</code>ä¸­åˆ›å»ºå¯åŠ¨ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.order.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OrderApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="43-æ·»åŠ è´­ç‰©è½¦">4.3 æ·»åŠ è´­ç‰©è½¦</h3>
<h4 id="431-æ€è·¯åˆ†æ">4.3.1 æ€è·¯åˆ†æ</h4>
<p><img src="/posts/project-0/20220528170121/image-20220528170719500.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç”¨æˆ·æ·»åŠ è´­ç‰©è½¦ï¼Œåªéœ€è¦å°†è¦åŠ å…¥è´­ç‰©è½¦çš„å•†å“å­˜å…¥åˆ°Redisä¸­å³å¯ã€‚ä¸€ä¸ªç”¨æˆ·å¯ä»¥å°†å¤šä»¶å•†å“åŠ å…¥è´­ç‰©è½¦ï¼Œå­˜å‚¨åˆ°Redisä¸­çš„æ•°æ®å¯ä»¥é‡‡ç”¨Hashç±»å‹ã€‚</p>
<p>è´­ç‰©è½¦æ•°æ®çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170727473.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="432-ä»£ç å®ç°">4.3.2 ä»£ç å®ç°</h4>
<p>(1)åœ¨dongyimai-order-service-apiä¸‹åˆ›å»ºè´­ç‰©è½¦å¤åˆå®ä½“ç±»com.offcn.order.group.Cart.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Cart</span> <span style="color:#000;font-weight:bold">implements</span> Serializable<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">private</span> String sellerId<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//å•†å®¶ID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">private</span> String sellerName<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//å•†å®¶åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">private</span> List<span style="color:#000;font-weight:bold">&lt;</span>OrderItem<span style="color:#000;font-weight:bold">&gt;</span> orderItemList<span style="color:#000;font-weight:bold">;</span><span style="color:#998;font-style:italic">//è´­ç‰©è½¦æ˜ç»†
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//getter  and setter  ......
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)feignåˆ›å»º</p>
<p>ä¸‹è®¢å•éœ€è¦è°ƒç”¨feignæŸ¥çœ‹å•†å“ä¿¡æ¯ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºfeignåˆ†åˆ«æ ¹æ®IDæŸ¥è¯¢SKUå’ŒSPUä¿¡æ¯ï¼Œåœ¨dongyimai-sellergoods-serivce-apiå·¥ç¨‹ä¸­çš„ItemFeignå’ŒGoodsFeignæ ¹æ®IDæŸ¥è¯¢æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>com.offcn.sellergoods.feign.ItemFeign</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dym-sellergoods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/item&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">ItemFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®IDæŸ¥è¯¢Itemæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/{id}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> Long id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>com.offcn.sellergoods.feign.GoodsFeign</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@FeignClient</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dym-sellergoods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/goods&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">GoodsFeign</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®IDæŸ¥è¯¢å•†å“æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/{id}&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Result<span style="color:#000;font-weight:bold">&lt;</span>GoodsEntity<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@PathVariable</span> Long id<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)ä¸šåŠ¡å±‚</p>
<p>ä¸šåŠ¡å±‚æ¥å£</p>
<p>åœ¨dongyimai-order-servicerå¾®æœåŠ¡ä¸­åˆ›å»ºcom.offcn.order.service.CartServiceæ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">CartService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param itemId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param num
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">,</span> Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ä»redisä¸­æŸ¥è¯¢è´­ç‰©è½¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å°†è´­ç‰©è½¦ä¿å­˜åˆ°redis
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ä¸šåŠ¡å±‚æ¥å£å®ç°ç±»</p>
<p>åœ¨dongyimai-service-orderå¾®æœåŠ¡ä¸­åˆ›å»ºæ¥å£å®ç°ç±»com.offcn.order.service.impl.CartServiceImpl,ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CartServiceImpl</span> <span style="color:#000;font-weight:bold">implements</span> CartService <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> ItemFeign itemFeign<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> RedisTemplate redisTemplate<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">,</span> Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//1.æ ¹æ®å•†å“SKU IDæŸ¥è¯¢SKUå•†å“ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Result<span style="color:#000;font-weight:bold">&lt;</span>Item<span style="color:#000;font-weight:bold">&gt;</span> itemResult <span style="color:#000;font-weight:bold">=</span> itemFeign<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findById</span><span style="color:#000;font-weight:bold">(</span>itemId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        Item item <span style="color:#000;font-weight:bold">=</span> itemResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getData</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å•†å“ä¸å­˜åœ¨&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(!</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatus</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;1&#34;</span><span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å•†å“çŠ¶æ€æ— æ•ˆ&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//2.è·å–å•†å®¶ID
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String sellerId <span style="color:#000;font-weight:bold">=</span> item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSellerId</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//3.æ ¹æ®å•†å®¶IDåˆ¤æ–­è´­ç‰©è½¦åˆ—è¡¨ä¸­æ˜¯å¦å­˜åœ¨è¯¥å•†å®¶çš„è´­ç‰©è½¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Cart cart <span style="color:#000;font-weight:bold">=</span> searchCartBySellerId<span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">,</span>sellerId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//4.å¦‚æœè´­ç‰©è½¦åˆ—è¡¨ä¸­ä¸å­˜åœ¨è¯¥å•†å®¶çš„è´­ç‰©è½¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//4.1 æ–°å»ºè´­ç‰©è½¦å¯¹è±¡ ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cart<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> Cart<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSellerId</span><span style="color:#000;font-weight:bold">(</span>sellerId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSellerName</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSeller</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            OrderItem orderItem <span style="color:#000;font-weight:bold">=</span> createOrderItem<span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">,</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            List orderItemList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            orderItemList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setOrderItemList</span><span style="color:#000;font-weight:bold">(</span>orderItemList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//4.2å°†è´­ç‰©è½¦å¯¹è±¡æ·»åŠ åˆ°è´­ç‰©è½¦åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cartList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//5.å¦‚æœè´­ç‰©è½¦åˆ—è¡¨ä¸­å­˜åœ¨è¯¥å•†å®¶çš„è´­ç‰©è½¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">// åˆ¤æ–­è´­ç‰©è½¦æ˜ç»†åˆ—è¡¨ä¸­æ˜¯å¦å­˜åœ¨è¯¥å•†å“
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            OrderItem orderItem <span style="color:#000;font-weight:bold">=</span> searchOrderItemByItemId<span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">(),</span>itemId<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//5.1. å¦‚æœæ²¡æœ‰ï¼Œæ–°å¢è´­ç‰©è½¦æ˜ç»†
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                orderItem<span style="color:#000;font-weight:bold">=</span>createOrderItem<span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">,</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span><span style="color:#000;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//5.2. å¦‚æœæœ‰ï¼Œåœ¨åŸè´­ç‰©è½¦æ˜ç»†ä¸Šæ·»åŠ æ•°é‡ï¼Œæ›´æ”¹é‡‘é¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNum</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNum</span><span style="color:#000;font-weight:bold">()+</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTotalFee</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> BigDecimal<span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNum</span><span style="color:#000;font-weight:bold">()*</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPrice</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">doubleValue</span><span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//å¦‚æœæ•°é‡æ“ä½œåå°äºç­‰äº0ï¼Œåˆ™ç§»é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNum</span><span style="color:#000;font-weight:bold">()&lt;=</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                    cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//ç§»é™¤è´­ç‰©è½¦æ˜ç»†
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//å¦‚æœç§»é™¤åcartçš„æ˜ç»†æ•°é‡ä¸º0ï¼Œåˆ™å°†cartç§»é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrderItemList</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()==</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                    cartList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartList<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * ä»redisä¸­æŸ¥è¯¢è´­ç‰©è½¦
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ä»redisä¸­æå–è´­ç‰©è½¦æ•°æ®.....&#34;</span><span style="color:#000;font-weight:bold">+</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;)</span> redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cartList&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">==</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            cartList<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartList<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å°†è´­ç‰©è½¦ä¿å­˜åˆ°redis
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param username
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;å‘rediså­˜å…¥è´­ç‰©è½¦æ•°æ®.....&#34;</span><span style="color:#000;font-weight:bold">+</span>username<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        redisTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">boundHashOps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cartList&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢è´­ç‰©è½¦å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param cartList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param sellerId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> Cart <span style="color:#900;font-weight:bold">searchCartBySellerId</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList<span style="color:#000;font-weight:bold">,</span> String sellerId<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span>Cart cart<span style="color:#000;font-weight:bold">:</span>cartList<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>cart<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSellerId</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>sellerId<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> cart<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * æ ¹æ®å•†å“æ˜ç»†IDæŸ¥è¯¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param orderItemList
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param itemId
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderItem <span style="color:#900;font-weight:bold">searchOrderItemByItemId</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>OrderItem<span style="color:#000;font-weight:bold">&gt;</span> orderItemList <span style="color:#000;font-weight:bold">,</span>Long itemId <span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span>OrderItem orderItem <span style="color:#000;font-weight:bold">:</span>orderItemList<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getItemId</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">longValue</span><span style="color:#000;font-weight:bold">()==</span>itemId<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">longValue</span><span style="color:#000;font-weight:bold">()){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> orderItem<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ›å»ºè®¢å•æ˜ç»†
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param item
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param num
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> OrderItem <span style="color:#900;font-weight:bold">createOrderItem</span><span style="color:#000;font-weight:bold">(</span>Item item<span style="color:#000;font-weight:bold">,</span>Integer num<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>num<span style="color:#000;font-weight:bold">&lt;=</span>0<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;æ•°é‡éæ³•&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        OrderItem orderItem<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> OrderItem<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setGoodsId</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGoodsId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setItemId</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setNum</span><span style="color:#000;font-weight:bold">(</span>num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPicPath</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getImage</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPrice</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPrice</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSellerId</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSellerId</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTitle</span><span style="color:#000;font-weight:bold">(</span>item<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTitle</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>       orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setTotalFee</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> BigDecimal<span style="color:#000;font-weight:bold">(</span>orderItem<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPrice</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">doubleValue</span><span style="color:#000;font-weight:bold">()*</span>num<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> orderItem<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ·»åŠ dongyimai-order-serviceå¯¹dongyimai-sellergoods-serivce-apiçš„ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>com.offcn<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>dongyimai-sellergoods-serivce-api<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>1.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)æ§åˆ¶å±‚</p>
<p>åœ¨dongyimai-service-orderå¾®æœåŠ¡ä¸­åˆ›å»ºcom.offcn.order.controller.CartControllerï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/cart&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CartController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> CartService cartService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è´­ç‰©è½¦åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/findCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartList</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//ä»redisä¸­æå–
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/addGoodsToCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String username <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;ujiuye&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList <span style="color:#000;font-weight:bold">=</span> findCartList<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//è·å–è´­ç‰©è½¦åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cartList <span style="color:#000;font-weight:bold">=</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">,</span> itemId<span style="color:#000;font-weight:bold">,</span> num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;æ·»åŠ æˆåŠŸ&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;æ·»åŠ å¤±è´¥&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)feigné…ç½®</p>
<p>ä¿®æ”¹<code>com.offcn.OrderApplication</code>å¼€å¯Feignå®¢æˆ·ç«¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableFeignClients</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.sellergoods.feign&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@MapperScan</span><span style="color:#000;font-weight:bold">(</span>basePackages <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;com.offcn.order.dao&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OrderApplication</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">(</span>OrderApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>args<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æµ‹è¯•æ·»åŠ è´­ç‰©è½¦ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p>è¯·æ±‚åœ°å€<code>http://localhost:9008/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>
<img src="/posts/project-0/20220528170121/image-20220528170830486.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æµ‹è¯•æŸ¥çœ‹è´­ç‰©è½¦ï¼š<code>http://localhost:9008/cart/findCartList?username=ujiuye</code>
<img src="/posts/project-0/20220528170121/image-20220528170835317.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="5-ç”¨æˆ·èº«ä»½è¯†åˆ«">5 ç”¨æˆ·èº«ä»½è¯†åˆ«</h2>
<h3 id="51-è´­ç‰©è½¦éœ€æ±‚åˆ†æ">5.1 è´­ç‰©è½¦éœ€æ±‚åˆ†æ</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170841088.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>è´­ç‰©è½¦åŠŸèƒ½å·²ç»åšå®Œäº†ï¼Œä½†ç”¨æˆ·æˆ‘ä»¬éƒ½æ˜¯ç¡¬ç¼–ç å†™æ­»çš„ã€‚ç”¨æˆ·è¦æƒ³å°†å•†å“åŠ å…¥è´­ç‰©è½¦ï¼Œå¿…é¡»å¾—å…ˆç™»å½•æˆæƒï¼Œç™»å½•æˆæƒåå†ç»è¿‡å¾®æœåŠ¡ç½‘å…³ï¼Œå¾®æœåŠ¡ç½‘å…³éœ€è¦è¿‡æ»¤åˆ¤æ–­ç”¨æˆ·è¯·æ±‚æ˜¯å¦å­˜åœ¨ä»¤ç‰Œï¼Œå¦‚æœå­˜åœ¨ä»¤ç‰Œï¼Œæ‰èƒ½å†æ¬¡è®¿é—®å¾®æœåŠ¡ï¼Œæ­¤æ—¶ç½‘å…³ä¼šé€šè¿‡è¿‡æ»¤å™¨å°†ä»¤ç‰Œæ•°æ®å†æ¬¡å­˜å…¥åˆ°å¤´æ–‡ä»¶ä¸­ï¼Œç„¶åè®¿é—®æ¨¡æ¿æ¸²æŸ“æœåŠ¡ï¼Œæ¨¡æ¿æ¸²æŸ“æœåŠ¡å†è°ƒç”¨è®¢å•è´­ç‰©è½¦å¾®æœåŠ¡ï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦å°†ä»¤ç‰Œæ•°æ®å­˜å…¥åˆ°å¤´æ–‡ä»¶ä¸­ï¼Œå°†ä»¤ç‰Œæ•°æ®ä¼ é€’ç»™è´­ç‰©è½¦è®¢å•å¾®æœåŠ¡ï¼Œåˆ°äº†è´­ç‰©è½¦è®¢å•å¾®æœåŠ¡çš„æ—¶å€™ï¼Œæ­¤æ—¶å¾®æœåŠ¡éœ€è¦æ ¡éªŒä»¤ç‰Œæ•°æ®ï¼Œå¦‚æœä»¤ç‰Œæ­£ç¡®ï¼Œæ‰èƒ½ä½¿ç”¨è´­ç‰©è½¦åŠŸèƒ½ï¼Œå¹¶è§£æä»¤ç‰Œæ•°æ®è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<h3 id="52-å¾®æœåŠ¡ä¹‹é—´è®¤è¯">5.2 å¾®æœåŠ¡ä¹‹é—´è®¤è¯</h3>
<p><img src="/posts/project-0/20220528170121/image-20220528170847702.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>å¦‚ä¸Šå›¾ï¼šå› ä¸ºå¾®æœåŠ¡ä¹‹é—´å¹¶æ²¡æœ‰ä¼ é€’å¤´æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ¯æ¬¡å¾®æœåŠ¡è°ƒç”¨ä¹‹å‰éƒ½å…ˆæ£€æŸ¥ä¸‹å¤´æ–‡ä»¶ï¼Œå°†è¯·æ±‚çš„å¤´æ–‡ä»¶ä¸­çš„ä»¤ç‰Œæ•°æ®å†æ”¾å…¥åˆ°headerä¸­ï¼Œå†è°ƒç”¨å…¶ä»–å¾®æœåŠ¡å³å¯ã€‚</p>
<p>(1)åˆ›å»ºFeignæ‹¦æˆªå™¨</p>
<p>åœ¨dongyimai-order-serviceæœåŠ¡ä¸­åˆ›å»ºä¸€ä¸ªcom.offcn.order.config.FeignInterceptoræ‹¦æˆªå™¨ï¼Œå¹¶å°†æ‰€æœ‰å¤´æ–‡ä»¶æ•°æ®å†æ¬¡åŠ å…¥åˆ°Feignè¯·æ±‚çš„å¾®æœåŠ¡å¤´æ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">FeignInterceptor</span> <span style="color:#000;font-weight:bold">implements</span> RequestInterceptor <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">apply</span><span style="color:#000;font-weight:bold">(</span>RequestTemplate requestTemplate<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//ä½¿ç”¨RequestContextHolderå·¥å…·è·å–requestç›¸å…³å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            ServletRequestAttributes attributes <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>ServletRequestAttributes<span style="color:#000;font-weight:bold">)</span> RequestContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequestAttributes</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>attributes <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//å–å‡ºrequest
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                HttpServletRequest request <span style="color:#000;font-weight:bold">=</span> attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//è·å–æ‰€æœ‰å¤´æ–‡ä»¶ä¿¡æ¯çš„key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                Enumeration<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> headerNames <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeaderNames</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>headerNames <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>headerNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasMoreElements</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">//å¤´æ–‡ä»¶çš„key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        String name <span style="color:#000;font-weight:bold">=</span> headerNames<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nextElement</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">//å¤´æ–‡ä»¶çš„value
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        String values <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeader</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">//å°†ä»¤ç‰Œæ•°æ®æ·»åŠ åˆ°å¤´æ–‡ä»¶ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        requestTemplate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">header</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">,</span> values<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)åˆ›å»ºæ‹¦æˆªå™¨Bean</p>
<p>åœ¨dongyimai-order-serviceæœåŠ¡ä¸­å¯åŠ¨ç±»é‡Œåˆ›å»ºå¯¹è±¡å®ä¾‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * åˆ›å»ºæ‹¦æˆªå™¨Beanå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> FeignInterceptor <span style="color:#900;font-weight:bold">feignInterceptor</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> FeignInterceptor<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)æˆ‘ä»¬å°†sellergoodså·¥ç¨‹é…ç½®ä¸Šèº«ä»½è®¤è¯</p>
<p>ä¿®æ”¹dongyimai-order-serviceçš„pom.xmlï¼Œæ·»åŠ oauthçš„ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--oauthä¾èµ–--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>å°†å…¬é’¥æ‹·è´åˆ°dongyimai-order-serviceå·¥ç¨‹çš„resourcesä¸­
<img src="/posts/project-0/20220528170121/image-20220528170856147.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>åœ¨dongyimai-order-serviceå·¥ç¨‹ä¸­åˆ›å»ºcom.offcn.order.config.ResourceServerConfig,é…ç½®éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œè¿™é‡Œéœ€è¦æ‹¦æˆªæ‰€æœ‰è¯·æ±‚è·¯å¾„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableResourceServer</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#000;font-weight:bold">(</span>prePostEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> securedEnabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#998;font-style:italic">//æ¿€æ´»æ–¹æ³•ä¸Šçš„PreAuthorizeæ³¨è§£
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ResourceServerConfig</span> <span style="color:#000;font-weight:bold">extends</span> ResourceServerConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å…¬é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>     <span style="color:#998;font-style:italic">//è¯»å–å…¬é’¥çš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åŠ è½½å…¬é’¥æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Resource resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è¯»å–è¾“å…¥æµ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader br <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è¯»å–ç¬¬1è¡Œï¼Œå…¬é’¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            String s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>s<span style="color:#000;font-weight:bold">=</span>br<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000;font-weight:bold">return</span> s<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å®šä¹‰JJwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å¸®åŠ©ç¨‹åºåœ¨JWTç¼–ç çš„ä»¤ç‰Œå€¼å’ŒOAuthèº«ä»½éªŒè¯ä¿¡æ¯ä¹‹é—´è¿›è¡Œè½¬æ¢
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> JwtAccessTokenConverter <span style="color:#900;font-weight:bold">jwtAccessTokenConverter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        JwtAccessTokenConverter converter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> JwtAccessTokenConverter<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        converter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVerifierKey</span><span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> converter<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * å®šä¹‰JwtTokenStore
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param jwtAccessTokenConverter
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenStore <span style="color:#900;font-weight:bold">tokenStore</span><span style="color:#000;font-weight:bold">(</span>JwtAccessTokenConverter jwtAccessTokenConverter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> JwtTokenStore<span style="color:#000;font-weight:bold">(</span>jwtAccessTokenConverter<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">//ä¸‹è¾¹çš„è·¯å¾„æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;/spec/**&#34;</span><span style="color:#000;font-weight:bold">).</span> <span style="color:#998;font-style:italic">//é…ç½®åœ°å€æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                permitAll<span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">anyRequest</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>                authenticated<span style="color:#000;font-weight:bold">();</span>    <span style="color:#998;font-style:italic">//å…¶ä»–åœ°å€éœ€è¦è®¤è¯æˆæƒ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ³¨æ„ï¼šå½“dongyimai-order-serviceè¿è¡Œèµ·æ¥å¯èƒ½ä¼šæŠ¥é“¾æ¥ä¸åˆ°redis localhost:6379,æ­¤å¤„å¯ä»¥å†é…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸€ä¸‹å³å¯ ã€‚</p>
<p>å†æ¬¡å‘é€æ·»åŠ è´­ç‰©è½¦è¯·æ±‚æµ‹è¯•ï¼Œ
<img src="/posts/project-0/20220528170121/image-20220528170905187.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æˆ‘ä»¬å‘ç°ServletRequestAttributeså§‹ç»ˆä¸ºç©ºï¼ŒåŸå› æ˜¯RequestContextHolder.getRequestAttributes()è¯¥æ–¹æ³•æ˜¯ä»ThreadLocalå˜é‡é‡Œé¢å–å¾—ç›¸åº”ä¿¡æ¯çš„ï¼Œå½“hystrixæ–­è·¯å™¨çš„éš”ç¦»ç­–ç•¥ä¸ºTHREADæ—¶ï¼Œæ˜¯æ— æ³•å–å¾—ThreadLocalä¸­çš„å€¼ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šå¼€å¯ç†”æ–­ï¼Œå¹¶å°†hystrixéš”ç¦»ç­–ç•¥æ¢ä¸ºSEMAPHORE</p>
<p>ä¿®æ”¹dongyimai-order-serviceçš„application.ymlé…ç½®æ–‡ä»¶ï¼Œåœ¨application.ymlä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#hystrix é…ç½®
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000
          strategy: SEMAPHORE
</code></pre><p>å†æ¬¡æµ‹è¯•(æ³¨æ„è¦é‡æ–°ç™»é™†ã€ä½¿ç”¨ç”Ÿæˆçš„ä»¤ç‰Œè¿›è¡Œè®¿é—®)</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170911280.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170915820.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(4)å·¥å…·ç±»æŠ½å–</p>
<p>å¾®æœåŠ¡ä¹‹é—´ç›¸äº’è®¤è¯çš„æƒ…å†µéå¸¸å¤šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢çš„æ‹¦æˆªå™¨æŠ½å–å‡ºå»ï¼Œæ”¾åˆ°dongyimai-commonçš„configåŒ…ä¸­ï¼Œå…¶ä»–å·¥ç¨‹éœ€è¦ç”¨ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ª@Beanå¯¹è±¡å³å¯ã€‚</p>
<h3 id="53-ç½‘å…³è¿‡æ»¤">5.3 ç½‘å…³è¿‡æ»¤</h3>
<p>ä¸ºäº†ä¸ç»™å¾®æœåŠ¡å¸¦æ¥ä¸€äº›æ— æ•ˆçš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç½‘å…³ä¸­è¿‡æ»¤ç”¨æˆ·è¯·æ±‚ï¼Œå…ˆçœ‹çœ‹å¤´æ–‡ä»¶ä¸­æ˜¯å¦æœ‰Authorizationï¼Œå¦‚æœæ²¡æœ‰å†çœ‹çœ‹cookieä¸­æ˜¯å¦æœ‰Authorizationï¼Œå¦‚æœéƒ½é€šè¿‡äº†æ‰å…è®¸è¯·æ±‚åˆ°è¾¾å¾®æœåŠ¡ã€‚</p>
<h3 id="54-è®¢å•å¯¹æ¥ç½‘å…³oauth">5.4 è®¢å•å¯¹æ¥ç½‘å…³+oauth</h3>
<p>(1)application.ymlé…ç½®</p>
<p>ä¿®æ”¹å¾®æœåŠ¡ç½‘å…³<code>dongyimai-gateway-web</code>çš„application.ymlé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ orderçš„è·¯ç”±è¿‡æ»¤é…ç½®ï¼Œé…ç½®å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170923122.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä¸Šå›¾ä»£ç å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#è´­ç‰©è½¦å¾®æœåŠ¡
      - id: dongyimai_order_route
        uri: lb://ORDER
        predicates:
          - Path=/api/cart/**,/api/order/**,/api/orderItem/**
        filters:
          - StripPrefix=1
</code></pre><p>è¿™é‡Œæ³¨æ„ä½¿ç”¨çš„æ˜¯ymlæ ¼å¼ï¼Œæ‰€ä»¥ä¸Šé¢ä»£ç ä¸­çš„ç©ºæ ¼ä¹Ÿä¸€å¹¶è®°å¾—æ‹·è´åˆ°application.ymlæ–‡ä»¶ä¸­ã€‚</p>
<p>(2)è¿‡æ»¤é…ç½®</p>
<p>åœ¨å¾®æœåŠ¡ç½‘å…³<code>dongyimai-gateway-web</code>ä¸­æ·»åŠ <code>com.offcn.filter.URLFilter</code>è¿‡æ»¤ç±»ï¼Œç”¨äºè¿‡æ»¤éœ€è¦ç”¨æˆ·ç™»å½•çš„åœ°å€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">URLFilter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è¦æ”¾è¡Œçš„è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String noAuthorizeurls <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/api/user/add,/api/user/login&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * åˆ¤æ–­ å½“å‰çš„è¯·æ±‚çš„åœ°å€ä¸­æ˜¯å¦åœ¨å·²æœ‰çš„ä¸æ‹¦æˆªçš„åœ°å€ä¸­å­˜åœ¨,å¦‚æœå­˜åœ¨ åˆ™è¿”å›true  è¡¨ç¤º  ä¸æ‹¦æˆª   falseè¡¨ç¤ºæ‹¦æˆª
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @param uri è·å–åˆ°çš„å½“å‰çš„è¯·æ±‚çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">hasAuthorize</span><span style="color:#000;font-weight:bold">(</span>String uri<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        String<span style="color:#000;font-weight:bold">[]</span> split <span style="color:#000;font-weight:bold">=</span> noAuthorizeurls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String s <span style="color:#000;font-weight:bold">:</span> split<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>s<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>uri<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)å…¨å±€è¿‡æ»¤å™¨ä¿®æ”¹</p>
<p>ä¿®æ”¹ä¹‹å‰çš„<code>com.offcn.filter.AuthorizeFilter</code>çš„è¿‡æ»¤æ–¹æ³•ï¼Œå°†æ˜¯å¦éœ€è¦ç”¨æˆ·ç™»å½•è¿‡æ»¤ä¹ŸåŠ å…¥å…¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170931350.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">//è·å–è¯·æ±‚çš„URI
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String path <span style="color:#000;font-weight:bold">=</span> request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getURI</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//åˆ¤æ–­è¯·æ±‚è·¯å¾„æ˜¯å¦æ˜¯ä¸éœ€è¦éªŒè¯çš„
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span>URLFilter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasAuthorize</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//ç›´æ¥æ”¾è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">return</span>   chain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span>exchange<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)æµ‹è¯•</p>
<p>ä½¿ç”¨Postmanè®¿é—® <code>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><strong>æœªç™»å½•ï¼š</strong>
<img src="/posts/project-0/20220528170121/image-20220528170942027.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä½¿ç”¨Postmanè®¿é—® <code>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1369283&amp;num=100</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><strong>å·²ç™»å½•ï¼š</strong>
<img src="/posts/project-0/20220528170121/image-20220528170948295.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ä½¿ç”¨Postmanè®¿é—® <code>http://localhost:8001/api/cart/findCartList?username=ujiuye</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="/posts/project-0/20220528170121/image-20220528170953025.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="55-è·å–ç”¨æˆ·æ•°æ®">5.5 è·å–ç”¨æˆ·æ•°æ®</h3>
<h4 id="551-æ•°æ®åˆ†æ">5.5.1 æ•°æ®åˆ†æ</h4>
<p>ç”¨æˆ·ç™»å½•åï¼Œæ•°æ®ä¼šå°è£…åˆ°<code>SecurityContextHolder.getContext().getAuthentication()</code>é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®ä»è¿™é‡Œé¢å–å‡ºï¼Œç„¶åè½¬æ¢æˆ<code>OAuth2AuthenticationDetails</code>,åœ¨è¿™é‡Œé¢å¯ä»¥è·å–åˆ°ä»¤ç‰Œä¿¡æ¯ã€ä»¤ç‰Œç±»å‹ç­‰ï¼Œä»£ç å¦‚ä¸‹ï¼š
<img src="/posts/project-0/20220528170121/image-20220528170959227.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>è¿™é‡Œçš„tokenValueæ˜¯åŠ å¯†ä¹‹åçš„ä»¤ç‰Œæ•°æ®ï¼ŒremoteAddressæ˜¯ç”¨æˆ·çš„IPä¿¡æ¯ï¼ŒtokenTypeæ˜¯ä»¤ç‰Œç±»å‹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è·å–ä»¤ç‰ŒåŠ å¯†æ•°æ®åï¼Œä½¿ç”¨å…¬é’¥å¯¹å®ƒè¿›è¡Œè§£å¯†ï¼Œå¦‚æœèƒ½è§£å¯†è¯´æ˜è¯­å¥æ— è¯¯ï¼Œå¦‚æœä¸èƒ½è§£å¯†ç”¨æˆ·ä¹Ÿæ²¡æ³•æ‰§è¡Œåˆ°è¿™ä¸€æ­¥ã€‚è§£å¯†åå¯ä»¥ä»æ˜æ–‡ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<h4 id="552-ä»£ç å®ç°">5.5.2 ä»£ç å®ç°</h4>
<p>(1)åœ¨dongyimai-commonå·¥ç¨‹ä¸­å¼•å…¥é‰´æƒåŒ…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--oauthä¾èµ–--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;scope&gt;</span>provided<span style="color:#000080">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">&lt;!--é‰´æƒ--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#000080">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;artifactId&gt;</span>jjwt<span style="color:#000080">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;version&gt;</span>0.9.0<span style="color:#000080">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&lt;scope&gt;</span>provided<span style="color:#000080">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000080">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(2)è¯»å–å…¬é’¥</p>
<p>åœ¨dongyimai-commonä¸­åˆ›å»ºcom.offcn.utils.TokenDecodeç±»ï¼Œç”¨äºè§£å¯†ä»¤ç‰Œä¿¡æ¯ï¼Œåœ¨ç±»ä¸­è¯»å–å…¬é’¥ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">TokenDecode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å…¬é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å®šä¹‰è¯»å–å…¬é’¥å†…å®¹å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String publickey<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è¯»å–å…¬é’¥å†…å®¹æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        Resource resource<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader bufferedReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è¯»å–ç¬¬ä¸€è¡Œå…¬é’¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>publickey<span style="color:#000;font-weight:bold">=</span>bufferedReader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(2)æ ¡éªŒè§£æä»¤ç‰Œæ•°æ®</p>
<p>åœ¨TokenDecodeç±»ä¸­æ·»åŠ æ ¡éªŒè§£æä»¤ç‰Œæ•°æ®çš„æ–¹æ³•ï¼Œè¿™é‡Œç”¨åˆ°äº†JwtHelperå®ç°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * è¯»å–ä»¤ç‰Œæ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">dcodeToken</span><span style="color:#000;font-weight:bold">(</span>String token<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//æ ¡éªŒJwt
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    Jwt jwt <span style="color:#000;font-weight:bold">=</span> JwtHelper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decodeAndVerify</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> RsaVerifier<span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è·å–JwtåŸå§‹å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    String claims <span style="color:#000;font-weight:bold">=</span> jwt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClaims</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">,</span>Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(3)è·å–ä»¤ç‰Œæ•°æ®</p>
<p>åœ¨TokenDecodeç±»ä¸­æ·»åŠ ä¸€ä¸ªgetUserInfoæ–¹æ³•ï¼Œç”¨äºä»å®¹å™¨ä¸­è·å–ä»¤ç‰Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * è·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getUserInfo</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è·å–æˆæƒä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    OAuth2AuthenticationDetails details <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>OAuth2AuthenticationDetails<span style="color:#000;font-weight:bold">)</span> SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAuthentication</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getDetails</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//ä»¤ç‰Œè§£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> dcodeToken<span style="color:#000;font-weight:bold">(</span>details<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTokenValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>å®Œæ•´ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.alibaba.fastjson.JSON</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.core.io.ClassPathResource</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.core.io.Resource</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.core.context.SecurityContextHolder</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.jwt.Jwt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.jwt.JwtHelper</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.jwt.crypto.sign.RsaVerifier</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationDetails</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.BufferedReader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.InputStreamReader</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">TokenDecode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å…¬é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String PUBLIC_KEY<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;public.key&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//å®šä¹‰è¯»å–å…¬é’¥å†…å®¹å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String publickey<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è¯»å–å…¬é’¥å†…å®¹æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">getPubKey</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        Resource resource<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">new</span> ClassPathResource<span style="color:#000;font-weight:bold">(</span>PUBLIC_KEY<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            InputStreamReader inputStreamReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InputStreamReader<span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInputStream</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            BufferedReader bufferedReader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BufferedReader<span style="color:#000;font-weight:bold">(</span>inputStreamReader<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">//è¯»å–ç¬¬ä¸€è¡Œå…¬é’¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span><span style="color:#000;font-weight:bold">((</span>publickey<span style="color:#000;font-weight:bold">=</span>bufferedReader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readLine</span><span style="color:#000;font-weight:bold">())!=</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> publickey<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è§£æä»¤ç‰Œè¯»å–æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">decodeToken</span><span style="color:#000;font-weight:bold">(</span>String token<span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è°ƒç”¨å…¬é’¥è§£æä»¤ç‰Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Jwt jwt <span style="color:#000;font-weight:bold">=</span> JwtHelper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decodeAndVerify</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> RsaVerifier<span style="color:#000;font-weight:bold">(</span>getPubKey<span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–åŸå§‹å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        String claims <span style="color:#000;font-weight:bold">=</span> jwt<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClaims</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è§£æjsonå­—ç¬¦ä¸²ä¸ºMap
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> JSON<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseObject</span><span style="color:#000;font-weight:bold">(</span>claims<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">//è®¿é—®å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯è§£æä»¤ç‰Œè·å–ç”¨æˆ·æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">public</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getUserInfo</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è·å–springSecurityç™»å½•ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        OAuth2AuthenticationDetails details<span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>OAuth2AuthenticationDetails<span style="color:#000;font-weight:bold">)</span> SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAuthentication</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getDetails</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//è§£æä»¤ç‰Œ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> decodeToken<span style="color:#000;font-weight:bold">(</span>details<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTokenValue</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(4)dongyimai-order-serviceå¾®æœåŠ¡çš„ä¸»å¯åŠ¨ç±»ä¸­å£°æ˜TokenDecode</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> TokenDecode <span style="color:#900;font-weight:bold">getTokenDecode</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> TokenDecode<span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)orderå¾®æœåŠ¡çš„æ§åˆ¶å±‚è·å–ç”¨æˆ·æ•°æ®</p>
<p>åœ¨CartControllerä¸­æ³¨å…¥TokenDecodeï¼Œå¹¶è°ƒç”¨TokenDecodeçš„getUserInfoæ–¹æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p>æ³¨å…¥TokenDecodeï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">private</span> TokenDecode tokenDecode<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>è·å–ç”¨æˆ·åï¼š
<img src="/posts/project-0/20220528170121/image-20220528171012342.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@CrossOrigin</span>
</span></span><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/cart&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CartController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> CartService cartService<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">private</span> TokenDecode tokenDecode<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * è´­ç‰©è½¦åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/findCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">findCartList</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> userInfo <span style="color:#000;font-weight:bold">=</span> tokenDecode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUserInfo</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;userInfo:&#34;</span><span style="color:#000;font-weight:bold">+</span>userInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        String username<span style="color:#000;font-weight:bold">=</span>userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user_name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findCartListFromRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//ä»redisä¸­æå–
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#3c5d5d;font-weight:bold">@RequestMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/addGoodsToCartList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>Long itemId<span style="color:#000;font-weight:bold">,</span> Integer num<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//String username = &#34;ujiuye&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> userInfo <span style="color:#000;font-weight:bold">=</span> tokenDecode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUserInfo</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;userInfo:&#34;</span><span style="color:#000;font-weight:bold">+</span>userInfo<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        String username<span style="color:#000;font-weight:bold">=</span>userInfo<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user_name&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#000;font-weight:bold">&lt;</span>Cart<span style="color:#000;font-weight:bold">&gt;</span> cartList <span style="color:#000;font-weight:bold">=</span> findCartList<span style="color:#000;font-weight:bold">();</span><span style="color:#998;font-style:italic">//è·å–è´­ç‰©è½¦åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            cartList <span style="color:#000;font-weight:bold">=</span> cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addGoodsToCartList</span><span style="color:#000;font-weight:bold">(</span>cartList<span style="color:#000;font-weight:bold">,</span> itemId<span style="color:#000;font-weight:bold">,</span> num<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            cartService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">saveCartListToRedis</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> cartList<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;æ·»åŠ æˆåŠŸ&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Result<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> StatusCode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ERROR</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;æ·»åŠ å¤±è´¥&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>(5)æµ‹è¯•</p>
<p>ç”¨æˆ·ç™»å½•åæµ‹è¯•</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171020396.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç»è¿‡ç½‘å…³è½¬å‘è¯·æ±‚æ·»åŠ åˆ°è´­ç‰©è½¦ï¼š</p>
<p>http://localhost:8001/api/cart/addGoodsToCartList?itemId=1324601&amp;num=1</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171025863.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>æŸ¥çœ‹redisç¼“å­˜ä¸­ä¿å­˜çš„ç”¨æˆ·æ•°æ®
<img src="/posts/project-0/20220528170121/image-20220528171044967.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>ç»è¿‡ç½‘å…³ï¼ŒæŸ¥çœ‹è´­ç‰©è½¦æ•°æ®:</p>
<p>http://localhost:8001/api/cart/findCartList</p>
<p><img src="/posts/project-0/20220528170121/image-20220528171053575.png"
    
    
    
    loading="lazy"
    
    
></p>

    </div>

    

    


    <div class="container-prevnext">
    <div><a href="https://lovemjh.vercel.app/posts/project-0/20220528173393/">â† ç§’æ€é«˜çº§</a></div>
    <div><a href="https://lovemjh.vercel.app/posts/tool/_20220527215246/">Dockerå¿«é€Ÿå…¥é—¨  â†’</a></div>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        è±«ICPå¤‡2022002918å·
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
</div></div>
    </body>
</html>
