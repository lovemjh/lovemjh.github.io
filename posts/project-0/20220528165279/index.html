<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>SpringSecurity OAuth2.0用户认证</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }
  </style>

</head>
    <body style="    
    background-image: url(https://api.ixiaowai.cn/api/api.php);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;">
    <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap">
  <nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-28&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-28&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            13272 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            27 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['SpringSecurity OAuth2.0用户认证'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第十一章</h1>
<h1 align = "center">SpringSecurity OAuth2.0用户认证</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>
<p>用户认证分析</p>
</li>
<li>
<p>认证技术方案了解</p>
</li>
<li>
<p>SpringSecurity Oauth2.0入门</p>
</li>
<li>
<p>用户授权认证开发</p>
</li>
</ul>
<h1 id="1-用户认证分析">1 用户认证分析</h1>
<p><img src="/posts/project-0/20220528165279/image-20220528165358321.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份认证成功后，需要识别用户的角色然后授权访问对应的功能。</p>
<h2 id="11-认证与授权">1.1 认证与授权</h2>
<p><strong>身份认证</strong></p>
<p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：用户名密码登录，指纹打卡等方式。说通俗点，就相当于校验用户账号密码是否正确。</p>
<p><strong>用户授权</strong></p>
<p>用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。</p>
<h2 id="12-单点登录">1.2 单点登录</h2>
<p><img src="/posts/project-0/20220528165279/image-20220528165407469.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>用户访问的项目中，至少有3个微服务需要识别用户身份，如果用户访问每个微服务都登录一次就太麻烦了，为了提高用户的体验，我们需要实现让用户在一个系统中登录，其他任意受信任的系统都可以访问，这个功能就叫单点登录。</p>
<p>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。 SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统</p>
<h2 id="13-第三方账号登录">1.3 第三方账号登录</h2>
<h3 id="131-第三方登录介绍">1.3.1 第三方登录介绍</h3>
<p>随着国内及国外巨头们的平台开放战略以及移动互联网的发展，第三方登录已经不是一个陌生的产品设计概念了。 所谓的第三方登录，是说基于用户在第三方平台上已有的账号和密码来快速完成己方应用的登录或者注册的功能。而这里的第三方平台，一般是已经拥有大量用户的平台，国外的比如Facebook，Twitter等，国内的比如微博、微信、QQ等。
<img src="/posts/project-0/20220528165279/image-20220528165414998.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="132-第三方登录优点">1.3.2 第三方登录优点</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.相比于本地注册，第三方登录一般来说比较方便、快捷，能够显著降低用户的注册和登录成本，方便用户实现快捷登录或注册。
</span></span><span class="line"><span class="cl">2.不用费尽心思地应付本地注册对账户名和密码的各种限制，如果不考虑昵称的重复性要求，几乎可以直接一个账号走遍天下，再也不用在大脑或者什么地方记住N多不同的网站或App的账号和密码，整个世界一下子清静了。
</span></span><span class="line"><span class="cl">3.在第一次绑定成功之后，之后用户便可以实现一键登录，使得后续的登录操作比起应用内的登录来容易了很多。
</span></span><span class="line"><span class="cl">4.对于某些喜欢社交，并希望将更多自己的生活内容展示给朋友的人来说，第三方登录可以实现把用户在应用内的活动同步到第三方平台上，省去了用户手动发布动态的麻烦。但对于某些比较注重个人隐私的用户来说，则会有一些担忧，所以这个优点是有前提的。
</span></span><span class="line"><span class="cl">5.因为降低了用户的注册或登录成本，从而减少由于本地注册的繁琐性而带来的隐形用户流失，最终提高注册转化率。
</span></span><span class="line"><span class="cl">6.对于某些应用来说，使用第三方登录完全可以满足自己的需要，因此不必要设计和开发一套自己的账户体系。
</span></span><span class="line"><span class="cl">7.通过授权，可以通过在第三方平台上分享用户在应用内的活动在第三方平台上宣传自己，从而增加产品知名度。
</span></span><span class="line"><span class="cl">8.通过授权，可以获得该用户在第三方平台上的好友或粉丝等社交信息，从而后续可以针对用户的社交关系网进行有目的性的营销宣传，为产品的市场推广提供另一种渠道。
</span></span></code></pre></div><h3 id="133-第三方认证">1.3.3 第三方认证</h3>
<p>当需要访问第三方系统的资源时需要首先通过第三方系统的认证（例如：微信认证），由第三方系统对用户认证通过，并授权资源的访问权限。
<img src="/posts/project-0/20220528165279/image-20220528165423568.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="2-认证技术方案">2 认证技术方案</h1>
<h2 id="21-单点登录技术方案">2.1 单点登录技术方案</h2>
<p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如： MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：
<img src="/posts/project-0/20220528165279/image-20220528165436164.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>单点登录的特点是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1、认证系统为独立的系统。 
</span></span><span class="line"><span class="cl">2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。 
</span></span><span class="line"><span class="cl">3、用户身份信息存储在Redis集群。
</span></span></code></pre></div><p>Java中有很多用户认证的框架都可以实现单点登录：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> 1、Apache Shiro. 
</span></span><span class="line"><span class="cl"> 2、CAS 
</span></span><span class="line"><span class="cl"> 3、Spring security CAS    
</span></span></code></pre></div><h2 id="22-oauth2认证">2.2 Oauth2认证</h2>
<p>OAuth（开放授权）是一个开放标准，允许用户授权第三方移动应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方移动应用或分享他们数据的所有内容，OAuth2.0是OAuth协议的延续版本。</p>
<h3 id="221-oauth2认证流程">2.2.1 Oauth2认证流程</h3>
<p>第三方认证技术方案最主要是解决认证协议的通用标准 问题，因为要实现 跨系统认证，各系统之间要遵循一定的接口协议。
OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务都Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。
Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。
参考：https://baike.baidu.com/item/oAuth/7153134?fr=aladdin
Oauth协议：https://tools.ietf.org/html/rfc6749
下边分析一个Oauth2认证的例子，网站使用微信认证的过程：
<img src="/posts/project-0/20220528165279/image-20220528165447243.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>1.客户端请求第三方授权</p>
<p>用户进入登录页面，点击QQ的图标以微信账号登录系统，用户是自己在QQ信息的资源拥有者。
<img src="/posts/project-0/20220528165279/image-20220528165455417.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>点击“用QQ账号登录”出现一个二维码，此时用户扫描二维码，开始给优就业官网授权。 <br>
<img src="/posts/project-0/20220528165279/image-20220528165502304.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>2.资源拥有者同意给客户端授权</p>
<p>资源拥有者扫描二维码表示资源拥有者同意给客户端授权，QQ会对资源拥有者的身份进行验证， 验证通过后，QQ会询问用户是否给授权优就业官网访问自己的QQ数据，用户点击“确认登录”表示同意授权，QQ认证服务器会 颁发一个授权码，并重定向到优就业官网。</p>
<p>3.客户端获取到授权码，请求认证服务器申请令牌 此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。</p>
<p>4.认证服务器向客户端响应令牌 认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。 此交互过程用户看不到，当客户端拿到令牌后，用户在优就业官网看到已经登录成功。</p>
<p>5.客户端请求资源服务器的资源 客户端携带令牌访问资源服务器的资源。 优就业官网携带令牌请求访问微信服务器获取用户的基本信息。</p>
<p>6.资源服务器返回受保护资源 资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。 注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务资源服务器通常要请求认证 服务器来校验令牌的合法性。</p>
<p>Oauth2.0认证流程如下： 引自Oauth2.0协议rfc6749 <a class="link" href="/posts/project-0/https://tools.ietf.org/html/rfc6749"  target="_blank" rel="noopener"
    >https://tools.ietf.org/html/rfc6749</a> <br>
<img src="/posts/project-0/20220528165279/image-20220528165511527.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>Oauth2包括以下角色：</p>
<p>1、客户端 本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：东易买IOS客户端、东易买Web客户端（浏览器端）、微信客户端等。</p>
<p>2、资源拥有者 通常为用户，也可以是应用程序，即该资源的拥有者。</p>
<p>3、授权服务器（也称认证服务器） 用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授 权后方可访问。</p>
<p>4、资源服务器 存储资源的服务器，比如，东易买商城用户管理服务器存储了东易买的用户信息等。客户端最终访问资源服务器获取资源信息。</p>
<h3 id="222-oauth2在项目的应用">2.2.2 Oauth2在项目的应用</h3>
<p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目使用Oauth2实现如 下目标：</p>
<p>1、东易买访问第三方系统的资源</p>
<p>2、外部系统访问东易买商城的资源</p>
<p>3、东易买前端（客户端） 访问东易买微服务的资源。</p>
<p>4、东易买微服务之间访问资源，例如：微服务A访问微服务B的资源，B访问A的资源。</p>
<h2 id="23-spring-security-oauth2认证解决方案">2.3 Spring security Oauth2认证解决方案</h2>
<p>本项目采用 Spring security + Oauth2完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图： <br>
<img src="/posts/project-0/20220528165279/image-20220528165524869.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>1、用户请求认证服务完成认证。</p>
<p>2、认证服务下发用户身份令牌，拥有身份令牌表示身份合法。</p>
<p>3、用户携带令牌请求资源服务，请求资源服务必先经过网关。</p>
<p>4、网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问。</p>
<p>5、资源服务获取令牌，根据令牌完成授权。</p>
<p>6、资源服务完成授权则响应资源信息。</p>
<h1 id="3-security-oauth20入门">3 Security Oauth2.0入门</h1>
<h2 id="31-学习知识点说明">3.1 学习知识点说明</h2>
<p>本项目认证服务基于Spring Security Oauth2进行构建，并在其基础上作了一些扩展，采用JWT令牌机制，并自定义了用户身份信息的内容。 本教程的主要目标是学习在项目中集成Spring Security Oauth2的方法和流程，通过 spring Security Oauth2的研究需要达到以下目标：</p>
<p>1、理解Oauth2的授权码认证流程及密码认证的流程。</p>
<p>2、理解spring Security Oauth2的工作流程。</p>
<p>3、掌握资源服务集成spring Security框架完成Oauth2认证的流程。</p>
<h2 id="32-搭建认证服务器">3.2 搭建认证服务器</h2>
<h3 id="321-创建认证模块">3.2.1 创建认证模块</h3>
<p>创建认证服务器模块<code>dongyimai-user-oauth</code>的模块，如下图：
<img src="/posts/project-0/20220528165279/image-20220528165533250.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="322-pomxml配置">3.2.2 pom.xml配置</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">&lt;dependencies&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">&lt;dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">&lt;dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">&lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">&lt;/dependencies&gt;</span><span class="w">
</span></span></span></code></pre></div><h3 id="323-applicationyml配置">3.2.3 application.yml配置</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user-auth </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8761/eureka</span><span class="w">
</span></span></span></code></pre></div><h3 id="324-编写springsecurity配置类websecurityconfig">3.2.4 编写SpringSecurity配置类WebSecurityConfig</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableWebSecurity</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//配置springsecurity拦截规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">http</span><span class="o">.</span><span class="na">requestMatchers</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span><span class="c1">//任何请求都要拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span><span class="c1">//登录界面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span><span class="c1">//跨站攻击防御禁用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//认证管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//声明自定义认证对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;userDetailsService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetailsService</span> <span class="nf">userDetailsServiceBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">CreateUserDetailsService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">UserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//启用自定义认证对象进行认证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">return</span>   <span class="k">this</span><span class="o">.</span><span class="na">CreateUserDetailsService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//自定义认证，声明用户登录账号、密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">UserDetailsService</span> <span class="nf">CreateUserDetailsService</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserDetails</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserDetails</span> <span class="n">adminUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">)).</span><span class="na">authorities</span><span class="o">(</span><span class="s">&#34;ADMIN&#34;</span><span class="o">,</span> <span class="s">&#34;USER&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserDetails</span> <span class="n">OneUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;user1&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">)).</span><span class="na">authorities</span><span class="o">(</span><span class="s">&#34;ADMIN&#34;</span><span class="o">,</span> <span class="s">&#34;USER&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserDetails</span> <span class="n">TowUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;user2&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;456&#34;</span><span class="o">)).</span><span class="na">authorities</span><span class="o">(</span><span class="s">&#34;USER&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">adminUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">OneUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">TowUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">InMemoryUserDetailsManager</span><span class="o">(</span><span class="n">users</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//声明密码加密器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><strong>注意</strong>：@EnableWebSecurity启用springSecurity</p>
<h3 id="325-编写springsecurityoauth2认证服务器配置类authorizationserverconfiguration">3.2.5 编写SpringSecurityOauth2认证服务器配置类AuthorizationServerConfiguration</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableAuthorizationServer</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServerConfiguration</span> <span class="kd">extends</span> <span class="n">AuthorizationServerConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//注入密码加密器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//注入自定义认证对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//注入认证管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//授权服务器端点访问权限验证方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">security</span><span class="o">.</span><span class="na">allowFormAuthenticationForClients</span><span class="o">()</span><span class="c1">//访问服务器端点需要进行客户端身份验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">)</span><span class="c1">//设置客户端密码加密机制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">tokenKeyAccess</span><span class="o">(</span><span class="s">&#34;permitAll()&#34;</span><span class="o">)</span><span class="c1">//开启token生成功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">checkTokenAccess</span><span class="o">(</span><span class="s">&#34;permitAll()&#34;</span><span class="o">);</span><span class="c1">//开启token校验功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Spring Security OAuth2会公开了两个端点，用于检查令牌（/oauth/check_token和/oauth/token_key），这些端点默认受保护denyAll()。tokenKeyAccess（）和checkTokenAccess（）方法会打开这些端点以供使用。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//客户端账号配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//在内存中创建账号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">clients</span><span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// admin，授权码认证、密码认证、客户端认证、简单认证、刷新token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span> <span class="c1">//账号名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">))</span><span class="c1">//密码，要设置加密
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">resourceIds</span><span class="o">(</span><span class="s">&#34;oauth2-resource&#34;</span><span class="o">,</span><span class="s">&#34;dongyimai-user&#34;</span><span class="o">,</span> <span class="s">&#34;dongyimai-goods&#34;</span><span class="o">)</span><span class="c1">//资源编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="s">&#34;server&#34;</span><span class="o">,</span><span class="s">&#34;app&#34;</span><span class="o">)</span><span class="c1">//作用范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">authorizedGrantTypes</span><span class="o">(</span><span class="s">&#34;authorization_code&#34;</span><span class="o">,</span> <span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="s">&#34;refresh_token&#34;</span><span class="o">,</span> <span class="s">&#34;client_credentials&#34;</span><span class="o">,</span><span class="s">&#34;implicit&#34;</span><span class="o">)</span><span class="c1">//登录授权模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">redirectUris</span><span class="o">(</span><span class="s">&#34;http://localhost&#34;</span><span class="o">);</span><span class="c1">//登录成功跳转地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//端点令牌存储方式、关联自定义认证对象、认证管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">endpoints</span><span class="o">.</span><span class="na">tokenStore</span><span class="o">(</span><span class="k">new</span> <span class="n">InMemoryTokenStore</span><span class="o">())</span> <span class="c1">//令牌存储到内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">)</span><span class="c1">//认证管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">)</span><span class="c1">//自定义认证类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">.</span><span class="na">allowedTokenEndpointRequestMethods</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">);</span><span class="c1">//允许端点访问方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><strong>注意</strong>：@EnableAuthorizationServer 启用OAuth2授权服务器</p>
<p><strong>注意</strong>：资源编号需要填写默认的：oauth2-resource</p>
<h3 id="326-编写主启动类">3.2.6 编写主启动类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOauth2Application</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">UserOauth2Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="327-启动授权认证服务">3.2.7 启动授权认证服务</h3>
<p>启动之前，记得先启动eureka，再启动该授权认证工程。</p>
<h2 id="33-oauth2授权模式">3.3 Oauth2授权模式</h2>
<h3 id="331-oauth2授权模式">3.3.1 Oauth2授权模式</h3>
<p>Oauth2有以下授权模式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">1.授权码模式（Authorization</span> <span class="s">Code）</span>
</span></span><span class="line"><span class="cl"><span class="na">2.密码模式（Resource</span> <span class="s">Owner Password Credentials）</span>
</span></span><span class="line"><span class="cl"><span class="na">3.客户端模式（Client</span> <span class="s">Credentials） </span>
</span></span><span class="line"><span class="cl"><span class="na">4.隐式授权模式（Implicit）</span> 
</span></span></code></pre></div><h3 id="332-授权码授权实现">3.3.2 授权码授权实现</h3>
<p>上边例举的优就业官网使用QQ认证的过程就是授权码模式，流程如下：</p>
<p>1、客户端请求第三方授权</p>
<p>2、用户(资源拥有者)同意给客户端授权</p>
<p>3、客户端获取到授权码，请求认证服务器申请 令牌</p>
<p>4、认证服务器向客户端响应令牌</p>
<p>5、客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权</p>
<p>6、资源服务器返回受保护资源</p>
<p><strong>(1)申请授权码</strong></p>
<p>请求认证服务获取授权码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Get请求：
</span></span><span class="line"><span class="cl">http://localhost:9100/oauth/authorize?client_id=admin&amp;response_type=code&amp;scop=app&amp;redirect_uri=http://localhost
</span></span></code></pre></div><p>参数列表如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">client_id：客户端id，和授权配置类中设置的客户端id一致。</span> 
</span></span><span class="line"><span class="cl"><span class="na">response_type：授权码模式固定为code</span> 
</span></span><span class="line"><span class="cl"><span class="na">scop：客户端范围，和授权配置类中设置的scop一致。</span> 
</span></span><span class="line"><span class="cl"><span class="err">redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）</span>
</span></span></code></pre></div><p>首先跳转到登录页面：
<img src="/posts/project-0/20220528165279/image-20220528165552836.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>输入账号和密码，点击Login。 Spring Security在WebSecurityConfig类的CreateUserDetailsService方法配置了用户和密码。
<img src="/posts/project-0/20220528165279/image-20220528165557800.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>接下来进入授权页面：
<img src="/posts/project-0/20220528165279/image-20220528165604352.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>点击Authorize,接下来返回授权码： 认证服务携带授权码跳转redirect_uri,code=Vi2KWa就是返回的授权码
<img src="/posts/project-0/20220528165279/image-20220528165610361.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>(2)申请令牌</strong></p>
<p>拿到授权码后，申请令牌。 Post请求：http://localhost:9100/oauth/token 参数如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">grant_type：授权类型，填写authorization_code，表示授权码模式 
</span></span><span class="line"><span class="cl">code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。 
</span></span><span class="line"><span class="cl">redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。 
</span></span></code></pre></div><p>此链接需要使用 http Basic认证。 什么是http Basic认证？ http协议定义的一种认证方式，将客户端id和客户端密码按照“客户端ID:客户端密码”的格式拼接，并用base64编 码，放在header中请求服务端，一个例子： Authorization：Basic WGNXZWJBcHA6WGNXZWJBcHA=WGNXZWJBcHA6WGNXZWJBcHA= 是用户名:密码的base64编码。 认证失败服务端返回 401 Unauthorized。</p>
<p>以上测试使用postman完成：</p>
<p>http basic认证： <br>
<img src="/posts/project-0/20220528165279/image-20220528165617452.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528165279/image-20220528165623879.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>body参数：</p>
<p>grant_type: authorization_code</p>
<p>code:y7o1pF                       //注意code值，从前面登录获取到的授权码获取</p>
<p>redirect_uri: http://localhost</p>
<p>点击发送： 申请令牌成功 <br>
<img src="/posts/project-0/20220528165279/image-20220528165629179.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>返回信如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">access_token：访问令牌，携带此令牌访问资源</span> 
</span></span><span class="line"><span class="cl"><span class="na">token_type：有MAC</span> <span class="s">Token与Bearer Token两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 Bearer Token（http://www.rfcreader.com/#rfc6750）。 </span>
</span></span><span class="line"><span class="cl"><span class="na">refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。</span> 
</span></span><span class="line"><span class="cl"><span class="na">expires_in：过期时间，单位为秒。</span> 
</span></span><span class="line"><span class="cl"><span class="na">scope：范围，与定义的客户端范围一致。</span>    
</span></span></code></pre></div><p><strong>(3)令牌校验</strong></p>
<p>Spring Security Oauth2提供校验令牌的端点，如下：</p>
<p>Get: http://localhost:9100/oauth/check_token?token= [access_token]</p>
<p>参数：</p>
<p>token：令牌</p>
<p>使用postman测试如下:
<img src="/posts/project-0/20220528165279/image-20220528165640240.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如果令牌校验失败，会出现如下结果：
<img src="/posts/project-0/20220528165279/image-20220528165645729.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>如果令牌过期了，会如下如下结果：
<img src="/posts/project-0/20220528165279/image-20220528165651171.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><strong>(4)刷新令牌</strong></p>
<p>刷新令牌是当令牌快过期时重新生成一个令牌，它于授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。</p>
<p>测试如下： Post：http://localhost:9100/oauth/token</p>
<p>参数：</p>
<p>grant_type： 固定为 refresh_token</p>
<p>refresh_token：刷新令牌（注意值不是access_token，而是refresh_token） <br>
<img src="/posts/project-0/20220528165279/image-20220528165659031.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528165279/image-20220528165703970.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="333-密码授权实现">3.3.3 密码授权实现</h3>
<p><strong>(1)认证</strong></p>
<p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是直接 通过用户名和密码即可申请令牌。</p>
<p>测试如下：</p>
<p>Post请求：http://localhost:9100/oauth/token</p>
<p>参数：</p>
<p>grant_type：密码模式授权填写password</p>
<p>username：账号</p>
<p>password：密码</p>
<p>注意首先要设置http basic认证： <br>
<img src="/posts/project-0/20220528165279/image-20220528165712564.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>然后在设置账号密码
<img src="/posts/project-0/20220528165279/image-20220528165718035.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="334-客户端模式授权实现">3.3.4 客户端模式授权实现</h3>
<p><strong>(1)认证</strong></p>
<p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是直接 通过用户名和密码即可申请令牌。</p>
<p>测试如下：</p>
<p>Post请求：http://localhost:9100/oauth/token</p>
<p>参数：</p>
<p>grant_type：密码模式授权填写client_credentials</p>
<p>注意首先要设置http basic认证： <br>
<img src="/posts/project-0/20220528165279/image-20220528165725552.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220528165279/image-20220528165730127.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="335-隐式授权实现">3.3.5 隐式授权实现</h3>
<p>隐式授权模式要求：用户登录并对第三方应用进行授权，直接返回访问token，通过token访问资源</p>
<p>相比授权码模式，它少了一次授权码的颁发与客户端使用授权码换取token的过程。</p>
<h4 id="隐式授权模式适用场景">隐式授权模式适用场景</h4>
<p>适用场景有以下几个条件：</p>
<ul>
<li>用户参与：使用隐式授权需要<strong>与用户交互</strong>，用户对授权服务器进行登录与授权</li>
<li>单页应用：SPA前端，<strong>没有后端或者后端属于授权方</strong></li>
<li>客户端密码：访问授权时，<strong>不需要</strong>带第三方应用secret，前提是资源服务校验token使用的client信息与客户端（第三方应用）不同，且配置了secret</li>
<li>前端：<strong>必须要有前端</strong>，否则无法使用授权功能</li>
<li>客户端后端：Options，仅当应用前后端不分离MVC场景</li>
<li>资源所属方：授权方</li>
</ul>
<p><strong>获取token</strong></p>
<p>请求认证服务获取授权码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Get请求：
</span></span><span class="line"><span class="cl">http://localhost:9100/oauth/authorize?client_id=admin&amp;redirect_uri=http://localhost&amp;response_type=token&amp;scope=app
</span></span></code></pre></div><p>参数列表如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">client_id：客户端id，和授权配置类中设置的客户端id一致。</span> 
</span></span><span class="line"><span class="cl"><span class="err">response_type：隐式模式固定为token</span>
</span></span><span class="line"><span class="cl"><span class="na">scop：客户端范围，和授权配置类中设置的scop一致。</span> 
</span></span><span class="line"><span class="cl"><span class="err">redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上access_token（令牌）</span>
</span></span></code></pre></div><p>首先跳转到登录页面：
<img src="/posts/project-0/20220528165279/image-20220528165739449.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>输入账号和密码，点击Login。 Spring Security在WebSecurityConfig类的CreateUserDetailsService方法配置了用户和密码。</p>
<p>接下来进入授权页面：
<img src="/posts/project-0/20220528165279/image-20220528165744656.jpeg"
    
    
    
    loading="lazy"
    
    
></p>
<p>点击Authorize,接下来返回令牌
<img src="/posts/project-0/20220528165279/image-20220528165750744.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="4-授权服务生成jwt令牌及资源服务授权流程">4 授权服务生成JWT令牌及资源服务授权流程</h1>
<h2 id="41-资源服务授权流程">4.1 资源服务授权流程</h2>
<p>(1)传统授权流程
<img src="/posts/project-0/20220528165279/image-20220528165756500.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>资源服务器授权流程如上图，客户端先去授权服务器申请令牌，申请令牌后，携带令牌访问资源服务器，资源服务器访问授权服务校验令牌的合法性，授权服务会返回校验结果，如果校验成功会返回用户信息给资源服务器，资源服务器如果接收到的校验结果通过了，则返回资源给客户端。</p>
<p>传统授权方法的问题是用户每次请求资源服务，资源服务都需要携带令牌访问认证服务去校验令牌的合法性，并根 据令牌获取用户的相关信息，性能低下。</p>
<p>(2)公钥私钥授权流程
<img src="/posts/project-0/20220528165279/image-20220528165803201.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>传统的授权模式性能低下，每次都需要请求授权服务校验令牌合法性，我们可以利用公钥私钥完成对令牌的加密，如果加密解密成功，则表示令牌合法，如果加密解密失败，则表示令牌无效不合法，合法则允许访问资源服务器的资源，解密失败，则不允许访问资源服务器资源。</p>
<p>上图的业务流程如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">1、客户端请求认证服务申请令牌</span>
</span></span><span class="line"><span class="cl"><span class="err">2、认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌。</span>
</span></span><span class="line"><span class="cl"><span class="na">3、客户端携带令牌访问资源服务客户端在Http</span> <span class="s">header 中添加： Authorization：Bearer 令牌。</span>
</span></span><span class="line"><span class="cl"><span class="err">4、资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性。</span>
</span></span><span class="line"><span class="cl"><span class="err">5、令牌有效，资源服务向客户端响应资源信息</span>
</span></span></code></pre></div><h2 id="42-公钥私钥">4.2 公钥私钥</h2>
<p>在对称加密的时代，加密和解密用的是同一个密钥，这个密钥既用于加密，又用于解密。这样做有一个明显的缺点，如果两个人之间传输文件，两个人都要知道密钥，如果是三个人呢，五个人呢？于是就产生了非对称加密，用一个密钥进行加密（公钥），用另一个密钥进行解密（私钥）。</p>
<h3 id="421-公钥私钥原理">4.2.1 公钥私钥原理</h3>
<p>张三有两把钥匙，一把是公钥，另一把是私钥。
<img src="/posts/project-0/20220528165279/image-20220528165812206.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>张三把公钥送给他的朋友们&mdash;-李四、王五、赵六&mdash;-每人一把。
<img src="/posts/project-0/20220528165279/image-20220528165818173.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>李四要给张三写一封保密的信。她写完后用张三的公钥加密，就可以达到保密的效果。
<img src="/posts/project-0/20220528165279/image-20220528165823463.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>张三收信后，用私钥解密，就看到了信件内容。这里要强调的是，只要张三的私钥不泄露，这封信就是安全的，即使落在别人手里，也无法解密。
<img src="/posts/project-0/20220528165279/image-20220528165831047.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>张三给李四回信，决定采用&quot;数字签名&quot;。他写完后先用Hash函数，生成信件的摘要（digest）。张三将这个签名，附在信件下面，一起发给李四。
<img src="/posts/project-0/20220528165279/image-20220528165836990.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>李四收信后，取下数字签名，用张三的公钥解密，得到信件的摘要。由此证明，这封信确实是张三发出的。李四再对信件本身使用Hash函数，将得到的结果，与上一步得到的摘要进行对比。如果两者一致，就证明这封信未被修改过。
<img src="/posts/project-0/20220528165279/image-20220528165842418.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="422-生成私钥公钥">4.2.2 生成私钥公钥</h3>
<p>Spring Security 提供对JWT的支持，本节我们使用Spring Security 提供的JwtHelper来创建JWT令牌，校验JWT令牌 等操作。 这里JWT令牌我们采用非对称算法进行加密，所以我们要先生成公钥和私钥。</p>
<p>(1)生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥</p>
<p>在Centos7服务器安装配置好JAVA环境：</p>
<p>创建一个文件夹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir key
</span></span><span class="line"><span class="cl">cd key
</span></span></code></pre></div><p>在该文件夹下执行如下命令行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">keytool</span> <span class="s">-genkeypair -alias dongyimai -keyalg RSA -keypass dongyimai -keystore dongyimai.jks -storepass dongyimai</span>
</span></span></code></pre></div><p>Keytool 是一个java提供的证书管理工具</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">-alias：密钥的别名</span> 
</span></span><span class="line"><span class="cl"><span class="na">-keyalg：使用的hash算法</span> 
</span></span><span class="line"><span class="cl"><span class="na">-keypass：密钥的访问密码</span> 
</span></span><span class="line"><span class="cl"><span class="na">-keystore：密钥库文件名，xc.keystore保存了生成的证书</span> 
</span></span><span class="line"><span class="cl"><span class="na">-storepass：密钥库的访问密码</span> 
</span></span></code></pre></div><p><img src="/posts/project-0/20220528165279/image-20220528165859534.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)查询证书信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">keytool</span> <span class="s">-list -keystore dongyimai.jks</span>
</span></span></code></pre></div><p><img src="/posts/project-0/20220528165279/image-20220528165905628.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(3)删除别名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">keytool</span> <span class="s">-delete -alias dongyimai -keystore dongyimai.jks</span>
</span></span></code></pre></div><h3 id="423-导出公钥">4.2.3 导出公钥</h3>
<p>openssl是一个加解密工具包，这里使用openssl来导出公钥信息。</p>
<p>openssl：https://www.openssl.org/</p>
<p>进入秘钥所在目录</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /root/key
</span></span></code></pre></div><p>进入dongyimai.jks文件所在目录执行如下命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">keytool -list -rfc --keystore dongyimai.jks <span class="p">|</span> openssl x509 -inform pem -pubkey
</span></span></code></pre></div><p><img src="/posts/project-0/20220528165279/image-20220528165944281.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>下面段内容是公钥</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">-----BEGIN</span> <span class="s">PUBLIC KEY-----</span>
</span></span><span class="line"><span class="cl"><span class="err">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAm79WjnLSh41Wt+J3K44rAfUwYVHEz5Ii2zXKdA+tx5/MFq7iLbBPoc6C2Ol+o+wVJVmV3Y1QAYdyGYMWIOJpFwggc+T4CmZNlCDxKEwwdB0ic63URGhTz5vf9lUAcluGC+gu5O++cZLjnUrRQYRjJGNewx8BkAVIRNAZn1i3vTOzdkYhqD6Ev8PyCCI5NGO5E4pZ3vj6F7HvrTjj7FKcI3J5iaXwAF9OiXJYIJpbB1+EBaWksoFSF5MalbwbmE22RJ6fNtgHJYNxhQfzMVip/x5jSwL5fcAJyBS0wzcErTCHYJcWH2tlWctp4e6Tjq23c98bg42nf+i2eqko6o90sQIDAQAB</span>
</span></span><span class="line"><span class="cl"><span class="na">-----END</span> <span class="s">PUBLIC KEY-----</span>
</span></span></code></pre></div><p>将上边的公钥拷贝到文本public.key文件中，**注意：**合并为一行,可以将它放到需要实现授权认证的工程中。</p>
<h2 id="43-使用私钥公钥生成解析jwt令牌">4.3 使用私钥公钥生成、解析JWT令牌</h2>
<p>(1)创建令牌数据</p>
<p>在dongyimai-user-oauth工程中创建测试类com.offcn.token.CreateJwtTest，使用它来创建令牌信息，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.dongyimai.oauth</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.thoughtworks.xstream.core.util.Base64Encoder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.io.ClassPathResource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.jwt.Jwt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.jwt.JwtHelper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.jwt.crypto.sign.RsaSigner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.security.rsa.crypto.KeyStoreKeyFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.KeyPair</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.interfaces.RSAPrivateKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.security.interfaces.RSAPublicKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateJwtTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 创建令牌测试
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreateToken</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//证书文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">key_location</span><span class="o">=</span><span class="s">&#34;dongyimai.jks&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//秘钥库密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">key_password</span><span class="o">=</span><span class="s">&#34;dongyimai&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//秘钥密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">keypwd</span> <span class="o">=</span> <span class="s">&#34;dongyimai&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//秘钥别名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">alias</span> <span class="o">=</span> <span class="s">&#34;dongyimai&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//访问证书路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ClassPathResource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="n">key_location</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//创建秘钥工厂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">KeyStoreKeyFactory</span> <span class="n">keyStoreKeyFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyStoreKeyFactory</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span><span class="n">key_password</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//读取指定别名秘钥对(公钥、私钥)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">KeyPair</span> <span class="n">keyPair</span> <span class="o">=</span> <span class="n">keyStoreKeyFactory</span><span class="o">.</span><span class="na">getKeyPair</span><span class="o">(</span><span class="n">alias</span><span class="o">,</span><span class="n">keypwd</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//  RSAPublicKey rsaPublicKey= (RSAPublicKey) keyPair.getPublic();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//  Base64Encoder base64Encoder = new Base64Encoder();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//  String encode = base64Encoder.encode(rsaPublicKey.getEncoded());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//  System.out.println(&#34;公钥:-----BEGIN PUBLIC KEY-----&#34;+encode+&#34;-----END PUBLIC KEY-----&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取私钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RSAPrivateKey</span> <span class="n">rsaPrivate</span> <span class="o">=</span> <span class="o">(</span><span class="n">RSAPrivateKey</span><span class="o">)</span> <span class="n">keyPair</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//定义Payload载荷
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">tokenMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">tokenMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tokenMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;ujiuye&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tokenMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;roles&#34;</span><span class="o">,</span> <span class="s">&#34;ROLE_VIP,ROLE_USER&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//使用私钥生成Jwt令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Jwt</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">JwtHelper</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">tokenMap</span><span class="o">),</span> <span class="k">new</span> <span class="n">RsaSigner</span><span class="o">(</span><span class="n">rsaPrivate</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//取出令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getEncoded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;token:&#34;</span><span class="o">+</span><span class="n">encoded</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>运行后的结果如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">token</span><span class="o">:</span><span class="s">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6IlJPTEVfVklQLFJPTEVfVVNFUiIsIm5hbWUiOiJ1aml1eWUiLCJpZCI6IjEifQ.G7hIUJV4a9PihurY4gfCdkqZqE0g9bRWU5l5PY0X1kv8LAt_-Otdi4ryLxgo2iM0FUI9GoT_LnggX3fSF-U3EaIu-pphyrvo2raz9kIWxEN_xLIW-Z3GHG05pOAhJE2OwF6Y-UYd3J1nGc3WMePdenuFRgLlJXw9d3fsalk5pC3fBBk4a6RKTRJveleRZxG58VP856XtrathNMl6HSfT37mwvMm-tTL1vzJgyyO5JM6Px38b9L4jpbsn5R1HX1JDve5RRFsbJHOgRycY2Crj_bm6jbWm-3jgj0w0N1MjA1JH86-DXEunciBgMjZ9BWRUDOe8Q8UhZjUwPVCKLzmcxw</span>
</span></span></code></pre></div><p>(2)解析令牌</p>
<p>上面创建令牌后，我们可以对JWT令牌进行解析，这里解析需要用到公钥，我们可以将之前生成的公钥public.key拷贝出来用字符串变量token存储，然后通过公钥解密。</p>
<p>在dongyimai-user-oauth创建测试类com.offcn.token.ParseJwtTest实现解析校验令牌数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ParseJwtTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 校验令牌
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testParseToken</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="s">&#34;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6IlJPTEVfVklQLFJPTEVfVVNFUiIsIm5hbWUiOiJpdGhlaW1hIiwiaWQiOiIxIn0.IR9Qu9ZqYZ2gU2qgAziyT38UhEeL4Oi69ko-dzC_P9-Vjz40hwZDqxl8wZ-W2WAw1eWGIHV1EYDjg0-eilogJZ5UikyWw1bewXCpvlM-ZRtYQQqHFTlfDiVcFetyTayaskwa-x_BVS4pTWAskiaIKbKR4KcME2E5o1rEek-3YPkqAiZ6WP1UOmpaCJDaaFSdninqG0gzSCuGvLuG40x0Ngpfk7mPOecsIi5cbJElpdYUsCr9oXc53ROyfvYpHjzV7c2D5eIZu3leUPXRvvVAPJFEcSBiisxUSEeiGpmuQhaFZd1g-yJ1WQrixFvehMeLX2XU6W1nlL5ARTpQf_Jjiw&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//公钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">publickey</span> <span class="o">=</span> <span class="s">&#34;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//校验Jwt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Jwt</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">JwtHelper</span><span class="o">.</span><span class="na">decodeAndVerify</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="k">new</span> <span class="n">RsaVerifier</span><span class="o">(</span><span class="n">publickey</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//获取Jwt原始令牌内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getClaims</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取jwt令牌解码内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getEncoded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">encoded</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>运行结果：
<img src="/posts/project-0/20220528165279/image-20220528170000772.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="44配置oauth2认证服务器实现jwt令牌">4.4、配置Oauth2认证服务器实现JWT令牌</h2>
<h3 id="441拷贝私钥到资源目录">4.4.1、拷贝私钥到资源目录</h3>
<p>拷贝私钥dongyimai.jks到resources目录
<img src="/posts/project-0/20220528165279/image-20220528170007852.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="442修改配置文件applicationyml配置秘钥相关参数">4.4.2、修改配置文件application.yml配置秘钥相关参数</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">encrypt</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">key-store</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:dongyimai.jks </span><span class="w"> </span><span class="c">#秘钥文件名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai </span><span class="w"> </span><span class="c">#别名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai </span><span class="w"> </span><span class="c">#密码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l">dongyimai  </span><span class="w"> </span><span class="c">#密钥库的访问密码</span><span class="w">
</span></span></span></code></pre></div><h3 id="443修改配置类authorizationserverconfiguration">4.4.3、修改配置类AuthorizationServerConfiguration</h3>
<p>秘钥证书读取方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//创建证书读取工具类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;keyProp&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">KeyProperties</span> <span class="nf">keyProperties</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">KeyProperties</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//引用证书读取工具类，根据对象名引用避免引用其他的对象失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;keyProp&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">KeyProperties</span> <span class="n">keyProperties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//读取证书方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">KeyPair</span> <span class="nf">keyPair</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">KeyStoreKeyFactory</span><span class="o">(</span><span class="n">keyProperties</span><span class="o">.</span><span class="na">getKeyStore</span><span class="o">().</span><span class="na">getLocation</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">keyProperties</span><span class="o">.</span><span class="na">getKeyStore</span><span class="o">().</span><span class="na">getSecret</span><span class="o">().</span><span class="na">toCharArray</span><span class="o">()).</span><span class="na">getKeyPair</span><span class="o">(</span><span class="n">keyProperties</span><span class="o">.</span><span class="na">getKeyStore</span><span class="o">().</span><span class="na">getAlias</span><span class="o">(),</span><span class="n">keyProperties</span><span class="o">.</span><span class="na">getKeyStore</span><span class="o">().</span><span class="na">getSecret</span><span class="o">().</span><span class="na">toCharArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>编写普通令牌转换成JWT格式令牌的转换方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//创建JwtAccessTokenConverter用来生成JWT令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">JwtAccessTokenConverter</span> <span class="nf">jwtAccessTokenConverter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">JwtAccessTokenConverter</span> <span class="n">jwtAccessTokenConverter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtAccessTokenConverter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//关联私钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">jwtAccessTokenConverter</span><span class="o">.</span><span class="na">setKeyPair</span><span class="o">(</span><span class="n">keyPair</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">jwtAccessTokenConverter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>修改配置方法public void configure(AuthorizationServerEndpointsConfigurer endpoints)指定令牌按照JWT令牌生成</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//端点令牌存储方式、关联自定义认证对象、认证管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">endpoints</span><span class="o">.</span><span class="na">tokenStore</span><span class="o">(</span><span class="k">new</span> <span class="n">JwtTokenStore</span><span class="o">(</span><span class="n">jwtAccessTokenConverter</span><span class="o">()))</span> <span class="c1">//令牌存储格式jwt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">.</span><span class="na">accessTokenConverter</span><span class="o">(</span><span class="n">jwtAccessTokenConverter</span><span class="o">())</span><span class="c1">//使用jwt令牌转换器处理请求令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">)</span><span class="c1">//认证管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">)</span><span class="c1">//自定义认证类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">.</span><span class="na">allowedTokenEndpointRequestMethods</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">);</span><span class="c1">//允许端点访问方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h3 id="444测试生成令牌">4.4.4、测试生成令牌</h3>
<p>生成令牌，就变成了JWT格式的了！
<img src="/posts/project-0/20220528165279/image-20220528170018040.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="445配置获取公钥端点">4.4.5、配置获取公钥端点</h3>
<p>修改配置类AuthorizationServerConfiguration,增加配置获取公钥的方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//获取公钥的端点访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TokenKeyEndpoint</span> <span class="nf">tokenKeyEndpoint</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">TokenKeyEndpoint</span><span class="o">(</span><span class="n">jwtAccessTokenConverter</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>测试获取公钥：</p>
<p>访问地址：http://localhost:9100/oauth/token_key
<img src="/posts/project-0/20220528165279/image-20220528170024353.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="5-认证开发">5 认证开发</h1>
<h2 id="51-需求分析">5.1 需求分析</h2>
<p>用户登录的流程图如下：
<img src="/posts/project-0/20220528165279/image-20220528170030230.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>执行流程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">1、用户登录，请求认证服务</span> 
</span></span><span class="line"><span class="cl"><span class="na">2、认证服务认证通过，生成jwt令牌，将jwt令牌及相关信息写入cookie</span> 
</span></span><span class="line"><span class="cl"><span class="na">3、用户访问资源页面，带着cookie到网关</span> 
</span></span><span class="line"><span class="cl"><span class="na">4、网关从cookie获取token，如果存在token，则校验token合法性，如果不合法则拒绝访问，否则放行</span> 
</span></span><span class="line"><span class="cl"><span class="na">5、用户退出，请求认证服务，删除cookie中的token</span> 
</span></span></code></pre></div><h2 id="52-认证服务">5.2 认证服务</h2>
<h3 id="521-认证需求分析">5.2.1 认证需求分析</h3>
<p>认证服务需要实现的功能如下：</p>
<p>1、登录接口</p>
<p>前端post提交账号、密码等，用户身份校验通过，生成令牌，并将令牌写入cookie。</p>
<p>2、退出接口 校验当前用户的身份为合法并且为已登录状态。 将令牌从cookie中删除。 <br>
<img src="/posts/project-0/20220528165279/image-20220528170038139.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="522-工具封装">5.2.2 工具封装</h3>
<p>在dongyimai-user-oauth工程中添加如下工具对象，方便操作令牌信息。</p>
<p>创建com.offcn.oauth.util.AuthToken类，存储用户令牌数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthToken</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//令牌信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">accessToken</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//刷新token(refresh_token)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">refreshToken</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//jwt短令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">jti</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//...get...set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>创建com.offcn.oauth.util.CookieUtil类，操作Cookie,代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.util</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.servlet.http.Cookie</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CookieUtil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 设置cookie
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param response
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name     cookie名字
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param value    cookie值
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxAge   cookie生命周期 以秒为单位
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addCookie</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">String</span> <span class="n">domain</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxAge</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">httpOnly</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="o">.</span><span class="na">setDomain</span><span class="o">(</span><span class="n">domain</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">maxAge</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="n">httpOnly</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据cookie名称读取cookie
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param request
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return map&lt;cookieName,cookieValue&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">readCookie</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="o">...</span> <span class="n">cookieNames</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">cookieMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">cookieName</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">cookieValue</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">cookieNames</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">cookieNames</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="n">cookieName</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cookieMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cookieName</span><span class="o">,</span><span class="n">cookieValue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cookieMap</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="523--配置文件">5.2.3  配置文件</h3>
<p>修改配置文件application.yml增加认证相关配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="m">3600</span><span class="w">  </span><span class="c">#token过期时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clientId</span><span class="p">:</span><span class="w"> </span><span class="l">admin </span><span class="w"> </span><span class="c">#客户端账号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clientSecret</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w"> </span><span class="c">#客户端密码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cookieDomain</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w"> </span><span class="c">#cookie域名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cookieMaxAge</span><span class="p">:</span><span class="w"> </span>-<span class="m">1</span><span class="w">     </span><span class="c">#cookie有效期</span><span class="w">
</span></span></span></code></pre></div><h3 id="524--业务层">5.2.4  业务层</h3>
<p><img src="/posts/project-0/20220528165279/image-20220528170047629.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图，我们现在实现一个认证流程，用户从页面输入账号密码，到认证服务的Controller层，Controller层调用Service层，Service层调用OAuth2.0的认证地址，进行密码授权认证操作，如果账号密码正确了，就返回令牌信息给Service层，Service将令牌信息给Controller层，Controller层将数据存入到Cookie中，再响应用户。</p>
<p>创建com.offcn.oauth.service.AuthService接口，并添加授权认证方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 授权认证方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AuthToken</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>创建com.offcn.oauth.service.impl.AuthServiceImpl实现类，实现获取令牌数据，这里认证获取令牌采用的是密码授权模式，用的是RestTemplate向OAuth服务发起认证请求，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthServiceImpl</span> <span class="kd">implements</span> <span class="n">AuthService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LoadBalancerClient</span> <span class="n">loadBalancerClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 授权认证方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param password
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clientId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clientSecret
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AuthToken</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//申请令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AuthToken</span> <span class="n">authToken</span> <span class="o">=</span> <span class="n">applyToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">password</span><span class="o">,</span><span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">authToken</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;申请令牌失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">authToken</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/****
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 认证方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param username:用户登录名字
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param password：用户密码
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clientId：配置文件中的客户端ID
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clientSecret：配置文件中的秘钥
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AuthToken</span> <span class="nf">applyToken</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//选中认证服务的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServiceInstance</span> <span class="n">serviceInstance</span> <span class="o">=</span> <span class="n">loadBalancerClient</span><span class="o">.</span><span class="na">choose</span><span class="o">(</span><span class="s">&#34;USER-AUTH&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">serviceInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;找不到对应的服务&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取令牌的url
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">serviceInstance</span><span class="o">.</span><span class="na">getUri</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;/oauth/token&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//定义body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//授权方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">formData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;grant_type&#34;</span><span class="o">,</span> <span class="s">&#34;password&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//账号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">formData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">formData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//定义头 必须声明为String，String泛型，要不然做Basic Auth会失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">header</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">header</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;Authorization&#34;</span><span class="o">,</span> <span class="n">httpbasic</span><span class="o">(</span><span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//指定 restTemplate当遇到400或401响应时候也不要抛出异常，也要正常返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//内部类重写快捷键 alt+insert
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">restTemplate</span><span class="o">.</span><span class="na">setErrorHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">DefaultResponseErrorHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleError</span><span class="o">(</span><span class="n">ClientHttpResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">////当发生错误的时候只有状态码不是400或者401才返回错误,其他情况正常响应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getRawStatusCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="o">.</span><span class="na">getRawStatusCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">401</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">super</span><span class="o">.</span><span class="na">handleError</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span> <span class="n">map</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//http请求spring security的申请令牌接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">mapResponseEntity</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span><span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;(</span><span class="n">formData</span><span class="o">,</span> <span class="n">header</span><span class="o">),</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取响应数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">map</span> <span class="o">=</span> <span class="n">mapResponseEntity</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RestClientException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;access_token&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;refresh_token&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;jti&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//jti是jwt令牌的唯一标识作为用户身份令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;创建令牌失败！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="c1">//将响应数据封装成AuthToken对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AuthToken</span> <span class="n">authToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthToken</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">authToken</span><span class="o">.</span><span class="na">setAccessToken</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;access_token&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">authToken</span><span class="o">.</span><span class="na">setRefreshToken</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;refresh_token&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">authToken</span><span class="o">.</span><span class="na">setJti</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;jti&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">authToken</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * base64编码
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clientId
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clientSecret
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">httpbasic</span><span class="o">(</span><span class="n">String</span> <span class="n">clientId</span><span class="o">,</span><span class="n">String</span> <span class="n">clientSecret</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将客户端id和客户端密码拼接，按“客户端id:客户端密码”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">clientId</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">clientSecret</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//进行base64编码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">byte</span><span class="o">[]</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">Base64Utils</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">string</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Basic &#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">encode</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意：HttpBasic协议验证规则 ,在请求头传递  Authorization  值为   Basic+半角空格+Base64Encode客户端id:客户端密码</p>
<h3 id="525--控制层">5.2.5  控制层</h3>
<p>创建控制层com.offcn.oauth.controller.AuthController，编写用户登录授权方法，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/user&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//客户端ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${auth.clientId}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//秘钥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${auth.clientSecret}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Cookie存储的域名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${auth.cookieDomain}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">cookieDomain</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Cookie生命周期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${auth.cookieMaxAge}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">cookieMaxAge</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="n">AuthService</span> <span class="n">authService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//登录方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断用户是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;用户名不能为空&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断密码是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">password</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;密码不能为空&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//调用服务，申请令牌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//注意客户端id：clientId、客户端密码，从配置文件读取，一定要保持和数据库中的一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AuthToken</span> <span class="n">authToken</span> <span class="o">=</span> <span class="n">authService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//保存令牌到cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CookieUtil</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">response</span><span class="o">,</span><span class="n">cookieDomain</span><span class="o">,</span><span class="s">&#34;/&#34;</span><span class="o">,</span><span class="s">&#34;Authorization&#34;</span><span class="o">,</span><span class="n">authToken</span><span class="o">.</span><span class="na">getAccessToken</span><span class="o">(),</span><span class="n">cookieMaxAge</span><span class="o">,</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;登录成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>修改主启动类，声明RestTemplate</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> @Bean
</span></span><span class="line"><span class="cl">    public RestTemplate restTemplate(){
</span></span><span class="line"><span class="cl">        return new RestTemplate();
</span></span><span class="line"><span class="cl">    }
</span></span></code></pre></div><h3 id="527-测试认证接口">5.2.7 测试认证接口</h3>
<p>使用postman测试：</p>
<p>Post请求：http://localhost:9100/user/login <br>
<img src="/posts/project-0/20220528165279/image-20220528170102492.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>可以看到本cookie已经写入了token</p>
<p><img src="/posts/project-0/20220528165279/image-20220528170109368.png"
    
    
    
    loading="lazy"
    
    
></p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project/_20220529000803/">← 微信小程序开发入门</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project/20220528222829/">tk-SpringCloudAlibaba →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>