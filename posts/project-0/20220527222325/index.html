<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>广告管理与Lua、Canal实现广告缓存</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }
  </style>

</head>
    <body style="    
    background-image: url(https://api.ixiaowai.cn/api/api.php);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;">
    <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap">
  <nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-27&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-27&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            14282 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            29 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['广告管理与Lua、Canal实现广告缓存'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <h1 align = "center">第五章</h1>
<h1 align = "center">广告管理与Lua、Canal实现广告缓存</h1>
<h3 align="center">优就业.JAVA教研室</h3>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>了解网站首页页面以及广告相关表结构</li>
<li>后台广告微服务开发</li>
<li>首页广告架构设计分析</li>
<li>Lua脚本</li>
<li>OpenResty介绍</li>
<li>广告缓存的载入与读取</li>
<li>完成网站首页前台工程广告轮播图展示</li>
<li>Nginx高并发限流讲解</li>
<li>Canal binlog增量数据实时同步</li>
<li>Canal实现广告实时缓存同步</li>
</ul>
<h1 id="一网站首页分析">一、网站首页分析</h1>
<p>首页门户系统需要展示各种各样的广告数据。如图，以jd为例：
<img src="/posts/project-0/20220527222325/image-20220527222457528.png"
    
    
    
    loading="lazy"
    
    
></p>
<h2 id="11网站首页广告">1.1网站首页广告</h2>
<p>（1）首页海报（轮播图）</p>
<p>（2）今日推荐</p>
<p>（3）猜你喜欢</p>
<p>（4）楼层广告</p>
<h2 id="12数据库表结构分析">1.2数据库表结构分析</h2>
<p>tb_content_category 广告分类表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>Bigint</td>
<td></td>
<td>主键</td>
</tr>
<tr>
<td>name</td>
<td>Varchar</td>
<td>255</td>
<td>广告分类名称</td>
</tr>
</tbody>
</table>
<p>tb_content 广告表</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>Bigint</td>
<td></td>
<td>主键</td>
</tr>
<tr>
<td>category_id</td>
<td>Bigint</td>
<td></td>
<td>广告分类ID</td>
</tr>
<tr>
<td>title</td>
<td>varchar</td>
<td>200</td>
<td>广告标题</td>
</tr>
<tr>
<td>url</td>
<td>varchar</td>
<td>500</td>
<td>广告链接</td>
</tr>
<tr>
<td>pic</td>
<td>varchar</td>
<td>300</td>
<td>图片地址</td>
</tr>
<tr>
<td>status</td>
<td>varchar</td>
<td>1</td>
<td>状态 0不显示 1显示</td>
</tr>
<tr>
<td>sort_order</td>
<td>int</td>
<td></td>
<td>排序</td>
</tr>
</tbody>
</table>
<h1 id="二-首页广告架构设计分析">二、 首页广告架构设计分析</h1>
<h3 id="21-传统实现思路">2.1 传统实现思路</h3>
<p><img src="/posts/project-0/20220527222325/image-20220527222509871.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图此种方式 简单，直接通过数据库查询数据展示给用户即可，但是通常情况下，首页（门户系统的流量一般非常的高）不适合直接通过mysql数据库直接访问的方式来获取展示。</p>
<h3 id="22-高并发架构设计">2.2 高并发架构设计</h3>
<p>1.首先访问nginx ，我们可以采用缓存的方式，先从nginx本地缓存中获取，获取到直接响应</p>
<p>2.如果nginx没有获取到，再次访问redis，我们可以从redis中获取数据，如果有 则返回，并缓存到nginx中</p>
<p>3.如果redis没有获取到,再次访问mysql,我们从mysql中获取数据，再将数据存储到redis中，返回。</p>
<p>而这里面，我们都可以使用LUA脚本嵌入到程序中执行这些查询相关的业务。
<img src="/posts/project-0/20220527222325/image-20220527222517043.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="三lua了解">三、Lua(了解)</h1>
<h3 id="31-lua是什么">3.1 Lua是什么</h3>
<p>Lua [1]  是一个小巧的<a class="link" href="/posts/project-0/https://baike.baidu.com/item/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80"  target="_blank" rel="noopener"
    >脚本语言</a>。它是巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个由Roberto Ierusalimschy、Waldemar Celes 和 Luiz Henrique de Figueiredo三人所组成的研究小组于1993年开发的。 其设计目的是为了通过灵活嵌入应用程序中从而为应用程序提供灵活的扩展和定制功能。Lua由标准C编写而成，几乎在所有操作系统和平台上都可以编译，运行。Lua并没有提供强大的库，这是由它的定位决定的。所以Lua不适合作为开发独立应用程序的语言。Lua 有一个同时进行的JIT项目，提供在特定平台上的即时编译功能。</p>
<p>简单来说：</p>
<p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<h3 id="32-特性">3.2 特性</h3>
<ul>
<li>支持面向过程(procedure-oriented)编程和函数式编程(functional programming)；</li>
<li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li>
<li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li>
<li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等。</li>
</ul>
<h3 id="33-应用场景">3.3 应用场景</h3>
<ul>
<li>游戏开发</li>
<li>独立应用脚本</li>
<li>Web 应用脚本</li>
<li>扩展和数据库插件如：MySQL Proxy 和 MySQL WorkBench</li>
<li>安全系统，如入侵检测系统</li>
<li>redis中嵌套调用实现类似事务的功能</li>
<li>web容器中应用处理一些过滤 缓存等等的逻辑，例如nginx。</li>
</ul>
<h3 id="34-lua的安装">3.4 lua的安装</h3>
<p>有linux版本的安装也有mac版本的安装。。我们采用linux版本的安装，首先我们准备一个linux虚拟机。</p>
<p>安装步骤,在linux系统中执行下面的命令。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">curl</span> <span class="s">-R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span>
</span></span><span class="line"><span class="cl"><span class="na">tar</span> <span class="s">zxf lua-5.3.5.tar.gz</span>
</span></span><span class="line"><span class="cl"><span class="na">cd</span> <span class="s">lua-5.3.5</span>
</span></span><span class="line"><span class="cl"><span class="na">make</span> <span class="s">linux test</span>
</span></span></code></pre></div><p>注意：此时安装，有可能会出现如下错误：
<img src="/posts/project-0/20220527222325/image-20220527222530431.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>此时需要安装lua相关依赖库的支持，执行如下命令即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">yum</span> <span class="s">install gcc libtermcap-devel ncurses-devel libevent-devel readline-devel -y</span>
</span></span></code></pre></div><p>重新编译lua</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">make</span> <span class="s">linux test</span>
</span></span></code></pre></div><p>安装lua</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">make</span> <span class="s">install</span>
</span></span></code></pre></div><p>删除老版本lua,关联新版本lua</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">cd</span> <span class="s">/usr/bin</span>
</span></span><span class="line"><span class="cl"><span class="na">rm</span> <span class="s">-rf lua luac</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">ln</span> <span class="s">-s /usr/local/bin/lua /usr/bin/lua</span>
</span></span><span class="line"><span class="cl"><span class="na">ln</span> <span class="s">-s /usr/local/bin/luac /usr/bin/luac</span>
</span></span></code></pre></div><p>此时再执行lua测试看lua是否安装成功</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">[root@localhost</span> <span class="s">~]# lua</span>
</span></span><span class="line"><span class="cl"><span class="na">Lua</span> <span class="s">5.3.5  Copyright (C) 1994-2018 Lua.org, PUC-Rio</span>
</span></span></code></pre></div><h3 id="35-入门程序">3.5 入门程序</h3>
<p>在线脚本测试：https://www.lua.org/cgi-bin/demo</p>
<p>创建hello.lua文件，内容为</p>
<p>编辑文件hello.lua</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vi hello.lua
</span></span></code></pre></div><p>在文件中输入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">print(&#34;hello&#34;);
</span></span></code></pre></div><p>保存并退出。</p>
<p>执行命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lua hello.lua
</span></span></code></pre></div><p>输出为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Hello
</span></span></code></pre></div><p>效果如下：
<img src="/posts/project-0/20220527222325/image-20220527222736718.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="36-lua的基本语法了解">3.6 LUA的基本语法(了解)</h3>
<p>lua有交互式编程和脚本式编程。</p>
<p>交互式编程就是直接输入语法，就能执行。</p>
<p>脚本式编程需要编写脚本，然后再执行命令 执行脚本才可以。</p>
<p>一般采用脚本式编程。（例如：编写一个hello.lua的文件，输入文件内容，并执行lua hell.lua即可）</p>
<p>(1)交互式编程</p>
<p>Lua 提供了交互式编程模式。我们可以在命令行中输入程序并立即查看效果。</p>
<p>Lua 交互式编程模式可以通过命令 lua -i 或 lua 来启用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lua -i
</span></span></code></pre></div><p>如下图：
<img src="/posts/project-0/20220527222325/image-20220527222844340.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)脚本式编程</p>
<p>我们可以将 Lua 程序代码保持到一个以 lua 结尾的文件，并执行，该模式称为脚本式编程，例如上面入门程序中将lua语法写到hello.lua文件中。</p>
<h4 id="361-注释">3.6.1 注释</h4>
<p>一行注释：两个减号是单行注释:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">--
</span></span></code></pre></div><p>多行注释：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="cm">--[[
</span></span></span><span class="line"><span class="cl"><span class="cm"> 多行注释
</span></span></span><span class="line"><span class="cl"><span class="cm"> 多行注释
</span></span></span><span class="line"><span class="cl"><span class="cm"> --]]</span>
</span></span></code></pre></div><h4 id="362-定义变量">3.6.2 定义变量</h4>
<p>全局变量，默认的情况下，定义一个变量都是全局变量，</p>
<p>如果要用局部变量 需要声明为local.例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 全局变量赋值</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 局部变量赋值</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span> 
</span></span></code></pre></div><p>如果变量没有初始化：则 它的值为nil 这和java中的null不同。</p>
<p>如下图案例：
<img src="/posts/project-0/20220527222325/image-20220527222912404.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="363-lua中的数据类型">3.6.3 Lua中的数据类型</h4>
<p>Lua 是动态类型语言，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回。</p>
<p>Lua 中有 8 个基本类型分别为：nil、boolean、number、string、userdata、function、thread 和 table。</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>nil</td>
<td>这个最简单，只有值nil属于该类，表示一个无效值（在条件表达式中相当于false）。</td>
</tr>
<tr>
<td>boolean</td>
<td>包含两个值：false和true。</td>
</tr>
<tr>
<td>number</td>
<td>表示双精度类型的实浮点数</td>
</tr>
<tr>
<td>string</td>
<td>字符串由一对双引号或单引号来表示</td>
</tr>
<tr>
<td>function</td>
<td>由 C 或 Lua 编写的函数</td>
</tr>
<tr>
<td>userdata</td>
<td>表示任意存储在变量中的C数据结构</td>
</tr>
<tr>
<td>thread</td>
<td>表示执行的独立线路，用于执行协同程序</td>
</tr>
<tr>
<td>table</td>
<td>Lua 中的表（table）其实是一个&quot;关联数组&quot;（associative arrays），数组的索引可以是数字、字符串或表类型。在 Lua 里，table 的创建是通过&quot;构造表达式&quot;来完成，最简单构造表达式是{}，用来创建一个空表。</td>
</tr>
</tbody>
</table>
<p>实例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">print(type(&#34;Hello</span> <span class="s">world&#34;))      --&gt; string</span>
</span></span><span class="line"><span class="cl"><span class="na">print(type(10.4*3))</span>             <span class="s">--&gt; number</span>
</span></span><span class="line"><span class="cl"><span class="na">print(type(print))</span>              <span class="s">--&gt; function</span>
</span></span><span class="line"><span class="cl"><span class="na">print(type(type))</span>               <span class="s">--&gt; function</span>
</span></span><span class="line"><span class="cl"><span class="na">print(type(true))</span>               <span class="s">--&gt; boolean</span>
</span></span><span class="line"><span class="cl"><span class="na">print(type(nil))</span>                <span class="s">--&gt; nil</span>
</span></span></code></pre></div><h4 id="364-流程控制">3.6.4 流程控制</h4>
<p>(1)if语句</p>
<p>Lua <strong>if 语句</strong> 由一个布尔表达式作为条件判断，其后紧跟其他语句组成。</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">if(布尔表达式)</span>
</span></span><span class="line"><span class="cl"><span class="na">then</span>
</span></span><span class="line"><span class="cl">   <span class="na">--[</span> <span class="s">在布尔表达式为 true 时执行的语句 --]</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span></code></pre></div><p>实例：
<img src="/posts/project-0/20220527222325/image-20220527222925177.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">--定义变量</span>
</span></span><span class="line"><span class="cl"><span class="n">num</span><span class="o">=</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="c1">--使用if语句判断</span>
</span></span><span class="line"><span class="cl"><span class="kr">if</span> <span class="n">num</span><span class="o">&lt;</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">  <span class="kr">then</span>
</span></span><span class="line"><span class="cl">  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;5&lt;10&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p>(2)if..else语句</p>
<p>Lua if 语句可以与 else 语句搭配使用, 在 if 条件表达式为 false 时执行 else 语句代码块。</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">if(布尔表达式)</span>
</span></span><span class="line"><span class="cl"><span class="na">then</span>
</span></span><span class="line"><span class="cl">   <span class="na">--[</span> <span class="s">布尔表达式为 true 时执行该语句块 --]</span>
</span></span><span class="line"><span class="cl"><span class="na">else</span>
</span></span><span class="line"><span class="cl">   <span class="na">--[</span> <span class="s">布尔表达式为 false 时执行该语句块 --]</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span></code></pre></div><p>实例：
<img src="/posts/project-0/20220527222325/image-20220527222931577.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">--定义变量</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="kr">if</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">then</span>
</span></span><span class="line"><span class="cl">  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;a&lt;20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">else</span>
</span></span><span class="line"><span class="cl">  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;a&gt;20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>  
</span></span></code></pre></div><h4 id="365-循环">3.6.5 循环</h4>
<p>学员完成</p>
<p>(1)while循环[==满足条件就循环==]</p>
<p>Lua 编程语言中 while 循环语句在判断条件为 true 时会重复执行循环体语句。
语法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">while(condition)</span>
</span></span><span class="line"><span class="cl"><span class="na">do</span>
</span></span><span class="line"><span class="cl">   <span class="na">statements</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span></code></pre></div><p>实例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">a</span><span class="o">=</span><span class="s">10</span>
</span></span><span class="line"><span class="cl"><span class="na">while(</span> <span class="s">a &lt; 20 )</span>
</span></span><span class="line"><span class="cl"><span class="na">do</span>
</span></span><span class="line"><span class="cl">   <span class="na">print(&#34;a</span> <span class="s">value:&#34;, a)</span>
</span></span><span class="line"><span class="cl">   <span class="na">a</span> <span class="o">=</span> <span class="s">a+1</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span></code></pre></div><p>效果如下：
<img src="/posts/project-0/20220527222325/image-20220527222940225.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)for循环</p>
<p>Lua 编程语言中 for 循环语句可以重复执行指定语句，重复次数可在 for 语句中控制。</p>
<p>语法：  1-&gt;10  1:exp1  10:exp2  2:exp3:递增的数量</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">for</span> <span class="s">var=exp1,exp2,exp3 </span>
</span></span><span class="line"><span class="cl"><span class="na">do</span>  
</span></span><span class="line"><span class="cl">    <span class="na">&lt;执行体&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="na">end</span>  
</span></span></code></pre></div><p>var 从 exp1 变化到 exp2，每次变化以 exp3 为步长递增 var，并执行一次 <strong>&ldquo;执行体&rdquo;</strong>。exp3 是可选的，如果不指定，默认为1。</p>
<p>例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">for</span> <span class="s">i=1,9,2</span>
</span></span><span class="line"><span class="cl"><span class="na">do</span>
</span></span><span class="line"><span class="cl"><span class="err">   print(i)</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span></code></pre></div><p><code>for i=1,9,2</code>:i=1从1开始循环，9循环数据到9结束，2每次递增2
<img src="/posts/project-0/20220527222325/image-20220527222948884.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(3)repeat&hellip;until语句[==满足条件结束==]</p>
<p>Lua 编程语言中 repeat&hellip;until 循环语句不同于 for 和 while循环，for 和 while 循环的条件语句在当前循环执行开始时判断，而 repeat&hellip;until 循环的条件语句在当前循环结束后判断。</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">repeat</span>
</span></span><span class="line"><span class="cl">   <span class="na">statements</span>
</span></span><span class="line"><span class="cl"><span class="na">until(</span> <span class="s">condition )</span>
</span></span></code></pre></div><p>案例：
<img src="/posts/project-0/20220527222325/image-20220527222955917.png"
    
    
    
    loading="lazy"
    
    
></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">num</span><span class="o">=</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="kr">repeat</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="kr">until</span><span class="p">(</span><span class="n">num</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="366-函数">3.6.6 函数</h4>
<p>lua中也可以定义函数，类似于java中的方法。例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="cm">--[[ 函数返回两个值的最大值 --]]</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">max</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kr">if</span> <span class="p">(</span><span class="n">num1</span> <span class="o">&gt;</span> <span class="n">num2</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="n">num1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kr">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="n">num2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kr">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 调用函数</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="s2">&#34;两值比较最大值为 &#34;</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="s2">&#34;两值比较最大值为 &#34;</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
</span></span></code></pre></div><p>执行之后的结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">两值比较最大值为     10
</span></span><span class="line"><span class="cl">两值比较最大值为     6
</span></span></code></pre></div><p>注意函数需要在lua脚本文件编写，不要采用交互模式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vi test.lua
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">编写内容
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">运行lua
</span></span><span class="line"><span class="cl">lua test.lua
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">输出结果：
</span></span><span class="line"><span class="cl">两值比较最大值为 	10
</span></span></code></pre></div><h4 id="367-表">3.6.7 表</h4>
<p>table 是 Lua 的一种数据结构用来帮助我们创建不同的数据类型，如：数组、字典等。</p>
<p>Lua也是通过table来解决模块（module）、包（package）和对象（Object）的。</p>
<p>案例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">--</span> <span class="s">初始化表</span>
</span></span><span class="line"><span class="cl"><span class="na">mytable</span> <span class="o">=</span> <span class="s">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">--</span> <span class="s">指定值</span>
</span></span><span class="line"><span class="cl"><span class="na">mytable[1]</span><span class="o">=</span> <span class="s">&#34;Lua&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">print(&#34;mytable</span><span class="o">:</span><span class="s">&#34;,mytable[1])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">--</span> <span class="s">移除引用</span>
</span></span><span class="line"><span class="cl"><span class="na">mytable</span> <span class="o">=</span> <span class="s">nil</span>
</span></span></code></pre></div><h4 id="368-模块">3.6.8 模块</h4>
<p>(1)模块定义</p>
<p>模块类似于一个封装库，从 Lua 5.1 开始，Lua 加入了标准的模块管理机制，可以把一些公用的代码放在一个文件里，以 API 接口的形式在其他地方调用，有利于代码的重用和降低代码耦合度。</p>
<p>创建一个文件叫module.lua，在module.lua中创建一个独立的模块，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">--</span> <span class="s">文件名为 module.lua</span>
</span></span><span class="line"><span class="cl"><span class="na">--</span> <span class="s">定义一个名为 module 的模块</span>
</span></span><span class="line"><span class="cl"><span class="na">module</span> <span class="o">=</span> <span class="s">{}</span>
</span></span><span class="line"><span class="cl"><span class="err"> </span>
</span></span><span class="line"><span class="cl"><span class="na">--</span> <span class="s">定义一个常量</span>
</span></span><span class="line"><span class="cl"><span class="na">module.constant</span> <span class="o">=</span> <span class="s">&#34;这是一个常量&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err"> </span>
</span></span><span class="line"><span class="cl"><span class="na">--</span> <span class="s">定义一个函数</span>
</span></span><span class="line"><span class="cl"><span class="na">function</span> <span class="s">module.func1()</span>
</span></span><span class="line"><span class="cl"><span class="err">    print(&#34;这是一个公有函数&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span><span class="line"><span class="cl"><span class="err"> </span>
</span></span><span class="line"><span class="cl"><span class="na">local</span> <span class="s">function func2()</span>
</span></span><span class="line"><span class="cl"><span class="err">    print(&#34;这是一个私有函数！&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span><span class="line"><span class="cl"><span class="err"> </span>
</span></span><span class="line"><span class="cl"><span class="na">function</span> <span class="s">module.func3()</span>
</span></span><span class="line"><span class="cl"><span class="err">    func2()</span>
</span></span><span class="line"><span class="cl"><span class="na">end</span>
</span></span><span class="line"><span class="cl"><span class="err"> </span>
</span></span><span class="line"><span class="cl"><span class="na">return</span> <span class="s">module</span>
</span></span></code></pre></div><p>由上可知，模块的结构就是一个 table 的结构，因此可以像操作调用 table 里的元素那样来操作调用模块里的常量或函数。</p>
<p>上面的 func2 声明为程序块的局部变量，即表示一个私有函数，因此是不能从外部访问模块里的这个私有函数，必须通过模块里的公有函数来调用.</p>
<p>(2)require 函数</p>
<p>require 用于 引入其他的模块，类似于java中的类要引用别的类的效果。</p>
<p>用法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="err">require(&#34;&lt;模块名&gt;&#34;)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">require</span> <span class="s">&#34;&lt;模块名&gt;&#34;</span>
</span></span></code></pre></div><p>两种都可以。</p>
<p>我们可以将上面定义的module模块引入使用,创建一个test_module.lua文件，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">--</span> <span class="s">test_module.lua 文件</span>
</span></span><span class="line"><span class="cl"><span class="na">--</span> <span class="s">module 模块为上文提到到 module.lua</span>
</span></span><span class="line"><span class="cl"><span class="err">require(&#34;module&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">print(module.constant)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">module.func3()</span>
</span></span></code></pre></div><h1 id="四openresty介绍">四、OpenResty介绍</h1>
<p>OpenResty(又称：ngx_openresty) 是一个基于 nginx的可伸缩的 Web 平台，由中国人章亦春发起，提供了很多高质量的第三方模块。</p>
<p>OpenResty 是一个强大的 Web 应用服务器，Web 开发人员可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块,更主要的是在性能方面，OpenResty可以 快速构造出足以胜任 10W以上并发连接响应的超高性能 Web 应用系统。</p>
<p>360，UPYUN，阿里云，新浪，腾讯网，去哪儿网，酷狗音乐等都是 OpenResty 的深度用户。</p>
<p>OpenResty 简单理解成 就相当于封装了nginx,并且集成了LUA脚本，开发人员只需要简单的其提供了模块就可以实现相关的逻辑，而不再像之前，还需要在nginx中自己编写lua的脚本，再进行调用了。</p>
<h3 id="41-安装openresty">4.1 安装openresty</h3>
<p>linux安装openresty:</p>
<p>1.添加仓库执行命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> yum install yum-utils
</span></span><span class="line"><span class="cl"> yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
</span></span></code></pre></div><p>2.执行安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">yum install openresty -y
</span></span></code></pre></div><p>3.安装成功后 会在默认的目录如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/usr/local/openresty
</span></span></code></pre></div><h3 id="42-配置nginx">4.2 配置nginx</h3>
<p>默认已经安装好了nginx,在目录：/usr/local/openresty/nginx 下。</p>
<p>修改/usr/local/openresty/nginx/conf/nginx.conf,将配置文件使用的根设置为root,目的就是将来要使用lua脚本的时候 ，直接可以加载在root下的lua脚本。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /usr/local/openresty/nginx/conf
</span></span><span class="line"><span class="cl">vi nginx.conf
</span></span></code></pre></div><p>修改代码如下：
<img src="/posts/project-0/20220527222325/image-20220527223055080.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="43启动openresty">4.3、启动openresty</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /usr/local/openresty/nginx/sbin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./nginx
</span></span></code></pre></div><h3 id="44停止openresty">4.4、停止openresty</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./nginx -s stop
</span></span></code></pre></div><h3 id="45重启openresty">4.5、重启openresty</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./nginx -s reload
</span></span></code></pre></div><h3 id="46-测试访问">4.6 测试访问</h3>
<p>重启下centos虚拟机，然后访问测试Nginx</p>
<p>访问地址：<code>http://192.168.188.128/</code>
<img src="/posts/project-0/20220527222325/image-20220527223109855.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：linux防火墙要打开80端口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">firewall-cmd --add-port<span class="o">=</span>80/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></div><h1 id="五广告缓存的载入与读取">五、广告缓存的载入与读取</h1>
<h3 id="51-需求分析">5.1 需求分析</h3>
<p>需要在页面上显示广告的信息。</p>
<h3 id="52-luanginx配置">5.2 Lua+Nginx配置</h3>
<h4 id="1实现思路-查询数据放入redis中">(1)实现思路-查询数据放入redis中</h4>
<p>实现思路：</p>
<p>定义请求：用于查询数据库中的数据更新到redis中。</p>
<p>a.连接mysql ，按照广告分类ID读取广告列表，转换为json字符串。</p>
<p>b.连接redis，将广告列表json字符串存入redis 。</p>
<p>定义请求：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">请求：
</span></span><span class="line"><span class="cl">	/update_content
</span></span><span class="line"><span class="cl">参数：
</span></span><span class="line"><span class="cl">	id  --指定广告分类的id
</span></span><span class="line"><span class="cl">返回值：
</span></span><span class="line"><span class="cl">	json
</span></span></code></pre></div><p>请求地址：<code>&lt;http://192.168.188.128/update_content?id=1&gt;</code></p>
<p>创建/root/lua目录，在该目录下创建update_content.lua： 目的就是连接mysql  查询数据 并存储到redis中。
<img src="/posts/project-0/20220527222325/image-20220527223119952.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">---</span>
</span></span><span class="line"><span class="cl"><span class="c1">--- Created by Administrator.</span>
</span></span><span class="line"><span class="cl"><span class="c1">--- DateTime: 2021/2/3 15:45</span>
</span></span><span class="line"><span class="cl"><span class="c1">---</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 设置nginx响应数据类型json</span>
</span></span><span class="line"><span class="cl"><span class="n">ngx.header</span><span class="p">.</span><span class="n">content_type</span><span class="o">=</span><span class="s2">&#34;application/json;charset=utf8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 引入json的操作类库</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">cjson</span><span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;cjson&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 引入连接数据库的类库</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">mysql</span><span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;resty.mysql&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 引入捕获nginx url路径参数类库</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">uri_args</span> <span class="o">=</span> <span class="n">ngx.req</span><span class="p">.</span><span class="n">get_uri_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 获取传递进来广告分类id</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">categoryid</span><span class="o">=</span><span class="n">uri_args</span><span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 连接到数据库</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span>  <span class="n">db</span><span class="o">=</span><span class="n">mysql</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 连接到数据库超时时间 单位是毫秒</span>
</span></span><span class="line"><span class="cl"><span class="n">db</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">50000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 设置连接到数据库参数</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span><span class="o">=</span><span class="s2">&#34;192.168.188.150&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">database</span><span class="o">=</span><span class="s2">&#34;dongyimaidb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span><span class="o">=</span><span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 使用连接参数建立连接</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">res</span><span class="o">=</span><span class="n">db</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 准备一条sql语句</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">sql</span><span class="o">=</span><span class="s2">&#34;SELECT url,pic FROM tb_content WHERE status=1 and category_id=&#34;</span><span class="o">..</span><span class="n">categoryid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 执行sql进行查询</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="o">=</span><span class="n">db</span><span class="p">:</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">--关闭数据库连接</span>
</span></span><span class="line"><span class="cl"><span class="n">db</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 引入redis操作类库</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">redis</span><span class="o">=</span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;resty.redis&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 创建一个redis客户端对象</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">red</span><span class="o">=</span><span class="n">redis</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 设置redis连接的超时时间</span>
</span></span><span class="line"><span class="cl"><span class="n">red</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">50000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- 指定redis服务器 ip、端口</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">ip</span><span class="o">=</span><span class="s2">&#34;192.168.188.150&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- redis客户端连接到指定redis服务器</span>
</span></span><span class="line"><span class="cl"><span class="n">red</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 把从数据库读取到数据写入到redis  要把从数据库读取到结果转换为json字符串</span>
</span></span><span class="line"><span class="cl"><span class="n">red</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;content_&#34;</span><span class="o">..</span><span class="n">categoryid</span><span class="p">,</span><span class="n">cjson.encode</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 关闭redis连接</span>
</span></span><span class="line"><span class="cl"><span class="n">red</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">--提示给nginx用户写入成功</span>
</span></span><span class="line"><span class="cl"><span class="n">ngx.say</span><span class="p">(</span><span class="s2">&#34;{flag:true}&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>注意</strong> .. 表示拼接变量</p>
<p>连接数据库的超时时间可以适当设置长一些，避免出现连接超时情况。</p>
<p>创建redis容器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker run -d --name redis1  --net=host redis:4.0.8
</span></span></code></pre></div><p>修改/usr/local/openresty/nginx/conf/nginx.conf文件： 添加头信息，和 location信息
<img src="/posts/project-0/20220527222325/image-20220527223129471.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/update_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/update_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>重启Nginx</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./Nginx -s reload
</span></span></code></pre></div><p>测试地址：http://192.168.188.128/update_content?id=1</p>
<p>此时会将分类ID=1的所有广告查询出来，并存入到Redis缓存。
<img src="/posts/project-0/20220527222325/image-20220527223137026.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="2实现思路-从redis中获取数据">(2)实现思路-从redis中获取数据</h4>
<p>实现思路：</p>
<p>定义请求，用户根据广告分类的ID 获取广告的列表。通过lua脚本直接从redis中获取数据即可。</p>
<p>定义请求：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">请求:/read_content
</span></span><span class="line"><span class="cl">参数：id
</span></span><span class="line"><span class="cl">返回值：json
</span></span></code></pre></div><p>在/root/lua目录下创建read_content.lua:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">---</span>
</span></span><span class="line"><span class="cl"><span class="c1">--- Created by Administrator.</span>
</span></span><span class="line"><span class="cl"><span class="c1">--- DateTime: 2021/2/3 15:45</span>
</span></span><span class="line"><span class="cl"><span class="c1">---</span>
</span></span><span class="line"><span class="cl"><span class="c1">--设置响应头类型</span>
</span></span><span class="line"><span class="cl"><span class="n">ngx.header</span><span class="p">.</span><span class="n">content_type</span><span class="o">=</span><span class="s2">&#34;application/json;charset=utf8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">--获取请求中的参数ID</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">uri_args</span> <span class="o">=</span> <span class="n">ngx.req</span><span class="p">.</span><span class="n">get_uri_args</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">uri_args</span><span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">--引入redis库</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">redis</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;resty.redis&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">--创建redis对象</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">red</span> <span class="o">=</span> <span class="n">redis</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">--设置超时时间</span>
</span></span><span class="line"><span class="cl"><span class="n">red</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">--连接</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">red</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="s2">&#34;192.168.188.128&#34;</span><span class="p">,</span> <span class="mi">6379</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">--获取key的值</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">rescontent</span><span class="o">=</span><span class="n">red</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;content_&#34;</span><span class="o">..</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">--输出到返回响应中</span>
</span></span><span class="line"><span class="cl"><span class="n">ngx.say</span><span class="p">(</span><span class="n">rescontent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">--关闭连接</span>
</span></span><span class="line"><span class="cl"><span class="n">red</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div><p>在/usr/local/openresty/nginx/conf/nginx.conf中配置如下：</p>
<p>如图：
<img src="/posts/project-0/20220527222325/image-20220527223145236.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">location</span> <span class="s">/read_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/read_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>重启Nginx</p>
<p>测试地址：http://192.168.188.128/read_content?id=1</p>
<p>此时会将分类ID=1的所有广告查询出来。
<img src="/posts/project-0/20220527222325/image-20220527223152379.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="3加入openresty本地缓存">(3)加入openresty本地缓存</h4>
<p>如上的方式没有问题，但是如果请求都到redis，redis压力也很大，所以我们一般采用多级缓存的方式来减少下游系统的服务压力。参考基本思路图的实现。</p>
<p>先查询openresty本地缓存 如果 没有</p>
<p>再查询redis中的数据，如果没有</p>
<p>再查询mysql中的数据，但凡有数据 则返回即可。</p>
<p>修改read_content.lua文件，代码如下：
<img src="/posts/project-0/20220527222325/image-20220527223159835.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">--- 设置nginx响应头数据类型</span>
</span></span><span class="line"><span class="cl"><span class="n">ngx.header</span><span class="p">.</span><span class="n">content_type</span><span class="o">=</span><span class="s2">&#34;application/json;charset=utf8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">--获取请求中的参数ID</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">uri_args</span> <span class="o">=</span> <span class="n">ngx.req</span><span class="p">.</span><span class="n">get_uri_args</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">uri_args</span><span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">--获取nginx本地缓存</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">cache_ngx</span> <span class="o">=</span> <span class="n">ngx.shared</span><span class="p">.</span><span class="n">dis_cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">--尝试从ngnx缓存读取广告轮播图数据</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">contentCache</span><span class="o">=</span><span class="n">cache_ngx</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content_cache_&#39;</span><span class="o">..</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">--判断从nginx缓存是否读取到内容</span>
</span></span><span class="line"><span class="cl"><span class="kr">if</span> <span class="n">contentCache</span> <span class="o">==</span><span class="kc">nil</span> <span class="ow">or</span> <span class="n">contentCache</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 从redis读取缓存数据</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 引入redis类库</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">redis</span><span class="o">=</span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;resty.redis&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 创建redis连接对象</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">red</span><span class="o">=</span><span class="n">redis</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">--设置连接超时时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">red</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">30000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">--建立连接</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">ok</span><span class="p">,</span><span class="n">error</span><span class="o">=</span><span class="n">red</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;192.168.188.144&#39;</span><span class="p">,</span><span class="mi">6379</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">--根据指定key去redis读取数据</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">response_context</span><span class="o">=</span><span class="n">red</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content_&#39;</span><span class="o">..</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">--判断从redis是否读取到广告轮播图的数据</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">ngx.null</span> <span class="o">==</span> <span class="n">response_context</span>
</span></span><span class="line"><span class="cl">    <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 从数据库读取数据库</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">mysql</span><span class="o">=</span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;resty.mysql&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 创建数据库对象</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">db</span><span class="o">=</span> <span class="n">mysql</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 设置数据库连接属性</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">host</span><span class="o">=</span><span class="s2">&#34;192.168.188.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">database</span><span class="o">=</span><span class="s2">&#34;dongyimai-db&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">password</span><span class="o">=</span><span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 设置连接超时时间</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">40000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 和mysql数据库建立连接</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span>  <span class="n">res</span><span class="o">=</span><span class="n">db</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">props</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 定义sql语句</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">sql</span><span class="o">=</span><span class="s2">&#34;SELECT	* FROM tb_content WHERE STATUS=&#39;1&#39; AND category_id=&#34;</span><span class="o">..</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">--执行sql查询</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span><span class="o">=</span><span class="n">db</span><span class="p">:</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--   ngx.say(&#39;form mysql----&#39;)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">--引入json的类库</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">cjson</span><span class="o">=</span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;cjson&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">--把读取到数据转换为json对象，存储到redis</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">response_json</span><span class="o">=</span>  <span class="n">cjson.encode</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">red</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;content_&#39;</span><span class="o">..</span><span class="n">id</span><span class="p">,</span><span class="n">response_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">--关闭redis连接</span>
</span></span><span class="line"><span class="cl">        <span class="n">red</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">--写入到nginx缓存一份  缓存有效期 单位是秒</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_ngx</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;content_cache_&#39;</span><span class="o">..</span><span class="n">id</span><span class="p">,</span><span class="n">response_json</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">--响应给nginx展示用户</span>
</span></span><span class="line"><span class="cl">        <span class="n">ngx.say</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">--关闭数据库连接</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 如果redis缓存存在数据写入数据到nginx缓存</span>
</span></span><span class="line"><span class="cl">        <span class="n">cache_ngx</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;content_cache_&#39;</span><span class="o">..</span><span class="n">id</span><span class="p">,</span><span class="n">response_context</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 响应nginx给浏览器</span>
</span></span><span class="line"><span class="cl">        <span class="n">ngx.say</span><span class="p">(</span><span class="n">response_context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">--  ngx.say(&#39;form redis cache----&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"> <span class="kr">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- 从nginx缓存能够读取到数据</span>
</span></span><span class="line"><span class="cl">    <span class="c1">--直接把读取到数据响应给浏览器</span>
</span></span><span class="line"><span class="cl">    <span class="n">ngx.say</span><span class="p">(</span><span class="n">contentCache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--  ngx.say(&#39;form nginx cache----&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></div><p><strong>注意</strong>：判断从redis是否读取到广告轮播图的数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if ngx.null == response_context
</span></span></code></pre></div><p>定义lua缓存命名空间，修改nginx.conf，添加如下代码即可：
<img src="/posts/project-0/20220527222325/image-20220527223209560.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">lua_shared_dict</span> <span class="s">dis_cache 128m;</span>
</span></span></code></pre></div><p>测试地址：http://192.168.188.128/read_content?id=1</p>
<p>此时会获取分类ID=1的所有广告信息。</p>
<p>此时手动清空redis中的数据，发现依然可以访问到信息。
<img src="/posts/project-0/20220527222325/image-20220527223222180.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="六网站首页前台工程广告轮播图展示">六、网站首页前台工程广告轮播图展示</h1>
<h3 id="61-网站首页工程搭建">6.1 网站首页工程搭建</h3>
<p>1、创建静态web工程
<img src="/posts/project-0/20220527222325/image-20220527223229603.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>2、拷贝网站首页静态资源
<img src="/posts/project-0/20220527222325/image-20220527223237499.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>3、把用到的vue\axios类库拷贝过来
<img src="/posts/project-0/20220527222325/image-20220527223244526.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="62-网站首页开发">6.2 网站首页开发</h3>
<p>编辑index.html</p>
<p>(1)、引入vue、axios类库到当前页面</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/vue.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/axios.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>（2）、在页面添加vue识别div</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......原有网页内容，注意里面不能包含javascript
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>(3)、编写vue代码，当页面加载的时候，从服务器端获取广告轮播图数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//生成一个Vue实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">app</span><span class="o">=</span><span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">		<span class="nx">el</span><span class="o">:</span><span class="s2">&#34;#app&#34;</span><span class="p">,</span><span class="c1">//el ,即是element。要渲染的页面元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">data</span><span class="o">:</span><span class="p">{</span><span class="c1">//数据			
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">contentList</span><span class="o">:</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">created</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">			<span class="kd">let</span> <span class="nx">th</span><span class="o">=</span><span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/read_content&#39;</span><span class="p">,{</span>       <span class="c1">// 还可以直接把参数拼接在url后边
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">params</span><span class="o">:</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">id</span><span class="o">:</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">				<span class="nx">th</span><span class="p">.</span><span class="nx">contentList</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//console.log(th.contentList)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">});</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span></code></pre></div><p>（4）、修改index.html循环显示轮播图</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;yui3-u Center banerArea&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--banner轮播--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;myCarousel&#34;</span> <span class="na">data-ride</span><span class="o">=</span><span class="s">&#34;carousel&#34;</span> <span class="na">data-interval</span><span class="o">=</span><span class="s">&#34;4000&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;sui-carousel slide&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;</span><span class="nt">ol</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;carousel-indicators&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;</span><span class="nt">li</span> <span class="na">data-target</span><span class="o">=</span><span class="s">&#34;#myCarousel&#34;</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;(content,index) in contentList&#34;</span> <span class="na">:data-slide-to</span><span class="o">=</span><span class="s">&#34;index&#34;</span> <span class="na">:class</span><span class="o">=</span><span class="s">&#34;index==0?&#39;active&#39;:&#39;&#39;&#34;</span> <span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>				 
</span></span><span class="line"><span class="cl">	<span class="p">&lt;/</span><span class="nt">ol</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;carousel-inner&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;(content,index) in contentList&#34;</span> <span class="na">:class</span><span class="o">=</span><span class="s">&#34;index==0?&#39;active item&#39;:&#39;item&#39;&#34;</span> <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="p">&lt;</span><span class="nt">a</span> <span class="na">:href</span><span class="o">=</span><span class="s">&#34;content.url&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="p">&lt;</span><span class="nt">img</span> <span class="na">:src</span><span class="o">=</span><span class="s">&#34;content.pic&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;width:730px;height:454px&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>					  
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;#myCarousel&#34;</span> <span class="na">data-slide</span><span class="o">=</span><span class="s">&#34;prev&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;carousel-control left&#34;</span><span class="p">&gt;</span>‹<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;#myCarousel&#34;</span> <span class="na">data-slide</span><span class="o">=</span><span class="s">&#34;next&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;carousel-control right&#34;</span><span class="p">&gt;</span>›<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><h3 id="63-部署页面">6.3 部署页面</h3>
<p>上传首页相关文件到nginx目录：/usr/local/openresty/nginx/html
<img src="/posts/project-0/20220527222325/image-20220527223256245.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="64-访问测试">6.4 访问测试</h3>
<p>访问地址: http://192.168.188.128/
<img src="/posts/project-0/20220527222325/image-20220527223302273.png"
    
    
    
    loading="lazy"
    
    
></p>
<h1 id="七nginx限流">七、nginx限流</h1>
<p>一般情况下，首页的并发量是比较大的，即使 有了多级缓存，当用户不停的刷新页面的时候，也是没有必要的，另外如果有恶意的请求 大量达到，也会对系统造成影响。</p>
<p>而限流就是保护措施之一。</p>
<h3 id="71-生活中限流对比">7.1 生活中限流对比</h3>
<ul>
<li>
<p>水坝泄洪，通过闸口限制洪水流量（控制流量速度）。</p>
</li>
<li>
<p>办理银行业务：所有人先领号，各窗口叫号处理。每个窗口处理速度根据客户具体业务而定，所有人排队等待叫号即可。若快下班时，告知客户明日再来(拒绝流量)</p>
</li>
<li>
<p>火车站排队买票安检，通过排队 的方式依次放入。（缓存带处理任务）</p>
</li>
</ul>
<h3 id="72-nginx的限流">7.2 nginx的限流</h3>
<p>nginx提供两种限流的方式：</p>
<ul>
<li>
<p>一是控制速率</p>
</li>
<li>
<p>二是控制并发连接数</p>
</li>
</ul>
<h4 id="721-控制速率">7.2.1 控制速率</h4>
<p>控制速率的方式之一就是采用漏桶算法。</p>
<h5 id="1漏桶算法实现控制速率限流">(1)漏桶算法实现控制速率限流</h5>
<p>漏桶(Leaky Bucket)算法思路很简单,水(请求)先进入到漏桶里,漏桶以一定的速度出水(接口有响应速率),当水流入速度过大会直接溢出(访问频率超过接口响应速率),然后就拒绝请求,可以看出漏桶算法能强行限制数据的传输速率.示意图如下:
<img src="/posts/project-0/20220527222325/image-20220527223314282.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>nginx的配置</p>
<p>配置示意图如下：
<img src="/posts/project-0/20220527222325/image-20220527223319461.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>修改/usr/local/openresty/nginx/conf/nginx.conf:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">user</span>  <span class="s">root</span> <span class="s">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">worker_processes</span>  <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">worker_connections</span>  <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">lua_shared_dict</span> <span class="s">dis_cache</span> <span class="mi">128m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#限流设置  QPS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=contentRateLimit:10m</span> <span class="s">rate=2r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span>        <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#tcp_nopush     on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#keepalive_timeout  0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip  on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/update_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/update_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/read_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#使用限流配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_req</span> <span class="s">zone=contentRateLimit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/read_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>配置说明：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">binary_remote_addr 是一种key，表示基于 remote_addr(客户端IP) 来做限流，binary_ 的目的是压缩内存占用量。
</span></span><span class="line"><span class="cl">zone：定义共享内存区来存储访问信息， contentRateLimit:10m 表示一个大小为10M，名字为contentRateLimit的内存区域。1M能存储16000 IP地址的访问信息，10M可以存储16W IP地址访问信息。
</span></span><span class="line"><span class="cl">rate 用于设置最大访问速率，rate=10r/s 表示每秒最多处理10个请求。Nginx 实际上以毫秒为粒度来跟踪请求信息，因此 10r/s 实际上是限制：每100毫秒处理一个请求。这意味着，自上一个请求处理完后，若后续100毫秒内又有请求到达，将拒绝处理该请求.我们这里设置成2个请求 方便测试。
</span></span></code></pre></div><p>测试：</p>
<p>重新加载配置文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">cd</span> <span class="s">/usr/local/openresty/nginx/sbin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">./nginx</span> <span class="s">-s reload</span>
</span></span></code></pre></div><p>访问页面：<code>http://192.168.188.128/read_content?id=1</code> ,连续刷新会直接报错。
<img src="/posts/project-0/20220527222325/image-20220527223330586.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="2处理突发流量">(2)处理突发流量</h5>
<p>上面例子限制 2r/s，如果有时正常流量突然增大，超出的请求将被拒绝，无法处理突发流量，可以结合 <strong>burst</strong> 参数使用来解决该问题。</p>
<p>例如，如下配置表示：
<img src="/posts/project-0/20220527222325/image-20220527223359450.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/update_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/update_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/read_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">limit_req</span> <span class="s">zone=contentRateLimit</span> <span class="s">burst=4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/read_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>burst 译为突发、爆发，表示在超过设定的处理速率后能额外处理的请求数,当 rate=10r/s 时，将1s拆成10份，即每100ms可处理1个请求。</p>
<p>此处，**burst=4 **，若同时有4个请求到达，Nginx 会处理第一个请求，剩余3个请求将放入队列，然后每隔500ms从队列中获取一个请求进行处理。若请求数大于4，将拒绝处理多余的请求，直接返回503.</p>
<p>不过，单独使用 burst 参数并不实用。假设 burst=50 ，rate依然为10r/s，排队中的50个请求虽然每100ms会处理一个，但第50个请求却需要等待 50 * 100ms即 5s，这么长的处理时间自然难以接受。</p>
<p>因此，burst 往往结合 nodelay 一起使用。</p>
<p>例如：如下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/update_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/update_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/read_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">limit_req</span> <span class="s">zone=contentRateLimit</span> <span class="s">burst=4</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/read_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>如上表示：</p>
<p>平均每秒允许不超过2个请求，突发不超过4个请求，并且处理突发4个请求的时候，没有延迟，等到完成之后，按照正常的速率处理。</p>
<p>如上两种配置结合就达到了速率稳定，但突然流量也能正常处理的效果。完整配置代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">user</span>  <span class="s">root</span> <span class="s">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">worker_processes</span>  <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">worker_connections</span>  <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">lua_shared_dict</span> <span class="s">dis_cache</span> <span class="mi">128m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#限流设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=contentRateLimit:10m</span> <span class="s">rate=2r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span>        <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#tcp_nopush     on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#keepalive_timeout  0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip  on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/update_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/update_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/read_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">limit_req</span> <span class="s">zone=contentRateLimit</span> <span class="s">burst=4</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/read_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>测试：如下图 在1秒钟之内可以刷新4次，正常处理。
<img src="/posts/project-0/20220527222325/image-20220527223441473.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>但是超过之后，连续刷新5次，抛出异常。
<img src="/posts/project-0/20220527222325/image-20220527223446937.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="722-控制并发量连接数">7.2.2 控制并发量（连接数）</h4>
<p>ngx_http_limit_conn_module  提供了限制连接数的能力。主要是利用limit_conn_zone和limit_conn两个指令。</p>
<p>利用连接数限制 某一个用户的ip连接的数量来控制流量。</p>
<p>注意：并非所有连接都被计算在内 只有当服务器正在处理请求并且已经读取了整个请求头时，才会计算有效连接。此处忽略测试。</p>
<p>配置语法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Syntax:	limit_conn zone number;
</span></span><span class="line"><span class="cl">Default: —;
</span></span><span class="line"><span class="cl">Context: http, server, location;
</span></span></code></pre></div><h5 id="1配置限制固定连接数">(1)配置限制固定连接数</h5>
<p>如下，配置如下：
<img src="/posts/project-0/20220527222325/image-20220527223500079.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">lua_shared_dict</span> <span class="s">dis_cache</span> <span class="mi">128m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#限流设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=contentRateLimit:10m</span> <span class="s">rate=2r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#根据IP地址来限制，存储内存大小1M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=addr:1m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span>        <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#tcp_nopush     on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#keepalive_timeout  0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip  on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#所有以brand开始的请求，访问本地dongyimai-content-service微服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">location</span> <span class="s">/brand</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">limit_conn</span> <span class="s">addr</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://192.168.188.1:9001/brand</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/update_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/update_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/read_content</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">limit_req</span> <span class="s">zone=contentRateLimit</span> <span class="s">burst=4</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">content_by_lua_file</span> <span class="s">/root/lua/read_content.lua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>表示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">limit_conn_zone $binary_remote_addr zone=addr:10m;  表示限制根据用户的IP地址来显示，设置存储地址为的内存大小10M
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">limit_conn addr 2;   表示 限制每个IP只能发起2个连接。
</span></span></code></pre></div><p>测试：</p>
<p>此时开3个线程，测试的时候会发生异常，开2个就不会有异常
<img src="/posts/project-0/20220527222325/image-20220527223513044.png"
    
    
    
    loading="lazy"
    
    
></p>
<p><img src="/posts/project-0/20220527222325/image-20220527223521293.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="2限制每个客户端ip与服务器的连接数同时限制与虚拟服务器的连接总数了解">(2)限制每个客户端IP与服务器的连接数，同时限制与虚拟服务器的连接总数。(了解)</h5>
<p>如下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=perip:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">limit_conn_zone</span> <span class="nv">$server_name</span> <span class="s">zone=perserver:10m</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">charset</span> <span class="s">utf-8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">limit_conn</span> <span class="s">perip</span> <span class="mi">10</span><span class="p">;</span><span class="c1">#单个客户端ip与服务器的连接数．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">limit_conn</span> <span class="s">perserver</span> <span class="mi">100</span><span class="p">;</span> <span class="kn">＃限制与服务器的总连接数</span>
</span></span><span class="line"><span class="cl">        <span class="s">root</span>   <span class="s">html</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="八canal同步广告">八、canal同步广告</h1>
<p>canal可以用来监控数据库数据的变化，从而获得新增数据，或者修改的数据。</p>
<p>canal是应阿里巴巴存在杭州和美国的双机房部署，存在跨机房同步的业务需求而提出的。</p>
<p>阿里系公司开始逐步的尝试基于数据库的日志解析，获取增量变更进行同步，由此衍生出了增量订阅&amp;消费的业务。</p>
<h3 id="81-canal工作原理">8.1 Canal工作原理</h3>
<p><img src="/posts/project-0/20220527222325/image-20220527223529682.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>原理相对比较简单：</p>
<ol>
<li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li>
<li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li>
<li>canal解析binary log对象(原始为byte流)</li>
</ol>
<p>canal需要使用到mysql，我们需要先安装mysql,给大家发的虚拟机中已经安装了mysql容器，但canal是基于mysql的主从模式实现的，所以必须先开启binlog.</p>
<h3 id="82使用docker创建数据库容器">8.2、使用docker创建数据库容器</h3>
<p>（1）、上传mysql数据库配置文件mysqld.cnf</p>
<p>到服务器的/root目录下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="na">character-set-server</span><span class="o">=</span><span class="s">utf8</span>
</span></span><span class="line"><span class="cl"><span class="na">collation-server</span><span class="o">=</span><span class="s">utf8_general_ci</span>
</span></span><span class="line"><span class="cl"><span class="na">pid-file</span>        <span class="o">=</span> <span class="s">/var/run/mysqld/mysqld.pid</span>
</span></span><span class="line"><span class="cl"><span class="na">socket</span>          <span class="o">=</span> <span class="s">/var/run/mysqld/mysqld.sock</span>
</span></span><span class="line"><span class="cl"><span class="na">datadir</span>         <span class="o">=</span> <span class="s">/var/lib/mysql</span>
</span></span><span class="line"><span class="cl"><span class="c1">#log-error      = /var/log/mysql/error.log</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default we only accept connections from localhost</span>
</span></span><span class="line"><span class="cl"><span class="c1">#bind-address   = 127.0.0.1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disabling symbolic-links is recommended to prevent assorted security risks</span>
</span></span><span class="line"><span class="cl"><span class="na">symbolic-links</span><span class="o">=</span><span class="s">0</span>
</span></span></code></pre></div><p>（2）、上传数据库初始化脚本到 dongyimaidb.sql</p>
<p>到服务器的/root目录下</p>
<p>（3）、创建mysql容器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker run -d  --name=mysql  -v /root/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf -v /root/db.sql:/docker-entrypoint-initdb.d/mysql.sql -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=dongyimai-db --net=host  mysql:5.7
</span></span></code></pre></div><p><strong>注意</strong>：设置 网络模式为 host共享主机ip</p>
<h3 id="83-开启binlog模式">8.3 开启binlog模式</h3>
<p>先使用docker 创建mysql容器,此处不再演示.</p>
<p>(1) 连接到mysql容器中,并修改/etc/mysql/mysql.conf.d/mysqld.cnf  需要开启主 从模式，开启binlog模式。</p>
<p>执行如下命令，编辑mysql配置文件
<img src="/posts/project-0/20220527222325/image-20220527223546857.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>命令行如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">exec -it mysql /bin/bash</span>
</span></span><span class="line"><span class="cl"><span class="na">cd</span> <span class="s">/etc/mysql/mysql.conf.d</span>
</span></span><span class="line"><span class="cl"><span class="na">vi</span> <span class="s">mysqld.cnf</span>
</span></span></code></pre></div><p>修改mysqld.cnf配置文件，添加如下配置：
<img src="/posts/project-0/20220527222325/image-20220527223553071.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>上图配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">log-bin</span><span class="o">=</span><span class="s">/var/lib/mysql/mysql-bin</span>
</span></span><span class="line"><span class="cl"><span class="na">server-id</span><span class="o">=</span><span class="s">12345</span>
</span></span></code></pre></div><p>(2) 通过客户端创建账号 用于测试使用,</p>
<p>使用root账号创建用户并授予权限</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">create</span> <span class="s">user canal@&#39;%&#39; IDENTIFIED by &#39;canal&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="na">GRANT</span> <span class="s">SELECT, REPLICATION SLAVE, REPLICATION CLIENT,SUPER ON *.* TO &#39;canal&#39;@&#39;%&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="na">FLUSH</span> <span class="s">PRIVILEGES;</span>
</span></span></code></pre></div><p>(3)重启mysql容器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">restart mysql</span>
</span></span></code></pre></div><h3 id="84-canal容器安装">8.4 canal容器安装</h3>
<p>下载镜像：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">pull docker.io/canal/canal-server</span>
</span></span></code></pre></div><p>容器安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">run   --name canal -d --net=host docker.io/canal/canal-server</span>
</span></span></code></pre></div><p>进入容器,修改核心配置canal.properties 和instance.properties，canal.properties 是canal自身的配置，instance.properties是需要同步数据的数据库连接配置。</p>
<p>执行代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">exec -it canal /bin/bash</span>
</span></span><span class="line"><span class="cl"><span class="na">cd</span> <span class="s">canal-server/conf/example</span>
</span></span><span class="line"><span class="cl"><span class="na">vi</span> <span class="s">instance.properties</span>
</span></span></code></pre></div><p>修改instance.properties,配置数据库连接地址:</p>
<p>注意ip填写mysql绑定的主机ip：192.168.188.128(每个人都不一样)
<img src="/posts/project-0/20220527222325/image-20220527223636376.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>因为当前mysql容器采用了host共享主机ip模式，所以，监听ip写宿主机的ip就可以
<img src="/posts/project-0/20220527222325/image-20220527223644877.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>这里的<code>canal.instance.filter.regex</code>有多种配置，如下：</p>
<p>可以参考地址如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">https://github.com/alibaba/canal/wiki/AdminGuide
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">mysql</span> <span class="s">数据解析关注的表，Perl正则表达式.</span>
</span></span><span class="line"><span class="cl"><span class="na">多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\)</span> 
</span></span><span class="line"><span class="cl"><span class="err">常见例子：</span>
</span></span><span class="line"><span class="cl"><span class="na">1.</span>  <span class="s">所有表：.*   or  .*\\..*</span>
</span></span><span class="line"><span class="cl"><span class="na">2.</span>  <span class="s">canal schema下所有表： canal\\..*</span>
</span></span><span class="line"><span class="cl"><span class="na">3.</span>  <span class="s">canal下的以canal打头的表：canal\\.canal.*</span>
</span></span><span class="line"><span class="cl"><span class="na">4.</span>  <span class="s">canal schema下的一张表：canal.test1</span>
</span></span><span class="line"><span class="cl"><span class="na">5.</span>  <span class="s">多个规则组合使用：canal\\..*,mysql.test1,mysql.test2 (逗号分隔)</span>
</span></span><span class="line"><span class="cl"><span class="na">注意：此过滤条件只针对row模式的数据有效(ps.</span> <span class="s">mixed/statement因为不解析sql，所以无法准确提取tableName进行过滤)</span>
</span></span></code></pre></div><p>配置完成后，设置开机启动，并记得重启canal。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">update --restart=always canal</span>
</span></span><span class="line"><span class="cl"><span class="na">docker</span> <span class="s">restart canal</span>
</span></span></code></pre></div><p>开启cancal的防火墙端口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">firewall-cmd --add-port=11111/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></div><h3 id="85-canal微服务搭建">8.5 canal微服务搭建</h3>
<p>当用户执行 数据库的操作的时候，binlog 日志会被canal捕获到，并解析出数据。我们就可以将解析出来的数据进行同步到redis中即可。</p>
<p>思路：创建一个独立的程序，并监控canal服务器，获取binlog日志，解析数据，将数据更新到redis中。这样广告的数据就更新了。</p>
<p>(1)安装辅助jar包</p>
<p>在<code>源码\spring-boot-starter-canal-master</code>中有一个工程<code>starter-canal</code>，它主要提供了SpringBoot环境下<code>canal</code>的支持，我们需要先安装该工程，在<code>starter-canal</code>目录下执行<code>mvn install</code>，如下图：
<img src="/posts/project-0/20220527222325/image-20220527223655805.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>(2)canal微服务工程搭建</p>
<p>在dongyimai-service下创建dongyimai-canal-service工程，并引入相关配置。</p>
<p>pom.xml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-service<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>dongyimai-canal-service<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;maven.compiler.source&gt;</span>8<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;maven.compiler.target&gt;</span>8<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--canal依赖--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.xpand<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>starter-canal<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>dongyimai-content-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><p>application.yml配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">server</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">port</span><span class="o">:</span> <span class="s">9003</span>
</span></span><span class="line"><span class="cl"><span class="na">spring</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">application</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">name</span><span class="o">:</span> <span class="s">canal</span>
</span></span><span class="line"><span class="cl"><span class="na">eureka</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">client</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">service-url</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">defaultZone</span><span class="o">:</span> <span class="s">http://127.0.0.1:8761/eureka</span>
</span></span><span class="line"><span class="cl">  <span class="na">instance</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">prefer-ip-address</span><span class="o">:</span> <span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">feign</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">hystrix</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">enabled</span><span class="o">:</span> <span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="c1">#hystrix 配置</span>
</span></span><span class="line"><span class="cl"><span class="na">hystrix</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">command</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">execution</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="na">timeout</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="c1">#如果enabled设置为false，则请求超时交给ribbon控制</span>
</span></span><span class="line"><span class="cl">          <span class="na">enabled</span><span class="o">:</span> <span class="s">true</span>
</span></span><span class="line"><span class="cl">        <span class="na">isolation</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="na">strategy</span><span class="o">:</span> <span class="s">SEMAPHORE</span>
</span></span><span class="line"><span class="cl"><span class="c1">#canal配置</span>
</span></span><span class="line"><span class="cl"><span class="na">canal</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="na">client</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="na">instances</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="na">example</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="na">host</span><span class="o">:</span> <span class="s">192.168.188.128</span>
</span></span><span class="line"><span class="cl">        <span class="na">port</span><span class="o">:</span> <span class="s">11111</span>
</span></span></code></pre></div><p>注意：开启canal服务器的端口防火墙</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">firewall-cmd --add-port=11111/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --add-port=3306/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></div><p>(3)监听创建</p>
<p>创建一个CanalDataEventListener类，实现对表增删改操作的监听，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.canal.listener</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.otter.canal.protocol.CanalEntry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.xpand.starter.canal.annotation.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@CanalEventListener</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CanalDataEventListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 增加数据监听
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param eventType
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param rowData
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@InsertListenPoint</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEventInsert</span><span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">CanalEntry</span><span class="o">.</span><span class="na">RowData</span> <span class="n">rowData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rowData</span><span class="o">.</span><span class="na">getAfterColumnsList</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">c</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;By--Annotation: &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; ::   &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 修改数据监听
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param rowData
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@UpdateListenPoint</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEventUpdate</span><span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">RowData</span> <span class="n">rowData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;UpdateListenPoint&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rowData</span><span class="o">.</span><span class="na">getAfterColumnsList</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">c</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;By--Annotation: &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; ::   &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 删除数据监听
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param eventType
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DeleteListenPoint</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEventDelete</span><span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;DeleteListenPoint&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 自定义数据修改监听
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param eventType
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param rowData
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ListenPoint</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&#34;example&#34;</span><span class="o">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="s">&#34;dongyimaidb&#34;</span><span class="o">,</span> <span class="n">table</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;tb_content_category&#34;</span><span class="o">,</span> <span class="s">&#34;tb_content&#34;</span><span class="o">},</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">UPDATE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEventCustomUpdate</span><span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">CanalEntry</span><span class="o">.</span><span class="na">RowData</span> <span class="n">rowData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;CustomUpdateListenPoint&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rowData</span><span class="o">.</span><span class="na">getAfterColumnsList</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">c</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;By--Annotation: &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; ::   &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>(4)启动类创建</p>
<p>在com.offcn.canal中创建启动类，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">@SpringBootApplication(exclude</span><span class="o">=</span><span class="s">{DataSourceAutoConfiguration.class})</span>
</span></span><span class="line"><span class="cl"><span class="err">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="err">@EnableCanalClient</span>
</span></span><span class="line"><span class="cl"><span class="na">public</span> <span class="s">class CanalApplication {</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="na">public</span> <span class="s">static void main(String[] args) {</span>
</span></span><span class="line"><span class="cl"><span class="err">        SpringApplication.run(CanalApplication.class,args);</span>
</span></span><span class="line"><span class="cl"><span class="err">    }</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span></code></pre></div><p>(5)测试</p>
<p>启动canal微服务，然后修改任意数据库的表数据，canal微服务后台输出如下：
<img src="/posts/project-0/20220527222325/image-20220527223709777.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="86-广告同步作业">8.6 广告同步(作业)</h3>
<p><img src="/posts/project-0/20220527222325/image-20220527223719678.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>如上图，每次执行广告操作的时候，会记录操作日志到，然后将操作日志发送给canal，canal将操作记录发送给canal微服务，canal微服务根据修改的分类ID调用content微服务查询分类对应的所有广告，canal微服务再将所有广告存入到Redis缓存。</p>
<h4 id="861-content微服务搭建">8.6.1 content微服务搭建</h4>
<p>在dongyimai-service中搭建dongyimai-content-servic微服务，对应的dao、service、controller、pojo、feign由代码生成器生成。</p>
<h5 id="8611构建工程">8.6.1.1、构建工程</h5>
<p>创建模块：</p>
<p>（1）、dongyimai-content-service-api
<img src="/posts/project-0/20220527222325/image-20220527223734068.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>模块继承父工程：dongyimai-service-api</p>
<p>新建包:com.offcn.content.pojo</p>
<p>（2）、dongyimai-content-service
<img src="/posts/project-0/20220527222325/image-20220527223743712.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>模块继承父工程：dongyimai-service</p>
<p>新建包:com.offcn.content</p>
<p>引入依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;groupId&gt;</span>com.offcn<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;artifactId&gt;</span>dongyimai-content-service-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id="8612生成代码拷贝到工程">8.6.1.2、生成代码、拷贝到工程</h5>
<p>（1）、dongyimai-content-service-api模块中拷贝生成的pojo实体类、feign调用接口
<img src="/posts/project-0/20220527222325/image-20220527223752254.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>（2）、dongyimai-content-service模块中拷贝生成的dao、service、controller代码
<img src="/posts/project-0/20220527222325/image-20220527223800524.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="8613创建配置文件">8.6.1.3、创建配置文件</h5>
<p>在模块dongyimai-content-service下 src/main/resources目录下创建配置文件:application.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9004</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">content</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.jdbc.Driver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/dongyimaidb?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8761/eureka  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#设定Hystrix熔断超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">execution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">isolation</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">thread</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutInMilliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">6000</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">configuration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">map-underscore-to-camel-case</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c">#开启驼峰式编写规范</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.offcn.content.pojo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 配置sql打印日志</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">com.offcn.content</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span></span></span></code></pre></div><h5 id="8614编写swagger文档配置类mybatisplus分页插件配置类">8.6.1.4、编写swagger文档配置类、MyBatisPlus分页插件配置类</h5>
<p>AppSwggerConfig.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.content.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.builders.ApiInfoBuilder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.builders.PathSelectors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.builders.RequestHandlerSelectors</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.service.ApiInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.spi.DocumentationType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.spring.web.plugins.Docket</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">springfox.documentation.swagger2.annotations.EnableSwagger2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableSwagger2</span> <span class="c1">//开启swagger2自动生成api文档的功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppSwggerConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Docket</span> <span class="nf">createRestApi</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Docket</span><span class="o">(</span><span class="n">DocumentationType</span><span class="o">.</span><span class="na">SWAGGER_2</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="s">&#34;webApi&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">apiInfo</span><span class="o">(</span><span class="n">apiInfo</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">select</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">apis</span><span class="o">(</span><span class="n">RequestHandlerSelectors</span><span class="o">.</span><span class="na">basePackage</span><span class="o">(</span><span class="s">&#34;com.offcn.content.controller&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">paths</span><span class="o">(</span><span class="n">PathSelectors</span><span class="o">.</span><span class="na">any</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ApiInfo</span> <span class="nf">apiInfo</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">ApiInfoBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="s">&#34;广告微服务-接口文档&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="s">&#34;提供广告模块的文档&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">termsOfServiceUrl</span><span class="o">(</span><span class="s">&#34;http://www.ujiuye.com/&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">version</span><span class="o">(</span><span class="s">&#34;1.0&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>PageConfig.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.content.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.annotation.DbType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Auther: lhq
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date: 2021/1/25 10:41
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Description:
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">MybatisPlusInterceptor</span> <span class="nf">mybatisPlusInterceptor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MybatisPlusInterceptor</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MybatisPlusInterceptor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">interceptor</span><span class="o">.</span><span class="na">addInnerInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="n">PaginationInnerInterceptor</span><span class="o">(</span><span class="n">DbType</span><span class="o">.</span><span class="na">MYSQL</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">interceptor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="8615编写主启动类">8.6.1.5、编写主启动类</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@MapperScan</span><span class="o">(</span><span class="s">&#34;com.offcn.content.dao&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContentApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ContentApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="862启动测试">8.6.2、启动测试</h4>
<h5 id="8621运行主启动类contentapplication启动项目">8.6.2.1、运行主启动类ContentApplication，启动项目</h5>
<p><img src="/posts/project-0/20220527222325/image-20220527223814254.png"
    
    
    
    loading="lazy"
    
    
></p>
<h5 id="8622访问swagger测试接口">8.6.2.2、访问Swagger测试接口</h5>
<p>访问地址:http://localhost:9003/swagger-ui.html
<img src="/posts/project-0/20220527222325/image-20220527223820172.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>swagger小bug解决：</p>
<p>使用swagger文档的时候，在后台出现错误如下：
<img src="/posts/project-0/20220527222325/image-20220527223825134.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>解决bug方法，修改dongyimai-parent的依赖配置文件pom.xml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="c">&lt;!--swagger--&gt;</span>       
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.springfox<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>springfox-swagger2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>${swagger.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;groupId&gt;</span>io.swagger<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;artifactId&gt;</span>swagger-models<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.swagger<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>swagger-models<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.5.21<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>       
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.springfox<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>springfox-swagger-ui<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>${swagger.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>把springfox-swagger2所依赖的swagger-models排除掉，引入1.5.21版本的swagger-models。</p>
<p>广告微服务开发完成，具体管理页面，和web前端进行对接实现！</p>
<h4 id="863-广告查询">8.6.3 广告查询</h4>
<p>在content微服务中，添加根据分类查询广告。</p>
<p>(1)业务层</p>
<p>修改dongyimai-content-service的com.offcn.content.service.ContentService接口，添加根据分类ID查询广告数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 根据categoryId查询广告集合
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span> <span class="nf">findByCategory</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
</span></span></code></pre></div><p>修改dongyimai-content-service的com.offcn.content.service.impl.ContentServiceImpl接口实现类，添加根据分类ID查询广告数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span> <span class="nf">findByCategory</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建查询条件数据封装对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Content</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Content</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置广告分类id查询条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">content</span><span class="o">.</span><span class="na">setCategoryId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置广告状态为 1 可用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">content</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//构建查询条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span> <span class="n">queryWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">createQueryWrapper</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置按照排序字段升序进行排序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">queryWrapper</span><span class="o">.</span><span class="na">orderByAsc</span><span class="o">(</span><span class="s">&#34;sort_order&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//发出查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">queryWrapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(2)控制层</p>
<p>修改dongyimai-content-service的com.offcn.content.controller.ContentController,添加根据分类ID查询广告数据，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据categoryId查询广告集合
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param content
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;根据categoryId查询广告集合&#34;</span><span class="o">,</span><span class="n">notes</span> <span class="o">=</span> <span class="s">&#34;根据categoryId查询广告集合&#34;</span><span class="o">,</span><span class="n">tags</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;ContentController&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ApiImplicitParam</span><span class="o">(</span><span class="n">paramType</span> <span class="o">=</span> <span class="s">&#34;path&#34;</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;分类id&#34;</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">dataType</span> <span class="o">=</span> <span class="s">&#34;Long&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/list/category/{id}&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;&gt;</span> <span class="nf">findByCategory</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//调用ContentService实现条件查询Content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">contentService</span><span class="o">.</span><span class="na">findByCategory</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;&gt;(</span><span class="kc">true</span><span class="o">,</span><span class="n">StatusCode</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span><span class="s">&#34;查询成功&#34;</span><span class="o">,</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>(3)feign配置</p>
<p>在dongyimai-content-service-api工程中ContentFeign添加获取指定分类id广告数据方法调用，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#34;content&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/content&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ContentFeign</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/***
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据分类ID查询所有广告
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/list/category/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;&gt;</span> <span class="nf">findByCategory</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="864-同步实现">8.6.4 同步实现</h4>
<p>在canal微服务中修改如下:</p>
<p>(1)配置redis</p>
<p>修改application.yml配置文件，添加redis配置，如下代码：
<img src="/posts/project-0/20220527222325/image-20220527223844163.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>（2）、配置熔断超时时间</p>
<p>修改application.yml配置文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#设定Hystrix熔断超时时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">execution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">isolation</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">thread</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutInMilliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">6000</span><span class="w"> 
</span></span></span></code></pre></div><p>(3)启动类中开启feign</p>
<p>修改CanalApplication，添加<code>@EnableFeignClients</code>注解，代码如下：
<img src="/posts/project-0/20220527222325/image-20220527223851183.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>错误：出现连接数据失败错误，修改主启动类排除数据库自动配置</p>
<p>(3)同步实现</p>
<p>修改监听类CanalDataEventListener，实现监听广告的增删改，并根据增删改的数据使用feign查询对应分类的所有广告，将广告存入到Redis中，代码如下：</p>
<p>上图代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@CanalEventListener</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CanalDataEventListener</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ContentFeign</span> <span class="n">contentFeign</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//自定义数据库的 操作来监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//destination = &#34;example&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@ListenPoint</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">&#34;example&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">schema</span> <span class="o">=</span> <span class="s">&#34;dongyimaidb&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;tb_content&#34;</span><span class="o">,</span> <span class="s">&#34;tb_content_category&#34;</span><span class="o">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventType</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">UPDATE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">DELETE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">INSERT</span><span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEventCustomUpdate</span><span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">CanalEntry</span><span class="o">.</span><span class="na">RowData</span> <span class="n">rowData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1.获取列名 为category_id的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">categoryId</span> <span class="o">=</span> <span class="n">getColumnValue</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="n">rowData</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2.调用feign 获取该分类下的所有的广告集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Result</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;&gt;</span> <span class="n">categoryresut</span> <span class="o">=</span> <span class="n">contentFeign</span><span class="o">.</span><span class="na">findByCategory</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">categoryId</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">categoryresut</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.使用redisTemplate存储到redis中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">boundValueOps</span><span class="o">(</span><span class="s">&#34;content_&#34;</span> <span class="o">+</span> <span class="n">categoryId</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getColumnValue</span><span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">CanalEntry</span><span class="o">.</span><span class="na">RowData</span> <span class="n">rowData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">categoryId</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断 如果是删除  则获取beforlist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">eventType</span> <span class="o">==</span> <span class="n">CanalEntry</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">DELETE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">Column</span> <span class="n">column</span> <span class="o">:</span> <span class="n">rowData</span><span class="o">.</span><span class="na">getBeforeColumnsList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">column</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;category_id&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">categoryId</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">categoryId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//判断 如果是添加 或者是更新 获取afterlist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">CanalEntry</span><span class="o">.</span><span class="na">Column</span> <span class="n">column</span> <span class="o">:</span> <span class="n">rowData</span><span class="o">.</span><span class="na">getAfterColumnsList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">column</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&#34;category_id&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">categoryId</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">categoryId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>测试：</p>
<p>修改数据库数据，可以看到Redis中的缓存跟着一起变化
<img src="/posts/project-0/20220527222325/image-20220527223900287.png"
    
    
    
    loading="lazy"
    
    
></p>

            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220527231000/">← 商品搜索</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/project-0/20220527224880/">搜索解决方案-Elasticsearch →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>