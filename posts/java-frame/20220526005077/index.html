<!DOCTYPE html>
<html><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=no">
  <meta name="description" content="MJH Blog & MEET HTML Theme">
  <title>Spring-2</title>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.4/tocbot.css">
  
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" />
  <script type="text/javascript">
    if (!!window.ActiveXObject || "ActiveXObject" in window) { 
      alert('朋友，上古浏览器不支持呢~');
    }
  </script>

  <style>
    .sidebar {
      z-index: 998;
      position: fixed;
      left: -200px;
      width: 200px;
      height: 100%;
      background: #ffffff;
      transition: all .5s ease;
    }

    .sidebar .top {
      font-size: 22px;
      color: rgb(0, 0, 0);
      text-align: center;
      height: 60px;
      line-height: 60px;
      background-color: rgb(255, 255, 255);
      user-select: none;

    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul a {
      display: block;
      height: 100%;
      width: 100%;
      text-align: center;
      line-height: 45px;
      font-size: 18px;
      color: rgb(0, 0, 0);
      box-sizing: border-box;
      border-top: 1px solid rgb(255, 0, 0);
      border-bottom: 1px solid rgb(0, 17, 255);
      transition: .4s;
    }

    .sidebar ul li:hover a {
      padding-left: 30px;
      color: #7c4242;
      border-left: 5px solid #ffffff;
      transition: all 0.5s;
    }

    .sidebar ul a i {
      margin-right: 16px;
    }

    #check {
      display: none;
    }

    label #btn,
    label #cancel {
      position: fixed;
      cursor: pointer;
      background-color: #000000;
      border-radius: 3px;
    }

    label #btn {
      left: 5px;
      top: 7px;
      font-size: 25px;
      color: #fff;
      padding: 6px 10px;
      transition: all .5s;
      z-index: 999;
    }

    label #cancel {
      z-index: 999;
      left: -145px;
      top: 10px;
      font-size: 25px;
      color: rgb(255, 255, 255);
      padding: 4px 9px;
      transition: all .5s ease;
    }

    #check:checked~.sidebar {
      left: 0;
    }

    #check:checked~label #btn {
      left: 10px;
      opacity: 0;
      pointer-events: none;
    }

    #check:checked~label #cancel {
      left: 150px;
    }







     
    ::-webkit-scrollbar {
      width: 8px;
      height: 6px
    }

     
    ::-webkit-scrollbar-track {
      background-color: transparent;
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }

     
    ::-webkit-scrollbar-thumb {
      background-color: #30B07F;
      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, .4) 100%, transparent 100%, transparent 50%, rgba(255, 255, 255, .4) 50%, rgba(255, 255, 255, .4) 75%, transparent 75%, transparent);
      -webkit-border-radius: 2em;
      -moz-border-radius: 2em;
      border-radius: 2em
    }






     
    .navigation {
      width: 100%;
      height: 50px;
       
      position: fixed;
      left: 0;
      top: 0;
      text-align: center;
      transition: top 0.5s;
      z-index: 999;

      background: rgba(255, 255, 255, .4) !important;
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px) !important;
    }

     
    .hide {
      top: -60px;
    }



     
    .btn {
      width: 120px;
      height: 40px;
      background: linear-gradient(315deg, #a4d8fa 0%, #5eb1e9 74%);
      border: none;
      border-radius: 10px;
      font-family: 'Lato', sans-serif;
      font-weight: 500;
      font-size: smaller;
      color: #fff;
      box-shadow: inset 2px 2px 2px 0px rgba(255, 255, 255, .5),
        7px 7px 20px 0px rgba(0, 0, 0, .1),
        4px 4px 5px 0px rgba(0, 0, 0, .1);
      outline: none;
      position: relative;
      z-index: 0;
    }

    .btn::before {
      position: absolute;
      content: '';
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
      z-index: -1;
    }

    .btn:hover::before {
      top: 0;
      height: 100%;
    }

    .btn:active {
      top: 2px;
    }




     
    a.toc-link {
      color: currentColor;
      height: auto;
    }

     
    * {
      font-family: LXGW WenKai
    }

    * {
      font-weight: bold
    }

    body {
      font-family: LXGW WenKai;
    }




     
    .pagination {
      display: flex;
      flex-flow: row nowrap;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 0px;
    }

    .pagination a {
      text-decoration: none;
      font-size: 22px;
      color: rgb(0, 0, 0);
    }

    .page-item {
      display: inline;
      margin-right: 20px;
    }
  </style>

</head>
    <body style="    
    background-image: url(https://api.ixiaowai.cn/api/api.php);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    -moz-background-size: 100% 100%;">
    <input type="checkbox" id="check">
<label for="check">
  <i class="fa fa-bars" id="btn"></i>
  <i class="fa fa-times" id="cancel"></i>
</label>
<div class="sidebar">
  <div class="top">Hi~</div>
  <ul>
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</div>
<div id="body-wrap">
  <nav class="navigation">
  <ul class="ull">
    
    <li class="lii">
      <a href="/">
        <div class="burger-item">
          <i class='fa fa-home'></i> 主页
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/posts">
        <div class="burger-item">
          <i class='fa fa-archive'></i> 文章
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/categories">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 分类
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/archive">
        <div class="burger-item">
          <i class='fa fa-folder-open'></i> 归档
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/tags">
        <div class="burger-item">
          <i class='fa fa-tags'></i> 标签
        </div>
      </a>
    </li>
    
    <li class="lii">
      <a href="/about">
        <div class="burger-item">
          <i class='fa fa-info-circle'></i> 关于
        </div>
      </a>
    </li>
    
  </ul>
</nav>
  <div style="width: 100%; height: 65vh;">
    <div id="page_site-info">
      <div id="site-title">
        <input type="checkbox" id="check">
        <br>
        <span class="blogtitle"></span>
        
        
        <div class="post-header">
          <span>
            
            <i class="fa fa-calendar"></i>
            2022-05-25&nbsp;
          </span>
          <span>
            
            <i class="fa fa-calendar-check-o"></i>
            2022-05-25&nbsp;&nbsp;&nbsp;
          </span>
          <span>
            
            <i class="fa fa-edit"></i>
            11177 字
          </span>&nbsp;
          <span>
            
            <i class="fa fa-paper-plane"></i>
            23 分钟
          </span>
        </div><div class="container-ctgtag">
	<div class="taxonomy" style="display: flex; justify-content: center;">
		
		<div class="ctg" style="display: flex; justify-content: center; margin-right: 20px;">
			
			<div style="margin-right: 10px;">
				
				<a href="/categories/"></a>
			</div>
			
		</div>
		<div class="tag" style="display: flex; justify-content: center;">
			
			<div style="margin-right: 10px;">
				
				<a href="/tags/"></a></i>
			</div>
			
		</div>
	</div>
</div>

        <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
        <script>
          var typed = new Typed(".blogtitle", {
            strings: ['Spring-2'],
            startDelay: 300,
            typeSpeed: 100,
            loop: true,
            backSpeed: 50,
            showCursor: true
          });
        </script>
      </div>
    </div>
  </div>
  
<main id="content-outer">
    <div class="layout_page" id="content-inner">
        <article id="page" style="margin-right: 10px;">
            
            <div class="js-toc-content" style="height: 100%;">
                <p>复习回顾：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DI： 依赖注入
</span></span><span class="line"><span class="cl">依赖注入的方式： 
</span></span><span class="line"><span class="cl">构造器注入： 
</span></span><span class="line"><span class="cl">setter注入u:
</span></span><span class="line"><span class="cl">P名称空间注入：
</span></span><span class="line"><span class="cl">SpEL表达式注入：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IOC的注解版本： 
</span></span><span class="line"><span class="cl">@Component  所属的类没有明确的层级划分， 此时就可以使用该注解。
</span></span><span class="line"><span class="cl">@Repository dao层
</span></span><span class="line"><span class="cl">@Service service层：
</span></span><span class="line"><span class="cl">@Controller web层：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DI的相关注解： 
</span></span><span class="line"><span class="cl">@Value(&#34;&#34;) 能够获得配置文件当中的内容： 
</span></span><span class="line"><span class="cl">@Autowire 根据类型自动装配。  如果容器当中有多个对象， 此时就会根据名称进行装配。 
</span></span><span class="line"><span class="cl">@Qualifier 根据对象的名称进行装配。 
</span></span><span class="line"><span class="cl">@Resource java提供的， @Autowire+@Qualifier 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">JdbcTemplate模板对象： 
</span></span><span class="line"><span class="cl">query() | queryForObject()
</span></span><span class="line"><span class="cl">update()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">spring整合Junit： 
</span></span><span class="line"><span class="cl">（1）引入依赖包： 
</span></span><span class="line"><span class="cl">（2）引入注解：
</span></span></code></pre></div><h1 id="0实现转账业务">0、实现转账业务</h1>
<h2 id="一-实现转账业务">一： 实现转账业务</h2>
<h3 id="1-底层数据库表-account">1 底层数据库表： Account</h3>
<h3 id="2-实现类-account">2 实现类： Account</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Double</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">getter</span> <span class="err">和</span> <span class="n">setter</span> <span class="o">...</span> 
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="3-accountdao-层接口--accountdaoimpl">3 AccountDao 层接口 &amp; AccountDaoImpl</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.dao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pojo.Account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountDao</span> <span class="o">{</span><span class="c1">// data access object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  根据id进行唯一性查询
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="n">Account</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 更新账户的方法：
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param account
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.dao.impl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.dao.AccountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pojo.Account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.dbutils.QueryRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.dbutils.handlers.BeanHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//private JdbcTemplate jdbcTemplate;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">QueryRunner</span> <span class="n">queryRunner</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">QueryRunner</span> <span class="nf">getQueryRunner</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setQueryRunner</span><span class="o">(</span><span class="n">QueryRunner</span> <span class="n">queryRunner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">queryRunner</span> <span class="o">=</span> <span class="n">queryRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">&#34;select * from account where id=?&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">queryRunner</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanHandler</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;(</span><span class="n">Account</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">&#34;update account set money=? where id=?&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">queryRunner</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">(),</span><span class="n">account</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="4-accountservice层接口--accountserviceimpl">4 AccountService层接口 &amp; AccountServiceImpl</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.service</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义转账方法：
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param sourceId 来源账户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param targetId 目标账户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param money    转账金额
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">sourceId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">targetId</span><span class="o">,</span> <span class="n">Double</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.service.impl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.dao.AccountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pojo.Account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.service.AccountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">sourceId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">targetId</span><span class="o">,</span> <span class="n">Double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1: 查询来源账户,查询目标账户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Account</span> <span class="n">sAcc</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">sourceId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Account</span> <span class="n">tAcc</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">targetId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//2: 内存当中修改金额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sAcc</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">sAcc</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tAcc</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">tAcc</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//3: 更新到数据库当中：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sAcc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">tAcc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AccountDao</span> <span class="nf">getAccountDao</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">accountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="5-applicationcontextxml-管理对象">5: applicationContext.xml 管理对象</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--dataSource--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClassName&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;url&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;username&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--构建QueryRunner 对象
</span></span></span><span class="line"><span class="cl"><span class="c">       QueryRunner qr = new QueryRunner(DataSource dataSource);
</span></span></span><span class="line"><span class="cl"><span class="c">    --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id =</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">class=</span><span class="s">&#34;org.apache.commons.dbutils.QueryRunner&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&#34;ds&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--accountDao--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;accountDao&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.dao.impl.AccountDaoImpl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">ref=</span><span class="s">&#34;queryRunner&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">                  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--accountService--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;accountService&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.service.impl.AccountServiceImpl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;accountDao&#34;</span> <span class="na">ref=</span><span class="s">&#34;accountDao&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h3 id="6-转账测试">6 转账测试</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.service.AccountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringJUnit4ClassRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:applicationContext.xml&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTransfer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountService</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountService</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="mi">1001</span><span class="o">,</span><span class="mi">1002</span><span class="o">,</span><span class="mi">100</span><span class="n">D</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="二事务相关内容复习">二、事务相关内容复习</h2>
<p>1、事务的定义</p>
<p>2、事务的特性</p>
<p>3、事务的隔离级别</p>
<p>4、不同事务隔离级别，产生不同的错误数据。</p>
<p>5、事务相关的代码： Connection ~</p>
<h2 id="三事务控制-threadlocal">三、事务控制-ThreadLocal</h2>
<h3 id="1定义了一个连接的工具类">1.定义了一个连接的工具类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 管理连接的工具类：  
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionUtil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">;</span><span class="c1">//准备连接对象： 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ThreadLocal: map
</span></span></span><span class="line"><span class="cl"><span class="cm">     * map.put(线程对象，value);
</span></span></span><span class="line"><span class="cl"><span class="cm">     * map.get(线程对象);
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//绑定在ThreadLocal当中： 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="n">connection</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="2改造了accountdaoimpl">2、改造了AccountDaoImpl</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.dao.impl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.dao.AccountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pojo.Account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.utils.ConnectionUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.dbutils.QueryRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.commons.dbutils.handlers.BeanHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//private JdbcTemplate jdbcTemplate;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">QueryRunner</span> <span class="n">queryRunner</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ConnectionUtil</span> <span class="n">connectionUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ConnectionUtil</span> <span class="nf">getConnectionUtil</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">connectionUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnectionUtil</span><span class="o">(</span><span class="n">ConnectionUtil</span> <span class="n">connectionUtil</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">connectionUtil</span> <span class="o">=</span> <span class="n">connectionUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">QueryRunner</span> <span class="nf">getQueryRunner</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setQueryRunner</span><span class="o">(</span><span class="n">QueryRunner</span> <span class="n">queryRunner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">queryRunner</span> <span class="o">=</span> <span class="n">queryRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">&#34;select * from account where id=?&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">queryRunner</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">connectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(),</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanHandler</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;(</span><span class="n">Account</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">&#34;update account set money=? where id=?&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">queryRunner</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">connectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">()</span> <span class="o">,</span><span class="n">sql</span><span class="o">,</span><span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">(),</span><span class="n">account</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="3定义了事务管理的工具类">3、定义了事务管理的工具类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.utils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 定义和事务相关的代码：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 事务的开启 提交  回滚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ConnectionUtil</span> <span class="n">connectionUtil</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//开启事务：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">beginTransaction</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">connection</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//事务提交
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">commit</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">connection</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//事务提交
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">rollback</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">connection</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//定义释放资源：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionUtil</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">throwables</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwables</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="4改造accountserviceimpl">4、改造AccountServiceImpl</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.service.impl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.dao.AccountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.pojo.Account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.service.AccountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.utils.TransactionManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">sourceId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">targetId</span><span class="o">,</span> <span class="n">Double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//开启事务：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">transactionManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//1: 查询来源账户,查询目标账户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Account</span> <span class="n">sAcc</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">sourceId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Account</span> <span class="n">tAcc</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">targetId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//2: 内存当中修改金额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">sAcc</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">sAcc</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">tAcc</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">tAcc</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//3: 更新到数据库当中：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sAcc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">i</span><span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">tAcc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//事务的提交：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//资源释放：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">transactionManager</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AccountDao</span> <span class="nf">getAccountDao</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">accountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountDao</span><span class="o">(</span><span class="n">AccountDao</span> <span class="n">accountDao</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">accountDao</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="5配置文件改造">5、配置文件改造</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--dataSource--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClassName&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;url&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;username&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--构建QueryRunner 对象
</span></span></span><span class="line"><span class="cl"><span class="c">       QueryRunner qr = new QueryRunner(DataSource dataSource);
</span></span></span><span class="line"><span class="cl"><span class="c">    --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id =</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">class=</span><span class="s">&#34;org.apache.commons.dbutils.QueryRunner&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--为了保证在同一个事务使用同一个连接，不能在构建qr的时候，执行指定DataSource--&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!--  &lt;constructor-arg name=&#34;ds&#34; ref=&#34;dataSource&#34;&gt;&lt;/constructor-arg&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--connectionUtil--&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;connectionUtil&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.utils.ConnectionUtil&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--transactionManager--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;transactionManager&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.utils.TransactionManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;connectionUtil&#34;</span> <span class="na">ref=</span><span class="s">&#34;connectionUtil&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--accountDao--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;accountDao&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.dao.impl.AccountDaoImpl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">ref=</span><span class="s">&#34;queryRunner&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;connectionUtil&#34;</span> <span class="na">ref=</span><span class="s">&#34;connectionUtil&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--accountService--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;accountService&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.service.impl.AccountServiceImpl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;accountDao&#34;</span> <span class="na">ref=</span><span class="s">&#34;accountDao&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;transactionManager&#34;</span> <span class="na">ref=</span><span class="s">&#34;transactionManager&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h3 id="6测试转账-考虑事务">6、测试转账-考虑事务</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.service.AccountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringJUnit4ClassRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:applicationContext.xml&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTransfer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountService</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountService</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="mi">1001</span><span class="o">,</span><span class="mi">1002</span><span class="o">,</span><span class="mi">100</span><span class="n">D</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="四-事务控制-动态代理">四、 事务控制-动态代理</h2>
<h3 id="1动态代理模式23">1、动态代理模式【23】</h3>
<p>你  【 中介 】  买房 买房~</p>
<p>代理的角色：</p>
<p>​    代理类： 代理对象【中介】</p>
<p>​    被代理类： 被代理对象【买房人】</p>
<p>​    目标方法： 核心业务</p>
<p>作用： 对某个类的某个方法进行功能增强。</p>
<p>动态代理分类：</p>
<p>​    （1）基于接口的动态代理（JDK的动态代理）：  被代理的类必须实现接口。 重要【JDK提供的】</p>
<p>​    （2）CGLIB代理： 地方提供的代理,需要引入第三方包。</p>
<h3 id="2动态代理的入门案例">2、动态代理的入门案例</h3>
<p>需求：  公司part ， person 完成晚会， sing dance</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.proxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CompanyParty</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sing</span><span class="o">(</span><span class="n">Double</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dance</span><span class="o">(</span><span class="n">Double</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>创建接口的实现类对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.proxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="kd">implements</span> <span class="n">CompanyParty</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sing</span><span class="o">(</span><span class="n">Double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;给你&#34;</span><span class="o">+</span><span class="n">money</span><span class="o">+</span><span class="s">&#34;sing&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dance</span><span class="o">(</span><span class="n">Double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;给你&#34;</span><span class="o">+</span><span class="n">money</span><span class="o">+</span><span class="s">&#34;dance&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>使用JDK的动态代理，获得person类的代理类对象，完成业务方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.proxy.CompanyParty</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.proxy.Person</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestProxy</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//被代理：person
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//person.dance(1001D);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//person.sing(1008D) ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  JDK的动态代理
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  Proxy: 反射包当中提供的类：
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  newProxyInstance(p1,p2,p3)： 获得代理类的方法：返回值是Object类型。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *     p1: ClassLoader 类的加载器。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *        目标对象(被代理对象)的类加载器。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         *     p2: 获得了接口当中所有的方法。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *       目的： 代理类和被代理类对象有着相同的行为：
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         *     p3: InvocationHandler 定义代理对象和被代理对象之间的代理策略。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">CompanyParty</span> <span class="n">proxy</span> <span class="o">=(</span><span class="n">CompanyParty</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">person</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">person</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">                     *
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * @param proxy  一般情况不适用。
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * @param method  封装了执行的目标方法。
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * @param args    封装了执行目标方法的参数。
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * @return object  执行了目标方法，目标方法的返回值。
</span></span></span><span class="line"><span class="cl"><span class="cm">                     * @throws Throwable 执行目标方法，遇到异常信息
</span></span></span><span class="line"><span class="cl"><span class="cm">                     *
</span></span></span><span class="line"><span class="cl"><span class="cm">                     */</span>
</span></span><span class="line"><span class="cl">                    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span><span class="c1">//获得执行方法的名称。；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">Double</span> <span class="n">money</span> <span class="o">=</span> <span class="o">(</span><span class="n">Double</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span><span class="c1">//获得目标方法的参数信息：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">Object</span> <span class="n">obj</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="s">&#34;sing&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">money</span> <span class="o">&gt;=</span><span class="mi">1000</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">//真正执行目标方法：  p1:目标对象 p2: 目标方法需要的参数信息。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                             <span class="n">obj</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="s">&#34;dance&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)&amp;&amp;</span> <span class="n">money</span><span class="o">&gt;=</span><span class="mi">2000</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                             <span class="n">obj</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">proxy</span><span class="o">.</span><span class="na">sing</span><span class="o">(</span><span class="mi">1005</span><span class="n">D</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy</span><span class="o">.</span><span class="na">dance</span><span class="o">(</span><span class="mi">2005</span><span class="n">D</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="3-使用动态代理控制事务">3 使用动态代理控制事务</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">创建了工厂类，</span> <span class="err">生成代理类对象：</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn.factory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.service.AccountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.utils.TransactionManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 工厂对象用来生成代理类对象；
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanFactory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//目标对象：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">AccountService</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AccountService</span> <span class="nf">getProxy</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span>  <span class="o">(</span><span class="n">AccountService</span><span class="o">)</span><span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">               <span class="n">accountService</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">               <span class="n">accountService</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">               <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span><span class="c1">//达成具体的代理策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                   <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                   <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                       <span class="n">Object</span> <span class="n">invoke</span><span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                       <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                           <span class="c1">//开启事务： 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="n">transactionManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                           <span class="n">invoke</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">accountService</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                           <span class="c1">//提交事务： 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                           <span class="k">return</span> <span class="n">invoke</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                           <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                           <span class="c1">//执行业务方法， 遇到了异常信息： 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                       <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                           <span class="n">transactionManager</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                       <span class="o">}</span>
</span></span><span class="line"><span class="cl">                       <span class="k">return</span> <span class="n">invoke</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                   <span class="o">}</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span>
</span></span><span class="line"><span class="cl">       <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AccountService</span> <span class="nf">getAccountService</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccountService</span><span class="o">(</span><span class="n">AccountService</span> <span class="n">accountService</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">accountService</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TransactionManager</span> <span class="nf">getTransactionManager</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">transactionManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTransactionManager</span><span class="o">(</span><span class="n">TransactionManager</span> <span class="n">transactionManager</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>业务层改造：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">sourceId</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">targetId</span><span class="o">,</span> <span class="n">Double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//1: 查询来源账户,查询目标账户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Account</span> <span class="n">sAcc</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">sourceId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Account</span> <span class="n">tAcc</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">targetId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//2: 内存当中修改金额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">sAcc</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">sAcc</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">-</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">tAcc</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">tAcc</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()</span> <span class="o">+</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//3: 更新到数据库当中：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sAcc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">i</span><span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">tAcc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>BeanFactory配置在applicationContext.xml当中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="c">&lt;!--BeanFactory: 
</span></span></span><span class="line"><span class="cl"><span class="c">       配置了一个实例工厂： factory-bean 指定的工厂的实例对象
</span></span></span><span class="line"><span class="cl"><span class="c">                        factory-method：工厂方法，方法的返回值存在IOC容器当中
</span></span></span><span class="line"><span class="cl"><span class="c">     --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;factory&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.factory.BeanFactory&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;transactionManager&#34;</span> <span class="na">ref=</span><span class="s">&#34;transactionManager&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;accountService&#34;</span> <span class="na">ref=</span><span class="s">&#34;accountService&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">factory-bean=</span><span class="s">&#34;factory&#34;</span> <span class="na">factory-method=</span><span class="s">&#34;getProxy&#34;</span><span class="nt">&gt;&lt;/bean&gt;</span>
</span></span></code></pre></div><p>测试：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.offcn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.offcn.service.AccountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringJUnit4ClassRunner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="s">&#34;classpath:applicationContext.xml&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTransfer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;proxy&#34;</span><span class="o">)</span><span class="c1">//获得对象是代理对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">AccountService</span> <span class="n">proxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//accountService.transfer(1001,1002,100D);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">proxy</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="mi">1001</span><span class="o">,</span><span class="mi">1002</span><span class="o">,</span><span class="mi">100</span><span class="n">D</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h1 id="一-springaop机制详解">一、 SpringAOP机制详解</h1>
<h2 id="一aop-概述">（一）AOP 概述</h2>
<h3 id="1-什么是-aop">1 什么是 AOP</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">话术：
</span></span><span class="line"><span class="cl">AOP 为 Aspect Oriented Programming 的缩写，意思为面向切面编程，是通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">aop:面向切面编程
</span></span><span class="line"><span class="cl">底层： 动态代理 
</span></span><span class="line"><span class="cl">      反射： java语言， 是一个静态语言， 但是可以通过反射技术， 体现出来动态性。 
</span></span></code></pre></div><h3 id="2-aop编程思想">2 AOP编程思想</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">话术：
</span></span><span class="line"><span class="cl">AOP 面向切面编程是一种编程思想，是 OOP（面向对象） 的延续，是软件开发中的一个热点，也是Spring框架中的一个重要内容，是函数式编程的一种衍生范型。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">应用场景： aop 事务控制， 权限校验， 日志记录， 性能统计
</span></span></code></pre></div><h3 id="3-spring中的常用术语">3 Spring中的常用术语</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">话术：
</span></span><span class="line"><span class="cl">Joinpoint（连接点）：所谓连接点是指那些被拦截到的点。在spring中,这些点指的是方法，因为spring只支持方法类型的连接点。 
</span></span><span class="line"><span class="cl">所有有机会被增强的方法就就似乎链接点。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Pointcut（切点）：真正被增强的方法， 就是切点。  案例： transfer 方法。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Advice（通知/ 增强）：所谓通知是指拦截到 Joinpoint 之后所要做的事情就是通知。
</span></span><span class="line"><span class="cl">在transfer方法上， 进行了事务代码的增强。 事务代码就是通知~ 
</span></span><span class="line"><span class="cl">通知的类型：前置通知,正常返回通知,异常返回通知,最终通知,环绕通知。【面试问题】
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Target（目标对象）：代理的目标对象 [被代理对象]
</span></span><span class="line"><span class="cl">Proxy （代理）：一个类被 AOP 织入增强后，就产生一个结果代理类，代理类产生代理对象
</span></span><span class="line"><span class="cl">Weaving（织入）：是指把增强应用到目标对象来创建新的代理对象的过程
</span></span><span class="line"><span class="cl">Aspect（切面）：是切入点和通知（引介）的结合  
</span></span><span class="line"><span class="cl">              切面描述了： 具体的通知应用在具体的哪个切点上。
</span></span></code></pre></div><h3 id="4-aop-的作用及优势">4 AOP 的作用及优势</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">话术：
</span></span><span class="line"><span class="cl">作用：在程序运行期间，在不修改源码的情况下对方法进行功能增强
</span></span><span class="line"><span class="cl">优势：减少重复代码，提高开发效率，并且便于维护
</span></span></code></pre></div><h2 id="二spring基于xml的aop配置">（二）Spring基于XML的AOP配置</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">讲解思路： 
</span></span><span class="line"><span class="cl"> 1、搭建maven工程，沿用上一章节转账的业务场景
</span></span><span class="line"><span class="cl"> 2、准备好通知类TransactionManager
</span></span><span class="line"><span class="cl"> 3、讲解基于XML形式的AOP配置，详细介绍每个标签，每个标签当中属性的作用
</span></span><span class="line"><span class="cl"> 4、测试使用AOP进行事务配置
</span></span><span class="line"><span class="cl"> 5、常用通知类型的总结
</span></span><span class="line"><span class="cl"> 6、详解切入点表达式的语法，常用案例的列举
</span></span></code></pre></div><h3 id="1-环境搭建">1 环境搭建</h3>
<h4 id="11-构建maven工程添加依赖">1.1 构建maven工程添加依赖</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;spring.version&gt;</span>5.2.5.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.8.7<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h4 id="12-沿用转账业务的代码">1.2 沿用转账业务的代码</h4>
<p>搭建了转账环境~</p>
<h4 id="13-创建-spring-的配置文件并导入约束">1.3 创建 Spring 的配置文件并导入约束</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:aop=</span><span class="s">&#34;http://www.springframework.org/schema/aop&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.springframework.org/schema/beans
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop/spring-aop.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h4 id="14-配置-spring-的-ioc">1.4 配置 Spring 的 IOC</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 配置数据源 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.mchange.v2.c3p0.ComboPooledDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--连接数据库的必备信息--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClass&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;jdbcUrl&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;user&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- 配置Connection的工具类 ConnectionUtils --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;connectionUtils&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.utils.ConnectionUtils&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 注入数据源--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--配置queryRunner--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">class=</span><span class="s">&#34;org.apache.commons.dbutils.QueryRunner&#34;</span><span class="nt">&gt;&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--配置accountDao--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;accountDao&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.dao.impl.AccountDaoImpl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">ref=</span><span class="s">&#34;queryRunner&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;connectionUtils&#34;</span> <span class="na">ref=</span><span class="s">&#34;connectionUtils&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--配置accountService--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;accountService&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.service.impl.AccountServiceImpl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;accountDao&#34;</span> <span class="na">ref=</span><span class="s">&#34;accountDao&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span></code></pre></div><h4 id="15-抽取公共代码制作成通知增强代码">1.5 抽取公共代码制作成通知(增强代码)</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 和事务管理相关的工具类，它包含了，开启事务，提交事务，回滚事务和释放连接
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConnectionUtils</span><span class="o">(</span><span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">connectionUtils</span> <span class="o">=</span> <span class="n">connectionUtils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 开启事务
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">beginTransaction</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 提交事务
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">commit</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 回滚事务
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">rollback</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 释放连接
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">release</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connectionUtils</span><span class="o">.</span><span class="na">removeConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">close</span><span class="o">();</span><span class="c1">//还回连接池中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="2-aop-配置步骤">2 AOP 配置步骤</h3>
<h4 id="21-把通知类用-bean-标签配置起来">2.1 把通知类用 bean 标签配置起来</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--配置通知：txManager--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;txManager&#34;</span> <span class="na">class=</span><span class="s">&#34;com.offcn.utils.TransactionManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;connectionUtils&#34;</span> <span class="na">ref=</span><span class="s">&#34;connectionUtils&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span></code></pre></div><h4 id="22-使用-aopconfig-声明-aop-配置">2.2 使用 aop:config 声明 AOP 配置</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop:config: 
</span></span><span class="line"><span class="cl">   作用： 开始声明aop配置
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:config&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!-- 配置的代码都写在此处 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/aop:config&gt;</span>
</span></span></code></pre></div><h4 id="23-使用-aopaspect-配置切面">2.3 使用 aop:aspect 配置切面</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop：aspect
</span></span><span class="line"><span class="cl">   作用： 用于配置切面
</span></span><span class="line"><span class="cl">   属性： 
</span></span><span class="line"><span class="cl">         id ：给切面提供一个唯一标识。
</span></span><span class="line"><span class="cl">         ref：引用配置好的通知类 bean 的 id。
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:aspect</span> <span class="na">id=</span><span class="s">&#34;tdAdvice&#34;</span> <span class="na">ref=</span><span class="s">&#34;txManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="c">&lt;!--配置通知的类型要写在此处--&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/aop:aspect&gt;</span>
</span></span></code></pre></div><h4 id="24-使用-aoppointcut-配置切入点表达式">2.4 使用 aop:pointcut 配置切入点表达式</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop:pointcut
</span></span><span class="line"><span class="cl">   作用： 用于配置切入点表达式。就是指定对哪些类的哪些方法进行增强。
</span></span><span class="line"><span class="cl">   属性： expression：用于定义切入点表达式。
</span></span><span class="line"><span class="cl">         id：用于给切入点表达式提供一个唯一标识
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&#34;point1&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="na">expression=</span><span class="s">&#34;execution( public void  com.offcn.service.impl.AccountServiceImpl.transfer(java.lang.String,java.lang.String,java.lang.Double))&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        
</span></span></code></pre></div><h4 id="25--使用-aopxxx-配置对应的通知类型">2.5  使用 aop:xxx 配置对应的通知类型</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop：before
</span></span><span class="line"><span class="cl">    作用：用于配置前置通知。指定增强的方法在切入点方法之前执行
</span></span><span class="line"><span class="cl">    属性：
</span></span><span class="line"><span class="cl">         method:用于指定通知类中的增强方法名称
</span></span><span class="line"><span class="cl">		 ponitcut-ref：用于指定切入点的表达式的引用
</span></span><span class="line"><span class="cl">		 poinitcut：用于指定切入点表达式
</span></span><span class="line"><span class="cl">    执行时间点：
</span></span><span class="line"><span class="cl">         切入点方法执行之前执行   
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:before</span> <span class="na">method=</span><span class="s">&#34;beginTransaction&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;point1&#34;</span><span class="nt">&gt;&lt;/aop:before&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop:after-returning
</span></span><span class="line"><span class="cl">	作用： 
</span></span><span class="line"><span class="cl">    	用于配置后置通知
</span></span><span class="line"><span class="cl">	属性：
</span></span><span class="line"><span class="cl">   		method：指定通知中方法的名称。
</span></span><span class="line"><span class="cl">  		pointct：定义切入点表达式
</span></span><span class="line"><span class="cl">   		pointcut-ref：指定切入点表达式的引用
</span></span><span class="line"><span class="cl">   	执行时间点：
</span></span><span class="line"><span class="cl">   	    切入点方法正常执行之后。它和异常通知只能有一个执行
</span></span><span class="line"><span class="cl">   	    
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;aop:after-returning</span> <span class="na">method=</span><span class="s">&#34;commit&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;point1&#34;</span><span class="nt">/&gt;</span> 	    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop:after-throwing
</span></span><span class="line"><span class="cl">	作用：
</span></span><span class="line"><span class="cl">		用于配置异常通知
</span></span><span class="line"><span class="cl">	属性：
</span></span><span class="line"><span class="cl">		method：指定通知中方法的名称。
</span></span><span class="line"><span class="cl">		pointct：定义切入点表达式
</span></span><span class="line"><span class="cl">		pointcut-ref：指定切入点表达式的引用
</span></span><span class="line"><span class="cl">	执行时间点：
</span></span><span class="line"><span class="cl">		切入点方法执行产生异常后执行。它和后置通知只能执行一个
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;aop:after-throwing</span> <span class="na">method=</span><span class="s">&#34;rollback&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;point1&#34;</span><span class="nt">/&gt;</span>	
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">aop:after
</span></span><span class="line"><span class="cl">	作用：
</span></span><span class="line"><span class="cl">		用于配置最终通知
</span></span><span class="line"><span class="cl">	属性：
</span></span><span class="line"><span class="cl">        method：指定通知中方法的名称。
</span></span><span class="line"><span class="cl">        pointct：定义切入点表达式
</span></span><span class="line"><span class="cl">        pointcut-ref：指定切入点表达式的引用
</span></span><span class="line"><span class="cl">	执行时间点：
</span></span><span class="line"><span class="cl">		无论切入点方法执行时是否有异常，它都会在其后面执行。
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;aop:after</span> <span class="na">method=</span><span class="s">&#34;release&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;point1&#34;</span><span class="nt">/&gt;</span>
</span></span></code></pre></div><h3 id="3-切入点表达式说明">3 切入点表达式说明</h3>
<h4 id="31-切点表达式的语法">3.1 切点表达式的语法</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">execution</span><span class="o">([</span><span class="err">修饰符</span><span class="o">]</span> <span class="err">返回值类型</span> <span class="err">包名</span><span class="o">.</span><span class="err">类名</span><span class="o">.</span><span class="err">方法名</span><span class="o">(</span><span class="err">参数</span><span class="o">))</span>
</span></span></code></pre></div><ul>
<li>访问修饰符可以省略</li>
<li>返回值类型、包名、类名、方法名可以使用星号*  代表任意</li>
<li>包名与类名之间一个点 . 代表当前包下的类，两个点 .. 表示当前包及其子包下的类</li>
<li>参数列表可以使用两个点 .. 表示任意个数，任意类型的参数列表</li>
</ul>
<p>例如：</p>
<p>全匹配方式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">AccountServiceImpl</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">Account</span><span class="o">)</span>
</span></span></code></pre></div><p>访问修饰符可以省略</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">AccountServiceImpl</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">Account</span><span class="o">)</span>
</span></span></code></pre></div><p>返回值可以使用*号，表示任意返回值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">*</span> <span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">AccountServiceImpl</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">Account</span><span class="o">)</span>
</span></span></code></pre></div><p>包名可以使用 * 号，表示任意包，但是有几级包，需要写几个 *</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">*</span> <span class="o">*.*.*.*.</span><span class="na">AccountServiceImpl</span><span class="o">.</span><span class="na">saveAccount</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">ujiuye</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">Account</span><span class="o">)</span>
</span></span></code></pre></div><p>使用..来表示当前包，及其子包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* com..AccountServiceImpl.saveAccount(com.ujiuye.domain.Account)
</span></span></code></pre></div><p>类名可以使用*号，表示任意类</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* com..*.saveAccount(com.ujiuye.domain.Account)
</span></span></code></pre></div><p>方法名可以使用*号，表示任意方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* com..*.*( com.ujiuye.domain.Account)
</span></span></code></pre></div><p>参数列表可以使用*，表示参数可以是任意数据类型，但是必须有参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* com..*.*(*)
</span></span></code></pre></div><p>参数列表可以使用..表示有无参数均可，有参数可以是任意类型</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* com..*.*(..)
</span></span></code></pre></div><p>全通配方式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">* *..*.*(..)
</span></span></code></pre></div><p>注意： 通常情况下，我们都是对业务层的方法进行增强，所以切入点表达式都是切到业务层实现类。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">execution(* com.ujiuye.service.impl.*.*(..))
</span></span></code></pre></div><h3 id="4-环绕通知配置事务管理">4 环绕通知配置事务管理</h3>
<p>在TransactionManager类当中添加方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 环绕通知:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * spring 框架为我们提供了一个接口：ProceedingJoinPoint，它可以作为环绕通知的方法参数。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在环绕通知执行时，spring 框架会为我们提供该接口的实现类对象，我们直接使用就行。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param pjp
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">transactionAround</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Object</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取方法执行所需的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//前置通知：开启事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">beginTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//执行方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">returnValue</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//后置通知：提交事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//异常通知：回滚事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//最终通知：释放资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">returnValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"> aop:around：
</span></span><span class="line"><span class="cl">	作用：
</span></span><span class="line"><span class="cl">		用于配置环绕通知
</span></span><span class="line"><span class="cl">	属性：
</span></span><span class="line"><span class="cl">        method：指定通知中方法的名称。
</span></span><span class="line"><span class="cl">        pointct：定义切入点表达式
</span></span><span class="line"><span class="cl">        pointcut-ref：指定切入点表达式的引用
</span></span><span class="line"><span class="cl">	说明：
</span></span><span class="line"><span class="cl">        它是 spring 框架为我们提供的一种可以在代码中手动控制增强代码什么时候执行的方式。
</span></span><span class="line"><span class="cl">        注意：通常情况下，环绕通知都是独立使用的
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:config&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;aop:aspect</span> <span class="na">id=</span><span class="s">&#34;tdAdvice&#34;</span> <span class="na">ref=</span><span class="s">&#34;txManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&#34;point1&#34;</span> <span class="na">expression=</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..))&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- 配置环绕通知 --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;aop:around</span> <span class="na">method=</span><span class="s">&#34;transactionAround&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;point1&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/aop:aspect&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/aop:config&gt;</span>
</span></span></code></pre></div><h2 id="三spring基于注解的aop配置">（三）Spring基于注解的AOP配置</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">话术： 
</span></span><span class="line"><span class="cl"> AOP注解方式和XML方式完成的功能是一样的，只是采用了两种开发方式而已。将原有的XML方式使用注解逐一替代。
</span></span></code></pre></div><h3 id="1-环境搭建-1">1 环境搭建</h3>
<h4 id="11-构建maven工程添加aop注解的相关依赖">1.1 构建maven工程添加AOP注解的相关依赖</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;spring.version&gt;</span>5.2.5.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.8.7<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h4 id="12-沿用上一章节资源">1.2 沿用上一章节资源</h4>
<p>copy Account AccountDao AccountDaoImpl AccountService AccountServiceImpl</p>
<h4 id="13-在配置文件中导入-context-的名称空间且配置">1.3 在配置文件中导入 context 的名称空间且配置</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:aop=</span><span class="s">&#34;http://www.springframework.org/schema/aop&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:context=</span><span class="s">&#34;http://www.springframework.org/schema/context&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.springframework.org/schema/beans
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop/spring-aop.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context/spring-context.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h4 id="14-资源使用注解配置">1.4 资源使用注解配置</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 配置数据源 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.mchange.v2.c3p0.ComboPooledDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--连接数据库的必备信息--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClass&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;jdbcUrl&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;user&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--配置queryRunner--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;queryRunner&#34;</span> <span class="na">class=</span><span class="s">&#34;org.apache.commons.dbutils.QueryRunner&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span></code></pre></div><h4 id="15-在配置文件中指定-spring-要扫描的包">1.5 在配置文件中指定 spring 要扫描的包</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"> <span class="c">&lt;!-- 告知 spring，在创建容器时要扫描的包 --&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&#34;com.offcn&#34;</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
</span></span></code></pre></div><h3 id="2-配置步骤">2 配置步骤</h3>
<h4 id="11--通知类使用注解配置">1.1  通知类使用注解配置</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 和事务管理相关的工具类，它包含了，开启事务，提交事务，回滚事务和释放连接
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span><span class="o">(</span><span class="s">&#34;txManager&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="12-在通知类上使用aspect-注解声明为切面">1.2 在通知类上使用@Aspect 注解声明为切面</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 和事务管理相关的工具类，它包含了，开启事务，提交事务，回滚事务和释放连接
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span><span class="o">(</span><span class="s">&#34;txManager&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Aspect</span> <span class="c1">//表明当前类是一个切面类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionManager</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ConnectionUtils</span> <span class="n">connectionUtils</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="13-在增强的方法上使用注解配置通知">1.3 在增强的方法上使用注解配置通知</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Before</span>
</span></span><span class="line"><span class="cl">	<span class="err">作用：</span>
</span></span><span class="line"><span class="cl">		<span class="err">把当前方法看成是前置通知</span>
</span></span><span class="line"><span class="cl">	<span class="err">属性：</span>
</span></span><span class="line"><span class="cl">		<span class="n">value</span><span class="err">：用于指定切入点表达式，还可以指定切入点表达式的引用。</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="c1">//开启事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Before</span><span class="o">(</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..)))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span>  <span class="kt">void</span> <span class="nf">beginTransaction</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before..........................&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="nd">@AfterReturning</span>
</span></span><span class="line"><span class="cl">	<span class="err">作用：</span> 
</span></span><span class="line"><span class="cl">		<span class="err">把当前方法看成是后置通知。</span>
</span></span><span class="line"><span class="cl">	<span class="err">属性：</span> 
</span></span><span class="line"><span class="cl">		<span class="n">value</span><span class="err">：用于指定切入点表达式，还可以指定切入点表达式的引用</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="c1">// 提交事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@AfterReturning</span><span class="o">(</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..)))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span>  <span class="kt">void</span> <span class="nf">commit</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AfterThrowing</span>
</span></span><span class="line"><span class="cl">	<span class="err">作用：</span> 
</span></span><span class="line"><span class="cl">		<span class="err">把当前方法看成是异常通知。</span>
</span></span><span class="line"><span class="cl">	<span class="err">属性：</span> 
</span></span><span class="line"><span class="cl">		<span class="n">value</span><span class="err">：用于指定切入点表达式，还可以指定切入点表达式的引用</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="c1">//回滚事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@AfterThrowing</span><span class="o">(</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..)))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span>  <span class="kt">void</span> <span class="nf">rollback</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@After</span>
</span></span><span class="line"><span class="cl">	<span class="err">作用：</span> 
</span></span><span class="line"><span class="cl">		<span class="err">把当前方法看成是最终通知。</span>
</span></span><span class="line"><span class="cl">	<span class="err">属性：</span> 
</span></span><span class="line"><span class="cl">		<span class="n">value</span><span class="err">：用于指定切入点表达式，还可以指定切入点表达式的引用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//释放连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@After</span><span class="o">(</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..)))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span>  <span class="kt">void</span> <span class="nf">release</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">removeConnection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">connectionUtils</span><span class="o">.</span><span class="na">getThreadConnection</span><span class="o">().</span><span class="na">close</span><span class="o">();</span><span class="c1">//还回连接池中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="14-在-spring-配置文件中开启-spring-对注解-aop-的支持">1.4 在 spring 配置文件中开启 spring 对注解 AOP 的支持</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 开启 spring 对注解 AOP 的支持 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:aspectj-autoproxy/&gt;</span>
</span></span></code></pre></div><h4 id="15-环绕通知注解配置">1.5 环绕通知注解配置</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Around</span>
</span></span><span class="line"><span class="cl">	<span class="err">作用：</span> 
</span></span><span class="line"><span class="cl">		<span class="err">把当前方法看成是环绕通知。</span>
</span></span><span class="line"><span class="cl">	<span class="err">属性：</span> 
</span></span><span class="line"><span class="cl">		<span class="n">value</span><span class="err">：用于指定切入点表达式，还可以指定切入点表达式的引用。</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 环绕通知:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Around</span><span class="o">(</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..)))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">transactionAround</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Object</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取方法执行所需的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//前置通知：开启事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">beginTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//执行方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">returnValue</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//后置通知：提交事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//异常通知：回滚事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//最终通知：释放资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">returnValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="16-切入点表达式注解">1.6 切入点表达式注解</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Pointcut</span><span class="o">(</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">point1</span><span class="o">()</span> <span class="o">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 环绕通知:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Around</span><span class="o">(</span><span class="s">&#34;point1()&#34;</span><span class="o">)</span><span class="c1">///注意：千万别忘了写括号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">transactionAround</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Object</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取方法执行所需的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//前置通知：开启事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">beginTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//执行方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">returnValue</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//后置通知：提交事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//异常通知：回滚事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rollback</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//最终通知：释放资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">returnValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>作业： aop 控制事务， 纯注解开发~</p>
<h1 id="二-spring事务详解">二、 Spring事务详解</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">讲解思路： 
</span></span><span class="line"><span class="cl"> 1、介绍Spring当中进行事务控制的常用对象以及作用
</span></span><span class="line"><span class="cl"> 2、事务的隔离级别，不同隔离级别产生的错误数据
</span></span><span class="line"><span class="cl"> 3、扩展事务的传播行为，事务传播行为的对应几种情况，面试问题
</span></span><span class="line"><span class="cl"> 4、完成基于XML形式事务配置
</span></span></code></pre></div><h2 id="一spring中事务的api详解">（一）Spring中事务的API详解</h2>
<h3 id="1-platformtransactionmanager作用掌握">1 PlatformTransactionManager作用【掌握】</h3>
<p>PlatformTransactionManager 接口是 Spring 的事务管理器，它里面提供了我们常用的操作事务的方法。</p>
<p><img src="/posts/Java-frame/20220526005077/image-20220526005607843.png"
    
    
    
    loading="lazy"
    
    
></p>
<p>注意：</p>
<p>PlatformTransactionManager 是接口类型，不同的 Dao 层技术则有不同的实现类，例如：Dao 层技术是jdbc 或 mybatis 时，JdbcTemplate 对象：org.springframework.jdbc.datasource.DataSourceTransactionManager</p>
<p>Dao 层技术是hibernate时：org.springframework.orm.hibernate5.HibernateTransactionManager</p>
<h3 id="2-transactiondefinition作用">2 TransactionDefinition作用</h3>
<p>TransactionDefinition 是事务的定义信息对象，里面有如下方法</p>
<p><img src="/posts/Java-frame/20220526005077/image-20220526005627306.png"
    
    
    
    loading="lazy"
    
    
></p>
<h4 id="21-事务隔离级别">2.1 事务隔离级别</h4>
<p>设置隔离级别，可以解决事务并发产生的问题，如脏读、不可重复读和虚读。</p>
<table>
<thead>
<tr>
<th>事务隔离级别</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ISOLATION_DEFAULT</td>
<td>默认级别，归属下列某一种</td>
</tr>
<tr>
<td>ISOLATION_READ_UNCOMMITTED</td>
<td>未提交读，可以读取未提交数据</td>
</tr>
<tr>
<td>ISOLATION_READ_COMMITTED</td>
<td>已提交读，只能读取已提交数据，解决脏读问题（Oracle默认级别）</td>
</tr>
<tr>
<td>ISOLATION_REPEATABLE_READ</td>
<td>可重复读，解决不可重复度问题（MySQL默认级别）</td>
</tr>
<tr>
<td>ISOLATION_SERIALIZABLE</td>
<td>串行化，节约幻读（虚读）问题</td>
</tr>
</tbody>
</table>
<h4 id="22-事务传播行为">2.2 事务传播行为</h4>
<table>
<thead>
<tr>
<th>事务传播行为</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>REQUIRED</strong></td>
<td><strong>如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。一般的选择（默认值）</strong></td>
</tr>
<tr>
<td><strong>SUPPORTS</strong></td>
<td>支持当前事务，如果当前没有事务，就以非事务方式执行（没有事务）</td>
</tr>
<tr>
<td>MANDATORY</td>
<td>使用当前的事务，如果当前没有事务，就抛出异常</td>
</tr>
<tr>
<td>REQUERS_NEW</td>
<td>新建事务，如果当前在事务中，把当前事务挂起。</td>
</tr>
<tr>
<td>NOT_SUPPORTED</td>
<td>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起</td>
</tr>
<tr>
<td>NEVER</td>
<td>以非事务方式运行，如果当前存在事务，抛出异常</td>
</tr>
<tr>
<td>NESTED</td>
<td>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行 REQUIRED 类似的操作</td>
</tr>
</tbody>
</table>
<h4 id="23-事务超时时间">2.3 事务超时时间</h4>
<p>默认值是-1，没有超时限制。如果有，以秒为单位进行设置。</p>
<h4 id="24-是否是只读事务">2.4 是否是只读事务</h4>
<p>建议查询时设置为只读。</p>
<h3 id="3-transactionstatus作用">3 TransactionStatus作用</h3>
<p>TransactionStatus 接口提供的是事务具体的运行状态，方法介绍如下。</p>
<p><img src="/posts/Java-frame/20220526005077/image-20220526005647243.png"
    
    
    
    loading="lazy"
    
    
></p>
<h3 id="4-上述三个对象关系">4 上述三个对象关系</h3>
<p>PlatformTransactionManager 根据TransactionDefinition 定义的事务属性，进行事务的管理， 在事务管理的过程当中产生的状态信息保存在TransactionStatus。</p>
<h2 id="二spring基于xml的事务配置">（二）Spring基于XML的事务配置</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">讲解思路： 
</span></span><span class="line"><span class="cl"> 1、准备转账的业务场景，演示没有事务控制时，数据一致性受损
</span></span><span class="line"><span class="cl"> 2、在XML配置文件当中，使用Spring提供的声明式事务进行控制，详解事务控制的每个步骤，每个步骤当中涉及的每个标签，讲解的过程当中复习巩固AOP当中的相关概念，加深学员对概念的理解
</span></span><span class="line"><span class="cl"> 3、测试基于XML声明式事务是否生效
</span></span></code></pre></div><h3 id="1-环境搭建-2">1 环境搭建</h3>
<h4 id="11-构建maven工程添加相关技术依赖">1.1 构建maven工程，添加相关技术依赖</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;spring.version&gt;</span>5.2.5.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入junit单元测试--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入spring的context坐标--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入Jdbc模块依赖--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入Mysql 驱动--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>5.1.47<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入C3P0连接池--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.mchange<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.9.5.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--aop--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.8.7<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h4 id="12-创建spring-的配置文件并导入约束">1.2 创建Spring 的配置文件并导入约束</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:context=</span><span class="s">&#34;http://www.springframework.org/schema/context&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:aop=</span><span class="s">&#34;http://www.springframework.org/schema/aop&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:tx=</span><span class="s">&#34;http://www.springframework.org/schema/tx&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context/spring-context.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop/spring-aop.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/tx
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/tx/spring-tx.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/beans
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c">&lt;!-- 告知 Spring，在创建容器时要扫描的包 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&#34;com.offcn&#34;</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 配置数据源 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.mchange.v2.c3p0.ComboPooledDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--连接数据库的必备信息--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClass&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;jdbcUrl&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;user&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--JdbcTemplate--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;jdbcTemplate&#34;</span> <span class="na">class=</span><span class="s">&#34;org.springframework.jdbc.core.JdbcTemplate&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h4 id="13-沿用转账业务的代码">1.3 沿用转账业务的代码</h4>
<p>copy Account AccountDao AccountDaoImpl AccontService AccountServiceImpl 代码：</p>
<p>注意： AccountDaoImpl 具体使用使用Spring提供的JdbcTemplate模板对象实现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span><span class="o">(</span><span class="s">&#34;accountDao&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountDaoImpl</span> <span class="kd">implements</span> <span class="n">AccountDao</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">findByName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">&#34;select * from account where name =? &#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span>  <span class="k">this</span><span class="o">.</span><span class="na">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="n">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="n">Account</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="n">account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">&#34;update account set money =? where name =? &#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">account</span><span class="o">.</span><span class="na">getMoney</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="2-事务管理配置步骤">2 事务管理配置步骤</h3>
<h4 id="21-配置事务管理器">2.1 配置事务管理器</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--平台事务管理器--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;transactionManager&#34;</span> <span class="na">class=</span><span class="s">&#34;org.springframework.jdbc.datasource.DataSourceTransactionManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span></code></pre></div><h4 id="22-配置事务的通知引用事务管理器">2.2 配置事务的通知引用事务管理器</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--事务的配置--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">&#34;txAdvice&#34;</span> <span class="na">transaction-manager=</span><span class="s">&#34;transactionManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/tx:advice&gt;</span>
</span></span></code></pre></div><h4 id="23-配置事务的属性">2.3 配置事务的属性</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 
</span></span></span><span class="line"><span class="cl"><span class="c">    指定方法名称：是业务核心方法
</span></span></span><span class="line"><span class="cl"><span class="c">     read-only：是否是只读事务。默认 false，不只读。
</span></span></span><span class="line"><span class="cl"><span class="c">     isolation：指定事务的隔离级别。默认值是使用数据库的默认隔离级别。
</span></span></span><span class="line"><span class="cl"><span class="c">     propagation：指定事务的传播行为。
</span></span></span><span class="line"><span class="cl"><span class="c">     timeout：指定超时时间。默认值为：-1。永不超时。
</span></span></span><span class="line"><span class="cl"><span class="c">     rollback-for：用于指定一个异常，当执行产生该异常时，事务回滚。产生其他异常，事务不回滚。
</span></span></span><span class="line"><span class="cl"><span class="c">     没有默认值，任何异常都回滚。
</span></span></span><span class="line"><span class="cl"><span class="c">     no-rollback-for：用于指定一个异常，当产生该异常时，事务不回滚，产生其他异常时，事务回滚。没有默认值，任何异常都回滚。
</span></span></span><span class="line"><span class="cl"><span class="c"> --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;tx:attributes&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">&#34;*&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/tx:attributes&gt;</span>
</span></span></code></pre></div><h4 id="24-配置-aop-切入点表达式">2.4 配置 AOP 切入点表达式</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--事务的aop增强--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:config&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&#34;myPointcut&#34;</span> <span class="na">expression=</span><span class="s">&#34;execution(* com.offcn.service.impl.*.*(..))&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/aop:config&gt;</span>
</span></span></code></pre></div><h4 id="25-配置切入点表达式和事务通知的对应关系">2.5 配置切入点表达式和事务通知的对应关系</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--在aop：config标签内部：建立事务的通知和切入点表达式的关系--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">&#34;txAdvice&#34;</span> <span class="na">pointcut-ref=</span><span class="s">&#34;myPointcut&#34;</span><span class="nt">&gt;&lt;/aop:advisor&gt;</span>
</span></span></code></pre></div><h1 id="三-spring事务详解-注解">三、 Spring事务详解-注解</h1>
<h2 id="一-spring基于注解的事务配置">（一） Spring基于注解的事务配置</h2>
<h3 id="1-环境搭建-3">1 环境搭建</h3>
<h4 id="11--构建maven工程添加相关技术依赖">1.1  构建maven工程，添加相关技术依赖</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;spring.version&gt;</span>5.2.5.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入junit单元测试--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入spring的context坐标--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入Jdbc模块依赖--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入Mysql 驱动--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>5.1.47<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入C3P0连接池--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.mchange<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.9.5.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--aop--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.8.7<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="12-创建-spring-的配置文件并导入约束">1.2 创建 Spring 的配置文件并导入约束</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:context=</span><span class="s">&#34;http://www.springframework.org/schema/context&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:aop=</span><span class="s">&#34;http://www.springframework.org/schema/aop&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:tx=</span><span class="s">&#34;http://www.springframework.org/schema/tx&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context/spring-context.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop/spring-aop.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/tx
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/tx/spring-tx.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/beans
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 告知 spring，在创建容器时要扫描的包 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&#34;com.offcn&#34;</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 配置数据源 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.mchange.v2.c3p0.ComboPooledDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--连接数据库的必备信息--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClass&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;jdbcUrl&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;user&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--JdbcTemplate--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;jdbcTemplate&#34;</span> <span class="na">class=</span><span class="s">&#34;org.springframework.jdbc.core.JdbcTemplate&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h4 id="13-沿用转账业务的代码dao实现类和service实现类采用注解的形式添加到容器中管理">1.3 沿用转账业务的代码：dao实现类和service实现类采用注解的形式，添加到容器中管理</h4>
<p>copy Account AccountDao AccountImpl  AccountService AccountServiceImpl 到工程当中复用</p>
<h3 id="2-事务管理配置步骤重点">2 事务管理配置步骤(重点)</h3>
<h4 id="21-配置事务管理器并注入数据源">2.1 配置事务管理器并注入数据源</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 配置事务管理器 --&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;transactionManager&#34;</span><span class="na">class=</span><span class="s">&#34;org.springframework.jdbc.datasource.DataSourceTransactionManager&#34;</span><span class="nt">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span></code></pre></div><h4 id="22-在业务层使用transactional-注解">2.2 在业务层使用@Transactional 注解</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> 该注解的属性和 xml 中的属性含义一致。该注解可以出现在接口上，类上和方法上。
</span></span></span><span class="line"><span class="cl"><span class="cm"> 出现接口上，表示该接口的所有实现类都有事务支持。
</span></span></span><span class="line"><span class="cl"><span class="cm"> 出现在类上，表示类中所有方法有事务支持
</span></span></span><span class="line"><span class="cl"><span class="cm"> 出现在方法上，表示方法有事务支持。
</span></span></span><span class="line"><span class="cl"><span class="cm"> 以上三个位置的优先级：方法&gt;类&gt;接口 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;accountService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">SUPPORTS</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//依赖dao层
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountDao</span> <span class="n">accountDao</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">String</span> <span class="n">sourceAccountName</span><span class="o">,</span> <span class="n">String</span> <span class="n">targetAccountName</span><span class="o">,</span> <span class="n">Double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Account</span> <span class="n">sAccount</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">sourceAccountName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Account</span> <span class="n">tAccount</span> <span class="o">=</span> <span class="n">accountDao</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">targetAccountName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//来源账户减钱，目标账户加钱
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">sAccount</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">sAccount</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()-</span><span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">tAccount</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">tAccount</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//持久化到数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sAccount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//模拟异常发生
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//int i=1/0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">accountDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">tAccount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="23-在配置文件中开启-spring-对注解事务的支持">2.3 在配置文件中开启 Spring 对注解事务的支持</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- 开启 spring 对注解事务的支持 --&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">&#34;transactionManager&#34;</span><span class="nt">/&gt;</span>
</span></span></code></pre></div><p>作业： 全注解开发~</p>
<h1 id="四-spring整合mybatis实现用户的crud">四、 Spring整合Mybatis实现用户的CRUD</h1>
<h2 id="一整合思路分析">（一）整合思路分析</h2>
<p>Mybatis框架是一个持久层ORM框架，而Spring则是一个综合性一站式框架。所以整合是Mybatis往Spring上整合。就是让Spring框架接管Mybatis的组件。</p>
<p>Mybatis单独运行时，数据源的管理，事务的管理， SqlSessionFactory 以及接口的实现类都是Mybatis管理的，整合后以上组件交给Spring管理。</p>
<h2 id="二构建maven工程添加技术依赖">（二）构建maven工程，添加技术依赖</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;spring.version&gt;</span>5.2.5.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入junit单元测试--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入spring的context坐标--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入Jdbc模块依赖--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入Mysql 驱动--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>5.1.47<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--导入C3P0连接池--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.mchange<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>c3p0<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>0.9.5.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--aop--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>1.8.7<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--mybatis-Spring适配包 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mybatis-spring<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- mybatis orm框架 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mybatis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>3.4.6<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h2 id="三构建数据库表并创建实体user">（三）构建数据库表并创建实体User</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">User</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">auto_increment</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">birthday</span><span class="w"> </span><span class="nb">date</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Date</span> <span class="n">birthday</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">address</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getBirthday</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">birthday</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBirthday</span><span class="o">(</span><span class="n">Date</span> <span class="n">birthday</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">birthday</span> <span class="o">=</span> <span class="n">birthday</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;User{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;id=&#34;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;, name=&#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;, address=&#39;&#34;</span> <span class="o">+</span> <span class="n">address</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;, birthday=&#34;</span> <span class="o">+</span> <span class="n">birthday</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="四编写dao层的接口usermapper">（四）编写dao层的接口UserMapper</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="五构建mapper接口对应的sql配置文件">（五）构建mapper接口对应的sql配置文件</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE mapper
</span></span></span><span class="line"><span class="cl"><span class="cp">        PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&#34;com.offcn.mapper.UserMapper&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&#34;BaseResultMap&#34;</span> <span class="na">type=</span><span class="s">&#34;com.offcn.pojo.User&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">&#34;id&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;INTEGER&#34;</span> <span class="na">property=</span><span class="s">&#34;id&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;name&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;VARCHAR&#34;</span> <span class="na">property=</span><span class="s">&#34;name&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;address&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;VARCHAR&#34;</span> <span class="na">property=</span><span class="s">&#34;address&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;birthday&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;DATE&#34;</span> <span class="na">property=</span><span class="s">&#34;birthday&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/resultMap&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&#34;insert&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;com.offcn.pojo.User&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        insert into user (name, birthday, address)
</span></span><span class="line"><span class="cl">        values (#{name}, #{birthday},#{address})
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/insert&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&#34;update&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        update user
</span></span><span class="line"><span class="cl">        set
</span></span><span class="line"><span class="cl">        name= #{name},
</span></span><span class="line"><span class="cl">        birthday=#{birthday},
</span></span><span class="line"><span class="cl">        address = #{address}
</span></span><span class="line"><span class="cl">        where id=#{id}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/update&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&#34;delete&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        delete from user
</span></span><span class="line"><span class="cl">        where id =#{id}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/delete&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;findById&#34;</span> <span class="na">resultMap=</span><span class="s">&#34;BaseResultMap&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        select * from user where id=#{id}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/select&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;findAll&#34;</span> <span class="na">resultMap=</span><span class="s">&#34;BaseResultMap&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        select * from user
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/select&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/mapper&gt;</span>
</span></span></code></pre></div><h2 id="六构建服务层接口userservice">（六）构建服务层接口UserService</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="七构建服务层实现类userserviceimpl">（七）构建服务层实现类UserServiceImpl</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">implements</span> <span class="n">UserService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">User</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userList</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="八构建spring框架的配置文件applicationcontextxml配置ioc管理的对象重点">（八）构建Spring框架的配置文件applicationContext.xml,配置IOC管理的对象【重点】</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:aop=</span><span class="s">&#34;http://www.springframework.org/schema/aop&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:tx=</span><span class="s">&#34;http://www.springframework.org/schema/tx&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xmlns:context=</span><span class="s">&#34;http://www.springframework.org/schema/context&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.springframework.org/schema/beans
</span></span></span><span class="line"><span class="cl"><span class="s">        https://www.springframework.org/schema/beans/spring-beans.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/tx
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/tx/spring-tx.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/aop/spring-aop.xsd
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context
</span></span></span><span class="line"><span class="cl"><span class="s">        http://www.springframework.org/schema/context/spring-context.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--开启包扫描--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&#34;com.offcn&#34;</span><span class="nt">&gt;</span> <span class="nt">&lt;/context:component-scan&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 配置数据源 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">class=</span><span class="s">&#34;com.mchange.v2.c3p0.ComboPooledDataSource&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--连接数据库的必备信息--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driverClass&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;jdbcUrl&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/test&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;user&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--Mybatis 核心对象： 工厂对象--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;sqlSessionFactory&#34;</span> <span class="na">class=</span><span class="s">&#34;org.mybatis.spring.SqlSessionFactoryBean&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--工厂创建必须注入一个数据源--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--指定mapper文件位置--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;mapperLocations&#34;</span> <span class="na">value=</span><span class="s">&#34;classpath:com/offcn/mapper/*Mapper.xml&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--引入Mybatis的核心配置文件：
</span></span></span><span class="line"><span class="cl"><span class="c">           如果Mybaits的核心配置要保留，需要再此处配置：
</span></span></span><span class="line"><span class="cl"><span class="c">        --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;configLocation&#34;</span> <span class="na">value=</span><span class="s">&#34;classpath:SqlMapConfig.xml&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--别名配置--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;typeAliasesPackage&#34;</span> <span class="na">value=</span><span class="s">&#34;com/offcn/pojo&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--进行分页插件的配置--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;plugins&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;array&gt;</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&#34;com.github.pagehelper.PageInterceptor&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;properties&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">						<span class="nt">&lt;value&gt;</span>
</span></span><span class="line"><span class="cl">							helperDialect=MySQL
</span></span><span class="line"><span class="cl">							reasonable=true
</span></span><span class="line"><span class="cl">							supportMethodsArguments=true
</span></span><span class="line"><span class="cl">							params=count=countSql
</span></span><span class="line"><span class="cl">							autoRuntimeDialect=true
</span></span><span class="line"><span class="cl">						<span class="nt">&lt;/value&gt;</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&lt;/array&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&lt;/property&gt;</span>   
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--配置接口的扫描--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;mapperScannerConfigurer&#34;</span> <span class="na">class=</span><span class="s">&#34;org.mybatis.spring.mapper.MapperScannerConfigurer&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--指定了包： 能够将包下的接口生成实现类： --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;basePackage&#34;</span> <span class="na">value=</span><span class="s">&#34;com.offcn.mapper&#34;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--配置平台管理器--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;transactionManager&#34;</span> <span class="na">class=</span><span class="s">&#34;org.springframework.jdbc.datasource.DataSourceTransactionManager&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--注入数据源--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;dataSource&#34;</span> <span class="na">ref=</span><span class="s">&#34;dataSource&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/bean&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">&#34;transactionManager&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/beans&gt;</span>
</span></span></code></pre></div><h2 id="九测试代码">（九）测试代码</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="s">&#34;classpath:applicationContext.xml&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAccountTransfer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//save
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInsert</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">&#34;china&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;num:&#34;</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUpdate</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;marry&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">&#34;America&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;num:&#34;</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//delete:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDelete</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;num:&#34;</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//findById
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindById</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;user:&#34;</span><span class="o">+</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//findAll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindByAll</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userList</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;userList:&#34;</span><span class="o">+</span><span class="n">userList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div>
            </div>
            <hr>
            <div style="text-align: center;">
                <button class="btn"><a href="https://lovemjh.github.io/posts/java-frame/20220526003427/">← Spring-1</a></button>
                <button class="btn"><a href="https://lovemjh.github.io/posts/java-web/20220430214937/">HTML DOM →</a></button>
            </div>

            
        </article><div class="aside_content" id="aside_content">
    <div class="card-widget card-info">
        <div class="card-content">
            <div class="card-info-avatar is-center">
                <img class="avatar-img" src="http://q1.qlogo.cn/g?b=qq&nk=2409741052&s=640" alt="avatar">
                <div class="author-info__name">青山</div>
                <div class="author-info__description">悟已往之不谏 知来者之可追</div>
            </div>
            
            <div class="card-info-social-icons is-center">
                <a class="social-icon" href="https://github.com/xioyito" target="_blank">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            

        </div>
    </div>


    <div class="card-widget">
        <div class="card-content">
            <meting-js auto="https://y.qq.com/n/yqq/playlist/7713574197.html">
            </meting-js>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-bullhorn" aria-hidden="true"></i>
                <span>一言</span>
            </div>
            <div id="hitokoto"></div>
        </div>
    </div>
    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <span>今日诗词</span>
            </div>
            <div id="jinrishici-sentence"></div>
        </div>
    </div>

    <div class="card-widget">
        <div class="card-content">
            <div class="item-headline">
                <i class="fa fa-line-chart" aria-hidden="true"></i>
                <span>站点信息</span>
            </div>
            <div class="webinfo">
                <div class="webinfo-item">
                    <div class="webinfo-site-uv-name">本站访客数 :</div>
                    <div class="webinfo-site-uv-count" id="busuanzi_value_site_uv"></div>
                </div>
                <div class="webinfo-item">
                    <div class="webinfo-site-name">本站总访问量 :</div>
                    <div class="webinfo-site-pv-count" id="busuanzi_value_site_pv"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-widget js-toc-w" id="js-toc-w">
        <div class="card-content js-toc">
            
        </div>
    </div>
    
</div></div>
</main>
<footer id="footer">
    <div id="footer-wrap">
        <div class="copyright">&copy;2019 - 2021 BY QING SHAN KE</div>
    </div>
</footer>
</div>

<div class="fan" id="fan" style="
position: fixed;
width: 40px;
height: 120px;
right: -200px;
bottom: 0px;
transition: all 0.5s;
z-index: 99999;
 ">
    <i class="fa fa-cog fa-spin fa-2x"></i><br>
    <i class="fa fa-align-justify fa-2x" id="ff"></i><br>
    <i class="fa fa fa-arrow-up fa-2x" id="aa"></i><br>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    var a = 0;
    ff.onclick = function () {
        if (a === 0) {
            $(".js-toc-w").css("position", "fixed"); 
            $(".js-toc-w").css("bottom", "10px");
            $(".js-toc-w").css("right", "40px");

            a++;
        } else {
            $(".js-toc-w").css("position", "static");
            a--;
        }
    }

    aa.onclick = function () {
        window.scrollTo({     
            top: 0,            
            behavior: "smooth"   
        })
    }

    
    window.onload = function () {
        $(".aplayer").css("background", "rgba(0, 0, 0, 0)");
        

        
    } 
</script>
<script>
    $(window).scroll(function () {
        var scrollY = document.documentElement.scrollTop || document.body.scrollTop
        console.log(scrollY + "----------------------")
        if (scrollY > 40) {
            $('.fan').css("right", "0px");
        } else {
            $('.fan').css("right", "-220px");
        }
    });
    $(function () {
        
        var start_height = $(document).scrollTop();
        
        var navigation_height = $('.navigation').outerHeight();
        $(window).scroll(function () {
            
            var end_height = $(document).scrollTop();
            
            if (end_height > navigation_height) {
                $('.navigation').addClass('hide');
            } else {
                $('.navigation').removeClass('hide');
            }
            
            if (end_height < start_height) {
                $('.navigation').removeClass('hide');
            }
            
            start_height = $(document).scrollTop();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" async></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script src="https://unpkg.com/nplayer@latest/dist/index.min.js"></script>


<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>





<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@3.0.8/js/maodian.js"></script>


<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3, h4, h5 ,h6',
        
        hasInnerContainers: false,
        
    });
</script>


<script type="text/javascript">
    console.clear();
    console.log("%c 有朋自远方来, 不亦说乎.", "background:#24272A; color:#ffffff", "");
    console.log("%c Github %c", "background:#24272A; color:#ffffff", "", "https://github.com/laoxuai");
    console.log("%c 版本号: %c", "background:#24272A; color:#ffffff", "", "1.0.0");

    (function ($) {
        $.fn.snow = function (options) {
            var $flake = $('<div id="snowbox" />').css({ 'position': 'absolute', 'z-index': '9999', 'top': '-50px' }).html('&#10052;'),
                documentHeight = $(document).height(),
                documentWidth = $(document).width(),
                defaults = {
                    minSize: 10,
                    maxSize: 20,
                    newOn: 1000,
                    flakeColor: "#AFDAEF"  
                },
                options = $.extend({}, defaults, options);
            var interval = setInterval(function () {
                var startPositionLeft = Math.random() * documentWidth - 100,
                    startOpacity = 0.5 + Math.random(),
                    sizeFlake = options.minSize + Math.random() * options.maxSize,
                    endPositionTop = documentHeight - 200,
                    endPositionLeft = startPositionLeft - 500 + Math.random() * 500,
                    durationFall = documentHeight * 10 + Math.random() * 5000;
                $flake.clone().appendTo('body').css({
                    left: startPositionLeft,
                    opacity: startOpacity,
                    'font-size': sizeFlake,
                    color: options.flakeColor
                }).animate({
                    top: endPositionTop,
                    left: endPositionLeft,
                    opacity: 0.2
                }, durationFall, 'linear', function () {
                    $(this).remove()
                });
            }, options.newOn);
        };
    })(jQuery);
    $(function () {
        $.fn.snow({
            minSize: 5,  
            maxSize: 50, 
            newOn: 800   
        });
    });

    
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            
            document.title = '╭(°A°`)╮ 页面崩溃啦 ~';
            clearTimeout(titleTime);
        }
        else {
            $('[rel="icon"]').attr('href', "/favicon.ico");
            document.title = '(ฅ>ω<*ฅ) 噫又好啦 ~' + OriginTitle;
            titleTime = setTimeout(function () {
                document.title = OriginTitle;
            }, 2000);
        }
    });
</script></body>
</html>